<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Smarter&#39;s blog</title>
  
  <subtitle>è¦å­¦ä¹ ã€è¦å¿«ä¹</subtitle>
  <link href="https://smarter.xin/atom.xml" rel="self"/>
  
  <link href="https://smarter.xin/"/>
  <updated>2026-01-24T08:26:21.331Z</updated>
  <id>https://smarter.xin/</id>
  
  <author>
    <name>Smarter</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>PMPP-ç¬¬äºŒåä¸€ç« ï¼šCUDAåŠ¨æ€å¹¶è¡Œæ€§</title>
    <link href="https://smarter.xin/posts/e519c4bc/"/>
    <id>https://smarter.xin/posts/e519c4bc/</id>
    <published>2026-01-24T08:20:44.000Z</published>
    <updated>2026-01-24T08:26:21.331Z</updated>
    
    <content type="html"><![CDATA[<h2 id="qian-yan" tabindex="-1" id="å‰è¨€">å‰è¨€</h2><p>ç¬¬äºŒåç« ä»‹ç»äº†å¤š GPU é›†ç¾¤ç¼–ç¨‹ã€‚ç¬¬äºŒåä¸€ç« å›åˆ°å• GPU çš„é«˜çº§ç‰¹æ€§â€”â€”<strong>åŠ¨æ€å¹¶è¡Œæ€§ï¼ˆDynamic Parallelismï¼‰</strong>ã€‚ä¼ ç»Ÿ CUDA ç¨‹åºä¸­ï¼Œåªæœ‰ CPU èƒ½å¯åŠ¨ kernelï¼›è€ŒåŠ¨æ€å¹¶è¡Œæ€§å…è®¸ <strong>GPU kernel ç›´æ¥å¯åŠ¨å…¶ä»– kernel</strong>ï¼Œæ— éœ€è¿”å› CPUã€‚è¿™ä¸€ç‰¹æ€§å¯¹é€’å½’ç®—æ³•ã€è‡ªé€‚åº”è®¡ç®—ã€ä¸è§„åˆ™æ•°æ®ç»“æ„ï¼ˆå¦‚æ ‘ã€å›¾ï¼‰çš„å¤„ç†éå¸¸æœ‰ç”¨ã€‚</p><blockquote><p><strong>ğŸ“¦ é…å¥—èµ„æº</strong>ï¼šæœ¬ç³»åˆ—æ–‡ç« é…æœ‰å®Œæ•´çš„ <a href="https://github.com/psmarter/PMPP-Learning">GitHub ä»“åº“</a>ï¼ŒåŒ…å«æ¯ç« çš„ç»ƒä¹ é¢˜è§£ç­”ã€CUDA ä»£ç å®ç°å’Œè¯¦ç»†æ³¨é‡Šã€‚æ‰€æœ‰ä»£ç éƒ½ç»è¿‡æµ‹è¯•ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œã€‚</p></blockquote><h2 id="shi-yao-shi-dong-tai-bing-xing-xing" tabindex="-1" id="ä»€ä¹ˆæ˜¯åŠ¨æ€å¹¶è¡Œæ€§">ä»€ä¹ˆæ˜¯åŠ¨æ€å¹¶è¡Œæ€§</h2><h3 id="chuan-tong-cuda-mo-xing-de-xian-zhi" tabindex="-1" id="ä¼ ç»Ÿ-CUDA-æ¨¡å‹çš„é™åˆ¶">ä¼ ç»Ÿ CUDA æ¨¡å‹çš„é™åˆ¶</h3><p>ä¼ ç»Ÿ CUDA ç¨‹åºä¸­ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CPU ä»£ç  â†’ å¯åŠ¨ kernel1 â†’ GPU æ‰§è¡Œ â†’ è¿”å› CPU</span><br><span class="line">         â†’ å¯åŠ¨ kernel2 â†’ GPU æ‰§è¡Œ â†’ è¿”å› CPU</span><br><span class="line">         â†’ ...</span><br></pre></td></tr></table></figure><p><strong>é—®é¢˜</strong>ï¼š</p><ol><li>æ¯æ¬¡å¯åŠ¨ kernel éƒ½éœ€è¦ CPU å‚ä¸</li><li>é€’å½’ç®—æ³•éš¾ä»¥è¡¨è¾¾</li><li>è‡ªé€‚åº”ç®—æ³•éœ€è¦å¤šæ¬¡ CPU-GPU å¾€è¿”</li></ol><h3 id="dong-tai-bing-xing-xing" tabindex="-1" id="åŠ¨æ€å¹¶è¡Œæ€§">åŠ¨æ€å¹¶è¡Œæ€§</h3><p><strong>åŠ¨æ€å¹¶è¡Œæ€§</strong>ï¼šå…è®¸ GPU kernel ç›´æ¥å¯åŠ¨å­ kernelï¼ˆchild kernelï¼‰ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CPU ä»£ç  â†’ å¯åŠ¨çˆ¶ kernel â†’ GPU æ‰§è¡Œ</span><br><span class="line">                           â”œâ†’ å¯åŠ¨å­ kernel1 â†’ GPU æ‰§è¡Œ</span><br><span class="line">                           â”œâ†’ å¯åŠ¨å­ kernel2 â†’ GPU æ‰§è¡Œ</span><br><span class="line">                           â””â†’ ...</span><br></pre></td></tr></table></figure><p><strong>ä¼˜åŠ¿</strong>ï¼š</p><ul><li>å‡å°‘ CPU-GPU é€šä¿¡</li><li>è‡ªç„¶è¡¨è¾¾é€’å½’ç®—æ³•</li><li>æ ¹æ®æ•°æ®ç‰¹æ€§åŠ¨æ€è°ƒæ•´è®¡ç®—</li></ul><h3 id="ying-jian-yao-qiu" tabindex="-1" id="ç¡¬ä»¶è¦æ±‚">ç¡¬ä»¶è¦æ±‚</h3><p>åŠ¨æ€å¹¶è¡Œæ€§éœ€è¦è®¡ç®—èƒ½åŠ› 3.5 æˆ–æ›´é«˜çš„ GPUã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¼–è¯‘æ—¶éœ€è¦ç‰¹æ®Šé€‰é¡¹</span></span><br><span class="line">nvcc -<span class="built_in">arch</span>=sm_35 -rdc=<span class="literal">true</span> my_program.cu -lcudadevrt</span><br></pre></td></tr></table></figure><ul><li><code>-rdc=true</code>ï¼šå¯ç”¨å¯é‡å®šä½è®¾å¤‡ä»£ç </li><li><code>-lcudadevrt</code>ï¼šé“¾æ¥è®¾å¤‡è¿è¡Œæ—¶åº“</li></ul><h2 id="ji-ben-yu-fa" tabindex="-1" id="åŸºæœ¬è¯­æ³•">åŸºæœ¬è¯­æ³•</h2><h3 id="zai-she-bei-dai-ma-zhong-qi-dong-kernel" tabindex="-1" id="åœ¨è®¾å¤‡ä»£ç ä¸­å¯åŠ¨-kernel">åœ¨è®¾å¤‡ä»£ç ä¸­å¯åŠ¨ kernel</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">__global__ void child_kernel(int *data, int n) &#123;</span><br><span class="line">    int idx = threadIdx.x + blockIdx.x * blockDim.x;</span><br><span class="line">    if (idx &lt; n) &#123;</span><br><span class="line">        data[idx] *= 2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__global__ void parent_kernel(int *data, int n) &#123;</span><br><span class="line">    // åœ¨è®¾å¤‡ä»£ç ä¸­å¯åŠ¨å­ kernel</span><br><span class="line">    child_kernel&lt;&lt;&lt;1, 32&gt;&gt;&gt;(data, n);</span><br><span class="line">    </span><br><span class="line">    // ç­‰å¾…å­ kernel å®Œæˆ</span><br><span class="line">    cudaDeviceSynchronize();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="she-bei-duan-tong-bu" tabindex="-1" id="è®¾å¤‡ç«¯åŒæ­¥">è®¾å¤‡ç«¯åŒæ­¥</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// ç­‰å¾…å½“å‰çº¿ç¨‹å¯åŠ¨çš„æ‰€æœ‰å­ kernel å®Œæˆ</span><br><span class="line">cudaDeviceSynchronize();</span><br><span class="line"></span><br><span class="line">// ç­‰å¾…ç‰¹å®šæµä¸­çš„æ“ä½œå®Œæˆ</span><br><span class="line">cudaStreamSynchronize(stream);</span><br></pre></td></tr></table></figure><p><strong>æ³¨æ„</strong>ï¼šçˆ¶ kernel é€€å‡ºæ—¶ä¼šéšå¼ç­‰å¾…æ‰€æœ‰å­ kernel å®Œæˆã€‚</p><h3 id="she-bei-duan-nei-cun-guan-li" tabindex="-1" id="è®¾å¤‡ç«¯å†…å­˜ç®¡ç†">è®¾å¤‡ç«¯å†…å­˜ç®¡ç†</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">__global__ void parent_kernel() &#123;</span><br><span class="line">    float *temp;</span><br><span class="line">    </span><br><span class="line">    // åœ¨è®¾å¤‡ç«¯åˆ†é…å†…å­˜</span><br><span class="line">    cudaMalloc(&amp;temp, 1024 * sizeof(float));</span><br><span class="line">    </span><br><span class="line">    // ä½¿ç”¨å†…å­˜...</span><br><span class="line">    child_kernel&lt;&lt;&lt;1, 256&gt;&gt;&gt;(temp, 1024);</span><br><span class="line">    cudaDeviceSynchronize();</span><br><span class="line">    </span><br><span class="line">    // é‡Šæ”¾å†…å­˜</span><br><span class="line">    cudaFree(temp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="nei-cun-ke-jian-xing" tabindex="-1" id="å†…å­˜å¯è§æ€§">å†…å­˜å¯è§æ€§</h2><h3 id="na-xie-nei-cun-zi-kernel-ke-yi-fang-wen" tabindex="-1" id="å“ªäº›å†…å­˜å­-kernel-å¯ä»¥è®¿é—®">å“ªäº›å†…å­˜å­ kernel å¯ä»¥è®¿é—®</h3><table><thead><tr><th>å†…å­˜ç±»å‹</th><th>å­ kernel å¯è®¿é—®</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>å…¨å±€å†…å­˜</td><td>âœ“</td><td>çˆ¶å­å…±äº«</td></tr><tr><td>å¸¸é‡å†…å­˜</td><td>âœ“</td><td>ç¼–è¯‘æ—¶ç¡®å®šï¼Œå…±äº«</td></tr><tr><td>çº¹ç†å†…å­˜</td><td>âœ“</td><td>çˆ¶å­å…±äº«</td></tr><tr><td>å…±äº«å†…å­˜</td><td>âœ—</td><td>ä»…é™å½“å‰ Block</td></tr><tr><td>å±€éƒ¨å†…å­˜</td><td>âœ—</td><td>ä»…é™å½“å‰çº¿ç¨‹</td></tr></tbody></table><h3 id="nei-cun-yi-zhi-xing" tabindex="-1" id="å†…å­˜ä¸€è‡´æ€§">å†…å­˜ä¸€è‡´æ€§</h3><p>çˆ¶ kernel çš„å…¨å±€å†…å­˜å†™å…¥å¯¹å­ kernel å¯è§ï¼Œéœ€è¦éµå¾ªä¸€å®šè§„åˆ™ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">__global__ void parent_kernel(int *data) &#123;</span><br><span class="line">    // å†™å…¥å…¨å±€å†…å­˜</span><br><span class="line">    data[threadIdx.x] = threadIdx.x * 2;</span><br><span class="line">    </span><br><span class="line">    // ç¡®ä¿å†™å…¥å®Œæˆï¼ˆå—å†…åŒæ­¥ï¼‰</span><br><span class="line">    __threadfence();</span><br><span class="line">    </span><br><span class="line">    // å¯åŠ¨å­ kernel</span><br><span class="line">    if (threadIdx.x == 0) &#123;</span><br><span class="line">        child_kernel&lt;&lt;&lt;1, 32&gt;&gt;&gt;(data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å…³é”®ç‚¹</strong>ï¼š</p><ul><li>çˆ¶çº¿ç¨‹åœ¨å¯åŠ¨å­ kernel å‰çš„å†™å…¥å¯¹å­ kernel å¯è§</li><li>å­ kernel çš„å†™å…¥åœ¨ <code>cudaDeviceSynchronize()</code> åå¯¹çˆ¶çº¿ç¨‹å¯è§</li></ul><h2 id="liu-yu-bing-fa" tabindex="-1" id="æµä¸å¹¶å‘">æµä¸å¹¶å‘</h2><h3 id="mo-ren-liu-xing-wei" tabindex="-1" id="é»˜è®¤æµè¡Œä¸º">é»˜è®¤æµè¡Œä¸º</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">__global__ void parent_kernel() &#123;</span><br><span class="line">    // è¿™ä¸¤ä¸ª kernel åœ¨åŒä¸€ä¸ª Block çš„é»˜è®¤æµä¸­é¡ºåºæ‰§è¡Œ</span><br><span class="line">    child_kernel1&lt;&lt;&lt;1, 32&gt;&gt;&gt;();</span><br><span class="line">    child_kernel2&lt;&lt;&lt;1, 32&gt;&gt;&gt;();  // ç­‰å¾… child_kernel1 å®Œæˆ</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>é‡è¦</strong>ï¼šåŒä¸€ Block å†…çš„çº¿ç¨‹å…±äº«é»˜è®¤æµï¼Œå› æ­¤å­ kernel ä¼šä¸²è¡Œæ‰§è¡Œã€‚</p><h3 id="shi-yong-du-li-liu-shi-xian-bing-fa" tabindex="-1" id="ä½¿ç”¨ç‹¬ç«‹æµå®ç°å¹¶å‘">ä½¿ç”¨ç‹¬ç«‹æµå®ç°å¹¶å‘</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">__global__ void parent_kernel() &#123;</span><br><span class="line">    cudaStream_t stream;</span><br><span class="line">    cudaStreamCreateWithFlags(&amp;stream, cudaStreamNonBlocking);</span><br><span class="line">    </span><br><span class="line">    // åœ¨ç‹¬ç«‹æµä¸­å¯åŠ¨ï¼Œå¯ä»¥ä¸å…¶ä»– kernel å¹¶å‘</span><br><span class="line">    child_kernel&lt;&lt;&lt;1, 32, 0, stream&gt;&gt;&gt;();</span><br><span class="line">    </span><br><span class="line">    cudaStreamDestroy(stream);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="bing-fa-zi-kernel-shi-li" tabindex="-1" id="å¹¶å‘å­-kernel-ç¤ºä¾‹">å¹¶å‘å­ kernel ç¤ºä¾‹</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">__global__ void parent_kernel(float *data, int n) &#123;</span><br><span class="line">    int chunk_size = n / 4;</span><br><span class="line">    cudaStream_t streams[4];</span><br><span class="line">    </span><br><span class="line">    for (int i = 0; i &lt; 4; i++) &#123;</span><br><span class="line">        cudaStreamCreateWithFlags(&amp;streams[i], cudaStreamNonBlocking);</span><br><span class="line">        child_kernel&lt;&lt;&lt;1, 256, 0, streams[i]&gt;&gt;&gt;(</span><br><span class="line">            data + i * chunk_size, chunk_size);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // ç­‰å¾…æ‰€æœ‰æµå®Œæˆ</span><br><span class="line">    cudaDeviceSynchronize();</span><br><span class="line">    </span><br><span class="line">    for (int i = 0; i &lt; 4; i++) &#123;</span><br><span class="line">        cudaStreamDestroy(streams[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="qi-dong-chi-pei-zhi" tabindex="-1" id="å¯åŠ¨æ± é…ç½®">å¯åŠ¨æ± é…ç½®</h2><h3 id="shi-yao-shi-qi-dong-chi" tabindex="-1" id="ä»€ä¹ˆæ˜¯å¯åŠ¨æ± ">ä»€ä¹ˆæ˜¯å¯åŠ¨æ± </h3><p>æ¯æ¬¡å­ kernel å¯åŠ¨éœ€è¦ä»<strong>å¯åŠ¨æ± </strong>åˆ†é…èµ„æºã€‚</p><p><strong>ä¸¤ç§æ± </strong>ï¼š</p><ol><li><strong>å›ºå®šå¤§å°æ± </strong>ï¼šé»˜è®¤ 2048 ä¸ªæ§½ä½ï¼Œé¢„åˆ†é…</li><li><strong>è™šæ‹ŸåŒ–æ± </strong>ï¼šåŠ¨æ€æ‰©å±•ï¼Œä½†æ€§èƒ½è¾ƒä½</li></ol><h3 id="pei-zhi-qi-dong-chi" tabindex="-1" id="é…ç½®å¯åŠ¨æ± ">é…ç½®å¯åŠ¨æ± </h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// è·å–å½“å‰è®¾å¤‡å±æ€§</span><br><span class="line">cudaDeviceProp prop;</span><br><span class="line">cudaGetDeviceProperties(&amp;prop, 0);</span><br><span class="line"></span><br><span class="line">// è®¾ç½®å›ºå®šæ± å¤§å°</span><br><span class="line">cudaDeviceSetLimit(cudaLimitDevRuntimePendingLaunchCount, 8192);</span><br></pre></td></tr></table></figure><p><strong>å»ºè®®</strong>ï¼š</p><ul><li>å¦‚æœé¢„æœŸå­ kernel æ•°é‡è¶…è¿‡é»˜è®¤å€¼ï¼Œå¢å¤§å›ºå®šæ± </li><li>å¦‚æœå­ kernel æ•°é‡å¯é¢„æµ‹ï¼Œè®¾ç½®ä¸ºè¯¥å€¼</li></ul><h2 id="ying-yong-shi-li-bezier-qu-xian-xi-fen" tabindex="-1" id="åº”ç”¨ç¤ºä¾‹ï¼šBezier-æ›²çº¿ç»†åˆ†">åº”ç”¨ç¤ºä¾‹ï¼šBezier æ›²çº¿ç»†åˆ†</h2><h3 id="wen-ti-miao-shu" tabindex="-1" id="é—®é¢˜æè¿°">é—®é¢˜æè¿°</h3><p>Bezier æ›²çº¿ç”±æ§åˆ¶ç‚¹å®šä¹‰ã€‚æ›²çº¿è¶Šå¼¯æ›²ï¼Œéœ€è¦è¶Šå¤šé‡‡æ ·ç‚¹æ‰èƒ½å¹³æ»‘æ˜¾ç¤ºã€‚</p><p><strong>è‡ªé€‚åº”ç»†åˆ†</strong>ï¼šæ ¹æ®æ›²ç‡å†³å®šé‡‡æ ·ç‚¹æ•°é‡ã€‚</p><h3 id="shu-ju-jie-gou" tabindex="-1" id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#define MAX_TESS_POINTS 32</span><br><span class="line"></span><br><span class="line">struct BezierLine &#123;</span><br><span class="line">    float2 CP[3];                      // 3 ä¸ªæ§åˆ¶ç‚¹</span><br><span class="line">    float2 vertexPos[MAX_TESS_POINTS]; // ç»†åˆ†åçš„é¡¶ç‚¹</span><br><span class="line">    int nVertices;                     // é¡¶ç‚¹æ•°é‡</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="ji-suan-qu-lu" tabindex="-1" id="è®¡ç®—æ›²ç‡">è®¡ç®—æ›²ç‡</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">__device__ float computeCurvature(float2 *cp) &#123;</span><br><span class="line">    // è®¡ç®—é¦–å°¾è¿çº¿é•¿åº¦</span><br><span class="line">    float dx = cp[2].x - cp[0].x;</span><br><span class="line">    float dy = cp[2].y - cp[0].y;</span><br><span class="line">    float line_length = sqrtf(dx * dx + dy * dy);</span><br><span class="line">    </span><br><span class="line">    if (line_length &lt; 0.001f) return 0.0f;</span><br><span class="line">    </span><br><span class="line">    // è®¡ç®—ä¸­ç‚¹åˆ°ç›´çº¿çš„è·ç¦»ï¼ˆæ›²ç‡è¿‘ä¼¼ï¼‰</span><br><span class="line">    float cross = fabsf((cp[1].x - cp[0].x) * dy - </span><br><span class="line">                        (cp[1].y - cp[0].y) * dx);</span><br><span class="line">    return cross / line_length;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="zi-kernel-ji-suan-xi-fen-dian" tabindex="-1" id="å­-kernelï¼šè®¡ç®—ç»†åˆ†ç‚¹">å­ kernelï¼šè®¡ç®—ç»†åˆ†ç‚¹</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">__global__ void computeBezierLine_child(</span><br><span class="line">    int lidx, BezierLine *bLines, int nTessPoints) &#123;</span><br><span class="line">    </span><br><span class="line">    int idx = threadIdx.x + blockDim.x * blockIdx.x;</span><br><span class="line">    if (idx &lt; nTessPoints) &#123;</span><br><span class="line">        // è®¡ç®—å‚æ•° u âˆˆ [0, 1]</span><br><span class="line">        float u = (float)idx / (float)(nTessPoints - 1);</span><br><span class="line">        float omu = 1.0f - u;</span><br><span class="line">        </span><br><span class="line">        // äºŒæ¬¡ Bezier åŸºå‡½æ•°</span><br><span class="line">        float B[3];</span><br><span class="line">        B[0] = omu * omu;</span><br><span class="line">        B[1] = 2.0f * u * omu;</span><br><span class="line">        B[2] = u * u;</span><br><span class="line">        </span><br><span class="line">        // è®¡ç®—ç‚¹ä½ç½®</span><br><span class="line">        float2 pos = &#123;0, 0&#125;;</span><br><span class="line">        for (int i = 0; i &lt; 3; i++) &#123;</span><br><span class="line">            pos.x += B[i] * bLines[lidx].CP[i].x;</span><br><span class="line">            pos.y += B[i] * bLines[lidx].CP[i].y;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        bLines[lidx].vertexPos[idx] = pos;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="fu-kernel-dong-tai-jue-ding-xi-fen-cheng-du" tabindex="-1" id="çˆ¶-kernelï¼šåŠ¨æ€å†³å®šç»†åˆ†ç¨‹åº¦">çˆ¶ kernelï¼šåŠ¨æ€å†³å®šç»†åˆ†ç¨‹åº¦</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">__global__ void computeBezierLines_parent(</span><br><span class="line">    BezierLine *bLines, int nLines) &#123;</span><br><span class="line">    </span><br><span class="line">    int lidx = threadIdx.x + blockDim.x * blockIdx.x;</span><br><span class="line">    if (lidx &lt; nLines) &#123;</span><br><span class="line">        // æ ¹æ®æ›²ç‡è®¡ç®—éœ€è¦çš„é¡¶ç‚¹æ•°</span><br><span class="line">        float curvature = computeCurvature(bLines[lidx].CP);</span><br><span class="line">        int nVertices = min(max((int)(curvature * 16.0f), 4), </span><br><span class="line">                            MAX_TESS_POINTS);</span><br><span class="line">        bLines[lidx].nVertices = nVertices;</span><br><span class="line">        </span><br><span class="line">        // åŠ¨æ€å¯åŠ¨å­ kernel</span><br><span class="line">        int blocks = (nVertices + 31) / 32;</span><br><span class="line">        computeBezierLine_child&lt;&lt;&lt;blocks, 32&gt;&gt;&gt;(</span><br><span class="line">            lidx, bLines, nVertices);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="dong-tai-vs-jing-tai-dui-bi" tabindex="-1" id="åŠ¨æ€-vs-é™æ€å¯¹æ¯”">åŠ¨æ€ vs é™æ€å¯¹æ¯”</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// é™æ€ç‰ˆæœ¬ï¼šæ¯æ¡æ›²çº¿ä½¿ç”¨å›ºå®š Blockï¼Œå¾ªç¯å¤„ç†</span><br><span class="line">__global__ void computeBezierLines_static(</span><br><span class="line">    BezierLine *bLines, int nLines) &#123;</span><br><span class="line">    </span><br><span class="line">    int bidx = blockIdx.x;</span><br><span class="line">    if (bidx &lt; nLines) &#123;</span><br><span class="line">        float curvature = computeCurvature(bLines[bidx].CP);</span><br><span class="line">        int nVertices = min(max((int)(curvature * 16.0f), 4), </span><br><span class="line">                            MAX_TESS_POINTS);</span><br><span class="line">        bLines[bidx].nVertices = nVertices;</span><br><span class="line">        </span><br><span class="line">        // ç”¨å¾ªç¯ä»£æ›¿å­ kernel</span><br><span class="line">        for (int inc = 0; inc &lt; nVertices; inc += blockDim.x) &#123;</span><br><span class="line">            int idx = inc + threadIdx.x;</span><br><span class="line">            if (idx &lt; nVertices) &#123;</span><br><span class="line">                // ... è®¡ç®—é¡¶ç‚¹ ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å¯¹æ¯”</strong>ï¼š</p><table><thead><tr><th>æ–¹é¢</th><th>åŠ¨æ€å¹¶è¡Œ</th><th>é™æ€ç‰ˆæœ¬</th></tr></thead><tbody><tr><td>ä»£ç ç»“æ„</td><td>æ›´è‡ªç„¶</td><td>éœ€è¦æ‰‹åŠ¨å¾ªç¯</td></tr><tr><td>èµ„æºåˆ©ç”¨</td><td>å­ kernel ç²¾ç¡®é…ç½®</td><td>å¯èƒ½æµªè´¹çº¿ç¨‹</td></tr><tr><td>å¯åŠ¨å¼€é”€</td><td>è¾ƒé«˜</td><td>æ— é¢å¤–å¼€é”€</td></tr><tr><td>é€‚ç”¨åœºæ™¯</td><td>å·¥ä½œé‡å˜åŒ–å¤§</td><td>å·¥ä½œé‡å‡åŒ€</td></tr></tbody></table><h2 id="ying-yong-shi-li-si-cha-shu-gou-jian" tabindex="-1" id="åº”ç”¨ç¤ºä¾‹ï¼šå››å‰æ ‘æ„å»º">åº”ç”¨ç¤ºä¾‹ï¼šå››å‰æ ‘æ„å»º</h2><h3 id="wen-ti-miao-shu-1" tabindex="-1" id="é—®é¢˜æè¿°-2">é—®é¢˜æè¿°</h3><p><strong>å››å‰æ ‘ï¼ˆQuadtreeï¼‰</strong>ï¼šé€’å½’åœ°å°† 2D ç©ºé—´åˆ’åˆ†ä¸ºå››ä¸ªè±¡é™ï¼Œç”¨äºç©ºé—´ç´¢å¼•ã€ç¢°æ’æ£€æµ‹ã€å›¾åƒå‹ç¼©ç­‰ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">åˆå§‹åŒºåŸŸ         ç¬¬ä¸€æ¬¡åˆ’åˆ†         ç»§ç»­åˆ’åˆ†...</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”     â”Œâ”€â”€â”¬â”€â”€â”¬â”€â”€â”€â”€â”</span><br><span class="line">â”‚         â”‚     â”‚ TL â”‚ TR â”‚     â”‚  â”‚  â”‚ TR â”‚</span><br><span class="line">â”‚    *    â”‚  â†’  â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤  â†’  â”œâ”€â”€â”¼â”€â”€â”¼â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚   **    â”‚     â”‚ BL â”‚ BR â”‚     â”‚  â”‚  â”‚    â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜     â””â”€â”€â”´â”€â”€â”´â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure><h3 id="di-gui-suan-fa" tabindex="-1" id="é€’å½’ç®—æ³•">é€’å½’ç®—æ³•</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">function build_quadtree(node, points):</span><br><span class="line">    if depth &gt; max_depth or len(points) &lt; threshold:</span><br><span class="line">        return  // åœæ­¢é€’å½’</span><br><span class="line">    </span><br><span class="line">    // å°†ç‚¹åˆ†ç±»åˆ°å››ä¸ªè±¡é™</span><br><span class="line">    for each point in points:</span><br><span class="line">        classify to TL, TR, BL, or BR</span><br><span class="line">    </span><br><span class="line">    // é€’å½’å¤„ç†æ¯ä¸ªè±¡é™</span><br><span class="line">    build_quadtree(node.TL, TL_points)</span><br><span class="line">    build_quadtree(node.TR, TR_points)</span><br><span class="line">    build_quadtree(node.BL, BL_points)</span><br><span class="line">    build_quadtree(node.BR, BR_points)</span><br></pre></td></tr></table></figure><h3 id="shu-ju-jie-gou-1" tabindex="-1" id="æ•°æ®ç»“æ„-2">æ•°æ®ç»“æ„</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">class Quadtree_node &#123;</span><br><span class="line">    int m_id;                  // èŠ‚ç‚¹ ID</span><br><span class="line">    Bounding_box m_bbox;       // è¾¹ç•Œæ¡†</span><br><span class="line">    int m_begin, m_end;        // ç‚¹èŒƒå›´ [begin, end)</span><br><span class="line">    </span><br><span class="line">public:</span><br><span class="line">    __device__ int num_points() const &#123; return m_end - m_begin; &#125;</span><br><span class="line">    // ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct Parameters &#123;</span><br><span class="line">    int point_selector;         // åŒç¼“å†²é€‰æ‹©å™¨</span><br><span class="line">    int num_nodes_at_this_level; // å½“å‰å±‚èŠ‚ç‚¹æ•°</span><br><span class="line">    int depth;                  // å½“å‰æ·±åº¦</span><br><span class="line">    int max_depth;              // æœ€å¤§æ·±åº¦</span><br><span class="line">    int min_points_per_node;    // åœæ­¢é˜ˆå€¼</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="he-xin-kernel" tabindex="-1" id="æ ¸å¿ƒ-kernel">æ ¸å¿ƒ kernel</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">__global__ void build_quadtree_kernel(</span><br><span class="line">    Quadtree_node *nodes, Points *points, Parameters params) &#123;</span><br><span class="line">    </span><br><span class="line">    __shared__ int smem[8];  // æ¯ä¸ªè±¡é™çš„ç‚¹æ•°å’Œåç§»</span><br><span class="line">    </span><br><span class="line">    Quadtree_node *node = &amp;nodes[blockIdx.x];</span><br><span class="line">    int num_points = node-&gt;num_points();</span><br><span class="line">    </span><br><span class="line">    // æ£€æŸ¥åœæ­¢æ¡ä»¶</span><br><span class="line">    if (params.depth &gt;= params.max_depth || </span><br><span class="line">        num_points &lt;= params.min_points_per_node) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // è®¡ç®—è¾¹ç•Œæ¡†ä¸­å¿ƒ</span><br><span class="line">    float2 center;</span><br><span class="line">    node-&gt;bounding_box().compute_center(&amp;center);</span><br><span class="line">    </span><br><span class="line">    // ç»Ÿè®¡æ¯ä¸ªè±¡é™çš„ç‚¹æ•°</span><br><span class="line">    count_points_in_children(points[params.point_selector], </span><br><span class="line">                              smem, node, center);</span><br><span class="line">    </span><br><span class="line">    // è®¡ç®—é‡æ’åç§»</span><br><span class="line">    scan_for_offsets(node-&gt;points_begin(), smem);</span><br><span class="line">    </span><br><span class="line">    // é‡æ’ç‚¹åˆ°åŒç¼“å†²</span><br><span class="line">    reorder_points(points[(params.point_selector + 1) % 2],</span><br><span class="line">                   points[params.point_selector], smem, node, center);</span><br><span class="line">    </span><br><span class="line">    // é€’å½’å¯åŠ¨å­ kernel</span><br><span class="line">    if (threadIdx.x == 0) &#123;</span><br><span class="line">        Quadtree_node *children = </span><br><span class="line">            &amp;nodes[params.num_nodes_at_this_level + blockIdx.x * 4];</span><br><span class="line">        </span><br><span class="line">        prepare_children(children, node, smem, center);</span><br><span class="line">        </span><br><span class="line">        Parameters next_params(params, true);  // æ›´æ–°å‚æ•°</span><br><span class="line">        </span><br><span class="line">        for (int i = 0; i &lt; 4; i++) &#123;</span><br><span class="line">            if (smem[i] &gt; 0) &#123;  // åªå¤„ç†éç©ºè±¡é™</span><br><span class="line">                build_quadtree_kernel&lt;&lt;&lt;1, 32&gt;&gt;&gt;(</span><br><span class="line">                    &amp;children[i], points, next_params);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="dian-fen-lei-tong-ji-jie-duan" tabindex="-1" id="ç‚¹åˆ†ç±»ï¼ˆç»Ÿè®¡é˜¶æ®µï¼‰">ç‚¹åˆ†ç±»ï¼ˆç»Ÿè®¡é˜¶æ®µï¼‰</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">__device__ void count_points_in_children(</span><br><span class="line">    const Points &amp;in_points, int *smem, </span><br><span class="line">    int range_begin, int range_end, float2 center) &#123;</span><br><span class="line">    </span><br><span class="line">    // åˆå§‹åŒ–è®¡æ•°</span><br><span class="line">    if (threadIdx.x &lt; 4) &#123;</span><br><span class="line">        smem[threadIdx.x] = 0;</span><br><span class="line">    &#125;</span><br><span class="line">    __syncthreads();</span><br><span class="line">    </span><br><span class="line">    // æ¯ä¸ªçº¿ç¨‹å¤„ç†å¤šä¸ªç‚¹</span><br><span class="line">    for (int iter = range_begin + threadIdx.x; </span><br><span class="line">         iter &lt; range_end; iter += blockDim.x) &#123;</span><br><span class="line">        float2 p = in_points.get_point(iter);</span><br><span class="line">        </span><br><span class="line">        if (p.x &lt; center.x &amp;&amp; p.y &gt;= center.y) &#123;</span><br><span class="line">            atomicAdd(&amp;smem[0], 1);  // å·¦ä¸Š</span><br><span class="line">        &#125; else if (p.x &gt;= center.x &amp;&amp; p.y &gt;= center.y) &#123;</span><br><span class="line">            atomicAdd(&amp;smem[1], 1);  // å³ä¸Š</span><br><span class="line">        &#125; else if (p.x &lt; center.x &amp;&amp; p.y &lt; center.y) &#123;</span><br><span class="line">            atomicAdd(&amp;smem[2], 1);  // å·¦ä¸‹</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            atomicAdd(&amp;smem[3], 1);  // å³ä¸‹</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    __syncthreads();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="shen-du-fen-xi" tabindex="-1" id="æ·±åº¦åˆ†æ">æ·±åº¦åˆ†æ</h3><p>å‡è®¾åˆå§‹æœ‰ 64 ä¸ªå‡åŒ€åˆ†å¸ƒçš„ç‚¹ï¼š</p><table><thead><tr><th>æ·±åº¦</th><th>èŠ‚ç‚¹æ•°</th><th>æ¯èŠ‚ç‚¹ç‚¹æ•°</th></tr></thead><tbody><tr><td>0</td><td>1</td><td>64</td></tr><tr><td>1</td><td>4</td><td>16</td></tr><tr><td>2</td><td>16</td><td>4</td></tr><tr><td>3</td><td>64</td><td>1</td></tr></tbody></table><p>æ€»å…±å¯åŠ¨ 1 + 4 + 16 = <strong>21</strong> ä¸ªå­ kernelã€‚</p><h2 id="xing-neng-kao-lu" tabindex="-1" id="æ€§èƒ½è€ƒè™‘">æ€§èƒ½è€ƒè™‘</h2><h3 id="qi-dong-kai-xiao" tabindex="-1" id="å¯åŠ¨å¼€é”€">å¯åŠ¨å¼€é”€</h3><p>å­ kernel å¯åŠ¨æœ‰å¼€é”€ï¼š</p><ul><li>èµ„æºåˆ†é…</li><li>å‚æ•°ä¼ é€’</li><li>è°ƒåº¦å»¶è¿Ÿ</li></ul><p><strong>å»ºè®®</strong>ï¼šåªåœ¨å·¥ä½œé‡è¶³å¤Ÿå¤§æ—¶ä½¿ç”¨åŠ¨æ€å¹¶è¡Œã€‚</p><h3 id="qian-tao-shen-du-xian-zhi" tabindex="-1" id="åµŒå¥—æ·±åº¦é™åˆ¶">åµŒå¥—æ·±åº¦é™åˆ¶</h3><p>CUDA é™åˆ¶åµŒå¥—æ·±åº¦ï¼ˆé€šå¸¸ 24 å±‚ï¼‰ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// æ£€æŸ¥æ”¯æŒçš„åµŒå¥—æ·±åº¦</span><br><span class="line">int max_depth;</span><br><span class="line">cudaDeviceGetAttribute(&amp;max_depth, </span><br><span class="line">    cudaDevAttrMaxDeviceRuntimeSynchronizationDepth, 0);</span><br></pre></td></tr></table></figure><h3 id="nei-cun-xiao-hao" tabindex="-1" id="å†…å­˜æ¶ˆè€—">å†…å­˜æ¶ˆè€—</h3><p>æ¯å±‚é€’å½’æ¶ˆè€—æ ˆç©ºé—´ã€‚æ·±åº¦é€’å½’å¯èƒ½å¯¼è‡´æ ˆæº¢å‡ºã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// å¢å¤§æ ˆå¤§å°</span><br><span class="line">cudaDeviceSetLimit(cudaLimitStackSize, 8192);</span><br></pre></td></tr></table></figure><h3 id="he-shi-shi-yong-dong-tai-bing-xing" tabindex="-1" id="ä½•æ—¶ä½¿ç”¨åŠ¨æ€å¹¶è¡Œ">ä½•æ—¶ä½¿ç”¨åŠ¨æ€å¹¶è¡Œ</h3><p><strong>é€‚åˆä½¿ç”¨</strong>ï¼š</p><ul><li>é€’å½’ç®—æ³•ï¼ˆæ ‘éå†ã€åˆ†æ²»ï¼‰</li><li>è‡ªé€‚åº”ç»†åˆ†ï¼ˆç½‘æ ¼ç»†åŒ–ã€LODï¼‰</li><li>ä¸è§„åˆ™æ•°æ®ï¼ˆç¨€ç–å›¾ã€ä¸å¹³è¡¡æ ‘ï¼‰</li></ul><p><strong>ä¸é€‚åˆä½¿ç”¨</strong>ï¼š</p><ul><li>è§„åˆ™çš„æ•°æ®å¹¶è¡Œï¼ˆçŸ©é˜µè¿ç®—ï¼‰</li><li>å­ kernel å·¥ä½œé‡å¾ˆå°</li><li>éœ€è¦æè‡´æ€§èƒ½çš„åœºæ™¯</li></ul><h2 id="diao-shi-yu-zui-jia-shi-jian" tabindex="-1" id="è°ƒè¯•ä¸æœ€ä½³å®è·µ">è°ƒè¯•ä¸æœ€ä½³å®è·µ</h2><h3 id="cuo-wu-chu-li" tabindex="-1" id="é”™è¯¯å¤„ç†">é”™è¯¯å¤„ç†</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">__global__ void parent_kernel() &#123;</span><br><span class="line">    cudaError_t err;</span><br><span class="line">    </span><br><span class="line">    child_kernel&lt;&lt;&lt;1, 32&gt;&gt;&gt;();</span><br><span class="line">    err = cudaGetLastError();</span><br><span class="line">    if (err != cudaSuccess) &#123;</span><br><span class="line">        printf(&quot;Child kernel launch failed: %s\n&quot;, </span><br><span class="line">               cudaGetErrorString(err));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    err = cudaDeviceSynchronize();</span><br><span class="line">    if (err != cudaSuccess) &#123;</span><br><span class="line">        printf(&quot;Child kernel execution failed: %s\n&quot;, </span><br><span class="line">               cudaGetErrorString(err));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="bi-mian-guo-du-qian-tao" tabindex="-1" id="é¿å…è¿‡åº¦åµŒå¥—">é¿å…è¿‡åº¦åµŒå¥—</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">__global__ void recursive_kernel(int depth, int max_depth) &#123;</span><br><span class="line">    if (depth &gt;= max_depth) &#123;</span><br><span class="line">        return;  // åœæ­¢é€’å½’</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    recursive_kernel&lt;&lt;&lt;1, 32&gt;&gt;&gt;(depth + 1, max_depth);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="zi-yuan-guan-li" tabindex="-1" id="èµ„æºç®¡ç†">èµ„æºç®¡ç†</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">__global__ void parent_kernel() &#123;</span><br><span class="line">    float *temp;</span><br><span class="line">    cudaMalloc(&amp;temp, size);</span><br><span class="line">    </span><br><span class="line">    // ç¡®ä¿å­ kernel å®Œæˆåå†é‡Šæ”¾</span><br><span class="line">    child_kernel&lt;&lt;&lt;1, 32&gt;&gt;&gt;(temp);</span><br><span class="line">    cudaDeviceSynchronize();</span><br><span class="line">    </span><br><span class="line">    cudaFree(temp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="xiao-jie" tabindex="-1" id="å°ç»“">å°ç»“</h2><p>ç¬¬äºŒåä¸€ç« ä»‹ç»äº† CUDA åŠ¨æ€å¹¶è¡Œæ€§è¿™ä¸€é«˜çº§ç‰¹æ€§ï¼š</p><p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>ï¼šGPU kernel å¯ä»¥ç›´æ¥å¯åŠ¨å­ kernelï¼Œæ— éœ€è¿”å› CPUã€‚è¿™ä½¿å¾—é€’å½’ç®—æ³•å’Œè‡ªé€‚åº”è®¡ç®—å¯ä»¥å®Œå…¨åœ¨ GPU ä¸Šæ‰§è¡Œã€‚</p><p><strong>è¯­æ³•è¦ç‚¹</strong>ï¼š</p><ul><li>åœ¨ <code>__global__</code> å‡½æ•°ä¸­ä½¿ç”¨ <code>&lt;&lt;&lt;...&gt;&gt;&gt;</code> å¯åŠ¨å­ kernel</li><li><code>cudaDeviceSynchronize()</code> ç­‰å¾…å­ kernel å®Œæˆ</li><li>å¯ä»¥åœ¨è®¾å¤‡ç«¯ä½¿ç”¨ <code>cudaMalloc</code>/<code>cudaFree</code></li></ul><p><strong>å†…å­˜å¯è§æ€§</strong>ï¼š</p><ul><li>å…¨å±€ã€å¸¸é‡ã€çº¹ç†å†…å­˜çˆ¶å­å…±äº«</li><li>å…±äº«å†…å­˜å’Œå±€éƒ¨å†…å­˜ä¸èƒ½ä¼ é€’ç»™å­ kernel</li></ul><p><strong>æµä¸å¹¶å‘</strong>ï¼š</p><ul><li>åŒä¸€ Block çš„é»˜è®¤æµå…±äº«ï¼Œå­ kernel ä¸²è¡Œæ‰§è¡Œ</li><li>ä½¿ç”¨éé˜»å¡æµå®ç°å­ kernel å¹¶å‘</li></ul><p><strong>åº”ç”¨åœºæ™¯</strong>ï¼š</p><ul><li>Bezier æ›²çº¿è‡ªé€‚åº”ç»†åˆ†ï¼šæ ¹æ®æ›²ç‡åŠ¨æ€å†³å®šé‡‡æ ·å¯†åº¦</li><li>å››å‰æ ‘æ„å»ºï¼šé€’å½’åˆ’åˆ†ç©ºé—´</li></ul><p><strong>æ€§èƒ½è€ƒè™‘</strong>ï¼š</p><ul><li>å¯åŠ¨å¼€é”€ä¸å¯å¿½è§†</li><li>æ·±åº¦é€’å½’æ¶ˆè€—æ ˆç©ºé—´</li><li>é…ç½®å¯åŠ¨æ± å¤§å°</li></ul><p>åŠ¨æ€å¹¶è¡Œæ€§è®© GPU ç¼–ç¨‹æ›´åŠ çµæ´»ï¼Œä½†è¦æƒè¡¡ä½¿ç”¨â€”â€”å¯¹äºè§„åˆ™çš„æ•°æ®å¹¶è¡Œä»»åŠ¡ï¼Œä¼ ç»Ÿæ–¹å¼å¯èƒ½æ›´é«˜æ•ˆã€‚å¯¹äºå¤©ç„¶é€’å½’æˆ–è‡ªé€‚åº”çš„é—®é¢˜ï¼ŒåŠ¨æ€å¹¶è¡Œæ€§æ˜¯å¼ºå¤§çš„å·¥å…·ã€‚</p><hr><p><strong>å‚è€ƒèµ„æ–™ï¼š</strong></p><ul><li>Hwu, W., Kirk, D., &amp; El Hajj, I. (2022). <em>Programming Massively Parallel Processors: A Hands-on Approach</em> (4th Edition). Morgan Kaufmann.</li><li>NVIDIA. <em>CUDA C++ Programming Guide - Dynamic Parallelism</em>. <a href="https://docs.nvidia.com/cuda/cuda-c-programming-guide/">https://docs.nvidia.com/cuda/cuda-c-programming-guide/</a></li><li>NVIDIA. <em>CUDA Dynamic Parallelism</em>. <a href="https://developer.nvidia.com/blog/cuda-dynamic-parallelism-api-principles/">https://developer.nvidia.com/blog/cuda-dynamic-parallelism-api-principles/</a></li></ul><hr><blockquote><p><strong>æœ¬æ–‡ GitHub ä»“åº“</strong>: <a href="https://github.com/psmarter/PMPP-Learning">https://github.com/psmarter/PMPP-Learning</a></p></blockquote>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;qian-yan&quot; tabindex=&quot;-1&quot; id=&quot;å‰è¨€&quot;&gt;å‰è¨€&lt;/h2&gt;
&lt;p&gt;ç¬¬äºŒåç« ä»‹ç»äº†å¤š GPU é›†ç¾¤ç¼–ç¨‹ã€‚ç¬¬äºŒåä¸€ç« å›åˆ°å• GPU çš„é«˜çº§ç‰¹æ€§â€”â€”&lt;strong&gt;åŠ¨æ€å¹¶è¡Œæ€§ï¼ˆDynamic Parallelismï¼‰&lt;/strong&gt;ã€‚ä¼ ç»Ÿ</summary>
        
      
    
    
    
    <category term="çŸ¥è¯†åˆ†äº«" scheme="https://smarter.xin/categories/knowledge-sharing/"/>
    
    
    <category term="CUDA" scheme="https://smarter.xin/tags/CUDA/"/>
    
    <category term="GPUç¼–ç¨‹" scheme="https://smarter.xin/tags/gpu-programming/"/>
    
    <category term="å¹¶è¡Œè®¡ç®—" scheme="https://smarter.xin/tags/parallel-computing/"/>
    
    <category term="PMPP" scheme="https://smarter.xin/tags/PMPP/"/>
    
    <category term="åŠ¨æ€å¹¶è¡Œ" scheme="https://smarter.xin/tags/dynamic-parallel/"/>
    
    <category term="é€’å½’ç®—æ³•" scheme="https://smarter.xin/tags/recursive-algorithm/"/>
    
    <category term="å››å‰æ ‘" scheme="https://smarter.xin/tags/quadtree/"/>
    
  </entry>
  
  <entry>
    <title>PMPP-ç¬¬äºŒåç« ï¼šå¼‚æ„è®¡ç®—é›†ç¾¤ç¼–ç¨‹</title>
    <link href="https://smarter.xin/posts/9506dbb9/"/>
    <id>https://smarter.xin/posts/9506dbb9/</id>
    <published>2026-01-24T07:26:44.000Z</published>
    <updated>2026-01-24T08:26:21.332Z</updated>
    
    <content type="html"><![CDATA[<h2 id="qian-yan" tabindex="-1" id="å‰è¨€">å‰è¨€</h2><p>ç¬¬åä¹ç« æ€»ç»“äº†å¹¶è¡Œç¼–ç¨‹çš„æ€ç»´æ–¹æ³•ã€‚ç¬¬äºŒåç« å°†è§†é‡æ‰©å±•åˆ°<strong>è®¡ç®—é›†ç¾¤</strong>â€”â€”å¤šå°è®¡ç®—æœºé€šè¿‡ç½‘ç»œè¿æ¥ï¼Œæ¯å°è®¡ç®—æœºå¯èƒ½é…å¤‡å¤šä¸ª GPUã€‚è¿™æ˜¯å½“ä»Šè¶…çº§è®¡ç®—æœºå’Œæ•°æ®ä¸­å¿ƒçš„å…¸å‹æ¶æ„ã€‚æœ¬ç« è®¨è®ºå¦‚ä½•ä½¿ç”¨ <strong>MPIï¼ˆæ¶ˆæ¯ä¼ é€’æ¥å£ï¼‰</strong> ä¸ CUDA ç»“åˆï¼Œå®ç°è·¨èŠ‚ç‚¹çš„å¼‚æ„å¹¶è¡Œè®¡ç®—ã€‚æŒæ¡è¿™äº›æŠ€æœ¯ï¼Œä½ å°±èƒ½ç¼–å†™å¯æ‰©å±•åˆ°æ•°åƒä¸ª GPU çš„å¹¶è¡Œç¨‹åºã€‚</p><blockquote><p><strong>ğŸ“¦ é…å¥—èµ„æº</strong>ï¼šæœ¬ç³»åˆ—æ–‡ç« é…æœ‰å®Œæ•´çš„ <a href="https://github.com/psmarter/PMPP-Learning">GitHub ä»“åº“</a>ï¼ŒåŒ…å«æ¯ç« çš„ç»ƒä¹ é¢˜è§£ç­”ã€CUDA ä»£ç å®ç°å’Œè¯¦ç»†æ³¨é‡Šã€‚æ‰€æœ‰ä»£ç éƒ½ç»è¿‡æµ‹è¯•ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œã€‚</p></blockquote><h2 id="yi-gou-ji-suan-ji-qun-jia-gou" tabindex="-1" id="å¼‚æ„è®¡ç®—é›†ç¾¤æ¶æ„">å¼‚æ„è®¡ç®—é›†ç¾¤æ¶æ„</h2><h3 id="shi-yao-shi-yi-gou-ji-qun" tabindex="-1" id="ä»€ä¹ˆæ˜¯å¼‚æ„é›†ç¾¤">ä»€ä¹ˆæ˜¯å¼‚æ„é›†ç¾¤</h3><p><strong>å¼‚æ„é›†ç¾¤</strong>ï¼šç”±å¤šä¸ªè®¡ç®—èŠ‚ç‚¹ç»„æˆï¼Œæ¯ä¸ªèŠ‚ç‚¹åŒ…å«ï¼š</p><ul><li>CPUï¼ˆä¸»æœºï¼‰</li><li>ä¸€ä¸ªæˆ–å¤šä¸ª GPUï¼ˆåŠ é€Ÿå™¨ï¼‰</li><li>æœ¬åœ°å†…å­˜</li><li>ç½‘ç»œæ¥å£</li></ul><p>èŠ‚ç‚¹ä¹‹é—´é€šè¿‡é«˜é€Ÿç½‘ç»œï¼ˆå¦‚ InfiniBandã€NVLinkï¼‰è¿æ¥ã€‚</p><h3 id="dian-xing-jia-gou" tabindex="-1" id="å…¸å‹æ¶æ„">å…¸å‹æ¶æ„</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚                    è®¡ç®—é›†ç¾¤                              â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚    èŠ‚ç‚¹ 0       â”‚    èŠ‚ç‚¹ 1       â”‚    èŠ‚ç‚¹ N-1         â”‚</span><br><span class="line">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚</span><br><span class="line">â”‚  â”‚  CPU    â”‚   â”‚  â”‚  CPU    â”‚   â”‚  â”‚  CPU    â”‚        â”‚</span><br><span class="line">â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜        â”‚</span><br><span class="line">â”‚       â”‚        â”‚       â”‚        â”‚       â”‚             â”‚</span><br><span class="line">â”‚  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”   â”‚  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”   â”‚  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”        â”‚</span><br><span class="line">â”‚  â”‚GPU0â”‚GPU1â”‚   â”‚  â”‚GPU0â”‚GPU1â”‚   â”‚  â”‚GPU0â”‚GPU1â”‚        â”‚</span><br><span class="line">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">         â”‚                â”‚                â”‚</span><br><span class="line">         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">                    é«˜é€Ÿç½‘ç»œ</span><br></pre></td></tr></table></figure><h3 id="bian-cheng-tiao-zhan" tabindex="-1" id="ç¼–ç¨‹æŒ‘æˆ˜">ç¼–ç¨‹æŒ‘æˆ˜</h3><ol><li><strong>åˆ†å¸ƒå¼å†…å­˜</strong>ï¼šæ¯ä¸ªèŠ‚ç‚¹æœ‰ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ï¼Œä¸èƒ½ç›´æ¥è®¿é—®</li><li><strong>æ•°æ®é€šä¿¡</strong>ï¼šéœ€è¦æ˜¾å¼åœ°åœ¨èŠ‚ç‚¹é—´ä¼ é€’æ•°æ®</li><li><strong>åŒæ­¥åè°ƒ</strong>ï¼šå¤šä¸ªè¿›ç¨‹éœ€è¦åè°ƒå·¥ä½œ</li><li><strong>æ•…éšœå®¹é”™</strong>ï¼šå•ä¸ªèŠ‚ç‚¹æ•…éšœä¸åº”å¯¼è‡´æ•´ä¸ªè®¡ç®—å´©æºƒ</li></ol><h2 id="mpi-ji-chu" tabindex="-1" id="MPI-åŸºç¡€">MPI åŸºç¡€</h2><h3 id="shi-yao-shi-mpi" tabindex="-1" id="ä»€ä¹ˆæ˜¯-MPI">ä»€ä¹ˆæ˜¯ MPI</h3><p><strong>MPIï¼ˆMessage Passing Interfaceï¼‰</strong>ï¼šä¸€ç§æ ‡å‡†åŒ–çš„æ¶ˆæ¯ä¼ é€’ç¼–ç¨‹æ¨¡å‹ã€‚</p><ul><li>å®šä¹‰äº†è¿›ç¨‹é—´é€šä¿¡çš„ API</li><li>æ”¯æŒç‚¹å¯¹ç‚¹é€šä¿¡å’Œé›†åˆé€šä¿¡</li><li>ä¸ç¡¬ä»¶æ— å…³ï¼Œå¯ç§»æ¤æ€§å¥½</li></ul><p>å¸¸è§å®ç°ï¼šOpenMPIã€MPICHã€Intel MPIã€‚</p><h3 id="ji-ben-gai-nian" tabindex="-1" id="åŸºæœ¬æ¦‚å¿µ">åŸºæœ¬æ¦‚å¿µ</h3><p><strong>è¿›ç¨‹ï¼ˆProcessï¼‰</strong>ï¼šMPI ç¨‹åºçš„åŸºæœ¬æ‰§è¡Œå•å…ƒã€‚æ¯ä¸ªè¿›ç¨‹æœ‰ï¼š</p><ul><li>å”¯ä¸€çš„<strong>ç§©ï¼ˆRankï¼‰</strong>ï¼š0 åˆ° N-1</li><li>ç‹¬ç«‹çš„åœ°å€ç©ºé—´</li><li>å¯ä»¥è¿è¡Œåœ¨ä¸åŒçš„ç‰©ç†èŠ‚ç‚¹ä¸Š</li></ul><p><strong>é€šä¿¡å­ï¼ˆCommunicatorï¼‰</strong>ï¼šå®šä¹‰å‚ä¸é€šä¿¡çš„è¿›ç¨‹ç»„ã€‚</p><ul><li><code>MPI_COMM_WORLD</code>ï¼šåŒ…å«æ‰€æœ‰è¿›ç¨‹çš„é»˜è®¤é€šä¿¡å­</li></ul><h3 id="mpi-cheng-xu-gu-jia" tabindex="-1" id="MPI-ç¨‹åºéª¨æ¶">MPI ç¨‹åºéª¨æ¶</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mpi.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="type">int</span> rank, size;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆå§‹åŒ– MPI</span></span><br><span class="line">    MPI_Init(&amp;argc, &amp;argv);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–å½“å‰è¿›ç¨‹çš„ç§©</span></span><br><span class="line">    MPI_Comm_rank(MPI_COMM_WORLD, &amp;rank);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–è¿›ç¨‹æ€»æ•°</span></span><br><span class="line">    MPI_Comm_size(MPI_COMM_WORLD, &amp;size);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;è¿›ç¨‹ %d / %d\n&quot;</span>, rank, size);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®¡ç®—å’Œé€šä¿¡...</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç»“æŸ MPI</span></span><br><span class="line">    MPI_Finalize();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è¿è¡Œæ–¹å¼</strong>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mpirun -np 4 ./my_program   <span class="comment"># å¯åŠ¨ 4 ä¸ªè¿›ç¨‹</span></span><br></pre></td></tr></table></figure><h2 id="dian-dui-dian-tong-xin" tabindex="-1" id="ç‚¹å¯¹ç‚¹é€šä¿¡">ç‚¹å¯¹ç‚¹é€šä¿¡</h2><h3 id="ji-ben-fa-song-he-jie-shou" tabindex="-1" id="åŸºæœ¬å‘é€å’Œæ¥æ”¶">åŸºæœ¬å‘é€å’Œæ¥æ”¶</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‘é€</span></span><br><span class="line">MPI_Send(</span><br><span class="line">    <span class="type">void</span> *buf,          <span class="comment">// å‘é€ç¼“å†²åŒº</span></span><br><span class="line">    <span class="type">int</span> count,          <span class="comment">// å…ƒç´ ä¸ªæ•°</span></span><br><span class="line">    MPI_Datatype dtype, <span class="comment">// æ•°æ®ç±»å‹ï¼ˆMPI_FLOAT, MPI_INT ç­‰ï¼‰</span></span><br><span class="line">    <span class="type">int</span> dest,           <span class="comment">// ç›®æ ‡è¿›ç¨‹ç§©</span></span><br><span class="line">    <span class="type">int</span> tag,            <span class="comment">// æ¶ˆæ¯æ ‡ç­¾</span></span><br><span class="line">    MPI_Comm comm       <span class="comment">// é€šä¿¡å­</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¥æ”¶</span></span><br><span class="line">MPI_Recv(</span><br><span class="line">    <span class="type">void</span> *buf,          <span class="comment">// æ¥æ”¶ç¼“å†²åŒº</span></span><br><span class="line">    <span class="type">int</span> count,          <span class="comment">// æœ€å¤§å…ƒç´ ä¸ªæ•°</span></span><br><span class="line">    MPI_Datatype dtype, <span class="comment">// æ•°æ®ç±»å‹</span></span><br><span class="line">    <span class="type">int</span> source,         <span class="comment">// æºè¿›ç¨‹ç§©</span></span><br><span class="line">    <span class="type">int</span> tag,            <span class="comment">// æ¶ˆæ¯æ ‡ç­¾</span></span><br><span class="line">    MPI_Comm comm,      <span class="comment">// é€šä¿¡å­</span></span><br><span class="line">    MPI_Status *status  <span class="comment">// çŠ¶æ€ä¿¡æ¯</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><h3 id="zu-sai-yu-fei-zu-sai" tabindex="-1" id="é˜»å¡ä¸éé˜»å¡">é˜»å¡ä¸éé˜»å¡</h3><p><strong>é˜»å¡é€šä¿¡</strong>ï¼šå‡½æ•°è¿”å›æ—¶ï¼Œæ“ä½œå·²å®Œæˆæˆ–ç¼“å†²åŒºå¯å®‰å…¨å¤ç”¨ã€‚</p><ul><li><code>MPI_Send</code>ï¼šå¯èƒ½é˜»å¡ç›´åˆ°æ¥æ”¶æ–¹å‡†å¤‡å¥½ï¼ˆå–å†³äºå®ç°ï¼‰</li><li><code>MPI_Recv</code>ï¼šé˜»å¡ç›´åˆ°æ¶ˆæ¯åˆ°è¾¾</li></ul><p><strong>éé˜»å¡é€šä¿¡</strong>ï¼šå‡½æ•°ç«‹å³è¿”å›ï¼Œåç»­æ£€æŸ¥å®ŒæˆçŠ¶æ€ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">MPI_Request request;</span><br><span class="line"></span><br><span class="line"><span class="comment">// éé˜»å¡å‘é€</span></span><br><span class="line">MPI_Isend(buf, count, dtype, dest, tag, comm, &amp;request);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åšå…¶ä»–äº‹æƒ…...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç­‰å¾…å®Œæˆ</span></span><br><span class="line">MPI_Wait(&amp;request, &amp;status);</span><br></pre></td></tr></table></figure><h3 id="send-receive-zu-he" tabindex="-1" id="Send-Receive-ç»„åˆ">Send-Receive ç»„åˆ</h3><p>é¿å…æ­»é”çš„å¸¸ç”¨æ¨¡å¼ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MPI_Sendrecv(</span><br><span class="line">    send_buf, send_count, send_type, dest, send_tag,</span><br><span class="line">    recv_buf, recv_count, recv_type, source, recv_tag,</span><br><span class="line">    comm, &amp;status</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>åŒæ—¶å‘é€å’Œæ¥æ”¶ï¼Œç³»ç»Ÿè‡ªåŠ¨å¤„ç†é¡ºåºã€‚</p><h2 id="mpi-cuda-bian-cheng" tabindex="-1" id="MPI-CUDA-ç¼–ç¨‹">MPI + CUDA ç¼–ç¨‹</h2><h3 id="ji-ben-ce-lue" tabindex="-1" id="åŸºæœ¬ç­–ç•¥">åŸºæœ¬ç­–ç•¥</h3><p>æ¯ä¸ª MPI è¿›ç¨‹ç®¡ç†ä¸€ä¸ªæˆ–å¤šä¸ª GPUï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> rank;</span><br><span class="line">MPI_Comm_rank(MPI_COMM_WORLD, &amp;rank);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¯ä¸ªè¿›ç¨‹é€‰æ‹©ä¸åŒçš„ GPU</span></span><br><span class="line"><span class="type">int</span> num_devices;</span><br><span class="line">cudaGetDeviceCount(&amp;num_devices);</span><br><span class="line">cudaSetDevice(rank % num_devices);</span><br></pre></td></tr></table></figure><h3 id="shu-ju-liu-mo-shi" tabindex="-1" id="æ•°æ®æµæ¨¡å¼">æ•°æ®æµæ¨¡å¼</h3><p>å…¸å‹çš„ MPI + CUDA è®¡ç®—æµç¨‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. MPI è¿›ç¨‹æ¥æ”¶è¾“å…¥æ•°æ®ï¼ˆä¸»æœºå†…å­˜ï¼‰</span><br><span class="line">2. å¤åˆ¶æ•°æ®åˆ° GPUï¼ˆcudaMemcpy H2Dï¼‰</span><br><span class="line">3. GPU è®¡ç®—ï¼ˆkernelï¼‰</span><br><span class="line">4. å¤åˆ¶ç»“æœåˆ°ä¸»æœºï¼ˆcudaMemcpy D2Hï¼‰</span><br><span class="line">5. MPI è¿›ç¨‹å‘é€ç»“æœ</span><br></pre></td></tr></table></figure><h3 id="shi-li-fen-bu-shi-xiang-liang-jia-fa" tabindex="-1" id="ç¤ºä¾‹ï¼šåˆ†å¸ƒå¼å‘é‡åŠ æ³•">ç¤ºä¾‹ï¼šåˆ†å¸ƒå¼å‘é‡åŠ æ³•</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">distributed_vector_add</span><span class="params">(<span class="type">float</span> *a, <span class="type">float</span> *b, <span class="type">float</span> *c, <span class="type">int</span> n, <span class="type">int</span> rank, <span class="type">int</span> size)</span> &#123;</span><br><span class="line">    <span class="type">int</span> local_n = n / size;</span><br><span class="line">    <span class="type">int</span> start = rank * local_n;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ†é… GPU å†…å­˜</span></span><br><span class="line">    <span class="type">float</span> *d_a, *d_b, *d_c;</span><br><span class="line">    cudaMalloc(&amp;d_a, local_n * <span class="keyword">sizeof</span>(<span class="type">float</span>));</span><br><span class="line">    cudaMalloc(&amp;d_b, local_n * <span class="keyword">sizeof</span>(<span class="type">float</span>));</span><br><span class="line">    cudaMalloc(&amp;d_c, local_n * <span class="keyword">sizeof</span>(<span class="type">float</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¤åˆ¶æœ¬åœ°æ•°æ®åˆ° GPU</span></span><br><span class="line">    cudaMemcpy(d_a, a + start, local_n * <span class="keyword">sizeof</span>(<span class="type">float</span>), cudaMemcpyHostToDevice);</span><br><span class="line">    cudaMemcpy(d_b, b + start, local_n * <span class="keyword">sizeof</span>(<span class="type">float</span>), cudaMemcpyHostToDevice);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// GPU è®¡ç®—</span></span><br><span class="line">    <span class="type">int</span> block_size = <span class="number">256</span>;</span><br><span class="line">    <span class="type">int</span> grid_size = (local_n + block_size - <span class="number">1</span>) / block_size;</span><br><span class="line">    vector_add&lt;&lt;&lt;grid_size, block_size&gt;&gt;&gt;(d_a, d_b, d_c, local_n);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¤åˆ¶ç»“æœå›ä¸»æœº</span></span><br><span class="line">    cudaMemcpy(c + start, d_c, local_n * <span class="keyword">sizeof</span>(<span class="type">float</span>), cudaMemcpyDeviceToHost);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ”¶é›†æ‰€æœ‰ç»“æœåˆ°è¿›ç¨‹ 0</span></span><br><span class="line">    MPI_Gather(c + start, local_n, MPI_FLOAT,</span><br><span class="line">               c, local_n, MPI_FLOAT,</span><br><span class="line">               <span class="number">0</span>, MPI_COMM_WORLD);</span><br><span class="line">    </span><br><span class="line">    cudaFree(d_a);</span><br><span class="line">    cudaFree(d_b);</span><br><span class="line">    cudaFree(d_c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="halo-jiao-huan-yu-bian-jie-tong-xin" tabindex="-1" id="Halo-äº¤æ¢ä¸è¾¹ç•Œé€šä¿¡">Halo äº¤æ¢ä¸è¾¹ç•Œé€šä¿¡</h2><h3 id="shi-yao-shi-halo" tabindex="-1" id="ä»€ä¹ˆæ˜¯-Halo">ä»€ä¹ˆæ˜¯ Halo</h3><p>åœ¨æ¨¡æ¿è®¡ç®—ï¼ˆstencilï¼‰ã€æœ‰é™å·®åˆ†ç­‰åº”ç”¨ä¸­ï¼Œæ¯ä¸ªç‚¹çš„è®¡ç®—ä¾èµ–äºé‚»è¿‘ç‚¹ã€‚</p><p>å½“æ•°æ®åˆ†å¸ƒåœ¨å¤šä¸ªè¿›ç¨‹æ—¶ï¼Œè¾¹ç•Œç‚¹çš„è®¡ç®—éœ€è¦<strong>ç›¸é‚»è¿›ç¨‹çš„æ•°æ®</strong>ã€‚</p><p><strong>Haloï¼ˆå…‰æ™•/å¹½çµåŒºåŸŸï¼‰</strong>ï¼šå­˜å‚¨æ¥è‡ªé‚»å±…è¿›ç¨‹çš„è¾¹ç•Œæ•°æ®ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">è¿›ç¨‹ 0 çš„æ•°æ®        è¿›ç¨‹ 1 çš„æ•°æ®</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚              â”‚    â”‚              â”‚</span><br><span class="line">â”‚   å†…éƒ¨åŒºåŸŸ   â”‚    â”‚   å†…éƒ¨åŒºåŸŸ   â”‚</span><br><span class="line">â”‚              â”‚    â”‚              â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚  å³è¾¹ç•Œ â†’â†’â†’  â”‚ â†”  â”‚ â†â†â† å·¦ Halo â”‚</span><br><span class="line">â”‚ (å‘é€ç»™ P1)  â”‚    â”‚ (æ¥è‡ª P0)   â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure><h3 id="3-d-mo-ban-ji-suan-shi-li" tabindex="-1" id="3D-æ¨¡æ¿è®¡ç®—ç¤ºä¾‹">3D æ¨¡æ¿è®¡ç®—ç¤ºä¾‹</h3><p>ä»¥ 25 ç‚¹æ¨¡æ¿ä¸ºä¾‹ï¼ˆæ¯ä¸ªæ–¹å‘å»¶ä¼¸ 4 ä¸ªç‚¹ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è®¡ç®—æ¯ä¸ªè¿›ç¨‹éœ€è¦å¤šå°‘ Halo ç‚¹</span></span><br><span class="line"><span class="type">int</span> halo_size = <span class="number">4</span>;  <span class="comment">// æ¯ä¾§ 4 å±‚</span></span><br><span class="line"><span class="type">int</span> num_halo_points = dimx * dimy * halo_size;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ†é…åŒ…å« Halo çš„æ•°æ®</span></span><br><span class="line"><span class="type">int</span> total_z = local_dimz + <span class="number">2</span> * halo_size;</span><br><span class="line"><span class="type">float</span> *data = <span class="built_in">malloc</span>(dimx * dimy * total_z * <span class="keyword">sizeof</span>(<span class="type">float</span>));</span><br></pre></td></tr></table></figure><h3 id="halo-jiao-huan-shi-xian" tabindex="-1" id="Halo-äº¤æ¢å®ç°">Halo äº¤æ¢å®ç°</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">exchange_halos</span><span class="params">(<span class="type">float</span> *data, <span class="type">int</span> dimx, <span class="type">int</span> dimy, <span class="type">int</span> dimz,</span></span><br><span class="line"><span class="params">                     <span class="type">int</span> left_neighbor, <span class="type">int</span> right_neighbor)</span> &#123;</span><br><span class="line">    <span class="type">int</span> halo_size = <span class="number">4</span>;</span><br><span class="line">    <span class="type">int</span> num_halo_points = dimx * dimy * halo_size;</span><br><span class="line">    </span><br><span class="line">    <span class="type">float</span> *left_send = data + num_halo_points;  <span class="comment">// å·¦è¾¹ç•Œæ•°æ®</span></span><br><span class="line">    <span class="type">float</span> *right_send = data + dimx * dimy * (dimz - halo_size);  <span class="comment">// å³è¾¹ç•Œæ•°æ®</span></span><br><span class="line">    <span class="type">float</span> *left_recv = data;  <span class="comment">// å·¦ Halo æ¥æ”¶åŒº</span></span><br><span class="line">    <span class="type">float</span> *right_recv = data + dimx * dimy * (dimz + halo_size);  <span class="comment">// å³ Halo æ¥æ”¶åŒº</span></span><br><span class="line">    </span><br><span class="line">    MPI_Status status;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å‘é€åˆ°å·¦é‚»å±…ï¼Œä»å³é‚»å±…æ¥æ”¶</span></span><br><span class="line">    MPI_Sendrecv(left_send, num_halo_points, MPI_FLOAT, left_neighbor, <span class="number">0</span>,</span><br><span class="line">                 right_recv, num_halo_points, MPI_FLOAT, right_neighbor, <span class="number">0</span>,</span><br><span class="line">                 MPI_COMM_WORLD, &amp;status);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å‘é€åˆ°å³é‚»å±…ï¼Œä»å·¦é‚»å±…æ¥æ”¶</span></span><br><span class="line">    MPI_Sendrecv(right_send, num_halo_points, MPI_FLOAT, right_neighbor, <span class="number">1</span>,</span><br><span class="line">                 left_recv, num_halo_points, MPI_FLOAT, left_neighbor, <span class="number">1</span>,</span><br><span class="line">                 MPI_COMM_WORLD, &amp;status);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ji-suan-yu-tong-xin-zhong-die" tabindex="-1" id="è®¡ç®—ä¸é€šä¿¡é‡å ">è®¡ç®—ä¸é€šä¿¡é‡å </h2><h3 id="wen-ti" tabindex="-1" id="é—®é¢˜">é—®é¢˜</h3><p>é€šä¿¡éœ€è¦æ—¶é—´ï¼Œå¦‚æœå…ˆè®¡ç®—å®Œå†é€šä¿¡ï¼ŒGPU ä¼šç©ºé—²ç­‰å¾…ã€‚</p><h3 id="jie-jue-fang-an" tabindex="-1" id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ</h3><p><strong>æ€è·¯</strong>ï¼šé‡å è®¡ç®—ä¸é€šä¿¡ã€‚</p><ol><li>å…ˆè®¡ç®—è¾¹ç•ŒåŒºåŸŸï¼ˆé€šä¿¡éœ€è¦çš„æ•°æ®ï¼‰</li><li>è¾¹ç•Œè®¡ç®—å®Œæˆåï¼Œå¼€å§‹é€šä¿¡</li><li>åŒæ—¶è®¡ç®—å†…éƒ¨åŒºåŸŸ</li><li>é€šä¿¡å®Œæˆåï¼Œæ‰€æœ‰è®¡ç®—éƒ½å®Œæˆäº†</li></ol><h3 id="cuda-liu-shi-xian" tabindex="-1" id="CUDA-æµå®ç°">CUDA æµå®ç°</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">cudaStream_t stream_boundary, stream_internal;</span><br><span class="line">cudaStreamCreate(&amp;stream_boundary);</span><br><span class="line">cudaStreamCreate(&amp;stream_internal);</span><br><span class="line"></span><br><span class="line">// é˜¶æ®µ 1ï¼šè®¡ç®—è¾¹ç•Œï¼ˆåœ¨ stream_boundary ä¸­ï¼‰</span><br><span class="line">stencil_kernel&lt;&lt;&lt;grid_boundary, block, 0, stream_boundary&gt;&gt;&gt;(</span><br><span class="line">    d_output + left_offset, d_input + left_offset, dimx, dimy, 12);</span><br><span class="line">stencil_kernel&lt;&lt;&lt;grid_boundary, block, 0, stream_boundary&gt;&gt;&gt;(</span><br><span class="line">    d_output + right_offset, d_input + right_offset, dimx, dimy, 12);</span><br><span class="line"></span><br><span class="line">// é˜¶æ®µ 2ï¼šåŒæ—¶è¿›è¡Œâ€”â€”</span><br><span class="line">// 2a: è®¡ç®—å†…éƒ¨åŒºåŸŸï¼ˆåœ¨ stream_internal ä¸­ï¼‰</span><br><span class="line">stencil_kernel&lt;&lt;&lt;grid_internal, block, 0, stream_internal&gt;&gt;&gt;(</span><br><span class="line">    d_output + internal_offset, d_input + internal_offset, dimx, dimy, dimz - 8);</span><br><span class="line"></span><br><span class="line">// 2b: å¤åˆ¶è¾¹ç•Œåˆ°ä¸»æœºï¼Œå‡†å¤‡å‘é€</span><br><span class="line">cudaMemcpyAsync(h_left_boundary, d_output + boundary_left,</span><br><span class="line">                num_halo_bytes, cudaMemcpyDeviceToHost, stream_boundary);</span><br><span class="line">cudaMemcpyAsync(h_right_boundary, d_output + boundary_right,</span><br><span class="line">                num_halo_bytes, cudaMemcpyDeviceToHost, stream_boundary);</span><br><span class="line"></span><br><span class="line">// ç­‰å¾…è¾¹ç•Œå¤åˆ¶å®Œæˆ</span><br><span class="line">cudaStreamSynchronize(stream_boundary);</span><br><span class="line"></span><br><span class="line">// é˜¶æ®µ 3ï¼šMPI é€šä¿¡</span><br><span class="line">MPI_Sendrecv(h_left_boundary, num_halo_points, MPI_FLOAT, left_neighbor, 0,</span><br><span class="line">             h_right_halo, num_halo_points, MPI_FLOAT, right_neighbor, 0,</span><br><span class="line">             MPI_COMM_WORLD, &amp;status);</span><br><span class="line">MPI_Sendrecv(h_right_boundary, num_halo_points, MPI_FLOAT, right_neighbor, 1,</span><br><span class="line">             h_left_halo, num_halo_points, MPI_FLOAT, left_neighbor, 1,</span><br><span class="line">             MPI_COMM_WORLD, &amp;status);</span><br><span class="line"></span><br><span class="line">// å¤åˆ¶ Halo å› GPU</span><br><span class="line">cudaMemcpyAsync(d_output + left_halo_offset, h_left_halo,</span><br><span class="line">                num_halo_bytes, cudaMemcpyHostToDevice, stream_boundary);</span><br><span class="line">cudaMemcpyAsync(d_output + right_halo_offset, h_right_halo,</span><br><span class="line">                num_halo_bytes, cudaMemcpyHostToDevice, stream_boundary);</span><br><span class="line"></span><br><span class="line">// ç­‰å¾…æ‰€æœ‰æ“ä½œå®Œæˆ</span><br><span class="line">cudaDeviceSynchronize();</span><br></pre></td></tr></table></figure><h3 id="shi-jian-xian-fen-xi" tabindex="-1" id="æ—¶é—´çº¿åˆ†æ">æ—¶é—´çº¿åˆ†æ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">                    æ—¶é—´ â†’</span><br><span class="line">stream_boundary:  [è¾¹ç•Œè®¡ç®—][D2H][       ][H2D]</span><br><span class="line">stream_internal:  [           å†…éƒ¨è®¡ç®—          ]</span><br><span class="line">MPI é€šä¿¡:         [      ][Sendrecv][      ]</span><br><span class="line">                           â†‘</span><br><span class="line">                     é‡å åŒºåŸŸï¼šå†…éƒ¨è®¡ç®—</span><br><span class="line">                     ä¸ MPI é€šä¿¡åŒæ—¶è¿›è¡Œ</span><br></pre></td></tr></table></figure><h2 id="cuda-aware-mpi" tabindex="-1" id="CUDA-Aware-MPI">CUDA-Aware MPI</h2><h3 id="chuan-tong-fang-shi-de-wen-ti" tabindex="-1" id="ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜">ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¼ ç»Ÿæ–¹å¼ï¼šå¿…é¡»ç»è¿‡ä¸»æœºå†…å­˜</span></span><br><span class="line">cudaMemcpy(h_buf, d_buf, size, cudaMemcpyDeviceToHost);  <span class="comment">// GPU â†’ CPU</span></span><br><span class="line">MPI_Send(h_buf, count, MPI_FLOAT, dest, tag, comm);       <span class="comment">// CPU â†’ ç½‘ç»œ</span></span><br><span class="line"><span class="comment">// æ¥æ”¶ç«¯</span></span><br><span class="line">MPI_Recv(h_buf, count, MPI_FLOAT, src, tag, comm, &amp;status);  <span class="comment">// ç½‘ç»œ â†’ CPU  </span></span><br><span class="line">cudaMemcpy(d_buf, h_buf, size, cudaMemcpyHostToDevice);      <span class="comment">// CPU â†’ GPU</span></span><br></pre></td></tr></table></figure><p><strong>é—®é¢˜</strong>ï¼šé¢å¤–çš„å†…å­˜æ‹·è´å¼€é”€ã€‚</p><h3 id="cuda-aware-mpi-1" tabindex="-1" id="CUDA-Aware-MPI-2">CUDA-Aware MPI</h3><p><strong>CUDA-Aware MPI</strong>ï¼šMPI å®ç°èƒ½ç›´æ¥è¯†åˆ« GPU æŒ‡é’ˆã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç›´æ¥ä¼ é€’ GPU æŒ‡é’ˆâ€”â€”ä¸éœ€è¦æ‰‹åŠ¨æ‹·è´</span></span><br><span class="line">MPI_Send(d_buf, count, MPI_FLOAT, dest, tag, comm);</span><br><span class="line">MPI_Recv(d_buf, count, MPI_FLOAT, src, tag, comm, &amp;status);</span><br></pre></td></tr></table></figure><p>MPI åº“è‡ªåŠ¨å¤„ç†ï¼š</p><ul><li>é€šè¿‡ GPUDirect RDMA ç›´æ¥ GPU åˆ° GPU ä¼ è¾“</li><li>å¦‚æœä¸æ”¯æŒï¼Œè‡ªåŠ¨å›é€€åˆ°ç»è¿‡ä¸»æœºçš„æ–¹å¼</li></ul><h3 id="huan-jing-pei-zhi" tabindex="-1" id="ç¯å¢ƒé…ç½®">ç¯å¢ƒé…ç½®</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¼–è¯‘æ—¶é“¾æ¥ CUDA-Aware MPI</span></span><br><span class="line">mpicc -o my_prog my_prog.c -I<span class="variable">$&#123;CUDA_HOME&#125;</span>/include -L<span class="variable">$&#123;CUDA_HOME&#125;</span>/lib64 -lcudart</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿è¡Œå‰è®¾ç½®</span></span><br><span class="line"><span class="built_in">export</span> UCX_RNDV_SCHEME=cuda</span><br><span class="line"><span class="built_in">export</span> UCX_TLS=rc,cuda_copy,cuda_ipc</span><br></pre></td></tr></table></figure><h3 id="shi-yong-cuda-aware-mpi-gai-xie" tabindex="-1" id="ä½¿ç”¨-CUDA-Aware-MPI-æ”¹å†™">ä½¿ç”¨ CUDA-Aware MPI æ”¹å†™</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ— éœ€ host bufferï¼Œç›´æ¥ä½¿ç”¨ device buffer</span></span><br><span class="line">MPI_Sendrecv(d_output + boundary_left, num_halo_points, MPI_FLOAT, left_neighbor, <span class="number">0</span>,</span><br><span class="line">             d_output + right_halo_offset, num_halo_points, MPI_FLOAT, right_neighbor, <span class="number">0</span>,</span><br><span class="line">             MPI_COMM_WORLD, &amp;status);</span><br></pre></td></tr></table></figure><p><strong>ä¼˜åŠ¿</strong>ï¼š</p><ul><li>å‡å°‘å†…å­˜æ‹·è´</li><li>æ›´ä½å»¶è¿Ÿ</li><li>ä»£ç æ›´ç®€æ´</li></ul><h2 id="shu-ju-fu-wu-qi-mo-shi" tabindex="-1" id="æ•°æ®æœåŠ¡å™¨æ¨¡å¼">æ•°æ®æœåŠ¡å™¨æ¨¡å¼</h2><h3 id="wen-ti-1" tabindex="-1" id="é—®é¢˜-2">é—®é¢˜</h3><p>å¤§è§„æ¨¡é›†ç¾¤ä¸­ï¼ŒI/O å¯èƒ½æˆä¸ºç“¶é¢ˆã€‚æ¯ä¸ªè®¡ç®—èŠ‚ç‚¹éƒ½ä»å­˜å‚¨è¯»æ•°æ®ä¼šå¯¼è‡´äº‰ç”¨ã€‚</p><h3 id="jie-jue-fang-an-1" tabindex="-1" id="è§£å†³æ–¹æ¡ˆ-2">è§£å†³æ–¹æ¡ˆ</h3><p><strong>æ•°æ®æœåŠ¡å™¨æ¨¡å¼</strong>ï¼šä¸€ä¸ªè¿›ç¨‹ä¸“é—¨è´Ÿè´£ I/Oï¼Œå…¶ä»–è¿›ç¨‹ä¸“é—¨è®¡ç®—ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚  æ•°æ®æœåŠ¡å™¨ (Rank N-1)                               â”‚</span><br><span class="line">â”‚  - è¯»å–è¾“å…¥æ•°æ®                                      â”‚</span><br><span class="line">â”‚  - åˆ†å‘æ•°æ®ç»™è®¡ç®—èŠ‚ç‚¹                                â”‚</span><br><span class="line">â”‚  - æ”¶é›†è®¡ç®—ç»“æœ                                      â”‚</span><br><span class="line">â”‚  - å†™å…¥è¾“å‡º                                          â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">         â†“ åˆ†å‘           â†‘ æ”¶é›†</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ Rank 0  â”‚ Rank 1  â”‚ Rank 2  â”‚   ...   â”‚</span><br><span class="line">â”‚ è®¡ç®—    â”‚ è®¡ç®—    â”‚ è®¡ç®—    â”‚         â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure><h3 id="shi-xian" tabindex="-1" id="å®ç°">å®ç°</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">data_server</span><span class="params">(<span class="type">int</span> dimx, <span class="type">int</span> dimy, <span class="type">int</span> dimz, <span class="type">int</span> nreps)</span> &#123;</span><br><span class="line">    <span class="type">int</span> np, num_comp_nodes;</span><br><span class="line">    MPI_Comm_size(MPI_COMM_WORLD, &amp;np);</span><br><span class="line">    num_comp_nodes = np - <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ†é…å¹¶åˆå§‹åŒ–æ•°æ®</span></span><br><span class="line">    <span class="type">float</span> *input = <span class="built_in">malloc</span>(dimx * dimy * dimz * <span class="keyword">sizeof</span>(<span class="type">float</span>));</span><br><span class="line">    <span class="type">float</span> *output = <span class="built_in">malloc</span>(dimx * dimy * dimz * <span class="keyword">sizeof</span>(<span class="type">float</span>));</span><br><span class="line">    initialize_data(input, dimx, dimy, dimz);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®¡ç®—æ¯ä¸ªèŠ‚ç‚¹çš„æ•°æ®é‡</span></span><br><span class="line">    <span class="type">int</span> slice_per_node = dimz / num_comp_nodes;</span><br><span class="line">    <span class="type">int</span> halo_size = <span class="number">4</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ†å‘æ•°æ®ç»™è®¡ç®—èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> p = <span class="number">0</span>; p &lt; num_comp_nodes; p++) &#123;</span><br><span class="line">        <span class="type">int</span> start_z = p * slice_per_node - (p &gt; <span class="number">0</span> ? halo_size : <span class="number">0</span>);</span><br><span class="line">        <span class="type">int</span> num_slices = slice_per_node + (p &gt; <span class="number">0</span> ? halo_size : <span class="number">0</span>) </span><br><span class="line">                                        + (p &lt; num_comp_nodes - <span class="number">1</span> ? halo_size : <span class="number">0</span>);</span><br><span class="line">        <span class="type">int</span> num_points = dimx * dimy * num_slices;</span><br><span class="line">        </span><br><span class="line">        MPI_Send(input + start_z * dimx * dimy, num_points, MPI_FLOAT,</span><br><span class="line">                 p, <span class="number">0</span>, MPI_COMM_WORLD);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç­‰å¾…è®¡ç®—å®Œæˆ</span></span><br><span class="line">    MPI_Barrier(MPI_COMM_WORLD);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ”¶é›†ç»“æœ</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> p = <span class="number">0</span>; p &lt; num_comp_nodes; p++) &#123;</span><br><span class="line">        <span class="type">int</span> offset = p * slice_per_node * dimx * dimy;</span><br><span class="line">        <span class="type">int</span> num_points = slice_per_node * dimx * dimy;</span><br><span class="line">        </span><br><span class="line">        MPI_Recv(output + offset, num_points, MPI_FLOAT,</span><br><span class="line">                 p, DATA_COLLECT, MPI_COMM_WORLD, MPI_STATUS_IGNORE);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä¿å­˜ç»“æœ</span></span><br><span class="line">    save_output(output, dimx, dimy, dimz);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">free</span>(input);</span><br><span class="line">    <span class="built_in">free</span>(output);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="wan-zheng-shi-li-mpi-cuda-mo-ban-ji-suan" tabindex="-1" id="å®Œæ•´ç¤ºä¾‹ï¼šMPI-CUDA-æ¨¡æ¿è®¡ç®—">å®Œæ•´ç¤ºä¾‹ï¼šMPI + CUDA æ¨¡æ¿è®¡ç®—</h2><h3 id="cheng-xu-jie-gou" tabindex="-1" id="ç¨‹åºç»“æ„">ç¨‹åºç»“æ„</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="type">int</span> pid, np;</span><br><span class="line">    </span><br><span class="line">    MPI_Init(&amp;argc, &amp;argv);</span><br><span class="line">    MPI_Comm_rank(MPI_COMM_WORLD, &amp;pid);</span><br><span class="line">    MPI_Comm_size(MPI_COMM_WORLD, &amp;np);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (pid &lt; np - <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// è®¡ç®—èŠ‚ç‚¹ï¼šè®¾ç½® GPU å¹¶è®¡ç®—</span></span><br><span class="line">        <span class="type">int</span> device = pid % num_devices;</span><br><span class="line">        cudaSetDevice(device);</span><br><span class="line">        compute_node_stencil(dimx, dimy, dimz / (np - <span class="number">1</span>), nreps);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// æ•°æ®æœåŠ¡å™¨ï¼šI/O å’Œæ•°æ®åˆ†å‘</span></span><br><span class="line">        data_server(dimx, dimy, dimz, nreps);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    MPI_Finalize();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ji-suan-jie-dian-shi-xian" tabindex="-1" id="è®¡ç®—èŠ‚ç‚¹å®ç°">è®¡ç®—èŠ‚ç‚¹å®ç°</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">compute_node_stencil</span><span class="params">(<span class="type">int</span> dimx, <span class="type">int</span> dimy, <span class="type">int</span> dimz, <span class="type">int</span> nreps)</span> &#123;</span><br><span class="line">    <span class="type">int</span> pid, np;</span><br><span class="line">    MPI_Comm_rank(MPI_COMM_WORLD, &amp;pid);</span><br><span class="line">    MPI_Comm_size(MPI_COMM_WORLD, &amp;np);</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> server = np - <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> left_neighbor = (pid &gt; <span class="number">0</span>) ? (pid - <span class="number">1</span>) : MPI_PROC_NULL;</span><br><span class="line">    <span class="type">int</span> right_neighbor = (pid &lt; np - <span class="number">2</span>) ? (pid + <span class="number">1</span>) : MPI_PROC_NULL;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ†é…å†…å­˜</span></span><br><span class="line">    <span class="type">int</span> halo = <span class="number">4</span>;</span><br><span class="line">    <span class="type">int</span> total_z = dimz + <span class="number">2</span> * halo;</span><br><span class="line">    <span class="type">size_t</span> num_bytes = dimx * dimy * total_z * <span class="keyword">sizeof</span>(<span class="type">float</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="type">float</span> *h_input = <span class="built_in">malloc</span>(num_bytes);</span><br><span class="line">    <span class="type">float</span> *h_output = <span class="built_in">malloc</span>(num_bytes);</span><br><span class="line">    <span class="type">float</span> *d_input, *d_output;</span><br><span class="line">    cudaMalloc(&amp;d_input, num_bytes);</span><br><span class="line">    cudaMalloc(&amp;d_output, num_bytes);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Halo ç¼“å†²åŒºï¼ˆå›ºå®šå†…å­˜ï¼ŒåŠ é€Ÿä¼ è¾“ï¼‰</span></span><br><span class="line">    <span class="type">float</span> *h_left_boundary, *h_right_boundary;</span><br><span class="line">    <span class="type">float</span> *h_left_halo, *h_right_halo;</span><br><span class="line">    <span class="type">size_t</span> halo_bytes = dimx * dimy * halo * <span class="keyword">sizeof</span>(<span class="type">float</span>);</span><br><span class="line">    cudaHostAlloc(&amp;h_left_boundary, halo_bytes, cudaHostAllocDefault);</span><br><span class="line">    cudaHostAlloc(&amp;h_right_boundary, halo_bytes, cudaHostAllocDefault);</span><br><span class="line">    cudaHostAlloc(&amp;h_left_halo, halo_bytes, cudaHostAllocDefault);</span><br><span class="line">    cudaHostAlloc(&amp;h_right_halo, halo_bytes, cudaHostAllocDefault);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ›å»º CUDA æµ</span></span><br><span class="line">    cudaStream_t stream_boundary, stream_internal;</span><br><span class="line">    cudaStreamCreate(&amp;stream_boundary);</span><br><span class="line">    cudaStreamCreate(&amp;stream_internal);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä»æ•°æ®æœåŠ¡å™¨æ¥æ”¶åˆå§‹æ•°æ®</span></span><br><span class="line">    MPI_Status status;</span><br><span class="line">    MPI_Recv(h_input, dimx * dimy * total_z, MPI_FLOAT,</span><br><span class="line">             server, MPI_ANY_TAG, MPI_COMM_WORLD, &amp;status);</span><br><span class="line">    cudaMemcpy(d_input, h_input, num_bytes, cudaMemcpyHostToDevice);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¿­ä»£è®¡ç®—</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> iter = <span class="number">0</span>; iter &lt; nreps; iter++) &#123;</span><br><span class="line">        <span class="comment">// é˜¶æ®µ 1ï¼šè¾¹ç•Œè®¡ç®—</span></span><br><span class="line">        launch_boundary_kernel(d_output, d_input, dimx, dimy, stream_boundary);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é˜¶æ®µ 2ï¼šå†…éƒ¨è®¡ç®—ï¼ˆä¸é€šä¿¡é‡å ï¼‰</span></span><br><span class="line">        launch_internal_kernel(d_output, d_input, dimx, dimy, dimz, stream_internal);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¤åˆ¶è¾¹ç•Œåˆ°ä¸»æœº</span></span><br><span class="line">        copy_boundary_to_host(d_output, h_left_boundary, h_right_boundary,</span><br><span class="line">                               dimx, dimy, halo, stream_boundary);</span><br><span class="line">        cudaStreamSynchronize(stream_boundary);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Halo äº¤æ¢</span></span><br><span class="line">        MPI_Sendrecv(h_left_boundary, dimx * dimy * halo, MPI_FLOAT, left_neighbor, iter,</span><br><span class="line">                     h_right_halo, dimx * dimy * halo, MPI_FLOAT, right_neighbor, iter,</span><br><span class="line">                     MPI_COMM_WORLD, &amp;status);</span><br><span class="line">        MPI_Sendrecv(h_right_boundary, dimx * dimy * halo, MPI_FLOAT, right_neighbor, iter,</span><br><span class="line">                     h_left_halo, dimx * dimy * halo, MPI_FLOAT, left_neighbor, iter,</span><br><span class="line">                     MPI_COMM_WORLD, &amp;status);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¤åˆ¶ Halo å› GPU</span></span><br><span class="line">        copy_halo_to_device(d_output, h_left_halo, h_right_halo,</span><br><span class="line">                             dimx, dimy, dimz, halo, stream_boundary);</span><br><span class="line">        </span><br><span class="line">        cudaDeviceSynchronize();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// äº¤æ¢è¾“å…¥è¾“å‡ºæŒ‡é’ˆ</span></span><br><span class="line">        <span class="type">float</span> *temp = d_output;</span><br><span class="line">        d_output = d_input;</span><br><span class="line">        d_input = temp;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å‘é€ç»“æœç»™æ•°æ®æœåŠ¡å™¨</span></span><br><span class="line">    cudaMemcpy(h_output, d_input, num_bytes, cudaMemcpyDeviceToHost);</span><br><span class="line">    MPI_Send(h_output + dimx * dimy * halo, dimx * dimy * dimz, MPI_FLOAT,</span><br><span class="line">             server, DATA_COLLECT, MPI_COMM_WORLD);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ¸…ç†</span></span><br><span class="line">    <span class="built_in">free</span>(h_input);</span><br><span class="line">    <span class="built_in">free</span>(h_output);</span><br><span class="line">    cudaFreeHost(h_left_boundary);</span><br><span class="line">    cudaFreeHost(h_right_boundary);</span><br><span class="line">    cudaFreeHost(h_left_halo);</span><br><span class="line">    cudaFreeHost(h_right_halo);</span><br><span class="line">    cudaFree(d_input);</span><br><span class="line">    cudaFree(d_output);</span><br><span class="line">    cudaStreamDestroy(stream_boundary);</span><br><span class="line">    cudaStreamDestroy(stream_internal);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="xing-neng-you-hua" tabindex="-1" id="æ€§èƒ½ä¼˜åŒ–">æ€§èƒ½ä¼˜åŒ–</h2><h3 id="tong-xin-you-hua" tabindex="-1" id="é€šä¿¡ä¼˜åŒ–">é€šä¿¡ä¼˜åŒ–</h3><table><thead><tr><th>æŠ€æœ¯</th><th>æè¿°</th><th>æ•ˆæœ</th></tr></thead><tbody><tr><td>éé˜»å¡é€šä¿¡</td><td>ä½¿ç”¨ <code>MPI_Isend</code>/<code>MPI_Irecv</code></td><td>é‡å é€šä¿¡ä¸è®¡ç®—</td></tr><tr><td>é›†åˆé€šä¿¡</td><td>ä½¿ç”¨ <code>MPI_Allreduce</code> è€Œéå¾ªç¯ P2P</td><td>åˆ©ç”¨ä¼˜åŒ–çš„ç®—æ³•</td></tr><tr><td>CUDA-Aware MPI</td><td>ç›´æ¥ä¼ é€’ GPU æŒ‡é’ˆ</td><td>å‡å°‘å†…å­˜æ‹·è´</td></tr><tr><td>å›ºå®šå†…å­˜</td><td><code>cudaHostAlloc</code></td><td>åŠ é€Ÿ H2D/D2H ä¼ è¾“</td></tr></tbody></table><h3 id="fu-zai-jun-heng" tabindex="-1" id="è´Ÿè½½å‡è¡¡">è´Ÿè½½å‡è¡¡</h3><p>ç¡®ä¿æ¯ä¸ªèŠ‚ç‚¹çš„å·¥ä½œé‡å¤§è‡´ç›¸ç­‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¤„ç†ä¸èƒ½æ•´é™¤çš„æƒ…å†µ</span></span><br><span class="line"><span class="type">int</span> base_slices = dimz / num_nodes;</span><br><span class="line"><span class="type">int</span> remainder = dimz % num_nodes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> p = <span class="number">0</span>; p &lt; num_nodes; p++) &#123;</span><br><span class="line">    <span class="type">int</span> slices = base_slices + (p &lt; remainder ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// åˆ†é… slices ç»™èŠ‚ç‚¹ p</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ke-kuo-zhan-xing-fen-xi" tabindex="-1" id="å¯æ‰©å±•æ€§åˆ†æ">å¯æ‰©å±•æ€§åˆ†æ</h3><p>å¯¹äº 25 ç‚¹æ¨¡æ¿è®¡ç®—ï¼š</p><table><thead><tr><th>èŠ‚ç‚¹æ•°</th><th>é€šä¿¡é‡ï¼ˆæ¯èŠ‚ç‚¹ï¼‰</th><th>è®¡ç®—é‡ï¼ˆæ¯èŠ‚ç‚¹ï¼‰</th><th>è®¡ç®—/é€šä¿¡æ¯”</th></tr></thead><tbody><tr><td>16</td><td>2Ã—64Ã—64Ã—4 = 32K</td><td>64Ã—64Ã—128 = 512K</td><td>16:1</td></tr><tr><td>64</td><td>2Ã—64Ã—64Ã—4 = 32K</td><td>64Ã—64Ã—32 = 128K</td><td>4:1</td></tr><tr><td>256</td><td>2Ã—64Ã—64Ã—4 = 32K</td><td>64Ã—64Ã—8 = 32K</td><td>1:1</td></tr></tbody></table><p><strong>è§‚å¯Ÿ</strong>ï¼šèŠ‚ç‚¹è¶Šå¤šï¼Œé€šä¿¡å¼€é”€å æ¯”è¶Šé«˜ã€‚è¿™æ˜¯<strong>å¼ºæ‰©å±•</strong>çš„å…¸å‹ç‰¹å¾ã€‚</p><h2 id="chang-jian-wen-ti-yu-jie-jue" tabindex="-1" id="å¸¸è§é—®é¢˜ä¸è§£å†³">å¸¸è§é—®é¢˜ä¸è§£å†³</h2><h3 id="si-suo" tabindex="-1" id="æ­»é”">æ­»é”</h3><p><strong>åŸå› </strong>ï¼šæ‰€æœ‰è¿›ç¨‹éƒ½åœ¨ç­‰å¾…æ¥æ”¶ï¼Œæ²¡æœ‰è¿›ç¨‹å‘é€ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é”™è¯¯ç¤ºä¾‹â€”â€”ä¼šæ­»é”ï¼</span></span><br><span class="line"><span class="keyword">if</span> (rank == <span class="number">0</span>) &#123;</span><br><span class="line">    MPI_Recv(..., <span class="number">1</span>, ...);  <span class="comment">// ç­‰å¾… rank 1</span></span><br><span class="line">    MPI_Send(..., <span class="number">1</span>, ...);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    MPI_Recv(..., <span class="number">0</span>, ...);  <span class="comment">// ç­‰å¾… rank 0</span></span><br><span class="line">    MPI_Send(..., <span class="number">0</span>, ...);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è§£å†³</strong>ï¼šä½¿ç”¨ <code>MPI_Sendrecv</code> æˆ–éé˜»å¡é€šä¿¡ã€‚</p><h3 id="gpu-nei-cun-bu-zu" tabindex="-1" id="GPU-å†…å­˜ä¸è¶³">GPU å†…å­˜ä¸è¶³</h3><p><strong>åŸå› </strong>ï¼šæ¯ä¸ªèŠ‚ç‚¹åˆ†é…çš„æ•°æ®å¤ªå¤šã€‚</p><p><strong>è§£å†³</strong>ï¼š</p><ul><li>å¢åŠ èŠ‚ç‚¹æ•°</li><li>ä½¿ç”¨ç»Ÿä¸€å†…å­˜è‡ªåŠ¨ç®¡ç†</li><li>åˆ†æ‰¹å¤„ç†</li></ul><h3 id="xing-neng-bu-jia" tabindex="-1" id="æ€§èƒ½ä¸ä½³">æ€§èƒ½ä¸ä½³</h3><p><strong>è¯Šæ–­</strong>ï¼šä½¿ç”¨ Nsight Systems åˆ†æ MPI + CUDA ç¨‹åºã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nsys profile --trace=cuda,mpi mpirun -np 4 ./my_program</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹æ˜¯å¦æœ‰ï¼š</p><ul><li>è¿‡é•¿çš„ MPI ç­‰å¾…æ—¶é—´</li><li>æœªé‡å çš„è®¡ç®—å’Œé€šä¿¡</li><li>GPU ç©ºé—²æ—¶é—´</li></ul><h2 id="xiao-jie" tabindex="-1" id="å°ç»“">å°ç»“</h2><p>ç¬¬äºŒåç« æ‰©å±•äº†å¹¶è¡Œç¼–ç¨‹çš„è§†é‡ï¼Œä»å• GPU æ‰©å±•åˆ°å¤šèŠ‚ç‚¹é›†ç¾¤ï¼š</p><p><strong>å¼‚æ„é›†ç¾¤æ¶æ„</strong>ï¼šæ¯ä¸ªèŠ‚ç‚¹åŒ…å« CPU å’Œ GPUï¼ŒèŠ‚ç‚¹é—´é€šè¿‡ç½‘ç»œè¿æ¥ã€‚åˆ†å¸ƒå¼å†…å­˜æ¨¡å‹è¦æ±‚æ˜¾å¼é€šä¿¡ã€‚</p><p><strong>MPI åŸºç¡€</strong>ï¼šæ¶ˆæ¯ä¼ é€’ç¼–ç¨‹æ¨¡å‹ã€‚è¿›ç¨‹é€šè¿‡å‘é€/æ¥æ”¶æ¶ˆæ¯é€šä¿¡ã€‚ç‚¹å¯¹ç‚¹é€šä¿¡ï¼ˆSend/Recvï¼‰å’Œé›†åˆé€šä¿¡ï¼ˆBroadcast/Reduceï¼‰ã€‚</p><p><strong>MPI + CUDA</strong>ï¼šæ¯ä¸ª MPI è¿›ç¨‹ç®¡ç†ä¸€ä¸ªæˆ–å¤šä¸ª GPUã€‚æ•°æ®åœ¨ä¸»æœºå†…å­˜å’Œ GPU å†…å­˜ä¹‹é—´ä¼ è¾“ï¼Œåœ¨è¿›ç¨‹é—´é€šè¿‡ MPI ä¼ è¾“ã€‚</p><p><strong>Halo äº¤æ¢</strong>ï¼šæ¨¡æ¿è®¡ç®—ä¸­ï¼Œè¾¹ç•Œæ•°æ®éœ€è¦ä¸é‚»å±…è¿›ç¨‹äº¤æ¢ã€‚ä½¿ç”¨ Sendrecv é¿å…æ­»é”ã€‚</p><p><strong>è®¡ç®—ä¸é€šä¿¡é‡å </strong>ï¼šåˆ©ç”¨ CUDA æµï¼Œè¾¹ç•Œè®¡ç®—å®Œæˆåç«‹å³å¼€å§‹é€šä¿¡ï¼ŒåŒæ—¶è¿›è¡Œå†…éƒ¨è®¡ç®—ã€‚æ˜¾è‘—å‡å°‘æ€»æ‰§è¡Œæ—¶é—´ã€‚</p><p><strong>CUDA-Aware MPI</strong>ï¼šMPI åº“ç›´æ¥æ¥å— GPU æŒ‡é’ˆï¼Œåˆ©ç”¨ GPUDirect æŠ€æœ¯å‡å°‘å†…å­˜æ‹·è´ã€‚</p><p><strong>æ•°æ®æœåŠ¡å™¨æ¨¡å¼</strong>ï¼šä¸€ä¸ªè¿›ç¨‹ä¸“é—¨è´Ÿè´£ I/Oï¼Œå‡å°‘å­˜å‚¨äº‰ç”¨ã€‚</p><p>æŒæ¡ MPI + CUDA ç¼–ç¨‹ï¼Œä½ å°±èƒ½ç¼–å†™å¯æ‰©å±•åˆ°æ•°åƒ GPU çš„åº”ç”¨ç¨‹åºâ€”â€”è¿™æ˜¯å½“ä»Š AI è®­ç»ƒã€ç§‘å­¦è®¡ç®—ã€å¤©æ°”é¢„æŠ¥ç­‰é¢†åŸŸçš„æ ¸å¿ƒæŠ€æœ¯ã€‚</p><hr><p><strong>å‚è€ƒèµ„æ–™ï¼š</strong></p><ul><li>Hwu, W., Kirk, D., &amp; El Hajj, I. (2022). <em>Programming Massively Parallel Processors: A Hands-on Approach</em> (4th Edition). Morgan Kaufmann.</li><li>MPI Forum. <em>MPI: A Message-Passing Interface Standard</em>. <a href="https://www.mpi-forum.org/">https://www.mpi-forum.org/</a></li><li>NVIDIA. <em>CUDA-Aware MPI</em>. <a href="https://developer.nvidia.com/blog/introduction-cuda-aware-mpi/">https://developer.nvidia.com/blog/introduction-cuda-aware-mpi/</a></li></ul><hr><blockquote><p><strong>æœ¬æ–‡ GitHub ä»“åº“</strong>: <a href="https://github.com/psmarter/PMPP-Learning">https://github.com/psmarter/PMPP-Learning</a></p></blockquote>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;qian-yan&quot; tabindex=&quot;-1&quot; id=&quot;å‰è¨€&quot;&gt;å‰è¨€&lt;/h2&gt;
&lt;p&gt;ç¬¬åä¹ç« æ€»ç»“äº†å¹¶è¡Œç¼–ç¨‹çš„æ€ç»´æ–¹æ³•ã€‚ç¬¬äºŒåç« å°†è§†é‡æ‰©å±•åˆ°&lt;strong&gt;è®¡ç®—é›†ç¾¤&lt;/strong&gt;â€”â€”å¤šå°è®¡ç®—æœºé€šè¿‡ç½‘ç»œè¿æ¥ï¼Œæ¯å°è®¡ç®—æœºå¯èƒ½é…å¤‡å¤šä¸ª</summary>
        
      
    
    
    
    <category term="çŸ¥è¯†åˆ†äº«" scheme="https://smarter.xin/categories/knowledge-sharing/"/>
    
    
    <category term="CUDA" scheme="https://smarter.xin/tags/CUDA/"/>
    
    <category term="GPUç¼–ç¨‹" scheme="https://smarter.xin/tags/gpu-programming/"/>
    
    <category term="å¹¶è¡Œè®¡ç®—" scheme="https://smarter.xin/tags/parallel-computing/"/>
    
    <category term="PMPP" scheme="https://smarter.xin/tags/PMPP/"/>
    
    <category term="MPI" scheme="https://smarter.xin/tags/MPI/"/>
    
    <category term="é›†ç¾¤è®¡ç®—" scheme="https://smarter.xin/tags/cluster-computing/"/>
    
    <category term="CUDAæµ" scheme="https://smarter.xin/tags/cuda-stream/"/>
    
    <category term="åˆ†å¸ƒå¼è®¡ç®—" scheme="https://smarter.xin/tags/distributed-computing/"/>
    
  </entry>
  
  <entry>
    <title>PMPP-ç¬¬åä¹ç« ï¼šå¹¶è¡Œç¼–ç¨‹ä¸è®¡ç®—æ€ç»´</title>
    <link href="https://smarter.xin/posts/46b3d994/"/>
    <id>https://smarter.xin/posts/46b3d994/</id>
    <published>2026-01-24T04:29:59.000Z</published>
    <updated>2026-01-24T08:26:21.332Z</updated>
    
    <content type="html"><![CDATA[<h2 id="qian-yan" tabindex="-1" id="å‰è¨€">å‰è¨€</h2><p>ç»è¿‡å‰åå…«ç« çš„å­¦ä¹ ï¼Œæˆ‘ä»¬æŒæ¡äº† CUDA ç¼–ç¨‹çš„å„ç§æŠ€æœ¯ç»†èŠ‚ã€‚ç¬¬åä¹ç« æ˜¯å…¨ä¹¦çš„æ€»ç»“ä¸å‡åï¼Œä»&quot;æœ¯&quot;ä¸Šå‡åˆ°&quot;é“&quot;â€”â€”<strong>è®¡ç®—æ€ç»´ï¼ˆComputational Thinkingï¼‰</strong>ã€‚è¿™ä¸€ç« ä¸å†è®²å…·ä½“çš„ API æˆ–ä¼˜åŒ–æŠ€å·§ï¼Œè€Œæ˜¯è®¨è®º<strong>å¦‚ä½•æ€è€ƒå¹¶è¡Œé—®é¢˜</strong>ã€<strong>å¦‚ä½•è®¾è®¡å¹¶è¡Œç®—æ³•</strong>ã€<strong>å¦‚ä½•æƒè¡¡å„ç§å› ç´ </strong>ã€‚è¿™äº›æ€ç»´æ–¹å¼å°†å¸®åŠ©ä½ åº”å¯¹æœªæ¥é‡åˆ°çš„ä»»ä½•å¹¶è¡Œè®¡ç®—æŒ‘æˆ˜ã€‚</p><blockquote><p><strong>ğŸ“¦ é…å¥—èµ„æº</strong>ï¼šæœ¬ç³»åˆ—æ–‡ç« é…æœ‰å®Œæ•´çš„ <a href="https://github.com/psmarter/PMPP-Learning">GitHub ä»“åº“</a>ï¼ŒåŒ…å«æ¯ç« çš„ç»ƒä¹ é¢˜è§£ç­”ã€CUDA ä»£ç å®ç°å’Œè¯¦ç»†æ³¨é‡Šã€‚æ‰€æœ‰ä»£ç éƒ½ç»è¿‡æµ‹è¯•ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œã€‚</p></blockquote><h2 id="shi-yao-shi-ji-suan-si-wei" tabindex="-1" id="ä»€ä¹ˆæ˜¯è®¡ç®—æ€ç»´">ä»€ä¹ˆæ˜¯è®¡ç®—æ€ç»´</h2><h3 id="ding-yi" tabindex="-1" id="å®šä¹‰">å®šä¹‰</h3><p><strong>è®¡ç®—æ€ç»´</strong>ï¼šç”¨è®¡ç®—æœºç§‘å­¦çš„åŸºæœ¬æ¦‚å¿µæ¥è§£å†³é—®é¢˜ã€è®¾è®¡ç³»ç»Ÿã€ç†è§£äººç±»è¡Œä¸ºã€‚</p><p>â€”â€”Jeannette Wing, 2006</p><p>åœ¨å¹¶è¡Œè®¡ç®—è¯­å¢ƒä¸‹ï¼Œè®¡ç®—æ€ç»´åŒ…æ‹¬ï¼š</p><ul><li>è¯†åˆ«é—®é¢˜çš„å¹¶è¡Œæ€§</li><li>åˆ†è§£ä»»åŠ¡ä¸æ•°æ®</li><li>è®¾è®¡é«˜æ•ˆçš„é€šä¿¡æ¨¡å¼</li><li>æƒè¡¡å„ç§èµ„æºçº¦æŸ</li></ul><h3 id="wei-shi-yao-zhong-yao" tabindex="-1" id="ä¸ºä»€ä¹ˆé‡è¦">ä¸ºä»€ä¹ˆé‡è¦</h3><p>ç¡¬ä»¶åœ¨å˜ï¼Œä½†æ€ç»´æ–¹å¼æŒä¹…ã€‚</p><ul><li>CUDA å¯èƒ½è¢«å…¶ä»–æŠ€æœ¯å–ä»£</li><li>ä½†å¹¶è¡Œæ€ç»´çš„æ ¸å¿ƒåŸåˆ™ä¸å˜</li><li>æŒæ¡æ€ç»´æ–¹å¼ &gt; è®°ä½ API</li></ul><h2 id="wen-ti-fen-jie" tabindex="-1" id="é—®é¢˜åˆ†è§£">é—®é¢˜åˆ†è§£</h2><h3 id="ren-wu-bing-xing-vs-shu-ju-bing-xing" tabindex="-1" id="ä»»åŠ¡å¹¶è¡Œ-vs-æ•°æ®å¹¶è¡Œ">ä»»åŠ¡å¹¶è¡Œ vs æ•°æ®å¹¶è¡Œ</h3><p><strong>ä»»åŠ¡å¹¶è¡Œï¼ˆTask Parallelismï¼‰</strong>ï¼š</p><ul><li>ä¸åŒçš„å¤„ç†å™¨æ‰§è¡Œä¸åŒçš„ä»»åŠ¡</li><li>é€‚åˆå¼‚æ„ä»»åŠ¡</li><li>ä¾‹ï¼šæµæ°´çº¿å¤„ç†</li></ul><p><strong>æ•°æ®å¹¶è¡Œï¼ˆData Parallelismï¼‰</strong>ï¼š</p><ul><li>ç›¸åŒçš„æ“ä½œåº”ç”¨åˆ°ä¸åŒçš„æ•°æ®</li><li>é€‚åˆåŒæ„ä»»åŠ¡</li><li>ä¾‹ï¼šå‘é‡åŠ æ³•ã€çŸ©é˜µä¹˜æ³•</li></ul><p><strong>GPU åå¥½æ•°æ®å¹¶è¡Œ</strong>ï¼š</p><ul><li>SIMT æ¨¡å‹å¤©ç„¶æ”¯æŒ</li><li>æ•°åƒçº¿ç¨‹æ‰§è¡Œç›¸åŒä»£ç </li><li>åˆ†æ”¯å‘æ•£ä¼šé™ä½æ•ˆç‡</li></ul><h3 id="fen-jie-ce-lue" tabindex="-1" id="åˆ†è§£ç­–ç•¥">åˆ†è§£ç­–ç•¥</h3><p><strong>è¾“å‡ºé©±åŠ¨</strong>ï¼šæ¯ä¸ªçº¿ç¨‹è´Ÿè´£è®¡ç®—ä¸€ä¸ªè¾“å‡ºå…ƒç´ </p><ul><li>é€‚åˆè¾“å‡ºä½ç½®ç¡®å®šçš„é—®é¢˜</li><li>ä¾‹ï¼šçŸ©é˜µä¹˜æ³•ã€å›¾åƒæ»¤æ³¢</li></ul><p><strong>è¾“å…¥é©±åŠ¨</strong>ï¼šæ¯ä¸ªçº¿ç¨‹å¤„ç†ä¸€ä¸ªè¾“å…¥å…ƒç´ </p><ul><li>é€‚åˆè¾“å‡ºéœ€è¦èšåˆçš„é—®é¢˜</li><li>ä¾‹ï¼šç›´æ–¹å›¾ã€å½’çº¦</li></ul><p><strong>æ··åˆ</strong>ï¼šæ ¹æ®é—®é¢˜ç‰¹æ€§çµæ´»é€‰æ‹©</p><ul><li>ä¾‹ï¼šç¨€ç–çŸ©é˜µâ€”â€”æ¯è¡Œä¸€ä¸ªçº¿ç¨‹æˆ–æ¯ Warp ä¸€è¡Œ</li></ul><h2 id="suan-fa-she-ji-mo-shi" tabindex="-1" id="ç®—æ³•è®¾è®¡æ¨¡å¼">ç®—æ³•è®¾è®¡æ¨¡å¼</h2><h3 id="chang-jian-bing-xing-mo-shi" tabindex="-1" id="å¸¸è§å¹¶è¡Œæ¨¡å¼">å¸¸è§å¹¶è¡Œæ¨¡å¼</h3><p>ç»è¿‡å‰é¢ç« èŠ‚çš„å­¦ä¹ ï¼Œä½ å·²ç»è§è¿‡è¿™äº›ç»å…¸æ¨¡å¼ï¼š</p><table><thead><tr><th>æ¨¡å¼</th><th>æè¿°</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td>Map</td><td>ä¸€å¯¹ä¸€å˜æ¢</td><td>ReLUã€æ ‡é‡ä¹˜æ³•</td></tr><tr><td>Reduce</td><td>å¤šå¯¹ä¸€èšåˆ</td><td>æ±‚å’Œã€æœ€å¤§å€¼</td></tr><tr><td>Scan</td><td>å‰ç¼€æ“ä½œ</td><td>æµå‹ç¼©ã€åŸºæ•°æ’åº</td></tr><tr><td>Stencil</td><td>é‚»åŸŸæ¨¡å¼</td><td>å·ç§¯ã€PDE æ±‚è§£</td></tr><tr><td>Gather</td><td>é—´æ¥è¯»å–</td><td>æŸ¥è¡¨ã€ç¨€ç–è®¿é—®</td></tr><tr><td>Scatter</td><td>é—´æ¥å†™å…¥</td><td>ç›´æ–¹å›¾ã€æ’åºåˆ†æ¡¶</td></tr></tbody></table><h3 id="mo-shi-zu-he" tabindex="-1" id="æ¨¡å¼ç»„åˆ">æ¨¡å¼ç»„åˆ</h3><p>å¤æ‚ç®—æ³•é€šå¸¸æ˜¯åŸºæœ¬æ¨¡å¼çš„ç»„åˆï¼š</p><p><strong>åŸºæ•°æ’åº</strong> = Histogram + Scan + Scatter</p><p><strong>ç¨€ç–çŸ©é˜µ-å‘é‡ä¹˜</strong> = Gather + Reduce</p><p><strong>BFS</strong> = Gather + Scatter + Reduce</p><p>è¯†åˆ«è¿™äº›æ¨¡å¼æœ‰åŠ©äºå¿«é€Ÿè®¾è®¡å¹¶è¡Œç®—æ³•ã€‚</p><h2 id="xing-neng-you-hua-si-wei" tabindex="-1" id="æ€§èƒ½ä¼˜åŒ–æ€ç»´">æ€§èƒ½ä¼˜åŒ–æ€ç»´</h2><h3 id="ping-jing-fen-xi" tabindex="-1" id="ç“¶é¢ˆåˆ†æ">ç“¶é¢ˆåˆ†æ</h3><p>ä»»ä½•ç¨‹åºéƒ½æœ‰ç“¶é¢ˆï¼Œä¼˜åŒ–è¦æ‰¾å¯¹æ–¹å‘ï¼š</p><p><strong>è®¡ç®—ç“¶é¢ˆ</strong>ï¼š</p><ul><li>ç®—æœ¯æ“ä½œæ˜¯é™åˆ¶å› ç´ </li><li>ä¼˜åŒ–ï¼šå‡å°‘æ“ä½œæ•°ã€ä½¿ç”¨å¿«é€Ÿæ•°å­¦å‡½æ•°</li></ul><p><strong>å†…å­˜ç“¶é¢ˆ</strong>ï¼š</p><ul><li>æ•°æ®ä¼ è¾“æ˜¯é™åˆ¶å› ç´ </li><li>ä¼˜åŒ–ï¼šæé«˜ç¼“å­˜åˆ©ç”¨ã€å‡å°‘è®¿é—®æ¬¡æ•°</li></ul><p><strong>å»¶è¿Ÿç“¶é¢ˆ</strong>ï¼š</p><ul><li>ç­‰å¾…æ—¶é—´æ˜¯é™åˆ¶å› ç´ </li><li>ä¼˜åŒ–ï¼šå¢åŠ å¹¶è¡Œåº¦éšè—å»¶è¿Ÿ</li></ul><h3 id="roofline-mo-xing" tabindex="-1" id="Roofline-æ¨¡å‹">Roofline æ¨¡å‹</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">æ€§èƒ½ = min(å³°å€¼ç®—åŠ›, å¸¦å®½ Ã— ç®—æœ¯å¼ºåº¦)</span><br></pre></td></tr></table></figure><p><strong>ç®—æœ¯å¼ºåº¦</strong> = FLOP / Byte</p><table><thead><tr><th>ç®—æœ¯å¼ºåº¦</th><th>ç“¶é¢ˆç±»å‹</th><th>ä¼˜åŒ–æ–¹å‘</th></tr></thead><tbody><tr><td>&lt; 10</td><td>å†…å­˜å—é™</td><td>æé«˜æ•°æ®å¤ç”¨</td></tr><tr><td>&gt; 10</td><td>è®¡ç®—å—é™</td><td>ä¼˜åŒ–è®¡ç®—æ•ˆç‡</td></tr></tbody></table><h3 id="you-hua-ceng-ci" tabindex="-1" id="ä¼˜åŒ–å±‚æ¬¡">ä¼˜åŒ–å±‚æ¬¡</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ ç¬¬å››å±‚ï¼šç®—æ³•å±‚                           â”‚</span><br><span class="line">â”‚   é€‰æ‹©æ›´é«˜æ•ˆçš„ç®—æ³•                       â”‚</span><br><span class="line">â”‚   å‡å°‘æ€»æ“ä½œæ•°                           â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚ ç¬¬ä¸‰å±‚ï¼šå¹¶è¡Œç­–ç•¥å±‚                       â”‚</span><br><span class="line">â”‚   ä»»åŠ¡åˆ†è§£æ–¹å¼                           â”‚</span><br><span class="line">â”‚   è´Ÿè½½å‡è¡¡                               â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚ ç¬¬äºŒå±‚ï¼šå†…å­˜å±‚                           â”‚</span><br><span class="line">â”‚   å…¨å±€/å…±äº«/å¯„å­˜å™¨çš„ä½¿ç”¨                 â”‚</span><br><span class="line">â”‚   è®¿é—®æ¨¡å¼ä¼˜åŒ–                           â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚ ç¬¬ä¸€å±‚ï¼šæŒ‡ä»¤å±‚                           â”‚</span><br><span class="line">â”‚   å¾ªç¯å±•å¼€                               â”‚</span><br><span class="line">â”‚   æŒ‡ä»¤çº§å¹¶è¡Œ                             â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure><p><strong>ä»ä¸Šå¾€ä¸‹ä¼˜åŒ–</strong>ï¼šç®—æ³•çº§æ”¹è¿›çš„æ”¶ç›Šæœ€å¤§ã€‚</p><h2 id="quan-heng-yu-jue-ce" tabindex="-1" id="æƒè¡¡ä¸å†³ç­–">æƒè¡¡ä¸å†³ç­–</h2><h3 id="chang-jian-quan-heng" tabindex="-1" id="å¸¸è§æƒè¡¡">å¸¸è§æƒè¡¡</h3><p><strong>1. å¹¶è¡Œåº¦ vs å†—ä½™è®¡ç®—</strong></p><p>å¢åŠ å¹¶è¡Œåº¦å¯èƒ½éœ€è¦å†—ä½™è®¡ç®—ï¼š</p><ul><li>Tiling éœ€è¦ Halo åŒºåŸŸé‡å </li><li>å½’çº¦éœ€è¦é¢å¤–çš„åˆå¹¶æ“ä½œ</li></ul><p><strong>2. å†…å­˜ä½¿ç”¨ vs è®¡ç®—æ•ˆç‡</strong></p><ul><li>é¢„è®¡ç®—æŸ¥æ‰¾è¡¨ï¼šçœè®¡ç®—ï¼Œè´¹å†…å­˜</li><li>å®æ—¶è®¡ç®—ï¼šçœå†…å­˜ï¼Œè´¹è®¡ç®—</li></ul><p><strong>3. é€šç”¨æ€§ vs ä¸“ç”¨ä¼˜åŒ–</strong></p><ul><li>é€šç”¨ä»£ç æ˜“ç»´æŠ¤</li><li>ä¸“ç”¨ä¼˜åŒ–æ€§èƒ½å¥½</li><li>æ¨¡æ¿/ä»£ç ç”Ÿæˆå¯ä»¥å…¼é¡¾</li></ul><h3 id="jue-ce-kuang-jia" tabindex="-1" id="å†³ç­–æ¡†æ¶">å†³ç­–æ¡†æ¶</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">1. ç†è§£é—®é¢˜</span><br><span class="line">   - è¾“å…¥/è¾“å‡ºç‰¹æ€§</span><br><span class="line">   - è®¡ç®—å¯†åº¦</span><br><span class="line">   - æ•°æ®ä¾èµ–</span><br><span class="line"></span><br><span class="line">2. é€‰æ‹©ç®—æ³•</span><br><span class="line">   - ç†è®ºå¤æ‚åº¦</span><br><span class="line">   - å¹¶è¡Œå‹å¥½åº¦</span><br><span class="line">   - å®ç°å¤æ‚åº¦</span><br><span class="line"></span><br><span class="line">3. è®¾è®¡å¹¶è¡Œç­–ç•¥</span><br><span class="line">   - åˆ†è§£æ–¹å¼</span><br><span class="line">   - åŒæ­¥éœ€æ±‚</span><br><span class="line">   - é€šä¿¡æ¨¡å¼</span><br><span class="line"></span><br><span class="line">4. å®ç°ä¸ä¼˜åŒ–</span><br><span class="line">   - å…ˆæ­£ç¡®ï¼Œåä¼˜åŒ–</span><br><span class="line">   - Profile é©±åŠ¨</span><br><span class="line">   - è¿­ä»£æ”¹è¿›</span><br></pre></td></tr></table></figure><h2 id="ke-kuo-zhan-xing-si-wei" tabindex="-1" id="å¯æ‰©å±•æ€§æ€ç»´">å¯æ‰©å±•æ€§æ€ç»´</h2><h3 id="qiang-kuo-zhan-yu-ruo-kuo-zhan" tabindex="-1" id="å¼ºæ‰©å±•ä¸å¼±æ‰©å±•">å¼ºæ‰©å±•ä¸å¼±æ‰©å±•</h3><p><strong>å¼ºæ‰©å±•ï¼ˆStrong Scalingï¼‰</strong>ï¼š</p><ul><li>é—®é¢˜è§„æ¨¡å›ºå®š</li><li>å¢åŠ å¤„ç†å™¨ï¼Œå‡å°‘æ—¶é—´</li><li>å— Amdahl å®šå¾‹é™åˆ¶</li></ul><p><strong>å¼±æ‰©å±•ï¼ˆWeak Scalingï¼‰</strong>ï¼š</p><ul><li>æ¯å¤„ç†å™¨è´Ÿè½½å›ºå®š</li><li>å¢åŠ å¤„ç†å™¨ï¼Œå¤„ç†æ›´å¤§é—®é¢˜</li><li>å— Gustafson å®šå¾‹æŒ‡å¯¼</li></ul><h3 id="amdahl-ding-lu" tabindex="-1" id="Amdahl-å®šå¾‹">Amdahl å®šå¾‹</h3><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>åŠ é€Ÿæ¯”</mtext><mo>=</mo><mfrac><mn>1</mn><mrow><mo stretchy="false">(</mo><mn>1</mn><mo>âˆ’</mo><mi>P</mi><mo stretchy="false">)</mo><mo>+</mo><mfrac><mi>P</mi><mi>N</mi></mfrac></mrow></mfrac></mrow><annotation encoding="application/x-tex">åŠ é€Ÿæ¯” = \frac{1}{(1-P) + \frac{P}{N}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback">åŠ é€Ÿæ¯”</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4288em;vertical-align:-1.1073em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.2377em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8723em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">P</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.1073em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><p>å…¶ä¸­ P æ˜¯å¯å¹¶è¡Œéƒ¨åˆ†æ¯”ä¾‹ï¼ŒN æ˜¯å¤„ç†å™¨æ•°ã€‚</p><p><strong>å¯ç¤º</strong>ï¼šä¸²è¡Œéƒ¨åˆ†å†³å®šåŠ é€Ÿä¸Šé™ã€‚</p><p><strong>ä¾‹</strong>ï¼š95% å¯å¹¶è¡Œï¼Œæœ€å¤§åŠ é€Ÿæ¯” = 20Ã—ï¼ˆæ— è®ºå¤šå°‘ GPUï¼‰</p><h3 id="gustafson-ding-lu" tabindex="-1" id="Gustafson-å®šå¾‹">Gustafson å®šå¾‹</h3><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>åŠ é€Ÿæ¯”</mtext><mo>=</mo><mi>N</mi><mo>âˆ’</mo><mo stretchy="false">(</mo><mn>1</mn><mo>âˆ’</mo><mi>P</mi><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mi>N</mi><mo>âˆ’</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">åŠ é€Ÿæ¯” = N - (1-P)(N-1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback">åŠ é€Ÿæ¯”</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mclose">)</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span></span></p><p><strong>å¯ç¤º</strong>ï¼šå¢å¤§é—®é¢˜è§„æ¨¡å¯ä»¥æé«˜å¹¶è¡Œæ•ˆç‡ã€‚</p><p><strong>ä¾‹</strong>ï¼š95% å¯å¹¶è¡Œï¼Œ100 GPUï¼ŒåŠ é€Ÿæ¯” = 95Ã—</p><h2 id="diao-shi-yu-yan-zheng" tabindex="-1" id="è°ƒè¯•ä¸éªŒè¯">è°ƒè¯•ä¸éªŒè¯</h2><h3 id="bing-xing-cheng-xu-diao-shi-tiao-zhan" tabindex="-1" id="å¹¶è¡Œç¨‹åºè°ƒè¯•æŒ‘æˆ˜">å¹¶è¡Œç¨‹åºè°ƒè¯•æŒ‘æˆ˜</h3><ul><li><strong>ä¸ç¡®å®šæ€§</strong>ï¼šç«æ€æ¡ä»¶å¯¼è‡´ç»“æœä¸å¯é‡å¤</li><li><strong>è§„æ¨¡</strong>ï¼šæ•°åƒçº¿ç¨‹éš¾ä»¥é€ä¸€è¿½è¸ª</li><li><strong>éšè”½æ€§</strong>ï¼šè¾¹ç•Œæƒ…å†µéš¾ä»¥è§¦å‘</li></ul><h3 id="ce-lue" tabindex="-1" id="ç­–ç•¥">ç­–ç•¥</h3><p><strong>1. ç®€åŒ–é—®é¢˜</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">å…ˆåœ¨å°è§„æ¨¡æ•°æ®ä¸Šæµ‹è¯•</span><br><span class="line">1 ä¸ª Block â†’ å¤š Block</span><br><span class="line">1 ä¸ª Warp â†’ å¤š Warp</span><br></pre></td></tr></table></figure><p><strong>2. ä¸²è¡Œå‚è€ƒ</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ€»æ˜¯ä¿ç•™ä¸²è¡Œç‰ˆæœ¬ç”¨äºéªŒè¯</span></span><br><span class="line"><span class="type">float</span> result_cpu = compute_cpu(data, n);</span><br><span class="line"><span class="type">float</span> result_gpu = compute_gpu(data, n);</span><br><span class="line">assert(<span class="built_in">abs</span>(result_cpu - result_gpu) &lt; epsilon);</span><br></pre></td></tr></table></figure><p><strong>3. ä½¿ç”¨å·¥å…·</strong></p><table><thead><tr><th>å·¥å…·</th><th>ç”¨é€”</th></tr></thead><tbody><tr><td>cuda-memcheck</td><td>å†…å­˜é”™è¯¯æ£€æµ‹</td></tr><tr><td>Nsight Compute</td><td>æ€§èƒ½åˆ†æ</td></tr><tr><td>Nsight Systems</td><td>ç³»ç»Ÿçº§åˆ†æ</td></tr><tr><td>printf</td><td>ç®€å•è°ƒè¯•ï¼ˆæ…ç”¨ï¼‰</td></tr></tbody></table><p><strong>4. æ¸è¿›å¼å¼€å‘</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. å®ç°æœ´ç´ ç‰ˆæœ¬ï¼ŒéªŒè¯æ­£ç¡®æ€§</span><br><span class="line">2. æ·»åŠ ä¸€ä¸ªä¼˜åŒ–ï¼ŒéªŒè¯æ­£ç¡®æ€§</span><br><span class="line">3. é‡å¤ç›´åˆ°æ»¡è¶³æ€§èƒ½éœ€æ±‚</span><br></pre></td></tr></table></figure><h2 id="kua-ping-tai-si-wei" tabindex="-1" id="è·¨å¹³å°æ€ç»´">è·¨å¹³å°æ€ç»´</h2><h3 id="ying-jian-duo-yang-xing" tabindex="-1" id="ç¡¬ä»¶å¤šæ ·æ€§">ç¡¬ä»¶å¤šæ ·æ€§</h3><p>ä¸åŒ GPU æ¶æ„æœ‰ä¸åŒç‰¹æ€§ï¼š</p><table><thead><tr><th>ç‰¹æ€§</th><th>Kepler</th><th>Pascal</th><th>Volta</th><th>Ampere</th></tr></thead><tbody><tr><td>SM å†…å­˜(KB)</td><td>64</td><td>64</td><td>96</td><td>164</td></tr><tr><td>L2 ç¼“å­˜(MB)</td><td>1.5</td><td>4</td><td>6</td><td>40</td></tr><tr><td>Tensor Core</td><td>æ— </td><td>æ— </td><td>æœ‰</td><td>æœ‰</td></tr></tbody></table><p><strong>ç­–ç•¥</strong>ï¼š</p><ul><li>ä½¿ç”¨è¿è¡Œæ—¶æŸ¥è¯¢èƒ½åŠ›</li><li>å‚æ•°åŒ–å…³é”®å¸¸é‡</li><li>é’ˆå¯¹ç›®æ ‡ç¡¬ä»¶è°ƒä¼˜</li></ul><h3 id="ke-yi-zhi-xing" tabindex="-1" id="å¯ç§»æ¤æ€§">å¯ç§»æ¤æ€§</h3><p><strong>CUDA ä¹‹å¤–</strong>ï¼š</p><ul><li>OpenCLï¼šè·¨å‚å•†</li><li>SYCLï¼šC++ æ ‡å‡†åŒ–</li><li>HIPï¼šAMD GPU</li></ul><p><strong>æŠ½è±¡åº“</strong>ï¼š</p><ul><li>Thrustï¼šSTL é£æ ¼</li><li>CUBï¼šä½çº§åŸè¯­</li><li>cuBLAS/cuDNNï¼šé¢†åŸŸç‰¹å®š</li></ul><h2 id="chi-xu-xue-xi" tabindex="-1" id="æŒç»­å­¦ä¹ ">æŒç»­å­¦ä¹ </h2><h3 id="ji-zhu-yan-jin" tabindex="-1" id="æŠ€æœ¯æ¼”è¿›">æŠ€æœ¯æ¼”è¿›</h3><p>GPU æŠ€æœ¯å¿«é€Ÿå‘å±•ï¼š</p><p><strong>è¿‡å»</strong>ï¼šå¯ç¼–ç¨‹ç€è‰²å™¨ â†’ CUDA è¯ç”Ÿ<br><strong>ç°åœ¨</strong>ï¼šTensor Coreã€å…‰çº¿è¿½è¸ª<br><strong>æœªæ¥</strong>ï¼šé‡å­æ¨¡æ‹Ÿï¼Ÿç¥ç»å½¢æ€è®¡ç®—ï¼Ÿ</p><p><strong>ä¿æŒå­¦ä¹ </strong>ï¼š</p><ul><li>é˜…è¯»æœ€æ–°è®ºæ–‡</li><li>å…³æ³¨ GTC å¤§ä¼š</li><li>å‚ä¸å¼€æºé¡¹ç›®</li></ul><h3 id="she-qu-zi-yuan" tabindex="-1" id="ç¤¾åŒºèµ„æº">ç¤¾åŒºèµ„æº</h3><ul><li><strong>NVIDIA Developer Blog</strong>ï¼šæŠ€æœ¯æ–‡ç« </li><li><strong>CUDA Zone</strong>ï¼šå®˜æ–¹èµ„æº</li><li><strong>GitHub</strong>ï¼šå¼€æºé¡¹ç›®</li><li><strong>Stack Overflow</strong>ï¼šé—®é¢˜è§£ç­”</li><li><strong>è¯¾ç¨‹</strong>ï¼šUIUCã€Stanford å…¬å¼€è¯¾</li></ul><h2 id="zong-jie-bing-xing-bian-cheng-xin-fa" tabindex="-1" id="æ€»ç»“ï¼šå¹¶è¡Œç¼–ç¨‹å¿ƒæ³•">æ€»ç»“ï¼šå¹¶è¡Œç¼–ç¨‹å¿ƒæ³•</h2><h3 id="shi-tiao-yuan-ze" tabindex="-1" id="åæ¡åŸåˆ™">åæ¡åŸåˆ™</h3><ol><li><p><strong>ç†è§£ç¡¬ä»¶</strong>ï¼šäº†è§£ä½ çš„ GPU æ¶æ„ï¼Œæ‰¬é•¿é¿çŸ­</p></li><li><p><strong>æ•°æ®ä¸ºç‹</strong>ï¼šå¹¶è¡Œç¨‹åºæ€§èƒ½é€šå¸¸å—é™äºæ•°æ®ç§»åŠ¨</p></li><li><p><strong>æœ€å¤§åŒ–å¹¶è¡Œ</strong>ï¼šæš´éœ²è¶³å¤Ÿçš„å¹¶è¡Œæ€§éšè—å»¶è¿Ÿ</p></li><li><p><strong>æœ€å°åŒ–åŒæ­¥</strong>ï¼šåŒæ­¥æ˜¯æ€§èƒ½æ€æ‰‹</p></li><li><p><strong>åˆå¹¶è®¿é—®</strong>ï¼šè®©å†…å­˜è®¿é—®è¿ç»­</p></li><li><p><strong>å¤ç”¨æ•°æ®</strong>ï¼šå…±äº«å†…å­˜æ˜¯ä½ æœ€å¥½çš„æœ‹å‹</p></li><li><p><strong>é¿å…å‘æ•£</strong>ï¼šè®©åŒä¸€ Warp çš„çº¿ç¨‹èµ°ç›¸åŒè·¯å¾„</p></li><li><p><strong>æƒè¡¡å–èˆ</strong>ï¼šæ²¡æœ‰é“¶å¼¹ï¼Œåªæœ‰é€‚åˆå…·ä½“é—®é¢˜çš„è§£</p></li><li><p><strong>Profile ä¼˜å…ˆ</strong>ï¼šæ•°æ®é©±åŠ¨ä¼˜åŒ–ï¼Œä¸è¦çŒœæµ‹</p></li><li><p><strong>æ¸è¿›è¿­ä»£</strong>ï¼šå…ˆæ­£ç¡®ï¼Œåä¼˜åŒ–ï¼ŒæŒç»­æ”¹è¿›</p></li></ol><h3 id="cong-ji-zhu-dao-si-wei" tabindex="-1" id="ä»æŠ€æœ¯åˆ°æ€ç»´">ä»æŠ€æœ¯åˆ°æ€ç»´</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">åˆå­¦è€…ï¼šå­¦ä¹  API å’Œè¯­æ³•</span><br><span class="line">         â†“</span><br><span class="line">è¿›é˜¶è€…ï¼šæŒæ¡ä¼˜åŒ–æŠ€å·§</span><br><span class="line">         â†“</span><br><span class="line">é«˜æ‰‹ï¼šå½¢æˆå¹¶è¡Œæ€ç»´</span><br><span class="line">         â†“</span><br><span class="line">ä¸“å®¶ï¼šèƒ½è®¾è®¡æ–°ç®—æ³•</span><br></pre></td></tr></table></figure><p>è¿™æœ¬ä¹¦å¸¦ä½ èµ°å®Œäº†å‰ä¸¤ä¸ªé˜¶æ®µï¼Œåä¸¤ä¸ªé˜¶æ®µéœ€è¦é€šè¿‡å®è·µå’ŒæŒç»­å­¦ä¹ æ¥è¾¾æˆã€‚</p><h2 id="xiao-jie" tabindex="-1" id="å°ç»“">å°ç»“</h2><p>ç¬¬åä¹ç« æ˜¯å…¨ä¹¦çš„å‡åï¼Œæ€»ç»“äº†å¹¶è¡Œç¼–ç¨‹çš„æ ¸å¿ƒæ€ç»´ï¼š</p><p><strong>è®¡ç®—æ€ç»´</strong>ï¼šç”¨è®¡ç®—çš„è§†è§’çœ‹é—®é¢˜â€”â€”åˆ†è§£ã€æ¨¡å¼åŒ¹é…ã€æŠ½è±¡ã€ç®—æ³•è®¾è®¡ã€‚</p><p><strong>é—®é¢˜åˆ†è§£</strong>ï¼šä»»åŠ¡å¹¶è¡Œ vs æ•°æ®å¹¶è¡Œï¼Œè¾“å‡ºé©±åŠ¨ vs è¾“å…¥é©±åŠ¨ã€‚æ ¹æ®é—®é¢˜ç‰¹æ€§é€‰æ‹©ã€‚</p><p><strong>è®¾è®¡æ¨¡å¼</strong>ï¼šMapã€Reduceã€Scanã€Stencilã€Gatherã€Scatterâ€”â€”è¯†åˆ«è¿™äº›æ¨¡å¼èƒ½å¿«é€Ÿæ„å»ºè§£å†³æ–¹æ¡ˆã€‚</p><p><strong>æ€§èƒ½æ€ç»´</strong>ï¼šç“¶é¢ˆåˆ†æã€Roofline æ¨¡å‹ã€åˆ†å±‚ä¼˜åŒ–ã€‚ä»ç®—æ³•å±‚å¼€å§‹ï¼Œé€å±‚å‘ä¸‹ã€‚</p><p><strong>æƒè¡¡å†³ç­–</strong>ï¼šæ²¡æœ‰å®Œç¾æ–¹æ¡ˆï¼Œåªæœ‰æœ€é€‚åˆå½“å‰çº¦æŸçš„æ–¹æ¡ˆã€‚ç†è§£å„ç§æƒè¡¡æ‰èƒ½åšå‡ºå¥½å†³ç­–ã€‚</p><p><strong>å¯æ‰©å±•æ€§</strong>ï¼šAmdahl vs Gustafsonï¼Œå¼ºæ‰©å±• vs å¼±æ‰©å±•ã€‚ç†è§£æé™æœ‰åŠ©äºè®¾å®šåˆç†é¢„æœŸã€‚</p><p>CUDA åªæ˜¯å·¥å…·ï¼Œæ€ç»´æ–¹å¼æ‰æ˜¯æ ¸å¿ƒç«äº‰åŠ›ã€‚å¸Œæœ›è¿™æœ¬ä¹¦ä¸ä»…æ•™ä¼šä½  CUDA ç¼–ç¨‹ï¼Œæ›´åŸ¹å…»äº†ä½ çš„å¹¶è¡Œè®¡ç®—æ€ç»´ã€‚</p><hr><p><strong>å‚è€ƒèµ„æ–™ï¼š</strong></p><ul><li>Hwu, W., Kirk, D., &amp; El Hajj, I. (2022). <em>Programming Massively Parallel Processors: A Hands-on Approach</em> (4th Edition). Morgan Kaufmann.</li><li>Wing, J. M. (2006). <em>Computational Thinking</em>. Communications of the ACM.</li><li>Williams, S., et al. (2009). <em>Roofline: An Insightful Visual Performance Model</em>. Communications of the ACM.</li></ul><hr><blockquote><p><strong>æœ¬æ–‡ GitHub ä»“åº“</strong>: <a href="https://github.com/psmarter/PMPP-Learning">https://github.com/psmarter/PMPP-Learning</a></p></blockquote>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;qian-yan&quot; tabindex=&quot;-1&quot; id=&quot;å‰è¨€&quot;&gt;å‰è¨€&lt;/h2&gt;
&lt;p&gt;ç»è¿‡å‰åå…«ç« çš„å­¦ä¹ ï¼Œæˆ‘ä»¬æŒæ¡äº† CUDA</summary>
        
      
    
    
    
    <category term="çŸ¥è¯†åˆ†äº«" scheme="https://smarter.xin/categories/knowledge-sharing/"/>
    
    
    <category term="CUDA" scheme="https://smarter.xin/tags/CUDA/"/>
    
    <category term="GPUç¼–ç¨‹" scheme="https://smarter.xin/tags/gpu-programming/"/>
    
    <category term="å¹¶è¡Œè®¡ç®—" scheme="https://smarter.xin/tags/parallel-computing/"/>
    
    <category term="PMPP" scheme="https://smarter.xin/tags/PMPP/"/>
    
    <category term="æ€§èƒ½ä¼˜åŒ–" scheme="https://smarter.xin/tags/performance-optimization/"/>
    
    <category term="è®¡ç®—æ€ç»´" scheme="https://smarter.xin/tags/computational-thinking/"/>
    
    <category term="æ–¹æ³•è®º" scheme="https://smarter.xin/tags/methodology/"/>
    
  </entry>
  
  <entry>
    <title>PMPP-ç¬¬åå…«ç« ï¼šé™ç”µåŠ¿èƒ½å›¾</title>
    <link href="https://smarter.xin/posts/d7c6e6a8/"/>
    <id>https://smarter.xin/posts/d7c6e6a8/</id>
    <published>2026-01-23T02:05:17.000Z</published>
    <updated>2026-01-24T08:26:21.333Z</updated>
    
    <content type="html"><![CDATA[<h2 id="qian-yan" tabindex="-1" id="å‰è¨€">å‰è¨€</h2><p>ç¬¬åä¸ƒç« æˆ‘ä»¬æ¢ç´¢äº† MRI é‡å»ºè¿™ä¸€åŒ»å­¦å½±åƒåº”ç”¨ã€‚ç¬¬åå…«ç« è½¬å‘å¦ä¸€ä¸ªé‡è¦çš„ç§‘å­¦è®¡ç®—é¢†åŸŸâ€”â€”<strong>åˆ†å­åŠ¨åŠ›å­¦</strong>ä¸­çš„é™ç”µåŠ¿èƒ½è®¡ç®—ã€‚é™ç”µç›¸äº’ä½œç”¨æ˜¯åˆ†å­æ¨¡æ‹Ÿçš„æ ¸å¿ƒï¼Œç†è§£åˆ†å­å¦‚ä½•é€šè¿‡ç”µè·ç›¸äº’ä½œç”¨æœ‰åŠ©äºè¯ç‰©è®¾è®¡ã€è›‹ç™½è´¨æŠ˜å ç ”ç©¶ç­‰ã€‚æœ¬ç« å°†å±•ç¤ºå¦‚ä½•åˆ©ç”¨ GPU çš„å¹¶è¡Œèƒ½åŠ›é«˜æ•ˆè®¡ç®—<strong>é™ç”µåŠ¿èƒ½å›¾ï¼ˆElectrostatic Potential Mapï¼‰</strong>ã€‚</p><blockquote><p><strong>ğŸ“¦ é…å¥—èµ„æº</strong>ï¼šæœ¬ç³»åˆ—æ–‡ç« é…æœ‰å®Œæ•´çš„ <a href="https://github.com/psmarter/PMPP-Learning">GitHub ä»“åº“</a>ï¼ŒåŒ…å«æ¯ç« çš„ç»ƒä¹ é¢˜è§£ç­”ã€CUDA ä»£ç å®ç°å’Œè¯¦ç»†æ³¨é‡Šã€‚æ‰€æœ‰ä»£ç éƒ½ç»è¿‡æµ‹è¯•ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œã€‚</p></blockquote><h2 id="jing-dian-shi-neng-ji-chu" tabindex="-1" id="é™ç”µåŠ¿èƒ½åŸºç¡€">é™ç”µåŠ¿èƒ½åŸºç¡€</h2><h3 id="ku-lun-ding-lu" tabindex="-1" id="åº“ä»‘å®šå¾‹">åº“ä»‘å®šå¾‹</h3><p>ä¸¤ä¸ªç‚¹ç”µè·ä¹‹é—´çš„é™ç”µåŠ¿èƒ½ï¼š</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>V</mi><mo>=</mo><mfrac><mrow><mi>k</mi><mo>â‹…</mo><mi>q</mi></mrow><mi>r</mi></mfrac></mrow><annotation encoding="application/x-tex">V = \frac{k \cdot q}{r}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0574em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><p>å…¶ä¸­ï¼š</p><ul><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span>ï¼šåº“ä»‘å¸¸æ•°</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi></mrow><annotation encoding="application/x-tex">q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span></span></span></span>ï¼šç”µè·é‡</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span>ï¼šè·ç¦»</li></ul><h3 id="fen-zi-zhong-de-jing-dian-shi-neng" tabindex="-1" id="åˆ†å­ä¸­çš„é™ç”µåŠ¿èƒ½">åˆ†å­ä¸­çš„é™ç”µåŠ¿èƒ½</h3><p>ä¸€ä¸ªåˆ†å­ç”±å¤šä¸ªåŸå­ç»„æˆï¼Œæ¯ä¸ªåŸå­æºå¸¦éƒ¨åˆ†ç”µè·ã€‚ç©ºé—´ä¸­ä»»æ„ä¸€ç‚¹çš„é™ç”µåŠ¿æ˜¯æ‰€æœ‰åŸå­è´¡çŒ®çš„æ€»å’Œï¼š</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>V</mi><mo stretchy="false">(</mo><mi mathvariant="bold">p</mi><mo stretchy="false">)</mo><mo>=</mo><munderover><mo>âˆ‘</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></munderover><mfrac><mrow><mi>k</mi><mo>â‹…</mo><msub><mi>q</mi><mi>i</mi></msub></mrow><mrow><mi mathvariant="normal">âˆ£</mi><mi mathvariant="bold">p</mi><mo>âˆ’</mo><msub><mi mathvariant="bold">r</mi><mi>i</mi></msub><mi mathvariant="normal">âˆ£</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">V(\mathbf{p}) = \sum_{i=1}^{N} \frac{k \cdot q_i}{|\mathbf{p} - \mathbf{r}_i|}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mopen">(</span><span class="mord mathbf">p</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.106em;vertical-align:-1.2777em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">âˆ£</span><span class="mord mathbf">p</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathbf">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">âˆ£</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><p>å…¶ä¸­ï¼š</p><ul><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">p</mi></mrow><annotation encoding="application/x-tex">\mathbf{p}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.1944em;"></span><span class="mord mathbf">p</span></span></span></span>ï¼šç©ºé—´ä¸­çš„ç½‘æ ¼ç‚¹</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">r</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\mathbf{r}_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5944em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathbf">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>ï¼šç¬¬ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> ä¸ªåŸå­çš„ä½ç½®</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>q</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">q_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>ï¼šç¬¬ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> ä¸ªåŸå­çš„éƒ¨åˆ†ç”µè·</li></ul><h3 id="jing-dian-shi-neng-tu" tabindex="-1" id="é™ç”µåŠ¿èƒ½å›¾">é™ç”µåŠ¿èƒ½å›¾</h3><p><strong>é™ç”µåŠ¿èƒ½å›¾</strong>ï¼šåœ¨åˆ†å­å‘¨å›´çš„ 3D ç½‘æ ¼ä¸Šï¼Œè®¡ç®—æ¯ä¸ªç½‘æ ¼ç‚¹çš„é™ç”µåŠ¿èƒ½å€¼ã€‚</p><p>å…¸å‹è§„æ¨¡ï¼š</p><ul><li>ç½‘æ ¼ï¼š256Â³ = 1670 ä¸‡ä¸ªç‚¹</li><li>åŸå­ï¼šæ•°åƒåˆ°æ•°ä¸‡ä¸ª</li></ul><p><strong>è®¡ç®—é‡</strong>ï¼šç½‘æ ¼ç‚¹æ•° Ã— åŸå­æ•° = æ•°åƒäº¿æ¬¡è¿ç®—</p><h2 id="zhi-jie-qiu-he-fa" tabindex="-1" id="ç›´æ¥æ±‚å’Œæ³•">ç›´æ¥æ±‚å’Œæ³•</h2><h3 id="ji-ben-suan-fa" tabindex="-1" id="åŸºæœ¬ç®—æ³•">åŸºæœ¬ç®—æ³•</h3><p>æœ€ç›´æ¥çš„æ–¹æ³•â€”â€”å¯¹æ¯ä¸ªç½‘æ ¼ç‚¹ï¼Œéå†æ‰€æœ‰åŸå­æ±‚å’Œï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">compute_potential_cpu</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="type">float</span> *potential,     <span class="comment">// è¾“å‡ºï¼š[Gx, Gy, Gz]</span></span></span><br><span class="line"><span class="params">    <span class="type">float</span> *atoms,         <span class="comment">// åŸå­åæ ‡ï¼š[N, 3]</span></span></span><br><span class="line"><span class="params">    <span class="type">float</span> *charges,       <span class="comment">// åŸå­ç”µè·ï¼š[N]</span></span></span><br><span class="line"><span class="params">    <span class="type">int</span> N,                <span class="comment">// åŸå­æ•°</span></span></span><br><span class="line"><span class="params">    <span class="type">int</span> Gx, <span class="type">int</span> Gy, <span class="type">int</span> Gz,  <span class="comment">// ç½‘æ ¼å°ºå¯¸</span></span></span><br><span class="line"><span class="params">    <span class="type">float</span> grid_spacing)</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> gx = <span class="number">0</span>; gx &lt; Gx; gx++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> gy = <span class="number">0</span>; gy &lt; Gy; gy++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> gz = <span class="number">0</span>; gz &lt; Gz; gz++) &#123;</span><br><span class="line">                <span class="type">float</span> px = gx * grid_spacing;</span><br><span class="line">                <span class="type">float</span> py = gy * grid_spacing;</span><br><span class="line">                <span class="type">float</span> pz = gz * grid_spacing;</span><br><span class="line">                </span><br><span class="line">                <span class="type">float</span> sum = <span class="number">0.0f</span>;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">                    <span class="type">float</span> dx = px - atoms[i * <span class="number">3</span> + <span class="number">0</span>];</span><br><span class="line">                    <span class="type">float</span> dy = py - atoms[i * <span class="number">3</span> + <span class="number">1</span>];</span><br><span class="line">                    <span class="type">float</span> dz = pz - atoms[i * <span class="number">3</span> + <span class="number">2</span>];</span><br><span class="line">                    <span class="type">float</span> r = sqrtf(dx*dx + dy*dy + dz*dz);</span><br><span class="line">                    <span class="keyword">if</span> (r &gt; <span class="number">0.001f</span>) &#123;  <span class="comment">// é¿å…é™¤ä»¥é›¶</span></span><br><span class="line">                        sum += charges[i] / r;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                potential[gx * Gy * Gz + gy * Gz + gz] = sum;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å¤æ‚åº¦</strong>ï¼šO(GÂ³ Ã— N)ï¼Œå¯¹äº 256Â³ ç½‘æ ¼å’Œ 10000 ä¸ªåŸå­ â‰ˆ 10Â¹Â¹ æ¬¡æ“ä½œã€‚</p><h3 id="gpu-po-su-shi-xian" tabindex="-1" id="GPU-æœ´ç´ å®ç°">GPU æœ´ç´ å®ç°</h3><p>æ¯ä¸ªçº¿ç¨‹è®¡ç®—ä¸€ä¸ªç½‘æ ¼ç‚¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">__global__ void compute_potential_naive(</span><br><span class="line">    float *potential,</span><br><span class="line">    float *atoms,     // [N, 3]</span><br><span class="line">    float *charges,   // [N]</span><br><span class="line">    int N,</span><br><span class="line">    int Gx, int Gy, int Gz,</span><br><span class="line">    float grid_spacing) &#123;</span><br><span class="line">    </span><br><span class="line">    int gx = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">    int gy = blockIdx.y * blockDim.y + threadIdx.y;</span><br><span class="line">    int gz = blockIdx.z * blockDim.z + threadIdx.z;</span><br><span class="line">    </span><br><span class="line">    if (gx &gt;= Gx || gy &gt;= Gy || gz &gt;= Gz) return;</span><br><span class="line">    </span><br><span class="line">    float px = gx * grid_spacing;</span><br><span class="line">    float py = gy * grid_spacing;</span><br><span class="line">    float pz = gz * grid_spacing;</span><br><span class="line">    </span><br><span class="line">    float sum = 0.0f;</span><br><span class="line">    for (int i = 0; i &lt; N; i++) &#123;</span><br><span class="line">        float dx = px - atoms[i * 3 + 0];</span><br><span class="line">        float dy = py - atoms[i * 3 + 1];</span><br><span class="line">        float dz = pz - atoms[i * 3 + 2];</span><br><span class="line">        float r = sqrtf(dx*dx + dy*dy + dz*dz);</span><br><span class="line">        if (r &gt; 0.001f) &#123;</span><br><span class="line">            sum += charges[i] / r;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    potential[gx * Gy * Gz + gy * Gz + gz] = sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>é—®é¢˜</strong>ï¼šæ¯ä¸ªçº¿ç¨‹éƒ½è¦è¯»å–æ‰€æœ‰åŸå­æ•°æ®â€”â€”å¤§é‡é‡å¤çš„å…¨å±€å†…å­˜è®¿é—®ã€‚</p><h2 id="gong-xiang-nei-cun-you-hua" tabindex="-1" id="å…±äº«å†…å­˜ä¼˜åŒ–">å…±äº«å†…å­˜ä¼˜åŒ–</h2><h3 id="yuan-zi-shu-ju-fen-kuai" tabindex="-1" id="åŸå­æ•°æ®åˆ†å—">åŸå­æ•°æ®åˆ†å—</h3><p>æŠŠåŸå­æ•°æ®åˆ†æˆå°å—ï¼Œæ¯å—åŠ è½½åˆ°å…±äº«å†…å­˜ï¼Œå¤ç”¨äº Block å†…æ‰€æœ‰çº¿ç¨‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">#define TILE_SIZE 128</span><br><span class="line"></span><br><span class="line">__global__ void compute_potential_tiled(</span><br><span class="line">    float *potential,</span><br><span class="line">    float *atoms,</span><br><span class="line">    float *charges,</span><br><span class="line">    int N,</span><br><span class="line">    int Gx, int Gy, int Gz,</span><br><span class="line">    float grid_spacing) &#123;</span><br><span class="line">    </span><br><span class="line">    __shared__ float s_atoms[TILE_SIZE * 3];</span><br><span class="line">    __shared__ float s_charges[TILE_SIZE];</span><br><span class="line">    </span><br><span class="line">    int gx = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">    int gy = blockIdx.y * blockDim.y + threadIdx.y;</span><br><span class="line">    int gz = blockIdx.z * blockDim.z + threadIdx.z;</span><br><span class="line">    </span><br><span class="line">    float px = gx * grid_spacing;</span><br><span class="line">    float py = gy * grid_spacing;</span><br><span class="line">    float pz = gz * grid_spacing;</span><br><span class="line">    </span><br><span class="line">    float sum = 0.0f;</span><br><span class="line">    </span><br><span class="line">    // åˆ†å—å¤„ç†åŸå­</span><br><span class="line">    for (int tile = 0; tile &lt; N; tile += TILE_SIZE) &#123;</span><br><span class="line">        // åä½œåŠ è½½åŸå­æ•°æ®åˆ°å…±äº«å†…å­˜</span><br><span class="line">        int tid = threadIdx.x + threadIdx.y * blockDim.x + threadIdx.z * blockDim.x * blockDim.y;</span><br><span class="line">        int num_threads = blockDim.x * blockDim.y * blockDim.z;</span><br><span class="line">        </span><br><span class="line">        for (int i = tid; i &lt; TILE_SIZE &amp;&amp; (tile + i) &lt; N; i += num_threads) &#123;</span><br><span class="line">            int atom_idx = tile + i;</span><br><span class="line">            s_atoms[i * 3 + 0] = atoms[atom_idx * 3 + 0];</span><br><span class="line">            s_atoms[i * 3 + 1] = atoms[atom_idx * 3 + 1];</span><br><span class="line">            s_atoms[i * 3 + 2] = atoms[atom_idx * 3 + 2];</span><br><span class="line">            s_charges[i] = charges[atom_idx];</span><br><span class="line">        &#125;</span><br><span class="line">        __syncthreads();</span><br><span class="line">        </span><br><span class="line">        // è®¡ç®—è¿™ä¸€å—åŸå­çš„è´¡çŒ®</span><br><span class="line">        int tile_atoms = min(TILE_SIZE, N - tile);</span><br><span class="line">        for (int i = 0; i &lt; tile_atoms; i++) &#123;</span><br><span class="line">            float dx = px - s_atoms[i * 3 + 0];</span><br><span class="line">            float dy = py - s_atoms[i * 3 + 1];</span><br><span class="line">            float dz = pz - s_atoms[i * 3 + 2];</span><br><span class="line">            float r = sqrtf(dx*dx + dy*dy + dz*dz);</span><br><span class="line">            if (r &gt; 0.001f) &#123;</span><br><span class="line">                sum += s_charges[i] / r;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        __syncthreads();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    if (gx &lt; Gx &amp;&amp; gy &lt; Gy &amp;&amp; gz &lt; Gz) &#123;</span><br><span class="line">        potential[gx * Gy * Gz + gy * Gz + gz] = sum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="xing-neng-fen-xi" tabindex="-1" id="æ€§èƒ½åˆ†æ">æ€§èƒ½åˆ†æ</h3><table><thead><tr><th>ç‰ˆæœ¬</th><th>å…¨å±€å†…å­˜è¯»å–æ¬¡æ•°</th><th>åŠ é€Ÿæ¯”</th></tr></thead><tbody><tr><td>æœ´ç´ </td><td>GÂ³ Ã— N</td><td>1Ã—</td></tr><tr><td>Tiled</td><td>GÂ³ Ã— N / B + N</td><td>~10Ã—</td></tr></tbody></table><p>å…¶ä¸­ B æ˜¯ Block å†…çº¿ç¨‹æ•°ã€‚</p><h2 id="chang-liang-nei-cun-you-hua" tabindex="-1" id="å¸¸é‡å†…å­˜ä¼˜åŒ–">å¸¸é‡å†…å­˜ä¼˜åŒ–</h2><h3 id="yuan-zi-shu-ju-fang-ru-chang-liang-nei-cun" tabindex="-1" id="åŸå­æ•°æ®æ”¾å…¥å¸¸é‡å†…å­˜">åŸå­æ•°æ®æ”¾å…¥å¸¸é‡å†…å­˜</h3><p>å¦‚æœåŸå­æ•°ä¸å¤ªå¤šï¼ˆ&lt; 16Kï¼‰ï¼Œå¯ä»¥æ”¾å…¥å¸¸é‡å†…å­˜ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">#define MAX_ATOMS 16000</span><br><span class="line"></span><br><span class="line">__constant__ float c_atoms[MAX_ATOMS * 4];  // x, y, z, charge</span><br><span class="line"></span><br><span class="line">void setup_atoms(float *atoms, float *charges, int N) &#123;</span><br><span class="line">    float atoms_packed[MAX_ATOMS * 4];</span><br><span class="line">    for (int i = 0; i &lt; N; i++) &#123;</span><br><span class="line">        atoms_packed[i * 4 + 0] = atoms[i * 3 + 0];</span><br><span class="line">        atoms_packed[i * 4 + 1] = atoms[i * 3 + 1];</span><br><span class="line">        atoms_packed[i * 4 + 2] = atoms[i * 3 + 2];</span><br><span class="line">        atoms_packed[i * 4 + 3] = charges[i];</span><br><span class="line">    &#125;</span><br><span class="line">    cudaMemcpyToSymbol(c_atoms, atoms_packed, N * 4 * sizeof(float));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__global__ void compute_potential_const(</span><br><span class="line">    float *potential,</span><br><span class="line">    int N,</span><br><span class="line">    int Gx, int Gy, int Gz,</span><br><span class="line">    float grid_spacing) &#123;</span><br><span class="line">    </span><br><span class="line">    // ... ç½‘æ ¼ç‚¹åæ ‡è®¡ç®— ...</span><br><span class="line">    </span><br><span class="line">    float sum = 0.0f;</span><br><span class="line">    for (int i = 0; i &lt; N; i++) &#123;</span><br><span class="line">        float ax = c_atoms[i * 4 + 0];</span><br><span class="line">        float ay = c_atoms[i * 4 + 1];</span><br><span class="line">        float az = c_atoms[i * 4 + 2];</span><br><span class="line">        float q  = c_atoms[i * 4 + 3];</span><br><span class="line">        </span><br><span class="line">        float dx = px - ax;</span><br><span class="line">        float dy = py - ay;</span><br><span class="line">        float dz = pz - az;</span><br><span class="line">        float r = sqrtf(dx*dx + dy*dy + dz*dz);</span><br><span class="line">        if (r &gt; 0.001f) &#123;</span><br><span class="line">            sum += q / r;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // ... å†™å…¥ç»“æœ ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ä¼˜åŠ¿</strong>ï¼š</p><ul><li>å¸¸é‡å†…å­˜æœ‰ä¸“ç”¨ç¼“å­˜</li><li>å¹¿æ’­æœºåˆ¶ï¼šWarp å†…çº¿ç¨‹è®¿é—®åŒä¸€åœ°å€åªéœ€ä¸€æ¬¡è¯»å–</li></ul><h2 id="jie-duan-fang-fa" tabindex="-1" id="æˆªæ–­æ–¹æ³•">æˆªæ–­æ–¹æ³•</h2><h3 id="wei-shi-yao-jie-duan" tabindex="-1" id="ä¸ºä»€ä¹ˆæˆªæ–­">ä¸ºä»€ä¹ˆæˆªæ–­</h3><p>çœŸå®åˆ†å­æ¨¡æ‹Ÿä¸­ï¼Œè¿œè·ç¦»åŸå­çš„è´¡çŒ®å¾ˆå°ã€‚å¯ä»¥è®¾ç½®<strong>æˆªæ–­åŠå¾„</strong>ï¼Œåªè®¡ç®—è·ç¦»å°äºæˆªæ–­åŠå¾„çš„åŸå­ã€‚</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>V</mi><mo stretchy="false">(</mo><mi mathvariant="bold">p</mi><mo stretchy="false">)</mo><mo>=</mo><munder><mo>âˆ‘</mo><mrow><mi mathvariant="normal">âˆ£</mi><mi mathvariant="bold">p</mi><mo>âˆ’</mo><msub><mi mathvariant="bold">r</mi><mi>i</mi></msub><mi mathvariant="normal">âˆ£</mi><mo>&lt;</mo><msub><mi>r</mi><mrow><mi>c</mi><mi>u</mi><mi>t</mi></mrow></msub></mrow></munder><mfrac><mrow><mi>k</mi><mo>â‹…</mo><msub><mi>q</mi><mi>i</mi></msub></mrow><mrow><mi mathvariant="normal">âˆ£</mi><mi mathvariant="bold">p</mi><mo>âˆ’</mo><msub><mi mathvariant="bold">r</mi><mi>i</mi></msub><mi mathvariant="normal">âˆ£</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">V(\mathbf{p}) = \sum_{|\mathbf{p} - \mathbf{r}_i| &lt; r_{cut}} \frac{k \cdot q_i}{|\mathbf{p} - \mathbf{r}_i|}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mopen">(</span><span class="mord mathbf">p</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.8874em;vertical-align:-1.516em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.809em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">âˆ£</span><span class="mord mathbf mtight">p</span><span class="mbin mtight">âˆ’</span><span class="mord mtight"><span class="mord mathbf mtight">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mord mtight">âˆ£</span><span class="mrel mtight">&lt;</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2963em;"><span style="top:-2.357em;margin-left:-0.0278em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.516em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">âˆ£</span><span class="mord mathbf">p</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathbf">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">âˆ£</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><h3 id="kong-jian-fen-qu" tabindex="-1" id="ç©ºé—´åˆ†åŒº">ç©ºé—´åˆ†åŒº</h3><p>ä¸ºäº†å¿«é€Ÿæ‰¾åˆ°&quot;é™„è¿‘&quot;çš„åŸå­ï¼Œä½¿ç”¨<strong>ç©ºé—´å“ˆå¸Œ</strong>æˆ–<strong>Cell List</strong>ï¼š</p><ol><li>æŠŠç©ºé—´åˆ’åˆ†æˆå°æ ¼å­ï¼ˆè¾¹é•¿ = æˆªæ–­åŠå¾„ï¼‰</li><li>æ¯ä¸ªåŸå­åˆ†é…åˆ°æ‰€åœ¨æ ¼å­</li><li>è®¡ç®—ç½‘æ ¼ç‚¹æ—¶ï¼Œåªéå†é‚»è¿‘ 27 ä¸ªæ ¼å­ä¸­çš„åŸå­</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">__global__ void compute_potential_cutoff(</span><br><span class="line">    float *potential,</span><br><span class="line">    int *cell_start,    // [Cx, Cy, Cz] æ¯ä¸ªæ ¼å­çš„åŸå­èµ·å§‹ç´¢å¼•</span><br><span class="line">    int *cell_count,    // [Cx, Cy, Cz] æ¯ä¸ªæ ¼å­çš„åŸå­æ•°</span><br><span class="line">    float *sorted_atoms,</span><br><span class="line">    float *sorted_charges,</span><br><span class="line">    float cutoff,</span><br><span class="line">    int Gx, int Gy, int Gz,</span><br><span class="line">    int Cx, int Cy, int Cz,</span><br><span class="line">    float grid_spacing,</span><br><span class="line">    float cell_size) &#123;</span><br><span class="line">    </span><br><span class="line">    int gx = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">    int gy = blockIdx.y * blockDim.y + threadIdx.y;</span><br><span class="line">    int gz = blockIdx.z * blockDim.z + threadIdx.z;</span><br><span class="line">    </span><br><span class="line">    if (gx &gt;= Gx || gy &gt;= Gy || gz &gt;= Gz) return;</span><br><span class="line">    </span><br><span class="line">    float px = gx * grid_spacing;</span><br><span class="line">    float py = gy * grid_spacing;</span><br><span class="line">    float pz = gz * grid_spacing;</span><br><span class="line">    </span><br><span class="line">    // ç¡®å®šæ‰€åœ¨æ ¼å­</span><br><span class="line">    int cx = (int)(px / cell_size);</span><br><span class="line">    int cy = (int)(py / cell_size);</span><br><span class="line">    int cz = (int)(pz / cell_size);</span><br><span class="line">    </span><br><span class="line">    float sum = 0.0f;</span><br><span class="line">    </span><br><span class="line">    // éå†é‚»è¿‘ 27 ä¸ªæ ¼å­</span><br><span class="line">    for (int dcx = -1; dcx &lt;= 1; dcx++) &#123;</span><br><span class="line">        for (int dcy = -1; dcy &lt;= 1; dcy++) &#123;</span><br><span class="line">            for (int dcz = -1; dcz &lt;= 1; dcz++) &#123;</span><br><span class="line">                int ncx = cx + dcx;</span><br><span class="line">                int ncy = cy + dcy;</span><br><span class="line">                int ncz = cz + dcz;</span><br><span class="line">                </span><br><span class="line">                if (ncx &lt; 0 || ncx &gt;= Cx || ncy &lt; 0 || ncy &gt;= Cy || ncz &lt; 0 || ncz &gt;= Cz)</span><br><span class="line">                    continue;</span><br><span class="line">                </span><br><span class="line">                int cell_idx = ncx * Cy * Cz + ncy * Cz + ncz;</span><br><span class="line">                int start = cell_start[cell_idx];</span><br><span class="line">                int count = cell_count[cell_idx];</span><br><span class="line">                </span><br><span class="line">                for (int i = 0; i &lt; count; i++) &#123;</span><br><span class="line">                    int atom_idx = start + i;</span><br><span class="line">                    float dx = px - sorted_atoms[atom_idx * 3 + 0];</span><br><span class="line">                    float dy = py - sorted_atoms[atom_idx * 3 + 1];</span><br><span class="line">                    float dz = pz - sorted_atoms[atom_idx * 3 + 2];</span><br><span class="line">                    float r = sqrtf(dx*dx + dy*dy + dz*dz);</span><br><span class="line">                    </span><br><span class="line">                    if (r &gt; 0.001f &amp;&amp; r &lt; cutoff) &#123;</span><br><span class="line">                        sum += sorted_charges[atom_idx] / r;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    potential[gx * Gy * Gz + gy * Gz + gz] = sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="fu-za-du-fen-xi" tabindex="-1" id="å¤æ‚åº¦åˆ†æ">å¤æ‚åº¦åˆ†æ</h3><table><thead><tr><th>æ–¹æ³•</th><th>å¤æ‚åº¦</th><th>é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td>ç›´æ¥æ±‚å’Œ</td><td>O(GÂ³ Ã— N)</td><td>å°ç³»ç»Ÿ</td></tr><tr><td>æˆªæ–­ + Cell</td><td>O(GÂ³ Ã— Ï Ã— rÂ³)</td><td>å¤§ç³»ç»Ÿ</td></tr></tbody></table><p>å…¶ä¸­ Ï æ˜¯åŸå­å¯†åº¦ï¼Œr æ˜¯æˆªæ–­åŠå¾„ã€‚</p><h2 id="duo-ceng-wang-ge-fang-fa" tabindex="-1" id="å¤šå±‚ç½‘æ ¼æ–¹æ³•">å¤šå±‚ç½‘æ ¼æ–¹æ³•</h2><h3 id="ewald-qiu-he" tabindex="-1" id="Ewald-æ±‚å’Œ">Ewald æ±‚å’Œ</h3><p>å¯¹äºå‘¨æœŸæ€§è¾¹ç•Œæ¡ä»¶ï¼Œéœ€è¦è€ƒè™‘<strong>æ‰€æœ‰å‘¨æœŸé•œåƒ</strong>çš„è´¡çŒ®ã€‚</p><p><strong>Ewald æ–¹æ³•</strong>å°†æ±‚å’Œåˆ†æˆä¸¤éƒ¨åˆ†ï¼š</p><ol><li><strong>å®ç©ºé—´</strong>ï¼šæˆªæ–­æ±‚å’Œï¼ˆçŸ­ç¨‹ï¼‰</li><li><strong>å€’ç©ºé—´</strong>ï¼šFFT æ±‚å’Œï¼ˆé•¿ç¨‹ï¼‰</li></ol><h3 id="pme-particle-mesh-ewald" tabindex="-1" id="PMEï¼ˆParticle-Mesh-Ewaldï¼‰">PMEï¼ˆParticle Mesh Ewaldï¼‰</h3><p>PME æ˜¯ Ewald çš„é«˜æ•ˆå˜ä½“ï¼š</p><ol><li>æŠŠç”µè·åˆ†é…åˆ°ç½‘æ ¼</li><li>å¯¹ç½‘æ ¼åš FFT</li><li>åœ¨å€’ç©ºé—´è®¡ç®—åŠ¿èƒ½</li><li>åš IFFT</li><li>æ’å€¼å›åŸå­ä½ç½®</li></ol><p><strong>å¤æ‚åº¦</strong>ï¼šO(N log N) vs ç›´æ¥ Ewald çš„ O(N^1.5)</p><h3 id="gpu-shang-de-pme" tabindex="-1" id="GPU-ä¸Šçš„-PME">GPU ä¸Šçš„ PME</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">void pme_potential(</span><br><span class="line">    float *potential,</span><br><span class="line">    float *atoms,</span><br><span class="line">    float *charges,</span><br><span class="line">    int N,</span><br><span class="line">    int grid_size) &#123;</span><br><span class="line">    </span><br><span class="line">    // 1. ç”µè·åˆ†é…åˆ°ç½‘æ ¼ï¼ˆB-spline æ’å€¼ï¼‰</span><br><span class="line">    charge_spreading&lt;&lt;&lt;...&gt;&gt;&gt;(charges, atoms, grid_charges, N, grid_size);</span><br><span class="line">    </span><br><span class="line">    // 2. 3D FFT</span><br><span class="line">    cufftExecC2C(plan, grid_charges, grid_kspace, CUFFT_FORWARD);</span><br><span class="line">    </span><br><span class="line">    // 3. å€’ç©ºé—´æ“ä½œï¼ˆä¹˜ä»¥ Green å‡½æ•°ï¼‰</span><br><span class="line">    reciprocal_kernel&lt;&lt;&lt;...&gt;&gt;&gt;(grid_kspace, grid_size);</span><br><span class="line">    </span><br><span class="line">    // 4. 3D IFFT</span><br><span class="line">    cufftExecC2C(plan, grid_kspace, grid_potential, CUFFT_INVERSE);</span><br><span class="line">    </span><br><span class="line">    // 5. æ’å€¼å›ç½‘æ ¼ç‚¹</span><br><span class="line">    interpolate_kernel&lt;&lt;&lt;...&gt;&gt;&gt;(grid_potential, potential, grid_size);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="duo-gpu-shi-xian" tabindex="-1" id="å¤š-GPU-å®ç°">å¤š GPU å®ç°</h2><h3 id="shu-ju-bing-xing" tabindex="-1" id="æ•°æ®å¹¶è¡Œ">æ•°æ®å¹¶è¡Œ</h3><p>å¯¹äºå¤§ç½‘æ ¼ï¼Œå¯ä»¥å°†ç½‘æ ¼åˆ†å‰²åˆ°å¤šä¸ª GPUï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">void multi_gpu_potential(</span><br><span class="line">    float *potential,</span><br><span class="line">    float *atoms,</span><br><span class="line">    float *charges,</span><br><span class="line">    int N,</span><br><span class="line">    int Gx, int Gy, int Gz,</span><br><span class="line">    int num_gpus) &#123;</span><br><span class="line">    </span><br><span class="line">    int slices_per_gpu = Gx / num_gpus;</span><br><span class="line">    </span><br><span class="line">    #pragma omp parallel for num_threads(num_gpus)</span><br><span class="line">    for (int gpu = 0; gpu &lt; num_gpus; gpu++) &#123;</span><br><span class="line">        cudaSetDevice(gpu);</span><br><span class="line">        </span><br><span class="line">        int gx_start = gpu * slices_per_gpu;</span><br><span class="line">        int gx_end = (gpu == num_gpus - 1) ? Gx : (gpu + 1) * slices_per_gpu;</span><br><span class="line">        </span><br><span class="line">        compute_potential_kernel&lt;&lt;&lt;...&gt;&gt;&gt;(</span><br><span class="line">            potential + gx_start * Gy * Gz,</span><br><span class="line">            atoms_d[gpu], charges_d[gpu], N,</span><br><span class="line">            gx_start, gx_end, Gy, Gz, grid_spacing);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // æ”¶é›†ç»“æœ</span><br><span class="line">    // ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="zhu-yi-shi-xiang" tabindex="-1" id="æ³¨æ„äº‹é¡¹">æ³¨æ„äº‹é¡¹</h3><ul><li>æ¯ä¸ª GPU éœ€è¦å®Œæ•´çš„åŸå­æ•°æ®å‰¯æœ¬</li><li>è¾¹ç•ŒåŒºåŸŸå¯èƒ½éœ€è¦é‡å è®¡ç®—</li><li>ä½¿ç”¨ NCCL é«˜æ•ˆé€šä¿¡</li></ul><h2 id="ying-yong-fen-zi-dui-jie" tabindex="-1" id="åº”ç”¨ï¼šåˆ†å­å¯¹æ¥">åº”ç”¨ï¼šåˆ†å­å¯¹æ¥</h2><h3 id="yao-wu-she-ji-zhong-de-ying-yong" tabindex="-1" id="è¯ç‰©è®¾è®¡ä¸­çš„åº”ç”¨">è¯ç‰©è®¾è®¡ä¸­çš„åº”ç”¨</h3><p>é™ç”µåŠ¿èƒ½å›¾ç”¨äº<strong>åˆ†å­å¯¹æ¥</strong>ï¼šé¢„æµ‹é…ä½“åˆ†å­ä¸è›‹ç™½è´¨é¶ç‚¹çš„ç»“åˆæ–¹å¼ã€‚</p><p><strong>æµç¨‹</strong>ï¼š</p><ol><li>è®¡ç®—è›‹ç™½è´¨çš„é™ç”µåŠ¿èƒ½å›¾</li><li>é…ä½“åœ¨åŠ¿èƒ½å›¾ä¸­æœç´¢æœ€ä¼˜ä½ç½®</li><li>è¯„ä¼°ç»“åˆäº²å’ŒåŠ›</li></ol><h3 id="shi-shi-ke-shi-hua" tabindex="-1" id="å®æ—¶å¯è§†åŒ–">å®æ—¶å¯è§†åŒ–</h3><p>GPU è®¡ç®—çš„é™ç”µåŠ¿èƒ½å›¾å¯ä»¥å®æ—¶æ¸²æŸ“ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// å°†åŠ¿èƒ½å›¾è½¬æ¢ä¸ºé¢œè‰²</span><br><span class="line">__global__ void potential_to_color(</span><br><span class="line">    float *potential,</span><br><span class="line">    uchar4 *colors,</span><br><span class="line">    float min_val, float max_val,</span><br><span class="line">    int num_points) &#123;</span><br><span class="line">    </span><br><span class="line">    int idx = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">    if (idx &gt;= num_points) return;</span><br><span class="line">    </span><br><span class="line">    float val = potential[idx];</span><br><span class="line">    float normalized = (val - min_val) / (max_val - min_val);</span><br><span class="line">    </span><br><span class="line">    // çº¢è‰²è¡¨ç¤ºæ­£ç”µåŠ¿ï¼Œè“è‰²è¡¨ç¤ºè´Ÿç”µåŠ¿</span><br><span class="line">    colors[idx].x = (unsigned char)(255 * fmaxf(normalized, 0.0f));</span><br><span class="line">    colors[idx].y = 0;</span><br><span class="line">    colors[idx].z = (unsigned char)(255 * fmaxf(-normalized, 0.0f));</span><br><span class="line">    colors[idx].w = 255;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="xing-neng-zong-jie" tabindex="-1" id="æ€§èƒ½æ€»ç»“">æ€§èƒ½æ€»ç»“</h2><h3 id="ge-you-hua-de-jia-su-xiao-guo" tabindex="-1" id="å„ä¼˜åŒ–çš„åŠ é€Ÿæ•ˆæœ">å„ä¼˜åŒ–çš„åŠ é€Ÿæ•ˆæœ</h3><table><thead><tr><th>ä¼˜åŒ–æŠ€æœ¯</th><th>ç›¸å¯¹åŠ é€Ÿ</th><th>ç´¯è®¡åŠ é€Ÿ</th></tr></thead><tbody><tr><td>GPU æœ´ç´ </td><td>50Ã—</td><td>50Ã—</td></tr><tr><td>å…±äº«å†…å­˜ Tiling</td><td>10Ã—</td><td>500Ã—</td></tr><tr><td>å¸¸é‡å†…å­˜</td><td>1.5Ã—</td><td>750Ã—</td></tr><tr><td>æˆªæ–­ + Cell</td><td>5-20Ã—</td><td>3000Ã—+</td></tr></tbody></table><h3 id="shi-ji-xing-neng" tabindex="-1" id="å®é™…æ€§èƒ½">å®é™…æ€§èƒ½</h3><p>256Â³ ç½‘æ ¼ï¼Œ10000 ä¸ªåŸå­ï¼š</p><ul><li>CPUï¼ˆå•æ ¸ï¼‰ï¼š~600 ç§’</li><li>GPUï¼ˆV100ï¼‰ï¼š~0.2 ç§’</li></ul><p><strong>åŠ é€Ÿæ¯”</strong>ï¼š3000Ã— ä»¥ä¸Š</p><h2 id="xiao-jie" tabindex="-1" id="å°ç»“">å°ç»“</h2><p>ç¬¬åå…«ç« å±•ç¤ºäº†é™ç”µåŠ¿èƒ½è®¡ç®—çš„ GPU åŠ é€Ÿï¼š</p><p><strong>é—®é¢˜æœ¬è´¨</strong>ï¼šN-body ç±»å‹çš„å…¨å¯¹é—®é¢˜ï¼Œæ¯ä¸ªç½‘æ ¼ç‚¹éœ€è¦éå†æ‰€æœ‰åŸå­ã€‚ç›´æ¥è®¡ç®—å¤æ‚åº¦ O(GÂ³ Ã— N)ã€‚</p><p><strong>å…±äº«å†…å­˜ä¼˜åŒ–</strong>ï¼šæŠŠåŸå­æ•°æ®åˆ†å—åŠ è½½åˆ°å…±äº«å†…å­˜ï¼ŒBlock å†…çº¿ç¨‹å…±äº«ï¼Œå¤§å¹…å‡å°‘å…¨å±€å†…å­˜è®¿é—®ã€‚</p><p><strong>å¸¸é‡å†…å­˜</strong>ï¼šå¯¹äºå°è§„æ¨¡åŸå­æ•°æ®ï¼Œåˆ©ç”¨å¸¸é‡ç¼“å­˜å’Œå¹¿æ’­æœºåˆ¶è¿›ä¸€æ­¥åŠ é€Ÿã€‚</p><p><strong>æˆªæ–­æ–¹æ³•</strong>ï¼šåˆ©ç”¨ç‰©ç†ç‰¹æ€§ï¼ˆè¿œåœºè´¡çŒ®å°ï¼‰å‡å°‘è®¡ç®—é‡ã€‚Cell List æ•°æ®ç»“æ„å¿«é€ŸæŸ¥æ‰¾é‚»è¿‘åŸå­ã€‚</p><p><strong>PME æ–¹æ³•</strong>ï¼šå¯¹äºå‘¨æœŸæ€§ç³»ç»Ÿï¼Œç”¨ FFT å¤„ç†é•¿ç¨‹ç›¸äº’ä½œç”¨ï¼Œå¤æ‚åº¦é™è‡³ O(N log N)ã€‚</p><p><strong>å¤š GPU æ‰©å±•</strong>ï¼šç½‘æ ¼å¤©ç„¶å¯åˆ†å‰²ï¼Œé€‚åˆæ•°æ®å¹¶è¡Œã€‚</p><p>é™ç”µåŠ¿èƒ½è®¡ç®—æ˜¯åˆ†å­åŠ¨åŠ›å­¦æ¨¡æ‹Ÿçš„æ ¸å¿ƒç»„ä»¶ã€‚æŒæ¡æœ¬ç« æŠ€æœ¯ï¼Œå°±èƒ½ç†è§£ GROMACSã€AMBER ç­‰åˆ†å­åŠ¨åŠ›å­¦è½¯ä»¶çš„ GPU åŠ é€ŸåŸç†ã€‚</p><hr><p><strong>å‚è€ƒèµ„æ–™ï¼š</strong></p><ul><li>Hwu, W., Kirk, D., &amp; El Hajj, I. (2022). <em>Programming Massively Parallel Processors: A Hands-on Approach</em> (4th Edition). Morgan Kaufmann.</li><li>Stone, J. E., et al. (2007). <em>Accelerating Molecular Modeling Applications with GPU Computing</em>. JCC.</li><li>Darden, T., et al. (1993). <em>Particle Mesh Ewald: An NÂ·log(N) Method for Ewald Sums</em>. JCP.</li></ul><hr><blockquote><p><strong>æœ¬æ–‡ GitHub ä»“åº“</strong>: <a href="https://github.com/psmarter/PMPP-Learning">https://github.com/psmarter/PMPP-Learning</a></p></blockquote>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;qian-yan&quot; tabindex=&quot;-1&quot; id=&quot;å‰è¨€&quot;&gt;å‰è¨€&lt;/h2&gt;
&lt;p&gt;ç¬¬åä¸ƒç« æˆ‘ä»¬æ¢ç´¢äº† MRI</summary>
        
      
    
    
    
    <category term="çŸ¥è¯†åˆ†äº«" scheme="https://smarter.xin/categories/knowledge-sharing/"/>
    
    
    <category term="CUDA" scheme="https://smarter.xin/tags/CUDA/"/>
    
    <category term="GPUç¼–ç¨‹" scheme="https://smarter.xin/tags/gpu-programming/"/>
    
    <category term="å¹¶è¡Œè®¡ç®—" scheme="https://smarter.xin/tags/parallel-computing/"/>
    
    <category term="PMPP" scheme="https://smarter.xin/tags/PMPP/"/>
    
    <category term="åˆ†å­åŠ¨åŠ›å­¦" scheme="https://smarter.xin/tags/molecular-dynamics/"/>
    
    <category term="é™ç”µåŠ¿èƒ½" scheme="https://smarter.xin/tags/electrostatic-potential/"/>
    
    <category term="ç§‘å­¦è®¡ç®—" scheme="https://smarter.xin/tags/scientific-computing/"/>
    
  </entry>
  
  <entry>
    <title>PMPP-ç¬¬åä¸ƒç« ï¼šè¿­ä»£å¼ç£å…±æŒ¯æˆåƒé‡å»º</title>
    <link href="https://smarter.xin/posts/fab0715b/"/>
    <id>https://smarter.xin/posts/fab0715b/</id>
    <published>2026-01-23T01:08:10.000Z</published>
    <updated>2026-01-24T08:26:21.332Z</updated>
    
    <content type="html"><![CDATA[<h2 id="qian-yan" tabindex="-1" id="å‰è¨€">å‰è¨€</h2><p>å‰é¢çš„ç« èŠ‚ä¸»è¦è®¨è®ºäº†é€šç”¨çš„å¹¶è¡Œç®—æ³•å’Œæ·±åº¦å­¦ä¹ ã€‚ç¬¬åä¸ƒç« è½¬å‘ä¸€ä¸ªå…·ä½“çš„åº”ç”¨é¢†åŸŸâ€”â€”<strong>åŒ»å­¦å½±åƒ</strong>ï¼Œç‰¹åˆ«æ˜¯**ç£å…±æŒ¯æˆåƒï¼ˆMRIï¼‰**çš„å›¾åƒé‡å»ºã€‚MRI é‡å»ºæ˜¯è®¡ç®—å¯†é›†å‹ä»»åŠ¡ï¼Œæ¶‰åŠå¤§é‡çš„å‚…é‡Œå¶å˜æ¢å’Œè¿­ä»£ä¼˜åŒ–ï¼Œæ˜¯ GPU åŠ é€Ÿçš„ç†æƒ³åœºæ™¯ã€‚æœ¬ç« å°†å±•ç¤ºå¦‚ä½•å°†å‰é¢å­¦åˆ°çš„å¹¶è¡ŒæŠ€æœ¯ï¼ˆFFTã€çŸ©é˜µè¿ç®—ã€è¿­ä»£æ±‚è§£ï¼‰ç»¼åˆåº”ç”¨åˆ°å®é™…é—®é¢˜ä¸­ã€‚</p><blockquote><p><strong>ğŸ“¦ é…å¥—èµ„æº</strong>ï¼šæœ¬ç³»åˆ—æ–‡ç« é…æœ‰å®Œæ•´çš„ <a href="https://github.com/psmarter/PMPP-Learning">GitHub ä»“åº“</a>ï¼ŒåŒ…å«æ¯ç« çš„ç»ƒä¹ é¢˜è§£ç­”ã€CUDA ä»£ç å®ç°å’Œè¯¦ç»†æ³¨é‡Šã€‚æ‰€æœ‰ä»£ç éƒ½ç»è¿‡æµ‹è¯•ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œã€‚</p></blockquote><h2 id="mri-cheng-xiang-ji-chu" tabindex="-1" id="MRI-æˆåƒåŸºç¡€">MRI æˆåƒåŸºç¡€</h2><h3 id="mri-wu-li-yuan-li-jian-shu" tabindex="-1" id="MRI-ç‰©ç†åŸç†ç®€è¿°">MRI ç‰©ç†åŸç†ç®€è¿°</h3><p>MRI åˆ©ç”¨äººä½“ä¸­æ°¢åŸå­æ ¸çš„ç£å…±æŒ¯ç°è±¡æˆåƒï¼š</p><ol><li><strong>æ¿€å‘</strong>ï¼šå°„é¢‘è„‰å†²æ¿€å‘æ°¢åŸå­æ ¸</li><li><strong>å¼›è±«</strong>ï¼šåŸå­æ ¸æ¢å¤å¹³è¡¡æ—¶å‘å‡ºä¿¡å·</li><li><strong>é‡‡é›†</strong>ï¼šæ¥æ”¶çº¿åœˆé‡‡é›†ä¿¡å·</li><li><strong>ç¼–ç </strong>ï¼šæ¢¯åº¦ç£åœºå¯¹ç©ºé—´ä½ç½®è¿›è¡Œç¼–ç </li></ol><p>é‡‡é›†åˆ°çš„ä¿¡å·ä½äº<strong>k ç©ºé—´ï¼ˆk-spaceï¼‰</strong>â€”â€”å›¾åƒçš„å‚…é‡Œå¶å˜æ¢åŸŸã€‚</p><h3 id="cong-k-kong-jian-dao-tu-xiang" tabindex="-1" id="ä»-k-ç©ºé—´åˆ°å›¾åƒ">ä» k ç©ºé—´åˆ°å›¾åƒ</h3><p><strong>åŸºæœ¬å…¬å¼</strong>ï¼š</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>s</mi><mo stretchy="false">(</mo><msub><mi>k</mi><mi>x</mi></msub><mo separator="true">,</mo><msub><mi>k</mi><mi>y</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mo>âˆ«</mo><mo>âˆ«</mo><mi>m</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo><mo>â‹…</mo><msup><mi>e</mi><mrow><mo>âˆ’</mo><mi>i</mi><mn>2</mn><mi>Ï€</mi><mo stretchy="false">(</mo><msub><mi>k</mi><mi>x</mi></msub><mi>x</mi><mo>+</mo><msub><mi>k</mi><mi>y</mi></msub><mi>y</mi><mo stretchy="false">)</mo></mrow></msup><mi>d</mi><mi>x</mi><mi>d</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">s(k_x, k_y) = \int \int m(x, y) \cdot e^{-i2\pi(k_x x + k_y y)} dx dy</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord mathnormal">s</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.2222em;vertical-align:-0.8622em;"></span><span class="mop op-symbol large-op" style="margin-right:0.44445em;position:relative;top:-0.0011em;">âˆ«âˆ«</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">m</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.1324em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">âˆ’</span><span class="mord mathnormal mtight">i</span><span class="mord mtight">2</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">Ï€</span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.0315em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mord mathnormal mtight">x</span><span class="mbin mtight">+</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.0315em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span></span></span></span></span></span></span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mord mathnormal">d</span><span class="mord mathnormal">x</span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span></span></p><p>å…¶ä¸­ï¼š</p><ul><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mo stretchy="false">(</mo><msub><mi>k</mi><mi>x</mi></msub><mo separator="true">,</mo><msub><mi>k</mi><mi>y</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">s(k_x, k_y)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord mathnormal">s</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>ï¼šk ç©ºé—´ä¿¡å·</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">m(x, y)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">m</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span>ï¼šå›¾åƒï¼ˆç£åŒ–å¼ºåº¦åˆ†å¸ƒï¼‰</li></ul><p><strong>é‡å»º</strong>å°±æ˜¯ä» <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">s</span></span></span></span> æ¢å¤ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span>ï¼Œå³<strong>é€†å‚…é‡Œå¶å˜æ¢</strong>ã€‚</p><h3 id="di-qia-er-cai-yang-vs-fei-di-qia-er-cai-yang" tabindex="-1" id="ç¬›å¡å°”é‡‡æ ·-vs-éç¬›å¡å°”é‡‡æ ·">ç¬›å¡å°”é‡‡æ · vs éç¬›å¡å°”é‡‡æ ·</h3><p><strong>ç¬›å¡å°”é‡‡æ ·</strong>ï¼šk ç©ºé—´æ•°æ®åœ¨è§„åˆ™ç½‘æ ¼ä¸Šé‡‡é›†ã€‚</p><ul><li>ä¼˜ç‚¹ï¼šç›´æ¥ç”¨ FFT é‡å»º</li><li>ç¼ºç‚¹ï¼šé‡‡é›†é€Ÿåº¦å—é™</li></ul><p><strong>éç¬›å¡å°”é‡‡æ ·</strong>ï¼ˆå¦‚èºæ—‹ã€å¾„å‘ï¼‰ï¼š</p><ul><li>ä¼˜ç‚¹ï¼šé‡‡é›†æ›´å¿«ï¼Œå¯¹è¿åŠ¨ä¸æ•æ„Ÿ</li><li>ç¼ºç‚¹ï¼šä¸èƒ½ç›´æ¥ FFTï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†</li></ul><h2 id="zhi-jie-zhong-jian-yu-die-dai-zhong-jian" tabindex="-1" id="ç›´æ¥é‡å»ºä¸è¿­ä»£é‡å»º">ç›´æ¥é‡å»ºä¸è¿­ä»£é‡å»º</h2><h3 id="zhi-jie-zhong-jian" tabindex="-1" id="ç›´æ¥é‡å»º">ç›´æ¥é‡å»º</h3><p>å¯¹äºç¬›å¡å°”é‡‡æ ·çš„å…¨é‡‡æ ·æ•°æ®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å›¾åƒ = IFFT(kç©ºé—´æ•°æ®)</span><br></pre></td></tr></table></figure><p>ç®€å•å¿«é€Ÿï¼Œä½†æœ‰ä¸¤ä¸ªé—®é¢˜ï¼š</p><ol><li><strong>æ¬ é‡‡æ ·</strong>ï¼šä¸ºåŠ é€Ÿæ‰«æï¼Œå¾€å¾€åªé‡‡é›†éƒ¨åˆ† k ç©ºé—´æ•°æ®</li><li><strong>éç¬›å¡å°”è½¨è¿¹</strong>ï¼šæ•°æ®ä¸åœ¨ç½‘æ ¼ä¸Š</li></ol><h3 id="qian-cai-yang-de-wen-ti" tabindex="-1" id="æ¬ é‡‡æ ·çš„é—®é¢˜">æ¬ é‡‡æ ·çš„é—®é¢˜</h3><p>æ ¹æ®å¥ˆå¥æ–¯ç‰¹å®šç†ï¼Œæ¬ é‡‡æ ·ä¼šå¯¼è‡´<strong>æ··å ä¼ªå½±ï¼ˆAliasingï¼‰</strong>ã€‚</p><p>ç›´æ¥ IFFT é‡å»ºæ¬ é‡‡æ ·æ•°æ®ä¼šäº§ç”Ÿä¸¥é‡çš„å›¾åƒå¤±çœŸã€‚</p><h3 id="die-dai-zhong-jian" tabindex="-1" id="è¿­ä»£é‡å»º">è¿­ä»£é‡å»º</h3><p><strong>æ€è·¯</strong>ï¼šæŠŠé‡å»ºå»ºæ¨¡ä¸º<strong>ä¼˜åŒ–é—®é¢˜</strong>ã€‚</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mover accent="true"><mi>m</mi><mo>^</mo></mover><mo>=</mo><mi>arg</mi><mo>â¡</mo><munder><mrow><mi>min</mi><mo>â¡</mo></mrow><mi>m</mi></munder><mfrac><mn>1</mn><mn>2</mn></mfrac><mi mathvariant="normal">âˆ¥</mi><mi>A</mi><mi>m</mi><mo>âˆ’</mo><mi>s</mi><msubsup><mi mathvariant="normal">âˆ¥</mi><mn>2</mn><mn>2</mn></msubsup><mo>+</mo><mi>Î»</mi><mi>R</mi><mo stretchy="false">(</mo><mi>m</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\hat{m} = \arg\min_m \frac{1}{2}\|Am - s\|_2^2 + \lambda R(m)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">m</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">^</span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0214em;vertical-align:-0.7em;"></span><span class="mop">ar<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6679em;"><span style="top:-2.4em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">min</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.7em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord">âˆ¥</span><span class="mord mathnormal">A</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.1141em;vertical-align:-0.25em;"></span><span class="mord mathnormal">s</span><span class="mord"><span class="mord">âˆ¥</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">Î»</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mclose">)</span></span></span></span></span></p><p>å…¶ä¸­ï¼š</p><ul><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span>ï¼šå‰å‘æ¨¡å‹ï¼ˆç¼–ç çŸ©é˜µï¼‰</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">s</span></span></span></span>ï¼šé‡‡é›†çš„ k ç©ºé—´æ•°æ®</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mo stretchy="false">(</mo><mi>m</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">R(m)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mclose">)</span></span></span></span>ï¼šæ­£åˆ™åŒ–é¡¹ï¼ˆå…ˆéªŒçº¦æŸï¼‰</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Î»</mi></mrow><annotation encoding="application/x-tex">\lambda</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">Î»</span></span></span></span>ï¼šæ­£åˆ™åŒ–æƒé‡</li></ul><p><strong>è¿­ä»£æ±‚è§£</strong>ï¼šé€šè¿‡æ¢¯åº¦ä¸‹é™ã€å…±è½­æ¢¯åº¦ç­‰æ–¹æ³•é€æ­¥é€¼è¿‘æœ€ä¼˜è§£ã€‚</p><h2 id="fei-jun-yun-fu-li-xie-bian-huan-nufft" tabindex="-1" id="éå‡åŒ€å‚…é‡Œå¶å˜æ¢ï¼ˆNUFFTï¼‰">éå‡åŒ€å‚…é‡Œå¶å˜æ¢ï¼ˆNUFFTï¼‰</h2><h3 id="wen-ti" tabindex="-1" id="é—®é¢˜">é—®é¢˜</h3><p>éç¬›å¡å°”é‡‡æ ·çš„æ•°æ®ä¸åœ¨è§„åˆ™ç½‘æ ¼ä¸Šï¼Œä¸èƒ½ç›´æ¥ç”¨ FFTã€‚</p><p><strong>éå‡åŒ€ç¦»æ•£å‚…é‡Œå¶å˜æ¢ï¼ˆNUDFTï¼‰</strong>ï¼š</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>s</mi><mo stretchy="false">(</mo><msub><mi>k</mi><mi>j</mi></msub><mo stretchy="false">)</mo><mo>=</mo><munderover><mo>âˆ‘</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></munderover><mi>m</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>â‹…</mo><msup><mi>e</mi><mrow><mo>âˆ’</mo><mi>i</mi><mn>2</mn><mi>Ï€</mi><msub><mi>k</mi><mi>j</mi></msub><msub><mi>x</mi><mi>i</mi></msub></mrow></msup></mrow><annotation encoding="application/x-tex">s(k_j) = \sum_{i=1}^{N} m(x_i) \cdot e^{-i2\pi k_j x_i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord mathnormal">s</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.106em;vertical-align:-1.2777em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">m</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8991em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">âˆ’</span><span class="mord mathnormal mtight">i</span><span class="mord mtight">2</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">Ï€</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.0315em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span></span></span></span></span></span></span><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p><p>ç›´æ¥è®¡ç®—å¤æ‚åº¦ O(MN)ï¼Œå¤ªæ…¢ã€‚</p><h3 id="nufft-suan-fa" tabindex="-1" id="NUFFT-ç®—æ³•">NUFFT ç®—æ³•</h3><p><strong>æ ¸å¿ƒæ€æƒ³</strong>ï¼šå…ˆæ’å€¼åˆ°è§„åˆ™ç½‘æ ¼ï¼Œå†ç”¨ FFTã€‚</p><p><strong>Type-1 NUFFTï¼ˆéå‡åŒ€åˆ°å‡åŒ€ï¼‰</strong>ï¼š</p><ol><li>æŠŠéå‡åŒ€ç‚¹çš„å€¼&quot;æ•£å¸ƒ&quot;åˆ°è§„åˆ™ç½‘æ ¼ï¼ˆå·ç§¯/æ’å€¼ï¼‰</li><li>å¯¹è§„åˆ™ç½‘æ ¼æ‰§è¡Œ FFT</li><li>å»å·ç§¯æ ¡æ­£</li></ol><p><strong>Type-2 NUFFTï¼ˆå‡åŒ€åˆ°éå‡åŒ€ï¼‰</strong>ï¼š</p><ol><li>å¯¹è§„åˆ™ç½‘æ ¼æ‰§è¡Œ IFFT</li><li>åœ¨éå‡åŒ€ç‚¹æ’å€¼é‡‡æ ·</li></ol><h3 id="gpu-shi-xian-yao-dian" tabindex="-1" id="GPU-å®ç°è¦ç‚¹">GPU å®ç°è¦ç‚¹</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">__global__ void gridding_kernel(</span><br><span class="line">    cuComplex *non_uniform_data,  // éå‡åŒ€é‡‡æ ·æ•°æ®</span><br><span class="line">    float2 *trajectory,            // é‡‡æ ·è½¨è¿¹ (kx, ky)</span><br><span class="line">    cuComplex *grid,               // è¾“å‡ºç½‘æ ¼</span><br><span class="line">    int num_samples,</span><br><span class="line">    int grid_size,</span><br><span class="line">    float kernel_width) &#123;</span><br><span class="line">    </span><br><span class="line">    int idx = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">    if (idx &gt;= num_samples) return;</span><br><span class="line">    </span><br><span class="line">    float kx = trajectory[idx].x;</span><br><span class="line">    float ky = trajectory[idx].y;</span><br><span class="line">    cuComplex val = non_uniform_data[idx];</span><br><span class="line">    </span><br><span class="line">    // æ‰¾åˆ°å½±å“çš„ç½‘æ ¼ç‚¹èŒƒå›´</span><br><span class="line">    int x_start = max(0, (int)(kx - kernel_width));</span><br><span class="line">    int x_end = min(grid_size - 1, (int)(kx + kernel_width));</span><br><span class="line">    int y_start = max(0, (int)(ky - kernel_width));</span><br><span class="line">    int y_end = min(grid_size - 1, (int)(ky + kernel_width));</span><br><span class="line">    </span><br><span class="line">    // æ•£å¸ƒåˆ°ç½‘æ ¼</span><br><span class="line">    for (int gx = x_start; gx &lt;= x_end; gx++) &#123;</span><br><span class="line">        for (int gy = y_start; gy &lt;= y_end; gy++) &#123;</span><br><span class="line">            float weight = kaiser_bessel(kx - gx, ky - gy, kernel_width);</span><br><span class="line">            atomicAdd(&amp;grid[gy * grid_size + gx].x, val.x * weight);</span><br><span class="line">            atomicAdd(&amp;grid[gy * grid_size + gx].y, val.y * weight);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å…³é”®ä¼˜åŒ–</strong>ï¼š</p><ul><li>ä½¿ç”¨ Kaiser-Bessel çª—å‡½æ•°æ’å€¼</li><li>åŸå­æ“ä½œå¤„ç†ç½‘æ ¼å†²çª</li><li>è¿‡é‡‡æ ·ç½‘æ ¼å‡å°‘è¯¯å·®</li></ul><h2 id="gong-e-ti-du-fa-cg" tabindex="-1" id="å…±è½­æ¢¯åº¦æ³•ï¼ˆCGï¼‰">å…±è½­æ¢¯åº¦æ³•ï¼ˆCGï¼‰</h2><h3 id="suan-fa-gai-shu" tabindex="-1" id="ç®—æ³•æ¦‚è¿°">ç®—æ³•æ¦‚è¿°</h3><p>å…±è½­æ¢¯åº¦æ³•æ±‚è§£çº¿æ€§ç³»ç»Ÿ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mi>x</mi><mo>=</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">Ax = b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">b</span></span></span></span>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">åˆå§‹åŒ–ï¼šx_0, r_0 = b - A*x_0, p_0 = r_0</span><br><span class="line"></span><br><span class="line">å¾ªç¯ï¼š</span><br><span class="line">    alpha_k = (r_kÂ·r_k) / (p_kÂ·A*p_k)</span><br><span class="line">    x_&#123;k+1&#125; = x_k + alpha_k * p_k</span><br><span class="line">    r_&#123;k+1&#125; = r_k - alpha_k * A*p_k</span><br><span class="line">    beta_k = (r_&#123;k+1&#125;Â·r_&#123;k+1&#125;) / (r_kÂ·r_k)</span><br><span class="line">    p_&#123;k+1&#125; = r_&#123;k+1&#125; + beta_k * p_k</span><br></pre></td></tr></table></figure><h3 id="gpu-shi-xian" tabindex="-1" id="GPU-å®ç°">GPU å®ç°</h3><p>CG çš„ä¸»è¦æ“ä½œï¼š</p><ol><li><strong>çŸ©é˜µ-å‘é‡ä¹˜</strong>ï¼šA*pï¼ˆä½¿ç”¨ NUFFTï¼‰</li><li><strong>å‘é‡å†…ç§¯</strong>ï¼šrÂ·rï¼ˆå½’çº¦ï¼‰</li><li><strong>å‘é‡åŠ æ³•</strong>ï¼šx + alpha*pï¼ˆé€å…ƒç´ ï¼‰</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">void cg_solve(</span><br><span class="line">    cuComplex *x,      // è§£ï¼ˆå›¾åƒï¼‰</span><br><span class="line">    cuComplex *b,      // å³ç«¯é¡¹ï¼ˆkç©ºé—´æ•°æ®ï¼‰</span><br><span class="line">    int max_iter,</span><br><span class="line">    float tol) &#123;</span><br><span class="line">    </span><br><span class="line">    // åˆ†é…ä¸­é—´å˜é‡</span><br><span class="line">    cuComplex *r, *p, *Ap;</span><br><span class="line">    </span><br><span class="line">    // r = b - A*x</span><br><span class="line">    apply_forward_model(x, Ap);</span><br><span class="line">    vector_subtract(b, Ap, r, n);</span><br><span class="line">    vector_copy(r, p, n);</span><br><span class="line">    </span><br><span class="line">    float rr = vector_dot(r, r, n);</span><br><span class="line">    </span><br><span class="line">    for (int k = 0; k &lt; max_iter &amp;&amp; rr &gt; tol; k++) &#123;</span><br><span class="line">        // Ap = A * p</span><br><span class="line">        apply_forward_model(p, Ap);</span><br><span class="line">        </span><br><span class="line">        // alpha = rr / (pÂ·Ap)</span><br><span class="line">        float pAp = vector_dot(p, Ap, n);</span><br><span class="line">        float alpha = rr / pAp;</span><br><span class="line">        </span><br><span class="line">        // x = x + alpha * p</span><br><span class="line">        vector_axpy(alpha, p, x, n);</span><br><span class="line">        </span><br><span class="line">        // r = r - alpha * Ap</span><br><span class="line">        vector_axpy(-alpha, Ap, r, n);</span><br><span class="line">        </span><br><span class="line">        // beta = rr_new / rr_old</span><br><span class="line">        float rr_new = vector_dot(r, r, n);</span><br><span class="line">        float beta = rr_new / rr;</span><br><span class="line">        </span><br><span class="line">        // p = r + beta * p</span><br><span class="line">        vector_xpay(r, beta, p, n);</span><br><span class="line">        </span><br><span class="line">        rr = rr_new;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="nufft-zuo-wei-qian-xiang-mo-xing" tabindex="-1" id="NUFFT-ä½œä¸ºå‰å‘æ¨¡å‹">NUFFT ä½œä¸ºå‰å‘æ¨¡å‹</h3><p>åœ¨ MRI é‡å»ºä¸­ï¼Œ<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span> ä¸æ˜¯æ˜¾å¼å­˜å‚¨çš„çŸ©é˜µï¼Œè€Œæ˜¯é€šè¿‡ NUFFT è®¡ç®—ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">void apply_forward_model(cuComplex *image, cuComplex *kspace) &#123;</span><br><span class="line">    // 1. å›¾åƒç©ºé—´ â†’ kç©ºé—´ï¼ˆType-2 NUFFTï¼‰</span><br><span class="line">    nufft_type2(image, kspace, trajectory, num_samples, grid_size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void apply_adjoint_model(cuComplex *kspace, cuComplex *image) &#123;</span><br><span class="line">    // 2. kç©ºé—´ â†’ å›¾åƒç©ºé—´ï¼ˆType-1 NUFFTï¼Œå…±è½­è½¬ç½®ï¼‰</span><br><span class="line">    nufft_type1(kspace, image, trajectory, num_samples, grid_size);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…±è½­æ¢¯åº¦ä¸­çš„ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>A</mi><mi>H</mi></msup><mi>A</mi></mrow><annotation encoding="application/x-tex">A^H A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.08125em;">H</span></span></span></span></span></span></span></span><span class="mord mathnormal">A</span></span></span></span> æ“ä½œå˜æˆï¼šNUFFT^H Â· NUFFTã€‚</p><h2 id="zheng-ze-hua" tabindex="-1" id="æ­£åˆ™åŒ–">æ­£åˆ™åŒ–</h2><h3 id="wei-shi-yao-xu-yao-zheng-ze-hua" tabindex="-1" id="ä¸ºä»€ä¹ˆéœ€è¦æ­£åˆ™åŒ–">ä¸ºä»€ä¹ˆéœ€è¦æ­£åˆ™åŒ–</h3><p>æ¬ é‡‡æ ·å¯¼è‡´é—®é¢˜<strong>æ¬ å®š</strong>ï¼šæ–¹ç¨‹æ•°å°‘äºæœªçŸ¥æ•°ã€‚</p><p>éœ€è¦é¢å¤–çº¦æŸæ¥é€‰æ‹©&quot;å¥½&quot;çš„è§£ã€‚</p><h3 id="chang-jian-zheng-ze-hua-xiang" tabindex="-1" id="å¸¸è§æ­£åˆ™åŒ–é¡¹">å¸¸è§æ­£åˆ™åŒ–é¡¹</h3><p><strong>Tikhonov æ­£åˆ™åŒ–ï¼ˆL2ï¼‰</strong>ï¼š</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mo stretchy="false">(</mo><mi>m</mi><mo stretchy="false">)</mo><mo>=</mo><mi mathvariant="normal">âˆ¥</mi><mi>m</mi><msubsup><mi mathvariant="normal">âˆ¥</mi><mn>2</mn><mn>2</mn></msubsup></mrow><annotation encoding="application/x-tex">R(m) = \|m\|_2^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1141em;vertical-align:-0.25em;"></span><span class="mord">âˆ¥</span><span class="mord mathnormal">m</span><span class="mord"><span class="mord">âˆ¥</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span></span></p><p>ä¿ƒè¿›è§£çš„å¹³æ»‘ï¼ŒæŠ‘åˆ¶å™ªå£°ã€‚</p><p><strong>å…¨å˜åˆ†ï¼ˆTVï¼‰</strong>ï¼š</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mo stretchy="false">(</mo><mi>m</mi><mo stretchy="false">)</mo><mo>=</mo><munder><mo>âˆ‘</mo><mi>i</mi></munder><msqrt><mrow><mo stretchy="false">(</mo><msub><mi mathvariant="normal">âˆ‡</mi><mi>x</mi></msub><msub><mi>m</mi><mi>i</mi></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><msub><mi mathvariant="normal">âˆ‡</mi><mi>y</mi></msub><msub><mi>m</mi><mi>i</mi></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow></msqrt></mrow><annotation encoding="application/x-tex">R(m) = \sum_i \sqrt{(\nabla_x m_i)^2 + (\nabla_y m_i)^2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.5435em;vertical-align:-1.2777em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.2658em;"><span class="svg-align" style="top:-3.8em;"><span class="pstrut" style="height:3.8em;"></span><span class="mord" style="padding-left:1em;"><span class="mopen">(</span><span class="mord"><span class="mord">âˆ‡</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mopen">(</span><span class="mord"><span class="mord">âˆ‡</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.2258em;"><span class="pstrut" style="height:3.8em;"></span><span class="hide-tail" style="min-width:1.02em;height:1.88em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.88em" viewBox="0 0 400000 1944" preserveAspectRatio="xMinYMin slice"><path d="M983 90l0 -0c4,-6.7,10,-10,18,-10 H400000v40H1013.1s-83.4,268,-264.1,840c-180.7,572,-277,876.3,-289,913c-4.7,4.7,-12.7,7,-24,7s-12,0,-12,0c-1.3,-3.3,-3.7,-11.7,-7,-25c-35.3,-125.3,-106.7,-373.3,-214,-744c-10,12,-21,25,-33,39s-32,39,-32,39c-6,-5.3,-15,-14,-27,-26s25,-30,25,-30c26.7,-32.7,52,-63,76,-91s52,-60,52,-60s208,722,208,722c56,-175.3,126.3,-397.3,211,-666c84.7,-268.7,153.8,-488.2,207.5,-658.5c53.7,-170.3,84.5,-266.8,92.5,-289.5zM1001 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.5742em;"><span></span></span></span></span></span></span></span></span></span></p><p>ä¿ç•™è¾¹ç¼˜çš„åŒæ—¶æŠ‘åˆ¶å™ªå£°ã€‚</p><p><strong>å°æ³¢ç¨€ç–</strong>ï¼š</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mo stretchy="false">(</mo><mi>m</mi><mo stretchy="false">)</mo><mo>=</mo><mi mathvariant="normal">âˆ¥</mi><mi mathvariant="normal">Î¨</mi><mi>m</mi><msub><mi mathvariant="normal">âˆ¥</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">R(m) = \|\Psi m\|_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">âˆ¥Î¨</span><span class="mord mathnormal">m</span><span class="mord"><span class="mord">âˆ¥</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p><p>åˆ©ç”¨å›¾åƒåœ¨å°æ³¢åŸŸçš„ç¨€ç–æ€§ã€‚</p><h3 id="gpu-shi-xian-tv-zheng-ze-hua" tabindex="-1" id="GPU-å®ç°-TV-æ­£åˆ™åŒ–">GPU å®ç° TV æ­£åˆ™åŒ–</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">__global__ void gradient_kernel(float *image, float *grad_x, float *grad_y,</span><br><span class="line">                                  int H, int W) &#123;</span><br><span class="line">    int x = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">    int y = blockIdx.y * blockDim.y + threadIdx.y;</span><br><span class="line">    </span><br><span class="line">    if (x &lt; W &amp;&amp; y &lt; H) &#123;</span><br><span class="line">        int idx = y * W + x;</span><br><span class="line">        </span><br><span class="line">        // å‰å‘å·®åˆ†</span><br><span class="line">        grad_x[idx] = (x &lt; W - 1) ? image[idx + 1] - image[idx] : 0;</span><br><span class="line">        grad_y[idx] = (y &lt; H - 1) ? image[idx + W] - image[idx] : 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__global__ void tv_proximal_kernel(float *grad_x, float *grad_y,</span><br><span class="line">                                     float lambda, int H, int W) &#123;</span><br><span class="line">    int x = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">    int y = blockIdx.y * blockDim.y + threadIdx.y;</span><br><span class="line">    </span><br><span class="line">    if (x &lt; W &amp;&amp; y &lt; H) &#123;</span><br><span class="line">        int idx = y * W + x;</span><br><span class="line">        </span><br><span class="line">        float gx = grad_x[idx];</span><br><span class="line">        float gy = grad_y[idx];</span><br><span class="line">        float norm = sqrtf(gx * gx + gy * gy) + 1e-8f;</span><br><span class="line">        </span><br><span class="line">        // è½¯é˜ˆå€¼</span><br><span class="line">        float shrink = fmaxf(1.0f - lambda / norm, 0.0f);</span><br><span class="line">        grad_x[idx] = gx * shrink;</span><br><span class="line">        grad_y[idx] = gy * shrink;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="duo-xian-quan-cheng-xiang" tabindex="-1" id="å¤šçº¿åœˆæˆåƒ">å¤šçº¿åœˆæˆåƒ</h2><h3 id="bing-xing-cheng-xiang" tabindex="-1" id="å¹¶è¡Œæˆåƒ">å¹¶è¡Œæˆåƒ</h3><p>ç°ä»£ MRI ä½¿ç”¨<strong>å¤šæ¥æ”¶çº¿åœˆ</strong>ï¼Œæ¯ä¸ªçº¿åœˆæœ‰ä¸åŒçš„çµæ•åº¦åˆ†å¸ƒï¼š</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>s</mi><mi>c</mi></msub><mo stretchy="false">(</mo><mi>k</mi><mo stretchy="false">)</mo><mo>=</mo><mo>âˆ«</mo><msub><mi>S</mi><mi>c</mi></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>â‹…</mo><mi>m</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>â‹…</mo><msup><mi>e</mi><mrow><mo>âˆ’</mo><mi>i</mi><mn>2</mn><mi>Ï€</mi><mi>k</mi><mo>â‹…</mo><mi>x</mi></mrow></msup><mi>d</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">s_c(k) = \int S_c(x) \cdot m(x) \cdot e^{-i2\pi k \cdot x} dx</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.2222em;vertical-align:-0.8622em;"></span><span class="mop op-symbol large-op" style="margin-right:0.44445em;position:relative;top:-0.0011em;">âˆ«</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">m</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8991em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">âˆ’</span><span class="mord mathnormal mtight">i</span><span class="mord mtight">2</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">Ï€k</span><span class="mbin mtight">â‹…</span><span class="mord mathnormal mtight">x</span></span></span></span></span></span></span></span></span><span class="mord mathnormal">d</span><span class="mord mathnormal">x</span></span></span></span></span></p><p>å…¶ä¸­ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">S_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> æ˜¯ç¬¬ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">c</span></span></span></span> ä¸ªçº¿åœˆçš„çµæ•åº¦ã€‚</p><h3 id="sense-zhong-jian" tabindex="-1" id="SENSE-é‡å»º">SENSE é‡å»º</h3><p><strong>SENSEï¼ˆSensitivity Encodingï¼‰</strong>ï¼šåˆ©ç”¨çº¿åœˆçµæ•åº¦å·®å¼‚è§£æ··å ã€‚</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mover accent="true"><mi>m</mi><mo>^</mo></mover><mo>=</mo><mi>arg</mi><mo>â¡</mo><munder><mrow><mi>min</mi><mo>â¡</mo></mrow><mi>m</mi></munder><munder><mo>âˆ‘</mo><mi>c</mi></munder><mi mathvariant="normal">âˆ¥</mi><mi>A</mi><msub><mi>S</mi><mi>c</mi></msub><mi>m</mi><mo>âˆ’</mo><msub><mi>s</mi><mi>c</mi></msub><msubsup><mi mathvariant="normal">âˆ¥</mi><mn>2</mn><mn>2</mn></msubsup></mrow><annotation encoding="application/x-tex">\hat{m} = \arg\min_m \sum_c \|A S_c m - s_c\|_2^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">m</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">^</span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.3em;vertical-align:-1.25em;"></span><span class="mop">ar<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6679em;"><span style="top:-2.4em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">min</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.7em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.9em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.25em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">âˆ¥</span><span class="mord mathnormal">A</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.1141em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord">âˆ¥</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span></span></p><h3 id="gpu-shi-xian-1" tabindex="-1" id="GPU-å®ç°-2">GPU å®ç°</h3><p>å¤šçº¿åœˆå¢åŠ äº†è®¡ç®—é‡ï¼Œä½†ä¹Ÿå¢åŠ äº†å¹¶è¡Œåº¦ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">void sense_cg_iteration(</span><br><span class="line">    cuComplex *image,           // [H, W]</span><br><span class="line">    cuComplex **coil_data,      // [num_coils][num_samples]</span><br><span class="line">    cuComplex **sensitivity,    // [num_coils][H, W]</span><br><span class="line">    int num_coils) &#123;</span><br><span class="line">    </span><br><span class="line">    // å¹¶è¡Œå¤„ç†æ¯ä¸ªçº¿åœˆ</span><br><span class="line">    for (int c = 0; c &lt; num_coils; c++) &#123;</span><br><span class="line">        // åº”ç”¨çµæ•åº¦</span><br><span class="line">        elementwise_multiply(image, sensitivity[c], coil_image, H * W);</span><br><span class="line">        </span><br><span class="line">        // NUFFT</span><br><span class="line">        nufft_forward(coil_image, coil_kspace, trajectory);</span><br><span class="line">        </span><br><span class="line">        // ç´¯åŠ </span><br><span class="line">        vector_add(residual, coil_residual, residual, num_samples);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çº¿åœˆé—´<strong>å®Œå…¨ç‹¬ç«‹</strong>ï¼Œé€‚åˆ GPU å¹¶è¡Œã€‚</p><h2 id="ya-suo-gan-zhi-mri" tabindex="-1" id="å‹ç¼©æ„ŸçŸ¥-MRI">å‹ç¼©æ„ŸçŸ¥ MRI</h2><h3 id="ji-ben-yuan-li" tabindex="-1" id="åŸºæœ¬åŸç†">åŸºæœ¬åŸç†</h3><p><strong>å‹ç¼©æ„ŸçŸ¥ï¼ˆCompressed Sensingï¼‰</strong>ï¼šå¦‚æœä¿¡å·åœ¨æŸä¸ªåŸŸæ˜¯ç¨€ç–çš„ï¼Œå¯ä»¥ç”¨è¿œå°‘äºå¥ˆå¥æ–¯ç‰¹é‡‡æ ·æ•°çš„æµ‹é‡é‡å»ºã€‚</p><p><strong>MRI ä¸­çš„ç¨€ç–æ€§</strong>ï¼š</p><ul><li>å›¾åƒåœ¨å°æ³¢åŸŸç¨€ç–</li><li>å›¾åƒæ¢¯åº¦ç¨€ç–ï¼ˆåˆ†æ®µå¹³æ»‘ï¼‰</li></ul><h3 id="cs-mri-you-hua-wen-ti" tabindex="-1" id="CS-MRI-ä¼˜åŒ–é—®é¢˜">CS-MRI ä¼˜åŒ–é—®é¢˜</h3><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mover accent="true"><mi>m</mi><mo>^</mo></mover><mo>=</mo><mi>arg</mi><mo>â¡</mo><munder><mrow><mi>min</mi><mo>â¡</mo></mrow><mi>m</mi></munder><mfrac><mn>1</mn><mn>2</mn></mfrac><mi mathvariant="normal">âˆ¥</mi><mi>A</mi><mi>m</mi><mo>âˆ’</mo><mi>s</mi><msubsup><mi mathvariant="normal">âˆ¥</mi><mn>2</mn><mn>2</mn></msubsup><mo>+</mo><msub><mi>Î»</mi><mn>1</mn></msub><mi mathvariant="normal">âˆ¥</mi><mi mathvariant="normal">Î¨</mi><mi>m</mi><msub><mi mathvariant="normal">âˆ¥</mi><mn>1</mn></msub><mo>+</mo><msub><mi>Î»</mi><mn>2</mn></msub><mi>T</mi><mi>V</mi><mo stretchy="false">(</mo><mi>m</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\hat{m} = \arg\min_m \frac{1}{2}\|Am - s\|_2^2 + \lambda_1 \|\Psi m\|_1 + \lambda_2 TV(m)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">m</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">^</span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0214em;vertical-align:-0.7em;"></span><span class="mop">ar<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6679em;"><span style="top:-2.4em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">min</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.7em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord">âˆ¥</span><span class="mord mathnormal">A</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.1141em;vertical-align:-0.25em;"></span><span class="mord mathnormal">s</span><span class="mord"><span class="mord">âˆ¥</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">Î»</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">âˆ¥Î¨</span><span class="mord mathnormal">m</span><span class="mord"><span class="mord">âˆ¥</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">Î»</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mclose">)</span></span></span></span></span></p><h3 id="admm-qiu-jie" tabindex="-1" id="ADMM-æ±‚è§£">ADMM æ±‚è§£</h3><p>**äº¤æ›¿æ–¹å‘ä¹˜å­æ³•ï¼ˆADMMï¼‰**å°†é—®é¢˜åˆ†è§£ä¸ºå­é—®é¢˜ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. æ•°æ®ä¿çœŸåº¦å­é—®é¢˜ï¼ˆCG æ±‚è§£ï¼‰</span><br><span class="line">2. å°æ³¢ç¨€ç–å­é—®é¢˜ï¼ˆè½¯é˜ˆå€¼ï¼‰</span><br><span class="line">3. TV å­é—®é¢˜ï¼ˆTV å»å™ªï¼‰</span><br><span class="line">4. æ›´æ–°æ‹‰æ ¼æœ—æ—¥ä¹˜å­</span><br></pre></td></tr></table></figure><p>æ¯ä¸ªå­é—®é¢˜éƒ½å¯ä»¥é«˜æ•ˆå¹¶è¡Œã€‚</p><h2 id="xing-neng-you-hua" tabindex="-1" id="æ€§èƒ½ä¼˜åŒ–">æ€§èƒ½ä¼˜åŒ–</h2><h3 id="nei-cun-guan-li" tabindex="-1" id="å†…å­˜ç®¡ç†">å†…å­˜ç®¡ç†</h3><p>MRI æ•°æ®é‡å¤§ï¼ˆ3Dã€å¤šçº¿åœˆã€å¤šæ—¶ç›¸ï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">4 çº¿åœˆ Ã— 256Â³ å¤æ•° = 4 Ã— 256Â³ Ã— 8 = 512 MB</span><br></pre></td></tr></table></figure><p><strong>ç­–ç•¥</strong>ï¼š</p><ul><li>æµæ°´çº¿å¤„ç†æ—¶ç›¸</li><li>å‹ç¼©å­˜å‚¨ä½ç§©æ•°æ®</li><li>ä½¿ç”¨ç»Ÿä¸€å†…å­˜è‡ªåŠ¨ç®¡ç†</li></ul><h3 id="ji-suan-you-hua" tabindex="-1" id="è®¡ç®—ä¼˜åŒ–">è®¡ç®—ä¼˜åŒ–</h3><table><thead><tr><th>æ“ä½œ</th><th>ä¼˜åŒ–ç­–ç•¥</th></tr></thead><tbody><tr><td>FFT</td><td>ä½¿ç”¨ cuFFTï¼Œæ‰¹é‡å¤„ç†</td></tr><tr><td>NUFFT</td><td>çº¹ç†ç¼“å­˜åŠ é€Ÿæ’å€¼</td></tr><tr><td>è§„çº¦</td><td>Warp Shuffle é«˜æ•ˆæ±‚å’Œ</td></tr><tr><td>TV</td><td>å…±äº«å†…å­˜å·®åˆ†æ¨¡æ¿</td></tr></tbody></table><h3 id="duo-gpu" tabindex="-1" id="å¤š-GPU">å¤š GPU</h3><p>MRI é‡å»ºå¤©ç„¶é€‚åˆå¤š GPUï¼š</p><ul><li>çº¿åœˆé—´å¹¶è¡Œ</li><li>åˆ‡ç‰‡é—´å¹¶è¡Œ</li><li>æ—¶ç›¸é—´å¹¶è¡Œ</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#pragma omp parallel for</span><br><span class="line">for (int c = 0; c &lt; num_coils; c++) &#123;</span><br><span class="line">    int device = c % num_gpus;</span><br><span class="line">    cudaSetDevice(device);</span><br><span class="line">    process_coil(c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="shi-ji-ying-yong" tabindex="-1" id="å®é™…åº”ç”¨">å®é™…åº”ç”¨</h2><h3 id="jia-su-bei-shu" tabindex="-1" id="åŠ é€Ÿå€æ•°">åŠ é€Ÿå€æ•°</h3><table><thead><tr><th>æŠ€æœ¯</th><th>åŠ é€Ÿå€æ•°</th></tr></thead><tbody><tr><td>å¹¶è¡Œæˆåƒ</td><td>2-4Ã—</td></tr><tr><td>å‹ç¼©æ„ŸçŸ¥</td><td>4-8Ã—</td></tr><tr><td>ä¸¤è€…ç»“åˆ</td><td>8-16Ã—</td></tr></tbody></table><p><strong>ä¸´åºŠæ„ä¹‰</strong>ï¼šæ‰«ææ—¶é—´ä» 10 åˆ†é’Ÿç¼©çŸ­åˆ° 1 åˆ†é’Ÿï¼Œå‡å°‘æ‚£è€…ä¸é€‚ï¼Œæé«˜é€šé‡ã€‚</p><h3 id="gpu-jia-su-xiao-guo" tabindex="-1" id="GPU-åŠ é€Ÿæ•ˆæœ">GPU åŠ é€Ÿæ•ˆæœ</h3><table><thead><tr><th>å¹³å°</th><th>256Â³ é‡å»ºæ—¶é—´</th></tr></thead><tbody><tr><td>å•æ ¸ CPU</td><td>~300 ç§’</td></tr><tr><td>å¤šæ ¸ CPU (8)</td><td>~40 ç§’</td></tr><tr><td>GPU (V100)</td><td>~2 ç§’</td></tr></tbody></table><p><strong>åŠ é€Ÿæ¯”</strong>ï¼š150Ã— ä»¥ä¸Šã€‚</p><h2 id="xiao-jie" tabindex="-1" id="å°ç»“">å°ç»“</h2><p>ç¬¬åä¸ƒç« å±•ç¤ºäº† GPU åœ¨åŒ»å­¦å½±åƒé¢†åŸŸçš„å¼ºå¤§èƒ½åŠ›ï¼š</p><p><strong>MRI é‡å»ºæœ¬è´¨</strong>ï¼šä» k ç©ºé—´æ•°æ®æ¢å¤å›¾åƒï¼Œæ¶‰åŠå‚…é‡Œå¶å˜æ¢å’Œä¼˜åŒ–é—®é¢˜ã€‚</p><p><strong>NUFFT</strong>ï¼šå¤„ç†éç¬›å¡å°”é‡‡æ ·çš„æ ¸å¿ƒç®—æ³•ã€‚GPU çš„ç½‘æ ¼åŒ–å’Œ FFT å®ç°æ¯” CPU å¿«ä¸¤ä¸ªæ•°é‡çº§ã€‚</p><p><strong>è¿­ä»£é‡å»º</strong>ï¼šå…±è½­æ¢¯åº¦ + æ­£åˆ™åŒ–è§£å†³æ¬ é‡‡æ ·é—®é¢˜ã€‚æ¯æ¬¡è¿­ä»£åŒ…å« NUFFTã€è§„çº¦ã€é€å…ƒç´ æ“ä½œâ€”â€”éƒ½æ˜¯ GPU æ“…é•¿çš„ã€‚</p><p><strong>å¤šçº¿åœˆ + å‹ç¼©æ„ŸçŸ¥</strong>ï¼šè¿›ä¸€æ­¥åŠ é€Ÿé‡‡é›†ï¼Œä½†è®¡ç®—é‡å¢åŠ ã€‚GPU çš„å¹¶è¡Œèƒ½åŠ›æ­£å¥½åº”å¯¹ã€‚</p><p><strong>ç»¼åˆåº”ç”¨</strong>ï¼šæœ¬ç« ç»¼åˆäº†å‰é¢å­¦çš„ FFTã€çŸ©é˜µè¿ç®—ã€è§„çº¦ã€è¿­ä»£æ±‚è§£ç­‰æŠ€æœ¯ï¼Œå±•ç¤ºäº†å®é™…é—®é¢˜ä¸­å¦‚ä½•ç»„åˆä½¿ç”¨è¿™äº›å·¥å…·ã€‚</p><p>MRI é‡å»ºåªæ˜¯åŒ»å­¦å½±åƒçš„å†°å±±ä¸€è§’ã€‚CT é‡å»ºã€PET é‡å»ºã€è¶…å£°æˆåƒéƒ½æœ‰ç±»ä¼¼çš„è®¡ç®—å¯†é›†å‹ä»»åŠ¡ï¼ŒGPU æ­£åœ¨æ”¹å˜æ•´ä¸ªåŒ»å­¦å½±åƒé¢†åŸŸã€‚</p><hr><p><strong>å‚è€ƒèµ„æ–™ï¼š</strong></p><ul><li>Hwu, W., Kirk, D., &amp; El Hajj, I. (2022). <em>Programming Massively Parallel Processors: A Hands-on Approach</em> (4th Edition). Morgan Kaufmann.</li><li>Lustig, M., Donoho, D., &amp; Pauly, J. M. (2007). <em>Sparse MRI: The Application of Compressed Sensing for Rapid MR Imaging</em>. MRM.</li><li>Fessler, J. A., &amp; Sutton, B. P. (2003). <em>Nonuniform Fast Fourier Transforms Using Min-Max Interpolation</em>. IEEE TSP.</li></ul><hr><blockquote><p><strong>æœ¬æ–‡ GitHub ä»“åº“</strong>: <a href="https://github.com/psmarter/PMPP-Learning">https://github.com/psmarter/PMPP-Learning</a></p></blockquote>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;qian-yan&quot; tabindex=&quot;-1&quot; id=&quot;å‰è¨€&quot;&gt;å‰è¨€&lt;/h2&gt;
&lt;p&gt;å‰é¢çš„ç« èŠ‚ä¸»è¦è®¨è®ºäº†é€šç”¨çš„å¹¶è¡Œç®—æ³•å’Œæ·±åº¦å­¦ä¹ ã€‚ç¬¬åä¸ƒç« è½¬å‘ä¸€ä¸ªå…·ä½“çš„åº”ç”¨é¢†åŸŸâ€”â€”&lt;strong&gt;åŒ»å­¦å½±åƒ&lt;/strong&gt;ï¼Œç‰¹åˆ«æ˜¯**ç£å…±æŒ¯æˆåƒï¼ˆMRIï¼‰**çš„å›¾åƒé‡å»ºã€‚MRI</summary>
        
      
    
    
    
    <category term="çŸ¥è¯†åˆ†äº«" scheme="https://smarter.xin/categories/knowledge-sharing/"/>
    
    
    <category term="CUDA" scheme="https://smarter.xin/tags/CUDA/"/>
    
    <category term="GPUç¼–ç¨‹" scheme="https://smarter.xin/tags/gpu-programming/"/>
    
    <category term="å¹¶è¡Œè®¡ç®—" scheme="https://smarter.xin/tags/parallel-computing/"/>
    
    <category term="PMPP" scheme="https://smarter.xin/tags/PMPP/"/>
    
    <category term="MRI" scheme="https://smarter.xin/tags/MRI/"/>
    
    <category term="åŒ»å­¦å½±åƒ" scheme="https://smarter.xin/tags/medical-imaging/"/>
    
    <category term="è¿­ä»£é‡å»º" scheme="https://smarter.xin/tags/iterative-reconstruction/"/>
    
  </entry>
  
  <entry>
    <title>PMPP-ç¬¬åå…­ç« ï¼šæ·±åº¦å­¦ä¹ </title>
    <link href="https://smarter.xin/posts/feaca34d/"/>
    <id>https://smarter.xin/posts/feaca34d/</id>
    <published>2026-01-19T15:07:59.000Z</published>
    <updated>2026-01-24T08:26:21.333Z</updated>
    
    <content type="html"><![CDATA[<h2 id="qian-yan" tabindex="-1" id="å‰è¨€">å‰è¨€</h2><p>å‰é¢æˆ‘ä»¬å­¦ä¹ äº†å„ç§å¹¶è¡Œç®—æ³•åŸè¯­ï¼šå½’çº¦ã€æ‰«æã€æ’åºã€ç¨€ç–çŸ©é˜µã€å›¾éå†ã€‚è¿™äº›æŠ€æœ¯åœ¨æ·±åº¦å­¦ä¹ ä¸­éƒ½æœ‰ç”¨æ­¦ä¹‹åœ°ã€‚ç¬¬åå…­ç« å°†è¿™äº›æŠ€æœ¯ä¸²è”èµ·æ¥ï¼Œå±•ç¤º GPU å¦‚ä½•åŠ é€Ÿ<strong>æ·±åº¦å­¦ä¹ </strong>â€”â€”è¿™æ˜¯å½“ä»Š GPU æœ€é‡è¦çš„åº”ç”¨ä¹‹ä¸€ã€‚æœ¬ç« ä¸ä¼šæ·±å…¥è®²è§£ç¥ç»ç½‘ç»œç†è®ºï¼Œè€Œæ˜¯èšç„¦äº<strong>è®¡ç®—è§†è§’</strong>ï¼šç¥ç»ç½‘ç»œçš„æ ¸å¿ƒæ“ä½œæ˜¯ä»€ä¹ˆï¼ŸGPU å¦‚ä½•é«˜æ•ˆå®ç°å®ƒä»¬ï¼Ÿ</p><blockquote><p><strong>ğŸ“¦ é…å¥—èµ„æº</strong>ï¼šæœ¬ç³»åˆ—æ–‡ç« é…æœ‰å®Œæ•´çš„ <a href="https://github.com/psmarter/PMPP-Learning">GitHub ä»“åº“</a>ï¼ŒåŒ…å«æ¯ç« çš„ç»ƒä¹ é¢˜è§£ç­”ã€CUDA ä»£ç å®ç°å’Œè¯¦ç»†æ³¨é‡Šã€‚æ‰€æœ‰ä»£ç éƒ½ç»è¿‡æµ‹è¯•ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œã€‚</p></blockquote><h2 id="shen-du-xue-xi-ji-chu" tabindex="-1" id="æ·±åº¦å­¦ä¹ åŸºç¡€">æ·±åº¦å­¦ä¹ åŸºç¡€</h2><h3 id="shen-jing-wang-luo-de-ji-suan-ben-zhi" tabindex="-1" id="ç¥ç»ç½‘ç»œçš„è®¡ç®—æœ¬è´¨">ç¥ç»ç½‘ç»œçš„è®¡ç®—æœ¬è´¨</h3><p>æ— è®ºæ˜¯å…¨è¿æ¥å±‚ã€å·ç§¯å±‚è¿˜æ˜¯æ³¨æ„åŠ›å±‚ï¼Œç¥ç»ç½‘ç»œçš„æ ¸å¿ƒæ“ä½œéƒ½æ˜¯ï¼š</p><ol><li><strong>çº¿æ€§å˜æ¢</strong>ï¼šçŸ©é˜µä¹˜æ³•ï¼ˆGEMMï¼‰</li><li><strong>éçº¿æ€§æ¿€æ´»</strong>ï¼šReLUã€Sigmoidã€Softmax ç­‰</li><li><strong>å½’çº¦æ“ä½œ</strong>ï¼šPoolingã€Normalization</li></ol><p><strong>è®¡ç®—é‡åˆ†å¸ƒ</strong>ï¼ˆä»¥ ResNet-50 ä¸ºä¾‹ï¼‰ï¼š</p><ul><li>å·ç§¯å±‚ï¼š~95% çš„è®¡ç®—é‡</li><li>å…¨è¿æ¥å±‚ï¼š~4%</li><li>å…¶ä»–ï¼š~1%</li></ul><p>å·ç§¯æ‰æ˜¯ GPU ä¼˜åŒ–çš„ä¸»æˆ˜åœºã€‚</p><h3 id="shen-du-xue-xi-wei-shi-yao-xu-yao-gpu" tabindex="-1" id="æ·±åº¦å­¦ä¹ ä¸ºä»€ä¹ˆéœ€è¦-GPU">æ·±åº¦å­¦ä¹ ä¸ºä»€ä¹ˆéœ€è¦ GPU</h3><table><thead><tr><th>ç‰¹æ€§</th><th>CPU</th><th>GPU</th></tr></thead><tbody><tr><td>æ ¸å¿ƒæ•°</td><td>8-64</td><td>æ•°åƒ</td></tr><tr><td>æ—¶é’Ÿé¢‘ç‡</td><td>3-5 GHz</td><td>1-2 GHz</td></tr><tr><td>å³°å€¼ç®—åŠ›(FP32)</td><td>~1 TFLOPS</td><td>~30 TFLOPS</td></tr><tr><td>å†…å­˜å¸¦å®½</td><td>~100 GB/s</td><td>~1000 GB/s</td></tr></tbody></table><p>æ·±åº¦å­¦ä¹ çš„è®¡ç®—æ˜¯<strong>é«˜åº¦å¹¶è¡Œ</strong>çš„ï¼š</p><ul><li>æ‰¹é‡å¤„ç†ï¼ˆBatchï¼‰ï¼šç‹¬ç«‹æ ·æœ¬å¹¶è¡Œ</li><li>ç©ºé—´å¹¶è¡Œï¼šå›¾åƒä¸åŒä½ç½®å¹¶è¡Œ</li><li>é€šé“å¹¶è¡Œï¼šä¸åŒç‰¹å¾å›¾å¹¶è¡Œ</li></ul><p>è¿™æ˜¯ GPU çš„ç†æƒ³åœºæ™¯ã€‚</p><h2 id="juan-ji-ceng-de-gpu-shi-xian" tabindex="-1" id="å·ç§¯å±‚çš„-GPU-å®ç°">å·ç§¯å±‚çš„ GPU å®ç°</h2><h3 id="juan-ji-de-ji-suan-fu-za-du" tabindex="-1" id="å·ç§¯çš„è®¡ç®—å¤æ‚åº¦">å·ç§¯çš„è®¡ç®—å¤æ‚åº¦</h3><p>ç»™å®šè¾“å…¥å¼ é‡ <code>[N, C_in, H, W]</code> å’Œå·ç§¯æ ¸ <code>[C_out, C_in, K, K]</code>ï¼š</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>FLOPs</mtext><mo>=</mo><mn>2</mn><mo>Ã—</mo><mi>N</mi><mo>Ã—</mo><msub><mi>C</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub><mo>Ã—</mo><msub><mi>H</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub><mo>Ã—</mo><msub><mi>W</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub><mo>Ã—</mo><msub><mi>C</mi><mrow><mi>i</mi><mi>n</mi></mrow></msub><mo>Ã—</mo><mi>K</mi><mo>Ã—</mo><mi>K</mi></mrow><annotation encoding="application/x-tex">\text{FLOPs} = 2 \times N \times C_{out} \times H_{out} \times W_{out} \times C_{in} \times K \times K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord text"><span class="mord">FLOPs</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0813em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">in</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span></span></p><p>å¯¹äº ResNet-50 çš„ç¬¬ä¸€ä¸ªå·ç§¯å±‚ï¼š</p><ul><li>è¾“å…¥ï¼š<code>[1, 3, 224, 224]</code></li><li>å·ç§¯æ ¸ï¼š<code>[64, 3, 7, 7]</code></li><li>FLOPs â‰ˆ 1.2 äº¿æ¬¡</li></ul><p>æ•´ä¸ªç½‘ç»œçº¦éœ€ 40 äº¿æ¬¡æµ®ç‚¹æ“ä½œã€‚</p><h3 id="zhi-jie-juan-ji" tabindex="-1" id="ç›´æ¥å·ç§¯">ç›´æ¥å·ç§¯</h3><p>æœ€ç›´è§‚çš„å®ç°ï¼Œç¬¬ä¸ƒç« å·²è¯¦ç»†è®²è¿‡ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">__global__ void conv2d_direct(float *input, float *kernel, float *output,</span><br><span class="line">                               int N, int C_in, int H, int W, </span><br><span class="line">                               int C_out, int K) &#123;</span><br><span class="line">    int n = blockIdx.z;</span><br><span class="line">    int c_out = blockIdx.y;</span><br><span class="line">    int h_out = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">    int w_out = blockIdx.x * blockDim.y + threadIdx.y;</span><br><span class="line">    </span><br><span class="line">    if (h_out &lt; H_out &amp;&amp; w_out &lt; W_out) &#123;</span><br><span class="line">        float sum = 0.0f;</span><br><span class="line">        for (int c_in = 0; c_in &lt; C_in; c_in++) &#123;</span><br><span class="line">            for (int kh = 0; kh &lt; K; kh++) &#123;</span><br><span class="line">                for (int kw = 0; kw &lt; K; kw++) &#123;</span><br><span class="line">                    int h_in = h_out + kh - K/2;</span><br><span class="line">                    int w_in = w_out + kw - K/2;</span><br><span class="line">                    if (h_in &gt;= 0 &amp;&amp; h_in &lt; H &amp;&amp; w_in &gt;= 0 &amp;&amp; w_in &lt; W) &#123;</span><br><span class="line">                        sum += input[...] * kernel[...];</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        output[...] = sum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>é—®é¢˜</strong>ï¼šå¾ªç¯å¤ªå¤šï¼Œå†…å­˜è®¿é—®ä¸è§„åˆ™ï¼Œæ•ˆç‡ä½ã€‚</p><h3 id="im-2-col-gemm" tabindex="-1" id="Im2col-GEMM">Im2col + GEMM</h3><p><strong>æ ¸å¿ƒæ€æƒ³</strong>ï¼šæŠŠå·ç§¯è½¬åŒ–ä¸ºçŸ©é˜µä¹˜æ³•ã€‚</p><p><strong>Im2col</strong>ï¼šæŠŠè¾“å…¥çš„æ¯ä¸ªæ»‘åŠ¨çª—å£å±•å¼€æˆä¸€åˆ—ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥å›¾åƒ [C_in, H, W]ï¼Œå·ç§¯æ ¸ [K, K]</span><br><span class="line"></span><br><span class="line">Im2col åï¼š</span><br><span class="line">  åˆ—æ•° = H_out Ã— W_out</span><br><span class="line">  è¡Œæ•° = C_in Ã— K Ã— K</span><br><span class="line"></span><br><span class="line">æ¯ä¸€åˆ—å¯¹åº”ä¸€ä¸ªæ»‘åŠ¨çª—å£çš„å±•å¼€</span><br></pre></td></tr></table></figure><p><strong>è½¬æ¢å</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">è¾“å‡º = Kernel Ã— Im2col(Input)</span><br><span class="line">[C_out, H_outÃ—W_out] = [C_out, C_inÃ—KÃ—K] Ã— [C_inÃ—KÃ—K, H_outÃ—W_out]</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯æ ‡å‡†çš„ GEMMï¼å¯ä»¥è°ƒç”¨é«˜åº¦ä¼˜åŒ–çš„ cuBLASã€‚</p><p><strong>ä»£ä»·</strong>ï¼šIm2col éœ€è¦é¢å¤–å†…å­˜ï¼Œçº¦ä¸ºåŸè¾“å…¥çš„ KÂ² å€ã€‚</p><h3 id="winograd-juan-ji" tabindex="-1" id="Winograd-å·ç§¯">Winograd å·ç§¯</h3><p><strong>æ ¸å¿ƒæ€æƒ³</strong>ï¼šç”¨æ›´å¤šåŠ æ³•æ¢æ›´å°‘ä¹˜æ³•ã€‚</p><p>å¯¹äº 3Ã—3 å·ç§¯ï¼ŒWinograd F(2Ã—2, 3Ã—3) å¯ä»¥æŠŠä¹˜æ³•æ¬¡æ•°ä» 36 å‡å°‘åˆ° 16ã€‚</p><p><strong>å…¬å¼</strong>ï¼š</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>Y</mi><mo>=</mo><msup><mi>A</mi><mi>T</mi></msup><mrow><mo fence="true">[</mo><mo stretchy="false">(</mo><mi>G</mi><mo>â‹…</mo><mi>g</mi><mo>â‹…</mo><msup><mi>G</mi><mi>T</mi></msup><mo stretchy="false">)</mo><mo>âŠ™</mo><mo stretchy="false">(</mo><msup><mi>B</mi><mi>T</mi></msup><mo>â‹…</mo><mi>d</mi><mo>â‹…</mo><mi>B</mi><mo stretchy="false">)</mo><mo fence="true">]</mo></mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">Y = A^T \left[ (G \cdot g \cdot G^T) \odot (B^T \cdot d \cdot B) \right] A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2413em;vertical-align:-0.35em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">[</span></span><span class="mopen">(</span><span class="mord mathnormal">G</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âŠ™</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mclose">)</span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">]</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">A</span></span></span></span></span></p><p>å…¶ä¸­ï¼š</p><ul><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi></mrow><annotation encoding="application/x-tex">g</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span></span></span></span>ï¼šå·ç§¯æ ¸</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span></span></span></span>ï¼šè¾“å…¥ Tile</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi><mo separator="true">,</mo><mi>B</mi><mo separator="true">,</mo><mi>A</mi></mrow><annotation encoding="application/x-tex">G, B, A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">G</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">A</span></span></span></span>ï¼šå˜æ¢çŸ©é˜µ</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>âŠ™</mo></mrow><annotation encoding="application/x-tex">\odot</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord">âŠ™</span></span></span></span>ï¼šé€å…ƒç´ ä¹˜æ³•</li></ul><p><strong>ä¼˜åŠ¿</strong>ï¼šè®¡ç®—é‡å‡å°‘ 2.25 å€ï¼ˆç†è®ºä¸Šï¼‰ã€‚</p><p><strong>é™åˆ¶</strong>ï¼š</p><ul><li>åªé€‚åˆå°å·ç§¯æ ¸ï¼ˆ3Ã—3 æœ€å¸¸ç”¨ï¼‰</li><li>æ•°å€¼ç¨³å®šæ€§é—®é¢˜</li><li>å®ç°å¤æ‚</li></ul><h3 id="fft-juan-ji" tabindex="-1" id="FFT-å·ç§¯">FFT å·ç§¯</h3><p><strong>æ ¸å¿ƒæ€æƒ³</strong>ï¼šå·ç§¯å®šç†â€”â€”æ—¶åŸŸå·ç§¯ = é¢‘åŸŸé€å…ƒç´ ä¹˜æ³•ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Output = IFFT(FFT(Input) âŠ™ FFT(Kernel))</span><br></pre></td></tr></table></figure><p><strong>å¤æ‚åº¦</strong>ï¼šO(NÂ² log N) vs ç›´æ¥å·ç§¯çš„ O(NÂ² KÂ²)</p><p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šå¤§å·ç§¯æ ¸ï¼ˆK &gt; 7ï¼‰ã€‚æ·±åº¦å­¦ä¹ ä¸­å·ç§¯æ ¸é€šå¸¸å¾ˆå°ï¼ˆ1Ã—1, 3Ã—3ï¼‰ï¼Œæ‰€ä»¥ FFT å·ç§¯è¾ƒå°‘ä½¿ç”¨ã€‚</p><h3 id="cu-dnn-ce-lue-xuan-ze" tabindex="-1" id="cuDNN-ç­–ç•¥é€‰æ‹©">cuDNN ç­–ç•¥é€‰æ‹©</h3><p>cuDNN å†…ç½®å¤šç§å·ç§¯ç®—æ³•ï¼Œä¼šæ ¹æ®é—®é¢˜è§„æ¨¡è‡ªåŠ¨é€‰æ‹©ï¼š</p><table><thead><tr><th>ç®—æ³•</th><th>é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td>IMPLICIT_GEMM</td><td>é€šç”¨</td></tr><tr><td>IMPLICIT_PRECOMP_GEMM</td><td>å¤§ Batch</td></tr><tr><td>GEMM</td><td>å°å·ç§¯æ ¸</td></tr><tr><td>WINOGRAD</td><td>3Ã—3 å·ç§¯</td></tr><tr><td>FFT</td><td>å¤§å·ç§¯æ ¸</td></tr></tbody></table><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cudnnConvolutionFwdAlgoPerf_t perfResults[8];</span><br><span class="line">cudnnFindConvolutionForwardAlgorithm(</span><br><span class="line">    handle, inputDesc, filterDesc, convDesc, outputDesc,</span><br><span class="line">    8, &amp;returnedAlgoCount, perfResults);</span><br><span class="line"></span><br><span class="line">// é€‰æ‹©æœ€å¿«çš„ç®—æ³•</span><br><span class="line">cudnnConvolutionFwdAlgo_t algo = perfResults[0].algo;</span><br></pre></td></tr></table></figure><h2 id="quan-lian-jie-ceng" tabindex="-1" id="å…¨è¿æ¥å±‚">å…¨è¿æ¥å±‚</h2><h3 id="ben-zhi-ju-zhen-cheng-fa" tabindex="-1" id="æœ¬è´¨ï¼šçŸ©é˜µä¹˜æ³•">æœ¬è´¨ï¼šçŸ©é˜µä¹˜æ³•</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">y = W Ã— x + b</span><br><span class="line">[out_features] = [out_features, in_features] Ã— [in_features] + [out_features]</span><br></pre></td></tr></table></figure><p>æ‰¹é‡å¤„ç†ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Y = X Ã— W^T + B</span><br><span class="line">[batch, out] = [batch, in] Ã— [in, out] + [batch, out]</span><br></pre></td></tr></table></figure><p>ç›´æ¥è°ƒç”¨ cuBLAS GEMM å³å¯ã€‚</p><h3 id="you-hua-tensor-core" tabindex="-1" id="ä¼˜åŒ–ï¼šTensor-Core">ä¼˜åŒ–ï¼šTensor Core</h3><p>ä» Volta æ¶æ„å¼€å§‹ï¼ŒGPU æœ‰ä¸“é—¨çš„ Tensor Coreï¼š</p><table><thead><tr><th>æ“ä½œ</th><th>CUDA Core</th><th>Tensor Core</th></tr></thead><tbody><tr><td>4Ã—4 çŸ©é˜µä¹˜åŠ </td><td>128 FLOPs</td><td>1 å‘¨æœŸ</td></tr><tr><td>ç²¾åº¦</td><td>FP32</td><td>FP16/BF16</td></tr><tr><td>å³°å€¼ç®—åŠ›(A100)</td><td>19 TFLOPS</td><td>312 TFLOPS</td></tr></tbody></table><p>ä½¿ç”¨ Tensor Core éœ€è¦ï¼š</p><ol><li>æ•°æ®ç±»å‹ä¸º FP16 æˆ– BF16</li><li>çŸ©é˜µç»´åº¦æ˜¯ 8 æˆ– 16 çš„å€æ•°</li><li>ä½¿ç”¨ cuBLAS æˆ– WMMA API</li></ol><h2 id="ji-huo-han-shu" tabindex="-1" id="æ¿€æ´»å‡½æ•°">æ¿€æ´»å‡½æ•°</h2><h3 id="re-lu" tabindex="-1" id="ReLU">ReLU</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__global__ void relu(float *x, int n) &#123;</span><br><span class="line">    int i = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">    if (i &lt; n) &#123;</span><br><span class="line">        x[i] = max(x[i], 0.0f);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è®¡ç®—ç®€å•ï¼Œå±äº <strong>Memory-Bound</strong>ï¼šè®¿å­˜æ—¶é—´è¿œå¤§äºè®¡ç®—æ—¶é—´ã€‚</p><p><strong>Fusion ä¼˜åŒ–</strong>ï¼šæŠŠ ReLU èåˆåˆ°å·ç§¯ Kernel ä¸­ï¼Œé¿å…é¢å¤–çš„å†…å­˜è¯»å†™ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// å·ç§¯ç»“æœç›´æ¥åº”ç”¨ ReLU</span><br><span class="line">output[idx] = max(conv_result, 0.0f);</span><br></pre></td></tr></table></figure><h3 id="softmax" tabindex="-1" id="Softmax">Softmax</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">// æ•°å€¼ç¨³å®šç‰ˆæœ¬</span><br><span class="line">__global__ void softmax(float *x, float *y, int n) &#123;</span><br><span class="line">    // 1. æ‰¾æœ€å¤§å€¼ï¼ˆè§„çº¦ï¼‰</span><br><span class="line">    float max_val = reduce_max(x, n);</span><br><span class="line">    </span><br><span class="line">    // 2. exp(x - max) å¹¶æ±‚å’Œï¼ˆè§„çº¦ï¼‰</span><br><span class="line">    float sum = 0;</span><br><span class="line">    for (int i = threadIdx.x; i &lt; n; i += blockDim.x) &#123;</span><br><span class="line">        sum += expf(x[i] - max_val);</span><br><span class="line">    &#125;</span><br><span class="line">    sum = reduce_sum(sum);</span><br><span class="line">    </span><br><span class="line">    // 3. å½’ä¸€åŒ–</span><br><span class="line">    for (int i = threadIdx.x; i &lt; n; i += blockDim.x) &#123;</span><br><span class="line">        y[i] = expf(x[i] - max_val) / sum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éœ€è¦ä¸¤æ¬¡å½’çº¦ï¼Œä¸‰æ¬¡éå†æ•°æ®ã€‚</p><h2 id="pooling-ceng" tabindex="-1" id="Pooling-å±‚">Pooling å±‚</h2><h3 id="max-pooling" tabindex="-1" id="Max-Pooling">Max Pooling</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">__global__ void max_pool2d(float *input, float *output,</span><br><span class="line">                            int H, int W, int pool_size, int stride) &#123;</span><br><span class="line">    int h_out = blockIdx.y * blockDim.y + threadIdx.y;</span><br><span class="line">    int w_out = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">    </span><br><span class="line">    float max_val = -FLT_MAX;</span><br><span class="line">    for (int ph = 0; ph &lt; pool_size; ph++) &#123;</span><br><span class="line">        for (int pw = 0; pw &lt; pool_size; pw++) &#123;</span><br><span class="line">            int h_in = h_out * stride + ph;</span><br><span class="line">            int w_in = w_out * stride + pw;</span><br><span class="line">            max_val = max(max_val, input[h_in * W + w_in]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    output[h_out * W_out + w_out] = max_val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç±»ä¼¼äºå·ç§¯ï¼Œä½†ç”¨ max æ›¿ä»£åŠ æƒå’Œã€‚</p><h3 id="global-average-pooling" tabindex="-1" id="Global-Average-Pooling">Global Average Pooling</h3><p>å¯¹æ•´ä¸ªç‰¹å¾å›¾æ±‚å¹³å‡ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// å°±æ˜¯ä¸€ä¸ª 2D å½’çº¦ï¼</span><br><span class="line">float sum = reduce_2d(feature_map, H, W);</span><br><span class="line">output = sum / (H * W);</span><br></pre></td></tr></table></figure><p>ç¬¬åç« çš„å½’çº¦æŠ€æœ¯ç›´æ¥é€‚ç”¨ã€‚</p><h2 id="batch-normalization" tabindex="-1" id="Batch-Normalization">Batch Normalization</h2><h3 id="ji-suan-guo-cheng" tabindex="-1" id="è®¡ç®—è¿‡ç¨‹">è®¡ç®—è¿‡ç¨‹</h3><ol><li><strong>è®¡ç®—å‡å€¼</strong>ï¼š<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Î¼</mi><mo>=</mo><mfrac><mn>1</mn><mi>m</mi></mfrac><mo>âˆ‘</mo><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\mu = \frac{1}{m} \sum x_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Î¼</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1901em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-symbol small-op" style="position:relative;top:0em;">âˆ‘</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>ï¼ˆå½’çº¦ï¼‰</li><li><strong>è®¡ç®—æ–¹å·®</strong>ï¼š<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>Ïƒ</mi><mn>2</mn></msup><mo>=</mo><mfrac><mn>1</mn><mi>m</mi></mfrac><mo>âˆ‘</mo><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo>âˆ’</mo><mi>Î¼</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\sigma^2 = \frac{1}{m} \sum (x_i - \mu)^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1901em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-symbol small-op" style="position:relative;top:0em;">âˆ‘</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord mathnormal">Î¼</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span>ï¼ˆå½’çº¦ï¼‰</li><li><strong>å½’ä¸€åŒ–</strong>ï¼š<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>x</mi><mo>^</mo></mover><mo>=</mo><mfrac><mrow><mi>x</mi><mo>âˆ’</mo><mi>Î¼</mi></mrow><msqrt><mrow><msup><mi>Ïƒ</mi><mn>2</mn></msup><mo>+</mo><mi>Ïµ</mi></mrow></msqrt></mfrac></mrow><annotation encoding="application/x-tex">\hat{x} = \frac{x - \mu}{\sqrt{\sigma^2 + \epsilon}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">x</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.3924em;vertical-align:-0.538em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8544em;"><span style="top:-2.5445em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord sqrt mtight"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9221em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mtight" style="padding-left:0.833em;"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">Ïƒ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7463em;"><span style="top:-2.786em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mbin mtight">+</span><span class="mord mathnormal mtight">Ïµ</span></span></span><span style="top:-2.8821em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail mtight" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429c69,-144,104.5,-217.7,106.5,-221l0 -0c5.3,-9.3,12,-14,20,-14H400000v40H845.2724s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47zM834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1179em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.4461em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="mbin mtight">âˆ’</span><span class="mord mathnormal mtight">Î¼</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.538em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>ï¼ˆé€å…ƒç´ ï¼‰</li><li><strong>ç¼©æ”¾å¹³ç§»</strong>ï¼š<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>=</mo><mi>Î³</mi><mover accent="true"><mi>x</mi><mo>^</mo></mover><mo>+</mo><mi>Î²</mi></mrow><annotation encoding="application/x-tex">y = \gamma \hat{x} + \beta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">Î³</span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">x</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05278em;">Î²</span></span></span></span>ï¼ˆé€å…ƒç´ ï¼‰</li></ol><h3 id="gpu-shi-xian-yao-dian" tabindex="-1" id="GPU-å®ç°è¦ç‚¹">GPU å®ç°è¦ç‚¹</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">__global__ void batch_norm(float *x, float *y, </span><br><span class="line">                           float *gamma, float *beta,</span><br><span class="line">                           int N, int C, int H, int W) &#123;</span><br><span class="line">    int c = blockIdx.x;  // æ¯ä¸ª Block å¤„ç†ä¸€ä¸ªé€šé“</span><br><span class="line">    </span><br><span class="line">    // 1. è®¡ç®—è¯¥é€šé“çš„å‡å€¼å’Œæ–¹å·®</span><br><span class="line">    float mean = compute_mean(x, c, N, H, W);</span><br><span class="line">    float var = compute_var(x, c, mean, N, H, W);</span><br><span class="line">    </span><br><span class="line">    __syncthreads();</span><br><span class="line">    </span><br><span class="line">    // 2. å½’ä¸€åŒ–å¹¶ç¼©æ”¾</span><br><span class="line">    for (int i = threadIdx.x; i &lt; N * H * W; i += blockDim.x) &#123;</span><br><span class="line">        float val = x[index(i, c)];</span><br><span class="line">        y[index(i, c)] = gamma[c] * (val - mean) / sqrtf(var + 1e-5f) + beta[c];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…³é”®æ˜¯<strong>æŒ‰é€šé“å½’çº¦</strong>ï¼Œæ¯ä¸ªé€šé“ç‹¬ç«‹å¤„ç†ã€‚</p><h2 id="fan-xiang-chuan-bo" tabindex="-1" id="åå‘ä¼ æ’­">åå‘ä¼ æ’­</h2><h3 id="ji-suan-tu-yu-zi-dong-wei-fen" tabindex="-1" id="è®¡ç®—å›¾ä¸è‡ªåŠ¨å¾®åˆ†">è®¡ç®—å›¾ä¸è‡ªåŠ¨å¾®åˆ†</h3><p>æ·±åº¦å­¦ä¹ æ¡†æ¶ï¼ˆPyTorchã€TensorFlowï¼‰é€šè¿‡<strong>è®¡ç®—å›¾</strong>è¿½è¸ªæ“ä½œï¼Œè‡ªåŠ¨è®¡ç®—æ¢¯åº¦ã€‚</p><p><strong>å‰å‘ä¼ æ’­</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">x â†’ Conv â†’ ReLU â†’ Pool â†’ FC â†’ Softmax â†’ Loss</span><br></pre></td></tr></table></figure><p><strong>åå‘ä¼ æ’­</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dLoss/dL â† dL/dFC â† dFC/dPool â† dPool/dReLU â† dReLU/dConv â† dConv/dx</span><br></pre></td></tr></table></figure><p>æ¯ä¸ªæ“ä½œéƒ½æœ‰å¯¹åº”çš„æ¢¯åº¦è®¡ç®— Kernelã€‚</p><h3 id="juan-ji-de-fan-xiang-chuan-bo" tabindex="-1" id="å·ç§¯çš„åå‘ä¼ æ’­">å·ç§¯çš„åå‘ä¼ æ’­</h3><p>å·ç§¯çš„æ¢¯åº¦è®¡ç®—ä¹Ÿæ˜¯å·ç§¯ï¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># å¯¹è¾“å…¥çš„æ¢¯åº¦</span><br><span class="line">dL/dInput = Convolution(dL/dOutput, Kernel^T)</span><br><span class="line"></span><br><span class="line"># å¯¹æƒé‡çš„æ¢¯åº¦</span><br><span class="line">dL/dKernel = Convolution(Input, dL/dOutput)</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥å·ç§¯çš„ä¼˜åŒ–åŒæ ·é€‚ç”¨äºåå‘ä¼ æ’­ã€‚</p><h2 id="cu-dnn-jie-kou" tabindex="-1" id="cuDNN-æ¥å£">cuDNN æ¥å£</h2><h3 id="ji-ben-shi-yong" tabindex="-1" id="åŸºæœ¬ä½¿ç”¨">åŸºæœ¬ä½¿ç”¨</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;cudnn.h&gt;</span><br><span class="line"></span><br><span class="line">// 1. åˆ›å»ºå¥æŸ„</span><br><span class="line">cudnnHandle_t handle;</span><br><span class="line">cudnnCreate(&amp;handle);</span><br><span class="line"></span><br><span class="line">// 2. åˆ›å»ºå¼ é‡æè¿°ç¬¦</span><br><span class="line">cudnnTensorDescriptor_t inputDesc, outputDesc;</span><br><span class="line">cudnnCreateTensorDescriptor(&amp;inputDesc);</span><br><span class="line">cudnnSetTensor4dDescriptor(inputDesc, CUDNN_TENSOR_NCHW, CUDNN_DATA_FLOAT,</span><br><span class="line">                           N, C, H, W);</span><br><span class="line"></span><br><span class="line">// 3. åˆ›å»ºå·ç§¯æè¿°ç¬¦</span><br><span class="line">cudnnConvolutionDescriptor_t convDesc;</span><br><span class="line">cudnnCreateConvolutionDescriptor(&amp;convDesc);</span><br><span class="line">cudnnSetConvolution2dDescriptor(convDesc, pad, pad, stride, stride, 1, 1,</span><br><span class="line">                                 CUDNN_CROSS_CORRELATION, CUDNN_DATA_FLOAT);</span><br><span class="line"></span><br><span class="line">// 4. æŸ¥è¯¢å·¥ä½œç©ºé—´å¤§å°</span><br><span class="line">size_t workspaceSize;</span><br><span class="line">cudnnGetConvolutionForwardWorkspaceSize(handle, inputDesc, filterDesc,</span><br><span class="line">                                         convDesc, outputDesc, algo, &amp;workspaceSize);</span><br><span class="line"></span><br><span class="line">// 5. åˆ†é…å·¥ä½œç©ºé—´å¹¶æ‰§è¡Œ</span><br><span class="line">void *workspace;</span><br><span class="line">cudaMalloc(&amp;workspace, workspaceSize);</span><br><span class="line"></span><br><span class="line">float alpha = 1.0f, beta = 0.0f;</span><br><span class="line">cudnnConvolutionForward(handle, &amp;alpha, inputDesc, input,</span><br><span class="line">                        filterDesc, filter, convDesc, algo,</span><br><span class="line">                        workspace, workspaceSize,</span><br><span class="line">                        &amp;beta, outputDesc, output);</span><br></pre></td></tr></table></figure><h3 id="chang-yong-cao-zuo" tabindex="-1" id="å¸¸ç”¨æ“ä½œ">å¸¸ç”¨æ“ä½œ</h3><table><thead><tr><th>æ“ä½œ</th><th>å‡½æ•°</th></tr></thead><tbody><tr><td>å·ç§¯å‰å‘</td><td>cudnnConvolutionForward</td></tr><tr><td>å·ç§¯åå‘ï¼ˆæ•°æ®ï¼‰</td><td>cudnnConvolutionBackwardData</td></tr><tr><td>å·ç§¯åå‘ï¼ˆæƒé‡ï¼‰</td><td>cudnnConvolutionBackwardFilter</td></tr><tr><td>æ± åŒ–</td><td>cudnnPoolingForward/Backward</td></tr><tr><td>æ¿€æ´»</td><td>cudnnActivationForward/Backward</td></tr><tr><td>BatchNorm</td><td>cudnnBatchNormForward/Backward</td></tr><tr><td>Softmax</td><td>cudnnSoftmaxForward/Backward</td></tr></tbody></table><h2 id="hun-he-jing-du-xun-lian" tabindex="-1" id="æ··åˆç²¾åº¦è®­ç»ƒ">æ··åˆç²¾åº¦è®­ç»ƒ</h2><h3 id="fp-16-de-you-shi" tabindex="-1" id="FP16-çš„ä¼˜åŠ¿">FP16 çš„ä¼˜åŠ¿</h3><table><thead><tr><th>ç²¾åº¦</th><th>å­˜å‚¨</th><th>å¸¦å®½</th><th>ç®—åŠ›(A100)</th></tr></thead><tbody><tr><td>FP32</td><td>4 å­—èŠ‚</td><td>1Ã—</td><td>19 TFLOPS</td></tr><tr><td>FP16</td><td>2 å­—èŠ‚</td><td>2Ã—</td><td>312 TFLOPS</td></tr></tbody></table><h3 id="zi-dong-hun-he-jing-du-amp" tabindex="-1" id="è‡ªåŠ¨æ··åˆç²¾åº¦ï¼ˆAMPï¼‰">è‡ªåŠ¨æ··åˆç²¾åº¦ï¼ˆAMPï¼‰</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># PyTorch ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">from</span> torch.cuda.amp <span class="keyword">import</span> autocast, GradScaler</span><br><span class="line"></span><br><span class="line">scaler = GradScaler()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> data, target <span class="keyword">in</span> dataloader:</span><br><span class="line">    optimizer.zero_grad()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">with</span> autocast():  <span class="comment"># è‡ªåŠ¨è½¬æ¢åˆ° FP16</span></span><br><span class="line">        output = model(data)</span><br><span class="line">        loss = criterion(output, target)</span><br><span class="line">    </span><br><span class="line">    scaler.scale(loss).backward()  <span class="comment"># æ¢¯åº¦ç¼©æ”¾</span></span><br><span class="line">    scaler.step(optimizer)</span><br><span class="line">    scaler.update()</span><br></pre></td></tr></table></figure><p><strong>Loss Scaling</strong>ï¼šé˜²æ­¢ FP16 æ¢¯åº¦ä¸‹æº¢ï¼Œå…ˆæ”¾å¤§ Lossï¼Œè®¡ç®—å®Œæ¢¯åº¦åç¼©å°ã€‚</p><h2 id="xiao-jie" tabindex="-1" id="å°ç»“">å°ç»“</h2><p>ç¬¬åå…­ç« å±•ç¤ºäº†æ·±åº¦å­¦ä¹ ä¸ GPU å¹¶è¡Œè®¡ç®—çš„ç´§å¯†è”ç³»ï¼š</p><p><strong>æ ¸å¿ƒæ“ä½œ</strong>ï¼šæ·±åº¦å­¦ä¹ çš„è®¡ç®—æœ¬è´¨æ˜¯çŸ©é˜µä¹˜æ³•ï¼ˆGEMMï¼‰å’Œå·ç§¯ã€‚è¿™ä¸¤ä¸ªæ“ä½œå æ®äº† 95% ä»¥ä¸Šçš„è®¡ç®—é‡ã€‚</p><p><strong>å·ç§¯å®ç°</strong>ï¼šç›´æ¥å·ç§¯ç®€å•ä½†ä½æ•ˆï¼›Im2col + GEMM è½¬åŒ–ä¸ºçŸ©é˜µä¹˜æ³•ï¼›Winograd å‡å°‘ä¹˜æ³•æ¬¡æ•°ï¼›cuDNN è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜ç­–ç•¥ã€‚</p><p><strong>èåˆä¼˜åŒ–</strong>ï¼šæŠŠå¤šä¸ªæ“ä½œèåˆåˆ°ä¸€ä¸ª Kernel ä¸­ï¼Œå‡å°‘å†…å­˜è®¿é—®ã€‚ReLUã€BatchNorm ç­‰å¸¸ä¸å·ç§¯èåˆã€‚</p><p><strong>Tensor Core</strong>ï¼šä¸“ç”¨ç¡¬ä»¶åŠ é€ŸçŸ©é˜µè¿ç®—ï¼ŒFP16 å³°å€¼ç®—åŠ›æ˜¯ FP32 çš„ 16 å€ã€‚æ··åˆç²¾åº¦è®­ç»ƒå·²æˆä¸ºæ ‡å‡†åšæ³•ã€‚</p><p><strong>cuDNN</strong>ï¼šå°è£…äº†æ‰€æœ‰ä¼˜åŒ–ï¼Œæ˜¯æ·±åº¦å­¦ä¹ æ¡†æ¶çš„åº•å±‚ä¾èµ–ã€‚ç†è§£å…¶åŸç†æœ‰åŠ©äºè°ƒä¼˜å’Œè°ƒè¯•ã€‚</p><p>æ·±åº¦å­¦ä¹ æ˜¯ GPU è®¡ç®—çš„&quot;æ€æ‰‹çº§åº”ç”¨&quot;ï¼Œæ­£æ˜¯è¿™ä¸€éœ€æ±‚æ¨åŠ¨äº† GPU ç¡¬ä»¶å’Œè½¯ä»¶çš„é£é€Ÿå‘å±•ã€‚æŒæ¡æœ¬ç« å†…å®¹ï¼Œä½ å°±èƒ½ç†è§£ PyTorchã€TensorFlow åœ¨åº•å±‚æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚</p><hr><p><strong>å‚è€ƒèµ„æ–™ï¼š</strong></p><ul><li>Hwu, W., Kirk, D., &amp; El Hajj, I. (2022). <em>Programming Massively Parallel Processors: A Hands-on Approach</em> (4th Edition). Morgan Kaufmann.</li><li><a href="https://docs.nvidia.com/deeplearning/cudnn/developer-guide/">NVIDIA cuDNN Developer Guide</a></li><li>Lavin, A., &amp; Gray, S. (2016). <em>Fast Algorithms for Convolutional Neural Networks</em>. CVPR.</li></ul><hr><blockquote><p><strong>æœ¬æ–‡ GitHub ä»“åº“</strong>: <a href="https://github.com/psmarter/PMPP-Learning">https://github.com/psmarter/PMPP-Learning</a></p></blockquote>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;qian-yan&quot; tabindex=&quot;-1&quot; id=&quot;å‰è¨€&quot;&gt;å‰è¨€&lt;/h2&gt;
&lt;p&gt;å‰é¢æˆ‘ä»¬å­¦ä¹ äº†å„ç§å¹¶è¡Œç®—æ³•åŸè¯­ï¼šå½’çº¦ã€æ‰«æã€æ’åºã€ç¨€ç–çŸ©é˜µã€å›¾éå†ã€‚è¿™äº›æŠ€æœ¯åœ¨æ·±åº¦å­¦ä¹ ä¸­éƒ½æœ‰ç”¨æ­¦ä¹‹åœ°ã€‚ç¬¬åå…­ç« å°†è¿™äº›æŠ€æœ¯ä¸²è”èµ·æ¥ï¼Œå±•ç¤º GPU</summary>
        
      
    
    
    
    <category term="çŸ¥è¯†åˆ†äº«" scheme="https://smarter.xin/categories/knowledge-sharing/"/>
    
    
    <category term="æ·±åº¦å­¦ä¹ " scheme="https://smarter.xin/tags/deep-learning/"/>
    
    <category term="CUDA" scheme="https://smarter.xin/tags/CUDA/"/>
    
    <category term="GPUç¼–ç¨‹" scheme="https://smarter.xin/tags/gpu-programming/"/>
    
    <category term="å¹¶è¡Œè®¡ç®—" scheme="https://smarter.xin/tags/parallel-computing/"/>
    
    <category term="PMPP" scheme="https://smarter.xin/tags/PMPP/"/>
    
    <category term="å·ç§¯ç¥ç»ç½‘ç»œ" scheme="https://smarter.xin/tags/convolutional-neural-network/"/>
    
    <category term="cuDNN" scheme="https://smarter.xin/tags/cuDNN/"/>
    
  </entry>
  
  <entry>
    <title>PMPP-ç¬¬åäº”ç« ï¼šå›¾éå†</title>
    <link href="https://smarter.xin/posts/70b05668/"/>
    <id>https://smarter.xin/posts/70b05668/</id>
    <published>2026-01-19T08:12:39.000Z</published>
    <updated>2026-01-24T08:26:21.333Z</updated>
    
    <content type="html"><![CDATA[<h2 id="qian-yan" tabindex="-1" id="å‰è¨€">å‰è¨€</h2><p>ç¬¬åå››ç« æˆ‘ä»¬å­¦ä¹ äº†ç¨€ç–çŸ©é˜µï¼Œé‚£ä¸€ç« çš„é‡ç‚¹æ˜¯ SpMVï¼ˆç¨€ç–çŸ©é˜µ-å‘é‡ä¹˜æ³•ï¼‰ã€‚å…¶å®ï¼Œ<strong>å›¾ï¼ˆGraphï¼‰<strong>å’Œç¨€ç–çŸ©é˜µæ˜¯ä¸€ä½“ä¸¤é¢çš„ï¼šå›¾çš„é‚»æ¥çŸ©é˜µé€šå¸¸å°±æ˜¯ç¨€ç–çŸ©é˜µã€‚ç¬¬åäº”ç« æˆ‘ä»¬å°†æ·±å…¥æ¢è®¨å›¾ç®—æ³•çš„æ ¸å¿ƒâ€”â€”<strong>å›¾éå†</strong>ï¼Œç‰¹åˆ«æ˜¯</strong>å¹¿åº¦ä¼˜å…ˆæœç´¢ï¼ˆBFSï¼‰</strong>ã€‚BFS æ˜¯æœ€çŸ­è·¯å¾„ã€è¿é€šåˆ†é‡ã€æœ€å¤§æµç­‰ä¼—å¤šå›¾ç®—æ³•çš„åŸºç¡€ï¼Œä¹Ÿæ˜¯ GPU å¤„ç†ä¸è§„åˆ™æ•°æ®ç»“æ„çš„å…¸å‹æ¡ˆä¾‹ã€‚</p><blockquote><p><strong>ğŸ“¦ é…å¥—èµ„æº</strong>ï¼šæœ¬ç³»åˆ—æ–‡ç« é…æœ‰å®Œæ•´çš„ <a href="https://github.com/psmarter/PMPP-Learning">GitHub ä»“åº“</a>ï¼ŒåŒ…å«æ¯ç« çš„ç»ƒä¹ é¢˜è§£ç­”ã€CUDA ä»£ç å®ç°å’Œè¯¦ç»†æ³¨é‡Šã€‚æ‰€æœ‰ä»£ç éƒ½ç»è¿‡æµ‹è¯•ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œã€‚</p></blockquote><h2 id="tu-de-biao-shi" tabindex="-1" id="å›¾çš„è¡¨ç¤º">å›¾çš„è¡¨ç¤º</h2><h3 id="cong-xian-shi-shi-jie-dao-tu" tabindex="-1" id="ä»ç°å®ä¸–ç•Œåˆ°å›¾">ä»ç°å®ä¸–ç•Œåˆ°å›¾</h3><p>å›¾ç”±èŠ‚ç‚¹ï¼ˆVertexï¼‰å’Œè¾¹ï¼ˆEdgeï¼‰ç»„æˆã€‚</p><ul><li><strong>ç¤¾äº¤ç½‘ç»œ</strong>ï¼šèŠ‚ç‚¹æ˜¯äººï¼Œè¾¹æ˜¯å…³æ³¨/å¥½å‹å…³ç³»ã€‚</li><li><strong>é“è·¯ç½‘</strong>ï¼šèŠ‚ç‚¹æ˜¯è·¯å£ï¼Œè¾¹æ˜¯é“è·¯ã€‚</li><li><strong>å¼•ç”¨ç½‘ç»œ</strong>ï¼šèŠ‚ç‚¹æ˜¯è®ºæ–‡ï¼Œè¾¹æ˜¯å¼•ç”¨å…³ç³»ã€‚</li></ul><p>è¿™äº›å›¾é€šå¸¸æ˜¯<strong>ç¨€ç–</strong>çš„ï¼ˆæ¯ä¸ªèŠ‚ç‚¹å¹³å‡åªè¿æ¥å°‘æ•°å…¶ä»–èŠ‚ç‚¹ï¼‰ä¸”<strong>æ— æ ‡åº¦</strong>çš„ï¼ˆå°‘æ•°èŠ‚ç‚¹æœ‰æå¤šè¿æ¥ï¼Œä¿—ç§°&quot;å¤§V&quot;ï¼‰ã€‚</p><h3 id="cun-chu-ge-shi-csr" tabindex="-1" id="å­˜å‚¨æ ¼å¼ï¼šCSR">å­˜å‚¨æ ¼å¼ï¼šCSR</h3><p>ä¸Šä¸€ç« ä»‹ç»çš„ <strong>CSR (Compressed Sparse Row)</strong> æ ¼å¼ä¸ä»…é€‚åˆ SpMVï¼Œä¹Ÿæ˜¯å­˜å‚¨å›¾çš„æ ‡å‡†æ ¼å¼ã€‚</p><p>å¯¹äºä¸€ä¸ªæœ‰ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span> ä¸ªèŠ‚ç‚¹ã€<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi></mrow><annotation encoding="application/x-tex">E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span></span> æ¡è¾¹çš„å›¾ï¼š</p><ul><li><strong>row_ptr</strong> (é•¿åº¦ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">V+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>)ï¼š<code>row_ptr[i]</code> æŒ‡å‘èŠ‚ç‚¹ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> çš„é‚»å±…åˆ—è¡¨åœ¨ <code>col_idx</code> ä¸­çš„èµ·å§‹ä½ç½®ã€‚</li><li><strong>col_idx</strong> (é•¿åº¦ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi></mrow><annotation encoding="application/x-tex">E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span></span>)ï¼šå­˜å‚¨æ‰€æœ‰è¾¹çš„ç›®æ ‡èŠ‚ç‚¹ã€‚</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">èŠ‚ç‚¹ 0 çš„é‚»å±…ï¼šcol_idx[row_ptr[0]] ... col_idx[row_ptr[1]-1]</span><br><span class="line">èŠ‚ç‚¹ i çš„é‚»å±…æ•°ï¼šrow_ptr[i+1] - row_ptr[i]</span><br></pre></td></tr></table></figure><h2 id="yan-du-you-xian-sou-suo-bfs" tabindex="-1" id="å¹¿åº¦ä¼˜å…ˆæœç´¢-BFS">å¹¿åº¦ä¼˜å…ˆæœç´¢ (BFS)</h2><h3 id="wen-ti-ding-yi" tabindex="-1" id="é—®é¢˜å®šä¹‰">é—®é¢˜å®šä¹‰</h3><p>ç»™å®šèµ·ç‚¹ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span>ï¼ŒBFS éœ€è¦è®¿é—®æ‰€æœ‰å¯è¾¾èŠ‚ç‚¹ï¼Œå¹¶è®¡ç®—ä» <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span> åˆ°æ¯ä¸ªèŠ‚ç‚¹çš„æœ€çŸ­è·ç¦»ï¼ˆå±‚æ•°ï¼‰ã€‚</p><h3 id="chuan-xing-bfs" tabindex="-1" id="ä¸²è¡Œ-BFS">ä¸²è¡Œ BFS</h3><p>ç»å…¸å®ç°ä½¿ç”¨<strong>é˜Ÿåˆ—ï¼ˆQueueï¼‰</strong>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">BFS_sequential</span><span class="params">(<span class="type">int</span> S, <span class="type">int</span> *row_ptr, <span class="type">int</span> *col_idx, <span class="type">int</span> *level, <span class="type">int</span> num_nodes)</span> </span>&#123;</span><br><span class="line">    std::queue&lt;<span class="type">int</span>&gt; q;</span><br><span class="line">    q.<span class="built_in">push</span>(S);</span><br><span class="line">    level[S] = <span class="number">0</span>; <span class="comment">// åˆå§‹åŒ–å…¶ä»–ä¸º -1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!q.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        <span class="type">int</span> u = q.<span class="built_in">front</span>(); q.<span class="built_in">pop</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// éå†æ‰€æœ‰é‚»å±… v</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = row_ptr[u]; i &lt; row_ptr[u<span class="number">+1</span>]; i++) &#123;</span><br><span class="line">            <span class="type">int</span> v = col_idx[i];</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// å¦‚æœ v æœªè¢«è®¿é—®</span></span><br><span class="line">            <span class="keyword">if</span> (level[v] == <span class="number">-1</span>) &#123;</span><br><span class="line">                level[v] = level[u] + <span class="number">1</span>;</span><br><span class="line">                q.<span class="built_in">push</span>(v);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="bing-xing-hua-de-tiao-zhan" tabindex="-1" id="å¹¶è¡ŒåŒ–çš„æŒ‘æˆ˜">å¹¶è¡ŒåŒ–çš„æŒ‘æˆ˜</h3><ol><li><strong>ä¸è§„åˆ™è®¿é—®</strong>ï¼šæ¯ä¸ªèŠ‚ç‚¹çš„é‚»å±…æ•°é‡å·®å¼‚å·¨å¤§ï¼ˆè´Ÿè½½ä¸å‡è¡¡ï¼‰ã€‚</li><li><strong>åŠ¨æ€å·¥ä½œé›†</strong>ï¼šæ¯ä¸€å±‚çš„èŠ‚ç‚¹æ•°éƒ½åœ¨å˜åŒ–ã€‚</li><li><strong>å¹¶å‘å†²çª</strong>ï¼šå¤šä¸ªèŠ‚ç‚¹å¯èƒ½åŒæ—¶å°è¯•è®¿é—®åŒä¸€ä¸ªé‚»å±…ã€‚</li></ol><h2 id="bing-xing-bfs-an-ceng-tong-bu" tabindex="-1" id="å¹¶è¡Œ-BFSï¼šæŒ‰å±‚åŒæ­¥">å¹¶è¡Œ BFSï¼šæŒ‰å±‚åŒæ­¥</h2><p>GPU é€‚åˆè§£å†³å¯ä»¥åˆ†å±‚çš„ä»»åŠ¡ã€‚BFS å¤©ç„¶åˆ†å±‚ï¼š<br>ç¬¬ 0 å±‚ï¼ˆèµ·ç‚¹ï¼‰ -&gt; ç¬¬ 1 å±‚é‚»å±… -&gt; ç¬¬ 2 å±‚é‚»å±… -&gt; â€¦</p><p>æˆ‘ä»¬å¯ä»¥é‡‡ç”¨**æŒ‰å±‚åŒæ­¥ï¼ˆLevel Synchronousï¼‰**çš„æ–¹æ³•ï¼š</p><ol><li>ç»´æŠ¤ä¸€ä¸ª**å‰æ²¿ï¼ˆFrontierï¼‰**æ•°ç»„ï¼Œæ ‡è®°å½“å‰å±‚éœ€è¦æ‰©å±•çš„èŠ‚ç‚¹ã€‚</li><li>å¹¶è¡Œå¤„ç† Frontier ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹ï¼Œæ‰¾åˆ°ä¸‹ä¸€å±‚çš„é‚»å±…ã€‚</li><li>æ›´æ–° Frontierï¼Œè¿›å…¥ä¸‹ä¸€è½®è¿­ä»£ã€‚</li></ol><h3 id="chu-shi-ban-ben-bu-er-qian-yan-shu-zu" tabindex="-1" id="åˆå§‹ç‰ˆæœ¬ï¼šå¸ƒå°”å‰æ²¿æ•°ç»„">åˆå§‹ç‰ˆæœ¬ï¼šå¸ƒå°”å‰æ²¿æ•°ç»„</h3><p>ç”¨ä¸€ä¸ªå¸ƒå°”æ•°ç»„ <code>F</code> è¡¨ç¤ºå½“å‰å±‚èŠ‚ç‚¹ï¼Œ<code>next_F</code> è¡¨ç¤ºä¸‹ä¸€å±‚ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">__global__ void BFS_kernel(int *row_ptr, int *col_idx, int *level, </span><br><span class="line">                           bool *F, bool *next_F, int num_nodes, int current_depth) &#123;</span><br><span class="line">    int tid = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">    </span><br><span class="line">    if (tid &lt; num_nodes &amp;&amp; F[tid]) &#123; // å¦‚æœæˆ‘æ˜¯å½“å‰å±‚èŠ‚ç‚¹</span><br><span class="line">        F[tid] = false; // ç§»é™¤è‡ªå·±</span><br><span class="line">        </span><br><span class="line">        // éå†é‚»å±…</span><br><span class="line">        int start = row_ptr[tid];</span><br><span class="line">        int end = row_ptr[tid+1];</span><br><span class="line">        for (int i = start; i &lt; end; i++) &#123;</span><br><span class="line">            int neighbor = col_idx[i];</span><br><span class="line">            </span><br><span class="line">            // å¦‚æœé‚»å±…æœªè®¿é—®</span><br><span class="line">            if (level[neighbor] == -1) &#123;</span><br><span class="line">                level[neighbor] = current_depth + 1;</span><br><span class="line">                next_F[neighbor] = true; // åŠ å…¥ä¸‹ä¸€å±‚</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Host ç«¯å¾ªç¯</strong>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (frontier_not_empty) &#123;</span><br><span class="line">    BFS_kernel&lt;&lt;&lt;...&gt;&gt;&gt;(..., depth);</span><br><span class="line">    <span class="built_in">cudaDeviceSynchronize</span>();</span><br><span class="line">    <span class="built_in">swap</span>(F, next_F);</span><br><span class="line">    depth++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="tong-dian-bing-fa-xie-chong-tu" tabindex="-1" id="ç—›ç‚¹ï¼šå¹¶å‘å†™å†²çª">ç—›ç‚¹ï¼šå¹¶å‘å†™å†²çª</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if (level[neighbor] == -1) &#123;</span><br><span class="line">    level[neighbor] = current_depth + 1; // å†²çªï¼</span><br><span class="line">    next_F[neighbor] = true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“å¤šä¸ªèŠ‚ç‚¹æŒ‡å‘åŒä¸€ä¸ªé‚»å±…æ—¶ï¼Œä¼šå‘ç”Ÿ<strong>å†™ç«äº‰</strong>ã€‚<br>è™½ç„¶åœ¨è¿™é‡Œï¼Œåªè¦æœ‰ä¸€ä¸ªçº¿ç¨‹å†™å…¥æˆåŠŸå³å¯ï¼ˆå› ä¸ºè·ç¦»éƒ½æ˜¯ <code>current_depth + 1</code>ï¼‰ï¼Œä¸” <code>next_F</code> è®¾ä¸º true å¤šæ¬¡ä¹Ÿæ— å¦¨ï¼Œä½†åœ¨æœ‰äº›ç¡¬ä»¶æˆ–ç®—æ³•å˜ä½“ä¸Šï¼Œè¿™ä¼šå¯¼è‡´æ•°æ®æœªå®šä¹‰è¡Œä¸ºã€‚</p><p><strong>æ›´å®‰å…¨çš„åšæ³•</strong>æ˜¯ä½¿ç”¨åŸå­æ“ä½œï¼Œä½†è¿™å¾ˆæ…¢ã€‚<br>åœ¨ BFS è¿™ç§è·ç¦»åªæ›´æ–°ä¸€æ¬¡çš„åœºæ™¯ï¼Œå¯ä»¥åˆ©ç”¨<strong>è‰¯æ€§ç«äº‰</strong>ï¼šå¤šçº¿ç¨‹åŒæ—¶å†™å…¥ç›¸åŒçš„å€¼é€šå¸¸æ˜¯å¯ä»¥æ¥å—çš„ï¼Œæˆ–è€…ä½¿ç”¨ <code>atomicCAS</code> ä¿è¯åªæœ‰ç¬¬ä¸€ä¸ªè®¿é—®è€…èƒ½æ›´æ–°ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if (level[neighbor] == -1) &#123;</span><br><span class="line">    // åˆ©ç”¨ level å€¼ä½œä¸ºé”</span><br><span class="line">    // åªæœ‰åŸæ¥çš„å€¼ä¸º -1 æ—¶æ‰æ›´æ–°</span><br><span class="line">    // å®é™…ä¸Šå¯¹äºç®€å•çš„ BFSï¼Œç›´æ¥å†™åœ¨æŸäº›æ¶æ„ä¸Šå¯è¡Œï¼Œä½†æ ‡å‡†åšæ³•åº”è€ƒè™‘æ•°æ®ç«äº‰</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="you-hua-yi-gong-zuo-xiao-lu-yu-xi-shu-qian-yan" tabindex="-1" id="ä¼˜åŒ–ä¸€ï¼šå·¥ä½œæ•ˆç‡ä¸ç¨€ç–å‰æ²¿">ä¼˜åŒ–ä¸€ï¼šå·¥ä½œæ•ˆç‡ä¸ç¨€ç–å‰æ²¿</h2><p>ä¸Šé¢çš„å¸ƒå°”æ•°ç»„æ–¹æ³•æœ‰ä¸€ä¸ªå¤§é—®é¢˜ï¼š<strong>å·¥ä½œæ•ˆç‡æä½</strong>ã€‚<br>æ¯ä¸€å±‚éƒ½è¦å¯åŠ¨ <code>num_nodes</code> ä¸ªçº¿ç¨‹ï¼Œå³ä½¿å½“å‰å±‚åªæœ‰ 1 ä¸ªèŠ‚ç‚¹ï¼</p><p><strong>ç¨€ç–å‰æ²¿ï¼ˆSparse Frontierï¼‰</strong>ï¼š<br>ä¸å­˜å‚¨å¸ƒå°”å€¼ï¼Œè€Œæ˜¯å°†å½“å‰å±‚èŠ‚ç‚¹çš„ ID å­˜å‚¨åœ¨ä¸€ä¸ªç´§å‡‘çš„é˜Ÿåˆ—ä¸­ã€‚<br><code>Queue: [0, 5, 12]</code></p><p>è¿™æ ·åªéœ€å¯åŠ¨ <code>num_frontier</code> ä¸ªçº¿ç¨‹ã€‚è¿™éœ€è¦<strong>åŠ¨æ€é˜Ÿåˆ—ç®¡ç†</strong>ã€‚</p><h3 id="quan-ju-yuan-zi-dui-lie" tabindex="-1" id="å…¨å±€åŸå­é˜Ÿåˆ—">å…¨å±€åŸå­é˜Ÿåˆ—</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">__global__ void BFS_queue_kernel(..., int *queue, int *q_count, int *next_queue, int *next_q_count) &#123;</span><br><span class="line">    int tid = ...;</span><br><span class="line">    // ä» queue ä¸­å–èŠ‚ç‚¹ u</span><br><span class="line">    int u = queue[tid]; </span><br><span class="line">    </span><br><span class="line">    // éå†é‚»å±… v</span><br><span class="line">    // ...</span><br><span class="line">    if (atomicCAS(&amp;level[v], -1, depth+1) == -1) &#123; // åªæœ‰ç¬¬ä¸€ä¸ªæ›´æ–°æˆåŠŸçš„æ‰å…¥é˜Ÿ</span><br><span class="line">         int pos = atomicAdd(next_q_count, 1);</span><br><span class="line">         next_queue[pos] = v;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>é—®é¢˜</strong>ï¼šæ‰€æœ‰çº¿ç¨‹äº‰æŠ¢ <code>next_q_count</code> è¿™ä¸ªå…¨å±€è®¡æ•°å™¨ï¼ŒåŸå­æ“ä½œäº‰ç”¨æå…¶ä¸¥é‡ï¼</p><h2 id="you-hua-er-si-you-hua-yu-fen-ceng-dui-lie" tabindex="-1" id="ä¼˜åŒ–äºŒï¼šç§æœ‰åŒ–ä¸åˆ†å±‚é˜Ÿåˆ—">ä¼˜åŒ–äºŒï¼šç§æœ‰åŒ–ä¸åˆ†å±‚é˜Ÿåˆ—</h2><p>ç±»ä¼¼äºç¬¬ä¹ç« çš„ç›´æ–¹å›¾ä¼˜åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨**ç§æœ‰åŒ–ï¼ˆPrivatizationï¼‰**æŠ€æœ¯ã€‚</p><ol><li><strong>Block çº§é˜Ÿåˆ—</strong>ï¼šæ¯ä¸ª Block åœ¨å…±äº«å†…å­˜ä¸­ç»´æŠ¤ä¸€ä¸ªå°çš„å±€éƒ¨é˜Ÿåˆ—ã€‚</li><li><strong>å±€éƒ¨èšåˆ</strong>ï¼šçº¿ç¨‹å‘ç°æ–°é‚»å±…æ—¶ï¼Œå…ˆå†™å…¥å…±äº«å†…å­˜é˜Ÿåˆ—ã€‚</li><li><strong>å…¨å±€æäº¤</strong>ï¼šBlock æ»¡æˆ–ç»“æŸæ—¶ï¼Œä¸€æ¬¡æ€§ç”³è¯·å…¨å±€é˜Ÿåˆ—ç©ºé—´ï¼Œå°†å±€éƒ¨é˜Ÿåˆ—æ‹·è´è¿‡å»ã€‚</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">__shared__ int s_queue[BLOCK_SIZE];</span><br><span class="line">__shared__ int s_tail;</span><br><span class="line"></span><br><span class="line">// 1. å‘ç°é‚»å±…å…¥å±€éƒ¨é˜Ÿ</span><br><span class="line">int s_pos = atomicAdd(&amp;s_tail, 1);</span><br><span class="line">if (s_pos &lt; BLOCK_SIZE) s_queue[s_pos] = v;</span><br><span class="line"></span><br><span class="line">__syncthreads();</span><br><span class="line"></span><br><span class="line">// 2. Block ç”³è¯·å…¨å±€ç©ºé—´</span><br><span class="line">__shared__ int g_offset;</span><br><span class="line">if (threadIdx.x == 0) &#123;</span><br><span class="line">    g_offset = atomicAdd(global_counter, s_tail);</span><br><span class="line">&#125;</span><br><span class="line">__syncthreads();</span><br><span class="line"></span><br><span class="line">// 3. æ‹·è´åˆ°å…¨å±€</span><br><span class="line">if (threadIdx.x &lt; s_tail) &#123;</span><br><span class="line">    next_queue[g_offset + threadIdx.x] = s_queue[threadIdx.x];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™å¤§å¤§å‡å°‘äº†å…¨å±€åŸå­æ“ä½œçš„æ¬¡æ•°ã€‚</p><h2 id="you-hua-san-fang-xiang-you-hua-top-down-vs-bottom-up" tabindex="-1" id="ä¼˜åŒ–ä¸‰ï¼šæ–¹å‘ä¼˜åŒ–ï¼ˆTop-Down-vs-Bottom-Upï¼‰">ä¼˜åŒ–ä¸‰ï¼šæ–¹å‘ä¼˜åŒ–ï¼ˆTop-Down vs Bottom-Upï¼‰</h2><p>è¿™æ˜¯ BFS ä¼˜åŒ–ä¸­æœ€é‡è¦çš„ç­–ç•¥ä¹‹ä¸€ï¼Œæºè‡ª Scott Beamer çš„å¼€åˆ›æ€§å·¥ä½œã€‚</p><h3 id="top-down-push" tabindex="-1" id="Top-Down-Push">Top-Down (Push)</h3><p>ä¼ ç»Ÿçš„ BFS æ˜¯**æ¨ï¼ˆPushï¼‰**æ¨¡å¼ï¼š</p><ul><li>çœ‹ç€ frontier é‡Œçš„èŠ‚ç‚¹ã€‚</li><li>æ£€æŸ¥å®ƒä»¬çš„é‚»å±…ã€‚</li><li>å¦‚æœé‚»å±…æ²¡è®¿é—®è¿‡ï¼Œæ›´æ–°é‚»å±…ã€‚</li></ul><p><strong>ä¼˜ç‚¹</strong>ï¼šå‰æ²¿ï¼ˆFrontierï¼‰å¾ˆå°æ—¶æ•ˆç‡é«˜ã€‚<br><strong>ç¼ºç‚¹</strong>ï¼šå‰æ²¿å¾ˆå¤§æ—¶ï¼Œè¾¹æ•°å¯èƒ½æ˜¯èŠ‚ç‚¹æ•°çš„å‡ åå€ï¼Œå¤§é‡å†—ä½™æ£€æŸ¥ï¼ˆå¾ˆå¤šé‚»å±…å·²ç»è¢«è®¿é—®è¿‡äº†ï¼‰ã€‚</p><h3 id="bottom-up-pull" tabindex="-1" id="Bottom-Up-Pull">Bottom-Up (Pull)</h3><p>åè¿‡æ¥æ€è€ƒï¼š**æ‹‰ï¼ˆPullï¼‰**æ¨¡å¼ã€‚</p><ul><li>çœ‹ç€æ‰€æœ‰<strong>æœªè®¿é—®</strong>çš„èŠ‚ç‚¹ã€‚</li><li>æ£€æŸ¥å®ƒä»¬çš„é‚»å±…æ˜¯å¦åœ¨ frontier é‡Œã€‚</li><li>åªè¦å‘ç°<strong>ä¸€ä¸ª</strong>é‚»å±…åœ¨ frontier é‡Œï¼Œæˆ‘å°±&quot;è¢«å‘ç°&quot;äº†ï¼Œæ›´æ–°è‡ªå·±ï¼Œä¸éœ€è¦æ£€æŸ¥å…¶ä»–é‚»å±…ã€‚</li></ul><p><strong>ä¼˜ç‚¹</strong>ï¼šå½“å‰æ²¿å¾ˆå¤§æ—¶ï¼Œä¸éœ€è¦éå†æ‰€æœ‰è¾¹ï¼Œåªéœ€æ‰¾åˆ°ä¸€ä¸ªçˆ¶èŠ‚ç‚¹å³å¯åœæ­¢ã€‚<br><strong>ç¼ºç‚¹</strong>ï¼šéœ€è¦æ‰«ææ‰€æœ‰æœªè®¿é—®èŠ‚ç‚¹ï¼Œå‰æ²¿å°æ—¶æ•ˆç‡æä½ã€‚</p><h3 id="hun-he-ce-lue-direction-optimizing-bfs" tabindex="-1" id="æ··åˆç­–ç•¥-Direction-Optimizing-BFS">æ··åˆç­–ç•¥ (Direction-Optimizing BFS)</h3><ul><li>å¼€å§‹æ—¶ï¼ˆå‰æ²¿å°ï¼‰ï¼šç”¨ Top-Downã€‚</li><li>ä¸­é—´æ—¶ï¼ˆå‰æ²¿çˆ†ç‚¸ï¼‰ï¼šåˆ‡æ¢åˆ° Bottom-Upã€‚</li><li>ç»“å°¾æ—¶ï¼ˆå‰æ²¿æ”¶ç¼©ï¼‰ï¼šåˆ‡å› Top-Downã€‚</li></ul><p>è¿™é€šå¸¸èƒ½å¸¦æ¥æ•°å€çš„æ€§èƒ½æå‡ã€‚</p><h2 id="fu-zai-jun-heng-chu-li-wu-biao-du-wang-luo" tabindex="-1" id="è´Ÿè½½å‡è¡¡ï¼šå¤„ç†æ— æ ‡åº¦ç½‘ç»œ">è´Ÿè½½å‡è¡¡ï¼šå¤„ç†æ— æ ‡åº¦ç½‘ç»œ</h2><p>åœ¨ç¤¾äº¤ç½‘ç»œä¸­ï¼ŒæŸäº›èŠ‚ç‚¹å¯èƒ½æœ‰ç™¾ä¸‡çº§é‚»å±…ï¼ˆå¦‚åäººï¼‰ï¼Œè€Œå¤§å¤šèŠ‚ç‚¹åªæœ‰å‡ ä¸ªé‚»å±…ã€‚<br>å¦‚æœä¸€ä¸ªçº¿ç¨‹å¤„ç†ä¸€ä¸ªèŠ‚ç‚¹ï¼š</p><ul><li>çº¿ç¨‹ A å¤„ç† 2 ä¸ªé‚»å±…ï¼ˆç¬é—´å®Œæˆï¼‰ã€‚</li><li>çº¿ç¨‹ B å¤„ç† 100ä¸‡ ä¸ªé‚»å±…ï¼ˆå¡æ­»æ•´ä¸ª Warp/Blockï¼‰ã€‚</li></ul><p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p><ol><li><strong>èŠ‚ç‚¹å¹¶è¡Œ</strong>ï¼šæ¯ä¸ªçº¿ç¨‹å¤„ç†ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆé€‚åˆæ™®é€šèŠ‚ç‚¹ï¼‰ã€‚</li><li><strong>è¾¹å¹¶è¡Œ</strong>ï¼šå¯¹äºåº¦æ•°æå¤§çš„èŠ‚ç‚¹ï¼Œè®©æ•´ä¸ª Warp ç”šè‡³æ•´ä¸ª Block åä½œå¤„ç†å®ƒçš„é‚»å±…åˆ—è¡¨ã€‚</li></ol><p>è¿™éœ€è¦é¢„å¤„ç†æ¥è¯†åˆ«å¤§åº¦èŠ‚ç‚¹ï¼Œç±»ä¼¼ SpMV ä¸­çš„ CSR-Vector æˆ– CSR-Stream ç­–ç•¥ã€‚</p><h2 id="zong-jie" tabindex="-1" id="æ€»ç»“">æ€»ç»“</h2><p>ç¬¬åäº”ç« å±•ç¤ºäº†å¦‚ä½•ç”¨ GPU è§£å†³å›¾éå†é—®é¢˜ã€‚ç›¸æ¯”äºè§„åˆ™çš„çŸ©é˜µè¿ç®—ï¼Œå›¾ç®—æ³•å……æ»¡äº†æŒ‘æˆ˜ï¼š</p><ol><li><strong>CSR æ ¼å¼</strong>ï¼šæ˜¯å›¾å’Œç¨€ç–çŸ©é˜µçš„æ¡¥æ¢ã€‚</li><li><strong>æŒ‰å±‚åŒæ­¥</strong>ï¼šæ˜¯å¹¶è¡Œ BFS çš„åŸºæœ¬æ¡†æ¶ã€‚</li><li><strong>é˜Ÿåˆ—ç®¡ç†</strong>ï¼šä»ç®€å•çš„å¸ƒå°”æ•°ç»„åˆ°å¤æ‚çš„åŒå±‚é˜Ÿåˆ—ï¼ˆç§æœ‰åŒ–ï¼‰ï¼Œæ˜¯ä¸ºäº†è§£å†³å·¥ä½œæ•ˆç‡å’ŒåŸå­äº‰ç”¨é—®é¢˜ã€‚</li><li><strong>æ–¹å‘ä¼˜åŒ–</strong>ï¼šPush vs Pull çš„åŠ¨æ€åˆ‡æ¢ï¼Œä½“ç°äº†ç®—æ³•è®¾è®¡å¯¹æ•°æ®ç‰¹å¾çš„é€‚åº”ã€‚</li><li><strong>è´Ÿè½½å‡è¡¡</strong>ï¼šåº”å¯¹æ— æ ‡åº¦ç‰¹æ€§ï¼Œéœ€è¦ç»†ç²’åº¦çš„ä»»åŠ¡è°ƒåº¦ã€‚</li></ol><p>å›¾ç®—æ³•æ˜¯é«˜æ€§èƒ½è®¡ç®—ï¼ˆHPCï¼‰çš‡å† ä¸Šçš„æ˜ç ä¹‹ä¸€ï¼ˆGraph500 æ’åï¼‰ï¼ŒæŒæ¡äº†å®ƒï¼Œæ„å‘³ç€ä½ å¯¹ GPU å¹¶è¡Œæ¨¡å¼çš„ç†è§£è¾¾åˆ°äº†æ–°çš„é«˜åº¦ã€‚</p><hr><p><strong>å‚è€ƒèµ„æ–™ï¼š</strong></p><ul><li>Hwu, W., Kirk, D., &amp; El Hajj, I. (2022). <em>Programming Massively Parallel Processors: A Hands-on Approach</em> (4th Edition). Morgan Kaufmann.</li><li>Merrill, D., et al. (2012). <em>Scalable GPU Graph Traversal</em>. PPoPP.</li><li>Beamer, S., et al. (2012). <em>Direction-Optimizing Breadth-First Search</em>. SC12.</li></ul><hr><blockquote><p><strong>æœ¬æ–‡ GitHub ä»“åº“</strong>: <a href="https://github.com/psmarter/PMPP-Learning">https://github.com/psmarter/PMPP-Learning</a></p></blockquote>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;qian-yan&quot; tabindex=&quot;-1&quot; id=&quot;å‰è¨€&quot;&gt;å‰è¨€&lt;/h2&gt;
&lt;p&gt;ç¬¬åå››ç« æˆ‘ä»¬å­¦ä¹ äº†ç¨€ç–çŸ©é˜µï¼Œé‚£ä¸€ç« çš„é‡ç‚¹æ˜¯</summary>
        
      
    
    
    
    <category term="çŸ¥è¯†åˆ†äº«" scheme="https://smarter.xin/categories/knowledge-sharing/"/>
    
    
    <category term="CUDA" scheme="https://smarter.xin/tags/CUDA/"/>
    
    <category term="GPUç¼–ç¨‹" scheme="https://smarter.xin/tags/gpu-programming/"/>
    
    <category term="å¹¶è¡Œè®¡ç®—" scheme="https://smarter.xin/tags/parallel-computing/"/>
    
    <category term="PMPP" scheme="https://smarter.xin/tags/PMPP/"/>
    
    <category term="å›¾ç®—æ³•" scheme="https://smarter.xin/tags/graph-algorithm/"/>
    
    <category term="BFS" scheme="https://smarter.xin/tags/BFS/"/>
    
    <category term="CSRæ ¼å¼" scheme="https://smarter.xin/tags/csr-format/"/>
    
  </entry>
  
  <entry>
    <title>PMPP-ç¬¬åå››ç« ï¼šç¨€ç–çŸ©é˜µè®¡ç®—</title>
    <link href="https://smarter.xin/posts/7af84cf7/"/>
    <id>https://smarter.xin/posts/7af84cf7/</id>
    <published>2026-01-19T02:49:30.000Z</published>
    <updated>2026-01-24T08:26:21.333Z</updated>
    
    <content type="html"><![CDATA[<h2 id="qian-yan" tabindex="-1" id="å‰è¨€">å‰è¨€</h2><p>å‰å‡ ç« å­¦äº†å½’çº¦ã€æ’åºç­‰&quot;è§„åˆ™&quot;æ•°æ®çš„å¹¶è¡Œç®—æ³•ã€‚è¿™ç« å­¦<strong>ç¨€ç–çŸ©é˜µ</strong>â€”â€”å¤§éƒ¨åˆ†å…ƒç´ ä¸ºé›¶çš„çŸ©é˜µã€‚ç¨€ç–çŸ©é˜µåœ¨ç§‘å­¦è®¡ç®—ã€å›¾ç®—æ³•ã€æœºå™¨å­¦ä¹ ä¸­æ— å¤„ä¸åœ¨ã€‚å­˜å‚¨æ‰€æœ‰é›¶å…ƒç´ æ—¢æµªè´¹ç©ºé—´åˆæµªè´¹è®¡ç®—ï¼Œæ‰€ä»¥éœ€è¦ç‰¹æ®Šçš„å­˜å‚¨æ ¼å¼å’Œç®—æ³•ã€‚ç¬¬åå››ç« è®²è§£å¸¸è§çš„ç¨€ç–æ ¼å¼å’Œå®ƒä»¬åœ¨ GPU ä¸Šçš„å®ç°ã€‚</p><blockquote><p><strong>ğŸ“¦ é…å¥—èµ„æº</strong>ï¼šæœ¬ç³»åˆ—æ–‡ç« é…æœ‰å®Œæ•´çš„ <a href="https://github.com/psmarter/PMPP-Learning">GitHub ä»“åº“</a>ï¼ŒåŒ…å«æ¯ç« çš„ç»ƒä¹ é¢˜è§£ç­”ã€CUDA ä»£ç å®ç°å’Œè¯¦ç»†æ³¨é‡Šã€‚æ‰€æœ‰ä»£ç éƒ½ç»è¿‡æµ‹è¯•ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œã€‚</p></blockquote><h2 id="xi-shu-ju-zhen-ji-chu" tabindex="-1" id="ç¨€ç–çŸ©é˜µåŸºç¡€">ç¨€ç–çŸ©é˜µåŸºç¡€</h2><h3 id="shi-yao-shi-xi-shu-ju-zhen" tabindex="-1" id="ä»€ä¹ˆæ˜¯ç¨€ç–çŸ©é˜µ">ä»€ä¹ˆæ˜¯ç¨€ç–çŸ©é˜µ</h3><p><strong>ç¨€ç–çŸ©é˜µ</strong>ï¼šéé›¶å…ƒç´ å æ¯”å¾ˆå°çš„çŸ©é˜µã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">å¯†é›†çŸ©é˜µ (Dense):</span><br><span class="line">[1, 2, 3, 4]</span><br><span class="line">[5, 6, 7, 8]</span><br><span class="line">[9, 10, 11, 12]</span><br><span class="line"></span><br><span class="line">ç¨€ç–çŸ©é˜µ (Sparse):</span><br><span class="line">[0, 0, 3, 0]</span><br><span class="line">[0, 0, 0, 0]</span><br><span class="line">[2, 0, 0, 5]</span><br></pre></td></tr></table></figure><p><strong>ç¨€ç–åº¦</strong>ï¼šé›¶å…ƒç´ å æ¯”ã€‚é€šå¸¸ç¨€ç–åº¦ &gt; 90% å°±å€¼å¾—ç”¨ç¨€ç–æ ¼å¼å­˜å‚¨ã€‚</p><h3 id="ying-yong-chang-jing" tabindex="-1" id="åº”ç”¨åœºæ™¯">åº”ç”¨åœºæ™¯</h3><table><thead><tr><th>é¢†åŸŸ</th><th>åº”ç”¨</th><th>ç¨€ç–åº¦</th></tr></thead><tbody><tr><td>å›¾ç®—æ³•</td><td>é‚»æ¥çŸ©é˜µ</td><td>&gt; 99%</td></tr><tr><td>ç‰©ç†ä»¿çœŸ</td><td>æœ‰é™å…ƒåˆšåº¦çŸ©é˜µ</td><td>&gt; 95%</td></tr><tr><td>æ¨èç³»ç»Ÿ</td><td>ç”¨æˆ·-ç‰©å“è¯„åˆ†çŸ©é˜µ</td><td>&gt; 99.9%</td></tr><tr><td>NLP</td><td>è¯-æ–‡æ¡£çŸ©é˜µ</td><td>&gt; 99%</td></tr><tr><td>æ·±åº¦å­¦ä¹ </td><td>å‰ªæåçš„æƒé‡çŸ©é˜µ</td><td>50%-90%</td></tr></tbody></table><h3 id="wei-shi-yao-xu-yao-te-shu-ge-shi" tabindex="-1" id="ä¸ºä»€ä¹ˆéœ€è¦ç‰¹æ®Šæ ¼å¼">ä¸ºä»€ä¹ˆéœ€è¦ç‰¹æ®Šæ ¼å¼</h3><p><strong>å­˜å‚¨æ•ˆç‡</strong>ï¼š</p><ul><li>å¯†é›†æ ¼å¼ï¼šnÂ² ä¸ªå…ƒç´ </li><li>ç¨€ç–æ ¼å¼ï¼šO(nnz) ä¸ªå…ƒç´ ï¼Œnnz = éé›¶å…ƒç´ æ•°</li></ul><p><strong>è®¡ç®—æ•ˆç‡</strong>ï¼š</p><ul><li>å¯†é›† SpMVï¼šO(nÂ²) æ“ä½œ</li><li>ç¨€ç– SpMVï¼šO(nnz) æ“ä½œ</li></ul><p>å¯¹äº 10000Ã—10000 çŸ©é˜µï¼Œ1% ç¨€ç–åº¦ï¼š</p><ul><li>å¯†é›†ï¼š10â¸ ä¸ªå…ƒç´ ï¼Œ400 MB</li><li>ç¨€ç–ï¼š10â¶ ä¸ªéé›¶å…ƒç´ ï¼Œ~12 MB</li></ul><h2 id="chang-jian-xi-shu-ge-shi" tabindex="-1" id="å¸¸è§ç¨€ç–æ ¼å¼">å¸¸è§ç¨€ç–æ ¼å¼</h2><h3 id="coo-coordinate-ge-shi" tabindex="-1" id="COOï¼ˆCoordinateï¼‰æ ¼å¼">COOï¼ˆCoordinateï¼‰æ ¼å¼</h3><p>æœ€ç›´è§‚çš„æ ¼å¼ï¼šå­˜å‚¨æ¯ä¸ªéé›¶å…ƒç´ çš„ (è¡Œ, åˆ—, å€¼)ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">çŸ©é˜µ:</span><br><span class="line">[0, 0, 3, 0]</span><br><span class="line">[0, 0, 0, 0]</span><br><span class="line">[2, 0, 0, 5]</span><br><span class="line"></span><br><span class="line">COO è¡¨ç¤º:</span><br><span class="line">row:    [0, 2, 2]</span><br><span class="line">col:    [2, 0, 3]</span><br><span class="line">value:  [3, 2, 5]</span><br></pre></td></tr></table></figure><p><strong>å­˜å‚¨ç©ºé—´</strong>ï¼š3 Ã— nnz</p><p><strong>ä¼˜ç‚¹</strong>ï¼šç®€å•ï¼Œæ„å»ºæ–¹ä¾¿ï¼Œæ”¯æŒä¹±åºæ’å…¥</p><p><strong>ç¼ºç‚¹</strong>ï¼šæŒ‰è¡Œéå†æ•ˆç‡ä½ï¼Œä¸é€‚åˆ SpMV</p><h3 id="csr-compressed-sparse-row-ge-shi" tabindex="-1" id="CSRï¼ˆCompressed-Sparse-Rowï¼‰æ ¼å¼">CSRï¼ˆCompressed Sparse Rowï¼‰æ ¼å¼</h3><p>æœ€å¸¸ç”¨çš„æ ¼å¼ï¼šå‹ç¼©è¡Œç´¢å¼•ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">çŸ©é˜µ:</span><br><span class="line">[0, 0, 3, 0]</span><br><span class="line">[0, 0, 0, 0]</span><br><span class="line">[2, 0, 0, 5]</span><br><span class="line"></span><br><span class="line">CSR è¡¨ç¤º:</span><br><span class="line">row_ptr:  [0, 1, 1, 3]  // æ¯è¡Œçš„èµ·å§‹ä½ç½®</span><br><span class="line">col_idx:  [2, 0, 3]      // åˆ—ç´¢å¼•</span><br><span class="line">values:   [3, 2, 5]      // å€¼</span><br></pre></td></tr></table></figure><p><strong>row_ptr è§£è¯»</strong>ï¼š</p><ul><li>ç¬¬ 0 è¡Œï¼šrow_ptr[0] åˆ° row_ptr[1]ï¼Œå³ [0, 1)ï¼ŒåŒ…å« 1 ä¸ªå…ƒç´ </li><li>ç¬¬ 1 è¡Œï¼šrow_ptr[1] åˆ° row_ptr[2]ï¼Œå³ [1, 1)ï¼ŒåŒ…å« 0 ä¸ªå…ƒç´ </li><li>ç¬¬ 2 è¡Œï¼šrow_ptr[2] åˆ° row_ptr[3]ï¼Œå³ [1, 3)ï¼ŒåŒ…å« 2 ä¸ªå…ƒç´ </li></ul><p><strong>å­˜å‚¨ç©ºé—´</strong>ï¼š(n + 1) + 2 Ã— nnz</p><p><strong>ä¼˜ç‚¹</strong>ï¼šæŒ‰è¡Œè®¿é—®é«˜æ•ˆï¼ŒSpMV å‹å¥½</p><p><strong>ç¼ºç‚¹</strong>ï¼šæ’å…¥/åˆ é™¤ä»£ä»·é«˜ï¼Œè´Ÿè½½å¯èƒ½ä¸å‡è¡¡</p><h3 id="csc-compressed-sparse-column-ge-shi" tabindex="-1" id="CSCï¼ˆCompressed-Sparse-Columnï¼‰æ ¼å¼">CSCï¼ˆCompressed Sparse Columnï¼‰æ ¼å¼</h3><p>CSR çš„è½¬ç½®ï¼šå‹ç¼©åˆ—ç´¢å¼•ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">col_ptr:  [0, 1, 1, 2, 3]  // æ¯åˆ—çš„èµ·å§‹ä½ç½®</span><br><span class="line">row_idx:  [2, 0, 2]         // è¡Œç´¢å¼•</span><br><span class="line">values:   [2, 3, 5]         // å€¼</span><br></pre></td></tr></table></figure><p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šæŒ‰åˆ—è®¿é—®é¢‘ç¹ï¼Œå¦‚ SpMV çš„è½¬ç½®æ“ä½œã€‚</p><h3 id="ell-ellpack-itpack-ge-shi" tabindex="-1" id="ELLï¼ˆELLPACK-ITPACKï¼‰æ ¼å¼">ELLï¼ˆELLPACK/ITPACKï¼‰æ ¼å¼</h3><p>æ¯è¡Œå¡«å……åˆ°ç›¸åŒé•¿åº¦ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">çŸ©é˜µ:</span><br><span class="line">[1, 0, 2, 0]</span><br><span class="line">[0, 3, 0, 0]</span><br><span class="line">[4, 5, 6, 0]</span><br><span class="line"></span><br><span class="line">ELL è¡¨ç¤ºï¼ˆæ¯è¡Œæœ€å¤š 3 ä¸ªéé›¶å…ƒç´ ï¼‰:</span><br><span class="line">values:       col_idx:</span><br><span class="line">[1, 2, *]     [0, 2, *]</span><br><span class="line">[3, *, *]     [1, *, *]</span><br><span class="line">[4, 5, 6]     [0, 1, 2]</span><br></pre></td></tr></table></figure><ul><li>è¡¨ç¤ºå¡«å……å€¼ï¼ˆæ— æ•ˆå…ƒç´ ï¼‰</li></ul><p><strong>ä¼˜ç‚¹</strong>ï¼šè§„åˆ™è®¿é—®æ¨¡å¼ï¼Œé€‚åˆ GPU å‘é‡åŒ–</p><p><strong>ç¼ºç‚¹</strong>ï¼šè¡Œé•¿åº¦å·®å¼‚å¤§æ—¶æµªè´¹ç©ºé—´</p><h3 id="hybrid-hyb-ge-shi" tabindex="-1" id="Hybridï¼ˆHYBï¼‰æ ¼å¼">Hybridï¼ˆHYBï¼‰æ ¼å¼</h3><p>ELL + COO çš„ç»„åˆï¼š</p><ul><li>å¤§éƒ¨åˆ†å…ƒç´ ç”¨ ELL å­˜å‚¨ï¼ˆè§„åˆ™éƒ¨åˆ†ï¼‰</li><li>è¶…å‡º ELL å®½åº¦çš„å…ƒç´ ç”¨ COO å­˜å‚¨ï¼ˆæº¢å‡ºéƒ¨åˆ†ï¼‰</li></ul><p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šè¡Œé•¿åº¦åˆ†å¸ƒä¸å‡åŒ€çš„çŸ©é˜µã€‚</p><h2 id="xi-shu-ju-zhen-xiang-liang-cheng-fa-sp-mv" tabindex="-1" id="ç¨€ç–çŸ©é˜µ-å‘é‡ä¹˜æ³•ï¼ˆSpMVï¼‰">ç¨€ç–çŸ©é˜µ-å‘é‡ä¹˜æ³•ï¼ˆSpMVï¼‰</h2><h3 id="wen-ti-ding-yi" tabindex="-1" id="é—®é¢˜å®šä¹‰">é—®é¢˜å®šä¹‰</h3><p>y = A Ã— xï¼Œå…¶ä¸­ A æ˜¯ m Ã— n ç¨€ç–çŸ©é˜µã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">y[i] = Î£ A[i][j] Ã— x[j]  ï¼ˆj éå†ç¬¬ i è¡Œçš„éé›¶å…ƒç´ ï¼‰</span><br></pre></td></tr></table></figure><p>SpMV æ˜¯ç§‘å­¦è®¡ç®—æœ€å¸¸è§çš„æ“ä½œï¼Œæ˜¯è¿­ä»£æ±‚è§£å™¨ï¼ˆCGã€GMRESï¼‰çš„æ ¸å¿ƒã€‚</p><h3 id="csr-sp-mv-chuan-xing-shi-xian" tabindex="-1" id="CSR-SpMV-ä¸²è¡Œå®ç°">CSR SpMV ä¸²è¡Œå®ç°</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">spmv_csr_sequential</span><span class="params">(<span class="type">int</span> m, <span class="type">int</span> *row_ptr, <span class="type">int</span> *col_idx, </span></span><br><span class="line"><span class="params">                          <span class="type">float</span> *values, <span class="type">float</span> *x, <span class="type">float</span> *y)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">        <span class="type">float</span> sum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = row_ptr[i]; j &lt; row_ptr[i + <span class="number">1</span>]; j++) &#123;</span><br><span class="line">            sum += values[j] * x[col_idx[j]];</span><br><span class="line">        &#125;</span><br><span class="line">        y[i] = sum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="csr-sp-mv-bing-xing-shi-xian" tabindex="-1" id="CSR-SpMV-å¹¶è¡Œå®ç°">CSR SpMV å¹¶è¡Œå®ç°</h3><p><strong>æ¯è¡Œä¸€ä¸ªçº¿ç¨‹</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">__global__ void spmv_csr_scalar(int m, int *row_ptr, int *col_idx,</span><br><span class="line">                                 float *values, float *x, float *y) &#123;</span><br><span class="line">    int row = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">    </span><br><span class="line">    if (row &lt; m) &#123;</span><br><span class="line">        float sum = 0;</span><br><span class="line">        for (int j = row_ptr[row]; j &lt; row_ptr[row + 1]; j++) &#123;</span><br><span class="line">            sum += values[j] * x[col_idx[j]];</span><br><span class="line">        &#125;</span><br><span class="line">        y[row] = sum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>é—®é¢˜</strong>ï¼š</p><ol><li><strong>è´Ÿè½½ä¸å‡è¡¡</strong>ï¼šè¡Œé•¿åº¦å·®å¼‚å¯¼è‡´çº¿ç¨‹å·¥ä½œé‡ä¸åŒ</li><li><strong>åˆ†æ”¯å‘æ•£</strong>ï¼šåŒä¸€ Warp çš„çº¿ç¨‹å¾ªç¯æ¬¡æ•°ä¸åŒ</li><li><strong>éåˆå¹¶è®¿é—®</strong>ï¼šx[col_idx[j]] æ˜¯é—´æ¥è®¿é—®ï¼Œä¸è¿ç»­</li></ol><h2 id="csr-sp-mv-you-hua" tabindex="-1" id="CSR-SpMV-ä¼˜åŒ–">CSR SpMV ä¼˜åŒ–</h2><h3 id="mei-xing-yi-ge-warp" tabindex="-1" id="æ¯è¡Œä¸€ä¸ª-Warp">æ¯è¡Œä¸€ä¸ª Warp</h3><p>ç”¨ä¸€ä¸ª Warpï¼ˆ32 çº¿ç¨‹ï¼‰å¤„ç†ä¸€è¡Œï¼ŒWarp å†…è§„çº¦æ±‚å’Œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">__global__ void spmv_csr_vector(int m, int *row_ptr, int *col_idx,</span><br><span class="line">                                 float *values, float *x, float *y) &#123;</span><br><span class="line">    int row = blockIdx.x * blockDim.x / 32 + threadIdx.x / 32;</span><br><span class="line">    int lane = threadIdx.x % 32;</span><br><span class="line">    </span><br><span class="line">    if (row &lt; m) &#123;</span><br><span class="line">        float sum = 0;</span><br><span class="line">        int row_start = row_ptr[row];</span><br><span class="line">        int row_end = row_ptr[row + 1];</span><br><span class="line">        </span><br><span class="line">        // Warp å†…çº¿ç¨‹åä½œéå†è¡Œ</span><br><span class="line">        for (int j = row_start + lane; j &lt; row_end; j += 32) &#123;</span><br><span class="line">            sum += values[j] * x[col_idx[j]];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // Warp å†…è§„çº¦</span><br><span class="line">        for (int offset = 16; offset &gt; 0; offset /= 2) &#123;</span><br><span class="line">            sum += __shfl_down_sync(0xffffffff, sum, offset);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        if (lane == 0) &#123;</span><br><span class="line">            y[row] = sum;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ä¼˜åŠ¿</strong>ï¼š</p><ul><li>è´Ÿè½½åœ¨ Warp å†…å‡è¡¡</li><li>æ— åˆ†æ”¯å‘æ•£ï¼ˆæ‰€æœ‰çº¿ç¨‹åšç›¸åŒæ¬¡å¾ªç¯ï¼‰</li><li>éƒ¨åˆ†åˆå¹¶ï¼ˆvalues è¿ç»­ï¼‰</li></ul><h3 id="zi-gua-ying-ce-lue" tabindex="-1" id="è‡ªé€‚åº”ç­–ç•¥">è‡ªé€‚åº”ç­–ç•¥</h3><p>æ ¹æ®è¡Œé•¿åº¦é€‰æ‹©ç­–ç•¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if (row_length &lt; 32) &#123;</span><br><span class="line">    // æ¯è¡Œä¸€ä¸ªçº¿ç¨‹ç»„ï¼ˆå¦‚ 8 çº¿ç¨‹ï¼‰</span><br><span class="line">&#125; else if (row_length &lt; 256) &#123;</span><br><span class="line">    // æ¯è¡Œä¸€ä¸ª Warp</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    // æ¯è¡Œå¤šä¸ª Warp</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>cuSPARSE åº“ä¼šè‡ªåŠ¨é€‰æ‹©æœ€ä¼˜ç­–ç•¥ã€‚</p><h2 id="ell-sp-mv" tabindex="-1" id="ELL-SpMV">ELL SpMV</h2><h3 id="shi-xian" tabindex="-1" id="å®ç°">å®ç°</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">__global__ void spmv_ell(int m, int max_nnz_per_row,</span><br><span class="line">                          int *col_idx, float *values,</span><br><span class="line">                          float *x, float *y) &#123;</span><br><span class="line">    int row = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">    </span><br><span class="line">    if (row &lt; m) &#123;</span><br><span class="line">        float sum = 0;</span><br><span class="line">        for (int j = 0; j &lt; max_nnz_per_row; j++) &#123;</span><br><span class="line">            int idx = row + j * m;  // åˆ—ä¸»åºå­˜å‚¨</span><br><span class="line">            int col = col_idx[idx];</span><br><span class="line">            if (col &gt;= 0) &#123;  // æœ‰æ•ˆå…ƒç´ </span><br><span class="line">                sum += values[idx] * x[col];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        y[row] = sum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="lie-zhu-xu-bu-ju" tabindex="-1" id="åˆ—ä¸»åºå¸ƒå±€">åˆ—ä¸»åºå¸ƒå±€</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">åŸå§‹ï¼ˆè¡Œä¸»åºï¼‰:</span><br><span class="line">row 0: [a, b, c]</span><br><span class="line">row 1: [d, e, *]</span><br><span class="line">row 2: [f, g, h]</span><br><span class="line"></span><br><span class="line">åˆ—ä¸»åº:</span><br><span class="line">j=0: [a, d, f]  â† è¿ç»­è®¿é—®ï¼</span><br><span class="line">j=1: [b, e, g]</span><br><span class="line">j=2: [c, *, h]</span><br></pre></td></tr></table></figure><p><strong>ä¼˜åŠ¿</strong>ï¼šåŒä¸€ Warp çš„çº¿ç¨‹è®¿é—®è¿ç»­å†…å­˜ï¼Œå®ç°åˆå¹¶è®¿é—®ã€‚</p><h3 id="ell-vs-csr" tabindex="-1" id="ELL-vs-CSR">ELL vs CSR</h3><table><thead><tr><th>ç‰¹æ€§</th><th>CSR</th><th>ELL</th></tr></thead><tbody><tr><td>ç©ºé—´</td><td>2Ã—nnz + (m+1)</td><td>2Ã—mÃ—max_nnz</td></tr><tr><td>è®¿é—®åˆå¹¶</td><td>å·®ï¼ˆå€¼å’Œåˆ—ç´¢å¼•ï¼‰</td><td>å¥½ï¼ˆåˆ—ä¸»åºï¼‰</td></tr><tr><td>è´Ÿè½½å‡è¡¡</td><td>éœ€è¦é¢å¤–å¤„ç†</td><td>è‡ªç„¶å‡è¡¡ï¼ˆå›ºå®šå¾ªç¯ï¼‰</td></tr><tr><td>é€‚ç”¨çŸ©é˜µ</td><td>é€šç”¨</td><td>è¡Œé•¿åº¦ç›¸è¿‘</td></tr></tbody></table><h2 id="jds-jagged-diagonal-storage-ge-shi" tabindex="-1" id="JDSï¼ˆJagged-Diagonal-Storageï¼‰æ ¼å¼">JDSï¼ˆJagged Diagonal Storageï¼‰æ ¼å¼</h2><h3 id="si-xiang" tabindex="-1" id="æ€æƒ³">æ€æƒ³</h3><p>æŒ‰è¡Œé•¿åº¦é™åºæ’åˆ—è¡Œï¼Œç„¶åç”¨ç±»ä¼¼ ELL çš„æ–¹å¼å­˜å‚¨ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">åŸå§‹çŸ©é˜µ:</span><br><span class="line">row 0: [a, b]       (é•¿åº¦ 2)</span><br><span class="line">row 1: [c, d, e, f] (é•¿åº¦ 4)</span><br><span class="line">row 2: [g]          (é•¿åº¦ 1)</span><br><span class="line">row 3: [h, i, j]    (é•¿åº¦ 3)</span><br><span class="line"></span><br><span class="line">æŒ‰é•¿åº¦æ’åºå:</span><br><span class="line">row 1: [c, d, e, f]</span><br><span class="line">row 3: [h, i, j, *]</span><br><span class="line">row 0: [a, b, *, *]</span><br><span class="line">row 2: [g, *, *, *]</span><br><span class="line"></span><br><span class="line">JDS å­˜å‚¨:</span><br><span class="line">jds_ptr:  [0, 4, 7, 9, 10]  // æ¯&quot;å¯¹è§’çº¿&quot;çš„èµ·å§‹ä½ç½®</span><br><span class="line">col_idx:  [1åˆ—ç´¢å¼•...]</span><br><span class="line">values:   [c, h, a, g, d, i, b, e, j, f]</span><br><span class="line">perm:     [1, 3, 0, 2]      // è¡Œé‡æ’æ˜ å°„</span><br></pre></td></tr></table></figure><h3 id="you-shi" tabindex="-1" id="ä¼˜åŠ¿">ä¼˜åŠ¿</h3><ul><li>çŸ­è¡Œé›†ä¸­åœ¨åé¢ï¼Œå‡å°‘å¡«å……æµªè´¹</li><li>å‰é¢çš„è¿­ä»£è´Ÿè½½å‡è¡¡æ›´å¥½</li></ul><h3 id="que-dian" tabindex="-1" id="ç¼ºç‚¹">ç¼ºç‚¹</h3><ul><li>éœ€è¦é¢å¤–çš„è¡Œé‡æ’æ•°ç»„</li><li>ç»“æœéœ€è¦æŒ‰åŸé¡ºåºå†™å›</li></ul><h2 id="fen-kuai-ge-shi" tabindex="-1" id="åˆ†å—æ ¼å¼">åˆ†å—æ ¼å¼</h2><h3 id="bsr-block-sparse-row" tabindex="-1" id="BSRï¼ˆBlock-Sparse-Rowï¼‰">BSRï¼ˆBlock Sparse Rowï¼‰</h3><p>æŠŠçŸ©é˜µåˆ†æˆå°å—ï¼ˆå¦‚ 4Ã—4ï¼‰ï¼Œç”¨ CSR å­˜å‚¨å—ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">åŸå§‹çŸ©é˜µ (8Ã—8):</span><br><span class="line">[A, 0, B, 0]     A, B, C, D æ˜¯ 2Ã—2 å—</span><br><span class="line">[0, C, 0, D]</span><br><span class="line"></span><br><span class="line">BSR è¡¨ç¤ºï¼ˆå—å¤§å° 2Ã—2ï¼‰:</span><br><span class="line">block_row_ptr: [0, 2, 4]</span><br><span class="line">block_col_idx: [0, 2, 1, 3]</span><br><span class="line">block_values:  [Açš„4ä¸ªå€¼, Bçš„4ä¸ªå€¼, Cçš„4ä¸ªå€¼, Dçš„4ä¸ªå€¼]</span><br></pre></td></tr></table></figure><h3 id="you-shi-1" tabindex="-1" id="ä¼˜åŠ¿-2">ä¼˜åŠ¿</h3><ol><li><strong>å‡å°‘ç´¢å¼•å¼€é”€</strong>ï¼šæ¯ä¸ªå—åªéœ€ä¸€ä¸ª (è¡Œ, åˆ—) ç´¢å¼•</li><li><strong>æé«˜ç¼“å­˜åˆ©ç”¨</strong>ï¼šå—å†…æ•°æ®è¿ç»­</li><li><strong>åˆ©ç”¨å¯†é›†è®¡ç®—</strong>ï¼šå—å†…å¯ä»¥ç”¨å¯†é›†çŸ©é˜µä¹˜æ³•</li></ol><h3 id="gua-yong-chang-jing" tabindex="-1" id="é€‚ç”¨åœºæ™¯">é€‚ç”¨åœºæ™¯</h3><p>ç‰©ç†ä»¿çœŸä¸­çš„å¤šè‡ªç”±åº¦ç³»ç»Ÿï¼ˆæ¯ä¸ªèŠ‚ç‚¹å¤šä¸ªè‡ªç”±åº¦ï¼‰ï¼Œè‡ªç„¶å½¢æˆå—ç»“æ„ã€‚</p><h2 id="ge-shi-xuan-ze-zhi-nan" tabindex="-1" id="æ ¼å¼é€‰æ‹©æŒ‡å—">æ ¼å¼é€‰æ‹©æŒ‡å—</h2><h3 id="jue-ce-shu" tabindex="-1" id="å†³ç­–æ ‘">å†³ç­–æ ‘</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">              â”‚    ç¨€ç–çŸ©é˜µ      â”‚</span><br><span class="line">              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">                       â”‚</span><br><span class="line">              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">              â”‚ è¡Œé•¿åº¦å·®å¼‚å¤§ï¼Ÿ   â”‚</span><br><span class="line">              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">             æ˜¯        â”‚        å¦</span><br><span class="line">        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">        â”‚              â”‚              â”‚</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”      â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ HYB æˆ– JDS     â”‚      â”‚      â”‚ ELL           â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">                       â”‚</span><br><span class="line">              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">              â”‚ æœ‰å—ç»“æ„ï¼Ÿ      â”‚</span><br><span class="line">              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">             æ˜¯        â”‚        å¦</span><br><span class="line">        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">        â”‚              â”‚              â”‚</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”      â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ BSR            â”‚      â”‚      â”‚ CSR           â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure><h3 id="ge-shi-dui-bi" tabindex="-1" id="æ ¼å¼å¯¹æ¯”">æ ¼å¼å¯¹æ¯”</h3><table><thead><tr><th>æ ¼å¼</th><th>æ„å»ºéš¾åº¦</th><th>ç©ºé—´æ•ˆç‡</th><th>SpMV æ€§èƒ½</th><th>é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td>COO</td><td>å®¹æ˜“</td><td>ä¸­</td><td>å·®</td><td>æ„å»ºé˜¶æ®µ</td></tr><tr><td>CSR</td><td>ä¸­</td><td>å¥½</td><td>ä¸­</td><td>é€šç”¨</td></tr><tr><td>ELL</td><td>ä¸­</td><td>å·®-ä¸­</td><td>å¥½</td><td>å‡åŒ€è¡Œé•¿</td></tr><tr><td>HYB</td><td>å¤æ‚</td><td>ä¸­</td><td>å¥½</td><td>ä¸å‡åŒ€</td></tr><tr><td>BSR</td><td>å¤æ‚</td><td>å¥½</td><td>å¾ˆå¥½</td><td>å—ç»“æ„</td></tr></tbody></table><h2 id="ge-shi-zhuan-huan" tabindex="-1" id="æ ¼å¼è½¬æ¢">æ ¼å¼è½¬æ¢</h2><h3 id="coo-dao-csr" tabindex="-1" id="COO-åˆ°-CSR">COO åˆ° CSR</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">void coo_to_csr(int m, int nnz, int *coo_row, int *coo_col, </span><br><span class="line">                float *coo_val, int *csr_row_ptr, int *csr_col, </span><br><span class="line">                float *csr_val) &#123;</span><br><span class="line">    // 1. ç»Ÿè®¡æ¯è¡Œå…ƒç´ æ•°</span><br><span class="line">    for (int i = 0; i &lt; nnz; i++) &#123;</span><br><span class="line">        csr_row_ptr[coo_row[i] + 1]++;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 2. å‰ç¼€å’Œå¾—åˆ°è¡ŒæŒ‡é’ˆ</span><br><span class="line">    for (int i = 0; i &lt; m; i++) &#123;</span><br><span class="line">        csr_row_ptr[i + 1] += csr_row_ptr[i];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 3. å¡«å……åˆ—ç´¢å¼•å’Œå€¼</span><br><span class="line">    int *temp = calloc(m, sizeof(int));</span><br><span class="line">    for (int i = 0; i &lt; nnz; i++) &#123;</span><br><span class="line">        int row = coo_row[i];</span><br><span class="line">        int pos = csr_row_ptr[row] + temp[row];</span><br><span class="line">        csr_col[pos] = coo_col[i];</span><br><span class="line">        csr_val[pos] = coo_val[i];</span><br><span class="line">        temp[row]++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="bing-xing-zhuan-huan" tabindex="-1" id="å¹¶è¡Œè½¬æ¢">å¹¶è¡Œè½¬æ¢</h3><p>åˆ©ç”¨å‰é¢å­¦çš„æŠ€æœ¯ï¼š</p><ol><li><strong>ç»Ÿè®¡</strong>ï¼šå¹¶è¡Œç›´æ–¹å›¾</li><li><strong>å‰ç¼€å’Œ</strong>ï¼šå¹¶è¡Œæ‰«æ</li><li><strong>åˆ†é…</strong>ï¼šåŸå­æ“ä½œæˆ–å‰ç¼€å’Œç¡®å®šä½ç½®</li></ol><h2 id="cu-sparse-ku" tabindex="-1" id="cuSPARSE-åº“">cuSPARSE åº“</h2><h3 id="ji-ben-shi-yong" tabindex="-1" id="åŸºæœ¬ä½¿ç”¨">åŸºæœ¬ä½¿ç”¨</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;cusparse.h&gt;</span><br><span class="line"></span><br><span class="line">void spmv_cusparse(int m, int n, int nnz,</span><br><span class="line">                   int *row_ptr, int *col_idx, float *values,</span><br><span class="line">                   float *x, float *y) &#123;</span><br><span class="line">    cusparseHandle_t handle;</span><br><span class="line">    cusparseCreate(&amp;handle);</span><br><span class="line">    </span><br><span class="line">    // åˆ›å»ºçŸ©é˜µæè¿°ç¬¦</span><br><span class="line">    cusparseSpMatDescr_t matA;</span><br><span class="line">    cusparseCreateCsr(&amp;matA, m, n, nnz,</span><br><span class="line">                      row_ptr, col_idx, values,</span><br><span class="line">                      CUSPARSE_INDEX_32I, CUSPARSE_INDEX_32I,</span><br><span class="line">                      CUSPARSE_INDEX_BASE_ZERO, CUDA_R_32F);</span><br><span class="line">    </span><br><span class="line">    // åˆ›å»ºå‘é‡æè¿°ç¬¦</span><br><span class="line">    cusparseDnVecDescr_t vecX, vecY;</span><br><span class="line">    cusparseCreateDnVec(&amp;vecX, n, x, CUDA_R_32F);</span><br><span class="line">    cusparseCreateDnVec(&amp;vecY, m, y, CUDA_R_32F);</span><br><span class="line">    </span><br><span class="line">    // åˆ†é…ä¸´æ—¶ç©ºé—´</span><br><span class="line">    float alpha = 1.0f, beta = 0.0f;</span><br><span class="line">    size_t bufferSize;</span><br><span class="line">    cusparseSpMV_bufferSize(handle, CUSPARSE_OPERATION_NON_TRANSPOSE,</span><br><span class="line">                            &amp;alpha, matA, vecX, &amp;beta, vecY,</span><br><span class="line">                            CUDA_R_32F, CUSPARSE_SPMV_ALG_DEFAULT,</span><br><span class="line">                            &amp;bufferSize);</span><br><span class="line">    </span><br><span class="line">    void *buffer;</span><br><span class="line">    cudaMalloc(&amp;buffer, bufferSize);</span><br><span class="line">    </span><br><span class="line">    // æ‰§è¡Œ SpMV</span><br><span class="line">    cusparseSpMV(handle, CUSPARSE_OPERATION_NON_TRANSPOSE,</span><br><span class="line">                 &amp;alpha, matA, vecX, &amp;beta, vecY,</span><br><span class="line">                 CUDA_R_32F, CUSPARSE_SPMV_ALG_DEFAULT, buffer);</span><br><span class="line">    </span><br><span class="line">    // æ¸…ç†</span><br><span class="line">    cusparseDestroySpMat(matA);</span><br><span class="line">    cusparseDestroyDnVec(vecX);</span><br><span class="line">    cusparseDestroyDnVec(vecY);</span><br><span class="line">    cudaFree(buffer);</span><br><span class="line">    cusparseDestroy(handle);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="cu-sparse-te-xing" tabindex="-1" id="cuSPARSE-ç‰¹æ€§">cuSPARSE ç‰¹æ€§</h3><table><thead><tr><th>åŠŸèƒ½</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>SpMV</td><td>ç¨€ç–çŸ©é˜µ-å‘é‡ä¹˜</td></tr><tr><td>SpMM</td><td>ç¨€ç–çŸ©é˜µ-å¯†é›†çŸ©é˜µä¹˜</td></tr><tr><td>SpGEMM</td><td>ç¨€ç–çŸ©é˜µ-ç¨€ç–çŸ©é˜µä¹˜</td></tr><tr><td>ä¸‰è§’æ±‚è§£</td><td>ç¨€ç–ä¸‰è§’çŸ©é˜µæ±‚è§£</td></tr><tr><td>æ ¼å¼è½¬æ¢</td><td>COO/CSR/CSC/BSR äº’è½¬</td></tr><tr><td>çŸ©é˜µåˆ†æ</td><td>ç€è‰²ã€é‡æ’åº</td></tr></tbody></table><h2 id="xing-neng-you-hua-zong-jie" tabindex="-1" id="æ€§èƒ½ä¼˜åŒ–æ€»ç»“">æ€§èƒ½ä¼˜åŒ–æ€»ç»“</h2><h3 id="nei-cun-fang-wen-you-hua" tabindex="-1" id="å†…å­˜è®¿é—®ä¼˜åŒ–">å†…å­˜è®¿é—®ä¼˜åŒ–</h3><ol><li><strong>å€¼å’Œåˆ—ç´¢å¼•</strong>ï¼šCSR ä¸­è¿™ä¸¤è€…é€šå¸¸è¿ç»­è®¿é—®ï¼Œåˆå¹¶è‰¯å¥½</li><li><strong>x å‘é‡</strong>ï¼šé—´æ¥è®¿é—®ï¼Œè€ƒè™‘ç”¨çº¹ç†ç¼“å­˜</li><li><strong>åˆ—ä¸»åº ELL</strong>ï¼šä¿è¯åŒä¸€ Warp çš„çº¿ç¨‹è®¿é—®è¿ç»­</li></ol><h3 id="fu-zai-jun-heng" tabindex="-1" id="è´Ÿè½½å‡è¡¡">è´Ÿè½½å‡è¡¡</h3><ol><li><strong>åˆ†è¡Œç­–ç•¥</strong>ï¼šçŸ­è¡Œç”¨å°‘çº¿ç¨‹ï¼Œé•¿è¡Œç”¨å¤šçº¿ç¨‹</li><li><strong>åˆ†å—å¤„ç†</strong>ï¼šæŠŠéé›¶å…ƒç´ å‡åŒ€åˆ†é…ç»™çº¿ç¨‹å—</li><li><strong>åŠ¨æ€è°ƒåº¦</strong>ï¼šè¿è¡Œæ—¶æ ¹æ®è¡Œé•¿åº¦åˆ†é…èµ„æº</li></ol><h3 id="jian-shao-kai-xiao" tabindex="-1" id="å‡å°‘å¼€é”€">å‡å°‘å¼€é”€</h3><ol><li><strong>åˆå¹¶è¿­ä»£</strong>ï¼šå¤šæ¬¡ SpMV ä¹‹é—´ä¸å¿…æ¥å›æ‹·è´</li><li><strong>é‡ç”¨åˆ†æç»“æœ</strong>ï¼šçŸ©é˜µç»“æ„ä¸å˜æ—¶ï¼Œanalysis åªåšä¸€æ¬¡</li><li><strong>æ··åˆç²¾åº¦</strong>ï¼šç´¢å¼•ç”¨ int32ï¼Œå€¼ç”¨ fp16/bf16</li></ol><h2 id="xiao-jie" tabindex="-1" id="å°ç»“">å°ç»“</h2><p>ç¬¬åå››ç« æ·±å…¥è®²è§£ç¨€ç–çŸ©é˜µï¼š</p><p><strong>å­˜å‚¨æ ¼å¼</strong>ï¼šCOOï¼ˆç®€å•ï¼‰ã€CSRï¼ˆé€šç”¨ï¼‰ã€ELLï¼ˆè§„åˆ™ï¼‰ã€BSRï¼ˆå—ç»“æ„ï¼‰ã€‚é€‰æ‹©å–å†³äºçŸ©é˜µç‰¹æ€§å’Œæ“ä½œç±»å‹ã€‚</p><p><strong>CSR SpMV</strong>ï¼šæœ€å¸¸ç”¨ã€‚æ¯è¡Œä¸€çº¿ç¨‹ç®€å•ä½†è´Ÿè½½ä¸å‡ï¼›æ¯è¡Œä¸€ Warp æ›´å‡è¡¡ä½†éœ€è¦è§„çº¦ã€‚è‡ªé€‚åº”ç­–ç•¥æ ¹æ®è¡Œé•¿åº¦é€‰æ‹©ã€‚</p><p><strong>ELL SpMV</strong>ï¼šåˆ—ä¸»åºå­˜å‚¨ä¿è¯åˆå¹¶è®¿é—®ã€‚é€‚åˆè¡Œé•¿åº¦ç›¸è¿‘çš„çŸ©é˜µã€‚</p><p><strong>æ ¼å¼è½¬æ¢</strong>ï¼šCOO â†’ CSR ç”¨å‰ç¼€å’Œç¡®å®šä½ç½®ã€‚å¹¶è¡Œè½¬æ¢åˆ©ç”¨ç›´æ–¹å›¾å’Œæ‰«æã€‚</p><p><strong>cuSPARSE</strong>ï¼šç”Ÿäº§ç¯å¢ƒé¦–é€‰ã€‚æä¾›å¤šç§æ ¼å¼å’Œæ“ä½œï¼Œè‡ªåŠ¨é€‰æ‹©æœ€ä¼˜ç®—æ³•ã€‚</p><p>ç¨€ç–çŸ©é˜µæ˜¯ç§‘å­¦è®¡ç®—çš„åŸºç¡€ã€‚æŒæ¡æ ¼å¼é€‰æ‹©å’Œ SpMV ä¼˜åŒ–ï¼Œå°±èƒ½é«˜æ•ˆå¤„ç†å›¾ç®—æ³•ã€ç‰©ç†ä»¿çœŸã€æœºå™¨å­¦ä¹ ä¸­çš„å¤§è§„æ¨¡ç¨€ç–æ•°æ®ã€‚</p><hr><p><strong>å‚è€ƒèµ„æ–™ï¼š</strong></p><ul><li>Hwu, W., Kirk, D., &amp; El Hajj, I. (2022). <em>Programming Massively Parallel Processors: A Hands-on Approach</em> (4th Edition). Morgan Kaufmann.</li><li>Bell, N., &amp; Garland, M. (2009). <em>Implementing Sparse Matrix-Vector Multiplication on Throughput-Oriented Processors</em>. SC09.</li><li><a href="https://docs.nvidia.com/cuda/cusparse/">NVIDIA cuSPARSE Library</a></li></ul><hr><blockquote><p><strong>æœ¬æ–‡ GitHub ä»“åº“</strong>: <a href="https://github.com/psmarter/PMPP-Learning">https://github.com/psmarter/PMPP-Learning</a></p></blockquote>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;qian-yan&quot; tabindex=&quot;-1&quot;</summary>
        
      
    
    
    
    <category term="çŸ¥è¯†åˆ†äº«" scheme="https://smarter.xin/categories/knowledge-sharing/"/>
    
    
    <category term="CUDA" scheme="https://smarter.xin/tags/CUDA/"/>
    
    <category term="GPUç¼–ç¨‹" scheme="https://smarter.xin/tags/gpu-programming/"/>
    
    <category term="å¹¶è¡Œè®¡ç®—" scheme="https://smarter.xin/tags/parallel-computing/"/>
    
    <category term="PMPP" scheme="https://smarter.xin/tags/PMPP/"/>
    
    <category term="CSRæ ¼å¼" scheme="https://smarter.xin/tags/csr-format/"/>
    
    <category term="ç¨€ç–çŸ©é˜µ" scheme="https://smarter.xin/tags/sparse-matrix/"/>
    
    <category term="SpMV" scheme="https://smarter.xin/tags/SpMV/"/>
    
  </entry>
  
  <entry>
    <title>PMPP-ç¬¬åä¸‰ç« ï¼šæ’åº</title>
    <link href="https://smarter.xin/posts/d9ee9484/"/>
    <id>https://smarter.xin/posts/d9ee9484/</id>
    <published>2026-01-18T14:04:20.000Z</published>
    <updated>2026-01-24T08:26:21.332Z</updated>
    
    <content type="html"><![CDATA[<h2 id="qian-yan" tabindex="-1" id="å‰è¨€">å‰è¨€</h2><p>å‰ä¸¤ç« å­¦äº†å½’çº¦å’Œå½’å¹¶ï¼Œè¿™ç« å­¦<strong>æ’åº</strong>â€”â€”æŠŠæ— åºæ•°æ®å˜æˆæœ‰åºæ•°æ®ã€‚æ’åºæ˜¯æœ€åŸºç¡€çš„ç®—æ³•ä¹‹ä¸€ï¼Œå‡ ä¹æ‰€æœ‰é¢†åŸŸéƒ½ç”¨å¾—åˆ°ã€‚GPU æ’åºçš„æŒ‘æˆ˜åœ¨äºï¼šä¼ ç»Ÿæ’åºç®—æ³•ï¼ˆå¦‚å¿«é€Ÿæ’åºï¼‰çš„é€’å½’å’Œæ•°æ®ä¾èµ–ä¸é€‚åˆ GPU çš„ SIMT æ¨¡å‹ã€‚ç¬¬åä¸‰ç« ä»‹ç»é€‚åˆ GPU çš„æ’åºç®—æ³•ï¼Œé‡ç‚¹æ˜¯<strong>åŸºæ•°æ’åºï¼ˆRadix Sortï¼‰</strong>â€”â€”åˆ©ç”¨å‰ç¼€å’Œå®ç°é«˜æ•ˆå¹¶è¡Œæ’åºã€‚</p><blockquote><p><strong>ğŸ“¦ é…å¥—èµ„æº</strong>ï¼šæœ¬ç³»åˆ—æ–‡ç« é…æœ‰å®Œæ•´çš„ <a href="https://github.com/psmarter/PMPP-Learning">GitHub ä»“åº“</a>ï¼ŒåŒ…å«æ¯ç« çš„ç»ƒä¹ é¢˜è§£ç­”ã€CUDA ä»£ç å®ç°å’Œè¯¦ç»†æ³¨é‡Šã€‚æ‰€æœ‰ä»£ç éƒ½ç»è¿‡æµ‹è¯•ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œã€‚</p></blockquote><h2 id="pai-xu-suan-fa-gai-lan" tabindex="-1" id="æ’åºç®—æ³•æ¦‚è§ˆ">æ’åºç®—æ³•æ¦‚è§ˆ</h2><h3 id="ji-yu-bi-jiao-de-pai-xu" tabindex="-1" id="åŸºäºæ¯”è¾ƒçš„æ’åº">åŸºäºæ¯”è¾ƒçš„æ’åº</h3><table><thead><tr><th>ç®—æ³•</th><th>å¹³å‡å¤æ‚åº¦</th><th>æœ€åå¤æ‚åº¦</th><th>ç©ºé—´</th><th>ç¨³å®šæ€§</th></tr></thead><tbody><tr><td>å†’æ³¡æ’åº</td><td>O(nÂ²)</td><td>O(nÂ²)</td><td>O(1)</td><td>ç¨³å®š</td></tr><tr><td>æ’å…¥æ’åº</td><td>O(nÂ²)</td><td>O(nÂ²)</td><td>O(1)</td><td>ç¨³å®š</td></tr><tr><td>å¿«é€Ÿæ’åº</td><td>O(n log n)</td><td>O(nÂ²)</td><td>O(log n)</td><td>ä¸ç¨³å®š</td></tr><tr><td>å½’å¹¶æ’åº</td><td>O(n log n)</td><td>O(n log n)</td><td>O(n)</td><td>ç¨³å®š</td></tr><tr><td>å †æ’åº</td><td>O(n log n)</td><td>O(n log n)</td><td>O(1)</td><td>ä¸ç¨³å®š</td></tr></tbody></table><p><strong>ç†è®ºä¸‹ç•Œ</strong>ï¼šåŸºäºæ¯”è¾ƒçš„æ’åºæœ€ä¼˜æ˜¯ O(n log n)ã€‚</p><h3 id="fei-bi-jiao-pai-xu" tabindex="-1" id="éæ¯”è¾ƒæ’åº">éæ¯”è¾ƒæ’åº</h3><table><thead><tr><th>ç®—æ³•</th><th>å¤æ‚åº¦</th><th>é€‚ç”¨ç±»å‹</th></tr></thead><tbody><tr><td>è®¡æ•°æ’åº</td><td>O(n + k)</td><td>å°èŒƒå›´æ•´æ•°</td></tr><tr><td>åŸºæ•°æ’åº</td><td>O(d(n + k))</td><td>å›ºå®šä½æ•°æ•´æ•°</td></tr><tr><td>æ¡¶æ’åº</td><td>O(n + k)</td><td>å‡åŒ€åˆ†å¸ƒ</td></tr></tbody></table><p><strong>çªç ´ä¸‹ç•Œ</strong>ï¼šéæ¯”è¾ƒæ’åºå¯ä»¥è¾¾åˆ° O(n)ï¼Œä½†æœ‰ç±»å‹é™åˆ¶ã€‚</p><h3 id="gpu-pai-xu-de-xuan-ze" tabindex="-1" id="GPU-æ’åºçš„é€‰æ‹©">GPU æ’åºçš„é€‰æ‹©</h3><p><strong>å¿«é€Ÿæ’åºä¸é€‚åˆ GPU</strong>ï¼š</p><ul><li>é€’å½’æ·±åº¦ä¸ç¡®å®š</li><li>åˆ†åŒºä¸å¹³è¡¡å¯¼è‡´è´Ÿè½½ä¸å‡</li><li>æ•°æ®ä¾èµ–å¯¼è‡´åˆ†æ”¯å‘æ•£</li></ul><p><strong>GPU å‹å¥½çš„ç®—æ³•</strong>ï¼š</p><ul><li><strong>åŸºæ•°æ’åº</strong>ï¼šè§„åˆ™çš„æ•°æ®è®¿é—®æ¨¡å¼ï¼Œåˆ©ç”¨å‰ç¼€å’Œ</li><li><strong>å½’å¹¶æ’åº</strong>ï¼šç¡®å®šçš„æ­¥éª¤æ•°ï¼Œå¯å¹¶è¡Œå½’å¹¶</li><li><strong>åŒè°ƒæ’åº</strong>ï¼šå®Œå…¨æ•°æ®æ— å…³çš„æ¯”è¾ƒç½‘ç»œ</li></ul><h2 id="ji-shu-pai-xu" tabindex="-1" id="åŸºæ•°æ’åº">åŸºæ•°æ’åº</h2><h3 id="he-xin-si-xiang" tabindex="-1" id="æ ¸å¿ƒæ€æƒ³">æ ¸å¿ƒæ€æƒ³</h3><p>æŒ‰ä½æ’åºï¼Œä»æœ€ä½ä½åˆ°æœ€é«˜ä½ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">åŸå§‹:    [329, 457, 657, 839, 436, 720, 355]</span><br><span class="line"></span><br><span class="line">æŒ‰ä¸ªä½æ’åºï¼ˆç¬¬0ä½ï¼‰:</span><br><span class="line">         [720, 355, 436, 457, 657, 329, 839]</span><br><span class="line"></span><br><span class="line">æŒ‰åä½æ’åºï¼ˆç¬¬1ä½ï¼‰:</span><br><span class="line">         [720, 329, 436, 839, 355, 457, 657]</span><br><span class="line"></span><br><span class="line">æŒ‰ç™¾ä½æ’åºï¼ˆç¬¬2ä½ï¼‰:</span><br><span class="line">         [329, 355, 436, 457, 657, 720, 839]</span><br><span class="line"></span><br><span class="line">å®Œæˆï¼</span><br></pre></td></tr></table></figure><p><strong>å…³é”®</strong>ï¼šæ¯ä¸€è½®æ’åºå¿…é¡»æ˜¯<strong>ç¨³å®š</strong>çš„ï¼Œä¿æŒç›¸åŒé”®å€¼å…ƒç´ çš„ç›¸å¯¹é¡ºåºã€‚</p><h3 id="wei-pai-xu-yu-ji-shu-pai-xu" tabindex="-1" id="ä½æ’åºä¸è®¡æ•°æ’åº">ä½æ’åºä¸è®¡æ•°æ’åº</h3><p>æ¯ä¸€è½®æŒ‰æŸä¸€ä½æ’åºï¼Œä½¿ç”¨<strong>è®¡æ•°æ’åº</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. ç»Ÿè®¡æ¯ä¸ªå€¼çš„å‡ºç°æ¬¡æ•°</span><br><span class="line">2. è®¡ç®—å‰ç¼€å’Œå¾—åˆ°æ¯ä¸ªå€¼çš„èµ·å§‹ä½ç½®</span><br><span class="line">3. æŒ‰åŸé¡ºåºåˆ†é…åˆ°è¾“å‡ºä½ç½®</span><br></pre></td></tr></table></figure><p>å¯¹äºäºŒè¿›åˆ¶ä½ï¼ˆ0 æˆ– 1ï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥:    [1, 0, 1, 1, 0, 0, 1, 0]</span><br><span class="line">è®¡æ•°:    count[0]=4, count[1]=4</span><br><span class="line">å‰ç¼€å’Œ:  pos[0]=0, pos[1]=4</span><br><span class="line">åˆ†é…:    è¾“å‡ºä½ç½® = pos[bit]++</span><br><span class="line">ç»“æœ:    [0, 0, 0, 0, 1, 1, 1, 1]</span><br></pre></td></tr></table></figure><h3 id="duo-wei-yi-qi-chu-li" tabindex="-1" id="å¤šä½ä¸€èµ·å¤„ç†">å¤šä½ä¸€èµ·å¤„ç†</h3><p>ä¸€æ¬¡å¤„ç†å¤šä½ï¼ˆå¦‚ 4 ä½ï¼‰å¯ä»¥å‡å°‘è½®æ•°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">32 ä½æ•´æ•°:</span><br><span class="line">  1 ä½/è½®: 32 è½®</span><br><span class="line">  4 ä½/è½®: 8 è½®</span><br><span class="line">  8 ä½/è½®: 4 è½®</span><br></pre></td></tr></table></figure><p>ä»£ä»·æ˜¯æ¯è½®éœ€è¦æ›´å¤§çš„è®¡æ•°æ•°ç»„ï¼ˆ2^b ä¸ªæ¡¶ï¼‰ã€‚</p><h2 id="bing-xing-ji-shu-pai-xu" tabindex="-1" id="å¹¶è¡ŒåŸºæ•°æ’åº">å¹¶è¡ŒåŸºæ•°æ’åº</h2><h3 id="dan-block-ban-ben" tabindex="-1" id="å•-Block-ç‰ˆæœ¬">å• Block ç‰ˆæœ¬</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">#define RADIX_BITS 4</span><br><span class="line">#define RADIX (1 &lt;&lt; RADIX_BITS)  // 16</span><br><span class="line">#define RADIX_MASK (RADIX - 1)</span><br><span class="line"></span><br><span class="line">__global__ void radix_sort_block(unsigned int *data, int n, int bit) &#123;</span><br><span class="line">    __shared__ unsigned int s_data[BLOCK_SIZE];</span><br><span class="line">    __shared__ int s_count[RADIX];</span><br><span class="line">    __shared__ int s_offset[RADIX];</span><br><span class="line">    </span><br><span class="line">    int tid = threadIdx.x;</span><br><span class="line">    </span><br><span class="line">    // åŠ è½½æ•°æ®</span><br><span class="line">    s_data[tid] = (tid &lt; n) ? data[tid] : 0xFFFFFFFF;</span><br><span class="line">    __syncthreads();</span><br><span class="line">    </span><br><span class="line">    // ç»Ÿè®¡æ¯ä¸ªæ¡¶çš„è®¡æ•°ï¼ˆè¿™é‡Œç®€åŒ–ï¼Œå®é™…éœ€è¦åŸå­æˆ–è§„çº¦ï¼‰</span><br><span class="line">    if (tid &lt; RADIX) s_count[tid] = 0;</span><br><span class="line">    __syncthreads();</span><br><span class="line">    </span><br><span class="line">    int digit = (s_data[tid] &gt;&gt; bit) &amp; RADIX_MASK;</span><br><span class="line">    atomicAdd(&amp;s_count[digit], 1);</span><br><span class="line">    __syncthreads();</span><br><span class="line">    </span><br><span class="line">    // å‰ç¼€å’Œå¾—åˆ°åç§»</span><br><span class="line">    // ... exclusive scan on s_count â†’ s_offset ...</span><br><span class="line">    </span><br><span class="line">    // åˆ†é…åˆ°è¾“å‡ºä½ç½®</span><br><span class="line">    int pos = atomicAdd(&amp;s_offset[digit], 1);  // åŠ¨æ€åˆ†é…</span><br><span class="line">    </span><br><span class="line">    __shared__ unsigned int s_temp[BLOCK_SIZE];</span><br><span class="line">    s_temp[pos] = s_data[tid];</span><br><span class="line">    __syncthreads();</span><br><span class="line">    </span><br><span class="line">    // å†™å›</span><br><span class="line">    s_data[tid] = s_temp[tid];</span><br><span class="line">    __syncthreads();</span><br><span class="line">    </span><br><span class="line">    if (tid &lt; n) data[tid] = s_data[tid];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="da-gui-mo-ji-shu-pai-xu" tabindex="-1" id="å¤§è§„æ¨¡åŸºæ•°æ’åº">å¤§è§„æ¨¡åŸºæ•°æ’åº</h3><p>å¯¹äºè¶…è¿‡å• Block çš„æ•°æ®ï¼Œéœ€è¦åˆ†é˜¶æ®µï¼š</p><p><strong>é˜¶æ®µ 1ï¼šå±€éƒ¨ç›´æ–¹å›¾</strong></p><p>æ¯ä¸ª Block ç»Ÿè®¡è‡ªå·±åŒºåŸŸçš„æ¡¶è®¡æ•°ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">__global__ void compute_histograms(unsigned int *data, int *histograms, </span><br><span class="line">                                    int n, int bit) &#123;</span><br><span class="line">    __shared__ int local_hist[RADIX];</span><br><span class="line">    </span><br><span class="line">    // åˆå§‹åŒ–</span><br><span class="line">    if (threadIdx.x &lt; RADIX) local_hist[threadIdx.x] = 0;</span><br><span class="line">    __syncthreads();</span><br><span class="line">    </span><br><span class="line">    // ç»Ÿè®¡</span><br><span class="line">    int i = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">    if (i &lt; n) &#123;</span><br><span class="line">        int digit = (data[i] &gt;&gt; bit) &amp; RADIX_MASK;</span><br><span class="line">        atomicAdd(&amp;local_hist[digit], 1);</span><br><span class="line">    &#125;</span><br><span class="line">    __syncthreads();</span><br><span class="line">    </span><br><span class="line">    // å†™å…¥å…¨å±€ç›´æ–¹å›¾</span><br><span class="line">    if (threadIdx.x &lt; RADIX) &#123;</span><br><span class="line">        histograms[blockIdx.x * RADIX + threadIdx.x] = local_hist[threadIdx.x];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>é˜¶æ®µ 2ï¼šå‰ç¼€å’Œ</strong></p><p>å¯¹æ‰€æœ‰ Block çš„ç›´æ–¹å›¾åšå…¨å±€å‰ç¼€å’Œï¼Œå¾—åˆ°æ¯ä¸ª Block æ¯ä¸ªæ¡¶çš„å…¨å±€èµ·å§‹ä½ç½®ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Block 0 æ¡¶ k çš„èµ·å§‹ä½ç½® = Î£(Block &lt; 0, æ¡¶ &lt; k çš„è®¡æ•°) + Î£(Block &lt; 0, æ¡¶ k çš„è®¡æ•°)</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ªäºŒç»´å‰ç¼€å’Œé—®é¢˜ã€‚</p><p><strong>é˜¶æ®µ 3ï¼šé‡æ’ï¼ˆScatterï¼‰</strong></p><p>æ ¹æ®è®¡ç®—å‡ºçš„ä½ç½®ï¼ŒæŠŠå…ƒç´ ç§»åŠ¨åˆ°æ­£ç¡®ä½ç½®ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">__global__ void scatter(unsigned int *in, unsigned int *out, </span><br><span class="line">                        int *prefix, int n, int bit) &#123;</span><br><span class="line">    __shared__ int local_prefix[RADIX];</span><br><span class="line">    </span><br><span class="line">    // åŠ è½½æœ¬ Block çš„å‰ç¼€</span><br><span class="line">    if (threadIdx.x &lt; RADIX) &#123;</span><br><span class="line">        local_prefix[threadIdx.x] = prefix[blockIdx.x * RADIX + threadIdx.x];</span><br><span class="line">    &#125;</span><br><span class="line">    __syncthreads();</span><br><span class="line">    </span><br><span class="line">    int i = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">    if (i &lt; n) &#123;</span><br><span class="line">        int digit = (in[i] &gt;&gt; bit) &amp; RADIX_MASK;</span><br><span class="line">        int pos = atomicAdd(&amp;local_prefix[digit], 1);</span><br><span class="line">        out[pos] = in[i];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="wan-zheng-liu-cheng" tabindex="-1" id="å®Œæ•´æµç¨‹">å®Œæ•´æµç¨‹</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">void radix_sort(unsigned int *data, int n) &#123;</span><br><span class="line">    unsigned int *d_data, *d_temp;</span><br><span class="line">    int *d_histograms, *d_prefix;</span><br><span class="line">    </span><br><span class="line">    int num_blocks = (n + BLOCK_SIZE - 1) / BLOCK_SIZE;</span><br><span class="line">    </span><br><span class="line">    cudaMalloc(&amp;d_data, n * sizeof(unsigned int));</span><br><span class="line">    cudaMalloc(&amp;d_temp, n * sizeof(unsigned int));</span><br><span class="line">    cudaMalloc(&amp;d_histograms, num_blocks * RADIX * sizeof(int));</span><br><span class="line">    cudaMalloc(&amp;d_prefix, num_blocks * RADIX * sizeof(int));</span><br><span class="line">    </span><br><span class="line">    cudaMemcpy(d_data, data, n * sizeof(unsigned int), cudaMemcpyHostToDevice);</span><br><span class="line">    </span><br><span class="line">    for (int bit = 0; bit &lt; 32; bit += RADIX_BITS) &#123;</span><br><span class="line">        // é˜¶æ®µ 1ï¼šè®¡ç®—ç›´æ–¹å›¾</span><br><span class="line">        compute_histograms&lt;&lt;&lt;num_blocks, BLOCK_SIZE&gt;&gt;&gt;</span><br><span class="line">            (d_data, d_histograms, n, bit);</span><br><span class="line">        </span><br><span class="line">        // é˜¶æ®µ 2ï¼šå…¨å±€å‰ç¼€å’Œ</span><br><span class="line">        exclusive_scan(d_histograms, d_prefix, num_blocks * RADIX);</span><br><span class="line">        </span><br><span class="line">        // é˜¶æ®µ 3ï¼šé‡æ’</span><br><span class="line">        scatter&lt;&lt;&lt;num_blocks, BLOCK_SIZE&gt;&gt;&gt;</span><br><span class="line">            (d_data, d_temp, d_prefix, n, bit);</span><br><span class="line">        </span><br><span class="line">        // äº¤æ¢ç¼“å†²åŒº</span><br><span class="line">        swap(d_data, d_temp);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    cudaMemcpy(data, d_data, n * sizeof(unsigned int), cudaMemcpyDeviceToHost);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="you-hua-ji-zhu" tabindex="-1" id="ä¼˜åŒ–æŠ€æœ¯">ä¼˜åŒ–æŠ€æœ¯</h2><h3 id="bi-mian-yuan-zi-cao-zuo" tabindex="-1" id="é¿å…åŸå­æ“ä½œ">é¿å…åŸå­æ“ä½œ</h3><p>é˜¶æ®µ 3 çš„ <code>atomicAdd</code> æ˜¯ç“¶é¢ˆã€‚å¯ä»¥ç”¨<strong>æœ¬åœ°æ’åº + å‰ç¼€å’Œ</strong>æ›¿ä»£ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. æ¯ä¸ªçº¿ç¨‹å¤„ç†å¤šä¸ªå…ƒç´ </span><br><span class="line">2. æœ¬åœ°è®¡ç®—æ¯ä¸ªæ¡¶çš„å…ƒç´ ä¸ªæ•°</span><br><span class="line">3. Block å†…å‰ç¼€å’Œå¾—åˆ°æ¯ä¸ªçº¿ç¨‹çš„èµ·å§‹åç§»</span><br><span class="line">4. æ— å†²çªåœ°å†™å…¥è¾“å‡º</span><br></pre></td></tr></table></figure><h3 id="xiang-liang-hua-jia-zai" tabindex="-1" id="å‘é‡åŒ–åŠ è½½">å‘é‡åŒ–åŠ è½½</h3><p>æ¯æ¬¡åŠ è½½ 4 ä¸ªå…ƒç´ ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">uint4 data4 = *reinterpret_cast&lt;uint4*&gt;(&amp;data[i]);</span><br><span class="line">// å¤„ç† data4.x, data4.y, data4.z, data4.w</span><br></pre></td></tr></table></figure><p>å‡å°‘å†…å­˜äº‹åŠ¡æ•°ã€‚</p><h3 id="fen-tong-you-hua" tabindex="-1" id="åˆ†æ¡¶ä¼˜åŒ–">åˆ†æ¡¶ä¼˜åŒ–</h3><p>å¯¹äºå¤§èŒƒå›´æ•°æ®ï¼Œå…ˆæŒ‰é«˜ä½åˆ†æˆå¤§æ¡¶ï¼Œå†åˆ†åˆ«æ’åºå°æ¡¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ç¬¬ä¸€éï¼šæŒ‰é«˜ 8 ä½åˆ†æˆ 256 ä¸ªæ¡¶</span><br><span class="line">ç¬¬äºŒéï¼šå¯¹æ¯ä¸ªæ¡¶æŒ‰å‰©ä½™ 24 ä½æ’åº</span><br></pre></td></tr></table></figure><p>å‡å°‘æ¯è½®éœ€è¦å¤„ç†çš„æ•°æ®é‡ã€‚</p><h2 id="gui-bing-pai-xu" tabindex="-1" id="å½’å¹¶æ’åº">å½’å¹¶æ’åº</h2><h3 id="gpu-gui-bing-pai-xu-liu-cheng" tabindex="-1" id="GPU-å½’å¹¶æ’åºæµç¨‹">GPU å½’å¹¶æ’åºæµç¨‹</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. Block å†…æ’åºï¼ˆç”¨å…±äº«å†…å­˜ï¼‰</span><br><span class="line">2. è·¨ Block å½’å¹¶ï¼ˆç”¨å¹¶è¡Œå½’å¹¶ï¼‰</span><br></pre></td></tr></table></figure><p><strong>Block å†…æ’åº</strong>å¯ä»¥ç”¨ï¼š</p><ul><li>æ¯”ç‰¹åºåˆ—æ’åºï¼ˆBitonic Sortï¼‰</li><li>å¥‡å¶å½’å¹¶æ’åº</li><li>ç›´æ¥å½’å¹¶æ’åº</li></ul><h3 id="block-nei-pai-xu" tabindex="-1" id="Block-å†…æ’åº">Block å†…æ’åº</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">__global__ void block_sort(int *data, int n) &#123;</span><br><span class="line">    __shared__ int s_data[BLOCK_SIZE];</span><br><span class="line">    </span><br><span class="line">    int tid = threadIdx.x;</span><br><span class="line">    int gid = blockIdx.x * blockDim.x + tid;</span><br><span class="line">    </span><br><span class="line">    // åŠ è½½</span><br><span class="line">    s_data[tid] = (gid &lt; n) ? data[gid] : INT_MAX;</span><br><span class="line">    __syncthreads();</span><br><span class="line">    </span><br><span class="line">    // åŒè°ƒæ’åºï¼ˆBitonic Sortï¼‰</span><br><span class="line">    for (int k = 2; k &lt;= BLOCK_SIZE; k *= 2) &#123;</span><br><span class="line">        for (int j = k / 2; j &gt; 0; j /= 2) &#123;</span><br><span class="line">            int ixj = tid ^ j;</span><br><span class="line">            if (ixj &gt; tid) &#123;</span><br><span class="line">                bool ascending = ((tid &amp; k) == 0);</span><br><span class="line">                if ((s_data[tid] &gt; s_data[ixj]) == ascending) &#123;</span><br><span class="line">                    // äº¤æ¢</span><br><span class="line">                    int temp = s_data[tid];</span><br><span class="line">                    s_data[tid] = s_data[ixj];</span><br><span class="line">                    s_data[ixj] = temp;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            __syncthreads();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // å†™å›</span><br><span class="line">    if (gid &lt; n) data[gid] = s_data[tid];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="kua-block-gui-bing" tabindex="-1" id="è·¨-Block-å½’å¹¶">è·¨ Block å½’å¹¶</h3><p>ä½¿ç”¨ç¬¬åäºŒç« çš„å¹¶è¡Œå½’å¹¶æŠ€æœ¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">void merge_sort_gpu(int *data, int n) &#123;</span><br><span class="line">    // é˜¶æ®µ 1ï¼šBlock å†…æ’åº</span><br><span class="line">    int num_blocks = (n + BLOCK_SIZE - 1) / BLOCK_SIZE;</span><br><span class="line">    block_sort&lt;&lt;&lt;num_blocks, BLOCK_SIZE&gt;&gt;&gt;(data, n);</span><br><span class="line">    </span><br><span class="line">    // é˜¶æ®µ 2ï¼šé€å±‚å½’å¹¶</span><br><span class="line">    for (int width = BLOCK_SIZE; width &lt; n; width *= 2) &#123;</span><br><span class="line">        int num_merges = (n + 2 * width - 1) / (2 * width);</span><br><span class="line">        </span><br><span class="line">        parallel_merge&lt;&lt;&lt;num_merges, BLOCK_SIZE&gt;&gt;&gt;(</span><br><span class="line">            data, n, width);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="fu-za-du-fen-xi" tabindex="-1" id="å¤æ‚åº¦åˆ†æ">å¤æ‚åº¦åˆ†æ</h3><table><thead><tr><th>é˜¶æ®µ</th><th>å·¥ä½œé‡</th><th>å¹¶è¡Œåº¦</th></tr></thead><tbody><tr><td>Block æ’åº</td><td>O(n log B)</td><td>n/B ä¸ª Block</td></tr><tr><td>å½’å¹¶ k å±‚</td><td>O(n) Ã— log(n/B)</td><td>é€’å‡</td></tr><tr><td><strong>æ€»è®¡</strong></td><td>O(n log n)</td><td></td></tr></tbody></table><h2 id="yang-ben-pai-xu-sample-sort" tabindex="-1" id="æ ·æœ¬æ’åºï¼ˆSample-Sortï¼‰">æ ·æœ¬æ’åºï¼ˆSample Sortï¼‰</h2><h3 id="si-xiang" tabindex="-1" id="æ€æƒ³">æ€æƒ³</h3><ol><li><strong>é‡‡æ ·</strong>ï¼šä»æ•°æ®ä¸­éšæœºé€‰å–æ ·æœ¬</li><li><strong>æ’åºæ ·æœ¬</strong>ï¼šå¾—åˆ°åˆ†å‰²ç‚¹ï¼ˆsplittersï¼‰</li><li><strong>åˆ†åŒº</strong>ï¼šæ ¹æ®åˆ†å‰²ç‚¹æŠŠæ•°æ®åˆ†åˆ°ä¸åŒæ¡¶</li><li><strong>æ¡¶æ’åº</strong>ï¼šæ¯ä¸ªæ¡¶ç‹¬ç«‹æ’åº</li><li><strong>åˆå¹¶</strong>ï¼šæŒ‰é¡ºåºæ‹¼æ¥æ‰€æœ‰æ¡¶</li></ol><h3 id="you-shi" tabindex="-1" id="ä¼˜åŠ¿">ä¼˜åŠ¿</h3><ul><li>è´Ÿè½½å‡è¡¡æ›´å¥½ï¼ˆé‡‡æ ·ä¿è¯æ¡¶å¤§å°æ¥è¿‘ï¼‰</li><li>å‡å°‘åŒæ­¥å¼€é”€ï¼ˆæ¡¶é—´ç‹¬ç«‹ï¼‰</li></ul><h3 id="gpu-shi-xian-yao-dian" tabindex="-1" id="GPU-å®ç°è¦ç‚¹">GPU å®ç°è¦ç‚¹</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">void sample_sort(int *data, int n) &#123;</span><br><span class="line">    // 1. é‡‡æ ·</span><br><span class="line">    int sample_size = min(n, 1024);</span><br><span class="line">    sample_and_sort(data, n, samples, sample_size);</span><br><span class="line">    </span><br><span class="line">    // 2. é€‰æ‹©åˆ†å‰²ç‚¹</span><br><span class="line">    int num_buckets = 256;</span><br><span class="line">    select_splitters(samples, sample_size, splitters, num_buckets);</span><br><span class="line">    </span><br><span class="line">    // 3. åˆ†åŒº</span><br><span class="line">    partition_to_buckets(data, n, splitters, bucket_ids, bucket_counts);</span><br><span class="line">    </span><br><span class="line">    // 4. å‰ç¼€å’Œå¾—åˆ°æ¡¶åç§»</span><br><span class="line">    exclusive_scan(bucket_counts, bucket_offsets, num_buckets);</span><br><span class="line">    </span><br><span class="line">    // 5. é‡æ’åˆ°æ¡¶</span><br><span class="line">    scatter_to_buckets(data, bucket_ids, bucket_offsets, temp, n);</span><br><span class="line">    </span><br><span class="line">    // 6. æ¡¶å†…æ’åº</span><br><span class="line">    for (int b = 0; b &lt; num_buckets; b++) &#123;</span><br><span class="line">        int start = bucket_offsets[b];</span><br><span class="line">        int end = bucket_offsets[b + 1];</span><br><span class="line">        sort_bucket&lt;&lt;&lt;...&gt;&gt;&gt;(temp + start, end - start);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 7. æ‹·è´å›</span><br><span class="line">    cudaMemcpy(data, temp, n * sizeof(int), cudaMemcpyDeviceToDevice);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="pai-xu-wen-ding-xing" tabindex="-1" id="æ’åºç¨³å®šæ€§">æ’åºç¨³å®šæ€§</h2><h3 id="wei-shi-yao-zhong-yao" tabindex="-1" id="ä¸ºä»€ä¹ˆé‡è¦">ä¸ºä»€ä¹ˆé‡è¦</h3><p><strong>ç¨³å®šæ’åº</strong>ï¼šç›¸åŒé”®å€¼çš„å…ƒç´ ä¿æŒåŸæœ‰çš„ç›¸å¯¹é¡ºåºã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">åŸå§‹:    [(3,&#x27;a&#x27;), (1,&#x27;b&#x27;), (3,&#x27;c&#x27;), (2,&#x27;d&#x27;)]</span><br><span class="line">æŒ‰æ•°å­—ç¨³å®šæ’åº:</span><br><span class="line">         [(1,&#x27;b&#x27;), (2,&#x27;d&#x27;), (3,&#x27;a&#x27;), (3,&#x27;c&#x27;)]</span><br><span class="line">                          â†‘ &#x27;a&#x27; ä»åœ¨ &#x27;c&#x27; å‰é¢</span><br></pre></td></tr></table></figure><p><strong>åº”ç”¨</strong>ï¼š</p><ul><li>å¤šå…³é”®å­—æ’åºï¼ˆå…ˆæŒ‰æ¬¡å…³é”®å­—ï¼Œå†æŒ‰ä¸»å…³é”®å­—ï¼‰</li><li>æ•°æ®åº“æ“ä½œï¼ˆä¿æŒæ’å…¥é¡ºåºï¼‰</li><li>åŸºæ•°æ’åºçš„æ­£ç¡®æ€§ä¾èµ–ç¨³å®šæ€§</li></ul><h3 id="gpu-pai-xu-de-wen-ding-xing" tabindex="-1" id="GPU-æ’åºçš„ç¨³å®šæ€§">GPU æ’åºçš„ç¨³å®šæ€§</h3><table><thead><tr><th>ç®—æ³•</th><th>ç¨³å®šæ€§</th></tr></thead><tbody><tr><td>åŸºæ•°æ’åº</td><td>ç¨³å®š</td></tr><tr><td>å½’å¹¶æ’åº</td><td>ç¨³å®š</td></tr><tr><td>åŒè°ƒæ’åº</td><td>ä¸ç¨³å®š</td></tr><tr><td>å¿«é€Ÿæ’åº</td><td>ä¸ç¨³å®š</td></tr></tbody></table><p>åŸºæ•°æ’åºå¤©ç„¶ç¨³å®šï¼Œæ˜¯ GPU æ’åºçš„é¦–é€‰ã€‚</p><h2 id="cub-thrust-ku" tabindex="-1" id="CUB-Thrust-åº“">CUB/Thrust åº“</h2><h3 id="shi-yong-thrust" tabindex="-1" id="ä½¿ç”¨-Thrust">ä½¿ç”¨ Thrust</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;thrust/sort.h&gt;</span><br><span class="line">#include &lt;thrust/device_vector.h&gt;</span><br><span class="line"></span><br><span class="line">void sortWithThrust(int *d_data, int n) &#123;</span><br><span class="line">    thrust::device_ptr&lt;int&gt; d_ptr(d_data);</span><br><span class="line">    thrust::sort(d_ptr, d_ptr + n);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// ç¨³å®šæ’åº</span><br><span class="line">thrust::stable_sort(d_ptr, d_ptr + n);</span><br><span class="line"></span><br><span class="line">// æŒ‰é”®æ’åº</span><br><span class="line">thrust::sort_by_key(d_keys, d_keys + n, d_values);</span><br></pre></td></tr></table></figure><h3 id="shi-yong-cub" tabindex="-1" id="ä½¿ç”¨-CUB">ä½¿ç”¨ CUB</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;cub/cub.cuh&gt;</span><br><span class="line"></span><br><span class="line">void sortWithCub(unsigned int *d_data, int n) &#123;</span><br><span class="line">    void *d_temp = nullptr;</span><br><span class="line">    size_t temp_bytes = 0;</span><br><span class="line">    </span><br><span class="line">    // ç¡®å®šä¸´æ—¶å­˜å‚¨å¤§å°</span><br><span class="line">    cub::DeviceRadixSort::SortKeys(d_temp, temp_bytes, </span><br><span class="line">                                    d_data, d_data, n);</span><br><span class="line">    </span><br><span class="line">    cudaMalloc(&amp;d_temp, temp_bytes);</span><br><span class="line">    </span><br><span class="line">    // æ‰§è¡Œæ’åº</span><br><span class="line">    cub::DeviceRadixSort::SortKeys(d_temp, temp_bytes,</span><br><span class="line">                                    d_data, d_data, n);</span><br><span class="line">    </span><br><span class="line">    cudaFree(d_temp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// é”®å€¼å¯¹æ’åº</span><br><span class="line">cub::DeviceRadixSort::SortPairs(d_temp, temp_bytes,</span><br><span class="line">                                 d_keys, d_keys,</span><br><span class="line">                                 d_values, d_values, n);</span><br></pre></td></tr></table></figure><h3 id="xing-neng-dui-bi" tabindex="-1" id="æ€§èƒ½å¯¹æ¯”">æ€§èƒ½å¯¹æ¯”</h3><p>ä»¥ 1 äº¿ä¸ª 32 ä½æ•´æ•°ä¸ºä¾‹ï¼ˆRTX 3090ï¼‰ï¼š</p><table><thead><tr><th>åº“/å®ç°</th><th>æ—¶é—´</th><th>ååé‡</th></tr></thead><tbody><tr><td>std::sort (CPU)</td><td>~8 ç§’</td><td>50 M/s</td></tr><tr><td>Thrust sort</td><td>~30 ms</td><td>3.3 G/s</td></tr><tr><td>CUB RadixSort</td><td>~15 ms</td><td>6.6 G/s</td></tr></tbody></table><p>GPU æ’åºæ¯” CPU å¿« 200-500 å€ã€‚</p><h2 id="xing-neng-you-hua-zong-jie" tabindex="-1" id="æ€§èƒ½ä¼˜åŒ–æ€»ç»“">æ€§èƒ½ä¼˜åŒ–æ€»ç»“</h2><h3 id="you-hua-ceng-ci" tabindex="-1" id="ä¼˜åŒ–å±‚æ¬¡">ä¼˜åŒ–å±‚æ¬¡</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ Level 4: ç®—æ³•é€‰æ‹©                                â”‚</span><br><span class="line">â”‚   - åŸºæ•°æ’åºï¼ˆæ•´æ•°æœ€å¿«ï¼‰                         â”‚</span><br><span class="line">â”‚   - å½’å¹¶æ’åºï¼ˆé€šç”¨ç¨³å®šï¼‰                         â”‚</span><br><span class="line">â”‚   - æ ·æœ¬æ’åºï¼ˆè´Ÿè½½å‡è¡¡ï¼‰                         â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚ Level 3: æ•°æ®å±€éƒ¨æ€§                              â”‚</span><br><span class="line">â”‚   - Block å†…å…±äº«å†…å­˜æ’åº                         â”‚</span><br><span class="line">â”‚   - å‘é‡åŒ–åŠ è½½/å­˜å‚¨                              â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚ Level 2: å‡å°‘åŒæ­¥                                â”‚</span><br><span class="line">â”‚   - Warp å†…æ’åºæ— éœ€åŒæ­¥                          â”‚</span><br><span class="line">â”‚   - å‡å°‘ Kernel å¯åŠ¨æ¬¡æ•°                         â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚ Level 1: åˆ©ç”¨å‰ç¼€å’Œ                              â”‚</span><br><span class="line">â”‚   - é«˜æ•ˆçš„ç›´æ–¹å›¾å’Œåˆ†é…                           â”‚</span><br><span class="line">â”‚   - é¿å…åŸå­æ“ä½œäº‰ç”¨                             â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure><h3 id="xuan-ze-zhi-nan" tabindex="-1" id="é€‰æ‹©æŒ‡å—">é€‰æ‹©æŒ‡å—</h3><table><thead><tr><th>æ•°æ®ç±»å‹</th><th>æ¨èç®—æ³•</th></tr></thead><tbody><tr><td>32 ä½æ•´æ•°</td><td>åŸºæ•°æ’åº</td></tr><tr><td>64 ä½æ•´æ•°</td><td>åŸºæ•°æ’åº</td></tr><tr><td>æµ®ç‚¹æ•°</td><td>åŸºæ•°æ’åº</td></tr><tr><td>ç»“æ„ä½“/è‡ªå®šä¹‰</td><td>å½’å¹¶æ’åº</td></tr><tr><td>éœ€è¦ç¨³å®šæ€§</td><td>åŸºæ•°/å½’å¹¶</td></tr></tbody></table><p>æµ®ç‚¹æ•°éœ€è¦ç‰¹æ®Šå¤„ç†ç¬¦å·ä½å’ŒæŒ‡æ•°ã€‚</p><h2 id="xiao-jie" tabindex="-1" id="å°ç»“">å°ç»“</h2><p>ç¬¬åä¸‰ç« ç³»ç»Ÿè®²è§£ GPU æ’åºï¼š</p><p><strong>åŸºæ•°æ’åº</strong>ï¼šGPU ä¸Šæœ€å¿«çš„æ•´æ•°æ’åºã€‚æŒ‰ä½å¤„ç†ï¼Œåˆ©ç”¨å‰ç¼€å’Œç¡®å®šè¾“å‡ºä½ç½®ã€‚å¤šè½®ï¼ˆ32 ä½éœ€è¦ 8 è½® 4 ä½ï¼‰ä½†æ¯è½®é«˜åº¦å¹¶è¡Œã€‚</p><p><strong>ä¸‰é˜¶æ®µæµç¨‹</strong>ï¼šç›´æ–¹å›¾ç»Ÿè®¡ â†’ å‰ç¼€å’Œè®¡ç®— â†’ å…ƒç´ é‡æ’ã€‚æ¯ä¸ªé˜¶æ®µéƒ½æ˜¯é«˜æ•ˆçš„å¹¶è¡Œæ“ä½œã€‚</p><p><strong>å½’å¹¶æ’åº</strong>ï¼šé€šç”¨ä¸”ç¨³å®šã€‚Block å†…ç”¨åŒè°ƒæ’åºï¼Œè·¨ Block ç”¨å¹¶è¡Œå½’å¹¶ã€‚é€‚åˆä»»æ„å¯æ¯”è¾ƒç±»å‹ã€‚</p><p><strong>æ ·æœ¬æ’åº</strong>ï¼šé€šè¿‡é‡‡æ ·å®ç°è´Ÿè½½å‡è¡¡ã€‚é€‚åˆæ•°æ®åˆ†å¸ƒä¸å‡åŒ€çš„æƒ…å†µã€‚</p><p><strong>ç¨³å®šæ€§</strong>ï¼šåŸºæ•°æ’åºå¤©ç„¶ç¨³å®šï¼Œå¤šå…³é”®å­—æ’åºå’Œæ•°æ®åº“æ“ä½œå¿…éœ€ã€‚</p><p><strong>åº“ä¼˜å…ˆ</strong>ï¼šCUB çš„ RadixSort é«˜åº¦ä¼˜åŒ–ï¼Œç”Ÿäº§ç¯å¢ƒç›´æ¥ä½¿ç”¨ã€‚ç†è§£åŸç†æœ‰åŠ©äºç‰¹æ®Šéœ€æ±‚çš„å®šåˆ¶ã€‚</p><p>æ’åºæ˜¯å¹¶è¡Œè®¡ç®—çš„è¯•é‡‘çŸ³ï¼ŒæŠŠå‰é¢å­¦çš„å½’çº¦ã€å‰ç¼€å’Œã€å½’å¹¶ç­‰æŠ€æœ¯ç»¼åˆè¿ç”¨ã€‚æŒæ¡ GPU æ’åºï¼Œå°±æŒæ¡äº†è¿™äº›åŸºç¡€åŸè¯­çš„å®æˆ˜åº”ç”¨ã€‚</p><hr><p><strong>å‚è€ƒèµ„æ–™ï¼š</strong></p><ul><li>Hwu, W., Kirk, D., &amp; El Hajj, I. (2022). <em>Programming Massively Parallel Processors: A Hands-on Approach</em> (4th Edition). Morgan Kaufmann.</li><li>Satish, N., Harris, M., &amp; Garland, M. (2009). <em>Designing efficient sorting algorithms for manycore GPUs</em>. IPDPS.</li><li><a href="https://nvlabs.github.io/cub/structcub_1_1_device_radix_sort.html">NVIDIA CUB Library - Radix Sort</a></li></ul><hr><blockquote><p><strong>æœ¬æ–‡ GitHub ä»“åº“</strong>: <a href="https://github.com/psmarter/PMPP-Learning">https://github.com/psmarter/PMPP-Learning</a></p></blockquote>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;qian-yan&quot; tabindex=&quot;-1&quot; id=&quot;å‰è¨€&quot;&gt;å‰è¨€&lt;/h2&gt;
&lt;p&gt;å‰ä¸¤ç« å­¦äº†å½’çº¦å’Œå½’å¹¶ï¼Œè¿™ç« å­¦&lt;strong&gt;æ’åº&lt;/strong&gt;â€”â€”æŠŠæ— åºæ•°æ®å˜æˆæœ‰åºæ•°æ®ã€‚æ’åºæ˜¯æœ€åŸºç¡€çš„ç®—æ³•ä¹‹ä¸€ï¼Œå‡ ä¹æ‰€æœ‰é¢†åŸŸéƒ½ç”¨å¾—åˆ°ã€‚GPU</summary>
        
      
    
    
    
    <category term="çŸ¥è¯†åˆ†äº«" scheme="https://smarter.xin/categories/knowledge-sharing/"/>
    
    
    <category term="CUDA" scheme="https://smarter.xin/tags/CUDA/"/>
    
    <category term="GPUç¼–ç¨‹" scheme="https://smarter.xin/tags/gpu-programming/"/>
    
    <category term="å¹¶è¡Œè®¡ç®—" scheme="https://smarter.xin/tags/parallel-computing/"/>
    
    <category term="PMPP" scheme="https://smarter.xin/tags/PMPP/"/>
    
    <category term="æ’åº" scheme="https://smarter.xin/tags/sort/"/>
    
    <category term="åŸºæ•°æ’åº" scheme="https://smarter.xin/tags/radix-sort/"/>
    
    <category term="å½’å¹¶æ’åº" scheme="https://smarter.xin/tags/merge-sort/"/>
    
  </entry>
  
  <entry>
    <title>PMPP-ç¬¬åäºŒç« ï¼šå½’å¹¶</title>
    <link href="https://smarter.xin/posts/31928809/"/>
    <id>https://smarter.xin/posts/31928809/</id>
    <published>2026-01-18T13:42:06.000Z</published>
    <updated>2026-01-24T08:26:21.332Z</updated>
    
    <content type="html"><![CDATA[<h2 id="qian-yan" tabindex="-1" id="å‰è¨€">å‰è¨€</h2><p>ç¬¬åä¸€ç« å­¦äº†å‰ç¼€å’Œï¼Œè¿™ç« å­¦<strong>å½’å¹¶ï¼ˆMergeï¼‰</strong>â€”â€”æŠŠä¸¤ä¸ªæœ‰åºæ•°ç»„åˆå¹¶æˆä¸€ä¸ªæœ‰åºæ•°ç»„ã€‚å½’å¹¶æ˜¯æ’åºç®—æ³•çš„æ ¸å¿ƒç»„ä»¶ï¼ˆå½’å¹¶æ’åºï¼‰ï¼Œä¹Ÿæ˜¯æ•°æ®åº“æ“ä½œçš„åŸºç¡€ï¼ˆJOINï¼‰ã€‚å¹¶è¡Œå½’å¹¶çš„æŒ‘æˆ˜åœ¨äºï¼š<strong>è¾“å‡ºä½ç½®å–å†³äºä¸¤ä¸ªæ•°ç»„çš„æ•°æ®å†…å®¹</strong>ï¼Œä¸åƒçŸ©é˜µä¹˜æ³•é‚£æ ·ä½ç½®å›ºå®šã€‚ç¬¬åäºŒç« è®²è§£å¦‚ä½•ç”¨**ååŒæ’åï¼ˆCo-Rankï¼‰**æŠ€æœ¯è§£å†³è¿™ä¸ª&quot;åŠ¨æ€è¾“å…¥æ•°æ®è¯†åˆ«&quot;é—®é¢˜ã€‚</p><blockquote><p><strong>ğŸ“¦ é…å¥—èµ„æº</strong>ï¼šæœ¬ç³»åˆ—æ–‡ç« é…æœ‰å®Œæ•´çš„ <a href="https://github.com/psmarter/PMPP-Learning">GitHub ä»“åº“</a>ï¼ŒåŒ…å«æ¯ç« çš„ç»ƒä¹ é¢˜è§£ç­”ã€CUDA ä»£ç å®ç°å’Œè¯¦ç»†æ³¨é‡Šã€‚æ‰€æœ‰ä»£ç éƒ½ç»è¿‡æµ‹è¯•ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œã€‚</p></blockquote><h2 id="gui-bing-ji-chu" tabindex="-1" id="å½’å¹¶åŸºç¡€">å½’å¹¶åŸºç¡€</h2><h3 id="shi-yao-shi-gui-bing" tabindex="-1" id="ä»€ä¹ˆæ˜¯å½’å¹¶">ä»€ä¹ˆæ˜¯å½’å¹¶</h3><p><strong>å½’å¹¶</strong>ï¼šç»™å®šä¸¤ä¸ª<strong>å·²æ’åº</strong>çš„æ•°ç»„ A å’Œ Bï¼Œç”Ÿæˆä¸€ä¸ªåŒ…å«æ‰€æœ‰å…ƒç´ çš„<strong>æœ‰åº</strong>æ•°ç»„ Cã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">A = [1, 3, 5, 7, 9]</span><br><span class="line">B = [2, 4, 6, 8, 10]</span><br><span class="line">C = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]</span><br></pre></td></tr></table></figure><h3 id="chuan-xing-gui-bing" tabindex="-1" id="ä¸²è¡Œå½’å¹¶">ä¸²è¡Œå½’å¹¶</h3><p>ç»å…¸çš„åŒæŒ‡é’ˆç®—æ³•ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">merge_sequential</span><span class="params">(<span class="type">int</span> *A, <span class="type">int</span> m, <span class="type">int</span> *B, <span class="type">int</span> n, <span class="type">int</span> *C)</span> &#123;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>, k = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (i &lt; m &amp;&amp; j &lt; n) &#123;</span><br><span class="line">        <span class="keyword">if</span> (A[i] &lt;= B[j]) &#123;</span><br><span class="line">            C[k++] = A[i++];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            C[k++] = B[j++];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¤„ç†å‰©ä½™å…ƒç´ </span></span><br><span class="line">    <span class="keyword">while</span> (i &lt; m) C[k++] = A[i++];</span><br><span class="line">    <span class="keyword">while</span> (j &lt; n) C[k++] = B[j++];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ—¶é—´å¤æ‚åº¦ O(m+n)ï¼Œç©ºé—´å¤æ‚åº¦ O(1)ï¼ˆä¸è®¡è¾“å‡ºï¼‰ã€‚</p><h3 id="bing-xing-hua-de-tiao-zhan" tabindex="-1" id="å¹¶è¡ŒåŒ–çš„æŒ‘æˆ˜">å¹¶è¡ŒåŒ–çš„æŒ‘æˆ˜</h3><p><strong>é—®é¢˜</strong>ï¼šè¾“å‡ºä½ç½® k å¯¹åº”çš„è¾“å…¥ä½ç½® (i, j) å–å†³äºæ•°æ®å†…å®¹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">è¦å¡«å…… C[5]ï¼Œéœ€è¦çŸ¥é“ï¼š</span><br><span class="line">- A å’Œ B ä¸­æœ‰å¤šå°‘å…ƒç´  â‰¤ C[5] çš„å€¼</span><br><span class="line">- è¿™å–å†³äº A å’Œ B çš„å…·ä½“å†…å®¹</span><br></pre></td></tr></table></figure><p>ä¸åƒçŸ©é˜µä¹˜æ³•é‚£æ ·å¯ä»¥æ ¹æ®çº¿ç¨‹ ID ç›´æ¥è®¡ç®—è¾“å…¥ä½ç½®ã€‚</p><p><strong>æ ¸å¿ƒé—®é¢˜</strong>ï¼šå¦‚ä½•è®©æ¯ä¸ªçº¿ç¨‹çŸ¥é“è‡ªå·±åº”è¯¥å¤„ç† A å’Œ B çš„å“ªä¸€æ®µï¼Ÿ</p><h2 id="xie-tong-pai-ming-co-rank" tabindex="-1" id="ååŒæ’åï¼ˆCo-Rankï¼‰">ååŒæ’åï¼ˆCo-Rankï¼‰</h2><h3 id="he-xin-dong-cha" tabindex="-1" id="æ ¸å¿ƒæ´å¯Ÿ">æ ¸å¿ƒæ´å¯Ÿ</h3><p>å¯¹äºè¾“å‡ºä½ç½® kï¼Œå‡è®¾å®ƒå¯¹åº” A ä¸­çš„å‰ i ä¸ªå…ƒç´ å’Œ B ä¸­çš„å‰ j ä¸ªå…ƒç´ ï¼Œåˆ™ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">i + j = k</span><br></pre></td></tr></table></figure><p>è¿™å°±æ˜¯<strong>ååŒæ’å</strong>çº¦æŸã€‚</p><p><strong>é—®é¢˜è½¬åŒ–</strong>ï¼šç»™å®š kï¼Œæ‰¾åˆ°æ»¡è¶³çº¦æŸä¸”ä¿æŒæœ‰åºæ€§çš„ (i, j)ã€‚</p><h3 id="er-fen-sou-suo-jie-fa" tabindex="-1" id="äºŒåˆ†æœç´¢è§£æ³•">äºŒåˆ†æœç´¢è§£æ³•</h3><p><strong>æœ‰åºæ€§æ¡ä»¶</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">A[i-1] â‰¤ B[j]  ä¸”  B[j-1] â‰¤ A[i]</span><br></pre></td></tr></table></figure><p>å³ï¼šA ä¸­ç¬¬ i ä¸ªå…ƒç´ åº”è¯¥æ’åœ¨ B çš„ç¬¬ j ä¸ªå…ƒç´ ä¹‹å‰æˆ–ç›¸ç­‰ï¼Œåä¹‹äº¦ç„¶ã€‚</p><p><strong>ç®—æ³•</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">co_rank</span><span class="params">(<span class="type">int</span> k, <span class="type">int</span> *A, <span class="type">int</span> m, <span class="type">int</span> *B, <span class="type">int</span> n)</span> &#123;</span><br><span class="line">    <span class="comment">// i çš„èŒƒå›´</span></span><br><span class="line">    <span class="type">int</span> i_low = max(<span class="number">0</span>, k - n);</span><br><span class="line">    <span class="type">int</span> i_high = min(k, m);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (i_low &lt; i_high) &#123;</span><br><span class="line">        <span class="type">int</span> i = (i_low + i_high) / <span class="number">2</span>;</span><br><span class="line">        <span class="type">int</span> j = k - i;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (i &gt; <span class="number">0</span> &amp;&amp; j &lt; n &amp;&amp; A[i<span class="number">-1</span>] &gt; B[j]) &#123;</span><br><span class="line">            <span class="comment">// A[i-1] å¤ªå¤§ï¼Œi éœ€è¦å‡å°</span></span><br><span class="line">            i_high = i;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (j &gt; <span class="number">0</span> &amp;&amp; i &lt; m &amp;&amp; B[j<span class="number">-1</span>] &gt; A[i]) &#123;</span><br><span class="line">            <span class="comment">// B[j-1] å¤ªå¤§ï¼Œi éœ€è¦å¢å¤§</span></span><br><span class="line">            i_low = i + <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// æ‰¾åˆ°äº†</span></span><br><span class="line">            <span class="keyword">return</span> i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> i_low;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ—¶é—´å¤æ‚åº¦</strong>ï¼šO(log(min(k, m, n)))</p><h3 id="shi-li" tabindex="-1" id="ç¤ºä¾‹">ç¤ºä¾‹</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">A = [1, 3, 5, 7, 9]  (m=5)</span><br><span class="line">B = [2, 4, 6, 8, 10] (n=5)</span><br><span class="line">k = 6ï¼ˆè¾“å‡ºä½ç½® 6ï¼‰</span><br><span class="line"></span><br><span class="line">i + j = 6</span><br><span class="line"></span><br><span class="line">å°è¯• i=3: j=3</span><br><span class="line">  A[2]=5 â‰¤ B[3]=8? âœ“</span><br><span class="line">  B[2]=6 â‰¤ A[3]=7? âœ“</span><br><span class="line">  æ‰¾åˆ°ï¼</span><br><span class="line"></span><br><span class="line">æ‰€ä»¥ C[0..5] æ¥è‡ª A[0..2] å’Œ B[0..2]</span><br><span class="line">C[6..9] æ¥è‡ª A[3..4] å’Œ B[3..4]</span><br></pre></td></tr></table></figure><h2 id="ji-chu-bing-xing-gui-bing" tabindex="-1" id="åŸºç¡€å¹¶è¡Œå½’å¹¶">åŸºç¡€å¹¶è¡Œå½’å¹¶</h2><h3 id="mei-xian-cheng-yi-ge-yuan-su" tabindex="-1" id="æ¯çº¿ç¨‹ä¸€ä¸ªå…ƒç´ ">æ¯çº¿ç¨‹ä¸€ä¸ªå…ƒç´ </h3><p>æœ€ç®€å•çš„å¹¶è¡ŒåŒ–ï¼šæ¯ä¸ªçº¿ç¨‹è´Ÿè´£è®¡ç®—ä¸€ä¸ªè¾“å‡ºå…ƒç´ ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">__global__ void merge_basic(int *A, int m, int *B, int n, int *C) &#123;</span><br><span class="line">    int k = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">    </span><br><span class="line">    if (k &lt; m + n) &#123;</span><br><span class="line">        int i = co_rank(k, A, m, B, n);</span><br><span class="line">        int j = k - i;</span><br><span class="line">        </span><br><span class="line">        int i_next = co_rank(k + 1, A, m, B, n);</span><br><span class="line">        int j_next = k + 1 - i_next;</span><br><span class="line">        </span><br><span class="line">        // ç¡®å®šè¿™ä¸ªä½ç½®çš„å€¼</span><br><span class="line">        if (i_next &gt; i) &#123;</span><br><span class="line">            C[k] = A[i];</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            C[k] = B[j];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="wen-ti" tabindex="-1" id="é—®é¢˜">é—®é¢˜</h3><p><strong>æ•ˆç‡ä½</strong>ï¼šæ¯ä¸ªçº¿ç¨‹éƒ½åšä¸€æ¬¡äºŒåˆ†æœç´¢ï¼ˆO(log n)ï¼‰ï¼Œæ€»å·¥ä½œé‡ O(n log n)ã€‚</p><p>ä¸²è¡Œåªéœ€ O(n)ï¼Œå¹¶è¡Œåè€Œåšäº†æ›´å¤šå·¥ä½œï¼</p><h2 id="fen-kuai-bing-xing-gui-bing" tabindex="-1" id="åˆ†å—å¹¶è¡Œå½’å¹¶">åˆ†å—å¹¶è¡Œå½’å¹¶</h2><h3 id="si-lu" tabindex="-1" id="æ€è·¯">æ€è·¯</h3><p>ä¸è¦æ¯ä¸ªå…ƒç´ éƒ½äºŒåˆ†æœç´¢ï¼Œè€Œæ˜¯ï¼š</p><ol><li>æŠŠè¾“å‡ºåˆ†æˆè‹¥å¹²å—ï¼ˆTileï¼‰</li><li>æ¯ä¸ª Tile åšä¸€æ¬¡ Co-Rank æ‰¾åˆ°è¾¹ç•Œ</li><li>Tile å†…éƒ¨ç”¨ä¸²è¡Œå½’å¹¶</li></ol><h3 id="suan-fa" tabindex="-1" id="ç®—æ³•">ç®—æ³•</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">è¾“å‡ºå¤§å°ï¼šm + n</span><br><span class="line">Tile å¤§å°ï¼šT</span><br><span class="line">Tile æ•°é‡ï¼š(m + n + T - 1) / T</span><br><span class="line"></span><br><span class="line">å¯¹äº Tile kï¼š</span><br><span class="line">  èµ·å§‹ä½ç½®ï¼šk * T</span><br><span class="line">  ç»“æŸä½ç½®ï¼šmin((k+1) * T, m+n)</span><br><span class="line">  </span><br><span class="line">  Co-Rank æ‰¾åˆ° (i_start, j_start) å’Œ (i_end, j_end)</span><br><span class="line">  </span><br><span class="line">  å½’å¹¶ A[i_start..i_end] å’Œ B[j_start..j_end]</span><br></pre></td></tr></table></figure><h3 id="cuda-shi-xian" tabindex="-1" id="CUDA-å®ç°">CUDA å®ç°</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">#define TILE_SIZE 1024</span><br><span class="line"></span><br><span class="line">__global__ void merge_tiled(int *A, int m, int *B, int n, int *C) &#123;</span><br><span class="line">    // æ¯ä¸ª Block å¤„ç†ä¸€ä¸ª Tile</span><br><span class="line">    int k_start = blockIdx.x * TILE_SIZE;</span><br><span class="line">    int k_end = min(k_start + TILE_SIZE, m + n);</span><br><span class="line">    </span><br><span class="line">    // Co-Rank æ‰¾è¾¹ç•Œ</span><br><span class="line">    __shared__ int i_start, j_start, i_end, j_end;</span><br><span class="line">    </span><br><span class="line">    if (threadIdx.x == 0) &#123;</span><br><span class="line">        i_start = co_rank(k_start, A, m, B, n);</span><br><span class="line">        j_start = k_start - i_start;</span><br><span class="line">        i_end = co_rank(k_end, A, m, B, n);</span><br><span class="line">        j_end = k_end - i_end;</span><br><span class="line">    &#125;</span><br><span class="line">    __syncthreads();</span><br><span class="line">    </span><br><span class="line">    // æ¯ä¸ªçº¿ç¨‹å¤„ç† Tile ä¸­çš„ä¸€éƒ¨åˆ†</span><br><span class="line">    int tile_size = k_end - k_start;</span><br><span class="line">    int elements_per_thread = (tile_size + blockDim.x - 1) / blockDim.x;</span><br><span class="line">    </span><br><span class="line">    int local_k = threadIdx.x * elements_per_thread;</span><br><span class="line">    int local_k_end = min(local_k + elements_per_thread, tile_size);</span><br><span class="line">    </span><br><span class="line">    // çº¿ç¨‹å†… Co-Rank</span><br><span class="line">    int A_seg_size = i_end - i_start;</span><br><span class="line">    int B_seg_size = j_end - j_start;</span><br><span class="line">    </span><br><span class="line">    int local_i = co_rank(local_k, A + i_start, A_seg_size, </span><br><span class="line">                                   B + j_start, B_seg_size);</span><br><span class="line">    int local_j = local_k - local_i;</span><br><span class="line">    </span><br><span class="line">    int local_i_end = co_rank(local_k_end, A + i_start, A_seg_size,</span><br><span class="line">                                           B + j_start, B_seg_size);</span><br><span class="line">    int local_j_end = local_k_end - local_i_end;</span><br><span class="line">    </span><br><span class="line">    // ä¸²è¡Œå½’å¹¶</span><br><span class="line">    merge_sequential(A + i_start + local_i, local_i_end - local_i,</span><br><span class="line">                     B + j_start + local_j, local_j_end - local_j,</span><br><span class="line">                     C + k_start + local_k);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="gong-zuo-liang-fen-xi" tabindex="-1" id="å·¥ä½œé‡åˆ†æ">å·¥ä½œé‡åˆ†æ</h3><table><thead><tr><th>æ“ä½œ</th><th>æ¬¡æ•°</th><th>å•æ¬¡å¤æ‚åº¦</th></tr></thead><tbody><tr><td>Block Co-Rank</td><td>(m+n)/T</td><td>O(log(m+n))</td></tr><tr><td>çº¿ç¨‹ Co-Rank</td><td>(m+n)/T Ã— blockDim</td><td>O(log T)</td></tr><tr><td>ä¸²è¡Œå½’å¹¶</td><td>(m+n)/T Ã— blockDim</td><td>O(T/blockDim)</td></tr></tbody></table><p>æ€»å·¥ä½œé‡ â‰ˆ O(m+n)ï¼Œæ¥è¿‘ä¸²è¡Œï¼</p><h2 id="gong-xiang-nei-cun-you-hua" tabindex="-1" id="å…±äº«å†…å­˜ä¼˜åŒ–">å…±äº«å†…å­˜ä¼˜åŒ–</h2><h3 id="dong-ji" tabindex="-1" id="åŠ¨æœº">åŠ¨æœº</h3><p>å‰é¢çš„å®ç°æ¯ä¸ªçº¿ç¨‹éƒ½è®¿é—®å…¨å±€å†…å­˜åšä¸²è¡Œå½’å¹¶ã€‚å¦‚æœæŠŠ Tile æ•°æ®åŠ è½½åˆ°å…±äº«å†…å­˜ï¼Œå¯ä»¥å¤§å¹…å‡å°‘å…¨å±€å†…å­˜è®¿é—®ã€‚</p><h3 id="shi-xian" tabindex="-1" id="å®ç°">å®ç°</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">#define TILE_SIZE 1024</span><br><span class="line"></span><br><span class="line">__global__ void merge_shared(int *A, int m, int *B, int n, int *C) &#123;</span><br><span class="line">    __shared__ int A_s[TILE_SIZE];</span><br><span class="line">    __shared__ int B_s[TILE_SIZE];</span><br><span class="line">    __shared__ int C_s[TILE_SIZE];</span><br><span class="line">    </span><br><span class="line">    int k_start = blockIdx.x * TILE_SIZE;</span><br><span class="line">    int k_end = min(k_start + TILE_SIZE, m + n);</span><br><span class="line">    int tile_size = k_end - k_start;</span><br><span class="line">    </span><br><span class="line">    // Co-Rank æ‰¾è¾¹ç•Œ</span><br><span class="line">    __shared__ int i_start, j_start, i_end, j_end;</span><br><span class="line">    </span><br><span class="line">    if (threadIdx.x == 0) &#123;</span><br><span class="line">        i_start = co_rank(k_start, A, m, B, n);</span><br><span class="line">        j_start = k_start - i_start;</span><br><span class="line">        i_end = co_rank(k_end, A, m, B, n);</span><br><span class="line">        j_end = k_end - i_end;</span><br><span class="line">    &#125;</span><br><span class="line">    __syncthreads();</span><br><span class="line">    </span><br><span class="line">    int A_size = i_end - i_start;</span><br><span class="line">    int B_size = j_end - j_start;</span><br><span class="line">    </span><br><span class="line">    // åŠ è½½åˆ°å…±äº«å†…å­˜</span><br><span class="line">    for (int i = threadIdx.x; i &lt; A_size; i += blockDim.x) &#123;</span><br><span class="line">        A_s[i] = A[i_start + i];</span><br><span class="line">    &#125;</span><br><span class="line">    for (int i = threadIdx.x; i &lt; B_size; i += blockDim.x) &#123;</span><br><span class="line">        B_s[i] = B[j_start + i];</span><br><span class="line">    &#125;</span><br><span class="line">    __syncthreads();</span><br><span class="line">    </span><br><span class="line">    // çº¿ç¨‹å†… Co-Rankï¼ˆä½¿ç”¨å…±äº«å†…å­˜ï¼‰</span><br><span class="line">    int elements_per_thread = (tile_size + blockDim.x - 1) / blockDim.x;</span><br><span class="line">    int local_k = threadIdx.x * elements_per_thread;</span><br><span class="line">    int local_k_end = min(local_k + elements_per_thread, tile_size);</span><br><span class="line">    </span><br><span class="line">    int local_i = co_rank(local_k, A_s, A_size, B_s, B_size);</span><br><span class="line">    int local_j = local_k - local_i;</span><br><span class="line">    </span><br><span class="line">    int local_i_end = co_rank(local_k_end, A_s, A_size, B_s, B_size);</span><br><span class="line">    int local_j_end = local_k_end - local_i_end;</span><br><span class="line">    </span><br><span class="line">    // å½’å¹¶åˆ°å…±äº«å†…å­˜</span><br><span class="line">    merge_sequential(A_s + local_i, local_i_end - local_i,</span><br><span class="line">                     B_s + local_j, local_j_end - local_j,</span><br><span class="line">                     C_s + local_k);</span><br><span class="line">    __syncthreads();</span><br><span class="line">    </span><br><span class="line">    // å†™å›å…¨å±€å†…å­˜</span><br><span class="line">    for (int i = threadIdx.x; i &lt; tile_size; i += blockDim.x) &#123;</span><br><span class="line">        C[k_start + i] = C_s[i];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="xing-neng-ti-sheng" tabindex="-1" id="æ€§èƒ½æå‡">æ€§èƒ½æå‡</h3><table><thead><tr><th>ç‰ˆæœ¬</th><th>å…¨å±€å†…å­˜è®¿é—®</th><th>æ€§èƒ½</th></tr></thead><tbody><tr><td>åŸºç¡€</td><td>O(m+n) æ¬¡</td><td>1Ã—</td></tr><tr><td>åˆ†å—</td><td>O(m+n) æ¬¡</td><td>~5Ã—</td></tr><tr><td>å…±äº«å†…å­˜</td><td>O(m+n)/T æ¬¡</td><td>~10Ã—</td></tr></tbody></table><h2 id="xun-huan-huan-chong-qu-you-hua" tabindex="-1" id="å¾ªç¯ç¼“å†²åŒºä¼˜åŒ–">å¾ªç¯ç¼“å†²åŒºä¼˜åŒ–</h2><h3 id="wen-ti-1" tabindex="-1" id="é—®é¢˜-2">é—®é¢˜</h3><p>å…±äº«å†…å­˜æœ‰é™ï¼Œå¦‚æœ A_size + B_size &gt; å…±äº«å†…å­˜å®¹é‡æ€ä¹ˆåŠï¼Ÿ</p><h3 id="si-lu-liu-shi-chu-li" tabindex="-1" id="æ€è·¯ï¼šæµå¼å¤„ç†">æ€è·¯ï¼šæµå¼å¤„ç†</h3><p>ç”¨<strong>å¾ªç¯ç¼“å†²åŒº</strong>é€å—å¤„ç†ï¼š</p><ol><li>åŠ è½½ A å’Œ B çš„ä¸€å°å—åˆ°å…±äº«å†…å­˜</li><li>å½’å¹¶èƒ½å½’å¹¶çš„éƒ¨åˆ†</li><li>åŠ è½½ä¸‹ä¸€å—ï¼Œç»§ç»­å½’å¹¶</li><li>é‡å¤ç›´åˆ°å®Œæˆ</li></ol><h3 id="guan-jian-dian" tabindex="-1" id="å…³é”®ç‚¹">å…³é”®ç‚¹</h3><p><strong>æ¶ˆè´¹è·Ÿè¸ª</strong>ï¼šè®°å½• A å’Œ B å„æ¶ˆè´¹äº†å¤šå°‘å…ƒç´ ã€‚</p><p><strong>ç¼“å†²åŒºç®¡ç†</strong>ï¼šå¾ªç¯ä½¿ç”¨ç¼“å†²åŒºç©ºé—´ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">__global__ void merge_circular(int *A, int m, int *B, int n, int *C) &#123;</span><br><span class="line">    __shared__ int buffer_A[BUFFER_SIZE];</span><br><span class="line">    __shared__ int buffer_B[BUFFER_SIZE];</span><br><span class="line">    </span><br><span class="line">    // ... åˆå§‹åŒ– ...</span><br><span class="line">    </span><br><span class="line">    int a_consumed = 0, b_consumed = 0;</span><br><span class="line">    int a_loaded = 0, b_loaded = 0;</span><br><span class="line">    int c_produced = 0;</span><br><span class="line">    </span><br><span class="line">    while (c_produced &lt; tile_size) &#123;</span><br><span class="line">        // å¡«å……ç¼“å†²åŒº</span><br><span class="line">        while (a_loaded - a_consumed &lt; BUFFER_SIZE &amp;&amp; a_loaded &lt; A_size) &#123;</span><br><span class="line">            buffer_A[a_loaded % BUFFER_SIZE] = A_s[a_loaded];</span><br><span class="line">            a_loaded++;</span><br><span class="line">        &#125;</span><br><span class="line">        while (b_loaded - b_consumed &lt; BUFFER_SIZE &amp;&amp; b_loaded &lt; B_size) &#123;</span><br><span class="line">            buffer_B[b_loaded % BUFFER_SIZE] = B_s[b_loaded];</span><br><span class="line">            b_loaded++;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // å½’å¹¶ä¸€æ‰¹</span><br><span class="line">        // ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ç§æŠ€æœ¯åœ¨æ•°æ®é‡è¿œè¶…å…±äº«å†…å­˜æ—¶å¾ˆæœ‰ç”¨ã€‚</p><h2 id="gui-bing-lu-jing-ke-shi-hua" tabindex="-1" id="å½’å¹¶è·¯å¾„å¯è§†åŒ–">å½’å¹¶è·¯å¾„å¯è§†åŒ–</h2><h3 id="co-rank-de-ji-he-jie-shi" tabindex="-1" id="Co-Rank-çš„å‡ ä½•è§£é‡Š">Co-Rank çš„å‡ ä½•è§£é‡Š</h3><p>æŠŠå½’å¹¶è¿‡ç¨‹å¯è§†åŒ–ä¸º 2D ç½‘æ ¼ä¸­çš„è·¯å¾„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">  B: 0   1   2   3   4</span><br><span class="line">     +---+---+---+---+</span><br><span class="line">A:0  |   |   |   |   |</span><br><span class="line">     +---+---+---+---+</span><br><span class="line">  1  |   |   |   |   |</span><br><span class="line">     +---+---+â”€â”€â”€+â”€â”€â”€+</span><br><span class="line">  2  |   |   |\  |   |</span><br><span class="line">     +---+---+â”€\â”€+---+</span><br><span class="line">  3  |   |   |  \|   |</span><br><span class="line">     +---+---+---+\--+</span><br><span class="line">  4  |   |   |   | \ |</span><br><span class="line">     +---+---+---+---+</span><br></pre></td></tr></table></figure><p><strong>è·¯å¾„è§„åˆ™</strong>ï¼š</p><ul><li>ä» (0,0) åˆ° (m,n)</li><li>æ¯æ­¥å‘å³ï¼ˆå– A å…ƒç´ ï¼‰æˆ–å‘ä¸‹ï¼ˆå– B å…ƒç´ ï¼‰</li><li>é€‰æ‹©è¾ƒå°çš„å…ƒç´ å†³å®šæ–¹å‘</li></ul><p><strong>Co-Rank(k)</strong>ï¼šè·¯å¾„ä¸Šç¬¬ k æ­¥çš„ä½ç½®ã€‚</p><h3 id="bing-xing-hua-shi-jiao" tabindex="-1" id="å¹¶è¡ŒåŒ–è§†è§’">å¹¶è¡ŒåŒ–è§†è§’</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">æŠŠè¾“å‡ºåˆ†æˆ T æ®µï¼š</span><br><span class="line">  æ®µ 0: è·¯å¾„ [0, T)</span><br><span class="line">  æ®µ 1: è·¯å¾„ [T, 2T)</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">æ¯æ®µçš„èµ·ç‚¹ç”± Co-Rank ç¡®å®šã€‚</span><br></pre></td></tr></table></figure><h2 id="gui-bing-pai-xu" tabindex="-1" id="å½’å¹¶æ’åº">å½’å¹¶æ’åº</h2><h3 id="fen-zhi-jie-gou" tabindex="-1" id="åˆ†æ²»ç»“æ„">åˆ†æ²»ç»“æ„</h3><p>å½’å¹¶æ’åº = é€’å½’æ‹†åˆ† + å½’å¹¶åˆå¹¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[3,1,7,4,5,2,6,8]</span><br><span class="line">       â†“ æ‹†åˆ†</span><br><span class="line">[3,1,7,4] [5,2,6,8]</span><br><span class="line">    â†“ æ‹†åˆ†</span><br><span class="line">[3,1] [7,4] [5,2] [6,8]</span><br><span class="line">  â†“ æ‹†åˆ†</span><br><span class="line">[3][1] [7][4] [5][2] [6][8]</span><br><span class="line">  â†“ å½’å¹¶</span><br><span class="line">[1,3] [4,7] [2,5] [6,8]</span><br><span class="line">    â†“ å½’å¹¶</span><br><span class="line">[1,3,4,7] [2,5,6,8]</span><br><span class="line">       â†“ å½’å¹¶</span><br><span class="line">[1,2,3,4,5,6,7,8]</span><br></pre></td></tr></table></figure><h3 id="bing-xing-gui-bing-pai-xu" tabindex="-1" id="å¹¶è¡Œå½’å¹¶æ’åº">å¹¶è¡Œå½’å¹¶æ’åº</h3><p>æ¯å±‚å½’å¹¶å¯ä»¥å¹¶è¡Œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">void parallel_merge_sort(int *data, int n) &#123;</span><br><span class="line">    // ä»å•å…ƒç´ å¼€å§‹ï¼Œé€å±‚å½’å¹¶</span><br><span class="line">    for (int width = 1; width &lt; n; width *= 2) &#123;</span><br><span class="line">        int num_merges = (n + 2 * width - 1) / (2 * width);</span><br><span class="line">        </span><br><span class="line">        // å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰å½’å¹¶</span><br><span class="line">        merge_kernel&lt;&lt;&lt;num_merges, BLOCK_SIZE&gt;&gt;&gt;(</span><br><span class="line">            data, n, width</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__global__ void merge_kernel(int *data, int n, int width) &#123;</span><br><span class="line">    int merge_id = blockIdx.x;</span><br><span class="line">    int left = merge_id * 2 * width;</span><br><span class="line">    int mid = min(left + width, n);</span><br><span class="line">    int right = min(left + 2 * width, n);</span><br><span class="line">    </span><br><span class="line">    // å½’å¹¶ [left, mid) å’Œ [mid, right)</span><br><span class="line">    merge_shared(data + left, mid - left, </span><br><span class="line">                 data + mid, right - mid, </span><br><span class="line">                 temp + left);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="fu-za-du" tabindex="-1" id="å¤æ‚åº¦">å¤æ‚åº¦</h3><table><thead><tr><th>æŒ‡æ ‡</th><th>ä¸²è¡Œå½’å¹¶æ’åº</th><th>å¹¶è¡Œå½’å¹¶æ’åº</th></tr></thead><tbody><tr><td>å±‚æ•°</td><td>logâ‚‚N</td><td>logâ‚‚N</td></tr><tr><td>æ¯å±‚å·¥ä½œ</td><td>O(N)</td><td>O(N)</td></tr><tr><td>æ€»å·¥ä½œ</td><td>O(N log N)</td><td>O(N log N)</td></tr><tr><td>å¹¶è¡Œæ—¶é—´</td><td>O(N log N)</td><td>O(logÂ²N)*</td></tr></tbody></table><p>*å‡è®¾æœ‰è¶³å¤Ÿå¤šçš„å¤„ç†å™¨ï¼Œæ¯å±‚å½’å¹¶å¹¶è¡Œå®Œæˆã€‚</p><h2 id="yu-qi-ta-suan-fa-de-guan-xi" tabindex="-1" id="ä¸å…¶ä»–ç®—æ³•çš„å…³ç³»">ä¸å…¶ä»–ç®—æ³•çš„å…³ç³»</h2><h3 id="gui-bing-vs-ji-shu-pai-xu" tabindex="-1" id="å½’å¹¶-vs-åŸºæ•°æ’åº">å½’å¹¶ vs åŸºæ•°æ’åº</h3><table><thead><tr><th>ç‰¹æ€§</th><th>å½’å¹¶æ’åº</th><th>åŸºæ•°æ’åº</th></tr></thead><tbody><tr><td>æ¯”è¾ƒæ¬¡æ•°</td><td>O(N log N)</td><td>O(N Ã— ä½æ•°)</td></tr><tr><td>ç¨³å®šæ€§</td><td>ç¨³å®š</td><td>ç¨³å®š</td></tr><tr><td>é€‚ç”¨ç±»å‹</td><td>é€šç”¨</td><td>æ•´æ•°/å®šé•¿é”®</td></tr><tr><td>GPU å‹å¥½åº¦</td><td>ä¸­ç­‰</td><td>é«˜</td></tr></tbody></table><p>åŸºæ•°æ’åºåœ¨ GPU ä¸Šé€šå¸¸æ›´å¿«ï¼Œä½†å½’å¹¶æ’åºé€‚ç”¨èŒƒå›´æ›´å¹¿ã€‚</p><h3 id="gui-bing-vs-kuai-su-pai-xu" tabindex="-1" id="å½’å¹¶-vs-å¿«é€Ÿæ’åº">å½’å¹¶ vs å¿«é€Ÿæ’åº</h3><table><thead><tr><th>ç‰¹æ€§</th><th>å½’å¹¶æ’åº</th><th>å¿«é€Ÿæ’åº</th></tr></thead><tbody><tr><td>æœ€åå¤æ‚åº¦</td><td>O(N log N)</td><td>O(NÂ²)</td></tr><tr><td>ç©ºé—´</td><td>O(N)</td><td>O(log N)</td></tr><tr><td>å¹¶è¡ŒåŒ–</td><td>å®¹æ˜“</td><td>è¾ƒéš¾</td></tr><tr><td>ç¨³å®šæ€§</td><td>ç¨³å®š</td><td>ä¸ç¨³å®š</td></tr></tbody></table><p>å½’å¹¶æ’åºçš„ç¡®å®šæ€§å’Œç¨³å®šæ€§ä½¿å…¶åœ¨å¹¶è¡Œè®¡ç®—ä¸­æ›´å—æ¬¢è¿ã€‚</p><h2 id="cub-thrust-ku" tabindex="-1" id="CUB-Thrust-åº“">CUB/Thrust åº“</h2><h3 id="shi-yong-thrust" tabindex="-1" id="ä½¿ç”¨-Thrust">ä½¿ç”¨ Thrust</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;thrust/merge.h&gt;</span><br><span class="line">#include &lt;thrust/device_vector.h&gt;</span><br><span class="line"></span><br><span class="line">void mergeWithThrust(int *A, int m, int *B, int n, int *C) &#123;</span><br><span class="line">    thrust::device_ptr&lt;int&gt; d_A(A);</span><br><span class="line">    thrust::device_ptr&lt;int&gt; d_B(B);</span><br><span class="line">    thrust::device_ptr&lt;int&gt; d_C(C);</span><br><span class="line">    </span><br><span class="line">    thrust::merge(d_A, d_A + m, d_B, d_B + n, d_C);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="shi-yong-cub" tabindex="-1" id="ä½¿ç”¨-CUB">ä½¿ç”¨ CUB</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;cub/cub.cuh&gt;</span><br><span class="line"></span><br><span class="line">void mergeWithCub(int *d_A, int m, int *d_B, int n, int *d_C) &#123;</span><br><span class="line">    void *d_temp = nullptr;</span><br><span class="line">    size_t temp_bytes = 0;</span><br><span class="line">    </span><br><span class="line">    cub::DeviceMerge::Merge(d_temp, temp_bytes, </span><br><span class="line">                            d_A, m, d_B, n, d_C);</span><br><span class="line">    </span><br><span class="line">    cudaMalloc(&amp;d_temp, temp_bytes);</span><br><span class="line">    </span><br><span class="line">    cub::DeviceMerge::Merge(d_temp, temp_bytes,</span><br><span class="line">                            d_A, m, d_B, n, d_C);</span><br><span class="line">    </span><br><span class="line">    cudaFree(d_temp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="xiao-jie" tabindex="-1" id="å°ç»“">å°ç»“</h2><p>ç¬¬åäºŒç« æ·±å…¥è®²è§£å¹¶è¡Œå½’å¹¶ï¼š</p><p><strong>æ ¸å¿ƒæŒ‘æˆ˜</strong>ï¼šè¾“å‡ºä½ç½®å–å†³äºè¾“å…¥æ•°æ®å†…å®¹ï¼ˆåŠ¨æ€æ•°æ®è¯†åˆ«ï¼‰ï¼Œä¸èƒ½ç®€å•æ ¹æ®çº¿ç¨‹ ID ç¡®å®šã€‚</p><p><strong>Co-Rank æŠ€æœ¯</strong>ï¼šç»™å®šè¾“å‡ºä½ç½® kï¼Œç”¨äºŒåˆ†æœç´¢æ‰¾åˆ°å¯¹åº”çš„è¾“å…¥ä½ç½® (i, j)ï¼Œæ»¡è¶³ i + j = kã€‚è¿™æ˜¯å¹¶è¡Œå½’å¹¶çš„å…³é”®ã€‚</p><p><strong>åˆ†å—å½’å¹¶</strong>ï¼šæŠŠè¾“å‡ºåˆ†æˆ Tileï¼Œæ¯ä¸ª Tile åšä¸€æ¬¡ Co-Rank æ‰¾è¾¹ç•Œï¼ŒTile å†…ä¸²è¡Œå½’å¹¶ã€‚å¹³è¡¡äº†å¹¶è¡Œå¼€é”€å’Œå·¥ä½œæ•ˆç‡ã€‚</p><p><strong>å…±äº«å†…å­˜ä¼˜åŒ–</strong>ï¼šæŠŠ Tile æ•°æ®åŠ è½½åˆ°å…±äº«å†…å­˜ï¼Œå‡å°‘å…¨å±€å†…å­˜è®¿é—®ã€‚å¾ªç¯ç¼“å†²åŒºå¤„ç†å¤§ Tileã€‚</p><p><strong>å½’å¹¶è·¯å¾„</strong>ï¼šå½’å¹¶è¿‡ç¨‹å¯è§†åŒ–ä¸º 2D ç½‘æ ¼ä¸­çš„è·¯å¾„ï¼ŒCo-Rank æ‰¾çš„æ˜¯è·¯å¾„ä¸Šçš„ç‚¹ã€‚</p><p><strong>å½’å¹¶æ’åº</strong>ï¼šlog N å±‚å½’å¹¶ï¼Œæ¯å±‚å¯ä»¥å¹¶è¡Œã€‚æ€»å·¥ä½œé‡ O(N log N)ï¼Œå¹¶è¡Œæ—¶é—´å¯è¾¾ O(logÂ² N)ã€‚</p><p>å½’å¹¶æ˜¯æ’åºã€æ•°æ®åº“æ“ä½œçš„åŸºç¡€ã€‚æŒæ¡ Co-Rank æŠ€æœ¯ï¼Œå°±èƒ½å¤„ç†å„ç§&quot;è¾“å‡ºä½ç½®ä¾èµ–è¾“å…¥æ•°æ®&quot;çš„é—®é¢˜ã€‚ä¸‹ä¸€ç« å­¦ä¹ æ’åºâ€”â€”å½’å¹¶çš„ç›´æ¥åº”ç”¨ã€‚</p><hr><p><strong>å‚è€ƒèµ„æ–™ï¼š</strong></p><ul><li>Hwu, W., Kirk, D., &amp; El Hajj, I. (2022). <em>Programming Massively Parallel Processors: A Hands-on Approach</em> (4th Edition). Morgan Kaufmann.</li><li>Odeh, S., Green, O., Miklau, Z., Rupnow, K., &amp; Hwu, W. (2012). <em>Merge Path - A Visually Intuitive Approach to Parallel Merging</em>. IPDPS.</li><li><a href="https://nvlabs.github.io/cub/">NVIDIA CUB Library</a></li></ul><hr><blockquote><p><strong>æœ¬æ–‡ GitHub ä»“åº“</strong>: <a href="https://github.com/psmarter/PMPP-Learning">https://github.com/psmarter/PMPP-Learning</a></p></blockquote>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;qian-yan&quot; tabindex=&quot;-1&quot;</summary>
        
      
    
    
    
    <category term="çŸ¥è¯†åˆ†äº«" scheme="https://smarter.xin/categories/knowledge-sharing/"/>
    
    
    <category term="CUDA" scheme="https://smarter.xin/tags/CUDA/"/>
    
    <category term="GPUç¼–ç¨‹" scheme="https://smarter.xin/tags/gpu-programming/"/>
    
    <category term="å¹¶è¡Œè®¡ç®—" scheme="https://smarter.xin/tags/parallel-computing/"/>
    
    <category term="PMPP" scheme="https://smarter.xin/tags/PMPP/"/>
    
    <category term="å½’å¹¶" scheme="https://smarter.xin/tags/merge/"/>
    
    <category term="Merge" scheme="https://smarter.xin/tags/Merge/"/>
    
    <category term="åŠ¨æ€æ•°æ®è¯†åˆ«" scheme="https://smarter.xin/tags/dynamic-data-identification/"/>
    
  </entry>
  
  <entry>
    <title>PMPP-ç¬¬åä¸€ç« ï¼šå‰ç¼€å’Œ</title>
    <link href="https://smarter.xin/posts/a6fc4cf6/"/>
    <id>https://smarter.xin/posts/a6fc4cf6/</id>
    <published>2026-01-18T07:51:17.000Z</published>
    <updated>2026-01-24T08:26:21.332Z</updated>
    
    <content type="html"><![CDATA[<h2 id="qian-yan" tabindex="-1" id="å‰è¨€">å‰è¨€</h2><p>ç¬¬åç« å­¦äº†å½’çº¦â€”â€”æŠŠ N ä¸ªæ•°å˜æˆ 1 ä¸ªæ•°ã€‚è¿™ç« å­¦<strong>å‰ç¼€å’Œï¼ˆPrefix Sumï¼‰</strong>ï¼Œä¹Ÿå« <strong>Scan</strong>â€”â€”æŠŠ N ä¸ªæ•°å˜æˆ N ä¸ªæ•°ï¼Œæ¯ä¸ªä½ç½®å­˜å‚¨ä¹‹å‰æ‰€æœ‰å…ƒç´ çš„ç´¯è®¡ç»“æœã€‚çœ‹èµ·æ¥è®¡ç®—é‡æ›´å¤§ï¼Œä½†å‰ç¼€å’Œæ˜¯å¹¶è¡Œè®¡ç®—çš„&quot;ç‘å£«å†›åˆ€&quot;ï¼Œèƒ½è§£å†³å¾ˆå¤šçœ‹ä¼¼ä¸å¯å¹¶è¡Œçš„é—®é¢˜ï¼šæµå‹ç¼©ã€åŸºæ•°æ’åºã€ç¨€ç–çŸ©é˜µè¿ç®—ç­‰ã€‚ç¬¬åä¸€ç« é‡ç‚¹è®²è§£<strong>å·¥ä½œæ•ˆç‡</strong>â€”â€”å¦‚ä½•è®©å¹¶è¡Œç®—æ³•åšçš„æ€»å·¥ä½œé‡ä¸è¶…è¿‡ä¸²è¡Œç®—æ³•å¤ªå¤šã€‚</p><blockquote><p><strong>ğŸ“¦ é…å¥—èµ„æº</strong>ï¼šæœ¬ç³»åˆ—æ–‡ç« é…æœ‰å®Œæ•´çš„ <a href="https://github.com/psmarter/PMPP-Learning">GitHub ä»“åº“</a>ï¼ŒåŒ…å«æ¯ç« çš„ç»ƒä¹ é¢˜è§£ç­”ã€CUDA ä»£ç å®ç°å’Œè¯¦ç»†æ³¨é‡Šã€‚æ‰€æœ‰ä»£ç éƒ½ç»è¿‡æµ‹è¯•ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œã€‚</p></blockquote><h2 id="qian-zhui-he-ji-chu" tabindex="-1" id="å‰ç¼€å’ŒåŸºç¡€">å‰ç¼€å’ŒåŸºç¡€</h2><h3 id="shi-yao-shi-qian-zhui-he" tabindex="-1" id="ä»€ä¹ˆæ˜¯å‰ç¼€å’Œ">ä»€ä¹ˆæ˜¯å‰ç¼€å’Œ</h3><p><strong>å‰ç¼€å’Œ</strong>ï¼šå¯¹äºè¾“å…¥æ•°ç»„ <code>[aâ‚€, aâ‚, aâ‚‚, ..., aâ‚™â‚‹â‚]</code>ï¼Œè¾“å‡ºæ¯ä¸ªä½ç½®ä¹‹å‰æ‰€æœ‰å…ƒç´ çš„ç´¯è®¡å€¼ã€‚</p><p>æœ‰ä¸¤ç§å˜ä½“ï¼š</p><p><strong>åŒ…å«å¼æ‰«æï¼ˆInclusive Scanï¼‰</strong>ï¼šåŒ…å«å½“å‰å…ƒç´ </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥:  [3, 1, 7, 0, 4, 1, 6, 3]</span><br><span class="line">è¾“å‡º:  [3, 4, 11, 11, 15, 16, 22, 25]</span><br><span class="line">       3  3+1  4+7  11+0  ...</span><br></pre></td></tr></table></figure><p><strong>æ’é™¤å¼æ‰«æï¼ˆExclusive Scanï¼‰</strong>ï¼šä¸åŒ…å«å½“å‰å…ƒç´ </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥:  [3, 1, 7, 0, 4, 1, 6, 3]</span><br><span class="line">è¾“å‡º:  [0, 3, 4, 11, 11, 15, 16, 22]</span><br><span class="line">       0  å‰ç¼€  å‰ç¼€+1  å‰ç¼€+7  ...</span><br></pre></td></tr></table></figure><p><strong>å…³ç³»</strong>ï¼š<code>exclusive[i] = inclusive[i-1]</code>ï¼Œ<code>exclusive[0] = 0</code></p><h3 id="shu-xue-ding-yi" tabindex="-1" id="æ•°å­¦å®šä¹‰">æ•°å­¦å®šä¹‰</h3><p>å¯¹äºäºŒå…ƒç»“åˆè¿ç®— âŠ•ï¼š</p><p><strong>Inclusive Scan</strong>:</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>y</mi><mi>i</mi></msub><mo>=</mo><munderover><mo>â¨</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mi>i</mi></munderover><msub><mi>x</mi><mi>j</mi></msub><mo>=</mo><msub><mi>x</mi><mn>0</mn></msub><mo>âŠ•</mo><msub><mi>x</mi><mn>1</mn></msub><mo>âŠ•</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo>âŠ•</mo><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">y_i = \bigoplus_{j=0}^{i} x_j = x_0 \oplus x_1 \oplus ... \oplus x_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.2254em;vertical-align:-1.4138em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8117em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">â¨</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.4138em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âŠ•</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âŠ•</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord">...</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âŠ•</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p><p><strong>Exclusive Scan</strong>:</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>y</mi><mi>i</mi></msub><mo>=</mo><munderover><mo>â¨</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mrow><mi>i</mi><mo>âˆ’</mo><mn>1</mn></mrow></munderover><msub><mi>x</mi><mi>j</mi></msub><mo>=</mo><msub><mi>x</mi><mn>0</mn></msub><mo>âŠ•</mo><msub><mi>x</mi><mn>1</mn></msub><mo>âŠ•</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo>âŠ•</mo><msub><mi>x</mi><mrow><mi>i</mi><mo>âˆ’</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">y_i = \bigoplus_{j=0}^{i-1} x_j = x_0 \oplus x_1 \oplus ... \oplus x_{i-1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.2254em;vertical-align:-1.4138em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8117em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">â¨</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.4138em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âŠ•</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âŠ•</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord">...</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âŠ•</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span></span></span></span></span></p><p>å…¶ä¸­ <code>yâ‚€ = identity</code>ï¼ˆå•ä½å…ƒï¼‰ã€‚</p><h3 id="ying-yong-chang-jing" tabindex="-1" id="åº”ç”¨åœºæ™¯">åº”ç”¨åœºæ™¯</h3><p>å‰ç¼€å’Œç”¨é€”æå¹¿ï¼š</p><table><thead><tr><th>åº”ç”¨</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><strong>æµå‹ç¼©</strong></td><td>æ ¹æ®æ¡ä»¶ç­›é€‰å…ƒç´ </td></tr><tr><td><strong>åŸºæ•°æ’åº</strong></td><td>è®¡ç®—æ¯ä¸ªæ¡¶çš„èµ·å§‹ä½ç½®</td></tr><tr><td><strong>ç¨€ç–çŸ©é˜µ</strong></td><td>CSR æ ¼å¼çš„è¡ŒæŒ‡é’ˆæ•°ç»„</td></tr><tr><td><strong>å¤šé¡¹å¼æ±‚å€¼</strong></td><td>Horner æ³•åˆ™çš„å¹¶è¡ŒåŒ–</td></tr><tr><td><strong>æ±‚è§£ä¸‰å¯¹è§’æ–¹ç¨‹</strong></td><td>å¾ªç¯å½’çº¦</td></tr><tr><td><strong>ç›´æ–¹å›¾å‡è¡¡åŒ–</strong></td><td>ç´¯ç§¯åˆ†å¸ƒå‡½æ•°</td></tr></tbody></table><p><strong>æ ¸å¿ƒæ€æƒ³</strong>ï¼šå‰ç¼€å’ŒæŠŠ&quot;ä¾èµ–å‰é¢ç»“æœ&quot;çš„é—®é¢˜è½¬åŒ–ä¸ºå¯å¹¶è¡Œçš„å½¢å¼ã€‚</p><h3 id="chuan-xing-shi-xian" tabindex="-1" id="ä¸²è¡Œå®ç°">ä¸²è¡Œå®ç°</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">inclusive_scan_sequential</span><span class="params">(<span class="type">float</span> *x, <span class="type">float</span> *y, <span class="type">int</span> n)</span> &#123;</span><br><span class="line">    y[<span class="number">0</span>] = x[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; n; i++) &#123;</span><br><span class="line">        y[i] = y[i<span class="number">-1</span>] + x[i];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ—¶é—´å¤æ‚åº¦ O(n)ï¼Œå­˜åœ¨ä¸¥æ ¼çš„æ•°æ®ä¾èµ–ï¼š<code>y[i]</code> ä¾èµ– <code>y[i-1]</code>ã€‚</p><p>çœ‹ä¼¼æ— æ³•å¹¶è¡Œï¼Ÿå…¶å®å¯ä»¥ï¼</p><h2 id="kogge-stone-suan-fa" tabindex="-1" id="Kogge-Stone-ç®—æ³•">Kogge-Stone ç®—æ³•</h2><h3 id="he-xin-si-xiang" tabindex="-1" id="æ ¸å¿ƒæ€æƒ³">æ ¸å¿ƒæ€æƒ³</h3><p>åˆ©ç”¨ç»“åˆå¾‹ï¼Œä¸éœ€è¦æŒ‰é¡ºåºè®¡ç®—ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">y[i] = x[0] + x[1] + ... + x[i]</span><br><span class="line">     = (x[0] + x[1] + ... + x[i-k]) + (x[i-k+1] + ... + x[i])</span><br></pre></td></tr></table></figure><p><strong>æ€è·¯</strong>ï¼šæ¯ä¸€æ­¥è®©æ¯ä¸ªå…ƒç´ ä¸è·ç¦»ä¸º 2^k çš„å…ƒç´ ç›¸åŠ ã€‚</p><h3 id="suan-fa-guo-cheng" tabindex="-1" id="ç®—æ³•è¿‡ç¨‹">ç®—æ³•è¿‡ç¨‹</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">åˆå§‹:     [3, 1, 7, 0, 4, 1, 6, 3]</span><br><span class="line"></span><br><span class="line">Step 1 (stride=1):</span><br><span class="line">  y[i] = x[i] + x[i-1]</span><br><span class="line">  ç»“æœ: [3, 4, 8, 7, 4, 5, 7, 9]</span><br><span class="line"></span><br><span class="line">Step 2 (stride=2):</span><br><span class="line">  y[i] = y[i] + y[i-2]</span><br><span class="line">  ç»“æœ: [3, 4, 11, 11, 12, 12, 11, 14]</span><br><span class="line"></span><br><span class="line">Step 3 (stride=4):</span><br><span class="line">  y[i] = y[i] + y[i-4]</span><br><span class="line">  ç»“æœ: [3, 4, 11, 11, 15, 16, 22, 25]</span><br><span class="line"></span><br><span class="line">å®Œæˆï¼</span><br></pre></td></tr></table></figure><p>æ¯ä¸€æ­¥ï¼Œæ¯ä¸ªå…ƒç´ éƒ½å¹¶è¡Œæ›´æ–°ã€‚logâ‚‚N æ­¥åå®Œæˆã€‚</p><h3 id="cuda-shi-xian" tabindex="-1" id="CUDA-å®ç°">CUDA å®ç°</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">__global__ void kogge_stone_scan(float *X, float *Y, int n) &#123;</span><br><span class="line">    __shared__ float XY[SECTION_SIZE];</span><br><span class="line">    </span><br><span class="line">    int i = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">    </span><br><span class="line">    // åŠ è½½åˆ°å…±äº«å†…å­˜</span><br><span class="line">    if (i &lt; n) &#123;</span><br><span class="line">        XY[threadIdx.x] = X[i];</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        XY[threadIdx.x] = 0;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // Kogge-Stone æ‰«æ</span><br><span class="line">    for (unsigned int stride = 1; stride &lt; blockDim.x; stride *= 2) &#123;</span><br><span class="line">        __syncthreads();</span><br><span class="line">        float temp;</span><br><span class="line">        if (threadIdx.x &gt;= stride) &#123;</span><br><span class="line">            temp = XY[threadIdx.x] + XY[threadIdx.x - stride];</span><br><span class="line">        &#125;</span><br><span class="line">        __syncthreads();</span><br><span class="line">        if (threadIdx.x &gt;= stride) &#123;</span><br><span class="line">            XY[threadIdx.x] = temp;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // å†™å›</span><br><span class="line">    if (i &lt; n) &#123;</span><br><span class="line">        Y[i] = XY[threadIdx.x];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="wei-shi-yao-xu-yao-liang-ci-tong-bu" tabindex="-1" id="ä¸ºä»€ä¹ˆéœ€è¦ä¸¤æ¬¡åŒæ­¥ï¼Ÿ">ä¸ºä»€ä¹ˆéœ€è¦ä¸¤æ¬¡åŒæ­¥ï¼Ÿ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__syncthreads();  // ç¬¬ä¸€æ¬¡ï¼šç¡®ä¿æ‰€æœ‰çº¿ç¨‹è¯»å®Œ</span><br><span class="line">temp = XY[...] + XY[...];  // è¯»å–</span><br><span class="line">__syncthreads();  // ç¬¬äºŒæ¬¡ï¼šç¡®ä¿æ‰€æœ‰çº¿ç¨‹è¯»å®Œå†å†™</span><br><span class="line">XY[...] = temp;  // å†™å…¥</span><br></pre></td></tr></table></figure><p>å¦‚æœä¸ç”¨ä¸´æ—¶å˜é‡ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// é”™è¯¯ï¼</span><br><span class="line">XY[i] = XY[i] + XY[i-stride];  // å¦‚æœé‚»å±…è¿˜æ²¡è¯»å®Œå°±è¢«è¦†ç›–</span><br></pre></td></tr></table></figure><p><strong>å…³é”®</strong>ï¼šè¯»å’Œå†™å¿…é¡»åˆ†ç¦»ï¼Œç”¨åŒæ­¥ä¿è¯ã€‚</p><h3 id="gong-zuo-liang-fen-xi" tabindex="-1" id="å·¥ä½œé‡åˆ†æ">å·¥ä½œé‡åˆ†æ</h3><table><thead><tr><th>æŒ‡æ ‡</th><th>ä¸²è¡Œç®—æ³•</th><th>Kogge-Stone</th></tr></thead><tbody><tr><td>æ­¥æ•°</td><td>N</td><td>logâ‚‚N</td></tr><tr><td>æ¯æ­¥æ“ä½œ</td><td>1</td><td>~N</td></tr><tr><td>æ€»æ“ä½œ</td><td>N</td><td>NÂ·logâ‚‚N</td></tr></tbody></table><p><strong>é—®é¢˜</strong>ï¼šKogge-Stone åšäº†æ›´å¤šçš„å·¥ä½œï¼</p><p>å¯¹äº N=1024ï¼š</p><ul><li>ä¸²è¡Œï¼š1024 æ¬¡æ“ä½œ</li><li>Kogge-Stoneï¼š1024 Ã— 10 = 10240 æ¬¡æ“ä½œ</li></ul><p>è¿™å°±æ˜¯**å·¥ä½œæ•ˆç‡ï¼ˆWork Efficiencyï¼‰**é—®é¢˜ã€‚</p><h2 id="brent-kung-suan-fa" tabindex="-1" id="Brent-Kung-ç®—æ³•">Brent-Kung ç®—æ³•</h2><h3 id="gong-zuo-xiao-lu-you-hua" tabindex="-1" id="å·¥ä½œæ•ˆç‡ä¼˜åŒ–">å·¥ä½œæ•ˆç‡ä¼˜åŒ–</h3><p><strong>æ€è·¯</strong>ï¼šå‡å°‘å†—ä½™è®¡ç®—ï¼Œåˆ†ä¸¤ä¸ªé˜¶æ®µï¼š</p><ol><li><strong>å½’çº¦é˜¶æ®µï¼ˆReduceï¼‰</strong>ï¼šè‡ªåº•å‘ä¸Šï¼Œæ„å»ºéƒ¨åˆ†å’Œ</li><li><strong>åˆ†å‘é˜¶æ®µï¼ˆDownsweepï¼‰</strong>ï¼šè‡ªé¡¶å‘ä¸‹ï¼Œåˆ†å‘ç»“æœ</li></ol><h3 id="suan-fa-guo-cheng-1" tabindex="-1" id="ç®—æ³•è¿‡ç¨‹-2">ç®—æ³•è¿‡ç¨‹</h3><p><strong>é˜¶æ®µ 1ï¼šå½’çº¦</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">åˆå§‹:     [3, 1, 7, 0, 4, 1, 6, 3]</span><br><span class="line"></span><br><span class="line">Step 1 (stride=1): ç›¸é‚»å…ƒç´ é…å¯¹æ±‚å’Œ</span><br><span class="line">          [3, 4, 7, 7, 4, 5, 6, 9]</span><br><span class="line">              â†‘     â†‘     â†‘     â†‘</span><br><span class="line">             1+3   0+7   1+4   3+6</span><br><span class="line"></span><br><span class="line">Step 2 (stride=2): éš”ä¸€ä¸ªé…å¯¹</span><br><span class="line">          [3, 4, 7, 11, 4, 5, 6, 14]</span><br><span class="line">                   â†‘           â†‘</span><br><span class="line">                  4+7         5+9</span><br><span class="line"></span><br><span class="line">Step 3 (stride=4): éš”ä¸‰ä¸ªé…å¯¹</span><br><span class="line">          [3, 4, 7, 11, 4, 5, 6, 25]</span><br><span class="line">                               â†‘</span><br><span class="line">                             11+14</span><br></pre></td></tr></table></figure><p>ç°åœ¨ <code>XY[7] = 25 = å…¨éƒ¨å…ƒç´ ä¹‹å’Œ</code>ã€‚</p><p><strong>é˜¶æ®µ 2ï¼šåˆ†å‘ï¼ˆDownsweepï¼‰</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ä»å³åˆ°å·¦ï¼ŒæŠŠéƒ¨åˆ†å’Œ&quot;ä¼ æ’­&quot;ä¸‹å»ï¼š</span><br><span class="line"></span><br><span class="line">Step 1 (stride=2):</span><br><span class="line">  XY[5] = XY[5] + XY[3] = 5 + 11 = 16</span><br><span class="line">          [3, 4, 7, 11, 4, 16, 6, 25]</span><br><span class="line"></span><br><span class="line">Step 2 (stride=1):</span><br><span class="line">  XY[2] = XY[2] + XY[1] = 7 + 4 = 11</span><br><span class="line">  XY[4] = XY[4] + XY[3] = 4 + 11 = 15</span><br><span class="line">  XY[6] = XY[6] + XY[5] = 6 + 16 = 22</span><br><span class="line">          [3, 4, 11, 11, 15, 16, 22, 25]</span><br><span class="line"></span><br><span class="line">å®Œæˆï¼</span><br></pre></td></tr></table></figure><h3 id="cuda-shi-xian-1" tabindex="-1" id="CUDA-å®ç°-2">CUDA å®ç°</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">__global__ void brent_kung_scan(float *X, float *Y, int n) &#123;</span><br><span class="line">    __shared__ float XY[SECTION_SIZE];</span><br><span class="line">    </span><br><span class="line">    int i = 2 * blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">    </span><br><span class="line">    // åŠ è½½ï¼ˆæ¯çº¿ç¨‹ä¸¤ä¸ªå…ƒç´ ï¼‰</span><br><span class="line">    if (i &lt; n) XY[threadIdx.x] = X[i];</span><br><span class="line">    if (i + blockDim.x &lt; n) XY[threadIdx.x + blockDim.x] = X[i + blockDim.x];</span><br><span class="line">    </span><br><span class="line">    // ========== å½’çº¦é˜¶æ®µ ==========</span><br><span class="line">    for (unsigned int stride = 1; stride &lt;= blockDim.x; stride *= 2) &#123;</span><br><span class="line">        __syncthreads();</span><br><span class="line">        int index = (threadIdx.x + 1) * 2 * stride - 1;</span><br><span class="line">        if (index &lt; SECTION_SIZE) &#123;</span><br><span class="line">            XY[index] += XY[index - stride];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // ========== åˆ†å‘é˜¶æ®µ ==========</span><br><span class="line">    for (unsigned int stride = SECTION_SIZE / 4; stride &gt; 0; stride /= 2) &#123;</span><br><span class="line">        __syncthreads();</span><br><span class="line">        int index = (threadIdx.x + 1) * 2 * stride - 1;</span><br><span class="line">        if (index + stride &lt; SECTION_SIZE) &#123;</span><br><span class="line">            XY[index + stride] += XY[index];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    __syncthreads();</span><br><span class="line">    </span><br><span class="line">    // å†™å›</span><br><span class="line">    if (i &lt; n) Y[i] = XY[threadIdx.x];</span><br><span class="line">    if (i + blockDim.x &lt; n) Y[i + blockDim.x] = XY[threadIdx.x + blockDim.x];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="gong-zuo-liang-fen-xi-1" tabindex="-1" id="å·¥ä½œé‡åˆ†æ-2">å·¥ä½œé‡åˆ†æ</h3><table><thead><tr><th>é˜¶æ®µ</th><th>æ­¥æ•°</th><th>æ¯æ­¥æ“ä½œ</th><th>æ€»æ“ä½œ</th></tr></thead><tbody><tr><td>å½’çº¦</td><td>logâ‚‚N</td><td>N/2^k</td><td>N-1</td></tr><tr><td>åˆ†å‘</td><td>logâ‚‚N - 1</td><td>N/2^k</td><td>N-1-logâ‚‚N</td></tr><tr><td><strong>æ€»è®¡</strong></td><td></td><td></td><td><strong>2N-2-logâ‚‚N</strong></td></tr></tbody></table><p>å¯¹äº N=1024ï¼š</p><ul><li>Kogge-Stoneï¼š10240 æ¬¡æ“ä½œ</li><li>Brent-Kungï¼š~2046 æ¬¡æ“ä½œ</li></ul><p><strong>å·¥ä½œæ•ˆç‡æå‡ 5 å€ï¼</strong></p><h3 id="wei-shi-yao-mei-xian-cheng-chu-li-liang-ge-yuan-su" tabindex="-1" id="ä¸ºä»€ä¹ˆæ¯çº¿ç¨‹å¤„ç†ä¸¤ä¸ªå…ƒç´ ï¼Ÿ">ä¸ºä»€ä¹ˆæ¯çº¿ç¨‹å¤„ç†ä¸¤ä¸ªå…ƒç´ ï¼Ÿ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int i = 2 * blockIdx.x * blockDim.x + threadIdx.x;</span><br></pre></td></tr></table></figure><p>å¦‚æœ Section æœ‰ 1024 ä¸ªå…ƒç´ ï¼Œåªéœ€è¦ 512 ä¸ªçº¿ç¨‹ã€‚æ¯çº¿ç¨‹åŠ è½½ä¸¤ä¸ªå…ƒç´ ï¼Œå‡å°‘äº†çº¿ç¨‹å¼€é”€ã€‚</p><h2 id="kogge-stone-vs-brent-kung" tabindex="-1" id="Kogge-Stone-vs-Brent-Kung">Kogge-Stone vs Brent-Kung</h2><h3 id="dui-bi" tabindex="-1" id="å¯¹æ¯”">å¯¹æ¯”</h3><table><thead><tr><th>æŒ‡æ ‡</th><th>Kogge-Stone</th><th>Brent-Kung</th></tr></thead><tbody><tr><td>æ€»æ“ä½œæ•°</td><td>NÂ·logâ‚‚N</td><td>2N - 2 - logâ‚‚N</td></tr><tr><td>æ­¥æ•°</td><td>logâ‚‚N</td><td>2Â·logâ‚‚N - 1</td></tr><tr><td>å¹¶è¡Œåº¦ï¼ˆæ¯æ­¥ï¼‰</td><td>N</td><td>é€’å‡/é€’å¢</td></tr><tr><td>æ§åˆ¶é€»è¾‘</td><td>ç®€å•</td><td>å¤æ‚</td></tr><tr><td>å·¥ä½œæ•ˆç‡</td><td>ä½</td><td>é«˜ï¼ˆ~ä¸²è¡Œï¼‰</td></tr></tbody></table><h3 id="xuan-ze-ce-lue" tabindex="-1" id="é€‰æ‹©ç­–ç•¥">é€‰æ‹©ç­–ç•¥</h3><table><thead><tr><th>åœºæ™¯</th><th>æ¨èç®—æ³•</th><th>åŸå› </th></tr></thead><tbody><tr><td>å°æ•°ç»„ï¼ˆ&lt;1Kï¼‰</td><td>Kogge-Stone</td><td>ç®€å•ï¼Œæ­¥æ•°å°‘</td></tr><tr><td>å¤§æ•°ç»„</td><td>Brent-Kung</td><td>å·¥ä½œé‡å°</td></tr><tr><td>å¸¦å®½å—é™</td><td>Kogge-Stone</td><td>æ›´å¤šå¹¶è¡Œéšè—å»¶è¿Ÿ</td></tr><tr><td>è®¡ç®—å—é™</td><td>Brent-Kung</td><td>æ€»æ“ä½œå°‘</td></tr></tbody></table><p>å®é™…ä¸­ï¼Œæ··åˆç­–ç•¥æœ€å¸¸è§ï¼šå¤§éƒ¨åˆ†ç”¨ Brent-Kungï¼Œæœ€åå‡ å±‚ç”¨ Kogge-Stoneã€‚</p><h2 id="san-jie-duan-fen-ceng-sao-miao" tabindex="-1" id="ä¸‰é˜¶æ®µåˆ†å±‚æ‰«æ">ä¸‰é˜¶æ®µåˆ†å±‚æ‰«æ</h2><h3 id="wen-ti-chao-chu-dan-block" tabindex="-1" id="é—®é¢˜ï¼šè¶…å‡ºå•-Block">é—®é¢˜ï¼šè¶…å‡ºå• Block</h3><p>å½“æ•°æ®é‡è¶…è¿‡å…±äº«å†…å­˜å®¹é‡æ—¶ï¼Œéœ€è¦<strong>å¤š Block åä½œ</strong>ã€‚</p><h3 id="san-jie-duan-suan-fa" tabindex="-1" id="ä¸‰é˜¶æ®µç®—æ³•">ä¸‰é˜¶æ®µç®—æ³•</h3><p><strong>é˜¶æ®µ 1ï¼šBlock å†…æ‰«æ</strong></p><p>æ¯ä¸ª Block ç‹¬ç«‹æ‰«æè‡ªå·±çš„ Sectionï¼Œä¿å­˜æœ€åä¸€ä¸ªå…ƒç´ ï¼ˆSection Sumï¼‰ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Block 0: [3,4,11,11]  â†’ sum[0] = 11</span><br><span class="line">Block 1: [4,5,11,14]  â†’ sum[1] = 14</span><br><span class="line">Block 2: [5,6,12,15]  â†’ sum[2] = 15</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p><strong>é˜¶æ®µ 2ï¼šæ‰«æ Section Sums</strong></p><p>å¯¹æ‰€æœ‰ Block çš„ sum åšæ‰«æï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sum: [11, 14, 15, ...]</span><br><span class="line">æ‰«æå: [0, 11, 25, 40, ...]  // Exclusive</span><br></pre></td></tr></table></figure><p>è¿™ç»™å‡ºäº†æ¯ä¸ª Block çš„&quot;èµ·å§‹åç§»&quot;ã€‚</p><p><strong>é˜¶æ®µ 3ï¼šåŠ ä¸Šåç§»</strong></p><p>æ¯ä¸ª Block çš„æ‰€æœ‰å…ƒç´ åŠ ä¸Šå¯¹åº”çš„åç§»ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Block 0: [3,4,11,11] + 0  â†’ [3,4,11,11]</span><br><span class="line">Block 1: [4,5,11,14] + 11 â†’ [15,16,22,25]</span><br><span class="line">Block 2: [5,6,12,15] + 25 â†’ [30,31,37,40]</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="shi-xian" tabindex="-1" id="å®ç°">å®ç°</h3><p><strong>Kernel 1ï¼šBlock å†…æ‰«æ</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">__global__ void scan_phase1(float *X, float *Y, float *S, int n) &#123;</span><br><span class="line">    __shared__ float XY[SECTION_SIZE];</span><br><span class="line">    </span><br><span class="line">    // Block å†…æ‰«æï¼ˆBrent-Kungï¼‰</span><br><span class="line">    // ...</span><br><span class="line">    </span><br><span class="line">    // ä¿å­˜ Section Sum</span><br><span class="line">    if (threadIdx.x == blockDim.x - 1) &#123;</span><br><span class="line">        S[blockIdx.x] = XY[SECTION_SIZE - 1];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // å†™å›</span><br><span class="line">    // ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Kernel 2ï¼šæ‰«æ Section Sums</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// é€šå¸¸åªæœ‰ä¸€ä¸ª Blockï¼Œå› ä¸º Section æ•°é‡ä¸å¤š</span><br><span class="line">scan_single_block&lt;&lt;&lt;1, numSections&gt;&gt;&gt;(S, S, numSections);</span><br></pre></td></tr></table></figure><p><strong>Kernel 3ï¼šåŠ åç§»</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__global__ void scan_phase3(float *Y, float *S, int n) &#123;</span><br><span class="line">    int i = blockIdx.x * SECTION_SIZE + threadIdx.x;</span><br><span class="line">    if (blockIdx.x &gt; 0 &amp;&amp; i &lt; n) &#123;</span><br><span class="line">        Y[i] += S[blockIdx.x - 1];  // Exclusive æ‰«æçš„ç»“æœ</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="di-gui-chu-li" tabindex="-1" id="é€’å½’å¤„ç†">é€’å½’å¤„ç†</h3><p>å¦‚æœ Section æ•°é‡ä¹Ÿå¾ˆå¤§ï¼Œå¯¹ S çš„æ‰«ææœ¬èº«éœ€è¦åˆ†å±‚ã€‚å½¢æˆ<strong>é€’å½’ç»“æ„</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Level 0: æ‰«æåŸå§‹æ•°æ® â†’ Section Sums</span><br><span class="line">Level 1: æ‰«æ Section Sums â†’ Super Section Sums</span><br><span class="line">Level 2: æ‰«æ Super Section Sums</span><br><span class="line">...</span><br><span class="line">Level K: å• Block å®Œæˆ</span><br><span class="line"></span><br><span class="line">ç„¶åé€†å‘åŠ åç§»ï¼š</span><br><span class="line">Level K â†’ Level K-1 â†’ ... â†’ Level 0</span><br></pre></td></tr></table></figure><p><strong>å±‚æ•°</strong>ï¼šlog(N/SECTION_SIZE)</p><h2 id="dan-bian-sao-miao-single-pass-scan" tabindex="-1" id="å•éæ‰«æï¼ˆSingle-Pass-Scanï¼‰">å•éæ‰«æï¼ˆSingle-Pass Scanï¼‰</h2><h3 id="dong-ji" tabindex="-1" id="åŠ¨æœº">åŠ¨æœº</h3><p>ä¸‰é˜¶æ®µæ‰«æéœ€è¦å¤šæ¬¡ Kernel å¯åŠ¨ï¼Œæœ‰å¼€é”€ã€‚èƒ½å¦ä¸€éå®Œæˆï¼Ÿ</p><h3 id="si-lu" tabindex="-1" id="æ€è·¯">æ€è·¯</h3><p>ç”¨<strong>åŸå­æ“ä½œ + å†…å­˜æ ‡å¿—</strong>å®ç° Block é—´é€šä¿¡ï¼š</p><ol><li>æ¯ä¸ª Block å®Œæˆæ‰«æåï¼Œå‘å¸ƒè‡ªå·±çš„ Section Sum</li><li>ç­‰å¾…å‰ä¸€ä¸ª Block çš„ç»“æœ</li><li>åŠ ä¸Šå‰ç¼€å¹¶ç»§ç»­</li></ol><h3 id="shi-xian-1" tabindex="-1" id="å®ç°-2">å®ç°</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">__global__ void single_pass_scan(float *X, float *Y, float *flags, </span><br><span class="line">                                  float *sums, int n) &#123;</span><br><span class="line">    __shared__ float XY[SECTION_SIZE];</span><br><span class="line">    __shared__ float prefix;</span><br><span class="line">    </span><br><span class="line">    int bid = blockIdx.x;</span><br><span class="line">    </span><br><span class="line">    // Phase 1: Block å†…æ‰«æ</span><br><span class="line">    // ... æ ‡å‡† Brent-Kung ...</span><br><span class="line">    </span><br><span class="line">    // Phase 2: ç­‰å¾…å‰ä¸€ä¸ª Block</span><br><span class="line">    if (threadIdx.x == 0) &#123;</span><br><span class="line">        // å‘å¸ƒè‡ªå·±çš„å’Œ</span><br><span class="line">        sums[bid] = XY[SECTION_SIZE - 1];</span><br><span class="line">        __threadfence();  // ç¡®ä¿å†™å…¥å¯¹å…¶ä»– Block å¯è§</span><br><span class="line">        atomicExch(&amp;flags[bid], 1);  // æ ‡è®°å®Œæˆ</span><br><span class="line">        </span><br><span class="line">        // ç­‰å¾…å‰ç¼€</span><br><span class="line">        if (bid &gt; 0) &#123;</span><br><span class="line">            // ç­‰å¾… Block bid-1</span><br><span class="line">            while (atomicAdd(&amp;flags[bid - 1], 0) == 0);</span><br><span class="line">            __threadfence();</span><br><span class="line">            </span><br><span class="line">            // ç´¯åŠ æ‰€æœ‰å‰ç¼€ï¼ˆå¯ä¼˜åŒ–ä¸º Kogge-Stone é£æ ¼ï¼‰</span><br><span class="line">            float pre = 0;</span><br><span class="line">            for (int i = 0; i &lt; bid; i++) &#123;</span><br><span class="line">                pre += sums[i];</span><br><span class="line">            &#125;</span><br><span class="line">            prefix = pre;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            prefix = 0;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    __syncthreads();</span><br><span class="line">    </span><br><span class="line">    // Phase 3: åŠ åç§»å¹¶å†™å›</span><br><span class="line">    int i = bid * SECTION_SIZE + threadIdx.x;</span><br><span class="line">    if (i &lt; n) &#123;</span><br><span class="line">        Y[i] = XY[threadIdx.x] + prefix;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="wen-ti" tabindex="-1" id="é—®é¢˜">é—®é¢˜</h3><p><strong>é¡ºåºä¾èµ–</strong>ï¼šBlock å¿…é¡»æŒ‰é¡ºåºå®Œæˆï¼Œå¯èƒ½å¯¼è‡´<strong>ä¸²è¡ŒåŒ–</strong>ã€‚</p><p><strong>æ”¹è¿›</strong>ï¼šä½¿ç”¨ <strong>Decoupled Look-back</strong>ï¼ˆåˆ†ç¦»å›æº¯ï¼‰ç®—æ³•ï¼Œæ¯ä¸ª Block åªæŸ¥çœ‹éƒ¨åˆ†å‰ç¼€ï¼Œé“¾å¼ä¼ æ’­ã€‚</p><h2 id="gong-zuo-xiao-lu-de-ben-zhi" tabindex="-1" id="å·¥ä½œæ•ˆç‡çš„æœ¬è´¨">å·¥ä½œæ•ˆç‡çš„æœ¬è´¨</h2><h3 id="shi-jian-vs-cao-zuo" tabindex="-1" id="æ—¶é—´-vs-æ“ä½œ">æ—¶é—´ vs æ“ä½œ</h3><p><strong>å¹¶è¡Œæ—¶é—´</strong>ï¼šæ‰€æœ‰å¤„ç†å™¨åŒæ—¶å·¥ä½œéœ€è¦çš„æ—¶é—´æ­¥æ•°</p><p><strong>æ€»æ“ä½œæ•°</strong>ï¼šæ‰€æœ‰å¤„ç†å™¨æ‰§è¡Œçš„æ“ä½œæ€»å’Œ</p><p><strong>å·¥ä½œæ•ˆç‡ = ä¸²è¡Œæ“ä½œæ•° / å¹¶è¡Œæ“ä½œæ•°</strong></p><table><thead><tr><th>ç®—æ³•</th><th>å¹¶è¡Œæ—¶é—´</th><th>æ€»æ“ä½œ</th><th>å·¥ä½œæ•ˆç‡</th></tr></thead><tbody><tr><td>ä¸²è¡Œ</td><td>N</td><td>N</td><td>100%</td></tr><tr><td>Kogge-Stone</td><td>log N</td><td>NÂ·log N</td><td>1/log N</td></tr><tr><td>Brent-Kung</td><td>2Â·log N</td><td>2N</td><td>~50%</td></tr></tbody></table><h3 id="he-shi-zhui-qiu-gong-zuo-xiao-lu" tabindex="-1" id="ä½•æ—¶è¿½æ±‚å·¥ä½œæ•ˆç‡ï¼Ÿ">ä½•æ—¶è¿½æ±‚å·¥ä½œæ•ˆç‡ï¼Ÿ</h3><p><strong>å¤„ç†å™¨å……è¶³æ—¶</strong>ï¼š</p><ul><li>æ“ä½œæ•°ä¸»å¯¼æ—¶é—´</li><li>åº”è¯¥è¿½æ±‚å·¥ä½œæ•ˆç‡</li></ul><p><strong>å¤„ç†å™¨ä¸è¶³æ—¶</strong>ï¼š</p><ul><li>æ­¥æ•°ä¸»å¯¼æ—¶é—´</li><li>å¯ä»¥ç‰ºç‰²å·¥ä½œæ•ˆç‡æ¢å–æ›´å°‘æ­¥æ•°</li></ul><p>GPU é€šå¸¸å¤„ç†å™¨&quot;è¶³å¤Ÿå¤š&quot;ï¼Œæ‰€ä»¥å·¥ä½œæ•ˆç‡å¾ˆé‡è¦ã€‚</p><h2 id="qian-zhui-he-de-ying-yong" tabindex="-1" id="å‰ç¼€å’Œçš„åº”ç”¨">å‰ç¼€å’Œçš„åº”ç”¨</h2><h3 id="liu-ya-suo-stream-compaction" tabindex="-1" id="æµå‹ç¼©ï¼ˆStream-Compactionï¼‰">æµå‹ç¼©ï¼ˆStream Compactionï¼‰</h3><p>ç­›é€‰æ»¡è¶³æ¡ä»¶çš„å…ƒç´ ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥:    [3, 1, 7, 0, 4, 1, 6, 3]</span><br><span class="line">æ¡ä»¶:    x &gt; 2</span><br><span class="line">æ ‡å¿—:    [1, 0, 1, 0, 1, 0, 1, 1]</span><br><span class="line">å‰ç¼€å’Œ:  [0, 1, 1, 2, 2, 3, 3, 4]  // Exclusive</span><br><span class="line">è¾“å‡ºä½ç½®: 0, -, 1, -, 2, -, 3, 4</span><br><span class="line">è¾“å‡º:    [3, 7, 4, 6, 3]</span><br></pre></td></tr></table></figure><p><strong>Exclusive å‰ç¼€å’Œç»™å‡ºæ¯ä¸ªæ»¡è¶³æ¡ä»¶å…ƒç´ çš„è¾“å‡ºä½ç½®ï¼</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">__global__ void compact(int *flags, int *positions, </span><br><span class="line">                        float *in, float *out, int n) &#123;</span><br><span class="line">    int i = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">    if (i &lt; n &amp;&amp; flags[i]) &#123;</span><br><span class="line">        out[positions[i]] = in[i];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ji-shu-pai-xu" tabindex="-1" id="åŸºæ•°æ’åº">åŸºæ•°æ’åº</h3><p>æŒ‰ä½æ’åºï¼Œæ¯ä¸€ä½ç”¨å‰ç¼€å’Œç¡®å®šä½ç½®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ç¬¬ 0 ä½ = 0 çš„å…ƒç´ : å‰ç¼€å’Œç¡®å®šä½ç½®</span><br><span class="line">ç¬¬ 0 ä½ = 1 çš„å…ƒç´ : ç´§éšå…¶å</span><br></pre></td></tr></table></figure><h3 id="fen-pei-gong-zuo" tabindex="-1" id="åˆ†é…å·¥ä½œ">åˆ†é…å·¥ä½œ</h3><p>æ ¹æ®è´Ÿè½½åˆ†é…ä»»åŠ¡ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ä»»åŠ¡å¤§å°:  [5, 3, 8, 2, 4]</span><br><span class="line">å‰ç¼€å’Œ:    [0, 5, 8, 16, 18]</span><br><span class="line"></span><br><span class="line">çº¿ç¨‹ 7 åº”è¯¥å¤„ç†å“ªä¸ªä»»åŠ¡ï¼Ÿ</span><br><span class="line">â†’ äºŒåˆ†æŸ¥æ‰¾å‰ç¼€å’Œæ•°ç»„</span><br><span class="line">â†’ ä»»åŠ¡ 1ï¼ˆå› ä¸º 5 â‰¤ 7 &lt; 8ï¼‰</span><br></pre></td></tr></table></figure><h2 id="cub-ku" tabindex="-1" id="CUB-åº“">CUB åº“</h2><h3 id="shi-yong-cub-shi-xian-sao-miao" tabindex="-1" id="ä½¿ç”¨-CUB-å®ç°æ‰«æ">ä½¿ç”¨ CUB å®ç°æ‰«æ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;cub/cub.cuh&gt;</span><br><span class="line"></span><br><span class="line">void scanWithCub(float *d_in, float *d_out, int n) &#123;</span><br><span class="line">    void *d_temp = nullptr;</span><br><span class="line">    size_t temp_bytes = 0;</span><br><span class="line">    </span><br><span class="line">    // ç¡®å®šä¸´æ—¶å­˜å‚¨å¤§å°</span><br><span class="line">    cub::DeviceScan::InclusiveSum(d_temp, temp_bytes, d_in, d_out, n);</span><br><span class="line">    </span><br><span class="line">    cudaMalloc(&amp;d_temp, temp_bytes);</span><br><span class="line">    </span><br><span class="line">    // æ‰§è¡Œæ‰«æ</span><br><span class="line">    cub::DeviceScan::InclusiveSum(d_temp, temp_bytes, d_in, d_out, n);</span><br><span class="line">    </span><br><span class="line">    cudaFree(d_temp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="cub-ti-gong-de-sao-miao" tabindex="-1" id="CUB-æä¾›çš„æ‰«æ">CUB æä¾›çš„æ‰«æ</h3><table><thead><tr><th>å‡½æ•°</th><th>åŠŸèƒ½</th></tr></thead><tbody><tr><td><code>DeviceScan::InclusiveSum</code></td><td>åŒ…å«å¼æ±‚å’Œ</td></tr><tr><td><code>DeviceScan::ExclusiveSum</code></td><td>æ’é™¤å¼æ±‚å’Œ</td></tr><tr><td><code>DeviceScan::InclusiveScan</code></td><td>åŒ…å«å¼è‡ªå®šä¹‰</td></tr><tr><td><code>DeviceScan::ExclusiveScan</code></td><td>æ’é™¤å¼è‡ªå®šä¹‰</td></tr></tbody></table><h3 id="zi-ding-yi-cao-zuo" tabindex="-1" id="è‡ªå®šä¹‰æ“ä½œ">è‡ªå®šä¹‰æ“ä½œ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">struct MaxOp &#123;</span><br><span class="line">    __device__ float operator()(float a, float b) &#123;</span><br><span class="line">        return (a &gt; b) ? a : b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">MaxOp max_op;</span><br><span class="line">cub::DeviceScan::InclusiveScan(d_temp, temp_bytes, </span><br><span class="line">                                d_in, d_out, max_op, n);</span><br></pre></td></tr></table></figure><h2 id="xiao-jie" tabindex="-1" id="å°ç»“">å°ç»“</h2><p>ç¬¬åä¸€ç« æ·±å…¥è®²è§£å‰ç¼€å’Œï¼š</p><p><strong>ä¸¤ç§å˜ä½“</strong>ï¼šInclusiveï¼ˆå«å½“å‰ï¼‰vs Exclusiveï¼ˆä¸å«å½“å‰ï¼‰ã€‚Exclusive çš„åº”ç”¨æ›´å¹¿ï¼Œç‰¹åˆ«æ˜¯ç¡®å®šè¾“å‡ºä½ç½®ã€‚</p><p><strong>Kogge-Stone</strong>ï¼šç®€å•ç›´æ¥ï¼Œlog N æ­¥ï¼Œä½†å·¥ä½œé‡ NÂ·log Nï¼Œå·¥ä½œæ•ˆç‡ä½ã€‚</p><p><strong>Brent-Kung</strong>ï¼šåˆ†å½’çº¦å’Œåˆ†å‘ä¸¤é˜¶æ®µï¼Œå·¥ä½œé‡ ~2Nï¼Œæ¥è¿‘ä¸²è¡Œã€‚æ­¥æ•°ç•¥å¤šä½†æ›´é«˜æ•ˆã€‚</p><p><strong>åˆ†å±‚æ‰«æ</strong>ï¼šå¤§æ•°æ®éœ€è¦å¤š Block åä½œã€‚ä¸‰é˜¶æ®µï¼šBlock å†…æ‰«æ â†’ æ‰«æ Section Sums â†’ åŠ åç§»ã€‚å¯é€’å½’å¤„ç†è¶…å¤§æ•°æ®ã€‚</p><p><strong>å·¥ä½œæ•ˆç‡</strong>ï¼šå¹¶è¡Œç®—æ³•çš„æ€»æ“ä½œæ•°ä¸åº”è¿œè¶…ä¸²è¡Œã€‚GPU å¤„ç†å™¨å¤šï¼Œå·¥ä½œæ•ˆç‡æ¯”æ­¥æ•°æ›´é‡è¦ã€‚</p><p><strong>æ ¸å¿ƒåº”ç”¨</strong>ï¼šæµå‹ç¼©ã€åŸºæ•°æ’åºã€è´Ÿè½½åˆ†é…ã€‚å‰ç¼€å’ŒæŠŠ&quot;è¾“å‡ºä½ç½®&quot;é—®é¢˜å˜æˆå¹¶è¡Œå¯è§£ã€‚</p><p>å‰ç¼€å’Œæ˜¯å¹¶è¡Œè®¡ç®—çš„åŸºç¡€åŸè¯­ï¼Œç†è§£å®ƒå¯¹äºå®ç°å¤æ‚å¹¶è¡Œç®—æ³•è‡³å…³é‡è¦ã€‚ä¸‹ä¸€ç« å­¦ä¹ åˆå¹¶ï¼ˆMergeï¼‰â€”â€”å¦ä¸€ä¸ªé‡è¦çš„å¹¶è¡ŒåŸè¯­ã€‚</p><hr><p><strong>å‚è€ƒèµ„æ–™ï¼š</strong></p><ul><li>Hwu, W., Kirk, D., &amp; El Hajj, I. (2022). <em>Programming Massively Parallel Processors: A Hands-on Approach</em> (4th Edition). Morgan Kaufmann.</li><li>Blelloch, G. E. (1990). <em>Prefix Sums and Their Applications</em>. CMU Technical Report.</li><li><a href="https://nvlabs.github.io/cub/structcub_1_1_device_scan.html">NVIDIA CUB Library - Scan</a></li></ul><hr><blockquote><p><strong>æœ¬æ–‡ GitHub ä»“åº“</strong>: <a href="https://github.com/psmarter/PMPP-Learning">https://github.com/psmarter/PMPP-Learning</a></p></blockquote>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;qian-yan&quot; tabindex=&quot;-1&quot; id=&quot;å‰è¨€&quot;&gt;å‰è¨€&lt;/h2&gt;
&lt;p&gt;ç¬¬åç« å­¦äº†å½’çº¦â€”â€”æŠŠ N ä¸ªæ•°å˜æˆ 1 ä¸ªæ•°ã€‚è¿™ç« å­¦&lt;strong&gt;å‰ç¼€å’Œï¼ˆPrefix Sumï¼‰&lt;/strong&gt;ï¼Œä¹Ÿå« &lt;strong&gt;Scan&lt;/strong&gt;â€”â€”æŠŠ N</summary>
        
      
    
    
    
    <category term="çŸ¥è¯†åˆ†äº«" scheme="https://smarter.xin/categories/knowledge-sharing/"/>
    
    
    <category term="CUDA" scheme="https://smarter.xin/tags/CUDA/"/>
    
    <category term="GPUç¼–ç¨‹" scheme="https://smarter.xin/tags/gpu-programming/"/>
    
    <category term="å¹¶è¡Œè®¡ç®—" scheme="https://smarter.xin/tags/parallel-computing/"/>
    
    <category term="PMPP" scheme="https://smarter.xin/tags/PMPP/"/>
    
    <category term="å‰ç¼€å’Œ" scheme="https://smarter.xin/tags/prefix-sum/"/>
    
    <category term="Scan" scheme="https://smarter.xin/tags/Scan/"/>
    
    <category term="å·¥ä½œæ•ˆç‡" scheme="https://smarter.xin/tags/work-efficiency/"/>
    
  </entry>
  
  <entry>
    <title>PMPP-ç¬¬åç« ï¼šå½’çº¦å’Œæœ€å°åŒ–å‘æ•£</title>
    <link href="https://smarter.xin/posts/43b40d12/"/>
    <id>https://smarter.xin/posts/43b40d12/</id>
    <published>2026-01-18T02:14:18.000Z</published>
    <updated>2026-01-24T08:26:21.333Z</updated>
    
    <content type="html"><![CDATA[<h2 id="qian-yan" tabindex="-1" id="å‰è¨€">å‰è¨€</h2><p>ç¬¬ä¹ç« å­¦äº†ç›´æ–¹å›¾ï¼Œç”¨åŸå­æ“ä½œå¤„ç†è¾“å‡ºå†²çªã€‚è¿™ç« å­¦<strong>å½’çº¦ï¼ˆReductionï¼‰</strong>â€”â€”æŠŠä¸€ç»„æ•°æ®&quot;å½’çº¦&quot;æˆä¸€ä¸ªå€¼ï¼Œæ¯”å¦‚æ±‚å’Œã€æ±‚æœ€å¤§å€¼ã€‚çœ‹ä¼¼ç®€å•ï¼Œå®é™…æ¶‰åŠå¹¶è¡Œç®—æ³•çš„æ ¸å¿ƒé—®é¢˜ï¼šå¦‚ä½•é«˜æ•ˆåœ°åˆå¹¶éƒ¨åˆ†ç»“æœï¼Ÿå¦‚ä½•é¿å…åˆ†æ”¯å‘æ•£ï¼Ÿå¦‚ä½•æœ€å¤§åŒ–ç¡¬ä»¶åˆ©ç”¨ç‡ï¼Ÿç¬¬åç« ç³»ç»Ÿè®²è§£è¿™äº›æŠ€æœ¯ã€‚</p><blockquote><p><strong>ğŸ“¦ é…å¥—èµ„æº</strong>ï¼šæœ¬ç³»åˆ—æ–‡ç« é…æœ‰å®Œæ•´çš„ <a href="https://github.com/psmarter/PMPP-Learning">GitHub ä»“åº“</a>ï¼ŒåŒ…å«æ¯ç« çš„ç»ƒä¹ é¢˜è§£ç­”ã€CUDA ä»£ç å®ç°å’Œè¯¦ç»†æ³¨é‡Šã€‚æ‰€æœ‰ä»£ç éƒ½ç»è¿‡æµ‹è¯•ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œã€‚</p></blockquote><h2 id="gui-yue-ji-chu" tabindex="-1" id="å½’çº¦åŸºç¡€">å½’çº¦åŸºç¡€</h2><h3 id="shi-yao-shi-gui-yue" tabindex="-1" id="ä»€ä¹ˆæ˜¯å½’çº¦">ä»€ä¹ˆæ˜¯å½’çº¦</h3><p><strong>å½’çº¦</strong>ï¼šç”¨ä¸€ä¸ª<strong>äºŒå…ƒç»“åˆè¿ç®—</strong>æŠŠ N ä¸ªå…ƒç´ åˆå¹¶æˆ 1 ä¸ªå€¼ã€‚</p><p><strong>å¸¸è§å½’çº¦æ“ä½œ</strong>ï¼š</p><table><thead><tr><th>æ“ä½œ</th><th>è¿ç®—ç¬¦</th><th>å•ä½å…ƒ</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td>æ±‚å’Œ</td><td>+</td><td>0</td><td>1+2+3+4 = 10</td></tr><tr><td>æ±‚ç§¯</td><td>Ã—</td><td>1</td><td>1Ã—2Ã—3Ã—4 = 24</td></tr><tr><td>æœ€å¤§å€¼</td><td>max</td><td>-âˆ</td><td>max(1,5,3,2) = 5</td></tr><tr><td>æœ€å°å€¼</td><td>min</td><td>+âˆ</td><td>min(1,5,3,2) = 1</td></tr><tr><td>é€»è¾‘ä¸</td><td>&amp;&amp;</td><td>true</td><td>true &amp;&amp; false = false</td></tr><tr><td>é€»è¾‘æˆ–</td><td>||</td><td>false</td><td>true || false = true</td></tr><tr><td>ä½ä¸</td><td>&amp;</td><td>~0</td><td>0b1100 &amp; 0b1010 = 0b1000</td></tr><tr><td>ä½æˆ–</td><td>|</td><td>0</td><td>0b1100 | 0b1010 = 0b1110</td></tr></tbody></table><p><strong>ç»“åˆå¾‹</strong>æ˜¯å…³é”®ï¼š<code>(a âŠ• b) âŠ• c = a âŠ• (b âŠ• c)</code></p><p>æœ‰äº†ç»“åˆå¾‹ï¼Œå°±èƒ½ä»»æ„åˆ†ç»„å¹¶è¡Œè®¡ç®—ã€‚</p><h3 id="chuan-xing-gui-yue" tabindex="-1" id="ä¸²è¡Œå½’çº¦">ä¸²è¡Œå½’çº¦</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">float</span> <span class="title function_">sum_sequential</span><span class="params">(<span class="type">float</span> *data, <span class="type">int</span> n)</span> &#123;</span><br><span class="line">    <span class="type">float</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        sum += data[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ—¶é—´å¤æ‚åº¦ O(n)ï¼Œæ— æ³•åˆ©ç”¨å¹¶è¡Œæ€§ã€‚</p><h3 id="bing-xing-gui-yue-de-si-lu" tabindex="-1" id="å¹¶è¡Œå½’çº¦çš„æ€è·¯">å¹¶è¡Œå½’çº¦çš„æ€è·¯</h3><p><strong>æ ‘å½¢å½’çº¦</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Level 0: [a0, a1, a2, a3, a4, a5, a6, a7]</span><br><span class="line">Level 1: [a0+a1, a2+a3, a4+a5, a6+a7]</span><br><span class="line">Level 2: [a0+a1+a2+a3, a4+a5+a6+a7]</span><br><span class="line">Level 3: [a0+a1+a2+a3+a4+a5+a6+a7]</span><br></pre></td></tr></table></figure><p>æ¯å±‚æŠŠå…ƒç´ æ•°å‡åŠï¼Œlogâ‚‚N å±‚åå¾—åˆ°ç»“æœã€‚</p><p><strong>æ—¶é—´å¤æ‚åº¦</strong>ï¼šO(log N) æ­¥ï¼Œæ¯æ­¥ O(N/2^k) æ¬¡æ“ä½œ</p><p><strong>å·¥ä½œé‡</strong>ï¼šæ€»æ“ä½œæ•° = N/2 + N/4 + â€¦ + 1 = N - 1ï¼ˆä¸ä¸²è¡Œç›¸åŒï¼‰</p><p><strong>å¹¶è¡Œåº¦</strong>ï¼šç¬¬ k å±‚éœ€è¦ N/2^k ä¸ªå¹¶è¡Œæ“ä½œ</p><h2 id="po-su-bing-xing-gui-yue" tabindex="-1" id="æœ´ç´ å¹¶è¡Œå½’çº¦">æœ´ç´ å¹¶è¡Œå½’çº¦</h2><h3 id="xiang-lin-pei-dui" tabindex="-1" id="ç›¸é‚»é…å¯¹">ç›¸é‚»é…å¯¹</h3><p>æœ€ç›´è§‚çš„å¹¶è¡ŒåŒ–ï¼šç›¸é‚»å…ƒç´ é…å¯¹æ±‚å’Œ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">__global__ void reduce_naive(float *g_data, float *g_result, int n) &#123;</span><br><span class="line">    extern __shared__ float sdata[];</span><br><span class="line">    </span><br><span class="line">    int tid = threadIdx.x;</span><br><span class="line">    int i = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">    </span><br><span class="line">    // åŠ è½½åˆ°å…±äº«å†…å­˜</span><br><span class="line">    sdata[tid] = (i &lt; n) ? g_data[i] : 0;</span><br><span class="line">    __syncthreads();</span><br><span class="line">    </span><br><span class="line">    // æ ‘å½¢å½’çº¦</span><br><span class="line">    for (int stride = 1; stride &lt; blockDim.x; stride *= 2) &#123;</span><br><span class="line">        if (tid % (2 * stride) == 0) &#123;</span><br><span class="line">            sdata[tid] += sdata[tid + stride];</span><br><span class="line">        &#125;</span><br><span class="line">        __syncthreads();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // å†™å›ç»“æœ</span><br><span class="line">    if (tid == 0) &#123;</span><br><span class="line">        g_result[blockIdx.x] = sdata[0];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="wen-ti-fen-zhi-fa-san" tabindex="-1" id="é—®é¢˜ï¼šåˆ†æ”¯å‘æ•£">é—®é¢˜ï¼šåˆ†æ”¯å‘æ•£</h3><p>çœ‹è¿™ä¸ªæ¡ä»¶ï¼š<code>if (tid % (2 * stride) == 0)</code></p><p><strong>Level 0</strong> (stride=1)ï¼šçº¿ç¨‹ 0,2,4,6â€¦ æ´»è·ƒï¼Œ1,3,5,7â€¦ ç©ºé—²<br><strong>Level 1</strong> (stride=2)ï¼šçº¿ç¨‹ 0,4,8â€¦ æ´»è·ƒ<br><strong>Level 2</strong> (stride=4)ï¼šçº¿ç¨‹ 0,8â€¦ æ´»è·ƒ</p><p>Warp å†…æœ‰çš„çº¿ç¨‹æ´»è·ƒã€æœ‰çš„ç©ºé—² = <strong>åˆ†æ”¯å‘æ•£</strong>ï¼</p><p>Warp å¿…é¡»ä¸²è¡Œæ‰§è¡Œä¸¤ä¸ªåˆ†æ”¯ï¼Œæ•ˆç‡å‡åŠã€‚</p><h3 id="wen-ti-bank-chong-tu" tabindex="-1" id="é—®é¢˜ï¼šBank-å†²çª">é—®é¢˜ï¼šBank å†²çª</h3><p><code>sdata[tid]</code> å’Œ <code>sdata[tid + stride]</code> çš„è®¿é—®æ¨¡å¼ï¼š</p><ul><li>stride=1ï¼šçº¿ç¨‹ 0 è®¿é—® [0,1]ï¼Œçº¿ç¨‹ 2 è®¿é—® [2,3]â€¦ï¼ˆæ— å†²çªï¼‰</li><li>stride=16ï¼šçº¿ç¨‹ 0 è®¿é—® [0,16]ï¼Œçº¿ç¨‹ 32 è®¿é—® [32,48]â€¦</li></ul><p>stride æ˜¯ 2 çš„å¹‚æ—¶ï¼Œå¯èƒ½äº§ç”Ÿ Bank å†²çªã€‚</p><h2 id="you-hua-1-jiao-cuo-pei-dui" tabindex="-1" id="ä¼˜åŒ–-1ï¼šäº¤é”™é…å¯¹">ä¼˜åŒ– 1ï¼šäº¤é”™é…å¯¹</h2><h3 id="gai-jin-si-lu" tabindex="-1" id="æ”¹è¿›æ€è·¯">æ”¹è¿›æ€è·¯</h3><p>æŠŠ&quot;ç©ºé—²çº¿ç¨‹åœ¨å³è¾¹&quot;æ”¹æˆ&quot;ç©ºé—²çº¿ç¨‹åœ¨åé¢&quot;ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">æœ´ç´ ï¼šçº¿ç¨‹ 0,2,4,6 æ´»è·ƒï¼Œ1,3,5,7 ç©ºé—²</span><br><span class="line">äº¤é”™ï¼šçº¿ç¨‹ 0,1,2,3 æ´»è·ƒï¼Œ4,5,6,7 ç©ºé—²</span><br></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œæ´»è·ƒçº¿ç¨‹æ˜¯è¿ç»­çš„ï¼Œå‰å‡ ä¸ª Warp æ»¡è½½ï¼Œæœ€åçš„ Warp æ‰é€æ¸ç©ºé—²ã€‚</p><h3 id="shi-xian" tabindex="-1" id="å®ç°">å®ç°</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">__global__ void reduce_interleaved(float *g_data, float *g_result, int n) &#123;</span><br><span class="line">    extern __shared__ float sdata[];</span><br><span class="line">    </span><br><span class="line">    int tid = threadIdx.x;</span><br><span class="line">    int i = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">    </span><br><span class="line">    sdata[tid] = (i &lt; n) ? g_data[i] : 0;</span><br><span class="line">    __syncthreads();</span><br><span class="line">    </span><br><span class="line">    // äº¤é”™å½’çº¦</span><br><span class="line">    for (int stride = blockDim.x / 2; stride &gt; 0; stride &gt;&gt;= 1) &#123;</span><br><span class="line">        if (tid &lt; stride) &#123;</span><br><span class="line">            sdata[tid] += sdata[tid + stride];</span><br><span class="line">        &#125;</span><br><span class="line">        __syncthreads();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    if (tid == 0) &#123;</span><br><span class="line">        g_result[blockIdx.x] = sdata[0];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="fen-xi" tabindex="-1" id="åˆ†æ">åˆ†æ</h3><p><strong>Level 0</strong> (stride=128)ï¼šçº¿ç¨‹ 0-127 æ´»è·ƒ<br><strong>Level 1</strong> (stride=64)ï¼šçº¿ç¨‹ 0-63 æ´»è·ƒ<br><strong>Level 2</strong> (stride=32)ï¼šçº¿ç¨‹ 0-31 æ´»è·ƒï¼ˆæ°å¥½ä¸€ä¸ª Warpï¼‰</p><p>å‰å‡ å±‚æœ‰å¤šä¸ªå®Œæ•´ Warp åŒæ—¶å·¥ä½œï¼Œåˆ†æ”¯å‘æ•£åªåœ¨æœ€åå‡ å±‚å‡ºç°ã€‚</p><p><strong>æ€§èƒ½æå‡</strong>ï¼šçº¦ 2Ã— ç›¸æ¯”æœ´ç´ ç‰ˆæœ¬ã€‚</p><h2 id="you-hua-2-shou-ci-jia-zai-shi-gui-yue" tabindex="-1" id="ä¼˜åŒ–-2ï¼šé¦–æ¬¡åŠ è½½æ—¶å½’çº¦">ä¼˜åŒ– 2ï¼šé¦–æ¬¡åŠ è½½æ—¶å½’çº¦</h2><h3 id="guan-cha" tabindex="-1" id="è§‚å¯Ÿ">è§‚å¯Ÿ</h3><p>æ¯ä¸ªçº¿ç¨‹åªåŠ è½½ä¸€ä¸ªå…ƒç´ ï¼Œä½† Block æ•°å¯èƒ½è¿œå¤šäº SM æ•°ã€‚å¦‚æœè®©æ¯ä¸ªçº¿ç¨‹åŠ è½½å¤šä¸ªå…ƒç´ å¹¶åœ¨åŠ è½½æ—¶æ±‚å’Œï¼Œå¯ä»¥å‡å°‘ Block æ•°ï¼Œæé«˜æ•ˆç‡ã€‚</p><h3 id="shi-xian-1" tabindex="-1" id="å®ç°-2">å®ç°</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">__global__ void reduce_first_add(float *g_data, float *g_result, int n) &#123;</span><br><span class="line">    extern __shared__ float sdata[];</span><br><span class="line">    </span><br><span class="line">    int tid = threadIdx.x;</span><br><span class="line">    int i = blockIdx.x * (blockDim.x * 2) + threadIdx.x;</span><br><span class="line">    </span><br><span class="line">    // é¦–æ¬¡åŠ è½½æ—¶å°±æ±‚å’Œä¸¤ä¸ªå…ƒç´ </span><br><span class="line">    float sum = 0;</span><br><span class="line">    if (i &lt; n) sum += g_data[i];</span><br><span class="line">    if (i + blockDim.x &lt; n) sum += g_data[i + blockDim.x];</span><br><span class="line">    sdata[tid] = sum;</span><br><span class="line">    __syncthreads();</span><br><span class="line">    </span><br><span class="line">    // åç»­å½’çº¦</span><br><span class="line">    for (int stride = blockDim.x / 2; stride &gt; 0; stride &gt;&gt;= 1) &#123;</span><br><span class="line">        if (tid &lt; stride) &#123;</span><br><span class="line">            sdata[tid] += sdata[tid + stride];</span><br><span class="line">        &#125;</span><br><span class="line">        __syncthreads();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    if (tid == 0) &#123;</span><br><span class="line">        g_result[blockIdx.x] = sdata[0];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="kuo-zhan-grid-stride-jia-zai" tabindex="-1" id="æ‰©å±•ï¼šGrid-Stride-åŠ è½½">æ‰©å±•ï¼šGrid-Stride åŠ è½½</h3><p>è®©æ¯ä¸ªçº¿ç¨‹åŠ è½½å¤šä¸ªå…ƒç´ ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">__global__ void reduce_grid_stride(float *g_data, float *g_result, int n) &#123;</span><br><span class="line">    extern __shared__ float sdata[];</span><br><span class="line">    </span><br><span class="line">    int tid = threadIdx.x;</span><br><span class="line">    int i = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">    int gridSize = blockDim.x * gridDim.x;</span><br><span class="line">    </span><br><span class="line">    // Grid-stride ç´¯åŠ </span><br><span class="line">    float sum = 0;</span><br><span class="line">    while (i &lt; n) &#123;</span><br><span class="line">        sum += g_data[i];</span><br><span class="line">        i += gridSize;</span><br><span class="line">    &#125;</span><br><span class="line">    sdata[tid] = sum;</span><br><span class="line">    __syncthreads();</span><br><span class="line">    </span><br><span class="line">    // æ ‘å½¢å½’çº¦</span><br><span class="line">    for (int stride = blockDim.x / 2; stride &gt; 0; stride &gt;&gt;= 1) &#123;</span><br><span class="line">        if (tid &lt; stride) &#123;</span><br><span class="line">            sdata[tid] += sdata[tid + stride];</span><br><span class="line">        &#125;</span><br><span class="line">        __syncthreads();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    if (tid == 0) &#123;</span><br><span class="line">        g_result[blockIdx.x] = sdata[0];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ä¼˜åŠ¿</strong>ï¼š</p><ol><li>Block æ•°é‡å¯ä»¥å›ºå®šï¼ˆå¦‚ 256ï¼‰ï¼Œä¸éšæ•°æ®é‡å˜åŒ–</li><li>æ¯çº¿ç¨‹åšæ›´å¤šæœ‰æ•ˆå·¥ä½œï¼Œåˆ†æ‘ŠåŒæ­¥å¼€é”€</li><li>æ›´å¥½çš„æŒ‡ä»¤çº§å¹¶è¡Œ</li></ol><h2 id="you-hua-3-zhan-kai-zui-hou-warp" tabindex="-1" id="ä¼˜åŒ–-3ï¼šå±•å¼€æœ€å-Warp">ä¼˜åŒ– 3ï¼šå±•å¼€æœ€å Warp</h2><h3 id="guan-cha-1" tabindex="-1" id="è§‚å¯Ÿ-2">è§‚å¯Ÿ</h3><p>å½“ stride &lt; 32 æ—¶ï¼Œåªæœ‰ä¸€ä¸ª Warp åœ¨å·¥ä½œã€‚Warp å†…çº¿ç¨‹è‡ªåŠ¨åŒæ­¥ï¼ˆSIMTï¼‰ï¼Œä¸éœ€è¦ <code>__syncthreads()</code>ï¼</p><h3 id="shi-xian-2" tabindex="-1" id="å®ç°-3">å®ç°</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">__device__ void warpReduce(volatile float *sdata, int tid) &#123;</span><br><span class="line">    sdata[tid] += sdata[tid + 32];</span><br><span class="line">    sdata[tid] += sdata[tid + 16];</span><br><span class="line">    sdata[tid] += sdata[tid + 8];</span><br><span class="line">    sdata[tid] += sdata[tid + 4];</span><br><span class="line">    sdata[tid] += sdata[tid + 2];</span><br><span class="line">    sdata[tid] += sdata[tid + 1];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__global__ void reduce_warp_unroll(float *g_data, float *g_result, int n) &#123;</span><br><span class="line">    extern __shared__ float sdata[];</span><br><span class="line">    </span><br><span class="line">    int tid = threadIdx.x;</span><br><span class="line">    int i = blockIdx.x * blockDim.x * 2 + threadIdx.x;</span><br><span class="line">    </span><br><span class="line">    sdata[tid] = 0;</span><br><span class="line">    if (i &lt; n) sdata[tid] += g_data[i];</span><br><span class="line">    if (i + blockDim.x &lt; n) sdata[tid] += g_data[i + blockDim.x];</span><br><span class="line">    __syncthreads();</span><br><span class="line">    </span><br><span class="line">    // å¸¸è§„å½’çº¦ï¼ˆstride &gt;= 64ï¼‰</span><br><span class="line">    for (int stride = blockDim.x / 2; stride &gt; 32; stride &gt;&gt;= 1) &#123;</span><br><span class="line">        if (tid &lt; stride) &#123;</span><br><span class="line">            sdata[tid] += sdata[tid + stride];</span><br><span class="line">        &#125;</span><br><span class="line">        __syncthreads();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // Warp å†…å±•å¼€ï¼ˆstride &lt; 32ï¼‰</span><br><span class="line">    if (tid &lt; 32) &#123;</span><br><span class="line">        warpReduce(sdata, tid);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    if (tid == 0) &#123;</span><br><span class="line">        g_result[blockIdx.x] = sdata[0];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="guan-jian-dian" tabindex="-1" id="å…³é”®ç‚¹">å…³é”®ç‚¹</h3><p><strong>volatile</strong>ï¼šå‘Šè¯‰ç¼–è¯‘å™¨ä¸è¦ä¼˜åŒ–æ‰å¯¹ sdata çš„è¯»å†™ï¼Œç¡®ä¿æ¯æ¬¡éƒ½è®¿é—®å…±äº«å†…å­˜ã€‚</p><p><strong>éšå¼åŒæ­¥</strong>ï¼šWarp å†…çš„ 32 ä¸ªçº¿ç¨‹æ‰§è¡Œç›¸åŒæŒ‡ä»¤ï¼Œè‡ªåŠ¨ä¿æŒåŒæ­¥ã€‚</p><p><strong>æ€§èƒ½æå‡</strong>ï¼šå‡å°‘ 5 æ¬¡ <code>__syncthreads()</code> è°ƒç”¨ã€‚</p><h2 id="you-hua-4-wan-quan-zhan-kai" tabindex="-1" id="ä¼˜åŒ–-4ï¼šå®Œå…¨å±•å¼€">ä¼˜åŒ– 4ï¼šå®Œå…¨å±•å¼€</h2><h3 id="dang-block-da-xiao-yi-zhi-shi" tabindex="-1" id="å½“-Block-å¤§å°å·²çŸ¥æ—¶">å½“ Block å¤§å°å·²çŸ¥æ—¶</h3><p>å¦‚æœ Block å¤§å°æ˜¯ç¼–è¯‘æ—¶å¸¸é‡ï¼ˆå¦‚ 256ï¼‰ï¼Œå¯ä»¥å®Œå…¨å±•å¼€å¾ªç¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">template &lt;unsigned int blockSize&gt;</span><br><span class="line">__global__ void reduce_complete_unroll(float *g_data, float *g_result, int n) &#123;</span><br><span class="line">    extern __shared__ float sdata[];</span><br><span class="line">    </span><br><span class="line">    int tid = threadIdx.x;</span><br><span class="line">    int i = blockIdx.x * blockSize * 2 + threadIdx.x;</span><br><span class="line">    </span><br><span class="line">    sdata[tid] = 0;</span><br><span class="line">    if (i &lt; n) sdata[tid] += g_data[i];</span><br><span class="line">    if (i + blockSize &lt; n) sdata[tid] += g_data[i + blockSize];</span><br><span class="line">    __syncthreads();</span><br><span class="line">    </span><br><span class="line">    // ç¼–è¯‘æ—¶å±•å¼€</span><br><span class="line">    if (blockSize &gt;= 512) &#123;</span><br><span class="line">        if (tid &lt; 256) sdata[tid] += sdata[tid + 256];</span><br><span class="line">        __syncthreads();</span><br><span class="line">    &#125;</span><br><span class="line">    if (blockSize &gt;= 256) &#123;</span><br><span class="line">        if (tid &lt; 128) sdata[tid] += sdata[tid + 128];</span><br><span class="line">        __syncthreads();</span><br><span class="line">    &#125;</span><br><span class="line">    if (blockSize &gt;= 128) &#123;</span><br><span class="line">        if (tid &lt; 64) sdata[tid] += sdata[tid + 64];</span><br><span class="line">        __syncthreads();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // Warp å†…å±•å¼€</span><br><span class="line">    if (tid &lt; 32) &#123;</span><br><span class="line">        volatile float *smem = sdata;</span><br><span class="line">        if (blockSize &gt;= 64) smem[tid] += smem[tid + 32];</span><br><span class="line">        if (blockSize &gt;= 32) smem[tid] += smem[tid + 16];</span><br><span class="line">        if (blockSize &gt;= 16) smem[tid] += smem[tid + 8];</span><br><span class="line">        if (blockSize &gt;= 8)  smem[tid] += smem[tid + 4];</span><br><span class="line">        if (blockSize &gt;= 4)  smem[tid] += smem[tid + 2];</span><br><span class="line">        if (blockSize &gt;= 2)  smem[tid] += smem[tid + 1];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    if (tid == 0) &#123;</span><br><span class="line">        g_result[blockIdx.x] = sdata[0];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="qi-dong" tabindex="-1" id="å¯åŠ¨">å¯åŠ¨</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// æ ¹æ® Block å¤§å°é€‰æ‹©æ¨¡æ¿å®ä¾‹</span><br><span class="line">switch (blockSize) &#123;</span><br><span class="line">    case 512: reduce_complete_unroll&lt;512&gt;&lt;&lt;&lt;grid, 512, 512*sizeof(float)&gt;&gt;&gt;(...); break;</span><br><span class="line">    case 256: reduce_complete_unroll&lt;256&gt;&lt;&lt;&lt;grid, 256, 256*sizeof(float)&gt;&gt;&gt;(...); break;</span><br><span class="line">    case 128: reduce_complete_unroll&lt;128&gt;&lt;&lt;&lt;grid, 128, 128*sizeof(float)&gt;&gt;&gt;(...); break;</span><br><span class="line">    // ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ä¼˜åŠ¿</strong>ï¼šç¼–è¯‘å™¨å¯ä»¥å®Œå…¨å±•å¼€å¾ªç¯ï¼Œæ¶ˆé™¤å¾ªç¯å¼€é”€å’Œåˆ†æ”¯ã€‚</p><h2 id="you-hua-5-warp-shuffle" tabindex="-1" id="ä¼˜åŒ–-5ï¼šWarp-Shuffle">ä¼˜åŒ– 5ï¼šWarp Shuffle</h2><h3 id="xian-dai-fang-fa" tabindex="-1" id="ç°ä»£æ–¹æ³•">ç°ä»£æ–¹æ³•</h3><p>ä» Kepler æ¶æ„å¼€å§‹ï¼ŒCUDA æä¾› <strong>Warp Shuffle</strong> æŒ‡ä»¤ï¼Œçº¿ç¨‹å¯ä»¥ç›´æ¥äº¤æ¢å¯„å­˜å™¨å€¼ï¼Œæ— éœ€å…±äº«å†…å­˜ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__device__ float warpReduceSum(float val) &#123;</span><br><span class="line">    for (int offset = 16; offset &gt; 0; offset /= 2) &#123;</span><br><span class="line">        val += __shfl_down_sync(0xffffffff, val, offset);</span><br><span class="line">    &#125;</span><br><span class="line">    return val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="wan-zheng-shi-xian" tabindex="-1" id="å®Œæ•´å®ç°">å®Œæ•´å®ç°</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">__global__ void reduce_shuffle(float *g_data, float *g_result, int n) &#123;</span><br><span class="line">    int tid = threadIdx.x;</span><br><span class="line">    int i = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">    int gridSize = blockDim.x * gridDim.x;</span><br><span class="line">    </span><br><span class="line">    // Grid-stride ç´¯åŠ </span><br><span class="line">    float sum = 0;</span><br><span class="line">    while (i &lt; n) &#123;</span><br><span class="line">        sum += g_data[i];</span><br><span class="line">        i += gridSize;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // Warp å†…å½’çº¦ï¼ˆshuffleï¼‰</span><br><span class="line">    sum = warpReduceSum(sum);</span><br><span class="line">    </span><br><span class="line">    // Warp é—´å½’çº¦</span><br><span class="line">    __shared__ float warpSums[32];  // æœ€å¤š 32 ä¸ª Warp</span><br><span class="line">    int lane = tid % 32;</span><br><span class="line">    int wid = tid / 32;</span><br><span class="line">    </span><br><span class="line">    if (lane == 0) &#123;</span><br><span class="line">        warpSums[wid] = sum;</span><br><span class="line">    &#125;</span><br><span class="line">    __syncthreads();</span><br><span class="line">    </span><br><span class="line">    // ç¬¬ä¸€ä¸ª Warp åšæœ€ç»ˆå½’çº¦</span><br><span class="line">    if (wid == 0) &#123;</span><br><span class="line">        sum = (tid &lt; blockDim.x / 32) ? warpSums[lane] : 0;</span><br><span class="line">        sum = warpReduceSum(sum);</span><br><span class="line">        </span><br><span class="line">        if (tid == 0) &#123;</span><br><span class="line">            g_result[blockIdx.x] = sum;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="shuffle-han-shu" tabindex="-1" id="Shuffle-å‡½æ•°">Shuffle å‡½æ•°</h3><table><thead><tr><th>å‡½æ•°</th><th>åŠŸèƒ½</th></tr></thead><tbody><tr><td><code>__shfl_sync</code></td><td>ä»æŒ‡å®š lane è·å–å€¼</td></tr><tr><td><code>__shfl_up_sync</code></td><td>ä»ä½ lane è·å–å€¼</td></tr><tr><td><code>__shfl_down_sync</code></td><td>ä»é«˜ lane è·å–å€¼</td></tr><tr><td><code>__shfl_xor_sync</code></td><td>ä¸ XOR åç§»çš„ lane äº¤æ¢</td></tr></tbody></table><p><strong>ä¼˜åŠ¿</strong>ï¼š</p><ol><li>ä¸éœ€è¦å…±äº«å†…å­˜</li><li>å»¶è¿Ÿæ¯”å…±äº«å†…å­˜ä½</li><li>æ—  Bank å†²çª</li></ol><h2 id="duo-ji-gui-yue" tabindex="-1" id="å¤šçº§å½’çº¦">å¤šçº§å½’çº¦</h2><h3 id="dan-block-bu-gou" tabindex="-1" id="å•-Block-ä¸å¤Ÿ">å• Block ä¸å¤Ÿ</h3><p>å¦‚æœæ•°æ®é‡è¶…è¿‡å• Block èƒ½å¤„ç†çš„èŒƒå›´ï¼Œéœ€è¦å¤šçº§å½’çº¦ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Level 1: æ¯ä¸ª Block å½’çº¦è‡ªå·±çš„éƒ¨åˆ† â†’ gridDim ä¸ªéƒ¨åˆ†å’Œ</span><br><span class="line">Level 2: å†å¯åŠ¨ä¸€ä¸ª Kernel å½’çº¦è¿™äº›éƒ¨åˆ†å’Œ</span><br><span class="line">...</span><br><span class="line">é‡å¤ç›´åˆ°åªå‰©ä¸€ä¸ªå€¼</span><br></pre></td></tr></table></figure><h3 id="shi-xian-3" tabindex="-1" id="å®ç°-4">å®ç°</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">void reduce_multi_level(float *d_data, float *d_result, int n) &#123;</span><br><span class="line">    int blockSize = 256;</span><br><span class="line">    int numBlocks = (n + blockSize * 2 - 1) / (blockSize * 2);</span><br><span class="line">    </span><br><span class="line">    float *d_partial;</span><br><span class="line">    cudaMalloc(&amp;d_partial, numBlocks * sizeof(float));</span><br><span class="line">    </span><br><span class="line">    // Level 1</span><br><span class="line">    reduce_kernel&lt;&lt;&lt;numBlocks, blockSize, blockSize * sizeof(float)&gt;&gt;&gt;</span><br><span class="line">        (d_data, d_partial, n);</span><br><span class="line">    </span><br><span class="line">    // åç»­ Level</span><br><span class="line">    while (numBlocks &gt; 1) &#123;</span><br><span class="line">        int n_next = numBlocks;</span><br><span class="line">        numBlocks = (n_next + blockSize * 2 - 1) / (blockSize * 2);</span><br><span class="line">        </span><br><span class="line">        reduce_kernel&lt;&lt;&lt;numBlocks, blockSize, blockSize * sizeof(float)&gt;&gt;&gt;</span><br><span class="line">            (d_partial, d_partial, n_next);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // æ‹·è´æœ€ç»ˆç»“æœ</span><br><span class="line">    cudaMemcpy(d_result, d_partial, sizeof(float), cudaMemcpyDeviceToHost);</span><br><span class="line">    cudaFree(d_partial);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="you-hua-yuan-zi-lei-jia" tabindex="-1" id="ä¼˜åŒ–ï¼šåŸå­ç´¯åŠ ">ä¼˜åŒ–ï¼šåŸå­ç´¯åŠ </h3><p>å¦‚æœåªéœ€è¦æœ€ç»ˆå’Œï¼Œå¯ä»¥ç”¨åŸå­æ“ä½œé¿å…å¤šçº§ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">__global__ void reduce_atomic(float *g_data, float *g_result, int n) &#123;</span><br><span class="line">    // ... å¸¸è§„ Block å†…å½’çº¦ ...</span><br><span class="line">    </span><br><span class="line">    if (tid == 0) &#123;</span><br><span class="line">        atomicAdd(g_result, sdata[0]);  // ç›´æ¥ç´¯åŠ åˆ°ç»“æœ</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ³¨æ„</strong>ï¼šéœ€è¦å…ˆå°† <code>g_result</code> åˆå§‹åŒ–ä¸º 0ã€‚</p><h2 id="fen-zhi-fa-san-shen-ru-fen-xi" tabindex="-1" id="åˆ†æ”¯å‘æ•£æ·±å…¥åˆ†æ">åˆ†æ”¯å‘æ•£æ·±å…¥åˆ†æ</h2><h3 id="fa-san-de-dai-jie" tabindex="-1" id="å‘æ•£çš„ä»£ä»·">å‘æ•£çš„ä»£ä»·</h3><p>å½“ Warp å†…çº¿ç¨‹èµ°ä¸åŒåˆ†æ”¯æ—¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if (condition) &#123;</span><br><span class="line">    doA();  // éƒ¨åˆ†çº¿ç¨‹</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    doB();  // å…¶ä»–çº¿ç¨‹</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¡¬ä»¶æ‰§è¡Œï¼š</p><ol><li>æ‰€æœ‰çº¿ç¨‹æ‰§è¡Œ doA()ï¼Œä¸æ»¡è¶³æ¡ä»¶çš„çº¿ç¨‹ç»“æœè¢«ä¸¢å¼ƒ</li><li>æ‰€æœ‰çº¿ç¨‹æ‰§è¡Œ doB()ï¼Œæ»¡è¶³æ¡ä»¶çš„çº¿ç¨‹ç»“æœè¢«ä¸¢å¼ƒ</li><li>æ€»æ—¶é—´ = doA() + doB()</li></ol><p><strong>å‘æ•£ç¨‹åº¦</strong>å½±å“æ€§èƒ½ï¼š</p><table><thead><tr><th>å‘æ•£æ¯”ä¾‹</th><th>æ€§èƒ½å½±å“</th></tr></thead><tbody><tr><td>0/32</td><td>æ— å½±å“</td></tr><tr><td>1/32</td><td>å‡ ä¹æ— å½±å“</td></tr><tr><td>16/32</td><td>çº¦ 50% æ€§èƒ½</td></tr><tr><td>æŒ‰ Warp è¾¹ç•Œ</td><td>æ— å‘æ•£</td></tr></tbody></table><h3 id="zui-xiao-hua-fa-san-de-ce-lue" tabindex="-1" id="æœ€å°åŒ–å‘æ•£çš„ç­–ç•¥">æœ€å°åŒ–å‘æ•£çš„ç­–ç•¥</h3><p><strong>1. è®©æ¡ä»¶æŒ‰ Warp å¯¹é½</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// å·®ï¼šæ··åˆå‘æ•£</span><br><span class="line">if (tid % 2 == 0) &#123; ... &#125;</span><br><span class="line"></span><br><span class="line">// å¥½ï¼šWarp å†…æ— å‘æ•£</span><br><span class="line">if (tid &lt; 128) &#123; ... &#125;  // å‰ 4 ä¸ª Warp vs å 4 ä¸ª Warp</span><br></pre></td></tr></table></figure><p><strong>2. ç”¨ç®—æœ¯æ›¿ä»£åˆ†æ”¯</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// æœ‰åˆ†æ”¯</span><br><span class="line">if (a &gt; b) result = a;</span><br><span class="line">else result = b;</span><br><span class="line"></span><br><span class="line">// æ— åˆ†æ”¯</span><br><span class="line">result = (a &gt; b) * a + (a &lt;= b) * b;</span><br><span class="line"></span><br><span class="line">// æ›´å¥½ï¼šç”¨å†…ç½®å‡½æ•°</span><br><span class="line">result = max(a, b);</span><br></pre></td></tr></table></figure><p><strong>3. é¢„å…ˆåˆ†ç¦»æ•°æ®</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// å·®ï¼šè¿è¡Œæ—¶åˆ†æ”¯</span><br><span class="line">if (data[i] &gt; threshold) processA();</span><br><span class="line">else processB();</span><br><span class="line"></span><br><span class="line">// å¥½ï¼šé¢„å¤„ç†åˆ†ç¦»</span><br><span class="line">// Kernel 1: åˆ†ç¦»æ•°æ®</span><br><span class="line">// Kernel 2: æ‰¹é‡å¤„ç† A ç±»</span><br><span class="line">// Kernel 3: æ‰¹é‡å¤„ç† B ç±»</span><br></pre></td></tr></table></figure><h3 id="gui-yue-zhong-de-fa-san-kong-zhi" tabindex="-1" id="å½’çº¦ä¸­çš„å‘æ•£æ§åˆ¶">å½’çº¦ä¸­çš„å‘æ•£æ§åˆ¶</h3><p>æœ´ç´  vs äº¤é”™çš„å¯¹æ¯”ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">æœ´ç´  (stride=1):</span><br><span class="line">  Warp 0: threads 0,2,4,...,30 æ´»è·ƒï¼ˆ16ä¸ªï¼‰</span><br><span class="line">  â†ª æ¯ä¸ª Warp éƒ½æœ‰ 50% å‘æ•£</span><br><span class="line"></span><br><span class="line">äº¤é”™ (stride=128):</span><br><span class="line">  Warp 0-3: å…¨éƒ¨æ´»è·ƒ</span><br><span class="line">  Warp 4-7: å…¨éƒ¨ç©ºé—²</span><br><span class="line">  â†ª æ²¡æœ‰ Warp å†…å‘æ•£ï¼</span><br></pre></td></tr></table></figure><h2 id="xing-neng-dui-bi" tabindex="-1" id="æ€§èƒ½å¯¹æ¯”">æ€§èƒ½å¯¹æ¯”</h2><p>ä»¥ 2Â²â´ï¼ˆçº¦ 1600 ä¸‡ï¼‰ä¸ª float æ±‚å’Œä¸ºä¾‹ï¼š</p><table><thead><tr><th>ä¼˜åŒ–ç‰ˆæœ¬</th><th>å¸¦å®½åˆ©ç”¨ç‡</th><th>ç›¸å¯¹æ€§èƒ½</th></tr></thead><tbody><tr><td>æœ´ç´ ç›¸é‚»é…å¯¹</td><td>4%</td><td>1Ã—</td></tr><tr><td>äº¤é”™é…å¯¹</td><td>8%</td><td>2Ã—</td></tr><tr><td>é¦–æ¬¡åŠ è½½å½’çº¦</td><td>16%</td><td>4Ã—</td></tr><tr><td>å±•å¼€æœ€å Warp</td><td>25%</td><td>6Ã—</td></tr><tr><td>å®Œå…¨å±•å¼€</td><td>40%</td><td>10Ã—</td></tr><tr><td>+ Warp Shuffle</td><td>60%</td><td>15Ã—</td></tr></tbody></table><p>å¸¦å®½åˆ©ç”¨ç‡ 60% å·²ç»å¾ˆé«˜â€”â€”å‰©ä½™å¼€é”€æ¥è‡ª Kernel å¯åŠ¨ã€åŒæ­¥ç­‰ä¸å¯é¿å…çš„å¼€é”€ã€‚</p><h2 id="qi-ta-gui-yue-cao-zuo" tabindex="-1" id="å…¶ä»–å½’çº¦æ“ä½œ">å…¶ä»–å½’çº¦æ“ä½œ</h2><h3 id="zui-da-zhi-zui-xiao-zhi" tabindex="-1" id="æœ€å¤§å€¼-æœ€å°å€¼">æœ€å¤§å€¼/æœ€å°å€¼</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__device__ float warpReduceMax(float val) &#123;</span><br><span class="line">    for (int offset = 16; offset &gt; 0; offset /= 2) &#123;</span><br><span class="line">        val = max(val, __shfl_down_sync(0xffffffff, val, offset));</span><br><span class="line">    &#125;</span><br><span class="line">    return val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="dai-suo-yin-de-zui-da-zhi" tabindex="-1" id="å¸¦ç´¢å¼•çš„æœ€å¤§å€¼">å¸¦ç´¢å¼•çš„æœ€å¤§å€¼</h3><p>è¿”å›æœ€å¤§å€¼åŠå…¶ä½ç½®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">__device__ void warpReduceArgMax(float &amp;val, int &amp;idx) &#123;</span><br><span class="line">    for (int offset = 16; offset &gt; 0; offset /= 2) &#123;</span><br><span class="line">        float other_val = __shfl_down_sync(0xffffffff, val, offset);</span><br><span class="line">        int other_idx = __shfl_down_sync(0xffffffff, idx, offset);</span><br><span class="line">        if (other_val &gt; val) &#123;</span><br><span class="line">            val = other_val;</span><br><span class="line">            idx = other_idx;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="dian-ji" tabindex="-1" id="ç‚¹ç§¯">ç‚¹ç§¯</h3><p>ä¸¤ä¸ªå‘é‡çš„ç‚¹ç§¯ = é€å…ƒç´ ä¹˜æ³• + æ±‚å’Œå½’çº¦ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">__global__ void dotProduct(float *a, float *b, float *result, int n) &#123;</span><br><span class="line">    extern __shared__ float sdata[];</span><br><span class="line">    </span><br><span class="line">    int tid = threadIdx.x;</span><br><span class="line">    int i = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">    </span><br><span class="line">    float sum = 0;</span><br><span class="line">    while (i &lt; n) &#123;</span><br><span class="line">        sum += a[i] * b[i];</span><br><span class="line">        i += blockDim.x * gridDim.x;</span><br><span class="line">    &#125;</span><br><span class="line">    sdata[tid] = sum;</span><br><span class="line">    __syncthreads();</span><br><span class="line">    </span><br><span class="line">    // å½’çº¦</span><br><span class="line">    // ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="cub-ku" tabindex="-1" id="CUB-åº“">CUB åº“</h2><h3 id="wei-shi-yao-yong-ku" tabindex="-1" id="ä¸ºä»€ä¹ˆç”¨åº“">ä¸ºä»€ä¹ˆç”¨åº“</h3><p>æ‰‹å†™å½’çº¦å®¹æ˜“å‡ºé”™ï¼Œä¸”éš¾ä»¥è¦†ç›–æ‰€æœ‰ä¼˜åŒ–ã€‚NVIDIA çš„ CUB åº“æä¾›é«˜åº¦ä¼˜åŒ–çš„å®ç°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;cub/cub.cuh&gt;</span><br><span class="line"></span><br><span class="line">void reduceWithCub(float *d_data, float *d_result, int n) &#123;</span><br><span class="line">    // ç¡®å®šä¸´æ—¶å­˜å‚¨å¤§å°</span><br><span class="line">    void *d_temp = nullptr;</span><br><span class="line">    size_t temp_bytes = 0;</span><br><span class="line">    cub::DeviceReduce::Sum(d_temp, temp_bytes, d_data, d_result, n);</span><br><span class="line">    </span><br><span class="line">    // åˆ†é…ä¸´æ—¶å­˜å‚¨</span><br><span class="line">    cudaMalloc(&amp;d_temp, temp_bytes);</span><br><span class="line">    </span><br><span class="line">    // æ‰§è¡Œå½’çº¦</span><br><span class="line">    cub::DeviceReduce::Sum(d_temp, temp_bytes, d_data, d_result, n);</span><br><span class="line">    </span><br><span class="line">    cudaFree(d_temp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="cub-ti-gong-de-gui-yue" tabindex="-1" id="CUB-æä¾›çš„å½’çº¦">CUB æä¾›çš„å½’çº¦</h3><table><thead><tr><th>å‡½æ•°</th><th>åŠŸèƒ½</th></tr></thead><tbody><tr><td><code>DeviceReduce::Sum</code></td><td>æ±‚å’Œ</td></tr><tr><td><code>DeviceReduce::Max</code></td><td>æœ€å¤§å€¼</td></tr><tr><td><code>DeviceReduce::Min</code></td><td>æœ€å°å€¼</td></tr><tr><td><code>DeviceReduce::ArgMax</code></td><td>æœ€å¤§å€¼åŠç´¢å¼•</td></tr><tr><td><code>DeviceReduce::ArgMin</code></td><td>æœ€å°å€¼åŠç´¢å¼•</td></tr><tr><td><code>DeviceReduce::Reduce</code></td><td>è‡ªå®šä¹‰æ“ä½œç¬¦</td></tr></tbody></table><h3 id="block-ji-gui-yue" tabindex="-1" id="Block-çº§å½’çº¦">Block çº§å½’çº¦</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;cub/cub.cuh&gt;</span><br><span class="line"></span><br><span class="line">__global__ void myKernel(float *data, float *result) &#123;</span><br><span class="line">    typedef cub::BlockReduce&lt;float, 256&gt; BlockReduce;</span><br><span class="line">    __shared__ typename BlockReduce::TempStorage temp_storage;</span><br><span class="line">    </span><br><span class="line">    float val = data[threadIdx.x];</span><br><span class="line">    float sum = BlockReduce(temp_storage).Sum(val);</span><br><span class="line">    </span><br><span class="line">    if (threadIdx.x == 0) &#123;</span><br><span class="line">        result[blockIdx.x] = sum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="xiao-jie" tabindex="-1" id="å°ç»“">å°ç»“</h2><p>ç¬¬åç« ç³»ç»Ÿè®²è§£äº†å¹¶è¡Œå½’çº¦ï¼š</p><p><strong>æ ‘å½¢å½’çº¦</strong>ï¼šlog N æ­¥å®Œæˆï¼Œä½†æœ´ç´ å®ç°æœ‰ä¸¥é‡çš„åˆ†æ”¯å‘æ•£å’Œ Bank å†²çªã€‚</p><p><strong>äº¤é”™é…å¯¹</strong>ï¼šè®©æ´»è·ƒçº¿ç¨‹è¿ç»­ï¼Œæ¶ˆé™¤ Warp å†…å‘æ•£ã€‚è¿™æ˜¯æœ€å…³é”®çš„ä¼˜åŒ–ã€‚</p><p><strong>é¦–æ¬¡åŠ è½½å½’çº¦</strong>ï¼šGrid-stride loop è®©æ¯çº¿ç¨‹å¤„ç†å¤šä¸ªå…ƒç´ ï¼Œå‡å°‘ Block æ•°å’ŒåŒæ­¥å¼€é”€ã€‚</p><p><strong>å±•å¼€ä¼˜åŒ–</strong>ï¼šåˆ©ç”¨ Warp å†…éšå¼åŒæ­¥ï¼Œæ¶ˆé™¤æœ€åå‡ å±‚çš„ <code>__syncthreads()</code>ã€‚å®Œå…¨å±•å¼€è¿›ä¸€æ­¥æ¶ˆé™¤å¾ªç¯å¼€é”€ã€‚</p><p><strong>Warp Shuffle</strong>ï¼šç°ä»£ GPU çš„åˆ©å™¨ï¼Œç›´æ¥äº¤æ¢å¯„å­˜å™¨ï¼Œæ— éœ€å…±äº«å†…å­˜ã€‚</p><p><strong>åˆ†æ”¯å‘æ•£</strong>ï¼šæŒ‰ Warp è¾¹ç•Œåˆ’åˆ†æ¡ä»¶ï¼Œç”¨ç®—æœ¯æ›¿ä»£åˆ†æ”¯ï¼Œæ˜¯é€šç”¨çš„å‘æ•£æœ€å°åŒ–æŠ€æœ¯ã€‚</p><p><strong>CUB åº“</strong>ï¼šç”Ÿäº§ç¯å¢ƒä¼˜å…ˆä½¿ç”¨åº“ï¼Œå®ƒé›†æˆäº†æ‰€æœ‰ä¼˜åŒ–ä¸”ç»è¿‡å……åˆ†æµ‹è¯•ã€‚</p><p>å½’çº¦æ˜¯å¹¶è¡Œè®¡ç®—çš„åŸºç¡€æ¨¡å¼ï¼Œå·ç§¯çš„è¾¹ç•Œå¤„ç†ã€ç›´æ–¹å›¾çš„æœ€ç»ˆåˆå¹¶ã€ç¥ç»ç½‘ç»œçš„ Softmax éƒ½ç”¨åˆ°ã€‚ä¸‹ä¸€ç« å­¦ä¹ å‰ç¼€å’Œâ€”â€”å¦ä¸€ä¸ªåŸºç¡€ä¸”å¼ºå¤§çš„å¹¶è¡ŒåŸè¯­ã€‚</p><hr><p><strong>å‚è€ƒèµ„æ–™ï¼š</strong></p><ul><li>Hwu, W., Kirk, D., &amp; El Hajj, I. (2022). <em>Programming Massively Parallel Processors: A Hands-on Approach</em> (4th Edition). Morgan Kaufmann.</li><li><a href="https://nvlabs.github.io/cub/">NVIDIA CUB Library</a></li><li>Harris, M. (2007). <em>Optimizing Parallel Reduction in CUDA</em>. NVIDIA Developer Technology.</li></ul><hr><blockquote><p><strong>æœ¬æ–‡ GitHub ä»“åº“</strong>: <a href="https://github.com/psmarter/PMPP-Learning">https://github.com/psmarter/PMPP-Learning</a></p></blockquote>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;qian-yan&quot; tabindex=&quot;-1&quot;</summary>
        
      
    
    
    
    <category term="çŸ¥è¯†åˆ†äº«" scheme="https://smarter.xin/categories/knowledge-sharing/"/>
    
    
    <category term="CUDA" scheme="https://smarter.xin/tags/CUDA/"/>
    
    <category term="GPUç¼–ç¨‹" scheme="https://smarter.xin/tags/gpu-programming/"/>
    
    <category term="å¹¶è¡Œè®¡ç®—" scheme="https://smarter.xin/tags/parallel-computing/"/>
    
    <category term="PMPP" scheme="https://smarter.xin/tags/PMPP/"/>
    
    <category term="å½’çº¦" scheme="https://smarter.xin/tags/reduction/"/>
    
    <category term="åˆ†æ”¯å‘æ•£" scheme="https://smarter.xin/tags/divergence/"/>
    
    <category term="å¹¶è¡Œç®—æ³•" scheme="https://smarter.xin/tags/parallel-algorithm/"/>
    
  </entry>
  
  <entry>
    <title>PMPP-ç¬¬ä¹ç« ï¼šå¹¶è¡Œç›´æ–¹å›¾</title>
    <link href="https://smarter.xin/posts/d29973f1/"/>
    <id>https://smarter.xin/posts/d29973f1/</id>
    <published>2026-01-17T12:54:04.000Z</published>
    <updated>2026-01-24T08:26:21.331Z</updated>
    
    <content type="html"><![CDATA[<h2 id="qian-yan" tabindex="-1" id="å‰è¨€">å‰è¨€</h2><p>å‰å‡ ç« å­¦çš„å·ç§¯ã€æ¨¡æ¿éƒ½æ˜¯&quot;è§„åˆ™&quot;çš„å¹¶è¡Œæ¨¡å¼â€”â€”è¾“å‡ºä½ç½®å›ºå®šï¼Œæ¯ä¸ªçº¿ç¨‹çŸ¥é“è‡ªå·±å†™å“ªé‡Œã€‚ä½†å¾ˆå¤šå®é™…é—®é¢˜ä¸æ˜¯è¿™æ ·çš„ï¼Œæ¯”å¦‚<strong>ç›´æ–¹å›¾</strong>ï¼šæ¯ä¸ªè¾“å…¥å…ƒç´ å†³å®šæ›´æ–°å“ªä¸ªè¾“å‡ºæ¡¶ï¼Œå¤šä¸ªçº¿ç¨‹å¯èƒ½åŒæ—¶æ›´æ–°åŒä¸€ä¸ªæ¡¶ã€‚è¿™å°±æ˜¯<strong>è¾“å‡ºå†²çª</strong>é—®é¢˜ã€‚ç¬¬ä¹ç« è®²è§£å¦‚ä½•ç”¨<strong>åŸå­æ“ä½œ</strong>å’Œ<strong>ç§æœ‰åŒ–</strong>æŠ€æœ¯è§£å†³è¿™ç±»é—®é¢˜ã€‚</p><blockquote><p><strong>ğŸ“¦ é…å¥—èµ„æº</strong>ï¼šæœ¬ç³»åˆ—æ–‡ç« é…æœ‰å®Œæ•´çš„ <a href="https://github.com/psmarter/PMPP-Learning">GitHub ä»“åº“</a>ï¼ŒåŒ…å«æ¯ç« çš„ç»ƒä¹ é¢˜è§£ç­”ã€CUDA ä»£ç å®ç°å’Œè¯¦ç»†æ³¨é‡Šã€‚æ‰€æœ‰ä»£ç éƒ½ç»è¿‡æµ‹è¯•ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œã€‚</p></blockquote><h2 id="zhi-fang-tu-ji-chu" tabindex="-1" id="ç›´æ–¹å›¾åŸºç¡€">ç›´æ–¹å›¾åŸºç¡€</h2><h3 id="shi-yao-shi-zhi-fang-tu" tabindex="-1" id="ä»€ä¹ˆæ˜¯ç›´æ–¹å›¾">ä»€ä¹ˆæ˜¯ç›´æ–¹å›¾</h3><p>ç›´æ–¹å›¾ç»Ÿè®¡æ•°æ®çš„åˆ†å¸ƒã€‚ç»™å®šä¸€ç»„æ•°æ®ï¼Œè®¡ç®—æ¯ä¸ªå€¼ï¼ˆæˆ–åŒºé—´ï¼‰å‡ºç°çš„æ¬¡æ•°ã€‚</p><p><strong>ä¾‹å­</strong>ï¼šç»Ÿè®¡æ–‡æœ¬ä¸­æ¯ä¸ªå­—æ¯çš„å‡ºç°æ¬¡æ•°</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥: &quot;hello world&quot;</span><br><span class="line">è¾“å‡º: h:1, e:1, l:3, o:2, w:1, r:1, d:1, ç©ºæ ¼:1</span><br></pre></td></tr></table></figure><p><strong>å›¾åƒç›´æ–¹å›¾</strong>ï¼šç»Ÿè®¡æ¯ä¸ªç°åº¦å€¼ï¼ˆ0-255ï¼‰çš„åƒç´ æ•°é‡</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥: 256Ã—256 å›¾åƒ</span><br><span class="line">è¾“å‡º: histogram[256]ï¼Œæ¯ä¸ªå…ƒç´ æ˜¯è¯¥ç°åº¦å€¼çš„åƒç´ è®¡æ•°</span><br></pre></td></tr></table></figure><h3 id="chuan-xing-shi-xian" tabindex="-1" id="ä¸²è¡Œå®ç°">ä¸²è¡Œå®ç°</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">histogram_sequential</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *data, <span class="type">int</span> *histogram, <span class="type">int</span> n)</span> &#123;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">256</span>; i++) &#123;</span><br><span class="line">        histogram[i] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç»Ÿè®¡</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        histogram[data[i]]++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ—¶é—´å¤æ‚åº¦ O(n)ï¼Œç©ºé—´å¤æ‚åº¦ O(æ¡¶æ•°)ã€‚</p><h3 id="bing-xing-hua-de-tiao-zhan" tabindex="-1" id="å¹¶è¡ŒåŒ–çš„æŒ‘æˆ˜">å¹¶è¡ŒåŒ–çš„æŒ‘æˆ˜</h3><p>å°è¯•ç›´æ¥å¹¶è¡ŒåŒ–ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__global__ void histogram_naive(unsigned char *data, int *histogram, int n) &#123;</span><br><span class="line">    int i = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">    if (i &lt; n) &#123;</span><br><span class="line">        histogram[data[i]]++;  // å±é™©ï¼è¯»-æ”¹-å†™ç«äº‰</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>é—®é¢˜</strong>ï¼šå¤šä¸ªçº¿ç¨‹å¯èƒ½åŒæ—¶è¯»å–åŒä¸€ä¸ª <code>histogram[k]</code>ï¼Œå„è‡ªåŠ  1ï¼Œç„¶åå†™å›ã€‚ç»“æœåªåŠ äº† 1 æ¬¡è€Œä¸æ˜¯å¤šæ¬¡ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">çº¿ç¨‹ A: è¯» histogram[5] = 10</span><br><span class="line">çº¿ç¨‹ B: è¯» histogram[5] = 10</span><br><span class="line">çº¿ç¨‹ A: å†™ histogram[5] = 11</span><br><span class="line">çº¿ç¨‹ B: å†™ histogram[5] = 11  // åº”è¯¥æ˜¯ 12ï¼</span><br></pre></td></tr></table></figure><p>è¿™å°±æ˜¯<strong>ç«æ€æ¡ä»¶ï¼ˆRace Conditionï¼‰</strong>ã€‚</p><h2 id="yuan-zi-cao-zuo" tabindex="-1" id="åŸå­æ“ä½œ">åŸå­æ“ä½œ</h2><h3 id="shi-yao-shi-yuan-zi-cao-zuo" tabindex="-1" id="ä»€ä¹ˆæ˜¯åŸå­æ“ä½œ">ä»€ä¹ˆæ˜¯åŸå­æ“ä½œ</h3><p><strong>åŸå­æ“ä½œ</strong>ï¼šä¸å¯åˆ†å‰²çš„æ“ä½œã€‚æ•´ä¸ª&quot;è¯»-æ”¹-å†™&quot;è¿‡ç¨‹è¦ä¹ˆå…¨éƒ¨å®Œæˆï¼Œè¦ä¹ˆå®Œå…¨ä¸æ‰§è¡Œï¼Œä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹æ‰“æ–­ã€‚</p><p>CUDA æä¾›çš„åŸå­å‡½æ•°ï¼š</p><table><thead><tr><th>å‡½æ•°</th><th>æ“ä½œ</th><th>è¿”å›å€¼</th></tr></thead><tbody><tr><td><code>atomicAdd</code></td><td><code>*addr += val</code></td><td>æ—§å€¼</td></tr><tr><td><code>atomicSub</code></td><td><code>*addr -= val</code></td><td>æ—§å€¼</td></tr><tr><td><code>atomicMax</code></td><td><code>*addr = max()</code></td><td>æ—§å€¼</td></tr><tr><td><code>atomicMin</code></td><td><code>*addr = min()</code></td><td>æ—§å€¼</td></tr><tr><td><code>atomicExch</code></td><td><code>*addr = val</code></td><td>æ—§å€¼</td></tr><tr><td><code>atomicCAS</code></td><td>compare-and-swap</td><td>æ—§å€¼</td></tr><tr><td><code>atomicAnd/Or/Xor</code></td><td>ä½æ“ä½œ</td><td>æ—§å€¼</td></tr></tbody></table><h3 id="shi-yong-yuan-zi-cao-zuo-de-zhi-fang-tu" tabindex="-1" id="ä½¿ç”¨åŸå­æ“ä½œçš„ç›´æ–¹å›¾">ä½¿ç”¨åŸå­æ“ä½œçš„ç›´æ–¹å›¾</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__global__ void histogram_atomic(unsigned char *data, int *histogram, int n) &#123;</span><br><span class="line">    int i = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">    if (i &lt; n) &#123;</span><br><span class="line">        atomicAdd(&amp;histogram[data[i]], 1);  // åŸå­åŠ </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ­£ç¡®æ€§ä¿è¯</strong>ï¼š<code>atomicAdd</code> ç¡®ä¿æ¯æ¬¡å¢é‡éƒ½è¢«æ­£ç¡®è®¡å…¥ã€‚</p><h3 id="yuan-zi-cao-zuo-de-kai-xiao" tabindex="-1" id="åŸå­æ“ä½œçš„å¼€é”€">åŸå­æ“ä½œçš„å¼€é”€</h3><p>åŸå­æ“ä½œæ¯”æ™®é€šæ“ä½œæ…¢å¾—å¤šï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">æ™®é€šå†™å…¥ï¼š~4 å‘¨æœŸ</span><br><span class="line">åŸå­æ“ä½œï¼š~æ•°ç™¾å‘¨æœŸï¼ˆå–å†³äºäº‰ç”¨ç¨‹åº¦ï¼‰</span><br></pre></td></tr></table></figure><p><strong>åŸå› </strong>ï¼š</p><ol><li><strong>ä¸²è¡ŒåŒ–</strong>ï¼šåŒä¸€åœ°å€çš„åŸå­æ“ä½œå¿…é¡»æ’é˜Ÿæ‰§è¡Œ</li><li><strong>ç¼“å­˜ä¸€è‡´æ€§</strong>ï¼šéœ€è¦åè°ƒå¤šä¸ª SM çš„ç¼“å­˜</li><li><strong>å†…å­˜äº‹åŠ¡</strong>ï¼šéœ€è¦å¾€è¿”å…¨å±€å†…å­˜</li></ol><p><strong>äº‰ç”¨ç¨‹åº¦</strong>å½±å“å¾ˆå¤§ï¼š</p><table><thead><tr><th>åœºæ™¯</th><th>æ¡¶æ•°</th><th>äº‰ç”¨ç¨‹åº¦</th><th>æ€§èƒ½</th></tr></thead><tbody><tr><td>å­—æ¯ç»Ÿè®¡</td><td>26</td><td>æé«˜</td><td>å¾ˆæ…¢</td></tr><tr><td>ç°åº¦ç›´æ–¹å›¾</td><td>256</td><td>é«˜</td><td>è¾ƒæ…¢</td></tr><tr><td>é¢œè‰²ç›´æ–¹å›¾</td><td>16M</td><td>ä½</td><td>æ¥è¿‘å³°å€¼</td></tr></tbody></table><p>æ¡¶è¶Šå¤šï¼Œäº‰ç”¨è¶Šä½ï¼Œæ€§èƒ½è¶Šå¥½ã€‚</p><h2 id="si-you-hua-privatization" tabindex="-1" id="ç§æœ‰åŒ–ï¼ˆPrivatizationï¼‰">ç§æœ‰åŒ–ï¼ˆPrivatizationï¼‰</h2><h3 id="he-xin-si-xiang" tabindex="-1" id="æ ¸å¿ƒæ€æƒ³">æ ¸å¿ƒæ€æƒ³</h3><p><strong>ç§æœ‰åŒ–</strong>ï¼šæ¯ä¸ªçº¿ç¨‹/å—ç»´æŠ¤è‡ªå·±çš„ç§æœ‰ç›´æ–¹å›¾ï¼Œæœ€ååˆå¹¶ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">åŸæœ¬ï¼šæ‰€æœ‰çº¿ç¨‹ â†’ å…¨å±€ç›´æ–¹å›¾ï¼ˆé«˜äº‰ç”¨ï¼‰</span><br><span class="line">ç§æœ‰åŒ–ï¼š</span><br><span class="line">  çº¿ç¨‹/å— â†’ ç§æœ‰ç›´æ–¹å›¾ï¼ˆæ— äº‰ç”¨ï¼‰</span><br><span class="line">  æœ€åï¼šç§æœ‰ç›´æ–¹å›¾ â†’ å…¨å±€ç›´æ–¹å›¾ï¼ˆä¸€æ¬¡æ€§åˆå¹¶ï¼‰</span><br></pre></td></tr></table></figure><h3 id="gong-xiang-nei-cun-si-you-hua" tabindex="-1" id="å…±äº«å†…å­˜ç§æœ‰åŒ–">å…±äº«å†…å­˜ç§æœ‰åŒ–</h3><p>æ¯ä¸ª Block ç”¨å…±äº«å†…å­˜ç»´æŠ¤ç§æœ‰ç›´æ–¹å›¾ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#define NUM_BINS 256</span><br><span class="line"></span><br><span class="line">__global__ void histogram_privatized(unsigned char *data, int *histogram, int n) &#123;</span><br><span class="line">    // ç§æœ‰ç›´æ–¹å›¾ï¼ˆå…±äº«å†…å­˜ï¼‰</span><br><span class="line">    __shared__ int private_hist[NUM_BINS];</span><br><span class="line">    </span><br><span class="line">    // åˆå§‹åŒ–ç§æœ‰ç›´æ–¹å›¾</span><br><span class="line">    if (threadIdx.x &lt; NUM_BINS) &#123;</span><br><span class="line">        private_hist[threadIdx.x] = 0;</span><br><span class="line">    &#125;</span><br><span class="line">    __syncthreads();</span><br><span class="line">    </span><br><span class="line">    // ç»Ÿè®¡åˆ°ç§æœ‰ç›´æ–¹å›¾</span><br><span class="line">    int i = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">    int stride = blockDim.x * gridDim.x;</span><br><span class="line">    </span><br><span class="line">    while (i &lt; n) &#123;</span><br><span class="line">        atomicAdd(&amp;private_hist[data[i]], 1);  // å…±äº«å†…å­˜åŸå­æ“ä½œ</span><br><span class="line">        i += stride;</span><br><span class="line">    &#125;</span><br><span class="line">    __syncthreads();</span><br><span class="line">    </span><br><span class="line">    // åˆå¹¶åˆ°å…¨å±€ç›´æ–¹å›¾</span><br><span class="line">    if (threadIdx.x &lt; NUM_BINS) &#123;</span><br><span class="line">        atomicAdd(&amp;histogram[threadIdx.x], private_hist[threadIdx.x]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="wei-shi-yao-geng-kuai" tabindex="-1" id="ä¸ºä»€ä¹ˆæ›´å¿«">ä¸ºä»€ä¹ˆæ›´å¿«</h3><p><strong>å…±äº«å†…å­˜åŸå­æ“ä½œæ¯”å…¨å±€å†…å­˜å¿«å¾—å¤š</strong>ï¼š</p><table><thead><tr><th>æ“ä½œä½ç½®</th><th>å»¶è¿Ÿ</th><th>å¸¦å®½</th></tr></thead><tbody><tr><td>å…¨å±€å†…å­˜</td><td>~400 å‘¨æœŸ</td><td>~500 GB/s</td></tr><tr><td>å…±äº«å†…å­˜</td><td>~20 å‘¨æœŸ</td><td>~10 TB/s</td></tr></tbody></table><p>åŠ é€Ÿæ¯”çº¦ 20 å€ï¼ˆç†æƒ³æƒ…å†µï¼‰ã€‚</p><p><strong>äº‰ç”¨ä¹Ÿå‡å°‘</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">åŸæœ¬ï¼šæ‰€æœ‰çº¿ç¨‹äº‰ç”¨åŒä¸€ä¸ªå…¨å±€ç›´æ–¹å›¾</span><br><span class="line">ç§æœ‰åŒ–ï¼š</span><br><span class="line">  - Block å†…çº¿ç¨‹äº‰ç”¨ç§æœ‰ç›´æ–¹å›¾ï¼ˆå…±äº«å†…å­˜ï¼Œå¿«ï¼‰</span><br><span class="line">  - Block é—´åˆå¹¶æ—¶äº‰ç”¨å…¨å±€ç›´æ–¹å›¾ï¼ˆä½†åªæœ‰ gridDim æ¬¡ï¼‰</span><br></pre></td></tr></table></figure><h3 id="fen-jie-duan-fen-xi" tabindex="-1" id="åˆ†é˜¶æ®µåˆ†æ">åˆ†é˜¶æ®µåˆ†æ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">é˜¶æ®µ 1ï¼ˆåˆå§‹åŒ–ï¼‰ï¼šNUM_BINS æ¬¡å†™å…¥å…±äº«å†…å­˜</span><br><span class="line">é˜¶æ®µ 2ï¼ˆç§æœ‰ç»Ÿè®¡ï¼‰ï¼šn/gridDim æ¬¡å…±äº«å†…å­˜åŸå­æ“ä½œ</span><br><span class="line">é˜¶æ®µ 3ï¼ˆåˆå¹¶ï¼‰ï¼šNUM_BINS æ¬¡å…¨å±€å†…å­˜åŸå­æ“ä½œ</span><br></pre></td></tr></table></figure><p>å…¨å±€åŸå­æ“ä½œä» n æ¬¡é™åˆ° NUM_BINS Ã— gridDim æ¬¡ï¼Œå¤§å¹…å‡å°‘ã€‚</p><h2 id="xian-cheng-cu-hua" tabindex="-1" id="çº¿ç¨‹ç²—åŒ–">çº¿ç¨‹ç²—åŒ–</h2><h3 id="grid-stride-loop" tabindex="-1" id="Grid-Stride-Loop">Grid-Stride Loop</h3><p>ä¹‹å‰ä»£ç å·²ç»ç”¨äº† grid-stride loopï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">int i = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">int stride = blockDim.x * gridDim.x;</span><br><span class="line"></span><br><span class="line">while (i &lt; n) &#123;</span><br><span class="line">    // å¤„ç†å…ƒç´  i</span><br><span class="line">    i += stride;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ä¼˜åŠ¿</strong>ï¼š</p><ol><li>æ¯ä¸ªçº¿ç¨‹å¤„ç†å¤šä¸ªå…ƒç´ ï¼Œåˆ†æ‘Šå¼€é”€</li><li>Grid å¤§å°å¯ä»¥å›ºå®šï¼Œä¸éšæ•°æ®é‡å˜åŒ–</li><li>æ›´å¥½çš„ç¼“å­˜åˆ©ç”¨</li></ol><h3 id="lian-xu-fang-wen-you-hua" tabindex="-1" id="è¿ç»­è®¿é—®ä¼˜åŒ–">è¿ç»­è®¿é—®ä¼˜åŒ–</h3><p>è®©æ¯ä¸ªçº¿ç¨‹å¤„ç†è¿ç»­çš„ä¸€æ®µæ•°æ®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">__global__ void histogram_coarsened(unsigned char *data, int *histogram, int n) &#123;</span><br><span class="line">    __shared__ int private_hist[NUM_BINS];</span><br><span class="line">    </span><br><span class="line">    // åˆå§‹åŒ–</span><br><span class="line">    for (int i = threadIdx.x; i &lt; NUM_BINS; i += blockDim.x) &#123;</span><br><span class="line">        private_hist[i] = 0;</span><br><span class="line">    &#125;</span><br><span class="line">    __syncthreads();</span><br><span class="line">    </span><br><span class="line">    // æ¯çº¿ç¨‹å¤„ç†è¿ç»­çš„ COARSEN_FACTOR ä¸ªå…ƒç´ </span><br><span class="line">    int base = (blockIdx.x * blockDim.x + threadIdx.x) * COARSEN_FACTOR;</span><br><span class="line">    </span><br><span class="line">    for (int k = 0; k &lt; COARSEN_FACTOR; k++) &#123;</span><br><span class="line">        int idx = base + k;</span><br><span class="line">        if (idx &lt; n) &#123;</span><br><span class="line">            atomicAdd(&amp;private_hist[data[idx]], 1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    __syncthreads();</span><br><span class="line">    </span><br><span class="line">    // åˆå¹¶</span><br><span class="line">    for (int i = threadIdx.x; i &lt; NUM_BINS; i += blockDim.x) &#123;</span><br><span class="line">        atomicAdd(&amp;histogram[i], private_hist[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ä¼˜åŠ¿</strong>ï¼šè¿ç»­è®¿é—®åˆ©äºå†…å­˜åˆå¹¶ã€‚</p><h2 id="ju-he-aggregation" tabindex="-1" id="èšåˆï¼ˆAggregationï¼‰">èšåˆï¼ˆAggregationï¼‰</h2><h3 id="wen-ti" tabindex="-1" id="é—®é¢˜">é—®é¢˜</h3><p>å³ä½¿ç”¨äº†å…±äº«å†…å­˜ç§æœ‰åŒ–ï¼ŒåŒä¸€ Warp å†…çš„çº¿ç¨‹å¯èƒ½é¢‘ç¹äº‰ç”¨åŒä¸€ä¸ªæ¡¶ã€‚</p><p><strong>ä¾‹å­</strong>ï¼šå¤„ç†å…¨é»‘å›¾åƒï¼ˆæ‰€æœ‰åƒç´ å€¼éƒ½æ˜¯ 0ï¼‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">32 ä¸ªçº¿ç¨‹åŒæ—¶ atomicAdd(&amp;private_hist[0], 1)</span><br><span class="line">â†’ 32 æ¬¡ä¸²è¡ŒåŒ–çš„åŸå­æ“ä½œ</span><br></pre></td></tr></table></figure><h3 id="jie-jue-fang-an-warp-ji-ju-he" tabindex="-1" id="è§£å†³æ–¹æ¡ˆï¼šWarp-çº§èšåˆ">è§£å†³æ–¹æ¡ˆï¼šWarp çº§èšåˆ</h3><p>å…ˆåœ¨ Warp å†…ç»Ÿè®¡æ¯ä¸ªå€¼å‡ºç°å¤šå°‘æ¬¡ï¼Œå†åšä¸€æ¬¡åŸå­æ“ä½œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">__global__ void histogram_aggregated(unsigned char *data, int *histogram, int n) &#123;</span><br><span class="line">    __shared__ int private_hist[NUM_BINS];</span><br><span class="line">    </span><br><span class="line">    // åˆå§‹åŒ–</span><br><span class="line">    if (threadIdx.x &lt; NUM_BINS) &#123;</span><br><span class="line">        private_hist[threadIdx.x] = 0;</span><br><span class="line">    &#125;</span><br><span class="line">    __syncthreads();</span><br><span class="line">    </span><br><span class="line">    int i = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">    </span><br><span class="line">    if (i &lt; n) &#123;</span><br><span class="line">        unsigned char value = data[i];</span><br><span class="line">        </span><br><span class="line">        // Warp çº§æŠ•ç¥¨ï¼šæ‰¾å‡ºåŒå€¼çº¿ç¨‹</span><br><span class="line">        unsigned int mask = __match_any_sync(__activemask(), value);</span><br><span class="line">        </span><br><span class="line">        // åªæœ‰ç»„å†…ç¬¬ä¸€ä¸ªçº¿ç¨‹æ‰§è¡ŒåŸå­æ“ä½œ</span><br><span class="line">        if (__ffs(mask) - 1 == (threadIdx.x % 32)) &#123;</span><br><span class="line">            atomicAdd(&amp;private_hist[value], __popc(mask));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    __syncthreads();</span><br><span class="line">    </span><br><span class="line">    // åˆå¹¶åˆ°å…¨å±€</span><br><span class="line">    if (threadIdx.x &lt; NUM_BINS) &#123;</span><br><span class="line">        atomicAdd(&amp;histogram[threadIdx.x], private_hist[threadIdx.x]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="warp-ji-yuan-yu" tabindex="-1" id="Warp-çº§åŸè¯­">Warp çº§åŸè¯­</h3><table><thead><tr><th>å‡½æ•°</th><th>åŠŸèƒ½</th></tr></thead><tbody><tr><td><code>__match_any_sync</code></td><td>è¿”å›å€¼ç›¸åŒçš„çº¿ç¨‹æ©ç </td></tr><tr><td><code>__ffs</code></td><td>æ‰¾ç¬¬ä¸€ä¸ªç½®ä½çš„ä½ï¼ˆfind first setï¼‰</td></tr><tr><td><code>__popc</code></td><td>ç»Ÿè®¡ç½®ä½çš„ä½æ•°ï¼ˆpopulation countï¼‰</td></tr><tr><td><code>__activemask</code></td><td>å½“å‰æ´»è·ƒçº¿ç¨‹æ©ç </td></tr></tbody></table><p><strong><code>__match_any_sync</code> ç¤ºä¾‹</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">çº¿ç¨‹ 0-7 çš„å€¼ï¼š[5, 3, 5, 5, 2, 3, 5, 2]</span><br><span class="line">__match_any_sync è¿”å›ï¼š</span><br><span class="line">  çº¿ç¨‹ 0,2,3,6 è¿”å› 0b01001101ï¼ˆå€¼=5 çš„æ©ç ï¼‰</span><br><span class="line">  çº¿ç¨‹ 1,5 è¿”å› 0b00100010ï¼ˆå€¼=3 çš„æ©ç ï¼‰</span><br><span class="line">  çº¿ç¨‹ 4,7 è¿”å› 0b10010000ï¼ˆå€¼=2 çš„æ©ç ï¼‰</span><br></pre></td></tr></table></figure><p><strong>æ•ˆæœ</strong>ï¼šåŸå­æ“ä½œæ¬¡æ•°ä» 32 æ¬¡é™åˆ° 3 æ¬¡ï¼ˆä¸åŒå€¼çš„æ•°é‡ï¼‰ã€‚</p><h2 id="wan-zheng-you-hua-ban-ben" tabindex="-1" id="å®Œæ•´ä¼˜åŒ–ç‰ˆæœ¬">å®Œæ•´ä¼˜åŒ–ç‰ˆæœ¬</h2><h3 id="zong-he-suo-you-you-hua" tabindex="-1" id="ç»¼åˆæ‰€æœ‰ä¼˜åŒ–">ç»¼åˆæ‰€æœ‰ä¼˜åŒ–</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">#define BLOCK_SIZE 256</span><br><span class="line">#define NUM_BINS 256</span><br><span class="line">#define COARSEN_FACTOR 4</span><br><span class="line"></span><br><span class="line">__global__ void histogram_optimized(unsigned char *data, int *histogram, int n) &#123;</span><br><span class="line">    // å…±äº«å†…å­˜ç§æœ‰ç›´æ–¹å›¾</span><br><span class="line">    __shared__ int private_hist[NUM_BINS];</span><br><span class="line">    </span><br><span class="line">    // åä½œåˆå§‹åŒ–</span><br><span class="line">    for (int i = threadIdx.x; i &lt; NUM_BINS; i += blockDim.x) &#123;</span><br><span class="line">        private_hist[i] = 0;</span><br><span class="line">    &#125;</span><br><span class="line">    __syncthreads();</span><br><span class="line">    </span><br><span class="line">    // Grid-stride loop + ç²—åŒ–</span><br><span class="line">    int tid = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">    int stride = blockDim.x * gridDim.x;</span><br><span class="line">    </span><br><span class="line">    for (int base = tid * COARSEN_FACTOR; base &lt; n; base += stride * COARSEN_FACTOR) &#123;</span><br><span class="line">        // åŠ è½½è¿ç»­çš„ COARSEN_FACTOR ä¸ªå…ƒç´ </span><br><span class="line">        unsigned char values[COARSEN_FACTOR];</span><br><span class="line">        </span><br><span class="line">        #pragma unroll</span><br><span class="line">        for (int k = 0; k &lt; COARSEN_FACTOR; k++) &#123;</span><br><span class="line">            int idx = base + k;</span><br><span class="line">            values[k] = (idx &lt; n) ? data[idx] : 0xFF;  // 0xFF ä½œä¸ºæ— æ•ˆæ ‡è®°</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // é€ä¸ªå¤„ç†ï¼Œä½¿ç”¨ warp èšåˆ</span><br><span class="line">        #pragma unroll</span><br><span class="line">        for (int k = 0; k &lt; COARSEN_FACTOR; k++) &#123;</span><br><span class="line">            if (values[k] != 0xFF) &#123;</span><br><span class="line">                unsigned int mask = __match_any_sync(__activemask(), values[k]);</span><br><span class="line">                if (__ffs(mask) - 1 == (threadIdx.x % 32)) &#123;</span><br><span class="line">                    atomicAdd(&amp;private_hist[values[k]], __popc(mask));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    __syncthreads();</span><br><span class="line">    </span><br><span class="line">    // åˆå¹¶åˆ°å…¨å±€ç›´æ–¹å›¾</span><br><span class="line">    for (int i = threadIdx.x; i &lt; NUM_BINS; i += blockDim.x) &#123;</span><br><span class="line">        if (private_hist[i] &gt; 0) &#123;</span><br><span class="line">            atomicAdd(&amp;histogram[i], private_hist[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="qi-dong-pei-zhi" tabindex="-1" id="å¯åŠ¨é…ç½®">å¯åŠ¨é…ç½®</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">int numBlocks = (n + BLOCK_SIZE * COARSEN_FACTOR - 1) / (BLOCK_SIZE * COARSEN_FACTOR);</span><br><span class="line">numBlocks = min(numBlocks, 256);  // é™åˆ¶ block æ•°é‡</span><br><span class="line"></span><br><span class="line">histogram_optimized&lt;&lt;&lt;numBlocks, BLOCK_SIZE&gt;&gt;&gt;(d_data, d_histogram, n);</span><br></pre></td></tr></table></figure><h3 id="xing-neng-dui-bi" tabindex="-1" id="æ€§èƒ½å¯¹æ¯”">æ€§èƒ½å¯¹æ¯”</h3><p>ä»¥ 1920Ã—1080 å›¾åƒï¼ˆ~200 ä¸‡åƒç´ ï¼‰ä¸ºä¾‹ï¼š</p><table><thead><tr><th>ç‰ˆæœ¬</th><th>ç›¸å¯¹æ€§èƒ½</th><th>ç“¶é¢ˆ</th></tr></thead><tbody><tr><td>æœ´ç´ å…¨å±€åŸå­</td><td>1Ã—</td><td>å…¨å±€å†…å­˜äº‰ç”¨</td></tr><tr><td>ç§æœ‰åŒ–</td><td>10Ã—</td><td>å…±äº«å†…å­˜åŸå­</td></tr><tr><td>+ ç²—åŒ–</td><td>15Ã—</td><td>åŸå­æ“ä½œ</td></tr><tr><td>+ èšåˆ</td><td>25Ã—</td><td>æ¥è¿‘å¸¦å®½ä¸Šé™</td></tr></tbody></table><h2 id="qi-ta-si-you-hua-ce-lue" tabindex="-1" id="å…¶ä»–ç§æœ‰åŒ–ç­–ç•¥">å…¶ä»–ç§æœ‰åŒ–ç­–ç•¥</h2><h3 id="xian-cheng-ji-si-you-hua" tabindex="-1" id="çº¿ç¨‹çº§ç§æœ‰åŒ–">çº¿ç¨‹çº§ç§æœ‰åŒ–</h3><p>å¦‚æœæ¡¶æ•°å¾ˆå°‘ï¼ˆå¦‚ 8 ä¸ªï¼‰ï¼Œå¯ä»¥ç”¨å¯„å­˜å™¨ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">__global__ void histogram_register(unsigned char *data, int *histogram, int n) &#123;</span><br><span class="line">    // æ¯çº¿ç¨‹ç§æœ‰ç›´æ–¹å›¾ï¼ˆå¯„å­˜å™¨ï¼‰</span><br><span class="line">    int local_hist[8] = &#123;0&#125;;</span><br><span class="line">    </span><br><span class="line">    int i = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">    int stride = blockDim.x * gridDim.x;</span><br><span class="line">    </span><br><span class="line">    while (i &lt; n) &#123;</span><br><span class="line">        int bin = data[i] % 8;  // å‡è®¾åªæœ‰ 8 ä¸ªæ¡¶</span><br><span class="line">        local_hist[bin]++;</span><br><span class="line">        i += stride;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // åˆå¹¶åˆ°å…¨å±€</span><br><span class="line">    for (int b = 0; b &lt; 8; b++) &#123;</span><br><span class="line">        atomicAdd(&amp;histogram[b], local_hist[b]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ä¼˜åŠ¿</strong>ï¼šå¯„å­˜å™¨æœ€å¿«ï¼Œæ— äº‰ç”¨ã€‚</p><p><strong>é™åˆ¶</strong>ï¼šæ¡¶æ•°å¿…é¡»å¾ˆå°‘ï¼ˆå¯„å­˜å™¨æ•°é‡æœ‰é™ï¼‰ã€‚</p><h3 id="duo-ji-si-you-hua" tabindex="-1" id="å¤šçº§ç§æœ‰åŒ–">å¤šçº§ç§æœ‰åŒ–</h3><p>å¯¹äºå¤§æ¡¶æ•°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å¯„å­˜å™¨ï¼ˆæå°‘æ¡¶ï¼‰â†’ å…±äº«å†…å­˜ï¼ˆä¸­ç­‰æ¡¶ï¼‰â†’ å…¨å±€å†…å­˜ï¼ˆå¤§æ¡¶æ•°ï¼‰</span><br></pre></td></tr></table></figure><p>æ¯çº§å®¹é‡é€’å¢ï¼Œé€Ÿåº¦é€’å‡ã€‚</p><h2 id="yuan-zi-cao-zuo-de-ying-jian-zhi-chi" tabindex="-1" id="åŸå­æ“ä½œçš„ç¡¬ä»¶æ”¯æŒ">åŸå­æ“ä½œçš„ç¡¬ä»¶æ”¯æŒ</h2><h3 id="zhi-chi-de-shu-ju-lei-xing" tabindex="-1" id="æ”¯æŒçš„æ•°æ®ç±»å‹">æ”¯æŒçš„æ•°æ®ç±»å‹</h3><table><thead><tr><th>ç±»å‹</th><th>åŸå­æ“ä½œæ”¯æŒ</th><th>å¤‡æ³¨</th></tr></thead><tbody><tr><td>int</td><td>å…¨éƒ¨</td><td>æœ€å¸¸ç”¨</td></tr><tr><td>unsigned</td><td>å…¨éƒ¨</td><td></td></tr><tr><td>float</td><td>atomicAdd</td><td>Kepler+ (CC 3.0)</td></tr><tr><td>double</td><td>atomicAdd</td><td>Pascal+ (CC 6.0)</td></tr><tr><td>half</td><td>atomicAdd</td><td>Volta+ (CC 7.0)</td></tr></tbody></table><h3 id="gong-xiang-nei-cun-vs-quan-ju-nei-cun-yuan-zi" tabindex="-1" id="å…±äº«å†…å­˜-vs-å…¨å±€å†…å­˜åŸå­">å…±äº«å†…å­˜ vs å…¨å±€å†…å­˜åŸå­</h3><table><thead><tr><th>ç‰¹æ€§</th><th>å…±äº«å†…å­˜åŸå­</th><th>å…¨å±€å†…å­˜åŸå­</th></tr></thead><tbody><tr><td>å»¶è¿Ÿ</td><td>~20 å‘¨æœŸ</td><td>~400 å‘¨æœŸ</td></tr><tr><td>å¸¦å®½</td><td>é«˜</td><td>ä½</td></tr><tr><td>äº‰ç”¨èŒƒå›´</td><td>Block å†…</td><td>å…¨è®¾å¤‡</td></tr><tr><td>é€‚ç”¨åœºæ™¯</td><td>ä¸­é—´ç»“æœ</td><td>æœ€ç»ˆç»“æœ</td></tr></tbody></table><h3 id="yuan-zi-cao-zuo-shi-xian-yuan-li" tabindex="-1" id="åŸå­æ“ä½œå®ç°åŸç†">åŸå­æ“ä½œå®ç°åŸç†</h3><p><strong>Compare-And-Swap (CAS)</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// atomicAdd çš„æœ¬è´¨å®ç°</span><br><span class="line">__device__ int atomicAdd_manual(int *addr, int val) &#123;</span><br><span class="line">    int old = *addr, assumed;</span><br><span class="line">    do &#123;</span><br><span class="line">        assumed = old;</span><br><span class="line">        old = atomicCAS(addr, assumed, assumed + val);</span><br><span class="line">    &#125; while (old != assumed);</span><br><span class="line">    return old;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¾ªç¯ç›´åˆ°æˆåŠŸâ€”â€”é«˜äº‰ç”¨æ—¶å¯èƒ½å¾ªç¯å¾ˆå¤šæ¬¡ã€‚</p><h2 id="ying-yong-kuo-zhan" tabindex="-1" id="åº”ç”¨æ‰©å±•">åº”ç”¨æ‰©å±•</h2><h3 id="duo-tong-dao-zhi-fang-tu" tabindex="-1" id="å¤šé€šé“ç›´æ–¹å›¾">å¤šé€šé“ç›´æ–¹å›¾</h3><p>RGB å›¾åƒçš„ä¸‰é€šé“ç›´æ–¹å›¾ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">__global__ void histogram_rgb(unsigned char *image, int *hist_r, int *hist_g, int *hist_b, int n) &#123;</span><br><span class="line">    __shared__ int priv_r[256], priv_g[256], priv_b[256];</span><br><span class="line">    </span><br><span class="line">    // åˆå§‹åŒ–</span><br><span class="line">    // ...</span><br><span class="line">    </span><br><span class="line">    int i = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">    if (i &lt; n) &#123;</span><br><span class="line">        atomicAdd(&amp;priv_r[image[3*i + 0]], 1);</span><br><span class="line">        atomicAdd(&amp;priv_g[image[3*i + 1]], 1);</span><br><span class="line">        atomicAdd(&amp;priv_b[image[3*i + 2]], 1);</span><br><span class="line">    &#125;</span><br><span class="line">    __syncthreads();</span><br><span class="line">    </span><br><span class="line">    // åˆå¹¶</span><br><span class="line">    // ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="jia-quan-zhi-fang-tu" tabindex="-1" id="åŠ æƒç›´æ–¹å›¾">åŠ æƒç›´æ–¹å›¾</h3><p>æ¯ä¸ªæ•°æ®ç‚¹æœ‰æƒé‡ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">atomicAdd(&amp;histogram[data[i]], weight[i]);</span><br></pre></td></tr></table></figure><p>ç”¨äºç›´æ–¹å›¾å‡è¡¡åŒ–ç­‰åœºæ™¯ã€‚</p><h3 id="er-wei-zhi-fang-tu" tabindex="-1" id="äºŒç»´ç›´æ–¹å›¾">äºŒç»´ç›´æ–¹å›¾</h3><p>ç»Ÿè®¡ä¸¤ä¸ªå˜é‡çš„è”åˆåˆ†å¸ƒï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">int bin_x = data_x[i] / bin_width_x;</span><br><span class="line">int bin_y = data_y[i] / bin_width_y;</span><br><span class="line">int bin = bin_y * num_bins_x + bin_x;</span><br><span class="line">atomicAdd(&amp;histogram_2d[bin], 1);</span><br></pre></td></tr></table></figure><h2 id="xing-neng-diao-you-jian-yi" tabindex="-1" id="æ€§èƒ½è°ƒä¼˜å»ºè®®">æ€§èƒ½è°ƒä¼˜å»ºè®®</h2><h3 id="xuan-ze-ce-lue" tabindex="-1" id="é€‰æ‹©ç­–ç•¥">é€‰æ‹©ç­–ç•¥</h3><table><thead><tr><th>æ¡¶æ•°</th><th>æ¨èç­–ç•¥</th></tr></thead><tbody><tr><td>&lt; 16</td><td>å¯„å­˜å™¨ç§æœ‰åŒ–</td></tr><tr><td>16 - 1024</td><td>å…±äº«å†…å­˜ç§æœ‰åŒ– + èšåˆ</td></tr><tr><td>&gt; 1024</td><td>ç›´æ¥å…¨å±€åŸå­ï¼ˆäº‰ç”¨ä½ï¼‰</td></tr></tbody></table><h3 id="guan-jian-can-shu" tabindex="-1" id="å…³é”®å‚æ•°">å…³é”®å‚æ•°</h3><p><strong>Block å¤§å°</strong>ï¼š256 æˆ– 512ï¼Œä¿è¯è¶³å¤Ÿçš„å¹¶è¡Œåº¦ã€‚</p><p><strong>ç²—åŒ–å› å­</strong>ï¼š4-16ï¼Œå¹³è¡¡å¯„å­˜å™¨å‹åŠ›å’Œè®¡ç®—ç²’åº¦ã€‚</p><p><strong>Grid å¤§å°</strong>ï¼šä¸è¦å¤ªå¤§ï¼Œå¦åˆ™åˆå¹¶é˜¶æ®µå¼€é”€å¢åŠ ã€‚</p><h3 id="nsight-zhi-biao" tabindex="-1" id="Nsight-æŒ‡æ ‡">Nsight æŒ‡æ ‡</h3><table><thead><tr><th>æŒ‡æ ‡</th><th>å«ä¹‰</th><th>ç›®æ ‡</th></tr></thead><tbody><tr><td>Atomic Operations</td><td>åŸå­æ“ä½œæ•°</td><td>è¶Šå°‘è¶Šå¥½</td></tr><tr><td>Shared Memory Bandwidth</td><td>å…±äº«å†…å­˜å¸¦å®½</td><td>æ¥è¿‘å³°å€¼</td></tr><tr><td>Warp Efficiency</td><td>Warp åˆ©ç”¨ç‡</td><td>&gt; 90%</td></tr></tbody></table><h2 id="xiao-jie" tabindex="-1" id="å°ç»“">å°ç»“</h2><p>ç¬¬ä¹ç« è§£å†³äº†&quot;è¾“å‡ºå†²çª&quot;é—®é¢˜ï¼š</p><p><strong>åŸå­æ“ä½œ</strong>ï¼šä¿è¯&quot;è¯»-æ”¹-å†™&quot;çš„åŸå­æ€§ï¼Œè§£å†³ç«æ€æ¡ä»¶ã€‚ä½†å…¨å±€å†…å­˜åŸå­æ“ä½œå¾ˆæ…¢ï¼Œå°¤å…¶åœ¨é«˜äº‰ç”¨æ—¶ã€‚</p><p><strong>ç§æœ‰åŒ–</strong>ï¼šæ¯ä¸ª Block ç”¨å…±äº«å†…å­˜ç»´æŠ¤ç§æœ‰å‰¯æœ¬ï¼Œæœ€ååˆå¹¶ã€‚å…±äº«å†…å­˜åŸå­æ¯”å…¨å±€å¿« 20 å€ï¼Œäº‰ç”¨ä¹Ÿè¢«é™åˆ¶åœ¨ Block å†…ã€‚</p><p><strong>çº¿ç¨‹ç²—åŒ–</strong>ï¼šæ¯çº¿ç¨‹å¤„ç†å¤šä¸ªå…ƒç´ ï¼Œåˆ†æ‘Šåˆå§‹åŒ–å’Œåˆå¹¶å¼€é”€ã€‚Grid-stride loop æ˜¯é€šç”¨æ¨¡å¼ã€‚</p><p><strong>Warp èšåˆ</strong>ï¼šç”¨ <code>__match_any_sync</code> æ‰¾åŒå€¼çº¿ç¨‹ï¼Œåªåšä¸€æ¬¡åŸå­æ“ä½œã€‚åœ¨æ•°æ®é‡å¤ç‡é«˜æ—¶æ•ˆæœæ˜¾è‘—ã€‚</p><p><strong>ç­–ç•¥é€‰æ‹©</strong>ï¼šæ¡¶æ•°å†³å®šç­–ç•¥â€”â€”å°‘æ¡¶ç”¨å¯„å­˜å™¨ï¼Œä¸­æ¡¶ç”¨å…±äº«å†…å­˜ï¼Œå¤šæ¡¶ç›´æ¥å…¨å±€åŸå­ã€‚</p><p>ç›´æ–¹å›¾æ˜¯&quot;å½’çº¦åˆ°å¤šä¸ªç›®æ ‡&quot;çš„å…¸å‹ä»£è¡¨ã€‚åŸå­æ“ä½œå’Œç§æœ‰åŒ–æŠ€æœ¯ä¹Ÿé€‚ç”¨äºå…¶ä»–ç±»ä¼¼é—®é¢˜ï¼šæ•£å°„ï¼ˆscatterï¼‰ã€åˆ†ç»„èšåˆã€å“ˆå¸Œè¡¨æ„å»ºç­‰ã€‚ä¸‹ä¸€ç« å°†å­¦ä¹ å¦ä¸€ä¸ªé‡è¦æ¨¡å¼â€”â€”å½’çº¦ã€‚</p><hr><p><strong>å‚è€ƒèµ„æ–™ï¼š</strong></p><ul><li>Hwu, W., Kirk, D., &amp; El Hajj, I. (2022). <em>Programming Massively Parallel Processors: A Hands-on Approach</em> (4th Edition). Morgan Kaufmann.</li><li><a href="https://docs.nvidia.com/cuda/cuda-c-programming-guide/index.html#atomic-functions">CUDA C++ Programming Guide - Atomic Functions</a></li><li><a href="https://developer.nvidia.com/blog/faster-parallel-reductions-kepler/">NVIDIA Developer Blog - Faster Parallel Reductions</a></li></ul><hr><blockquote><p><strong>æœ¬æ–‡ GitHub ä»“åº“</strong>: <a href="https://github.com/psmarter/PMPP-Learning">https://github.com/psmarter/PMPP-Learning</a></p></blockquote>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;qian-yan&quot; tabindex=&quot;-1&quot;</summary>
        
      
    
    
    
    <category term="çŸ¥è¯†åˆ†äº«" scheme="https://smarter.xin/categories/knowledge-sharing/"/>
    
    
    <category term="CUDA" scheme="https://smarter.xin/tags/CUDA/"/>
    
    <category term="GPUç¼–ç¨‹" scheme="https://smarter.xin/tags/gpu-programming/"/>
    
    <category term="å¹¶è¡Œè®¡ç®—" scheme="https://smarter.xin/tags/parallel-computing/"/>
    
    <category term="PMPP" scheme="https://smarter.xin/tags/PMPP/"/>
    
    <category term="ç›´æ–¹å›¾" scheme="https://smarter.xin/tags/histogram/"/>
    
    <category term="åŸå­æ“ä½œ" scheme="https://smarter.xin/tags/atomic-operations/"/>
    
    <category term="ç§æœ‰åŒ–" scheme="https://smarter.xin/tags/privatization/"/>
    
  </entry>
  
  <entry>
    <title>PMPP-ç¬¬å…«ç« ï¼šæ¨¡æ¿</title>
    <link href="https://smarter.xin/posts/93c68d7a/"/>
    <id>https://smarter.xin/posts/93c68d7a/</id>
    <published>2026-01-17T09:15:06.000Z</published>
    <updated>2026-01-24T08:26:21.332Z</updated>
    
    <content type="html"><![CDATA[<h2 id="qian-yan" tabindex="-1" id="å‰è¨€">å‰è¨€</h2><p>ç¬¬ä¸ƒç« å­¦äº†å·ç§¯ï¼Œè¿™ç« å­¦æ¨¡æ¿ï¼ˆStencilï¼‰ã€‚ä½ å¯èƒ½ä¼šé—®ï¼šè¿™ä¿©ä¸æ˜¯å·®ä¸å¤šå—ï¼Ÿç¡®å®å¾ˆåƒï¼Œä½†æœ‰å¾®å¦™åŒºåˆ«ã€‚<strong>å·ç§¯</strong>å¼ºè°ƒçš„æ˜¯ä¿¡å·å¤„ç†ä¸­çš„æ»‘åŠ¨åŠ æƒå’Œï¼Œæƒé‡æ¥è‡ªæ»¤æ³¢å™¨ï¼›<strong>æ¨¡æ¿</strong>å¼ºè°ƒçš„æ˜¯ç§‘å­¦è®¡ç®—ä¸­çš„é‚»åŸŸæ›´æ–°ï¼Œæ¯”å¦‚ PDE æ±‚è§£ã€ç‰©ç†ä»¿çœŸã€‚ä» CUDA ä¼˜åŒ–è§’åº¦çœ‹ï¼ŒæŠ€æœ¯æ˜¯ç›¸é€šçš„ï¼Œä½†æ¨¡æ¿è®¡ç®—æœ‰è‡ªå·±çš„ç‰¹ç‚¹ï¼šé€šå¸¸æ˜¯<strong>å¤šæ¬¡è¿­ä»£</strong>çš„ï¼Œéœ€è¦å¤„ç†<strong>æ—¶é—´æ­¥è¿›</strong>å’Œ<strong>æ•°æ®äº¤æ¢</strong>ã€‚</p><blockquote><p><strong>ğŸ“¦ é…å¥—èµ„æº</strong>ï¼šæœ¬ç³»åˆ—æ–‡ç« é…æœ‰å®Œæ•´çš„ <a href="https://github.com/psmarter/PMPP-Learning">GitHub ä»“åº“</a>ï¼ŒåŒ…å«æ¯ç« çš„ç»ƒä¹ é¢˜è§£ç­”ã€CUDA ä»£ç å®ç°å’Œè¯¦ç»†æ³¨é‡Šã€‚æ‰€æœ‰ä»£ç éƒ½ç»è¿‡æµ‹è¯•ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œã€‚</p></blockquote><h2 id="mo-ban-ji-suan-ji-chu" tabindex="-1" id="æ¨¡æ¿è®¡ç®—åŸºç¡€">æ¨¡æ¿è®¡ç®—åŸºç¡€</h2><h3 id="shi-yao-shi-mo-ban-ji-suan" tabindex="-1" id="ä»€ä¹ˆæ˜¯æ¨¡æ¿è®¡ç®—">ä»€ä¹ˆæ˜¯æ¨¡æ¿è®¡ç®—</h3><p>æ¨¡æ¿è®¡ç®—ï¼ˆStencil Computationï¼‰ï¼šç”¨<strong>å›ºå®šçš„é‚»åŸŸæ¨¡å¼</strong>æ›´æ–°ç½‘æ ¼ä¸­çš„æ¯ä¸ªç‚¹ã€‚</p><p><strong>ä¸€ç»´çƒ­ä¼ å¯¼</strong>ï¼ˆæœ€ç®€å•çš„ä¾‹å­ï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">æ—¶é—´ t:    [..., A, B, C, ...]</span><br><span class="line">æ—¶é—´ t+1:       B&#x27; = (A + B + C) / 3</span><br></pre></td></tr></table></figure><p>æ¯ä¸ªç‚¹çš„æ–°å€¼æ˜¯è‡ªå·±å’Œé‚»å±…çš„åŠ æƒå¹³å‡ã€‚è¿™å°±æ˜¯æ¨¡æ¿ï¼šä¸€ä¸ªæè¿°&quot;å¦‚ä½•ä»é‚»å±…è®¡ç®—è‡ªå·±&quot;çš„æ¨¡å¼ã€‚</p><h3 id="mo-ban-de-xing-zhuang" tabindex="-1" id="æ¨¡æ¿çš„å½¢çŠ¶">æ¨¡æ¿çš„å½¢çŠ¶</h3><p>å¸¸è§çš„æ¨¡æ¿å½¢çŠ¶ï¼š</p><p><strong>1D ä¸‰ç‚¹æ¨¡æ¿</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[ -1  0  +1 ]</span><br><span class="line">   â†“  â†“  â†“</span><br><span class="line">   A  B  C</span><br></pre></td></tr></table></figure><p><strong>2D äº”ç‚¹æ¨¡æ¿ï¼ˆå†¯Â·è¯ºä¾æ›¼é‚»åŸŸï¼‰</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">       [0,-1]</span><br><span class="line">         â†‘</span><br><span class="line">[-1,0] â† [0,0] â†’ [+1,0]</span><br><span class="line">         â†“</span><br><span class="line">       [0,+1]</span><br></pre></td></tr></table></figure><p><strong>2D ä¹ç‚¹æ¨¡æ¿ï¼ˆæ‘©å°”é‚»åŸŸï¼‰</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[-1,-1] [0,-1] [+1,-1]</span><br><span class="line">[-1, 0] [0, 0] [+1, 0]</span><br><span class="line">[-1,+1] [0,+1] [+1,+1]</span><br></pre></td></tr></table></figure><p><strong>3D ä¸ƒç‚¹æ¨¡æ¿</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ä¸Šä¸‹å‰åå·¦å³ + è‡ªå·±</span><br></pre></td></tr></table></figure><h3 id="mo-ban-vs-juan-ji" tabindex="-1" id="æ¨¡æ¿-vs-å·ç§¯">æ¨¡æ¿ vs å·ç§¯</h3><table><thead><tr><th>ç‰¹æ€§</th><th>å·ç§¯</th><th>æ¨¡æ¿</th></tr></thead><tbody><tr><td>æƒé‡</td><td>æ¥è‡ªæ»¤æ³¢å™¨ï¼Œä»»æ„å€¼</td><td>é€šå¸¸æ˜¯å›ºå®šç³»æ•°</td></tr><tr><td>è¿­ä»£</td><td>é€šå¸¸å•æ¬¡</td><td>å¤šæ¬¡æ—¶é—´æ­¥è¿›</td></tr><tr><td>è¾¹ç•Œ</td><td>é›¶å¡«å……å¸¸è§</td><td>å‘¨æœŸ/å›ºå®šè¾¹ç•Œæ›´å¸¸è§</td></tr><tr><td>åº”ç”¨</td><td>ä¿¡å·/å›¾åƒå¤„ç†</td><td>PDE/ç‰©ç†ä»¿çœŸ</td></tr><tr><td>è¯»å†™æ¨¡å¼</td><td>åªè¯»è¾“å…¥ï¼Œå†™è¾“å‡º</td><td>è¯»æ—§å€¼ï¼Œå†™æ–°å€¼</td></tr></tbody></table><p>ä» GPU ä¼˜åŒ–è§’åº¦ï¼Œä¸¤è€…çš„æ ¸å¿ƒæŠ€æœ¯æ˜¯ç›¸åŒçš„ï¼š<strong>å¸¸é‡å†…å­˜</strong>å­˜ç³»æ•°ï¼Œ<strong>å…±äº«å†…å­˜</strong> Tiling å‡å°‘å…¨å±€å†…å­˜è®¿é—®ã€‚</p><h2 id="2-d-mo-ban-re-chuan-dao-fang-cheng" tabindex="-1" id="2D-æ¨¡æ¿ï¼šçƒ­ä¼ å¯¼æ–¹ç¨‹">2D æ¨¡æ¿ï¼šçƒ­ä¼ å¯¼æ–¹ç¨‹</h2><h3 id="wu-li-bei-jing" tabindex="-1" id="ç‰©ç†èƒŒæ™¯">ç‰©ç†èƒŒæ™¯</h3><p>äºŒç»´çƒ­ä¼ å¯¼æ–¹ç¨‹ï¼š</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mfrac><mrow><mi mathvariant="normal">âˆ‚</mi><mi>T</mi></mrow><mrow><mi mathvariant="normal">âˆ‚</mi><mi>t</mi></mrow></mfrac><mo>=</mo><mi>Î±</mi><mrow><mo fence="true">(</mo><mfrac><mrow><msup><mi mathvariant="normal">âˆ‚</mi><mn>2</mn></msup><mi>T</mi></mrow><mrow><mi mathvariant="normal">âˆ‚</mi><msup><mi>x</mi><mn>2</mn></msup></mrow></mfrac><mo>+</mo><mfrac><mrow><msup><mi mathvariant="normal">âˆ‚</mi><mn>2</mn></msup><mi>T</mi></mrow><mrow><mi mathvariant="normal">âˆ‚</mi><msup><mi>y</mi><mn>2</mn></msup></mrow></mfrac><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">\frac{\partial T}{\partial t} = \alpha \left( \frac{\partial^2 T}{\partial x^2} + \frac{\partial^2 T}{\partial y^2} \right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.0574em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">âˆ‚</span><span class="mord mathnormal">t</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">âˆ‚</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4411em;vertical-align:-0.95em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.4911em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">âˆ‚</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord" style="margin-right:0.05556em;">âˆ‚</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.4911em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">âˆ‚</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord" style="margin-right:0.05556em;">âˆ‚</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.8804em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span></span></span></span></span></p><p>ç”¨æœ‰é™å·®åˆ†ç¦»æ•£åŒ–åï¼š</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msubsup><mi>T</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow><mrow><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msubsup><mo>=</mo><msubsup><mi>T</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow><mi>n</mi></msubsup><mo>+</mo><mi>Î±</mi><mi mathvariant="normal">Î”</mi><mi>t</mi><mrow><mo fence="true">(</mo><mfrac><mrow><msubsup><mi>T</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn><mo separator="true">,</mo><mi>j</mi></mrow><mi>n</mi></msubsup><mo>+</mo><msubsup><mi>T</mi><mrow><mi>i</mi><mo>âˆ’</mo><mn>1</mn><mo separator="true">,</mo><mi>j</mi></mrow><mi>n</mi></msubsup><mo>+</mo><msubsup><mi>T</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo>+</mo><mn>1</mn></mrow><mi>n</mi></msubsup><mo>+</mo><msubsup><mi>T</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo>âˆ’</mo><mn>1</mn></mrow><mi>n</mi></msubsup><mo>âˆ’</mo><mn>4</mn><msubsup><mi>T</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow><mi>n</mi></msubsup></mrow><mrow><mi mathvariant="normal">Î”</mi><msup><mi>x</mi><mn>2</mn></msup></mrow></mfrac><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">T_{i,j}^{n+1} = T_{i,j}^n + \alpha \Delta t \left( \frac{T_{i+1,j}^n + T_{i-1,j}^n + T_{i,j+1}^n + T_{i,j-1}^n - 4T_{i,j}^n}{\Delta x^2} \right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2672em;vertical-align:-0.4031em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-2.433em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.4031em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0975em;vertical-align:-0.3831em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7144em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3831em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:2.4181em;vertical-align:-0.95em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="mord">Î”</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.4681em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">Î”</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.7848em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-2.4413em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3948em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-2.4413em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3948em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-2.4413em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3948em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-2.4413em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3948em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">4</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-2.4413em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3948em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span></span></span></span></span></p><p>ç®€åŒ–ä¸ºäº”ç‚¹æ¨¡æ¿ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">T_new[i][j] = c0 * T[i][j] + c1 * (T[i-1][j] + T[i+1][j] + T[i][j-1] + T[i][j+1])</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>c0 = 1 - 4*alpha*dt/dxÂ²</code>ï¼Œ<code>c1 = alpha*dt/dxÂ²</code>ã€‚</p><h3 id="po-su-shi-xian" tabindex="-1" id="æœ´ç´ å®ç°">æœ´ç´ å®ç°</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">__global__ void stencil_2d_basic(float *in, float *out, int N) &#123;</span><br><span class="line">    int i = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">    int j = blockIdx.y * blockDim.y + threadIdx.y;</span><br><span class="line">    </span><br><span class="line">    if (i &gt; 0 &amp;&amp; i &lt; N-1 &amp;&amp; j &gt; 0 &amp;&amp; j &lt; N-1) &#123;</span><br><span class="line">        out[i*N + j] = C0 * in[i*N + j] +</span><br><span class="line">                       C1 * (in[(i-1)*N + j] + in[(i+1)*N + j] +</span><br><span class="line">                             in[i*N + (j-1)] + in[i*N + (j+1)]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>é—®é¢˜</strong>ï¼šæ¯ä¸ªç‚¹è¯»å– 5 æ¬¡å…¨å±€å†…å­˜ï¼Œç›¸é‚»ç‚¹çš„è®¿é—®æœ‰å¤§é‡é‡å ã€‚</p><h3 id="shu-ju-fu-yong-fen-xi" tabindex="-1" id="æ•°æ®å¤ç”¨åˆ†æ">æ•°æ®å¤ç”¨åˆ†æ</h3><p>è€ƒè™‘ä¸€è¡Œçº¿ç¨‹è®¡ç®—ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">çº¿ç¨‹ j:   è¯»å– T[i][j-1], T[i][j], T[i][j+1], T[i-1][j], T[i+1][j]</span><br><span class="line">çº¿ç¨‹ j+1: è¯»å– T[i][j], T[i][j+1], T[i][j+2], T[i-1][j+1], T[i+1][j+1]</span><br><span class="line">                â†‘           â†‘ å…±äº«</span><br></pre></td></tr></table></figure><p>ç›¸é‚»çº¿ç¨‹å…±äº«äº† <code>T[i][j]</code> å’Œ <code>T[i][j+1]</code>ã€‚å¦‚æœæŠŠä¸€ä¸ª Tile çš„æ•°æ®åŠ è½½åˆ°å…±äº«å†…å­˜ï¼Œè¿™äº›å…±äº«è®¿é—®éƒ½å˜æˆå¿«é€Ÿçš„ç‰‡ä¸Šè®¿é—®ã€‚</p><h2 id="tiled-mo-ban-shi-xian" tabindex="-1" id="Tiled-æ¨¡æ¿å®ç°">Tiled æ¨¡æ¿å®ç°</h2><h3 id="shu-ru-shu-chu-tile-guan-xi" tabindex="-1" id="è¾“å…¥è¾“å‡º-Tile-å…³ç³»">è¾“å…¥è¾“å‡º Tile å…³ç³»</h3><p>ä¸å·ç§¯ç±»ä¼¼ï¼Œè®¡ç®— <code>OUT_TILE_SIZE Ã— OUT_TILE_SIZE</code> çš„è¾“å‡ºï¼Œéœ€è¦ <code>(OUT_TILE_SIZE + 2*r) Ã— (OUT_TILE_SIZE + 2*r)</code> çš„è¾“å…¥ã€‚</p><p>å¯¹äºäº”ç‚¹æ¨¡æ¿ï¼ˆr=1ï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ Tileï¼š(T + 2) Ã— (T + 2)</span><br><span class="line">è¾“å‡º Tileï¼šT Ã— T</span><br></pre></td></tr></table></figure><h3 id="xian-cheng-yu-shu-ju-ying-she" tabindex="-1" id="çº¿ç¨‹ä¸æ•°æ®æ˜ å°„">çº¿ç¨‹ä¸æ•°æ®æ˜ å°„</h3><p>æœ‰ä¸¤ç§ç­–ç•¥ï¼š</p><p><strong>ç­–ç•¥ 1ï¼šçº¿ç¨‹æ•° = è¾“å…¥ Tile å¤§å°</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Block: (T+2) Ã— (T+2) çº¿ç¨‹</span><br><span class="line">æ¯çº¿ç¨‹åŠ è½½ 1 ä¸ªè¾“å…¥å…ƒç´ </span><br><span class="line">åªæœ‰å†…éƒ¨ T Ã— T çº¿ç¨‹è®¡ç®—è¾“å‡º</span><br></pre></td></tr></table></figure><p><strong>ç­–ç•¥ 2ï¼šçº¿ç¨‹æ•° = è¾“å‡º Tile å¤§å°</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Block: T Ã— T çº¿ç¨‹</span><br><span class="line">éƒ¨åˆ†çº¿ç¨‹è´Ÿè´£åŠ è½½ Halo å…ƒç´ </span><br><span class="line">æ‰€æœ‰çº¿ç¨‹éƒ½è®¡ç®—è¾“å‡º</span><br></pre></td></tr></table></figure><p>ä¹¦ä¸­æ¨è<strong>ç­–ç•¥ 1</strong>ï¼Œå› ä¸ºåŠ è½½æ›´ç®€å•ï¼Œä¸”è¾¹ç•Œçº¿ç¨‹è™½ä¸è®¡ç®—ä½†ä»èƒ½å¹¶è¡Œæ‰§è¡Œã€‚</p><h3 id="wan-zheng-shi-xian" tabindex="-1" id="å®Œæ•´å®ç°">å®Œæ•´å®ç°</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">#define IN_TILE_SIZE 18  // 16 + 2</span><br><span class="line">#define OUT_TILE_SIZE 16</span><br><span class="line"></span><br><span class="line">__global__ void stencil_2d_tiled(float *in, float *out, int N) &#123;</span><br><span class="line">    __shared__ float tile[IN_TILE_SIZE][IN_TILE_SIZE];</span><br><span class="line">    </span><br><span class="line">    // çº¿ç¨‹åœ¨è¾“å…¥ Tile ä¸­çš„ä½ç½®</span><br><span class="line">    int tx = threadIdx.x, ty = threadIdx.y;</span><br><span class="line">    </span><br><span class="line">    // å¯¹åº”çš„å…¨å±€è¾“å…¥ä½ç½®</span><br><span class="line">    int in_row = blockIdx.y * OUT_TILE_SIZE + ty - 1;  // -1 æ˜¯å› ä¸º Halo</span><br><span class="line">    int in_col = blockIdx.x * OUT_TILE_SIZE + tx - 1;</span><br><span class="line">    </span><br><span class="line">    // åŠ è½½ï¼ˆå«è¾¹ç•Œæ£€æŸ¥ï¼‰</span><br><span class="line">    if (in_row &gt;= 0 &amp;&amp; in_row &lt; N &amp;&amp; in_col &gt;= 0 &amp;&amp; in_col &lt; N) &#123;</span><br><span class="line">        tile[ty][tx] = in[in_row * N + in_col];</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        tile[ty][tx] = 0.0f;  // è¾¹ç•Œå¤–å¡« 0</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    __syncthreads();</span><br><span class="line">    </span><br><span class="line">    // åªæœ‰å†…éƒ¨çº¿ç¨‹è®¡ç®—è¾“å‡º</span><br><span class="line">    if (tx &gt; 0 &amp;&amp; tx &lt; IN_TILE_SIZE - 1 &amp;&amp; </span><br><span class="line">        ty &gt; 0 &amp;&amp; ty &lt; IN_TILE_SIZE - 1) &#123;</span><br><span class="line">        </span><br><span class="line">        int out_row = blockIdx.y * OUT_TILE_SIZE + ty - 1;</span><br><span class="line">        int out_col = blockIdx.x * OUT_TILE_SIZE + tx - 1;</span><br><span class="line">        </span><br><span class="line">        if (out_row &lt; N &amp;&amp; out_col &lt; N) &#123;</span><br><span class="line">            out[out_row * N + out_col] = </span><br><span class="line">                C0 * tile[ty][tx] +</span><br><span class="line">                C1 * (tile[ty-1][tx] + tile[ty+1][tx] +</span><br><span class="line">                      tile[ty][tx-1] + tile[ty][tx+1]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="qi-dong-pei-zhi" tabindex="-1" id="å¯åŠ¨é…ç½®">å¯åŠ¨é…ç½®</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dim3 block(IN_TILE_SIZE, IN_TILE_SIZE);  // 18Ã—18 = 324 çº¿ç¨‹</span><br><span class="line">dim3 grid((N + OUT_TILE_SIZE - 1) / OUT_TILE_SIZE,</span><br><span class="line">          (N + OUT_TILE_SIZE - 1) / OUT_TILE_SIZE);</span><br><span class="line"></span><br><span class="line">stencil_2d_tiled&lt;&lt;&lt;grid, block&gt;&gt;&gt;(d_in, d_out, N);</span><br></pre></td></tr></table></figure><h3 id="xing-neng-fen-xi" tabindex="-1" id="æ€§èƒ½åˆ†æ">æ€§èƒ½åˆ†æ</h3><table><thead><tr><th>æŒ‡æ ‡</th><th>æœ´ç´ å®ç°</th><th>Tiled å®ç°</th></tr></thead><tbody><tr><td>æ¯è¾“å‡ºå…ƒç´ </td><td>5 æ¬¡å…¨å±€è¯»å–</td><td>18Â²/16Â² â‰ˆ 1.27 æ¬¡</td></tr><tr><td>åŠ é€Ÿæ¯”</td><td>1Ã—</td><td>~4Ã—</td></tr><tr><td>å…±äº«å†…å­˜</td><td>0</td><td>18Ã—18Ã—4 = 1.3 KB</td></tr></tbody></table><h2 id="xian-cheng-cu-hua-thread-coarsening" tabindex="-1" id="çº¿ç¨‹ç²—åŒ–ï¼ˆThread-Coarseningï¼‰">çº¿ç¨‹ç²—åŒ–ï¼ˆThread Coarseningï¼‰</h2><h3 id="wei-shi-yao-cu-hua" tabindex="-1" id="ä¸ºä»€ä¹ˆç²—åŒ–">ä¸ºä»€ä¹ˆç²—åŒ–</h3><p>Tiled æ¨¡æ¿æœ‰ä¸ªé—®é¢˜ï¼šè¾¹ç•Œçº¿ç¨‹åªåŠ è½½ä¸è®¡ç®—ï¼Œæ•ˆç‡ä¸é«˜ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Block çº¿ç¨‹æ•°ï¼š18Ã—18 = 324</span><br><span class="line">è®¡ç®—çº¿ç¨‹æ•°ï¼š16Ã—16 = 256</span><br><span class="line">åˆ©ç”¨ç‡ï¼š256/324 = 79%</span><br></pre></td></tr></table></figure><p>å¦‚æœæ¨¡æ¿åŠå¾„æ›´å¤§ï¼Œåˆ©ç”¨ç‡æ›´ä½ã€‚</p><p><strong>çº¿ç¨‹ç²—åŒ–</strong>çš„æ€è·¯ï¼šè®©æ¯ä¸ªçº¿ç¨‹è®¡ç®—å¤šä¸ªè¾“å‡ºå…ƒç´ ï¼Œåˆ†æ‘Šè¾¹ç•Œå¼€é”€ã€‚</p><h3 id="z-fang-xiang-cu-hua" tabindex="-1" id="Z-æ–¹å‘ç²—åŒ–">Z æ–¹å‘ç²—åŒ–</h3><p>å¯¹äº 3D æ¨¡æ¿ï¼Œå¸¸ç”¨çš„æŠ€å·§æ˜¯åœ¨ Z æ–¹å‘å±•å¼€ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">#define IN_TILE_SIZE 18</span><br><span class="line">#define OUT_TILE_SIZE 16</span><br><span class="line">#define Z_COARSEN 8  // æ¯çº¿ç¨‹å¤„ç† 8 å±‚</span><br><span class="line"></span><br><span class="line">__global__ void stencil_3d_coarsened(float *in, float *out, </span><br><span class="line">                                      int Nx, int Ny, int Nz) &#123;</span><br><span class="line">    __shared__ float tile[3][IN_TILE_SIZE][IN_TILE_SIZE];  // åªéœ€ 3 å±‚</span><br><span class="line">    </span><br><span class="line">    int tx = threadIdx.x, ty = threadIdx.y;</span><br><span class="line">    int ox = blockIdx.x * OUT_TILE_SIZE + tx - 1;</span><br><span class="line">    int oy = blockIdx.y * OUT_TILE_SIZE + ty - 1;</span><br><span class="line">    </span><br><span class="line">    // é¢„åŠ è½½å‰ä¸¤å±‚</span><br><span class="line">    load_layer(tile[0], in, ox, oy, 0, Nx, Ny, Nz);</span><br><span class="line">    load_layer(tile[1], in, ox, oy, 1, Nx, Ny, Nz);</span><br><span class="line">    </span><br><span class="line">    // æ»‘åŠ¨çª—å£éå† Z æ–¹å‘</span><br><span class="line">    for (int z = 1; z &lt; Nz - 1; z++) &#123;</span><br><span class="line">        // åŠ è½½ä¸‹ä¸€å±‚</span><br><span class="line">        load_layer(tile[(z+1) % 3], in, ox, oy, z+1, Nx, Ny, Nz);</span><br><span class="line">        __syncthreads();</span><br><span class="line">        </span><br><span class="line">        // è®¡ç®—å½“å‰å±‚</span><br><span class="line">        if (tx &gt; 0 &amp;&amp; tx &lt; IN_TILE_SIZE - 1 &amp;&amp; </span><br><span class="line">            ty &gt; 0 &amp;&amp; ty &lt; IN_TILE_SIZE - 1) &#123;</span><br><span class="line">            int idx = z * Nx * Ny + oy * Nx + ox;</span><br><span class="line">            out[idx] = compute_stencil(tile, tx, ty, z);</span><br><span class="line">        &#125;</span><br><span class="line">        __syncthreads();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ji-cun-qi-cu-hua" tabindex="-1" id="å¯„å­˜å™¨ç²—åŒ–">å¯„å­˜å™¨ç²—åŒ–</h3><p>æ›´æ¿€è¿›çš„åšæ³•ï¼šæŠŠæ»‘åŠ¨çª—å£å­˜åœ¨å¯„å­˜å™¨é‡Œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">__global__ void stencil_3d_register(float *in, float *out, </span><br><span class="line">                                     int Nx, int Ny, int Nz) &#123;</span><br><span class="line">    __shared__ float tile[IN_TILE_SIZE][IN_TILE_SIZE];</span><br><span class="line">    </span><br><span class="line">    int tx = threadIdx.x, ty = threadIdx.y;</span><br><span class="line">    int ox = blockIdx.x * OUT_TILE_SIZE + tx - 1;</span><br><span class="line">    int oy = blockIdx.y * OUT_TILE_SIZE + ty - 1;</span><br><span class="line">    </span><br><span class="line">    // å¯„å­˜å™¨å­˜ Z æ–¹å‘çš„ä¸‰ä¸ªå€¼</span><br><span class="line">    float z_prev, z_curr, z_next;</span><br><span class="line">    </span><br><span class="line">    z_prev = load_element(in, ox, oy, 0, Nx, Ny, Nz);</span><br><span class="line">    z_curr = load_element(in, ox, oy, 1, Nx, Ny, Nz);</span><br><span class="line">    </span><br><span class="line">    for (int z = 1; z &lt; Nz - 1; z++) &#123;</span><br><span class="line">        z_next = load_element(in, ox, oy, z+1, Nx, Ny, Nz);</span><br><span class="line">        </span><br><span class="line">        // åŠ è½½ XY å¹³é¢åˆ°å…±äº«å†…å­˜</span><br><span class="line">        tile[ty][tx] = z_curr;</span><br><span class="line">        __syncthreads();</span><br><span class="line">        </span><br><span class="line">        // è®¡ç®—</span><br><span class="line">        if (valid_output_thread) &#123;</span><br><span class="line">            out[idx] = C0 * tile[ty][tx] +</span><br><span class="line">                       C1 * (tile[ty-1][tx] + tile[ty+1][tx] +</span><br><span class="line">                             tile[ty][tx-1] + tile[ty][tx+1]) +</span><br><span class="line">                       C2 * (z_prev + z_next);  // Z æ–¹å‘ç”¨å¯„å­˜å™¨</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // æ»‘åŠ¨çª—å£</span><br><span class="line">        z_prev = z_curr;</span><br><span class="line">        z_curr = z_next;</span><br><span class="line">        __syncthreads();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ä¼˜åŠ¿</strong>ï¼šZ æ–¹å‘çš„è®¿é—®å®Œå…¨åœ¨å¯„å­˜å™¨ï¼Œæ— éœ€å…±äº«å†…å­˜ã€‚</p><h2 id="bian-jie-tiao-jian-chu-li" tabindex="-1" id="è¾¹ç•Œæ¡ä»¶å¤„ç†">è¾¹ç•Œæ¡ä»¶å¤„ç†</h2><h3 id="chang-jian-bian-jie-tiao-jian" tabindex="-1" id="å¸¸è§è¾¹ç•Œæ¡ä»¶">å¸¸è§è¾¹ç•Œæ¡ä»¶</h3><p><strong>1. å›ºå®šè¾¹ç•Œï¼ˆDirichletï¼‰</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (is_boundary) &#123;</span><br><span class="line">    out[idx] = BOUNDARY_VALUE;  // å›ºå®šå€¼</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>2. å‘¨æœŸè¾¹ç•Œï¼ˆPeriodicï¼‰</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">int wrapped_x = (x + N) % N;  // ç¯ç»•</span><br><span class="line">int wrapped_y = (y + N) % N;</span><br></pre></td></tr></table></figure><p><strong>3. é›¶æ¢¯åº¦è¾¹ç•Œï¼ˆNeumannï¼‰</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// è¾¹ç•Œå¤„ç”¨ç›¸é‚»å†…éƒ¨å€¼</span><br><span class="line">if (x == 0) x = 1;</span><br><span class="line">if (x == N-1) x = N-2;</span><br></pre></td></tr></table></figure><h3 id="bian-jie-chu-li-ce-lue" tabindex="-1" id="è¾¹ç•Œå¤„ç†ç­–ç•¥">è¾¹ç•Œå¤„ç†ç­–ç•¥</h3><p><strong>æ–¹æ³• 1ï¼šæ¡ä»¶åˆ†æ”¯</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if (i &gt; 0 &amp;&amp; i &lt; N-1 &amp;&amp; j &gt; 0 &amp;&amp; j &lt; N-1) &#123;</span><br><span class="line">    // å†…éƒ¨ç‚¹è®¡ç®—</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    // è¾¹ç•Œå¤„ç†</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é—®é¢˜ï¼šåˆ†æ”¯å‘æ•£ã€‚</p><p><strong>æ–¹æ³• 2ï¼šPadding</strong></p><p>é¢„å…ˆåœ¨æ•°æ®å‘¨å›´åŠ ä¸€åœˆè¾¹ç•Œå€¼ï¼Œkernel å†…éƒ¨æ— éœ€åˆ¤æ–­ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">åŸå§‹æ•°æ® NÃ—N â†’ å¡«å……å (N+2)Ã—(N+2)</span><br><span class="line">æ‰€æœ‰è®¡ç®—éƒ½åœ¨ [1, N] èŒƒå›´å†…</span><br></pre></td></tr></table></figure><p><strong>æ–¹æ³• 3ï¼šåˆ†ç¦»è¾¹ç•Œ Kernel</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// å…ˆå¤„ç†å†…éƒ¨</span><br><span class="line">stencil_interior&lt;&lt;&lt;blocks, threads&gt;&gt;&gt;(in, out, N);</span><br><span class="line"></span><br><span class="line">// å†å¤„ç†è¾¹ç•Œ</span><br><span class="line">stencil_boundary&lt;&lt;&lt;1, boundary_threads&gt;&gt;&gt;(in, out, N);</span><br></pre></td></tr></table></figure><p>å†…éƒ¨ kernel æ— åˆ†æ”¯ï¼Œè¾¹ç•Œ kernel çº¿ç¨‹å°‘ä½†é€»è¾‘å¤æ‚ã€‚</p><h2 id="shi-jian-bu-jin-yu-shuang-huan-chong" tabindex="-1" id="æ—¶é—´æ­¥è¿›ä¸åŒç¼“å†²">æ—¶é—´æ­¥è¿›ä¸åŒç¼“å†²</h2><h3 id="die-dai-mo-shi" tabindex="-1" id="è¿­ä»£æ¨¡å¼">è¿­ä»£æ¨¡å¼</h3><p>æ¨¡æ¿è®¡ç®—é€šå¸¸éœ€è¦å¤šæ¬¡è¿­ä»£ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">for (int t = 0; t &lt; num_steps; t++) &#123;</span><br><span class="line">    stencil_kernel&lt;&lt;&lt;grid, block&gt;&gt;&gt;(d_in, d_out, N);</span><br><span class="line">    cudaDeviceSynchronize();</span><br><span class="line">    swap(d_in, d_out);  // äº¤æ¢è¾“å…¥è¾“å‡º</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å…³é”®</strong>ï¼šä¸èƒ½åŸåœ°æ›´æ–°ï¼è¯»å–é‚»å±…æ—¶å¯èƒ½è¯»åˆ°å·²æ›´æ–°çš„å€¼ï¼Œå¯¼è‡´é”™è¯¯ã€‚æ‰€ä»¥éœ€è¦<strong>åŒç¼“å†²</strong>ï¼šè¯»æ—§å†™æ–°ï¼Œç„¶åäº¤æ¢ã€‚</p><h3 id="shi-jian-zu-sai-temporal-blocking" tabindex="-1" id="æ—¶é—´é˜»å¡ï¼ˆTemporal-Blockingï¼‰">æ—¶é—´é˜»å¡ï¼ˆTemporal Blockingï¼‰</h3><p>æ¯æ¬¡ kernel å¯åŠ¨æœ‰å¼€é”€ã€‚å¦‚æœèƒ½åœ¨ä¸€æ¬¡ kernel ä¸­è®¡ç®—å¤šä¸ªæ—¶é—´æ­¥ï¼Œå°±èƒ½å‡å°‘å¯åŠ¨å¼€é”€ã€‚</p><p><strong>åŸç†</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ Tile è®¡ç®— T ä¸ªæ—¶é—´æ­¥ï¼š</span><br><span class="line">æ—¶é—´ 0ï¼šéœ€è¦ (OUT + 2r*T) çš„è¾“å…¥</span><br><span class="line">æ—¶é—´ 1ï¼šéœ€è¦ (OUT + 2r*(T-1)) çš„è¾“å…¥</span><br><span class="line">...</span><br><span class="line">æ—¶é—´ Tï¼šè¾“å‡º OUT çš„ç»“æœ</span><br></pre></td></tr></table></figure><p>éšç€æ—¶é—´æ¨è¿›ï¼Œæœ‰æ•ˆæ•°æ®åŒºåŸŸå‘å†…æ”¶ç¼©ã€‚</p><p><strong>å®ç°å¤æ‚åº¦é«˜</strong>ï¼Œé€šå¸¸åœ¨é«˜æ€§èƒ½è®¡ç®—åº“ä¸­ä½¿ç”¨ï¼Œæ‰‹å†™è¾ƒéš¾ã€‚</p><h2 id="3-d-mo-ban-you-hua" tabindex="-1" id="3D-æ¨¡æ¿ä¼˜åŒ–">3D æ¨¡æ¿ä¼˜åŒ–</h2><h3 id="tiao-zhan" tabindex="-1" id="æŒ‘æˆ˜">æŒ‘æˆ˜</h3><p>3D æ¨¡æ¿çš„å…±äº«å†…å­˜éœ€æ±‚æ›´å¤§ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2D: (T+2)Â² Ã— 4 = 324 Ã— 4 = 1.3 KB</span><br><span class="line">3D: (T+2)Â³ Ã— 4 = 8000 Ã— 4 = 32 KB  // å¯èƒ½è¶…é™ï¼</span><br></pre></td></tr></table></figure><h3 id="jie-jue-fang-an" tabindex="-1" id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ</h3><p><strong>1. å‡å° Tile å¤§å°</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#define TILE_3D 8</span><br><span class="line">// (8+2)Â³ = 1000 å…ƒç´ ï¼Œ4 KB</span><br></pre></td></tr></table></figure><p>ä»£ä»·ï¼šé™ä½æ•°æ®å¤ç”¨ç‡ã€‚</p><p><strong>2. 2.5D åˆ†è§£</strong></p><p>åªåŠ è½½ XY å¹³é¢çš„ Tileï¼ŒZ æ–¹å‘é€å±‚å¤„ç†ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__shared__ float tile[TILE_Y][TILE_X];  // åªå­˜ä¸€å±‚ XY</span><br><span class="line"></span><br><span class="line">for (int z = 0; z &lt; Nz; z++) &#123;</span><br><span class="line">    // åŠ è½½å½“å‰å±‚</span><br><span class="line">    // è®¡ç®—ï¼ˆZ æ–¹å‘é‚»å±…ä»å…¨å±€å†…å­˜è¯»ï¼‰</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Z æ–¹å‘çš„è®¿é—®ä»èµ°å…¨å±€å†…å­˜ï¼Œä½† XY æ–¹å‘åˆ©ç”¨å…±äº«å†…å­˜ã€‚</p><p><strong>3. å¯„å­˜å™¨æ»‘åŠ¨çª—å£</strong></p><p>å¦‚å‰æ‰€è¿°ï¼ŒZ æ–¹å‘ 3 ä¸ªå€¼å­˜å¯„å­˜å™¨ï¼ŒXY å¹³é¢å­˜å…±äº«å†…å­˜ã€‚</p><h2 id="zhi-ling-ji-you-hua" tabindex="-1" id="æŒ‡ä»¤çº§ä¼˜åŒ–">æŒ‡ä»¤çº§ä¼˜åŒ–</h2><h3 id="xun-huan-zhan-kai" tabindex="-1" id="å¾ªç¯å±•å¼€">å¾ªç¯å±•å¼€</h3><p>å¯¹äºå°æ¨¡æ¿ï¼Œæ‰‹åŠ¨å±•å¼€æ¶ˆé™¤å¾ªç¯å¼€é”€ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// å±•å¼€å‰</span><br><span class="line">for (int di = -1; di &lt;= 1; di++) &#123;</span><br><span class="line">    for (int dj = -1; dj &lt;= 1; dj++) &#123;</span><br><span class="line">        sum += tile[ty+di][tx+dj] * weight[di+1][dj+1];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// å±•å¼€å</span><br><span class="line">sum = tile[ty-1][tx-1] * W00 + tile[ty-1][tx] * W01 + tile[ty-1][tx+1] * W02 +</span><br><span class="line">      tile[ty  ][tx-1] * W10 + tile[ty  ][tx] * W11 + tile[ty  ][tx+1] * W12 +</span><br><span class="line">      tile[ty+1][tx-1] * W20 + tile[ty+1][tx] * W21 + tile[ty+1][tx+1] * W22;</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘å™¨é€šå¸¸ä¼šè‡ªåŠ¨å±•å¼€ï¼Œä½†æ˜¾å¼å±•å¼€ä¿è¯æ•ˆæœã€‚</p><h3 id="chang-liang-yu-ji-suan" tabindex="-1" id="å¸¸é‡é¢„è®¡ç®—">å¸¸é‡é¢„è®¡ç®—</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// ç¼–è¯‘æ—¶å¸¸é‡</span><br><span class="line">#define C0 0.25f</span><br><span class="line">#define C1 0.125f</span><br><span class="line"></span><br><span class="line">// æˆ–ä½¿ç”¨ constexprï¼ˆC++11ï¼‰</span><br><span class="line">__device__ constexpr float c0 = 0.25f;</span><br></pre></td></tr></table></figure><p>é¿å…è¿è¡Œæ—¶è®¡ç®—ç³»æ•°ã€‚</p><h3 id="xiang-liang-hua-jia-zai" tabindex="-1" id="å‘é‡åŒ–åŠ è½½">å‘é‡åŒ–åŠ è½½</h3><p>å¯¹äºå¯¹é½çš„è®¿é—®æ¨¡å¼ï¼Œä½¿ç”¨å‘é‡ç±»å‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">float4 data = *reinterpret_cast&lt;float4*&gt;(&amp;in[idx]);</span><br><span class="line">// ä¸€æ¬¡åŠ è½½ 4 ä¸ª float</span><br></pre></td></tr></table></figure><p>éœ€è¦æ•°æ®å¯¹é½ï¼ˆ16 å­—èŠ‚è¾¹ç•Œï¼‰ã€‚</p><h2 id="shi-zhan-jacobi-die-dai-qiu-jie-qi" tabindex="-1" id="å®æˆ˜ï¼šJacobi-è¿­ä»£æ±‚è§£å™¨">å®æˆ˜ï¼šJacobi è¿­ä»£æ±‚è§£å™¨</h2><h3 id="wen-ti-she-zhi" tabindex="-1" id="é—®é¢˜è®¾ç½®">é—®é¢˜è®¾ç½®</h3><p>æ±‚è§£æ³Šæ¾æ–¹ç¨‹ âˆ‡Â²u = fï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// Jacobi è¿­ä»£ï¼šu_new = (u_left + u_right + u_up + u_down - hÂ²f) / 4</span><br></pre></td></tr></table></figure><h3 id="cuda-shi-xian" tabindex="-1" id="CUDA-å®ç°">CUDA å®ç°</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">#define BLOCK_SIZE 16</span><br><span class="line">#define TILE_SIZE 18  // BLOCK_SIZE + 2</span><br><span class="line"></span><br><span class="line">__global__ void jacobi_iteration(float *u, float *u_new, float *f,</span><br><span class="line">                                  int N, float h2) &#123;</span><br><span class="line">    __shared__ float tile[TILE_SIZE][TILE_SIZE];</span><br><span class="line">    </span><br><span class="line">    int tx = threadIdx.x + 1;  // åç§» 1ï¼Œç•™å‡º Halo</span><br><span class="line">    int ty = threadIdx.y + 1;</span><br><span class="line">    int gx = blockIdx.x * BLOCK_SIZE + threadIdx.x;</span><br><span class="line">    int gy = blockIdx.y * BLOCK_SIZE + threadIdx.y;</span><br><span class="line">    </span><br><span class="line">    // åŠ è½½ä¸­å¿ƒ</span><br><span class="line">    if (gx &lt; N &amp;&amp; gy &lt; N) &#123;</span><br><span class="line">        tile[ty][tx] = u[gy * N + gx];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // åŠ è½½ Halo</span><br><span class="line">    if (threadIdx.x == 0 &amp;&amp; gx &gt; 0) &#123;</span><br><span class="line">        tile[ty][0] = u[gy * N + gx - 1];</span><br><span class="line">    &#125;</span><br><span class="line">    if (threadIdx.x == BLOCK_SIZE - 1 &amp;&amp; gx &lt; N - 1) &#123;</span><br><span class="line">        tile[ty][TILE_SIZE - 1] = u[gy * N + gx + 1];</span><br><span class="line">    &#125;</span><br><span class="line">    if (threadIdx.y == 0 &amp;&amp; gy &gt; 0) &#123;</span><br><span class="line">        tile[0][tx] = u[(gy - 1) * N + gx];</span><br><span class="line">    &#125;</span><br><span class="line">    if (threadIdx.y == BLOCK_SIZE - 1 &amp;&amp; gy &lt; N - 1) &#123;</span><br><span class="line">        tile[TILE_SIZE - 1][tx] = u[(gy + 1) * N + gx];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    __syncthreads();</span><br><span class="line">    </span><br><span class="line">    // è®¡ç®—ï¼ˆè·³è¿‡è¾¹ç•Œï¼‰</span><br><span class="line">    if (gx &gt; 0 &amp;&amp; gx &lt; N - 1 &amp;&amp; gy &gt; 0 &amp;&amp; gy &lt; N - 1) &#123;</span><br><span class="line">        float f_val = f[gy * N + gx];</span><br><span class="line">        u_new[gy * N + gx] = 0.25f * (tile[ty-1][tx] + tile[ty+1][tx] +</span><br><span class="line">                                       tile[ty][tx-1] + tile[ty][tx+1] -</span><br><span class="line">                                       h2 * f_val);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Host ç«¯è¿­ä»£</span><br><span class="line">void jacobi_solve(float *u, float *f, int N, int max_iter, float tol) &#123;</span><br><span class="line">    float *d_u, *d_u_new, *d_f;</span><br><span class="line">    // ... åˆ†é…å†…å­˜ ...</span><br><span class="line">    </span><br><span class="line">    dim3 block(BLOCK_SIZE, BLOCK_SIZE);</span><br><span class="line">    dim3 grid((N + BLOCK_SIZE - 1) / BLOCK_SIZE,</span><br><span class="line">              (N + BLOCK_SIZE - 1) / BLOCK_SIZE);</span><br><span class="line">    </span><br><span class="line">    for (int iter = 0; iter &lt; max_iter; iter++) &#123;</span><br><span class="line">        jacobi_iteration&lt;&lt;&lt;grid, block&gt;&gt;&gt;(d_u, d_u_new, d_f, N, h*h);</span><br><span class="line">        cudaDeviceSynchronize();</span><br><span class="line">        </span><br><span class="line">        // äº¤æ¢æŒ‡é’ˆ</span><br><span class="line">        float *temp = d_u;</span><br><span class="line">        d_u = d_u_new;</span><br><span class="line">        d_u_new = temp;</span><br><span class="line">        </span><br><span class="line">        // å¯é€‰ï¼šæ£€æŸ¥æ”¶æ•›</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="shou-lian-jian-cha" tabindex="-1" id="æ”¶æ•›æ£€æŸ¥">æ”¶æ•›æ£€æŸ¥</h3><p>æ¯éš”å‡ æ­¥æ£€æŸ¥æ®‹å·®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">__global__ void compute_residual(float *u, float *f, float *residual,</span><br><span class="line">                                  int N, float h2) &#123;</span><br><span class="line">    // è®¡ç®— ||âˆ‡Â²u - f||</span><br><span class="line">    // ä½¿ç”¨è§„çº¦æ±‚å’Œ</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸éœ€è¦æ¯æ­¥éƒ½æ£€æŸ¥ï¼Œå¼€é”€å¤ªå¤§ã€‚</p><h2 id="xing-neng-diao-you-jian-yi" tabindex="-1" id="æ€§èƒ½è°ƒä¼˜å»ºè®®">æ€§èƒ½è°ƒä¼˜å»ºè®®</h2><h3 id="tile-da-xiao-xuan-ze" tabindex="-1" id="Tile-å¤§å°é€‰æ‹©">Tile å¤§å°é€‰æ‹©</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">å…±äº«å†…å­˜é™åˆ¶ï¼š96 KB / SMï¼ˆAmpereï¼‰</span><br><span class="line">æ¯ Block å¯ç”¨ï¼š~48 KB</span><br><span class="line"></span><br><span class="line">2D Tile: sqrt(48K/4) â‰ˆ 110 â†’ å®é™…ç”¨ 32ã€48ã€64</span><br><span class="line">3D Tile: cbrt(48K/4) â‰ˆ 23  â†’ å®é™…ç”¨ 8ã€12ã€16</span><br></pre></td></tr></table></figure><p>éœ€è¦è€ƒè™‘å ç”¨ç‡ï¼šTile å¤ªå¤§å¯¼è‡´æ¯ SM çš„ Block æ•°å‡å°‘ã€‚</p><h3 id="nsight-zhi-biao" tabindex="-1" id="Nsight-æŒ‡æ ‡">Nsight æŒ‡æ ‡</h3><p>å…³æ³¨ï¼š</p><table><thead><tr><th>æŒ‡æ ‡</th><th>æ„ä¹‰</th><th>ç›®æ ‡</th></tr></thead><tbody><tr><td>Memory Throughput</td><td>å¸¦å®½åˆ©ç”¨</td><td>æ¥è¿‘å³°å€¼</td></tr><tr><td>Compute Throughput</td><td>è®¡ç®—åˆ©ç”¨</td><td>è¶Šé«˜è¶Šå¥½</td></tr><tr><td>Shared Memory Usage</td><td>å…±äº«å†…å­˜</td><td>ä¸è¶…é™</td></tr><tr><td>Warp Occupancy</td><td>å ç”¨ç‡</td><td>&gt;50%</td></tr></tbody></table><h3 id="chang-jian-ping-jing" tabindex="-1" id="å¸¸è§ç“¶é¢ˆ">å¸¸è§ç“¶é¢ˆ</h3><p><strong>å¸¦å®½å—é™</strong>ï¼šTiling ä¼˜åŒ–ã€å¯„å­˜å™¨ç¼“å­˜<br><strong>è®¡ç®—å—é™</strong>ï¼šå‘é‡åŒ–ã€æŒ‡ä»¤çº§å¹¶è¡Œ<br><strong>å»¶è¿Ÿå—é™</strong>ï¼šå¢åŠ å ç”¨ç‡ã€é¢„å–</p><h2 id="mo-ban-you-hua-zong-jie" tabindex="-1" id="æ¨¡æ¿ä¼˜åŒ–æ€»ç»“">æ¨¡æ¿ä¼˜åŒ–æ€»ç»“</h2><h3 id="he-xin-ji-zhu" tabindex="-1" id="æ ¸å¿ƒæŠ€æœ¯">æ ¸å¿ƒæŠ€æœ¯</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ Level 3: é«˜çº§ä¼˜åŒ–                                            â”‚</span><br><span class="line">â”‚   - æ—¶é—´é˜»å¡ï¼ˆå¤šæ­¥åˆå¹¶ï¼‰                                      â”‚</span><br><span class="line">â”‚   - è‡ªåŠ¨è°ƒä¼˜ï¼ˆæœç´¢æœ€ä¼˜å‚æ•°ï¼‰                                  â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚ Level 2: æ•°æ®å±€éƒ¨æ€§                                          â”‚</span><br><span class="line">â”‚   - å…±äº«å†…å­˜ Tiling                                          â”‚</span><br><span class="line">â”‚   - å¯„å­˜å™¨æ»‘åŠ¨çª—å£                                           â”‚</span><br><span class="line">â”‚   - çº¿ç¨‹ç²—åŒ–                                                 â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚ Level 1: åŸºç¡€ä¼˜åŒ–                                            â”‚</span><br><span class="line">â”‚   - åŒç¼“å†²é¿å…ç«äº‰                                           â”‚</span><br><span class="line">â”‚   - è¾¹ç•Œæ¡ä»¶å¤„ç†                                             â”‚</span><br><span class="line">â”‚   - åˆå¹¶å†…å­˜è®¿é—®                                             â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure><h3 id="mo-ban-vs-juan-ji-jue-ce" tabindex="-1" id="æ¨¡æ¿-vs-å·ç§¯å†³ç­–">æ¨¡æ¿ vs å·ç§¯å†³ç­–</h3><table><thead><tr><th>åœºæ™¯</th><th>æ¨èæŠ€æœ¯</th></tr></thead><tbody><tr><td>å•æ¬¡æ»¤æ³¢</td><td>å·ç§¯ + å¸¸é‡å†…å­˜</td></tr><tr><td>è¿­ä»£æ±‚è§£</td><td>æ¨¡æ¿ + åŒç¼“å†²</td></tr><tr><td>å¤§åŠå¾„æ¨¡æ¿</td><td>æ—¶é—´é˜»å¡</td></tr><tr><td>3D + å¤§è§„æ¨¡</td><td>2.5D + å¯„å­˜å™¨æ»‘åŠ¨</td></tr></tbody></table><h2 id="xiao-jie" tabindex="-1" id="å°ç»“">å°ç»“</h2><p>ç¬¬å…«ç« å›´ç»•æ¨¡æ¿è®¡ç®—ï¼Œåœ¨ç¬¬ä¸ƒç« å·ç§¯çš„åŸºç¡€ä¸Šå¢åŠ äº†ï¼š</p><p><strong>è¿­ä»£ç»“æ„</strong>ï¼šæ¨¡æ¿è®¡ç®—é€šå¸¸æ˜¯å¤šæ­¥è¿­ä»£çš„ã€‚åŒç¼“å†²æ˜¯åŸºæœ¬æŠ€å·§â€”â€”è¯»æ—§å†™æ–°ï¼Œç„¶åäº¤æ¢ã€‚</p><p><strong>çº¿ç¨‹ç²—åŒ–</strong>ï¼šè®©æ¯ä¸ªçº¿ç¨‹è®¡ç®—å¤šä¸ªè¾“å‡ºï¼Œåˆ†æ‘Šè¾¹ç•Œçº¿ç¨‹çš„å¼€é”€ã€‚Z æ–¹å‘ç²—åŒ–æ˜¯ 3D æ¨¡æ¿çš„å¸¸ç”¨æŠ€å·§ã€‚</p><p><strong>å¯„å­˜å™¨ä¼˜åŒ–</strong>ï¼šå¯¹äºæ»‘åŠ¨çª—å£æ¨¡å¼ï¼ŒæŠŠæ—¶é—´ç»´åº¦æˆ–ç©ºé—´ç»´åº¦çš„å°é‚»åŸŸå­˜å¯„å­˜å™¨ï¼Œæ¯”å…±äº«å†…å­˜æ›´å¿«ã€‚</p><p><strong>è¾¹ç•Œå¤„ç†</strong>ï¼šDirichletã€Neumannã€å‘¨æœŸè¾¹ç•Œå„æœ‰ç­–ç•¥ã€‚Padding é¢„å¤„ç†èƒ½ç®€åŒ– kernel é€»è¾‘ï¼Œä½†éœ€è¦é¢å¤–å†…å­˜ã€‚</p><p><strong>3D æŒ‘æˆ˜</strong>ï¼šå…±äº«å†…å­˜éœ€æ±‚çˆ†ç‚¸ã€‚2.5D åˆ†è§£ã€å¯„å­˜å™¨æ»‘åŠ¨æ˜¯è§£å†³æ–¹æ¡ˆã€‚</p><p>æ¨¡æ¿è®¡ç®—æ˜¯ç§‘å­¦è®¡ç®—çš„æ ¸å¿ƒï¼Œçƒ­ä¼ å¯¼ã€æµä½“åŠ›å­¦ã€ç”µç£ä»¿çœŸéƒ½ç”¨åˆ°ã€‚æŒæ¡è¿™å¥—ä¼˜åŒ–æŠ€æœ¯ï¼Œå°±èƒ½é«˜æ•ˆå®ç°å„ç§ PDE æ±‚è§£å™¨ã€‚ä¸‹ä¸€ç« è¿›å…¥å¦ä¸€ä¸ªé‡è¦æ¨¡å¼â€”â€”å¹¶è¡Œç›´æ–¹å›¾ã€‚</p><hr><p><strong>å‚è€ƒèµ„æ–™ï¼š</strong></p><ul><li>Hwu, W., Kirk, D., &amp; El Hajj, I. (2022). <em>Programming Massively Parallel Processors: A Hands-on Approach</em> (4th Edition). Morgan Kaufmann.</li><li><a href="https://docs.nvidia.com/cuda/cuda-c-programming-guide/index.html#shared-memory">CUDA C++ Programming Guide - Shared Memory</a></li><li>Datta, K., et al. (2008). <em>Stencil computation optimization and auto-tuning on state-of-the-art multicore architectures</em>. SC08.</li></ul><hr><blockquote><p><strong>æœ¬æ–‡ GitHub ä»“åº“</strong>: <a href="https://github.com/psmarter/PMPP-Learning">https://github.com/psmarter/PMPP-Learning</a></p></blockquote>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;qian-yan&quot; tabindex=&quot;-1&quot;</summary>
        
      
    
    
    
    <category term="çŸ¥è¯†åˆ†äº«" scheme="https://smarter.xin/categories/knowledge-sharing/"/>
    
    
    <category term="CUDA" scheme="https://smarter.xin/tags/CUDA/"/>
    
    <category term="GPUç¼–ç¨‹" scheme="https://smarter.xin/tags/gpu-programming/"/>
    
    <category term="å¹¶è¡Œè®¡ç®—" scheme="https://smarter.xin/tags/parallel-computing/"/>
    
    <category term="PMPP" scheme="https://smarter.xin/tags/PMPP/"/>
    
    <category term="å…±äº«å†…å­˜" scheme="https://smarter.xin/tags/shared-memory/"/>
    
    <category term="æ¨¡æ¿è®¡ç®—" scheme="https://smarter.xin/tags/template-computation/"/>
    
    <category term="Stencil" scheme="https://smarter.xin/tags/Stencil/"/>
    
  </entry>
  
  <entry>
    <title>PMPP-ç¬¬ä¸ƒç« ï¼šå·ç§¯</title>
    <link href="https://smarter.xin/posts/1c778456/"/>
    <id>https://smarter.xin/posts/1c778456/</id>
    <published>2026-01-16T13:58:04.000Z</published>
    <updated>2026-01-24T08:26:21.331Z</updated>
    
    <content type="html"><![CDATA[<h2 id="qian-yan" tabindex="-1" id="å‰è¨€">å‰è¨€</h2><p>ç¬¬å…­ç« è®²äº†æ€§èƒ½ä¼˜åŒ–çš„æ–¹æ–¹é¢é¢ï¼Œç°åœ¨å¼€å§‹å­¦ä¹ å…·ä½“çš„å¹¶è¡Œæ¨¡å¼ã€‚ç¬¬ä¸ƒç« çš„ä¸»è§’æ˜¯<strong>å·ç§¯ï¼ˆConvolutionï¼‰</strong>â€”â€”ä¿¡å·å¤„ç†å’Œæ·±åº¦å­¦ä¹ çš„æ ¸å¿ƒç®—å­ã€‚å·ç§¯çœ‹ä¼¼ç®€å•ï¼Œä½†è¦é«˜æ•ˆå®ç°å´æ¶‰åŠå¤šä¸ªå†…å­˜å±‚æ¬¡çš„é…åˆï¼šå¸¸é‡å†…å­˜å­˜å·ç§¯æ ¸ã€å…±äº«å†…å­˜åš Tilingã€å…¨å±€å†…å­˜è¾“å…¥è¾“å‡ºã€‚è¿™ç« å°±æ˜¯æ•™ä½ å¦‚ä½•æŠŠè¿™äº›æŠ€æœ¯ç»„åˆèµ·æ¥ï¼Œå†™å‡ºå·¥ä¸šçº§çš„å·ç§¯ Kernelã€‚</p><blockquote><p><strong>ğŸ“¦ é…å¥—èµ„æº</strong>ï¼šæœ¬ç³»åˆ—æ–‡ç« é…æœ‰å®Œæ•´çš„ <a href="https://github.com/psmarter/PMPP-Learning">GitHub ä»“åº“</a>ï¼ŒåŒ…å«æ¯ç« çš„ç»ƒä¹ é¢˜è§£ç­”ã€CUDA ä»£ç å®ç°å’Œè¯¦ç»†æ³¨é‡Šã€‚æ‰€æœ‰ä»£ç éƒ½ç»è¿‡æµ‹è¯•ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œã€‚</p></blockquote><h2 id="juan-ji-ji-chu" tabindex="-1" id="å·ç§¯åŸºç¡€">å·ç§¯åŸºç¡€</h2><h3 id="shi-yao-shi-juan-ji" tabindex="-1" id="ä»€ä¹ˆæ˜¯å·ç§¯">ä»€ä¹ˆæ˜¯å·ç§¯</h3><p>å·ç§¯æ˜¯ä¸€ç§æ•°å­¦è¿ç®—ï¼Œç”¨ä¸€ä¸ªå°çŸ©é˜µï¼ˆ<strong>å·ç§¯æ ¸/æ»¤æ³¢å™¨</strong>ï¼‰åœ¨è¾“å…¥æ•°æ®ä¸Šæ»‘åŠ¨ï¼Œåœ¨æ¯ä¸ªä½ç½®è®¡ç®—åŠ æƒå’Œã€‚</p><p><strong>1D å·ç§¯</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼š  [1, 2, 3, 4, 5, 6, 7]</span><br><span class="line">å·ç§¯æ ¸ï¼š[1, 2, 1]</span><br><span class="line">è¾“å‡ºï¼š  [_, 8, 12, 16, 20, 24, _]</span><br><span class="line"></span><br><span class="line">è®¡ç®— Output[3]ï¼š</span><br><span class="line">= Input[2]*Kernel[0] + Input[3]*Kernel[1] + Input[4]*Kernel[2]</span><br><span class="line">= 3*1 + 4*2 + 5*1 = 12</span><br></pre></td></tr></table></figure><p><strong>2D å·ç§¯</strong>ï¼ˆå›¾åƒå¤„ç†å¸¸ç”¨ï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥å›¾åƒ                    å·ç§¯æ ¸ (3Ã—3)</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ 1 2 3 4 5     â”‚           â”‚ 1 0 1 â”‚</span><br><span class="line">â”‚ 5 6 7 8 9     â”‚     *     â”‚ 0 1 0 â”‚</span><br><span class="line">â”‚ 9 0 1 2 3     â”‚           â”‚ 1 0 1 â”‚</span><br><span class="line">â”‚ 4 5 6 7 8     â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure><h3 id="juan-ji-de-ying-yong" tabindex="-1" id="å·ç§¯çš„åº”ç”¨">å·ç§¯çš„åº”ç”¨</h3><p>å·ç§¯æ— å¤„ä¸åœ¨ï¼š</p><table><thead><tr><th>é¢†åŸŸ</th><th>åº”ç”¨</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td>å›¾åƒå¤„ç†</td><td>è¾¹ç¼˜æ£€æµ‹ã€æ¨¡ç³Šã€é”åŒ–</td><td>Sobelã€Gaussian Blur</td></tr><tr><td>éŸ³é¢‘å¤„ç†</td><td>å›å£°ã€å‡è¡¡å™¨ã€é™å™ª</td><td>FIR æ»¤æ³¢å™¨</td></tr><tr><td>æ·±åº¦å­¦ä¹ </td><td>ç‰¹å¾æå–</td><td>CNN çš„æ ¸å¿ƒæ“ä½œ</td></tr><tr><td>ç‰©ç†ä»¿çœŸ</td><td>æ‰©æ•£æ–¹ç¨‹ã€æœ‰é™å·®åˆ†</td><td>çƒ­ä¼ å¯¼ã€æ³¢åŠ¨æ–¹ç¨‹</td></tr></tbody></table><h3 id="juan-ji-de-shu-xue-ding-yi" tabindex="-1" id="å·ç§¯çš„æ•°å­¦å®šä¹‰">å·ç§¯çš„æ•°å­¦å®šä¹‰</h3><p><strong>1D ç¦»æ•£å·ç§¯</strong>ï¼š</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>O</mi><mi>u</mi><mi>t</mi><mi>p</mi><mi>u</mi><mi>t</mi><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo><mo>=</mo><munderover><mo>âˆ‘</mo><mrow><mi>j</mi><mo>=</mo><mo>âˆ’</mo><mi>r</mi></mrow><mi>r</mi></munderover><mi>I</mi><mi>n</mi><mi>p</mi><mi>u</mi><mi>t</mi><mo stretchy="false">[</mo><mi>i</mi><mo>+</mo><mi>j</mi><mo stretchy="false">]</mo><mo>Ã—</mo><mi>K</mi><mi>e</mi><mi>r</mi><mi>n</mi><mi>e</mi><mi>l</mi><mo stretchy="false">[</mo><mi>j</mi><mo>+</mo><mi>r</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">Output[i] = \sum_{j=-r}^{r} Input[i+j] \times Kernel[j+r]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mord mathnormal">u</span><span class="mord mathnormal">tp</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.0652em;vertical-align:-1.4138em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">âˆ’</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.4138em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mord mathnormal">n</span><span class="mord mathnormal">p</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">Ker</span><span class="mord mathnormal">n</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mclose">]</span></span></span></span></span></p><p>å…¶ä¸­ r æ˜¯å·ç§¯æ ¸çš„&quot;åŠå¾„&quot;ï¼Œå·ç§¯æ ¸å¤§å°ä¸º 2r+1ã€‚</p><p><strong>2D ç¦»æ•£å·ç§¯</strong>ï¼š</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>O</mi><mi>u</mi><mi>t</mi><mi>p</mi><mi>u</mi><mi>t</mi><mo stretchy="false">[</mo><mi>y</mi><mo stretchy="false">]</mo><mo stretchy="false">[</mo><mi>x</mi><mo stretchy="false">]</mo><mo>=</mo><munderover><mo>âˆ‘</mo><mrow><mi>d</mi><mi>y</mi><mo>=</mo><mo>âˆ’</mo><mi>r</mi></mrow><mi>r</mi></munderover><munderover><mo>âˆ‘</mo><mrow><mi>d</mi><mi>x</mi><mo>=</mo><mo>âˆ’</mo><mi>r</mi></mrow><mi>r</mi></munderover><mi>I</mi><mi>n</mi><mi>p</mi><mi>u</mi><mi>t</mi><mo stretchy="false">[</mo><mi>y</mi><mo>+</mo><mi>d</mi><mi>y</mi><mo stretchy="false">]</mo><mo stretchy="false">[</mo><mi>x</mi><mo>+</mo><mi>d</mi><mi>x</mi><mo stretchy="false">]</mo><mo>Ã—</mo><mi>K</mi><mi>e</mi><mi>r</mi><mi>n</mi><mi>e</mi><mi>l</mi><mo stretchy="false">[</mo><mi>d</mi><mi>y</mi><mo>+</mo><mi>r</mi><mo stretchy="false">]</mo><mo stretchy="false">[</mo><mi>d</mi><mi>x</mi><mo>+</mo><mi>r</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">Output[y][x] = \sum_{dy=-r}^{r} \sum_{dx=-r}^{r} Input[y+dy][x+dx] \times Kernel[dy+r][dx+r]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mord mathnormal">u</span><span class="mord mathnormal">tp</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord mathnormal">x</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.0896em;vertical-align:-1.4382em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8479em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span><span class="mrel mtight">=</span><span class="mord mtight">âˆ’</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.4382em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8479em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">x</span><span class="mrel mtight">=</span><span class="mord mtight">âˆ’</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.3604em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mord mathnormal">n</span><span class="mord mathnormal">p</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">x</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">Ker</span><span class="mord mathnormal">n</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mopen">[</span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord mathnormal">d</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mclose">]</span></span></span></span></span></p><h3 id="bian-jie-chu-li" tabindex="-1" id="è¾¹ç•Œå¤„ç†">è¾¹ç•Œå¤„ç†</h3><p>å½“å·ç§¯çª—å£è¶…å‡ºè¾“å…¥è¾¹ç•Œæ—¶ï¼Œæœ‰å‡ ç§å¤„ç†ç­–ç•¥ï¼š</p><p><strong>1. é›¶å¡«å……ï¼ˆZero Paddingï¼‰</strong>ï¼šè¾¹ç•Œå¤–çš„å…ƒç´ è§†ä¸º 0</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Padding å‰ï¼š[1, 2, 3, 4, 5]</span><br><span class="line">Padding åï¼š[0, 0, 1, 2, 3, 4, 5, 0, 0]</span><br></pre></td></tr></table></figure><p><strong>2. å¤åˆ¶å¡«å……ï¼ˆReplicate Paddingï¼‰</strong>ï¼šç”¨è¾¹ç•Œå€¼å¡«å……</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Padding åï¼š[1, 1, 1, 2, 3, 4, 5, 5, 5]</span><br></pre></td></tr></table></figure><p><strong>3. é•œåƒå¡«å……ï¼ˆReflect Paddingï¼‰</strong>ï¼šé•œåƒè¾¹ç•Œå…ƒç´ </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Padding åï¼š[3, 2, 1, 2, 3, 4, 5, 4, 3]</span><br></pre></td></tr></table></figure><p>åœ¨ CUDA å®ç°ä¸­ï¼Œé›¶å¡«å……æœ€ç®€å•â€”â€”åªéœ€åœ¨è¾¹ç•Œåˆ¤æ–­æ—¶è¿”å› 0ã€‚</p><h2 id="po-su-1-d-juan-ji-shi-xian" tabindex="-1" id="æœ´ç´ -1D-å·ç§¯å®ç°">æœ´ç´  1D å·ç§¯å®ç°</h2><h3 id="ji-ben-si-lu" tabindex="-1" id="åŸºæœ¬æ€è·¯">åŸºæœ¬æ€è·¯</h3><p>æ¯ä¸ªçº¿ç¨‹è´Ÿè´£è®¡ç®—ä¸€ä¸ªè¾“å‡ºå…ƒç´ ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">__global__ void conv1d_basic(float *input, float *kernel, float *output,</span><br><span class="line">                              int n, int kernel_size) &#123;</span><br><span class="line">    int i = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">    int r = kernel_size / 2;  // å·ç§¯æ ¸åŠå¾„</span><br><span class="line">    </span><br><span class="line">    if (i &lt; n) &#123;</span><br><span class="line">        float sum = 0.0f;</span><br><span class="line">        for (int j = -r; j &lt;= r; j++) &#123;</span><br><span class="line">            int idx = i + j;</span><br><span class="line">            if (idx &gt;= 0 &amp;&amp; idx &lt; n) &#123;</span><br><span class="line">                sum += input[idx] * kernel[j + r];</span><br><span class="line">            &#125;</span><br><span class="line">            // è¾¹ç•Œå¤–éšå¼ä¸º 0ï¼ˆé›¶å¡«å……ï¼‰</span><br><span class="line">        &#125;</span><br><span class="line">        output[i] = sum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="xing-neng-wen-ti" tabindex="-1" id="æ€§èƒ½é—®é¢˜">æ€§èƒ½é—®é¢˜</h3><p>è¿™ä¸ªæœ´ç´ å®ç°æœ‰ä¸¤ä¸ªç“¶é¢ˆï¼š</p><p><strong>1. å·ç§¯æ ¸é‡å¤è¯»å–</strong></p><p>æ¯ä¸ªçº¿ç¨‹éƒ½è¦è¯»å–æ•´ä¸ªå·ç§¯æ ¸ã€‚å¦‚æœæœ‰ 10 ä¸‡ä¸ªçº¿ç¨‹ï¼Œå·ç§¯æ ¸å°±è¢«è¯»å– 10 ä¸‡æ¬¡ã€‚ä½†å·ç§¯æ ¸å¯¹æ‰€æœ‰çº¿ç¨‹æ˜¯ç›¸åŒçš„ï¼</p><p><strong>2. è¾“å…¥æ•°æ®é‡å¤è¯»å–</strong></p><p>ç›¸é‚»çº¿ç¨‹çš„å·ç§¯çª—å£é«˜åº¦é‡å ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">çº¿ç¨‹ i   è¯»å–ï¼šinput[i-1], input[i], input[i+1]</span><br><span class="line">çº¿ç¨‹ i+1 è¯»å–ï¼šinput[i], input[i+1], input[i+2]</span><br><span class="line">                â†‘ å…±äº«å…ƒç´ </span><br></pre></td></tr></table></figure><p>å·ç§¯æ ¸å¤§å°ä¸º 2r+1 æ—¶ï¼Œæ¯ä¸ªè¾“å…¥å…ƒç´ å¹³å‡è¢«è¯»å– 2r+1 æ¬¡ã€‚</p><h2 id="chang-liang-nei-cun-you-hua" tabindex="-1" id="å¸¸é‡å†…å­˜ä¼˜åŒ–">å¸¸é‡å†…å­˜ä¼˜åŒ–</h2><h3 id="chang-liang-nei-cun-te-xing" tabindex="-1" id="å¸¸é‡å†…å­˜ç‰¹æ€§">å¸¸é‡å†…å­˜ç‰¹æ€§</h3><p>ç¬¬äº”ç« æè¿‡å¸¸é‡å†…å­˜ï¼Œè¿™é‡Œæ·±å…¥è®²è§£ï¼š</p><p><strong>ç¡¬ä»¶ç»“æ„</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚           å¸¸é‡å†…å­˜ (64 KB)            â”‚</span><br><span class="line">â”‚           Device DRAM                â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">               â”‚ å¹¿æ’­</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚        å¸¸é‡ç¼“å­˜ (æ¯ SM ~8 KB)         â”‚</span><br><span class="line">â”‚           On-chip Cache              â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">               â”‚ æä½å»¶è¿Ÿ</span><br><span class="line">               â†“</span><br><span class="line">         Warp ä¸­çš„çº¿ç¨‹</span><br></pre></td></tr></table></figure><p><strong>ç‰¹ç‚¹</strong>ï¼š</p><ol><li><strong>åªè¯»</strong>ï¼šKernel æ‰§è¡ŒæœŸé—´ä¸èƒ½ä¿®æ”¹</li><li><strong>ç¼“å­˜ä¼˜åŒ–</strong>ï¼šæœ‰ä¸“ç”¨ç¼“å­˜ï¼Œå‘½ä¸­æ—¶å»¶è¿Ÿæä½</li><li><strong>å¹¿æ’­é«˜æ•ˆ</strong>ï¼šåŒä¸€ Warp è¯»ç›¸åŒåœ°å€æ—¶ï¼Œåªéœ€ä¸€æ¬¡è®¿é—®</li></ol><p><strong>ä¸ºä»€ä¹ˆé€‚åˆå·ç§¯æ ¸</strong>ï¼š</p><ul><li>å·ç§¯æ ¸å¯¹æ‰€æœ‰çº¿ç¨‹éƒ½æ˜¯ç›¸åŒçš„å¸¸é‡</li><li>æ¯æ¬¡å·ç§¯æ“ä½œï¼Œæ‰€æœ‰çº¿ç¨‹éƒ½è¯»ç›¸åŒçš„ kernel[j]</li><li>å®Œç¾åŒ¹é…å¸¸é‡å†…å­˜çš„&quot;å¹¿æ’­&quot;ç‰¹æ€§</li></ul><h3 id="shi-yong-chang-liang-nei-cun" tabindex="-1" id="ä½¿ç”¨å¸¸é‡å†…å­˜">ä½¿ç”¨å¸¸é‡å†…å­˜</h3><p><strong>å£°æ˜</strong>ï¼ˆå…¨å±€ä½œç”¨åŸŸï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#define MAX_KERNEL_SIZE 1025</span><br><span class="line">__constant__ float d_kernel[MAX_KERNEL_SIZE];</span><br></pre></td></tr></table></figure><p><strong>Host ç«¯åˆå§‹åŒ–</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">float h_kernel[kernel_size];</span><br><span class="line">// ... å¡«å……å·ç§¯æ ¸æ•°æ® ...</span><br><span class="line"></span><br><span class="line">cudaMemcpyToSymbol(d_kernel, h_kernel, kernel_size * sizeof(float));</span><br></pre></td></tr></table></figure><p><strong>Kernel ä¸­ä½¿ç”¨</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">__global__ void conv1d_const(float *input, float *output, </span><br><span class="line">                              int n, int kernel_size) &#123;</span><br><span class="line">    int i = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">    int r = kernel_size / 2;</span><br><span class="line">    </span><br><span class="line">    if (i &lt; n) &#123;</span><br><span class="line">        float sum = 0.0f;</span><br><span class="line">        for (int j = -r; j &lt;= r; j++) &#123;</span><br><span class="line">            int idx = i + j;</span><br><span class="line">            if (idx &gt;= 0 &amp;&amp; idx &lt; n) &#123;</span><br><span class="line">                sum += input[idx] * d_kernel[j + r];  // ç›´æ¥ä½¿ç”¨</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        output[i] = sum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="xing-neng-ti-sheng" tabindex="-1" id="æ€§èƒ½æå‡">æ€§èƒ½æå‡</h3><p>å¸¸é‡å†…å­˜è§£å†³äº†<strong>å·ç§¯æ ¸é‡å¤è¯»å–</strong>çš„é—®é¢˜ï¼š</p><table><thead><tr><th>ç‰ˆæœ¬</th><th>å·ç§¯æ ¸è¯»å–</th><th>å¸¦å®½æ¶ˆè€—</th></tr></thead><tbody><tr><td>æœ´ç´ </td><td>NÃ—K æ¬¡</td><td>é«˜</td></tr><tr><td>å¸¸é‡å†…å­˜</td><td>K æ¬¡ + ç¼“å­˜</td><td>æä½ï¼ˆå¹¿æ’­ï¼‰</td></tr></tbody></table><p>å…¶ä¸­ N æ˜¯è¾“å‡ºå…ƒç´ æ•°ï¼ŒK æ˜¯å·ç§¯æ ¸å¤§å°ã€‚</p><p>ä½†è¾“å…¥æ•°æ®çš„é‡å¤è¯»å–é—®é¢˜è¿˜æ²¡è§£å†³â€”â€”è¿™éœ€è¦ Tilingã€‚</p><h2 id="tiled-juan-ji" tabindex="-1" id="Tiled-å·ç§¯">Tiled å·ç§¯</h2><h3 id="wei-shi-yao-xu-yao-tiling" tabindex="-1" id="ä¸ºä»€ä¹ˆéœ€è¦-Tiling">ä¸ºä»€ä¹ˆéœ€è¦ Tiling</h3><p>å›é¡¾è¾“å…¥æ•°æ®è®¿é—®æ¨¡å¼ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Block å†…çš„çº¿ç¨‹è®¿é—®ï¼š</span><br><span class="line">çº¿ç¨‹ 0:   input[0], input[1], ..., input[k-1]</span><br><span class="line">çº¿ç¨‹ 1:   input[1], input[2], ..., input[k]</span><br><span class="line">...</span><br><span class="line">çº¿ç¨‹ 255: input[255], input[256], ..., input[255+k-1]</span><br></pre></td></tr></table></figure><p>Block å†…çš„çº¿ç¨‹è®¿é—®èŒƒå›´æ˜¯è¿ç»­çš„ï¼Œæœ‰å¤§é‡é‡å ã€‚æŠŠè¿™éƒ¨åˆ†æ•°æ®åŠ è½½åˆ°å…±äº«å†…å­˜ï¼Œå°±èƒ½é¿å…é‡å¤çš„å…¨å±€å†…å­˜è®¿é—®ã€‚</p><h3 id="shu-ru-tile-she-ji" tabindex="-1" id="è¾“å…¥-Tile-è®¾è®¡">è¾“å…¥ Tile è®¾è®¡</h3><p>å…³é”®é—®é¢˜ï¼š<strong>ä¸€ä¸ª Block çš„çº¿ç¨‹éœ€è¦å¤šå¤§çš„è¾“å…¥ Tileï¼Ÿ</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Block å¤§å°ï¼šBLOCK_SIZE</span><br><span class="line">å·ç§¯æ ¸åŠå¾„ï¼šr</span><br><span class="line">å·ç§¯æ ¸å¤§å°ï¼š2r + 1</span><br><span class="line"></span><br><span class="line">è¾“å‡ºèŒƒå›´ï¼š[block_start, block_start + BLOCK_SIZE - 1]</span><br><span class="line">è¾“å…¥èŒƒå›´ï¼š[block_start - r, block_start + BLOCK_SIZE - 1 + r]</span><br><span class="line">         = block_start - r, block_start + BLOCK_SIZE + r - 1]</span><br><span class="line"></span><br><span class="line">è¾“å…¥ Tile å¤§å° = BLOCK_SIZE + 2r</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œè¦è®¡ç®— BLOCK_SIZE ä¸ªè¾“å‡ºï¼Œéœ€è¦è¯»å– BLOCK_SIZE + 2r ä¸ªè¾“å…¥å…ƒç´ ã€‚</p><h3 id="halo-yuan-su" tabindex="-1" id="Halo-å…ƒç´ ">Halo å…ƒç´ </h3><p>è¾“å…¥ Tile æ¯”è¾“å‡º Tile å¤§ï¼Œå¤šå‡ºæ¥çš„éƒ¨åˆ†å«åš <strong>Haloï¼ˆå…‰æ™•ï¼‰å…ƒç´ </strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">                    Halo                 ä¸»ä½“                  Halo</span><br><span class="line">            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">è¾“å…¥ Tile:  â”‚ r ä¸ªå…ƒç´        â”‚ BLOCK_SIZE ä¸ªå…ƒç´         â”‚ r ä¸ªå…ƒç´        â”‚</span><br><span class="line">            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">                    â†‘                                           â†‘</span><br><span class="line">                å·¦ Halo                                      å³ Halo</span><br></pre></td></tr></table></figure><p>Halo å…ƒç´ æ˜¯ç›¸é‚» Block è¾¹ç•Œçš„é‡å éƒ¨åˆ†ï¼Œä¹Ÿå« <strong>Ghost Cells</strong>ã€‚</p><h3 id="shi-xian-ce-lue" tabindex="-1" id="å®ç°ç­–ç•¥">å®ç°ç­–ç•¥</h3><p>æœ‰ä¸¤ç§åŠ è½½æ–¹å¼ï¼š</p><p><strong>ç­–ç•¥ 1ï¼šç»Ÿä¸€åŠ è½½</strong></p><p>æ‰€æœ‰å…ƒç´ ç”± BLOCK_SIZE ä¸ªçº¿ç¨‹åˆ†å·¥åŠ è½½ï¼Œæ¯çº¿ç¨‹å¯èƒ½åŠ è½½å¤šä¸ªå…ƒç´ ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">__shared__ float tile[BLOCK_SIZE + 2 * MAX_R];</span><br><span class="line"></span><br><span class="line">int tile_size = BLOCK_SIZE + 2 * r;</span><br><span class="line">int loads_per_thread = (tile_size + BLOCK_SIZE - 1) / BLOCK_SIZE;</span><br><span class="line"></span><br><span class="line">for (int i = 0; i &lt; loads_per_thread; i++) &#123;</span><br><span class="line">    int tile_idx = threadIdx.x + i * BLOCK_SIZE;</span><br><span class="line">    if (tile_idx &lt; tile_size) &#123;</span><br><span class="line">        int global_idx = block_start - r + tile_idx;</span><br><span class="line">        tile[tile_idx] = (global_idx &gt;= 0 &amp;&amp; global_idx &lt; n) ? </span><br><span class="line">                          input[global_idx] : 0.0f;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç­–ç•¥ 2ï¼šåˆ†åŒºåŠ è½½ï¼ˆæ›´é«˜æ•ˆï¼‰</strong></p><p>å·¦ Haloã€ä¸»ä½“ã€å³ Halo åˆ†åˆ«ç”±ä¸åŒçº¿ç¨‹åŠ è½½ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">__shared__ float tile[BLOCK_SIZE + 2 * MAX_R];</span><br><span class="line"></span><br><span class="line">int halo_left = r;</span><br><span class="line">int block_start = blockIdx.x * BLOCK_SIZE;</span><br><span class="line"></span><br><span class="line">// å·¦ Haloï¼šå‰ r ä¸ªçº¿ç¨‹è´Ÿè´£</span><br><span class="line">if (threadIdx.x &lt; r) &#123;</span><br><span class="line">    int idx = block_start - r + threadIdx.x;</span><br><span class="line">    tile[threadIdx.x] = (idx &gt;= 0) ? input[idx] : 0.0f;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// ä¸»ä½“ï¼šæ‰€æœ‰çº¿ç¨‹å„è´Ÿè´£ä¸€ä¸ª</span><br><span class="line">int main_idx = block_start + threadIdx.x;</span><br><span class="line">tile[r + threadIdx.x] = (main_idx &lt; n) ? input[main_idx] : 0.0f;</span><br><span class="line"></span><br><span class="line">// å³ Haloï¼šå‰ r ä¸ªçº¿ç¨‹è´Ÿè´£</span><br><span class="line">if (threadIdx.x &lt; r) &#123;</span><br><span class="line">    int idx = block_start + BLOCK_SIZE + threadIdx.x;</span><br><span class="line">    tile[BLOCK_SIZE + r + threadIdx.x] = (idx &lt; n) ? input[idx] : 0.0f;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__syncthreads();</span><br></pre></td></tr></table></figure><h3 id="wan-zheng-de-tiled-1-d-juan-ji" tabindex="-1" id="å®Œæ•´çš„-Tiled-1D-å·ç§¯">å®Œæ•´çš„ Tiled 1D å·ç§¯</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">#define BLOCK_SIZE 256</span><br><span class="line">#define MAX_R 512</span><br><span class="line"></span><br><span class="line">__constant__ float d_kernel[2 * MAX_R + 1];</span><br><span class="line"></span><br><span class="line">__global__ void conv1d_tiled(float *input, float *output, </span><br><span class="line">                              int n, int r) &#123;</span><br><span class="line">    // å…±äº«å†…å­˜ Tile</span><br><span class="line">    __shared__ float tile[BLOCK_SIZE + 2 * MAX_R];</span><br><span class="line">    </span><br><span class="line">    int block_start = blockIdx.x * BLOCK_SIZE;</span><br><span class="line">    int global_idx = block_start + threadIdx.x;</span><br><span class="line">    </span><br><span class="line">    // ========== åä½œåŠ è½½ ==========</span><br><span class="line">    </span><br><span class="line">    // å·¦ Halo</span><br><span class="line">    if (threadIdx.x &lt; r) &#123;</span><br><span class="line">        int idx = block_start - r + threadIdx.x;</span><br><span class="line">        tile[threadIdx.x] = (idx &gt;= 0) ? input[idx] : 0.0f;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // ä¸»ä½“å…ƒç´ </span><br><span class="line">    tile[r + threadIdx.x] = (global_idx &lt; n) ? input[global_idx] : 0.0f;</span><br><span class="line">    </span><br><span class="line">    // å³ Halo</span><br><span class="line">    if (threadIdx.x &lt; r) &#123;</span><br><span class="line">        int idx = block_start + BLOCK_SIZE + threadIdx.x;</span><br><span class="line">        tile[BLOCK_SIZE + r + threadIdx.x] = (idx &lt; n) ? input[idx] : 0.0f;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    __syncthreads();</span><br><span class="line">    </span><br><span class="line">    // ========== è®¡ç®—å·ç§¯ ==========</span><br><span class="line">    </span><br><span class="line">    if (global_idx &lt; n) &#123;</span><br><span class="line">        float sum = 0.0f;</span><br><span class="line">        for (int j = 0; j &lt; 2 * r + 1; j++) &#123;</span><br><span class="line">            sum += tile[threadIdx.x + j] * d_kernel[j];</span><br><span class="line">        &#125;</span><br><span class="line">        output[global_idx] = sum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="xing-neng-fen-xi" tabindex="-1" id="æ€§èƒ½åˆ†æ">æ€§èƒ½åˆ†æ</h3><p><strong>å…¨å±€å†…å­˜è®¿é—®</strong>ï¼š</p><table><thead><tr><th>ç‰ˆæœ¬</th><th>æ¯å…ƒç´ è¯»å–æ¬¡æ•°</th><th>æ€»è¯»å–é‡</th></tr></thead><tbody><tr><td>æœ´ç´ </td><td>2r + 1</td><td>N Ã— (2r + 1)</td></tr><tr><td>Tiled</td><td>1 + 2r/BLOCK_SIZE</td><td>N Ã— (1 + 2r/B)</td></tr></tbody></table><p>å½“ BLOCK_SIZE = 256, r = 5 æ—¶ï¼š</p><ul><li>æœ´ç´ ï¼šæ¯å…ƒç´  11 æ¬¡</li><li>Tiledï¼šæ¯å…ƒç´  1.04 æ¬¡</li></ul><p>å…¨å±€å†…å­˜è®¿é—®å‡å°‘çº¦ <strong>10 å€</strong>ï¼</p><h2 id="2-d-juan-ji" tabindex="-1" id="2D-å·ç§¯">2D å·ç§¯</h2><h3 id="kuo-zhan-dao-er-wei" tabindex="-1" id="æ‰©å±•åˆ°äºŒç»´">æ‰©å±•åˆ°äºŒç»´</h3><p>2D å·ç§¯æ›´å¸¸è§ï¼Œæ€è·¯ç±»ä¼¼ä½†æ›´å¤æ‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ Tile å¤§å°ï¼š(BLOCK_Y + 2ry) Ã— (BLOCK_X + 2rx)</span><br><span class="line">Halo å…ƒç´ åœ¨å››ä¸ªè¾¹å’Œå››ä¸ªè§’</span><br></pre></td></tr></table></figure><h3 id="2-d-tile-jie-gou" tabindex="-1" id="2D-Tile-ç»“æ„">2D Tile ç»“æ„</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚  å·¦ä¸Šè§’     â”‚        ä¸Š Halo            â”‚  å³ä¸Šè§’     â”‚</span><br><span class="line">â”‚  (ryÃ—rx)    â”‚      (ryÃ—BLOCK_X)         â”‚  (ryÃ—rx)    â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚             â”‚                           â”‚             â”‚</span><br><span class="line">â”‚  å·¦ Halo    â”‚       ä¸»ä½“                â”‚  å³ Halo    â”‚</span><br><span class="line">â”‚ (BLOCK_YÃ—rx)â”‚   (BLOCK_YÃ—BLOCK_X)       â”‚(BLOCK_YÃ—rx) â”‚</span><br><span class="line">â”‚             â”‚                           â”‚             â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚  å·¦ä¸‹è§’     â”‚        ä¸‹ Halo            â”‚  å³ä¸‹è§’     â”‚</span><br><span class="line">â”‚  (ryÃ—rx)    â”‚      (ryÃ—BLOCK_X)         â”‚  (ryÃ—rx)    â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure><h3 id="jian-hua-de-2-d-shi-xian" tabindex="-1" id="ç®€åŒ–çš„-2D-å®ç°">ç®€åŒ–çš„ 2D å®ç°</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">#define TILE_X 16</span><br><span class="line">#define TILE_Y 16</span><br><span class="line">#define R 1  // 3Ã—3 å·ç§¯æ ¸çš„åŠå¾„</span><br><span class="line"></span><br><span class="line">__constant__ float d_kernel2d[(2*R+1) * (2*R+1)];</span><br><span class="line"></span><br><span class="line">__global__ void conv2d_tiled(float *input, float *output,</span><br><span class="line">                              int width, int height) &#123;</span><br><span class="line">    // å…±äº«å†…å­˜</span><br><span class="line">    __shared__ float tile[TILE_Y + 2*R][TILE_X + 2*R];</span><br><span class="line">    </span><br><span class="line">    int tx = threadIdx.x, ty = threadIdx.y;</span><br><span class="line">    int bx = blockIdx.x * TILE_X, by = blockIdx.y * TILE_Y;</span><br><span class="line">    int gx = bx + tx, gy = by + ty;</span><br><span class="line">    </span><br><span class="line">    // ========== åŠ è½½ä¸»ä½“ ==========</span><br><span class="line">    int tile_x = tx + R, tile_y = ty + R;</span><br><span class="line">    tile[tile_y][tile_x] = (gx &lt; width &amp;&amp; gy &lt; height) ? </span><br><span class="line">                            input[gy * width + gx] : 0.0f;</span><br><span class="line">    </span><br><span class="line">    // ========== åŠ è½½ Haloï¼ˆè¾¹ç•Œçº¿ç¨‹è´Ÿè´£ï¼‰==========</span><br><span class="line">    </span><br><span class="line">    // ä¸Šè¾¹ç•Œ</span><br><span class="line">    if (ty &lt; R) &#123;</span><br><span class="line">        int src_y = gy - R;</span><br><span class="line">        tile[ty][tile_x] = (gx &lt; width &amp;&amp; src_y &gt;= 0) ? </span><br><span class="line">                            input[src_y * width + gx] : 0.0f;</span><br><span class="line">    &#125;</span><br><span class="line">    // ä¸‹è¾¹ç•Œ</span><br><span class="line">    if (ty &gt;= TILE_Y - R) &#123;</span><br><span class="line">        int src_y = gy + R;</span><br><span class="line">        tile[tile_y + R][tile_x] = (gx &lt; width &amp;&amp; src_y &lt; height) ? </span><br><span class="line">                                    input[src_y * width + gx] : 0.0f;</span><br><span class="line">    &#125;</span><br><span class="line">    // å·¦è¾¹ç•Œ</span><br><span class="line">    if (tx &lt; R) &#123;</span><br><span class="line">        int src_x = gx - R;</span><br><span class="line">        tile[tile_y][tx] = (src_x &gt;= 0 &amp;&amp; gy &lt; height) ? </span><br><span class="line">                            input[gy * width + src_x] : 0.0f;</span><br><span class="line">    &#125;</span><br><span class="line">    // å³è¾¹ç•Œ</span><br><span class="line">    if (tx &gt;= TILE_X - R) &#123;</span><br><span class="line">        int src_x = gx + R;</span><br><span class="line">        tile[tile_y][tile_x + R] = (src_x &lt; width &amp;&amp; gy &lt; height) ? </span><br><span class="line">                                    input[gy * width + src_x] : 0.0f;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // å››ä¸ªè§’ï¼ˆè§’è½çº¿ç¨‹è´Ÿè´£ï¼‰</span><br><span class="line">    if (tx &lt; R &amp;&amp; ty &lt; R) &#123;  // å·¦ä¸Š</span><br><span class="line">        int sx = gx - R, sy = gy - R;</span><br><span class="line">        tile[ty][tx] = (sx &gt;= 0 &amp;&amp; sy &gt;= 0) ? input[sy * width + sx] : 0.0f;</span><br><span class="line">    &#125;</span><br><span class="line">    if (tx &gt;= TILE_X - R &amp;&amp; ty &lt; R) &#123;  // å³ä¸Š</span><br><span class="line">        int sx = gx + R, sy = gy - R;</span><br><span class="line">        tile[ty][tile_x + R] = (sx &lt; width &amp;&amp; sy &gt;= 0) ? </span><br><span class="line">                                input[sy * width + sx] : 0.0f;</span><br><span class="line">    &#125;</span><br><span class="line">    if (tx &lt; R &amp;&amp; ty &gt;= TILE_Y - R) &#123;  // å·¦ä¸‹</span><br><span class="line">        int sx = gx - R, sy = gy + R;</span><br><span class="line">        tile[tile_y + R][tx] = (sx &gt;= 0 &amp;&amp; sy &lt; height) ? </span><br><span class="line">                                input[sy * width + sx] : 0.0f;</span><br><span class="line">    &#125;</span><br><span class="line">    if (tx &gt;= TILE_X - R &amp;&amp; ty &gt;= TILE_Y - R) &#123;  // å³ä¸‹</span><br><span class="line">        int sx = gx + R, sy = gy + R;</span><br><span class="line">        tile[tile_y + R][tile_x + R] = (sx &lt; width &amp;&amp; sy &lt; height) ?</span><br><span class="line">                                        input[sy * width + sx] : 0.0f;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    __syncthreads();</span><br><span class="line">    </span><br><span class="line">    // ========== è®¡ç®—å·ç§¯ ==========</span><br><span class="line">    if (gx &lt; width &amp;&amp; gy &lt; height) &#123;</span><br><span class="line">        float sum = 0.0f;</span><br><span class="line">        for (int dy = -R; dy &lt;= R; dy++) &#123;</span><br><span class="line">            for (int dx = -R; dx &lt;= R; dx++) &#123;</span><br><span class="line">                sum += tile[ty + R + dy][tx + R + dx] * </span><br><span class="line">                       d_kernel2d[(dy + R) * (2*R + 1) + (dx + R)];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        output[gy * width + gx] = sum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="qi-dong-pei-zhi" tabindex="-1" id="å¯åŠ¨é…ç½®">å¯åŠ¨é…ç½®</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dim3 block(TILE_X, TILE_Y);  // 16Ã—16 = 256 çº¿ç¨‹</span><br><span class="line">dim3 grid((width + TILE_X - 1) / TILE_X, </span><br><span class="line">          (height + TILE_Y - 1) / TILE_Y);</span><br><span class="line"></span><br><span class="line">conv2d_tiled&lt;&lt;&lt;grid, block&gt;&gt;&gt;(d_input, d_output, width, height);</span><br></pre></td></tr></table></figure><h2 id="huan-cun-ji-zhi" tabindex="-1" id="ç¼“å­˜æœºåˆ¶">ç¼“å­˜æœºåˆ¶</h2><h3 id="l-1-l-2-huan-cun-yu-tiling-de-guan-xi" tabindex="-1" id="L1-L2-ç¼“å­˜ä¸-Tiling-çš„å…³ç³»">L1/L2 ç¼“å­˜ä¸ Tiling çš„å…³ç³»</h3><p>å‰é¢æˆ‘ä»¬æ‰‹åŠ¨ç”¨å…±äº«å†…å­˜å®ç°äº† Tilingã€‚ä½† GPU è¿˜æœ‰è‡ªåŠ¨çš„ç¼“å­˜æœºåˆ¶ï¼š</p><p><strong>L1 ç¼“å­˜</strong>ï¼ˆæ¯ SMï¼‰ï¼š</p><ul><li>Ampere æ¶æ„ï¼š128 KBï¼ˆå¯é…ç½®ä¸å…±äº«å†…å­˜åˆ†å‰²ï¼‰</li><li>è‡ªåŠ¨ç¼“å­˜å…¨å±€å†…å­˜è®¿é—®</li><li>å¯¹äºå°å·ç§¯æ ¸ï¼Œå¯èƒ½&quot;å…è´¹&quot;è·å¾—æ•°æ®å¤ç”¨</li></ul><p><strong>L2 ç¼“å­˜</strong>ï¼ˆå…¨å±€å…±äº«ï¼‰ï¼š</p><ul><li>å‡  MB å®¹é‡</li><li>æ‰€æœ‰ SM å…±äº«</li><li>è·¨ Block çš„æ•°æ®è®¿é—®å¯èƒ½å‘½ä¸­</li></ul><h3 id="he-shi-yi-lai-huan-cun-vs-xian-shi-tiling" tabindex="-1" id="ä½•æ—¶ä¾èµ–ç¼“å­˜-vs-æ˜¾å¼-Tiling">ä½•æ—¶ä¾èµ–ç¼“å­˜ vs æ˜¾å¼ Tiling</h3><table><thead><tr><th>åœºæ™¯</th><th>æ¨èæ–¹å¼</th><th>åŸå› </th></tr></thead><tbody><tr><td>å°å·ç§¯æ ¸ï¼ˆ3Ã—3ï¼‰</td><td>å¯èƒ½åªç”¨ç¼“å­˜</td><td>L1 å¤Ÿç”¨ï¼Œä»£ç ç®€å•</td></tr><tr><td>å¤§å·ç§¯æ ¸ï¼ˆ11Ã—11+ï¼‰</td><td>æ˜¾å¼ Tiling</td><td>æ•°æ®é‡å¤§ï¼Œéœ€ç²¾ç¡®æ§åˆ¶</td></tr><tr><td>å¤§å›¾åƒã€å° kernel</td><td>æ˜¾å¼ Tiling</td><td>æœ€å¤§åŒ–å†…å­˜å¸¦å®½åˆ©ç”¨</td></tr><tr><td>è°ƒè¯•/åŸå‹</td><td>å…ˆç”¨ç¼“å­˜</td><td>å¿«é€ŸéªŒè¯æ­£ç¡®æ€§</td></tr></tbody></table><h3 id="xian-dai-gpu-de-you-hua-jian-yi" tabindex="-1" id="ç°ä»£-GPU-çš„ä¼˜åŒ–å»ºè®®">ç°ä»£ GPU çš„ä¼˜åŒ–å»ºè®®</h3><ol><li><strong>å…ˆå†™ç®€å•ç‰ˆæœ¬</strong>ï¼Œä¾èµ– L1/L2 ç¼“å­˜</li><li><strong>ç”¨ Nsight Compute åˆ†æ</strong>ï¼Œçœ‹å†…å­˜ååæ˜¯å¦æˆä¸ºç“¶é¢ˆ</li><li><strong>å¦‚æœå—é™äºå†…å­˜å¸¦å®½</strong>ï¼Œå†æ·»åŠ å…±äº«å†…å­˜ Tiling</li><li><strong>å¸¸é‡å†…å­˜å§‹ç»ˆæ˜¯å¥½é€‰æ‹©</strong>ï¼ˆå¯¹äºå·ç§¯æ ¸ï¼‰</li></ol><h2 id="juan-ji-you-hua-zong-jie" tabindex="-1" id="å·ç§¯ä¼˜åŒ–æ€»ç»“">å·ç§¯ä¼˜åŒ–æ€»ç»“</h2><h3 id="you-hua-shou-duan-ceng-ci" tabindex="-1" id="ä¼˜åŒ–æ‰‹æ®µå±‚æ¬¡">ä¼˜åŒ–æ‰‹æ®µå±‚æ¬¡</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ Level 4: ç®—æ³•çº§ä¼˜åŒ–                                              â”‚</span><br><span class="line">â”‚   - FFT å·ç§¯ï¼ˆå¤§å·ç§¯æ ¸ï¼‰                                          â”‚</span><br><span class="line">â”‚   - Winograd ç®—æ³•ï¼ˆç‰¹å®šå°ºå¯¸ï¼‰                                     â”‚</span><br><span class="line">â”‚   - Im2col + GEMMï¼ˆcuDNN æ–¹å¼ï¼‰                                   â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚ Level 3: æ•°æ®å¤ç”¨                                                 â”‚</span><br><span class="line">â”‚   - å…±äº«å†…å­˜ Tiling                                               â”‚</span><br><span class="line">â”‚   - å¸¸é‡å†…å­˜å­˜å‚¨å·ç§¯æ ¸                                            â”‚</span><br><span class="line">â”‚   - å¯„å­˜å™¨ç¼“å­˜å±€éƒ¨ç»“æœ                                            â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚ Level 2: å†…å­˜è®¿é—®æ¨¡å¼                                             â”‚</span><br><span class="line">â”‚   - åˆå¹¶è®¿é—®å…¨å±€å†…å­˜                                              â”‚</span><br><span class="line">â”‚   - é¿å… Bank å†²çª                                                â”‚</span><br><span class="line">â”‚   - é¢„å–å’ŒåŒç¼“å†²                                                  â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚ Level 1: åŸºç¡€æ­£ç¡®å®ç°                                             â”‚</span><br><span class="line">â”‚   - è¾¹ç•Œæ£€æŸ¥                                                      â”‚</span><br><span class="line">â”‚   - æ­£ç¡®çš„ç´¢å¼•è®¡ç®—                                                 â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure><h3 id="xuan-ze-ce-lue" tabindex="-1" id="é€‰æ‹©ç­–ç•¥">é€‰æ‹©ç­–ç•¥</h3><table><thead><tr><th>å·ç§¯æ ¸å¤§å°</th><th>æ¨èæ–¹æ³•</th></tr></thead><tbody><tr><td>3Ã—3</td><td>Tiled + å¸¸é‡å†…å­˜</td></tr><tr><td>5Ã—5 ~ 11Ã—11</td><td>Tiled + å¸¸é‡å†…å­˜</td></tr><tr><td>å¤§äº 11Ã—11</td><td>è€ƒè™‘ FFT æˆ– cuDNN</td></tr></tbody></table><h3 id="cu-dnn-gong-ye-ji-xuan-ze" tabindex="-1" id="cuDNNï¼šå·¥ä¸šçº§é€‰æ‹©">cuDNNï¼šå·¥ä¸šçº§é€‰æ‹©</h3><p>å®é™…ç”Ÿäº§ä¸­ï¼Œå·ç§¯é€šå¸¸ç”¨ cuDNNï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cudnnConvolutionForward</span>(handle,</span><br><span class="line">    &amp;alpha,</span><br><span class="line">    inputDesc, d_input,</span><br><span class="line">    filterDesc, d_filter,</span><br><span class="line">    convDesc,</span><br><span class="line">    algo,  <span class="comment">// è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜ç®—æ³•</span></span><br><span class="line">    workspace, workspaceSize,</span><br><span class="line">    &amp;beta,</span><br><span class="line">    outputDesc, d_output);</span><br></pre></td></tr></table></figure><p>cuDNN ä¼šæ ¹æ®è¾“å…¥å°ºå¯¸ã€å·ç§¯æ ¸å¤§å°ã€GPU æ¶æ„ï¼Œè‡ªåŠ¨é€‰æ‹©æœ€ä¼˜å®ç°ï¼ˆç›´æ¥å·ç§¯ã€FFTã€Winogradã€Im2col+GEMM ç­‰ï¼‰ã€‚</p><p>ä½†ç†è§£åº•å±‚åŸç†ä»ç„¶é‡è¦â€”â€”çŸ¥é“ cuDNN åœ¨åšä»€ä¹ˆï¼Œæ‰èƒ½æ­£ç¡®è°ƒç”¨å’Œè°ƒä¼˜ã€‚</p><h2 id="shi-zhan-tu-xiang-rui-hua" tabindex="-1" id="å®æˆ˜ï¼šå›¾åƒé”åŒ–">å®æˆ˜ï¼šå›¾åƒé”åŒ–</h2><h3 id="rui-hua-juan-ji-he" tabindex="-1" id="é”åŒ–å·ç§¯æ ¸">é”åŒ–å·ç§¯æ ¸</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚  0  â”‚ -1  â”‚  0  â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚ -1  â”‚  5  â”‚ -1  â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚  0  â”‚ -1  â”‚  0  â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure><h3 id="wan-zheng-shi-li" tabindex="-1" id="å®Œæ•´ç¤ºä¾‹">å®Œæ•´ç¤ºä¾‹</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;cuda_runtime.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line"></span><br><span class="line">#define TILE_SIZE 16</span><br><span class="line">#define R 1</span><br><span class="line"></span><br><span class="line">__constant__ float d_sharpen_kernel[9] = &#123;</span><br><span class="line">    0, -1,  0,</span><br><span class="line">   -1,  5, -1,</span><br><span class="line">    0, -1,  0</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">__global__ void sharpen_image(unsigned char *input, unsigned char *output,</span><br><span class="line">                               int width, int height) &#123;</span><br><span class="line">    __shared__ float tile[TILE_SIZE + 2][TILE_SIZE + 2];</span><br><span class="line">    </span><br><span class="line">    int tx = threadIdx.x, ty = threadIdx.y;</span><br><span class="line">    int gx = blockIdx.x * TILE_SIZE + tx;</span><br><span class="line">    int gy = blockIdx.y * TILE_SIZE + ty;</span><br><span class="line">    </span><br><span class="line">    // åŠ è½½ï¼ˆç®€åŒ–ç‰ˆï¼Œå‡è®¾è¾¹ç•Œå†…ï¼‰</span><br><span class="line">    if (gx &lt; width &amp;&amp; gy &lt; height) &#123;</span><br><span class="line">        tile[ty + 1][tx + 1] = (float)input[gy * width + gx];</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        tile[ty + 1][tx + 1] = 0.0f;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // åŠ è½½ Haloï¼ˆç®€åŒ–ï¼Œä»…ç¤ºæ„ï¼‰</span><br><span class="line">    if (tx == 0 &amp;&amp; gx &gt; 0) </span><br><span class="line">        tile[ty + 1][0] = input[gy * width + gx - 1];</span><br><span class="line">    if (tx == TILE_SIZE - 1 &amp;&amp; gx &lt; width - 1) </span><br><span class="line">        tile[ty + 1][TILE_SIZE + 1] = input[gy * width + gx + 1];</span><br><span class="line">    if (ty == 0 &amp;&amp; gy &gt; 0) </span><br><span class="line">        tile[0][tx + 1] = input[(gy - 1) * width + gx];</span><br><span class="line">    if (ty == TILE_SIZE - 1 &amp;&amp; gy &lt; height - 1) </span><br><span class="line">        tile[TILE_SIZE + 1][tx + 1] = input[(gy + 1) * width + gx];</span><br><span class="line">    </span><br><span class="line">    // è§’è½å¤„ç†çœç•¥...</span><br><span class="line">    </span><br><span class="line">    __syncthreads();</span><br><span class="line">    </span><br><span class="line">    // å·ç§¯è®¡ç®—</span><br><span class="line">    if (gx &lt; width &amp;&amp; gy &lt; height) &#123;</span><br><span class="line">        float sum = 0.0f;</span><br><span class="line">        for (int dy = -1; dy &lt;= 1; dy++) &#123;</span><br><span class="line">            for (int dx = -1; dx &lt;= 1; dx++) &#123;</span><br><span class="line">                sum += tile[ty + 1 + dy][tx + 1 + dx] * </span><br><span class="line">                       d_sharpen_kernel[(dy + 1) * 3 + (dx + 1)];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        // é’³åˆ¶åˆ° [0, 255]</span><br><span class="line">        sum = fminf(fmaxf(sum, 0.0f), 255.0f);</span><br><span class="line">        output[gy * width + gx] = (unsigned char)sum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="1-d-vs-2-d-juan-ji-de-ke-fen-chi-xing" tabindex="-1" id="1D-vs-2D-å·ç§¯çš„å¯åˆ†ç¦»æ€§">1D vs 2D å·ç§¯çš„å¯åˆ†ç¦»æ€§</h2><h3 id="ke-fen-chi-juan-ji" tabindex="-1" id="å¯åˆ†ç¦»å·ç§¯">å¯åˆ†ç¦»å·ç§¯</h3><p>æœ‰äº› 2D å·ç§¯æ ¸å¯ä»¥åˆ†è§£ä¸ºä¸¤ä¸ª 1D å·ç§¯æ ¸çš„å¤–ç§¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">                       â”Œâ”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚ 1 â”‚   â”‚             â”‚</span><br><span class="line">â”‚ 1  4  6  4  1 â”‚      â”‚ 4 â”‚ Ã— â”‚ 1 4 6 4 1   â”‚</span><br><span class="line">â”‚ 4 16 24 16 4 â”‚  =    â”‚ 6 â”‚   â”‚             â”‚</span><br><span class="line">â”‚ 6 24 36 24 6 â”‚       â”‚ 4 â”‚   â”‚             â”‚</span><br><span class="line">â”‚ 4 16 24 16 4 â”‚       â”‚ 1 â”‚   â”‚             â”‚</span><br><span class="line">â”‚ 1  4  6  4  1 â”‚      â””â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        å‚ç›´ 1D     æ°´å¹³ 1D</span><br><span class="line">   5Ã—5 é«˜æ–¯</span><br></pre></td></tr></table></figure><h3 id="ke-fen-chi-juan-ji-de-you-shi" tabindex="-1" id="å¯åˆ†ç¦»å·ç§¯çš„ä¼˜åŠ¿">å¯åˆ†ç¦»å·ç§¯çš„ä¼˜åŠ¿</h3><p>åŸå§‹ 2Dï¼šæ¯åƒç´  5Ã—5 = 25 æ¬¡ä¹˜æ³•<br>å¯åˆ†ç¦»ï¼šæ¯åƒç´  5 + 5 = 10 æ¬¡ä¹˜æ³•</p><p><strong>è®¡ç®—é‡å‡å°‘ 60%ï¼</strong></p><h3 id="cuda-shi-xian-si-lu" tabindex="-1" id="CUDA-å®ç°æ€è·¯">CUDA å®ç°æ€è·¯</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// ç¬¬ä¸€æ­¥ï¼šæ°´å¹³å·ç§¯ï¼ˆæ¯è¡Œï¼‰</span><br><span class="line">conv1d_horizontal&lt;&lt;&lt;gridH, blockH&gt;&gt;&gt;(input, temp, width, height, kernel_h);</span><br><span class="line"></span><br><span class="line">// ç¬¬äºŒæ­¥ï¼šå‚ç›´å·ç§¯ï¼ˆæ¯åˆ—ï¼‰</span><br><span class="line">conv1d_vertical&lt;&lt;&lt;gridV, blockV&gt;&gt;&gt;(temp, output, width, height, kernel_v);</span><br></pre></td></tr></table></figure><p>å¸¸è§çš„é«˜æ–¯æ¨¡ç³Šã€ç›’çŠ¶æ¨¡ç³Šéƒ½æ˜¯å¯åˆ†ç¦»çš„ï¼Œè¿™æ˜¯å®é™…ä¼˜åŒ–ä¸­çš„é‡è¦æŠ€å·§ã€‚</p><h2 id="xiao-jie" tabindex="-1" id="å°ç»“">å°ç»“</h2><p>ç¬¬ä¸ƒç« å›´ç»•å·ç§¯ï¼Œæ•´åˆäº†å¤šé¡¹å†…å­˜ä¼˜åŒ–æŠ€æœ¯ï¼š</p><p><strong>å¸¸é‡å†…å­˜</strong>ï¼šå·ç§¯æ ¸å¯¹æ‰€æœ‰çº¿ç¨‹ç›¸åŒï¼Œæ”¾å¸¸é‡å†…å­˜æ˜¯è‡ªç„¶é€‰æ‹©ã€‚å¹¿æ’­è®¿é—®è®©å¸¦å®½æ¶ˆè€—è¶‹è¿‘äºé›¶ã€‚</p><p><strong>Tiled å…±äº«å†…å­˜</strong>ï¼šè¾“å…¥æ•°æ®æœ‰å¤§é‡é‡å è®¿é—®ã€‚ç”¨å…±äº«å†…å­˜ç¼“å­˜ Tileï¼Œå…¨å±€å†…å­˜è®¿é—®é™ä½åˆ°æ¥è¿‘ 1 æ¬¡/å…ƒç´ ã€‚</p><p><strong>Halo å¤„ç†</strong>ï¼š2D Tiling çš„å…³é”®éš¾ç‚¹ã€‚è¾¹ç•Œã€è§’è½éœ€è¦ç»†å¿ƒå¤„ç†ã€‚å»ºè®®åˆ†åŒºåŠ è½½â€”â€”ä¸åŒåŒºåŸŸç”±ä¸åŒçº¿ç¨‹è´Ÿè´£ã€‚</p><p><strong>ç¼“å­˜åˆ©ç”¨</strong>ï¼šç°ä»£ GPU çš„ L1/L2 ç¼“å­˜èƒ½è‡ªåŠ¨è¦†ç›–éƒ¨åˆ†æ•°æ®å¤ç”¨ã€‚å°å·ç§¯æ ¸ã€è°ƒè¯•é˜¶æ®µå¯ä»¥ä¾èµ–ç¼“å­˜ï¼Œæ­£å¼ä¼˜åŒ–å†åŠ  Tilingã€‚</p><p><strong>å¯åˆ†ç¦»å·ç§¯</strong>ï¼šé«˜æ–¯ç­‰å¯åˆ†ç¦»æ ¸ï¼Œåˆ†è§£æˆä¸¤æ¬¡ 1D å·ç§¯ï¼Œè®¡ç®—é‡ç›´æ¥å‡åŠã€‚</p><p>å·ç§¯æ˜¯æ·±åº¦å­¦ä¹ å’Œå›¾åƒå¤„ç†çš„æ ¸å¿ƒç®—å­ï¼Œä¼˜åŒ–å·ç§¯çš„æ€è·¯â€”â€”å¸¸é‡å†…å­˜ã€Tilingã€Halo å¤„ç†â€”â€”é€‚ç”¨äºå¾ˆå¤šç›¸ä¼¼çš„æ¨¡æ¿è®¡ç®—æ¨¡å¼ã€‚ä¸‹ä¸€ç« ä¼šå­¦ä¹ å¦ä¸€ä¸ªé‡è¦æ¨¡å¼â€”â€”Stencilï¼ˆæ¨¡æ¿è®¡ç®—ï¼‰ï¼Œæ€è·¯ç±»ä¼¼ä½†æœ‰è‡ªå·±çš„ç‰¹ç‚¹ã€‚</p><hr><p><strong>å‚è€ƒèµ„æ–™ï¼š</strong></p><ul><li>Hwu, W., Kirk, D., &amp; El Hajj, I. (2022). <em>Programming Massively Parallel Processors: A Hands-on Approach</em> (4th Edition). Morgan Kaufmann.</li><li><a href="https://docs.nvidia.com/cuda/cuda-c-programming-guide/index.html#constant-memory">CUDA C++ Programming Guide - Constant Memory</a></li><li><a href="https://docs.nvidia.com/deeplearning/cudnn/developer-guide/index.html">cuDNN Developer Guide</a></li></ul><hr><blockquote><p><strong>æœ¬æ–‡ GitHub ä»“åº“</strong>: <a href="https://github.com/psmarter/PMPP-Learning">https://github.com/psmarter/PMPP-Learning</a></p></blockquote>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;qian-yan&quot; tabindex=&quot;-1&quot;</summary>
        
      
    
    
    
    <category term="çŸ¥è¯†åˆ†äº«" scheme="https://smarter.xin/categories/knowledge-sharing/"/>
    
    
    <category term="CUDA" scheme="https://smarter.xin/tags/CUDA/"/>
    
    <category term="GPUç¼–ç¨‹" scheme="https://smarter.xin/tags/gpu-programming/"/>
    
    <category term="å¹¶è¡Œè®¡ç®—" scheme="https://smarter.xin/tags/parallel-computing/"/>
    
    <category term="PMPP" scheme="https://smarter.xin/tags/PMPP/"/>
    
    <category term="å·ç§¯" scheme="https://smarter.xin/tags/convolution/"/>
    
    <category term="å¸¸é‡å†…å­˜" scheme="https://smarter.xin/tags/constant-memory/"/>
    
    <category term="Tiling" scheme="https://smarter.xin/tags/Tiling/"/>
    
  </entry>
  
  <entry>
    <title>PMPP-ç¬¬å…­ç« ï¼šæ€§èƒ½æ–¹é¢çš„è€ƒè™‘</title>
    <link href="https://smarter.xin/posts/220818c3/"/>
    <id>https://smarter.xin/posts/220818c3/</id>
    <published>2026-01-16T09:11:58.000Z</published>
    <updated>2026-01-24T08:26:21.332Z</updated>
    
    <content type="html"><![CDATA[<h2 id="qian-yan" tabindex="-1" id="å‰è¨€">å‰è¨€</h2><p>ç¬¬äº”ç« å­¦äº†å†…å­˜å±‚æ¬¡å’Œ Tiling æŠ€æœ¯ï¼ŒçŸ©é˜µä¹˜æ³•æ€§èƒ½æå‡äº† 10 å€ã€‚ä½†è¿™åªæ˜¯å¼€å§‹â€”â€”å®é™…ä¼˜åŒ–ä¸­è¿˜æœ‰å¾ˆå¤šç»†èŠ‚ä¼šå½±å“æ€§èƒ½ã€‚ç¬¬å…­ç« ç³»ç»Ÿæ¢³ç†è¿™äº›æ€§èƒ½å› ç´ ï¼šå†…å­˜åˆå¹¶ã€åˆ†æ”¯å‘æ•£ã€èµ„æºåˆ†é…ã€æŒ‡ä»¤æ··åˆç­‰ã€‚è¿™ç« å†…å®¹å&quot;å·¥ç¨‹å®è·µ&quot;ï¼ŒæŒæ¡è¿™äº›æŠ€å·§ï¼Œèƒ½è®©ä»£ç å†å¿«ä¸€å€ã€‚</p><blockquote><p><strong>ğŸ“¦ é…å¥—èµ„æº</strong>ï¼šæœ¬ç³»åˆ—æ–‡ç« é…æœ‰å®Œæ•´çš„ <a href="https://github.com/psmarter/PMPP-Learning">GitHub ä»“åº“</a>ï¼ŒåŒ…å«æ¯ç« çš„ç»ƒä¹ é¢˜è§£ç­”ã€CUDA ä»£ç å®ç°å’Œè¯¦ç»†æ³¨é‡Šã€‚æ‰€æœ‰ä»£ç éƒ½ç»è¿‡æµ‹è¯•ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œã€‚</p></blockquote><h2 id="nei-cun-he-bing-memory-coalescing" tabindex="-1" id="å†…å­˜åˆå¹¶ï¼ˆMemory-Coalescingï¼‰">å†…å­˜åˆå¹¶ï¼ˆMemory Coalescingï¼‰</h2><h3 id="quan-ju-nei-cun-de-ying-jian-te-xing" tabindex="-1" id="å…¨å±€å†…å­˜çš„ç¡¬ä»¶ç‰¹æ€§">å…¨å±€å†…å­˜çš„ç¡¬ä»¶ç‰¹æ€§</h3><p>å…¨å±€å†…å­˜ï¼ˆDRAMï¼‰ä¸æ˜¯æŒ‰å•ä¸ªå­—èŠ‚è®¿é—®çš„ï¼Œè€Œæ˜¯æŒ‰**äº‹åŠ¡ï¼ˆTransactionï¼‰**æ‰¹é‡è®¿é—®ï¼š</p><ul><li>æ¯æ¬¡äº‹åŠ¡è¯»å–ä¸€ä¸ª<strong>å†…å­˜æ®µï¼ˆMemory Segmentï¼‰</strong></li><li>æ®µå¤§å°é€šå¸¸æ˜¯ 32 å­—èŠ‚æˆ– 128 å­—èŠ‚</li><li>æ®µå¿…é¡»å¯¹é½ï¼ˆèµ·å§‹åœ°å€æ˜¯æ®µå¤§å°çš„å€æ•°ï¼‰</li></ul><p>è¿™æ„å‘³ç€ï¼šè¯» 1 ä¸ª floatï¼ˆ4 å­—èŠ‚ï¼‰å’Œè¯» 32 ä¸ª floatï¼ˆ128 å­—èŠ‚ï¼‰ï¼Œå¦‚æœè½åœ¨åŒä¸€ä¸ªæ®µï¼Œç¡¬ä»¶å¼€é”€ç›¸åŒã€‚</p><h3 id="he-bing-fang-wen-de-tiao-jian" tabindex="-1" id="åˆå¹¶è®¿é—®çš„æ¡ä»¶">åˆå¹¶è®¿é—®çš„æ¡ä»¶</h3><p>å½“ Warp ä¸­çš„ 32 ä¸ªçº¿ç¨‹è®¿é—®<strong>è¿ç»­ä¸”å¯¹é½</strong>çš„å†…å­˜åœ°å€æ—¶ï¼Œè¿™äº›è®¿é—®å¯ä»¥åˆå¹¶æˆæœ€å°‘çš„äº‹åŠ¡ï¼š</p><p><strong>ç†æƒ³æƒ…å†µ</strong>ï¼š32 çº¿ç¨‹è®¿é—®è¿ç»­ 128 å­—èŠ‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// åˆå¹¶è®¿é—®ï¼ˆ1 æ¬¡ 128B äº‹åŠ¡ï¼‰</span><br><span class="line">float val = data[threadIdx.x];</span><br><span class="line">// çº¿ç¨‹ 0 è®¿é—® data[0], çº¿ç¨‹ 1 è®¿é—® data[1], ...</span><br></pre></td></tr></table></figure><p><strong>ç³Ÿç³•æƒ…å†µ</strong>ï¼š32 çº¿ç¨‹è®¿é—®è·¨æ­¥åœ°å€</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// éåˆå¹¶è®¿é—®ï¼ˆå¯èƒ½ 32 æ¬¡äº‹åŠ¡ï¼ï¼‰</span><br><span class="line">float val = data[threadIdx.x * 32];</span><br><span class="line">// çº¿ç¨‹ 0 è®¿é—® data[0], çº¿ç¨‹ 1 è®¿é—® data[32], ...</span><br><span class="line">// æ¯ä¸ªè®¿é—®è½åœ¨ä¸åŒæ®µ</span><br></pre></td></tr></table></figure><h3 id="liang-hua-ying-xiang" tabindex="-1" id="é‡åŒ–å½±å“">é‡åŒ–å½±å“</h3><p>å‡è®¾æ¯æ¬¡äº‹åŠ¡å»¶è¿Ÿç›¸åŒï¼Œåˆå¹¶è®¿é—®å¸¦æ¥çš„åŠ é€Ÿï¼š</p><table><thead><tr><th>è®¿é—®æ¨¡å¼</th><th>äº‹åŠ¡æ•°</th><th>ç›¸å¯¹å¸¦å®½</th></tr></thead><tbody><tr><td>å®Œå…¨åˆå¹¶</td><td>1</td><td>100%</td></tr><tr><td>æ­¥é•¿ 2</td><td>2</td><td>50%</td></tr><tr><td>æ­¥é•¿ 4</td><td>4</td><td>25%</td></tr><tr><td>æ­¥é•¿ 32</td><td>32</td><td>3%</td></tr></tbody></table><p>æ­¥é•¿è¶Šå¤§ï¼Œå¸¦å®½åˆ©ç”¨ç‡è¶Šä½ã€‚</p><h3 id="ju-zhen-fang-wen-de-xian-jing" tabindex="-1" id="çŸ©é˜µè®¿é—®çš„é™·é˜±">çŸ©é˜µè®¿é—®çš„é™·é˜±</h3><p>è€ƒè™‘è¡Œä¸»åºçŸ©é˜µ <code>M[row][col]</code>ï¼Œä¸€ç»´ç´¢å¼•ä¸º <code>M[row * width + col]</code>ï¼š</p><p><strong>æŒ‰è¡Œéå†ï¼ˆåˆå¹¶ï¼‰</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// åŒä¸€ warp çš„çº¿ç¨‹ï¼Œrow ç›¸åŒï¼Œcol è¿ç»­</span><br><span class="line">int idx = row * width + threadIdx.x;</span><br><span class="line">float val = M[idx];  // è¿ç»­åœ°å€ï¼Œåˆå¹¶</span><br></pre></td></tr></table></figure><p><strong>æŒ‰åˆ—éå†ï¼ˆä¸åˆå¹¶ï¼‰</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// åŒä¸€ warp çš„çº¿ç¨‹ï¼Œcol ç›¸åŒï¼Œrow è¿ç»­</span><br><span class="line">int idx = threadIdx.x * width + col;</span><br><span class="line">float val = M[idx];  // æ­¥é•¿ = widthï¼Œä¸åˆå¹¶</span><br></pre></td></tr></table></figure><p>å¦‚æœ width = 1024ï¼Œæ­¥é•¿å°±æ˜¯ 1024Ã—4 = 4096 å­—èŠ‚ï¼Œè¿œè¶…æ®µå¤§å°ï¼Œæ¯ä¸ªçº¿ç¨‹è®¿é—®ä¸åŒæ®µã€‚</p><h3 id="ju-zhen-zhuan-zhi-you-hua" tabindex="-1" id="çŸ©é˜µè½¬ç½®ä¼˜åŒ–">çŸ©é˜µè½¬ç½®ä¼˜åŒ–</h3><p>çŸ©é˜µè½¬ç½® <code>B[j][i] = A[i][j]</code>ï¼Œå¿…ç„¶æœ‰ä¸€ä¸ªçŸ©é˜µæŒ‰åˆ—è®¿é—®ã€‚è§£å†³æ–¹æ¡ˆï¼š<strong>ç”¨å…±äº«å†…å­˜åšä¸­è½¬</strong>ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">__global__ void transposeCoalesced(float *A, float *B, int width) &#123;</span><br><span class="line">    __shared__ float tile[32][33];  // æ³¨æ„ padding é˜² bank å†²çª</span><br><span class="line">    </span><br><span class="line">    int x = blockIdx.x * 32 + threadIdx.x;</span><br><span class="line">    int y = blockIdx.y * 32 + threadIdx.y;</span><br><span class="line">    </span><br><span class="line">    // åˆå¹¶è¯»å– Aï¼ˆæŒ‰è¡Œï¼‰</span><br><span class="line">    if (x &lt; width &amp;&amp; y &lt; width)</span><br><span class="line">        tile[threadIdx.y][threadIdx.x] = A[y * width + x];</span><br><span class="line">    </span><br><span class="line">    __syncthreads();</span><br><span class="line">    </span><br><span class="line">    // äº¤æ¢ block ç´¢å¼•</span><br><span class="line">    x = blockIdx.y * 32 + threadIdx.x;</span><br><span class="line">    y = blockIdx.x * 32 + threadIdx.y;</span><br><span class="line">    </span><br><span class="line">    // åˆå¹¶å†™å…¥ Bï¼ˆæŒ‰è¡Œï¼Œä½†æ•°æ®æ¥è‡ª tile çš„åˆ—ï¼‰</span><br><span class="line">    if (x &lt; width &amp;&amp; y &lt; width)</span><br><span class="line">        B[y * width + x] = tile[threadIdx.x][threadIdx.y];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å…³é”®</strong>ï¼šå…±äº«å†…å­˜æ²¡æœ‰åˆå¹¶è¦æ±‚ï¼Œå¯ä»¥ä»»æ„é¡ºåºè®¿é—®ï¼ˆåªéœ€æ³¨æ„ Bank å†²çªï¼‰ã€‚é€šè¿‡å…±äº«å†…å­˜&quot;è½¬æ¢&quot;è®¿é—®æ¨¡å¼ï¼Œè®©å…¨å±€å†…å­˜è¯»å†™éƒ½æ˜¯åˆå¹¶çš„ã€‚</p><h2 id="fen-qu-lu-ying-partition-camping" tabindex="-1" id="åˆ†åŒºéœ²è¥ï¼ˆPartition-Campingï¼‰">åˆ†åŒºéœ²è¥ï¼ˆPartition Campingï¼‰</h2><h3 id="dram-de-fen-qu-jie-gou" tabindex="-1" id="DRAM-çš„åˆ†åŒºç»“æ„">DRAM çš„åˆ†åŒºç»“æ„</h3><p>å…¨å±€å†…å­˜ç”±å¤šä¸ª**åˆ†åŒºï¼ˆPartitionï¼‰**ç»„æˆï¼Œæ¯ä¸ªåˆ†åŒºæœ‰ç‹¬ç«‹çš„è®¿é—®é€šé“ã€‚åœ°å€åˆ°åˆ†åŒºçš„æ˜ å°„é€šå¸¸æ˜¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">åˆ†åŒº = (åœ°å€ / 256) % åˆ†åŒºæ•°</span><br></pre></td></tr></table></figure><p>å¦‚æœæ‰€æœ‰è®¿é—®éƒ½è½åœ¨åŒä¸€åˆ†åŒºï¼Œå…¶ä»–åˆ†åŒºç©ºé—²ï¼Œå¸¦å®½åªæœ‰ 1/Nã€‚</p><h3 id="he-shi-fa-sheng" tabindex="-1" id="ä½•æ—¶å‘ç”Ÿ">ä½•æ—¶å‘ç”Ÿ</h3><p>å½“å¤šä¸ª Warp è®¿é—®åœ°å€&quot;æ­¥è°ƒä¸€è‡´&quot;æ—¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// å‡è®¾æ¯ä¸ª block å¤„ç†çŸ©é˜µçš„ä¸€åˆ—</span><br><span class="line">int col = blockIdx.x;</span><br><span class="line">for (int row = 0; row &lt; height; row++) &#123;</span><br><span class="line">    float val = M[row * width + col];  // æ‰€æœ‰ block åŒæ­¥è®¿é—®</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœ width æ°å¥½æ˜¯åˆ†åŒºæ•°çš„å€æ•°ï¼Œæ‰€æœ‰ block åŒæ—¶è®¿é—®åŒä¸€åˆ†åŒºã€‚</p><h3 id="jie-jue-fang-an" tabindex="-1" id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ</h3><ol><li><strong>è°ƒæ•´æ•°æ®å¸ƒå±€</strong>ï¼šåŠ  padding æ‰“ç ´å¯¹é½</li><li><strong>è°ƒæ•´è®¿é—®é¡ºåº</strong>ï¼šè®©ä¸åŒ block è®¿é—®ä¸åŒåˆ†åŒº</li><li><strong>é€šå¸¸é—®é¢˜ä¸å¤§</strong>ï¼šç°ä»£ GPU åˆ†åŒºå¤šï¼Œè‡ªåŠ¨è°ƒåº¦èƒ½åŠ›å¼º</li></ol><p>åˆ†åŒºéœ²è¥åœ¨æ—©æœŸ GPU ä¸Šæ˜¯ä¸¥é‡é—®é¢˜ï¼Œç°ä»£æ¶æ„ï¼ˆAmpere+ï¼‰å½±å“è¾ƒå°ï¼Œä½†ä»å€¼å¾—æ³¨æ„ã€‚</p><h2 id="zhi-ling-hun-he-yu-tun-tu-liang" tabindex="-1" id="æŒ‡ä»¤æ··åˆä¸ååé‡">æŒ‡ä»¤æ··åˆä¸ååé‡</h2><h3 id="bu-tong-zhi-ling-de-tun-tu-liang" tabindex="-1" id="ä¸åŒæŒ‡ä»¤çš„ååé‡">ä¸åŒæŒ‡ä»¤çš„ååé‡</h3><p>å¹¶éæ‰€æœ‰æ“ä½œé€Ÿåº¦ç›¸åŒï¼š</p><table><thead><tr><th>æ“ä½œç±»å‹</th><th>ååé‡ï¼ˆFLOP/å‘¨æœŸ/SMï¼‰</th><th>ç›¸å¯¹é€Ÿåº¦</th></tr></thead><tbody><tr><td>FP32 åŠ æ³•/ä¹˜æ³•</td><td>128</td><td>1Ã—</td></tr><tr><td>FP32 FMA</td><td>128</td><td>1Ã—</td></tr><tr><td>FP32 é™¤æ³•</td><td>16</td><td>1/8</td></tr><tr><td>FP32 ç‰¹æ®Šå‡½æ•°</td><td>32</td><td>1/4</td></tr><tr><td>FP64 åŠ æ³•/ä¹˜æ³•</td><td>64ï¼ˆæˆ–æ›´å°‘ï¼‰</td><td>1/2</td></tr><tr><td>æ•´æ•°ä¹˜æ³•</td><td>64</td><td>1/2</td></tr></tbody></table><p><strong>æ³¨æ„</strong>ï¼šé™¤æ³•å’Œç‰¹æ®Šå‡½æ•°ï¼ˆsin/cos/expï¼‰æ…¢å¾ˆå¤šã€‚</p><h3 id="you-hua-ce-lue" tabindex="-1" id="ä¼˜åŒ–ç­–ç•¥">ä¼˜åŒ–ç­–ç•¥</h3><p><strong>ç”¨ä¹˜æ³•æ›¿ä»£é™¤æ³•</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// æ…¢</span><br><span class="line">float y = x / 3.0f;</span><br><span class="line"></span><br><span class="line">// å¿«ï¼ˆé¢„è®¡ç®—å€’æ•°ï¼‰</span><br><span class="line">float inv3 = 1.0f / 3.0f;  // å¸¸é‡ï¼Œç¼–è¯‘æ—¶è®¡ç®—</span><br><span class="line">float y = x * inv3;</span><br></pre></td></tr></table></figure><p><strong>ç”¨è¿‘ä¼¼å‡½æ•°</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// ç²¾ç¡®ä½†æ…¢</span><br><span class="line">float y = sinf(x);</span><br><span class="line"></span><br><span class="line">// å¿«é€Ÿè¿‘ä¼¼ï¼ˆè¯¯å·®ç•¥å¤§ï¼‰</span><br><span class="line">float y = __sinf(x);  // å†…ç½®å¿«é€Ÿç‰ˆæœ¬</span><br></pre></td></tr></table></figure><p><strong>å‡å°‘ç‰¹æ®Šå‡½æ•°è°ƒç”¨</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// å·®ï¼š3 æ¬¡ç‰¹æ®Šå‡½æ•°</span><br><span class="line">float a = expf(x);</span><br><span class="line">float b = expf(y);</span><br><span class="line">float c = expf(z);</span><br><span class="line"></span><br><span class="line">// å¥½ï¼šåˆ©ç”¨æ•°å­¦æ€§è´¨</span><br><span class="line">float abc = expf(x + y + z);</span><br></pre></td></tr></table></figure><h3 id="hun-he-jing-du" tabindex="-1" id="æ··åˆç²¾åº¦">æ··åˆç²¾åº¦</h3><p>å¦‚æœç²¾åº¦å…è®¸ï¼Œç”¨ FP16 æˆ– TF32ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// ä½¿ç”¨ half ç²¾åº¦ï¼ˆéœ€è¦ include cuda_fp16.hï¼‰</span><br><span class="line">half x = __float2half(input);</span><br><span class="line">half y = __hmul(x, x);  // FP16 ä¹˜æ³•ï¼Œååé‡æ›´é«˜</span><br><span class="line">float result = __half2float(y);</span><br></pre></td></tr></table></figure><p>Tensor Core å¯ä»¥åš FP16/TF32 çŸ©é˜µä¹˜æ³•ï¼Œååé‡æ¯” FP32 CUDA æ ¸å¿ƒé«˜æ•°å€ã€‚</p><h2 id="xian-cheng-li-du" tabindex="-1" id="çº¿ç¨‹ç²’åº¦">çº¿ç¨‹ç²’åº¦</h2><h3 id="mei-xian-cheng-gong-zuo-liang" tabindex="-1" id="æ¯çº¿ç¨‹å·¥ä½œé‡">æ¯çº¿ç¨‹å·¥ä½œé‡</h3><p>çº¿ç¨‹ç²’åº¦æŒ‡æ¯ä¸ªçº¿ç¨‹å¤„ç†çš„æ•°æ®é‡ã€‚ä¸¤ä¸ªæç«¯ï¼š</p><p><strong>ç»†ç²’åº¦</strong>ï¼šæ¯çº¿ç¨‹å¤„ç† 1 ä¸ªå…ƒç´ </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// æ¯çº¿ç¨‹ 1 ä¸ªå…ƒç´ </span><br><span class="line">int i = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">C[i] = A[i] + B[i];</span><br></pre></td></tr></table></figure><p><strong>ç²—ç²’åº¦</strong>ï¼šæ¯çº¿ç¨‹å¤„ç†å¤šä¸ªå…ƒç´ </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// æ¯çº¿ç¨‹ 4 ä¸ªå…ƒç´ </span><br><span class="line">int base = (blockIdx.x * blockDim.x + threadIdx.x) * 4;</span><br><span class="line">for (int i = 0; i &lt; 4; i++) &#123;</span><br><span class="line">    C[base + i] = A[base + i] + B[base + i];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="cu-li-du-de-you-shi" tabindex="-1" id="ç²—ç²’åº¦çš„ä¼˜åŠ¿">ç²—ç²’åº¦çš„ä¼˜åŠ¿</h3><ol><li><strong>å‡å°‘å¯åŠ¨å¼€é”€</strong>ï¼šæ›´å°‘çš„çº¿ç¨‹æ€»æ•°</li><li><strong>å¯„å­˜å™¨å¤ç”¨</strong>ï¼šå¾ªç¯å˜é‡ã€æŒ‡é’ˆå¯å¤ç”¨</li><li><strong>æŒ‡ä»¤çº§å¹¶è¡Œ</strong>ï¼šå¾ªç¯å±•å¼€åå¤šæ¡æŒ‡ä»¤å¯æµæ°´</li><li><strong>å‡å°‘åŒæ­¥</strong>ï¼šæ¯çº¿ç¨‹æ›´å¤šç‹¬ç«‹å·¥ä½œ</li></ol><h3 id="cu-li-du-de-feng-xian" tabindex="-1" id="ç²—ç²’åº¦çš„é£é™©">ç²—ç²’åº¦çš„é£é™©</h3><ol><li><strong>è´Ÿè½½ä¸å‡è¡¡</strong>ï¼šå¦‚æœå…ƒç´ æ•°ä¸æ˜¯ç²’åº¦å€æ•°ï¼Œæœ€åä¸€æ‰¹çº¿ç¨‹å·¥ä½œé‡ä¸åŒ</li><li><strong>å ç”¨ç‡ä¸‹é™</strong>ï¼šæ¯çº¿ç¨‹æ›´å¤šå¯„å­˜å™¨ï¼Œå¯èƒ½é™ä½å¹¶è¡Œåº¦</li><li><strong>å¤æ‚è¾¹ç•Œå¤„ç†</strong>ï¼šéœ€è¦é¢å¤–æ£€æŸ¥</li></ol><h3 id="shi-jian-jian-yi" tabindex="-1" id="å®è·µå»ºè®®">å®è·µå»ºè®®</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// æ¯çº¿ç¨‹å¤„ç† 4 ä¸ªå…ƒç´ ï¼Œå¸¦è¾¹ç•Œæ£€æŸ¥</span><br><span class="line">__global__ void vectorAddCoarsened(float *A, float *B, float *C, int n) &#123;</span><br><span class="line">    int tid = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">    int stride = blockDim.x * gridDim.x;</span><br><span class="line">    </span><br><span class="line">    // Grid-stride loop</span><br><span class="line">    for (int i = tid; i &lt; n; i += stride) &#123;</span><br><span class="line">        C[i] = A[i] + B[i];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Grid-stride loop</strong> æ˜¯ç»å…¸æ¨¡å¼ï¼šæ¯çº¿ç¨‹ä»è‡ªå·±çš„èµ·å§‹ä½ç½®å¼€å§‹ï¼ŒæŒ‰ grid å¤§å°æ­¥è¿›ï¼Œç›´åˆ°å¤„ç†å®Œæ‰€æœ‰å…ƒç´ ã€‚å…¼é¡¾äº†ç²’åº¦å’Œçµæ´»æ€§ã€‚</p><h2 id="zi-yuan-ping-heng" tabindex="-1" id="èµ„æºå¹³è¡¡">èµ„æºå¹³è¡¡</h2><h3 id="zhan-yong-lu-vs-mei-xian-cheng-zi-yuan" tabindex="-1" id="å ç”¨ç‡-vs-æ¯çº¿ç¨‹èµ„æº">å ç”¨ç‡ vs æ¯çº¿ç¨‹èµ„æº</h3><p>å›é¡¾ç¬¬å››ç« çš„å ç”¨ç‡æ¦‚å¿µã€‚èµ„æºä½¿ç”¨å¢åŠ ä¼šé™ä½å ç”¨ç‡ï¼š</p><table><thead><tr><th>æ¯çº¿ç¨‹å¯„å­˜å™¨</th><th>æ¯ SM çº¿ç¨‹æ•°</th><th>å ç”¨ç‡</th></tr></thead><tbody><tr><td>32</td><td>2048</td><td>100%</td></tr><tr><td>64</td><td>1024</td><td>50%</td></tr><tr><td>128</td><td>512</td><td>25%</td></tr><tr><td>256</td><td>256</td><td>12.5%</td></tr></tbody></table><p>ç±»ä¼¼åœ°ï¼Œæ¯ Block å…±äº«å†…å­˜è¶Šå¤šï¼Œèƒ½åŒæ—¶è¿è¡Œçš„ Block è¶Šå°‘ã€‚</p><h3 id="quan-heng-an-li" tabindex="-1" id="æƒè¡¡æ¡ˆä¾‹">æƒè¡¡æ¡ˆä¾‹</h3><p><strong>åœºæ™¯</strong>ï¼šTiled çŸ©é˜µä¹˜æ³•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// æ–¹æ¡ˆ Aï¼šå° Tile</span><br><span class="line">#define TILE 16</span><br><span class="line">__shared__ float As[16][16];  // 2 KB</span><br><span class="line">__shared__ float Bs[16][16];  // 2 KB</span><br><span class="line">// å…±äº«å†…å­˜å°‘ï¼Œå¯ä»¥å¤š Blockï¼Œé«˜å ç”¨ç‡</span><br><span class="line">// ä½† Tile å°ï¼Œç®—æœ¯å¼ºåº¦ä½</span><br><span class="line"></span><br><span class="line">// æ–¹æ¡ˆ Bï¼šå¤§ Tile</span><br><span class="line">#define TILE 32</span><br><span class="line">__shared__ float As[32][32];  // 8 KB</span><br><span class="line">__shared__ float Bs[32][32];  // 8 KB</span><br><span class="line">// å…±äº«å†…å­˜å¤šï¼ŒBlock å°‘ï¼Œä½å ç”¨ç‡</span><br><span class="line">// ä½† Tile å¤§ï¼Œç®—æœ¯å¼ºåº¦é«˜</span><br></pre></td></tr></table></figure><p><strong>é€šå¸¸å¤§ Tile æ›´ä¼˜</strong>ï¼šçŸ©é˜µä¹˜æ³•æ˜¯è®¡ç®—å¯†é›†å‹ï¼Œç®—æœ¯å¼ºåº¦æ¯”å ç”¨ç‡æ›´é‡è¦ã€‚ä½†éœ€è¦å®æµ‹éªŒè¯ã€‚</p><h3 id="shi-yong-launch-bounds" tabindex="-1" id="ä½¿ç”¨-Launch-Bounds">ä½¿ç”¨ Launch Bounds</h3><p>å‘Šè¯‰ç¼–è¯‘å™¨ä½ çš„é…ç½®ï¼Œå¸®åŠ©ä¼˜åŒ–å¯„å­˜å™¨åˆ†é…ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">__global__ void __launch_bounds__(256, 4) matMulKernel(...) &#123;</span><br><span class="line">    // æ¯ Block 256 çº¿ç¨‹</span><br><span class="line">    // æœŸæœ›æ¯ SM è‡³å°‘ 4 ä¸ª Block</span><br><span class="line">    // ç¼–è¯‘å™¨æ®æ­¤é™åˆ¶å¯„å­˜å™¨ä½¿ç”¨</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœä¸æŒ‡å®šï¼Œç¼–è¯‘å™¨å¯èƒ½è¿‡åº¦ä½¿ç”¨å¯„å­˜å™¨ï¼Œå¯¼è‡´å ç”¨ç‡ä½äºé¢„æœŸã€‚</p><h2 id="warp-zhi-xing-xiao-lu" tabindex="-1" id="Warp-æ‰§è¡Œæ•ˆç‡">Warp æ‰§è¡Œæ•ˆç‡</h2><h3 id="xian-cheng-shu-li-yong-lu" tabindex="-1" id="çº¿ç¨‹æŸåˆ©ç”¨ç‡">çº¿ç¨‹æŸåˆ©ç”¨ç‡</h3><p>å¦‚æœ Block å¤§å°ä¸æ˜¯ 32 çš„å€æ•°ï¼Œæœ€åä¸€ä¸ª Warp æœ‰çº¿ç¨‹ç©ºé—²ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dim3 block(100);  // 100 / 32 = 3.125 â†’ 4 ä¸ª warp</span><br><span class="line">// Warp 3 åªæœ‰ 4 ä¸ªæ´»è·ƒçº¿ç¨‹ï¼Œ28 ä¸ªç©ºé—²</span><br><span class="line">// warp åˆ©ç”¨ç‡ = 100 / 128 = 78%</span><br></pre></td></tr></table></figure><p><strong>æ°¸è¿œç”¨ 32 çš„å€æ•°ä½œä¸º Block å¤§å°</strong>ã€‚</p><h3 id="dong-tai-fen-zhi-de-e-wai-kai-xiao" tabindex="-1" id="åŠ¨æ€åˆ†æ”¯çš„é¢å¤–å¼€é”€">åŠ¨æ€åˆ†æ”¯çš„é¢å¤–å¼€é”€</h3><p>å³ä½¿æ²¡æœ‰åˆ†æ”¯å‘æ•£ï¼ŒåŠ¨æ€åˆ†æ”¯æœ¬èº«ä¹Ÿæœ‰å¼€é”€ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// æœ‰åˆ†æ”¯å¼€é”€</span><br><span class="line">if (condition) &#123;</span><br><span class="line">    doWork();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æ— åˆ†æ”¯ï¼ˆæ¡ä»¶æ€»ä¸º trueï¼‰</span><br><span class="line">doWork();</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘å™¨æ— æ³•çŸ¥é“ <code>condition</code> æ˜¯å¦æ€»ä¸º trueï¼Œå¿…é¡»ç”Ÿæˆåˆ†æ”¯æŒ‡ä»¤ã€‚å¦‚æœæ¡ä»¶å¯ä»¥åœ¨ç¼–è¯‘æ—¶ç¡®å®šï¼Œç”¨æ¨¡æ¿æˆ– constexprã€‚</p><h2 id="shu-ju-yu-qu" tabindex="-1" id="æ•°æ®é¢„å–">æ•°æ®é¢„å–</h2><h3 id="ruan-jian-liu-shui" tabindex="-1" id="è½¯ä»¶æµæ°´">è½¯ä»¶æµæ°´</h3><p>é€šè¿‡æå‰å‘èµ·å†…å­˜è¯·æ±‚ï¼Œä¸è®¡ç®—é‡å ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// æ— é¢„å–</span><br><span class="line">for (int i = 0; i &lt; n; i++) &#123;</span><br><span class="line">    float data = load(i);      // ç­‰å¾…</span><br><span class="line">    process(data);             // è®¡ç®—</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æœ‰é¢„å–</span><br><span class="line">float next = load(0);</span><br><span class="line">for (int i = 0; i &lt; n - 1; i++) &#123;</span><br><span class="line">    float curr = next;</span><br><span class="line">    next = load(i + 1);        // æå‰è¯·æ±‚</span><br><span class="line">    process(curr);             // åŒæ—¶è®¡ç®—</span><br><span class="line">&#125;</span><br><span class="line">process(next);</span><br></pre></td></tr></table></figure><p>é¢„å–è®© load å’Œ compute é‡å ï¼Œéšè—éƒ¨åˆ†å»¶è¿Ÿã€‚</p><h3 id="zai-cuda-zhong-de-ying-yong" tabindex="-1" id="åœ¨-CUDA-ä¸­çš„åº”ç”¨">åœ¨ CUDA ä¸­çš„åº”ç”¨</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">__global__ void prefetchExample(float *in, float *out, int n) &#123;</span><br><span class="line">    __shared__ float buffer[2][TILE_SIZE];  // åŒç¼“å†²</span><br><span class="line">    </span><br><span class="line">    int tile = 0;</span><br><span class="line">    </span><br><span class="line">    // é¢„åŠ è½½ç¬¬ä¸€å—</span><br><span class="line">    buffer[0][threadIdx.x] = in[threadIdx.x];</span><br><span class="line">    </span><br><span class="line">    for (int i = TILE_SIZE; i &lt; n; i += TILE_SIZE) &#123;</span><br><span class="line">        __syncthreads();</span><br><span class="line">        </span><br><span class="line">        // åŠ è½½ä¸‹ä¸€å—åˆ°å¦ä¸€ä¸ªç¼“å†²åŒº</span><br><span class="line">        buffer[1 - tile][threadIdx.x] = in[i + threadIdx.x];</span><br><span class="line">        </span><br><span class="line">        // å¤„ç†å½“å‰å—</span><br><span class="line">        out[i - TILE_SIZE + threadIdx.x] = process(buffer[tile][threadIdx.x]);</span><br><span class="line">        </span><br><span class="line">        tile = 1 - tile;  // åˆ‡æ¢ç¼“å†²åŒº</span><br><span class="line">        __syncthreads();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // å¤„ç†æœ€åä¸€å—</span><br><span class="line">    out[n - TILE_SIZE + threadIdx.x] = process(buffer[tile][threadIdx.x]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒç¼“å†²æ˜¯ç»å…¸æŠ€æœ¯ï¼šä¸€ä¸ªç¼“å†²åŒºå¤„ç†ï¼Œå¦ä¸€ä¸ªåŠ è½½ï¼Œäº¤æ›¿è¿›è¡Œã€‚</p><h2 id="xing-neng-fen-xi-gong-ju" tabindex="-1" id="æ€§èƒ½åˆ†æå·¥å…·">æ€§èƒ½åˆ†æå·¥å…·</h2><h3 id="nsight-compute" tabindex="-1" id="Nsight-Compute">Nsight Compute</h3><p>NVIDIA å®˜æ–¹ profilerï¼Œåˆ†æ kernel æ€§èƒ½ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ncu --<span class="built_in">set</span> full ./myprogram</span><br></pre></td></tr></table></figure><p>å…³é”®æŒ‡æ ‡ï¼š</p><table><thead><tr><th>æŒ‡æ ‡</th><th>å«ä¹‰</th><th>ç›®æ ‡</th></tr></thead><tbody><tr><td>SM Throughput</td><td>è®¡ç®—å•å…ƒåˆ©ç”¨ç‡</td><td>è¶Šé«˜è¶Šå¥½</td></tr><tr><td>Memory Throughput</td><td>å†…å­˜å¸¦å®½åˆ©ç”¨ç‡</td><td>æ¥è¿‘ç¡¬ä»¶å³°å€¼</td></tr><tr><td>Occupancy</td><td>å ç”¨ç‡</td><td>è§†æƒ…å†µè€Œå®š</td></tr><tr><td>Warp Execution Efficiency</td><td>çº¿ç¨‹æŸæ•ˆç‡</td><td>æ¥è¿‘ 100%</td></tr><tr><td>Memory Coalescing</td><td>åˆå¹¶æ•ˆç‡</td><td>æ¥è¿‘ 100%</td></tr></tbody></table><h3 id="nsight-systems" tabindex="-1" id="Nsight-Systems">Nsight Systems</h3><p>åˆ†ææ•´ä½“æ‰§è¡Œæµç¨‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nsys profile ./myprogram</span><br></pre></td></tr></table></figure><p>å¯è§†åŒ–ï¼š</p><ul><li>Kernel æ‰§è¡Œæ—¶é—´çº¿</li><li>Memory æ‹·è´æ—¶é—´</li><li>CPU/GPU äº¤äº’</li><li>æµå’Œäº‹ä»¶</li></ul><h3 id="chang-jian-xing-neng-mo-shi" tabindex="-1" id="å¸¸è§æ€§èƒ½æ¨¡å¼">å¸¸è§æ€§èƒ½æ¨¡å¼</h3><p><strong>å†…å­˜å—é™</strong>ï¼šMemory Throughput é«˜ï¼ŒSM Throughput ä½</p><ul><li>è§£å†³ï¼šæé«˜ç®—æœ¯å¼ºåº¦ã€ç”¨å…±äº«å†…å­˜</li></ul><p><strong>è®¡ç®—å—é™</strong>ï¼šSM Throughput é«˜ï¼ŒMemory Throughput ä½</p><ul><li>è§£å†³ï¼šå·²ç»å¾ˆå¥½äº†ï¼Œä¼˜åŒ–ç®—æ³•å¤æ‚åº¦</li></ul><p><strong>å»¶è¿Ÿå—é™</strong>ï¼šä¸¤ä¸ª Throughput éƒ½ä½ï¼ŒOccupancy ä¹Ÿä½</p><ul><li>è§£å†³ï¼šå¢åŠ å¹¶è¡Œåº¦ï¼Œè°ƒæ•´ Block é…ç½®</li></ul><h2 id="you-hua-jian-cha-qing-dan" tabindex="-1" id="ä¼˜åŒ–æ£€æŸ¥æ¸…å•">ä¼˜åŒ–æ£€æŸ¥æ¸…å•</h2><p>æŒ‰ä¼˜å…ˆçº§æ’åºçš„ä¼˜åŒ–æ­¥éª¤ï¼š</p><h3 id="1-zheng-que-xing-you-xian" tabindex="-1" id="1-æ­£ç¡®æ€§ä¼˜å…ˆ">1. æ­£ç¡®æ€§ä¼˜å…ˆ</h3><ul><li>[ ] è¾¹ç•Œæ£€æŸ¥å®Œæ•´</li><li>[ ] åŒæ­¥æ­£ç¡®ä½¿ç”¨</li><li>[ ] æ— ç«æ€æ¡ä»¶</li></ul><h3 id="2-nei-cun-you-hua" tabindex="-1" id="2-å†…å­˜ä¼˜åŒ–">2. å†…å­˜ä¼˜åŒ–</h3><ul><li>[ ] å…¨å±€å†…å­˜åˆå¹¶è®¿é—®</li><li>[ ] ä½¿ç”¨å…±äº«å†…å­˜å‡å°‘å…¨å±€å†…å­˜è®¿é—®</li><li>[ ] é¿å… Bank å†²çª</li><li>[ ] å¸¸é‡æ•°æ®ç”¨ <code>__constant__</code></li></ul><h3 id="3-zhi-xing-you-hua" tabindex="-1" id="3-æ‰§è¡Œä¼˜åŒ–">3. æ‰§è¡Œä¼˜åŒ–</h3><ul><li>[ ] Block å¤§å°æ˜¯ 32 çš„å€æ•°</li><li>[ ] é¿å… Warp å†…åˆ†æ”¯å‘æ•£</li><li>[ ] å‡å°‘åŒæ­¥æ¬¡æ•°</li><li>[ ] åˆç†çº¿ç¨‹ç²’åº¦</li></ul><h3 id="4-zhi-ling-you-hua" tabindex="-1" id="4-æŒ‡ä»¤ä¼˜åŒ–">4. æŒ‡ä»¤ä¼˜åŒ–</h3><ul><li>[ ] é¿å…é™¤æ³•å’Œç‰¹æ®Šå‡½æ•°</li><li>[ ] ç”¨ FMAï¼ˆç¼–è¯‘å™¨è‡ªåŠ¨ï¼‰</li><li>[ ] è€ƒè™‘æ··åˆç²¾åº¦</li></ul><h3 id="5-zi-yuan-ping-heng" tabindex="-1" id="5-èµ„æºå¹³è¡¡">5. èµ„æºå¹³è¡¡</h3><ul><li>[ ] ç›‘æ§å¯„å­˜å™¨ä½¿ç”¨</li><li>[ ] ä½¿ç”¨ launch_bounds</li><li>[ ] å®æµ‹ä¸åŒé…ç½®</li></ul><h2 id="xiao-jie" tabindex="-1" id="å°ç»“">å°ç»“</h2><p>ç¬¬å…­ç« æ˜¯æ€§èƒ½ä¼˜åŒ–çš„å·¥ç¨‹å®è·µï¼š</p><p><strong>å†…å­˜åˆå¹¶æ ¸å¿ƒ</strong>ï¼šWarp çº¿ç¨‹è®¿é—®è¿ç»­åœ°å€ï¼Œäº‹åŠ¡æ•°æœ€å°‘ã€‚çŸ©é˜µæŒ‰è¡Œè®¿é—®å¥½ï¼ŒæŒ‰åˆ—è®¿é—®å·®ã€‚ç”¨å…±äº«å†…å­˜è½¬æ¢è®¿é—®æ¨¡å¼ã€‚</p><p><strong>åˆ†æ”¯å‘æ•£å›é¡¾</strong>ï¼šWarp å†…èµ°ä¸åŒåˆ†æ”¯ä¼šä¸²è¡ŒåŒ–ã€‚æŒ‰ Warp è¾¹ç•Œåˆ’åˆ†ä»»åŠ¡ï¼Œç”¨ç®—æœ¯æ›¿ä»£åˆ†æ”¯ã€‚</p><p><strong>æŒ‡ä»¤ååé‡</strong>ï¼šé™¤æ³•æ…¢ 8 å€ï¼Œç‰¹æ®Šå‡½æ•°æ…¢ 4 å€ã€‚é¢„è®¡ç®—å€’æ•°ï¼Œç”¨å¿«é€Ÿè¿‘ä¼¼ï¼Œè€ƒè™‘æ··åˆç²¾åº¦ã€‚</p><p><strong>çº¿ç¨‹ç²’åº¦</strong>ï¼šæ¯çº¿ç¨‹å¤„ç†å¤šä¸ªå…ƒç´ å¯æé«˜æ•ˆç‡ã€‚Grid-stride loop æ˜¯é€šç”¨æ¨¡å¼ã€‚</p><p><strong>èµ„æºå¹³è¡¡</strong>ï¼šå ç”¨ç‡ä¸æ˜¯è¶Šé«˜è¶Šå¥½ã€‚è®¡ç®—å¯†é›†å‹å¯æ¥å—ä½å ç”¨ç‡ï¼Œå†…å­˜å¯†é›†å‹éœ€è¦é«˜å ç”¨ç‡æ¥éšè—å»¶è¿Ÿã€‚</p><p><strong>å·¥å…·é©±åŠ¨ä¼˜åŒ–</strong>ï¼šç”¨ Nsight Compute åˆ†æç“¶é¢ˆï¼Œä¸è¦çŒœæµ‹ã€‚Memory Throughput å’Œ SM Throughput æŒ‡æ˜ä¼˜åŒ–æ–¹å‘ã€‚</p><p>è¿™äº›æŠ€å·§ç»„åˆä½¿ç”¨ï¼Œèƒ½è®©ä»£ç æ€§èƒ½å†æå‡æ•°å€ã€‚ä¸‹ä¸€ç« å¼€å§‹å­¦ä¹ å…·ä½“çš„å¹¶è¡Œæ¨¡å¼â€”â€”å·ç§¯ã€è§„çº¦ã€å‰ç¼€å’Œï¼Œè¿™äº›éƒ½éœ€è¦æœ¬ç« çš„ä¼˜åŒ–æŠ€æœ¯ã€‚</p><hr><p><strong>å‚è€ƒèµ„æ–™ï¼š</strong></p><ul><li>Hwu, W., Kirk, D., &amp; El Hajj, I. (2022). <em>Programming Massively Parallel Processors: A Hands-on Approach</em> (4th Edition). Morgan Kaufmann.</li><li><a href="https://docs.nvidia.com/cuda/cuda-c-best-practices-guide/">CUDA C++ Best Practices Guide</a></li><li><a href="https://docs.nvidia.com/nsight-compute/">Nsight Compute Documentation</a></li></ul><hr><blockquote><p><strong>æœ¬æ–‡ GitHub ä»“åº“</strong>: <a href="https://github.com/psmarter/PMPP-Learning">https://github.com/psmarter/PMPP-Learning</a></p></blockquote>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;qian-yan&quot; tabindex=&quot;-1&quot; id=&quot;å‰è¨€&quot;&gt;å‰è¨€&lt;/h2&gt;
&lt;p&gt;ç¬¬äº”ç« å­¦äº†å†…å­˜å±‚æ¬¡å’Œ Tiling æŠ€æœ¯ï¼ŒçŸ©é˜µä¹˜æ³•æ€§èƒ½æå‡äº† 10</summary>
        
      
    
    
    
    <category term="çŸ¥è¯†åˆ†äº«" scheme="https://smarter.xin/categories/knowledge-sharing/"/>
    
    
    <category term="CUDA" scheme="https://smarter.xin/tags/CUDA/"/>
    
    <category term="GPUç¼–ç¨‹" scheme="https://smarter.xin/tags/gpu-programming/"/>
    
    <category term="å¹¶è¡Œè®¡ç®—" scheme="https://smarter.xin/tags/parallel-computing/"/>
    
    <category term="PMPP" scheme="https://smarter.xin/tags/PMPP/"/>
    
    <category term="æ€§èƒ½ä¼˜åŒ–" scheme="https://smarter.xin/tags/performance-optimization/"/>
    
    <category term="å†…å­˜åˆå¹¶" scheme="https://smarter.xin/tags/memory-coalescing/"/>
    
  </entry>
  
  <entry>
    <title>PMPP-ç¬¬äº”ç« ï¼šå†…å­˜æ¶æ„å’Œæ•°æ®å±€éƒ¨æ€§</title>
    <link href="https://smarter.xin/posts/3bb3179b/"/>
    <id>https://smarter.xin/posts/3bb3179b/</id>
    <published>2026-01-16T02:16:08.000Z</published>
    <updated>2026-01-24T08:26:21.332Z</updated>
    
    <content type="html"><![CDATA[<h2 id="qian-yan" tabindex="-1" id="å‰è¨€">å‰è¨€</h2><p>ç¬¬å››ç« ç†è§£äº†GPUçš„è°ƒåº¦æœºåˆ¶å’Œç¡¬ä»¶æ¶æ„ï¼Œè¿™ä¸€ç« è¿›å…¥æ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒâ€”â€”å†…å­˜ã€‚GPUè®¡ç®—èƒ½åŠ›å¼ºå¤§ï¼Œä½†æ•°æ®ä¾›åº”è·Ÿä¸ä¸Šå°±ç™½æ­ã€‚ç¬¬äº”ç« è®²è§£GPUçš„å†…å­˜å±‚æ¬¡ç»“æ„ï¼Œé‡ç‚¹æ˜¯Shared Memoryå’ŒTilingæŠ€æœ¯ã€‚æŒæ¡è¿™äº›ï¼ŒçŸ©é˜µä¹˜æ³•æ€§èƒ½å¯ä»¥æå‡10å€ä»¥ä¸Šã€‚</p><blockquote><p><strong>ğŸ“¦ é…å¥—èµ„æº</strong>ï¼šæœ¬ç³»åˆ—æ–‡ç« é…æœ‰å®Œæ•´çš„ <a href="https://github.com/psmarter/PMPP-Learning">GitHub ä»“åº“</a>ï¼ŒåŒ…å«æ¯ç« çš„ç»ƒä¹ é¢˜è§£ç­”ã€CUDA ä»£ç å®ç°å’Œè¯¦ç»†æ³¨é‡Šã€‚æ‰€æœ‰ä»£ç éƒ½ç»è¿‡æµ‹è¯•ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œã€‚</p></blockquote><h2 id="nei-cun-dai-kuan-xing-neng-de-tian-hua-ban" tabindex="-1" id="å†…å­˜å¸¦å®½ï¼šæ€§èƒ½çš„å¤©èŠ±æ¿">å†…å­˜å¸¦å®½ï¼šæ€§èƒ½çš„å¤©èŠ±æ¿</h2><h3 id="wen-ti-de-ben-zhi" tabindex="-1" id="é—®é¢˜çš„æœ¬è´¨">é—®é¢˜çš„æœ¬è´¨</h3><p>å›é¡¾ç¬¬ä¸‰ç« çš„çŸ©é˜µä¹˜æ³•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">__global__ void matMul(float *M, float *N, float *P, int width) &#123;</span><br><span class="line">    int row = blockIdx.y * blockDim.y + threadIdx.y;</span><br><span class="line">    int col = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">    </span><br><span class="line">    if (row &lt; width &amp;&amp; col &lt; width) &#123;</span><br><span class="line">        float sum = 0.0f;</span><br><span class="line">        for (int k = 0; k &lt; width; k++) &#123;</span><br><span class="line">            sum += M[row * width + k] * N[k * width + col];</span><br><span class="line">        &#125;</span><br><span class="line">        P[row * width + col] = sum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è®¡ç®— P[row][col] éœ€è¦è¯»å– M çš„ä¸€è¡Œå’Œ N çš„ä¸€åˆ—ï¼Œå…± 2Ã—width ä¸ªå…ƒç´ ã€‚æ¯ä¸ªå…ƒç´  4 å­—èŠ‚ï¼Œwidth=1024 æ—¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">æ¯çº¿ç¨‹è¯»å–ï¼š2 Ã— 1024 Ã— 4 = 8192 å­—èŠ‚</span><br><span class="line">æ¯çº¿ç¨‹è®¡ç®—ï¼š2 Ã— 1024 = 2048 FLOP</span><br><span class="line">ç®—æœ¯å¼ºåº¦ï¼š2048 / 8192 = 0.25 FLOP/Byte</span><br></pre></td></tr></table></figure><p>ç°ä»£ GPU å³°å€¼ 10+ TFLOPSï¼Œå¸¦å®½ 500+ GB/sï¼Œéœ€è¦ 20 FLOP/Byte æ‰èƒ½è·‘æ»¡è®¡ç®—å•å…ƒã€‚å®é™…åªæœ‰ 0.25ï¼Œ<strong>GPU å¤§éƒ¨åˆ†æ—¶é—´åœ¨ç­‰æ•°æ®</strong>ã€‚</p><h3 id="shu-ju-zhong-fu-fang-wen" tabindex="-1" id="æ•°æ®é‡å¤è®¿é—®">æ•°æ®é‡å¤è®¿é—®</h3><p>æ›´ä¸¥é‡çš„æ˜¯ï¼š<strong>åŒä¸€æ•°æ®è¢«å¤šä¸ªçº¿ç¨‹é‡å¤è¯»å–</strong>ã€‚</p><p>M[i][k] è¢«ç¬¬ i è¡Œçš„æ‰€æœ‰çº¿ç¨‹è¯»å–ï¼ŒN[k][j] è¢«ç¬¬ j åˆ—çš„æ‰€æœ‰çº¿ç¨‹è¯»å–ã€‚1024Ã—1024 çŸ©é˜µï¼Œæ¯ä¸ªå…ƒç´ è¢«è¯» 1024 æ¬¡ï¼Œä½†æ¯æ¬¡éƒ½ä»å…¨å±€å†…å­˜ï¼ˆDRAMï¼‰è¯»ã€‚</p><p>è¿™å°±æ˜¯ä¼˜åŒ–çš„åˆ‡å…¥ç‚¹ï¼š<strong>è®©æ•°æ®å¤ç”¨å‘ç”Ÿåœ¨å¿«é€Ÿå­˜å‚¨ä¸Šï¼Œè€Œä¸æ˜¯å…¨å±€å†…å­˜</strong>ã€‚</p><h2 id="gpu-nei-cun-ceng-ci" tabindex="-1" id="GPU-å†…å­˜å±‚æ¬¡">GPU å†…å­˜å±‚æ¬¡</h2><h3 id="ceng-ci-jie-gou" tabindex="-1" id="å±‚æ¬¡ç»“æ„">å±‚æ¬¡ç»“æ„</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚                   Host Memory               â”‚   CPU DDR4/DDR5</span><br><span class="line">â”‚                   (GB çº§åˆ«)                  â”‚   ~50 GB/s</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚              Global Memory (DRAM)           â”‚   GPU æ˜¾å­˜</span><br><span class="line">â”‚                  (GB çº§åˆ«)                   â”‚   ~500 GB/s</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚    L2 Cache (SM å…±äº«)                        â”‚   å‡  MB</span><br><span class="line">â”‚                                              â”‚   ~1-2 TB/s</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚   Shared     â”‚   Shared     â”‚   Shared      â”‚   æ¯ SM</span><br><span class="line">â”‚   Memory     â”‚   Memory     â”‚   Memory      â”‚   ~100 KB</span><br><span class="line">â”‚   L1 Cache   â”‚   L1 Cache   â”‚   L1 Cache    â”‚   ~10 TB/s</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚  Registers   â”‚  Registers   â”‚  Registers    â”‚   æ¯çº¿ç¨‹</span><br><span class="line">â”‚              â”‚              â”‚               â”‚   ~å‡ å TB/s</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">     SM 0           SM 1           SM 2</span><br></pre></td></tr></table></figure><p><strong>æ ¸å¿ƒè§„å¾‹</strong>ï¼šè¶Šé è¿‘è®¡ç®—å•å…ƒï¼Œå®¹é‡è¶Šå°ï¼Œé€Ÿåº¦è¶Šå¿«ã€‚</p><h3 id="ge-ji-cun-chu-te-dian" tabindex="-1" id="å„çº§å­˜å‚¨ç‰¹ç‚¹">å„çº§å­˜å‚¨ç‰¹ç‚¹</h3><table><thead><tr><th>å­˜å‚¨ç±»å‹</th><th>ä½œç”¨åŸŸ</th><th>å®¹é‡</th><th>å»¶è¿Ÿ</th><th>ç¨‹åºå‘˜æ§åˆ¶</th></tr></thead><tbody><tr><td>å¯„å­˜å™¨</td><td>å•çº¿ç¨‹</td><td>~255ä¸ª/çº¿ç¨‹</td><td>1å‘¨æœŸ</td><td>éšå¼ï¼ˆå˜é‡ï¼‰</td></tr><tr><td>å…±äº«å†…å­˜</td><td>Blockå†…</td><td>~100KB/SM</td><td>~20å‘¨æœŸ</td><td>æ˜¾å¼</td></tr><tr><td>L1ç¼“å­˜</td><td>SMå†…</td><td>~128KB/SM</td><td>~20å‘¨æœŸ</td><td>éƒ¨åˆ†</td></tr><tr><td>L2ç¼“å­˜</td><td>å…¨å±€</td><td>~6MB</td><td>~200å‘¨æœŸ</td><td>æ— </td></tr><tr><td>å…¨å±€å†…å­˜</td><td>å…¨å±€</td><td>~æ•°GB</td><td>~400å‘¨æœŸ</td><td>æ˜¾å¼</td></tr></tbody></table><p><strong>å…³é”®æ´å¯Ÿ</strong>ï¼š</p><ul><li><strong>å¯„å­˜å™¨</strong>æœ€å¿«ï¼Œä½†å®¹é‡æœ‰é™ï¼Œä¸”åªå±äºå•ä¸ªçº¿ç¨‹</li><li><strong>å…±äº«å†…å­˜</strong>æ˜¯ç¨‹åºå‘˜å¯æ§çš„ Block çº§ç¼“å­˜ï¼Œè¿™æ˜¯ä¼˜åŒ–çš„ä¸»æˆ˜åœº</li><li><strong>å…¨å±€å†…å­˜</strong>æ˜¯å”¯ä¸€èƒ½å®¹çº³å¤§æ•°æ®çš„åœ°æ–¹ï¼Œä½†å¤ªæ…¢</li></ul><h2 id="gong-xiang-nei-cun-shared-memory" tabindex="-1" id="å…±äº«å†…å­˜ï¼ˆShared-Memoryï¼‰">å…±äº«å†…å­˜ï¼ˆShared Memoryï¼‰</h2><h3 id="ji-ben-gai-nian" tabindex="-1" id="åŸºæœ¬æ¦‚å¿µ">åŸºæœ¬æ¦‚å¿µ</h3><p>å…±äº«å†…å­˜æ˜¯ SM ä¸Šçš„å¯ç¼–ç¨‹ç¼“å­˜ï¼š</p><ul><li><strong>Block å†…æ‰€æœ‰çº¿ç¨‹å…±äº«</strong>ï¼šåŒ Block çš„çº¿ç¨‹å¯ä»¥è¯»å†™åŒä¸€å—å…±äº«å†…å­˜</li><li><strong>ç”Ÿå‘½å‘¨æœŸä¸ Block ç»‘å®š</strong>ï¼šBlock ç»“æŸï¼Œå…±äº«å†…å­˜é‡Šæ”¾</li><li><strong>ä½å»¶è¿Ÿ</strong>ï¼šçº¦ 20 å‘¨æœŸï¼Œæ¯”å…¨å±€å†…å­˜å¿« 20 å€</li></ul><h3 id="sheng-ming-yu-fa" tabindex="-1" id="å£°æ˜è¯­æ³•">å£°æ˜è¯­æ³•</h3><p><strong>é™æ€åˆ†é…</strong>ï¼ˆç¼–è¯‘æ—¶ç¡®å®šå¤§å°ï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__global__ void kernel() &#123;</span><br><span class="line">    __shared__ float sharedData[256];  // Block å†…å…±äº«</span><br><span class="line">    // ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>åŠ¨æ€åˆ†é…</strong>ï¼ˆè¿è¡Œæ—¶ç¡®å®šå¤§å°ï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">__global__ void kernel() &#123;</span><br><span class="line">    extern __shared__ float sharedData[];  // å¤§å°ç”±å¯åŠ¨é…ç½®æŒ‡å®š</span><br><span class="line">    // ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// å¯åŠ¨æ—¶æŒ‡å®šå…±äº«å†…å­˜å¤§å°</span><br><span class="line">kernel&lt;&lt;&lt;grid, block, sharedMemBytes&gt;&gt;&gt;(args);</span><br></pre></td></tr></table></figure><h3 id="tong-bu-syncthreads" tabindex="-1" id="åŒæ­¥ï¼š-syncthreads">åŒæ­¥ï¼š__syncthreads()</h3><p>å…±äº«å†…å­˜æ˜¯ Block å†…å…±äº«çš„ï¼Œéœ€è¦åŒæ­¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">__shared__ float data[256];</span><br><span class="line"></span><br><span class="line">// é˜¶æ®µ1ï¼šæ‰€æœ‰çº¿ç¨‹å†™å…¥</span><br><span class="line">data[threadIdx.x] = input[globalIdx];</span><br><span class="line"></span><br><span class="line">__syncthreads();  // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆå†™å…¥</span><br><span class="line"></span><br><span class="line">// é˜¶æ®µ2ï¼šæ‰€æœ‰çº¿ç¨‹è¯»å–ï¼ˆæ­¤æ—¶æ•°æ®å·²å°±ç»ªï¼‰</span><br><span class="line">float val = data[(threadIdx.x + 1) % 256];</span><br></pre></td></tr></table></figure><p><strong>__syncthreads() æ˜¯æ …æ åŒæ­¥</strong>ï¼šBlock å†…æ‰€æœ‰çº¿ç¨‹å¿…é¡»åˆ°è¾¾è¿™ä¸€ç‚¹ï¼Œæ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚</p><p><strong>å¸¸è§é”™è¯¯</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// å±é™©ï¼æ¡ä»¶å†…ä½¿ç”¨ syncthreads</span><br><span class="line">if (threadIdx.x &lt; 128) &#123;</span><br><span class="line">    data[threadIdx.x] = ...;</span><br><span class="line">    __syncthreads();  // åªæœ‰éƒ¨åˆ†çº¿ç¨‹æ‰§è¡Œï¼Œä¼šæ­»é”ï¼</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒæ­¥å¿…é¡»ä¿è¯ Block å†…æ‰€æœ‰æ´»è·ƒçº¿ç¨‹éƒ½æ‰§è¡Œåˆ°ã€‚</p><h2 id="tiling-fen-kuai-chu-li" tabindex="-1" id="Tilingï¼šåˆ†å—å¤„ç†">Tilingï¼šåˆ†å—å¤„ç†</h2><h3 id="he-xin-si-xiang" tabindex="-1" id="æ ¸å¿ƒæ€æƒ³">æ ¸å¿ƒæ€æƒ³</h3><p>æ—¢ç„¶å…¨å±€å†…å­˜æ…¢ä½†å…±äº«å†…å­˜å¿«ï¼Œç­–ç•¥å°±æ˜¯ï¼š</p><ol><li><strong>åˆ†å—åŠ è½½</strong>ï¼šå°†æ•°æ®åˆ†æˆå°å—ï¼ˆTileï¼‰ï¼Œé€å—åŠ è½½åˆ°å…±äº«å†…å­˜</li><li><strong>è®¡ç®—å¤ç”¨</strong>ï¼šåœ¨å…±äº«å†…å­˜ä¸­å®Œæˆè¯¥å—çš„æ‰€æœ‰è®¡ç®—</li><li><strong>ç§»åŠ¨çª—å£</strong>ï¼šå¤„ç†ä¸‹ä¸€å—ï¼Œç›´åˆ°å®Œæˆ</li></ol><p>è¿™æ ·ï¼Œæ¯ä¸ªæ•°æ®ä»å…¨å±€å†…å­˜åªè¯»ä¸€æ¬¡ï¼Œä½†åœ¨å…±äº«å†…å­˜ä¸­è¢«å¤šæ¬¡ä½¿ç”¨ã€‚</p><h3 id="tiled-ju-zhen-cheng-fa" tabindex="-1" id="Tiled-çŸ©é˜µä¹˜æ³•">Tiled çŸ©é˜µä¹˜æ³•</h3><p><strong>é—®é¢˜</strong>ï¼šè®¡ç®— P = M Ã— Nï¼Œæ¯ä¸ª P[i][j] = Î£ M[i][k] Ã— N[k][j]</p><p><strong>æœ´ç´ ç‰ˆæœ¬</strong>ï¼šæ¯ä¸ªçº¿ç¨‹ç‹¬ç«‹è¯»å–æ•´è¡Œå’Œæ•´åˆ—ï¼ˆå¤§é‡é‡å¤è¯»å–ï¼‰</p><p><strong>Tiled ç‰ˆæœ¬</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚   M çŸ©é˜µ       â”‚   â”‚   N çŸ©é˜µ       â”‚</span><br><span class="line">â”‚  â”Œâ”€â”€â”€â”        â”‚   â”‚      â”Œâ”€â”€â”€â”    â”‚</span><br><span class="line">â”‚  â”‚Tileâ”‚ â”€â”€â”€â”€â†’ â”‚   â”‚      â”‚Tileâ”‚   â”‚</span><br><span class="line">â”‚  â””â”€â”€â”€â”˜        â”‚   â”‚      â””â”€â”€â”€â”˜    â”‚</span><br><span class="line">â”‚               â”‚   â”‚        â”‚      â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">                             â†“</span><br><span class="line">                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">                    â”‚   P çŸ©é˜µ       â”‚</span><br><span class="line">                    â”‚      â”Œâ”€â”€â”€â”    â”‚</span><br><span class="line">                    â”‚      â”‚è®¡ç®—â”‚    â”‚</span><br><span class="line">                    â”‚      â””â”€â”€â”€â”˜    â”‚</span><br><span class="line">                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure><p><strong>æ­¥éª¤</strong>ï¼š</p><ol><li>å°† M çš„ä¸€ä¸ª Tile å’Œ N çš„ä¸€ä¸ª Tile åŠ è½½åˆ°å…±äº«å†…å­˜</li><li>Block å†…æ‰€æœ‰çº¿ç¨‹ä½¿ç”¨å…±äº«å†…å­˜ä¸­çš„æ•°æ®è¿›è¡Œéƒ¨åˆ†è®¡ç®—</li><li>åŠ è½½ä¸‹ä¸€å¯¹ Tileï¼Œç´¯åŠ ç»“æœ</li><li>é‡å¤ç›´åˆ°å®Œæˆ</li></ol><h3 id="dai-ma-shi-xian" tabindex="-1" id="ä»£ç å®ç°">ä»£ç å®ç°</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">#define TILE_WIDTH 16</span><br><span class="line"></span><br><span class="line">__global__ void matMulTiled(float *M, float *N, float *P, int width) &#123;</span><br><span class="line">    // å…±äº«å†…å­˜å£°æ˜</span><br><span class="line">    __shared__ float Mds[TILE_WIDTH][TILE_WIDTH];</span><br><span class="line">    __shared__ float Nds[TILE_WIDTH][TILE_WIDTH];</span><br><span class="line">    </span><br><span class="line">    int bx = blockIdx.x, by = blockIdx.y;</span><br><span class="line">    int tx = threadIdx.x, ty = threadIdx.y;</span><br><span class="line">    </span><br><span class="line">    // è®¡ç®—è¯¥çº¿ç¨‹è´Ÿè´£çš„ P å…ƒç´ ä½ç½®</span><br><span class="line">    int row = by * TILE_WIDTH + ty;</span><br><span class="line">    int col = bx * TILE_WIDTH + tx;</span><br><span class="line">    </span><br><span class="line">    float Pvalue = 0;</span><br><span class="line">    </span><br><span class="line">    // åˆ†å—å¾ªç¯</span><br><span class="line">    for (int ph = 0; ph &lt; width / TILE_WIDTH; ++ph) &#123;</span><br><span class="line">        </span><br><span class="line">        // åä½œåŠ è½½ M çš„ Tile</span><br><span class="line">        Mds[ty][tx] = M[row * width + (ph * TILE_WIDTH + tx)];</span><br><span class="line">        </span><br><span class="line">        // åä½œåŠ è½½ N çš„ Tile</span><br><span class="line">        Nds[ty][tx] = N[(ph * TILE_WIDTH + ty) * width + col];</span><br><span class="line">        </span><br><span class="line">        __syncthreads();  // ç¡®ä¿ Tile åŠ è½½å®Œæˆ</span><br><span class="line">        </span><br><span class="line">        // ä½¿ç”¨å…±äº«å†…å­˜è®¡ç®—éƒ¨åˆ†ç‚¹ç§¯</span><br><span class="line">        for (int k = 0; k &lt; TILE_WIDTH; ++k) &#123;</span><br><span class="line">            Pvalue += Mds[ty][k] * Nds[k][tx];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        __syncthreads();  // ç¡®ä¿è®¡ç®—å®Œæˆå†åŠ è½½ä¸‹ä¸€ä¸ª Tile</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    P[row * width + col] = Pvalue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="guan-jian-dian-jie-xi" tabindex="-1" id="å…³é”®ç‚¹è§£æ">å…³é”®ç‚¹è§£æ</h3><p><strong>1. åä½œåŠ è½½</strong></p><p>Block å†…çš„çº¿ç¨‹åˆ†å·¥åŠ è½½ Tileï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Mds[ty][tx] = M[row * width + (ph * TILE_WIDTH + tx)];</span><br></pre></td></tr></table></figure><p>æ¯ä¸ªçº¿ç¨‹åŠ è½½ä¸€ä¸ªå…ƒç´ ï¼Œ16Ã—16 = 256 ä¸ªçº¿ç¨‹åŠ è½½ 256 ä¸ªå…ƒç´ ã€‚æ¯”å•çº¿ç¨‹åŠ è½½æ•´ä¸ª Tile é«˜æ•ˆå¾—å¤šã€‚</p><p><strong>2. ä¸¤æ¬¡åŒæ­¥</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">__syncthreads();  // ç¬¬ä¸€æ¬¡ï¼šç¡®ä¿æ•°æ®åŠ è½½å®Œæˆ</span><br><span class="line">// ... è®¡ç®— ...</span><br><span class="line">__syncthreads();  // ç¬¬äºŒæ¬¡ï¼šç¡®ä¿è®¡ç®—å®Œæˆå†è¦†ç›–å…±äº«å†…å­˜</span><br></pre></td></tr></table></figure><p>ä¸¤æ¬¡åŒæ­¥éƒ½å¿…è¦ï¼š</p><ul><li>ç¬¬ä¸€æ¬¡ï¼šé˜²æ­¢è¯»åˆ°æœªåŠ è½½çš„æ•°æ®</li><li>ç¬¬äºŒæ¬¡ï¼šé˜²æ­¢å¿«çº¿ç¨‹è¦†ç›–æ…¢çº¿ç¨‹è¿˜åœ¨ç”¨çš„æ•°æ®</li></ul><p><strong>3. å†…å±‚å¾ªç¯</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for (int k = 0; k &lt; TILE_WIDTH; ++k) &#123;</span><br><span class="line">    Pvalue += Mds[ty][k] * Nds[k][tx];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå¾ªç¯åªè®¿é—®å…±äº«å†…å­˜ï¼Œæ²¡æœ‰å…¨å±€å†…å­˜è®¿é—®ã€‚è¿™æ˜¯æ€§èƒ½æå‡çš„æ¥æºã€‚</p><h3 id="xing-neng-fen-xi" tabindex="-1" id="æ€§èƒ½åˆ†æ">æ€§èƒ½åˆ†æ</h3><p><strong>æœ´ç´ ç‰ˆæœ¬</strong>ï¼š</p><ul><li>æ¯çº¿ç¨‹è¯»å–å…¨å±€å†…å­˜ï¼š2 Ã— width æ¬¡</li><li>æ€»å…¨å±€å†…å­˜è®¿é—®ï¼šwidthÂ³ Ã— 2ï¼ˆè¯»ï¼‰+ widthÂ²ï¼ˆå†™ï¼‰</li></ul><p><strong>Tiled ç‰ˆæœ¬</strong>ï¼š</p><ul><li>æ¯ Tile é˜¶æ®µï¼šBlock è¯» 2 Ã— TILE_WIDTHÂ² ä¸ªå…ƒç´ </li><li>å…± width/TILE_WIDTH ä¸ªé˜¶æ®µ</li><li>æ¯çº¿ç¨‹è´¡çŒ®ï¼š2 Ã— width æ¬¡ï¼ˆä¸æœ´ç´ ç›¸åŒï¼Ÿä¸å¯¹ï¼ï¼‰</li></ul><p><strong>å…³é”®å·®å¼‚</strong>ï¼šåœ¨ Tiled ç‰ˆæœ¬ä¸­ï¼Œæ¯ä¸ªå…¨å±€å†…å­˜è¯»å–è¢« TILE_WIDTH ä¸ªçº¿ç¨‹å…±äº«ä½¿ç”¨ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">å…¨å±€å†…å­˜è®¿é—®å‡å°‘å€æ•° = TILE_WIDTH</span><br><span class="line">ç®—æœ¯å¼ºåº¦æå‡ = TILE_WIDTH å€</span><br></pre></td></tr></table></figure><p>TILE_WIDTH = 16 æ—¶ï¼Œç®—æœ¯å¼ºåº¦ä» 0.25 æå‡åˆ° 4 FLOP/Byteã€‚TILE_WIDTH = 32 æ—¶å¯è¾¾ 8 FLOP/Byteã€‚</p><h3 id="bian-jie-chu-li" tabindex="-1" id="è¾¹ç•Œå¤„ç†">è¾¹ç•Œå¤„ç†</h3><p>ä¸Šé¢çš„ä»£ç å‡è®¾ width æ˜¯ TILE_WIDTH çš„å€æ•°ã€‚å®é™…éœ€è¦å¤„ç†è¾¹ç•Œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// å¸¦è¾¹ç•Œæ£€æŸ¥çš„åŠ è½½</span><br><span class="line">if (row &lt; width &amp;&amp; (ph * TILE_WIDTH + tx) &lt; width)</span><br><span class="line">    Mds[ty][tx] = M[row * width + (ph * TILE_WIDTH + tx)];</span><br><span class="line">else</span><br><span class="line">    Mds[ty][tx] = 0;  // è¶Šç•Œå…ƒç´ å¡«0</span><br><span class="line"></span><br><span class="line">if ((ph * TILE_WIDTH + ty) &lt; width &amp;&amp; col &lt; width)</span><br><span class="line">    Nds[ty][tx] = N[(ph * TILE_WIDTH + ty) * width + col];</span><br><span class="line">else</span><br><span class="line">    Nds[ty][tx] = 0;</span><br></pre></td></tr></table></figure><p>å¡« 0 ä¸å½±å“åŠ æ³•ç»“æœï¼Œæ˜¯å¤„ç†è¾¹ç•Œçš„å¸¸ç”¨æŠ€å·§ã€‚</p><h2 id="nei-cun-fang-wen-mo-shi" tabindex="-1" id="å†…å­˜è®¿é—®æ¨¡å¼">å†…å­˜è®¿é—®æ¨¡å¼</h2><h3 id="he-bing-fang-wen-coalesced-access" tabindex="-1" id="åˆå¹¶è®¿é—®ï¼ˆCoalesced-Accessï¼‰">åˆå¹¶è®¿é—®ï¼ˆCoalesced Accessï¼‰</h3><p>GPU å†…å­˜æ§åˆ¶å™¨æŒ‰ <strong>32 å­—èŠ‚æˆ– 128 å­—èŠ‚</strong> çš„äº‹åŠ¡è¯»å†™æ•°æ®ã€‚å¦‚æœ Warp ä¸­çš„çº¿ç¨‹è®¿é—®è¿ç»­åœ°å€ï¼Œå¯ä»¥åˆå¹¶æˆä¸€æ¬¡äº‹åŠ¡ï¼š</p><p><strong>å¥½çš„è®¿é—®æ¨¡å¼</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// çº¿ç¨‹ 0,1,2,...,31 è®¿é—®è¿ç»­åœ°å€</span><br><span class="line">data[threadIdx.x];  // ä¸€æ¬¡ 128B äº‹åŠ¡</span><br></pre></td></tr></table></figure><p><strong>å·®çš„è®¿é—®æ¨¡å¼</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// çº¿ç¨‹ 0,1,2,...,31 è®¿é—®è·¨æ­¥åœ°å€</span><br><span class="line">data[threadIdx.x * 32];  // 32 æ¬¡äº‹åŠ¡ï¼</span><br></pre></td></tr></table></figure><p><strong>çŸ©é˜µè®¿é—®çš„é™·é˜±</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// P[i][j] éå†</span><br><span class="line">// æŒ‰è¡Œéå†ï¼ˆå¥½ï¼‰ï¼šdata[row * width + col]ï¼Œcol è¿ç»­</span><br><span class="line">// æŒ‰åˆ—éå†ï¼ˆå·®ï¼‰ï¼šdata[row * width + col]ï¼Œrow è¿ç»­ï¼ˆè·¨æ­¥ = widthï¼‰</span><br></pre></td></tr></table></figure><h3 id="gong-xiang-nei-cun-bank-chong-tu" tabindex="-1" id="å…±äº«å†…å­˜-Bank-å†²çª">å…±äº«å†…å­˜ Bank å†²çª</h3><p>å…±äº«å†…å­˜åˆ†æˆ 32 ä¸ª <strong>Bank</strong>ï¼Œæ¯ä¸ª Bank å®½åº¦ 4 å­—èŠ‚ã€‚ä¸åŒ Bank å¯ä»¥åŒæ—¶è®¿é—®ï¼Œä½†åŒä¸€ Bank çš„ä¸åŒåœ°å€ä¼šä¸²è¡ŒåŒ–ã€‚</p><p><strong>Bank æ˜ å°„</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">åœ°å€ 0,32,64,...  â†’ Bank 0</span><br><span class="line">åœ°å€ 4,36,68,...  â†’ Bank 1</span><br><span class="line">åœ°å€ 8,40,72,...  â†’ Bank 2</span><br><span class="line">...</span><br><span class="line">åœ°å€ 124,156,... â†’ Bank 31</span><br></pre></td></tr></table></figure><p><strong>æ— å†²çª</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">data[threadIdx.x];      // 32 çº¿ç¨‹è®¿é—® 32 ä¸ª Bank</span><br><span class="line">data[threadIdx.x * 2];  // è·¨æ­¥ 2ï¼Œè®¿é—® Bank 0,2,4,...ï¼ˆæ— å†²çªï¼‰</span><br></pre></td></tr></table></figure><p><strong>æœ‰å†²çª</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data[threadIdx.x * 32]; // æ‰€æœ‰çº¿ç¨‹è®¿é—® Bank 0ï¼32-way å†²çª</span><br></pre></td></tr></table></figure><p><strong>ç‰¹ä¾‹â€”â€”å¹¿æ’­</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data[0];  // æ‰€æœ‰çº¿ç¨‹è¯»åŒä¸€åœ°å€ï¼Œç¡¬ä»¶å¹¿æ’­ï¼Œæ— å†²çª</span><br></pre></td></tr></table></figure><h3 id="ju-zhen-zhuan-zhi-de-bank-chong-tu" tabindex="-1" id="çŸ©é˜µè½¬ç½®çš„-Bank-å†²çª">çŸ©é˜µè½¬ç½®çš„ Bank å†²çª</h3><p>è€ƒè™‘å…±äº«å†…å­˜ä¸­ 16Ã—16 çš„çŸ©é˜µï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">__shared__ float tile[16][16];</span><br><span class="line"></span><br><span class="line">// åŠ è½½ï¼ˆåˆ—è®¿é—®ï¼‰</span><br><span class="line">tile[ty][tx] = input[row * width + col];  // æ— å†²çª</span><br><span class="line"></span><br><span class="line">// å­˜å‚¨ï¼ˆè¡Œè®¿é—®ï¼‰</span><br><span class="line">output[col * width + row] = tile[tx][ty];  // æœ‰å†²çªï¼</span><br></pre></td></tr></table></figure><p><code>tile[tx][ty]</code> ä½¿å¾—çº¿ç¨‹ 0,1,2,â€¦,15 åˆ†åˆ«è®¿é—® tile[0][ty], tile[1][ty], â€¦ï¼Œè¿™äº›å…ƒç´ åœ°å€ä¸º ty, ty+16, ty+32, â€¦ï¼Œæ­¥é•¿ 16Ã—4 = 64 å­—èŠ‚ = 16 ä¸ª Bankã€‚éƒ¨åˆ†çº¿ç¨‹ä¼šè®¿é—®åŒä¸€ Bankã€‚</p><p><strong>è§£å†³æ–¹æ¡ˆâ€”â€”Padding</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__shared__ float tile[16][17];  // å¤šåŠ ä¸€åˆ—</span><br><span class="line"></span><br><span class="line">// ç°åœ¨ tile[i][j] çš„åœ°å€æ˜¯ i*17 + j</span><br><span class="line">// æ­¥é•¿å˜æˆ 17Ã—4 = 68 å­—èŠ‚ï¼Œä¸å†å¯¹é½</span><br></pre></td></tr></table></figure><p>Padding æ‰“ç ´äº† Bank å¯¹é½ï¼Œæ¶ˆé™¤å†²çªã€‚ä»£ä»·æ˜¯æµªè´¹ä¸€ç‚¹å…±äº«å†…å­˜ã€‚</p><h2 id="chang-liang-nei-cun-constant-memory" tabindex="-1" id="å¸¸é‡å†…å­˜ï¼ˆConstant-Memoryï¼‰">å¸¸é‡å†…å­˜ï¼ˆConstant Memoryï¼‰</h2><h3 id="te-dian" tabindex="-1" id="ç‰¹ç‚¹">ç‰¹ç‚¹</h3><ul><li><strong>åªè¯»</strong>ï¼šKernel å†…ä¸èƒ½å†™</li><li><strong>ç¼“å­˜ä¼˜åŒ–</strong>ï¼šæœ‰ä¸“ç”¨ç¼“å­˜ï¼Œå¹¿æ’­è®¿é—®æ•ˆç‡é«˜</li><li><strong>å®¹é‡æœ‰é™</strong>ï¼š64 KB</li></ul><h3 id="gua-yong-chang-jing" tabindex="-1" id="é€‚ç”¨åœºæ™¯">é€‚ç”¨åœºæ™¯</h3><p>æ‰€æœ‰çº¿ç¨‹è¯»ç›¸åŒæ•°æ®ï¼ˆå¦‚å·ç§¯æ ¸ã€å˜æ¢çŸ©é˜µï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">__constant__ float kernel[9];  // å£°æ˜</span><br><span class="line"></span><br><span class="line">// Host ç«¯å†™å…¥</span><br><span class="line">cudaMemcpyToSymbol(kernel, h_kernel, 9 * sizeof(float));</span><br><span class="line"></span><br><span class="line">// Kernel å†…ä½¿ç”¨</span><br><span class="line">__global__ void conv(...) &#123;</span><br><span class="line">    float sum = 0;</span><br><span class="line">    for (int i = 0; i &lt; 9; i++) &#123;</span><br><span class="line">        sum += data[i] * kernel[i];  // æ‰€æœ‰çº¿ç¨‹è¯»ç›¸åŒ kernel[i]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæ¯ä¸ªçº¿ç¨‹è¯»ä¸åŒåœ°å€ï¼Œå¸¸é‡å†…å­˜åè€Œæ›´æ…¢ï¼ˆä¸²è¡ŒåŒ–ï¼‰ã€‚</p><h2 id="ji-cun-qi-you-hua" tabindex="-1" id="å¯„å­˜å™¨ä¼˜åŒ–">å¯„å­˜å™¨ä¼˜åŒ–</h2><h3 id="ji-cun-qi-de-zhong-yao-xing" tabindex="-1" id="å¯„å­˜å™¨çš„é‡è¦æ€§">å¯„å­˜å™¨çš„é‡è¦æ€§</h3><p>å¯„å­˜å™¨æ˜¯æœ€å¿«çš„å­˜å‚¨ï¼Œå•å‘¨æœŸå»¶è¿Ÿã€‚ä½†æ•°é‡æœ‰é™ï¼ˆæ¯ SM çº¦ 64K ä¸ªï¼‰ï¼Œè¿‡åº¦ä½¿ç”¨ä¼šå¯¼è‡´ï¼š</p><ol><li><strong>å¯„å­˜å™¨æº¢å‡ºï¼ˆSpillingï¼‰</strong>ï¼šæº¢å‡ºåˆ° Local Memoryï¼ˆå®é™…æ˜¯å…¨å±€å†…å­˜ï¼‰ï¼Œææ…¢</li><li><strong>å ç”¨ç‡ä¸‹é™</strong>ï¼šæ¯çº¿ç¨‹ç”¨æ›´å¤šå¯„å­˜å™¨ï¼ŒSM èƒ½å®¹çº³çš„çº¿ç¨‹æ•°å‡å°‘</li></ol><h3 id="cha-kan-ji-cun-qi-shi-yong" tabindex="-1" id="æŸ¥çœ‹å¯„å­˜å™¨ä½¿ç”¨">æŸ¥çœ‹å¯„å­˜å™¨ä½¿ç”¨</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvcc --ptxas-options=-v kernel.cu</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ptxas info: Used 32 registers, ...</span><br></pre></td></tr></table></figure><h3 id="kong-zhi-ce-lue" tabindex="-1" id="æ§åˆ¶ç­–ç•¥">æ§åˆ¶ç­–ç•¥</h3><p><strong>ç¼–è¯‘å™¨æç¤º</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__global__ void __launch_bounds__(256, 4) kernel(...) &#123;</span><br><span class="line">    // å‘Šè¯‰ç¼–è¯‘å™¨ï¼šæ¯ Block 256 çº¿ç¨‹ï¼Œæ¯ SM è‡³å°‘ 4 ä¸ª Block</span><br><span class="line">    // ç¼–è¯‘å™¨æ®æ­¤ä¼˜åŒ–å¯„å­˜å™¨åˆ†é…</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç¼–è¯‘é€‰é¡¹</strong>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvcc -maxrregcount=32 kernel.cu  <span class="comment"># é™åˆ¶æ¯çº¿ç¨‹æœ€å¤š 32 ä¸ªå¯„å­˜å™¨</span></span><br></pre></td></tr></table></figure><p><strong>æƒè¡¡</strong>ï¼šé™åˆ¶è¿‡ä¸¥å¯èƒ½å¯¼è‡´æº¢å‡ºï¼Œé™åˆ¶è¿‡æ¾å¯èƒ½é™ä½å ç”¨ç‡ã€‚éœ€è¦å®æµ‹ã€‚</p><h2 id="shu-ju-ju-bu-xing-you-hua-qing-dan" tabindex="-1" id="æ•°æ®å±€éƒ¨æ€§ä¼˜åŒ–æ¸…å•">æ•°æ®å±€éƒ¨æ€§ä¼˜åŒ–æ¸…å•</h2><h3 id="kong-jian-ju-bu-xing" tabindex="-1" id="ç©ºé—´å±€éƒ¨æ€§">ç©ºé—´å±€éƒ¨æ€§</h3><p><strong>å®šä¹‰</strong>ï¼šè®¿é—®çš„æ•°æ®åœ¨å†…å­˜ä¸­ç›¸é‚»</p><p><strong>ä¼˜åŒ–æ‰‹æ®µ</strong>ï¼š</p><ul><li>è¿ç»­è®¿é—®ï¼Œåˆ©ç”¨åˆå¹¶</li><li>æ•°æ®å¸ƒå±€ä¼˜åŒ–ï¼ˆAoS â†’ SoAï¼‰</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// Array of Structuresï¼ˆå·®ï¼‰</span><br><span class="line">struct Particle &#123; float x, y, z; &#125;;</span><br><span class="line">Particle particles[N];</span><br><span class="line">particles[i].x;  // è·¨æ­¥ 12 å­—èŠ‚</span><br><span class="line"></span><br><span class="line">// Structure of Arraysï¼ˆå¥½ï¼‰</span><br><span class="line">struct Particles &#123; float x[N], y[N], z[N]; &#125;;</span><br><span class="line">Particles p;</span><br><span class="line">p.x[i];  // è¿ç»­è®¿é—®</span><br></pre></td></tr></table></figure><h3 id="shi-jian-ju-bu-xing" tabindex="-1" id="æ—¶é—´å±€éƒ¨æ€§">æ—¶é—´å±€éƒ¨æ€§</h3><p><strong>å®šä¹‰</strong>ï¼šåŒä¸€æ•°æ®çŸ­æœŸå†…è¢«å¤šæ¬¡è®¿é—®</p><p><strong>ä¼˜åŒ–æ‰‹æ®µ</strong>ï¼š</p><ul><li>Tiling åˆ°å…±äº«å†…å­˜/å¯„å­˜å™¨</li><li>å¾ªç¯åˆ†å—</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// æ— æ—¶é—´å±€éƒ¨æ€§</span><br><span class="line">for (int k = 0; k &lt; N; k++) &#123;</span><br><span class="line">    C[i][j] += A[i][k] * B[k][j];  // Aã€B æ¯æ¬¡ä»å…¨å±€å†…å­˜è¯»</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æœ‰æ—¶é—´å±€éƒ¨æ€§ï¼ˆTiledï¼‰</span><br><span class="line">for (int tile = 0; tile &lt; N/TILE; tile++) &#123;</span><br><span class="line">    // åŠ è½½ tile åˆ°å…±äº«å†…å­˜</span><br><span class="line">    for (int k = 0; k &lt; TILE; k++) &#123;</span><br><span class="line">        C[i][j] += As[ty][k] * Bs[k][tx];  // ä»å…±äº«å†…å­˜è¯»ï¼Œå¤ç”¨</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="shi-zhan-you-hua-hou-de-ju-zhen-cheng-fa-xing-neng" tabindex="-1" id="å®æˆ˜ï¼šä¼˜åŒ–åçš„çŸ©é˜µä¹˜æ³•æ€§èƒ½">å®æˆ˜ï¼šä¼˜åŒ–åçš„çŸ©é˜µä¹˜æ³•æ€§èƒ½</h2><p>ä»¥ 1024Ã—1024 çŸ©é˜µä¸ºä¾‹ï¼š</p><table><thead><tr><th>ç‰ˆæœ¬</th><th>å…¨å±€å†…å­˜è®¿é—®</th><th>ç®—æœ¯å¼ºåº¦</th><th>ç›¸å¯¹æ€§èƒ½</th></tr></thead><tbody><tr><td>æœ´ç´ </td><td>2Ã—10â¹ æ¬¡</td><td>0.25</td><td>1Ã—</td></tr><tr><td>Tiled (16Ã—16)</td><td>1.25Ã—10â¸ æ¬¡</td><td>4</td><td>~8Ã—</td></tr><tr><td>Tiled (32Ã—32)</td><td>6.25Ã—10â· æ¬¡</td><td>8</td><td>~12Ã—</td></tr><tr><td>+ å¯„å­˜å™¨ä¼˜åŒ–</td><td>æ›´å°‘</td><td>16+</td><td>~20Ã—</td></tr></tbody></table><p>å®é™…æå‡å–å†³äºå…·ä½“ GPU å’Œé—®é¢˜è§„æ¨¡ï¼Œä½† 10Ã— ä»¥ä¸Šæ˜¯å¸¸è§çš„ã€‚</p><h2 id="xiao-jie" tabindex="-1" id="å°ç»“">å°ç»“</h2><p>ç¬¬äº”ç« æ˜¯æ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒï¼š</p><p><strong>å†…å­˜å±‚æ¬¡è®¤çŸ¥</strong>ï¼šå¯„å­˜å™¨â†’å…±äº«å†…å­˜â†’L2â†’å…¨å±€å†…å­˜ï¼Œé€Ÿåº¦å·® 100 å€ä»¥ä¸Šã€‚å†™é«˜æ€§èƒ½ä»£ç å°±æ˜¯è®©çƒ­æ•°æ®ç•™åœ¨å¿«å­˜å‚¨ã€‚</p><p><strong>å…±äº«å†…å­˜æœ¬è´¨</strong>ï¼šç¨‹åºå‘˜å¯æ§çš„ Block çº§ç¼“å­˜ã€‚å£°æ˜ç®€å•ï¼Œä½†éœ€è¦æ­£ç¡®åŒæ­¥ã€‚ä¸¤æ¬¡ __syncthreads() åˆ«å¿˜ã€‚</p><p><strong>Tiling æ ¸å¿ƒ</strong>ï¼šåˆ†å—åŠ è½½ï¼Œå—å†…å¤ç”¨ã€‚çŸ©é˜µä¹˜æ³•ä» 0.25 æå‡åˆ° 8+ FLOP/Byteï¼Œè¿™æ˜¯å®æ‰“å®çš„ 10Ã— åŠ é€Ÿã€‚</p><p><strong>è®¿é—®æ¨¡å¼</strong>ï¼š</p><ul><li>å…¨å±€å†…å­˜è¦åˆå¹¶è®¿é—®</li><li>å…±äº«å†…å­˜è¦é¿å… Bank å†²çª</li><li>å¿…è¦æ—¶ç”¨ Padding</li></ul><p><strong>å±€éƒ¨æ€§åŸåˆ™</strong>ï¼šç©ºé—´å±€éƒ¨æ€§ï¼ˆè¿ç»­è®¿é—®ï¼‰ï¼Œæ—¶é—´å±€éƒ¨æ€§ï¼ˆé‡å¤ä½¿ç”¨ï¼‰ã€‚Tiling åŒæ—¶åˆ©ç”¨äº†ä¸¤è€…ã€‚</p><p>æŒæ¡äº†å†…å­˜ä¼˜åŒ–ï¼ŒGPU çš„è®¡ç®—èƒ½åŠ›æ‰èƒ½çœŸæ­£å‘æŒ¥ã€‚ä¸‹ä¸€ç« ä¼šå­¦ä¹ æ›´å¤šè®¡ç®—æ¨¡å¼â€”â€”å·ç§¯ã€è§„çº¦ã€å‰ç¼€å’Œï¼Œè¿™äº›éƒ½éœ€è¦ç²¾å¿ƒè®¾è®¡çš„å†…å­˜è®¿é—®ç­–ç•¥ã€‚</p><hr><p><strong>å‚è€ƒèµ„æ–™ï¼š</strong></p><ul><li>Hwu, W., Kirk, D., &amp; El Hajj, I. (2022). <em>Programming Massively Parallel Processors: A Hands-on Approach</em> (4th Edition). Morgan Kaufmann.</li><li><a href="https://docs.nvidia.com/cuda/cuda-c-programming-guide/index.html#memory-hierarchy">CUDA C++ Programming Guide - Memory Model</a></li><li><a href="https://docs.nvidia.com/cuda/cuda-c-best-practices-guide/">CUDA Best Practices Guide</a></li></ul><hr><blockquote><p><strong>æœ¬æ–‡ GitHub ä»“åº“</strong>: <a href="https://github.com/psmarter/PMPP-Learning">https://github.com/psmarter/PMPP-Learning</a></p></blockquote>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;qian-yan&quot; tabindex=&quot;-1&quot; id=&quot;å‰è¨€&quot;&gt;å‰è¨€&lt;/h2&gt;
&lt;p&gt;ç¬¬å››ç« ç†è§£äº†GPUçš„è°ƒåº¦æœºåˆ¶å’Œç¡¬ä»¶æ¶æ„ï¼Œè¿™ä¸€ç« è¿›å…¥æ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒâ€”â€”å†…å­˜ã€‚GPUè®¡ç®—èƒ½åŠ›å¼ºå¤§ï¼Œä½†æ•°æ®ä¾›åº”è·Ÿä¸ä¸Šå°±ç™½æ­ã€‚ç¬¬äº”ç« è®²è§£GPUçš„å†…å­˜å±‚æ¬¡ç»“æ„ï¼Œé‡ç‚¹æ˜¯Shared</summary>
        
      
    
    
    
    <category term="çŸ¥è¯†åˆ†äº«" scheme="https://smarter.xin/categories/knowledge-sharing/"/>
    
    
    <category term="CUDA" scheme="https://smarter.xin/tags/CUDA/"/>
    
    <category term="GPUç¼–ç¨‹" scheme="https://smarter.xin/tags/gpu-programming/"/>
    
    <category term="å¹¶è¡Œè®¡ç®—" scheme="https://smarter.xin/tags/parallel-computing/"/>
    
    <category term="PMPP" scheme="https://smarter.xin/tags/PMPP/"/>
    
    <category term="Tiling" scheme="https://smarter.xin/tags/Tiling/"/>
    
    <category term="å…±äº«å†…å­˜" scheme="https://smarter.xin/tags/shared-memory/"/>
    
  </entry>
  
  <entry>
    <title>PMPP-ç¬¬å››ç« ï¼šè®¡ç®—æ¶æ„å’Œè°ƒåº¦</title>
    <link href="https://smarter.xin/posts/bd5d1d6/"/>
    <id>https://smarter.xin/posts/bd5d1d6/</id>
    <published>2026-01-15T05:08:55.000Z</published>
    <updated>2026-01-24T08:26:21.333Z</updated>
    
    <content type="html"><![CDATA[<h2 id="qian-yan" tabindex="-1" id="å‰è¨€">å‰è¨€</h2><p>å‰ä¸‰ç« æ‰“ä¸‹äº†åŸºç¡€ï¼šç¬¬ä¸€ç« ç†è§£&quot;ä¸ºä»€ä¹ˆç”¨GPU&quot;ï¼Œç¬¬äºŒç« å­¦ä¼š&quot;æ€ä¹ˆå†™kernel&quot;ï¼Œç¬¬ä¸‰ç« æŒæ¡&quot;å¤šç»´æ•°æ®å¤„ç†&quot;ã€‚ä½†åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬åªæ˜¯åœ¨ä½¿ç”¨GPUï¼Œè¿˜ä¸çœŸæ­£ç†è§£å®ƒã€‚ç¬¬å››ç« å¼€å§‹æ·±å…¥GPUå†…éƒ¨â€”â€”ç¡¬ä»¶æ¶æ„å¦‚ä½•å½±å“æ€§èƒ½ï¼Œçº¿ç¨‹æ˜¯æ€ä¹ˆè¢«è°ƒåº¦æ‰§è¡Œçš„ï¼Œä¸ºä»€ä¹ˆæœ‰äº›ä»£ç å¿«æœ‰äº›æ…¢ã€‚ç†è§£è¿™äº›ï¼Œæ‰ç®—çœŸæ­£å…¥é—¨GPUç¼–ç¨‹ã€‚</p><blockquote><p><strong>ğŸ“¦ é…å¥—èµ„æº</strong>ï¼šæœ¬ç³»åˆ—æ–‡ç« é…æœ‰å®Œæ•´çš„ <a href="https://github.com/psmarter/PMPP-Learning">GitHub ä»“åº“</a>ï¼ŒåŒ…å«æ¯ç« çš„ç»ƒä¹ é¢˜è§£ç­”ã€CUDA ä»£ç å®ç°å’Œè¯¦ç»†æ³¨é‡Šã€‚æ‰€æœ‰ä»£ç éƒ½ç»è¿‡æµ‹è¯•ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œã€‚</p></blockquote><h2 id="gpu-jia-gou-gai-lan" tabindex="-1" id="GPUæ¶æ„æ¦‚è§ˆ">GPUæ¶æ„æ¦‚è§ˆ</h2><h3 id="liu-shi-duo-chu-li-qi-sm" tabindex="-1" id="æµå¼å¤šå¤„ç†å™¨ï¼ˆSMï¼‰">æµå¼å¤šå¤„ç†å™¨ï¼ˆSMï¼‰</h3><p>GPUå¹¶ä¸æ˜¯ä¸€ä¸ªå·¨å¤§çš„å¤„ç†å™¨ï¼Œè€Œæ˜¯ç”±å¤šä¸ª**æµå¼å¤šå¤„ç†å™¨ï¼ˆStreaming Multiprocessor, SMï¼‰**ç»„æˆçš„é˜µåˆ—ã€‚æ¯ä¸ªSMæ˜¯ç›¸å¯¹ç‹¬ç«‹çš„æ‰§è¡Œå•å…ƒï¼Œå¯ä»¥åŒæ—¶è¿è¡Œå¤šä¸ªçº¿ç¨‹å—ã€‚</p><p>ä»¥NVIDIA Ampereæ¶æ„ï¼ˆå¦‚RTX 3080ï¼‰ä¸ºä¾‹ï¼š</p><table><thead><tr><th>ç»„ä»¶</th><th>æ•°é‡/è§„æ ¼</th></tr></thead><tbody><tr><td>SMæ•°é‡</td><td>68</td></tr><tr><td>æ¯SM CUDAæ ¸å¿ƒ</td><td>128</td></tr><tr><td>æ¯SMæœ€å¤§çº¿ç¨‹</td><td>1536</td></tr><tr><td>æ¯SMæœ€å¤§Block</td><td>16</td></tr><tr><td>å…±äº«å†…å­˜</td><td>æ¯SM 128KBå¯é…ç½®</td></tr><tr><td>L2ç¼“å­˜</td><td>5MB</td></tr></tbody></table><p>ä¸åŒæ¶æ„å‚æ•°ä¸åŒï¼Œä½†æ ¸å¿ƒæ€æƒ³ç›¸åŒï¼š<strong>å¤§é‡å°æ ¸å¿ƒå¹¶è¡Œå·¥ä½œ</strong>ã€‚</p><h3 id="sm-nei-bu-jie-gou" tabindex="-1" id="SMå†…éƒ¨ç»“æ„">SMå†…éƒ¨ç»“æ„</h3><p>æ¯ä¸ªSMåŒ…å«ï¼š</p><ol><li><strong>CUDAæ ¸å¿ƒ</strong>ï¼šæ‰§è¡Œæ•´æ•°å’Œå•ç²¾åº¦æµ®ç‚¹è¿ç®—</li><li><strong>Tensoræ ¸å¿ƒ</strong>ï¼šä¸“ç”¨çŸ©é˜µè¿ç®—ï¼ˆæ·±åº¦å­¦ä¹ åŠ é€Ÿï¼‰</li><li><strong>ç‰¹æ®ŠåŠŸèƒ½å•å…ƒï¼ˆSFUï¼‰</strong>ï¼šæ‰§è¡Œsin/cos/expç­‰è¶…è¶Šå‡½æ•°</li><li><strong>åŠ è½½/å­˜å‚¨å•å…ƒï¼ˆLD/STï¼‰</strong>ï¼šå¤„ç†å†…å­˜è®¿é—®</li><li><strong>Warpè°ƒåº¦å™¨</strong>ï¼šè°ƒåº¦çº¿ç¨‹æ‰§è¡Œ</li><li><strong>å¯„å­˜å™¨æ–‡ä»¶</strong>ï¼šå¿«é€Ÿå­˜å‚¨ï¼Œæ¯SMçº¦64KB</li><li><strong>å…±äº«å†…å­˜</strong>ï¼šblockå†…å…±äº«çš„å¯ç¼–ç¨‹ç¼“å­˜</li></ol><p>å…³é”®è®¤è¯†ï¼šSMæ˜¯èµ„æºæ± ï¼Œå¤šä¸ªblockå…±äº«è¿™äº›èµ„æºã€‚blockåˆ†é…å¤šå°‘èµ„æºï¼Œå†³å®šäº†SMèƒ½åŒæ—¶è¿è¡Œå‡ ä¸ªblockã€‚</p><h3 id="xian-cheng-kuai-dao-sm-de-ying-she" tabindex="-1" id="çº¿ç¨‹å—åˆ°SMçš„æ˜ å°„">çº¿ç¨‹å—åˆ°SMçš„æ˜ å°„</h3><p>å¯åŠ¨kernelæ—¶ï¼Œruntimeè´Ÿè´£å°†çº¿ç¨‹å—åˆ†é…åˆ°å„SMï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kernel&lt;&lt;&lt;gridDim, blockDim&gt;&gt;&gt;(args);</span><br><span class="line">         â†“</span><br><span class="line">è¿è¡Œæ—¶åˆ†é…ï¼šBlock 0â†’SM0, Block 1â†’SM2, Block 2â†’SM1, ...</span><br></pre></td></tr></table></figure><p><strong>å…³é”®è§„åˆ™</strong>ï¼š</p><ul><li>æ¯ä¸ªblockåªåœ¨ä¸€ä¸ªSMä¸Šæ‰§è¡Œï¼Œä¸ä¼šè·¨SM</li><li>ä¸€ä¸ªSMå¯ä»¥åŒæ—¶æ‰§è¡Œå¤šä¸ªblockï¼ˆèµ„æºå…è®¸çš„è¯ï¼‰</li><li>Blockä¹‹é—´æ²¡æœ‰æ‰§è¡Œé¡ºåºä¿è¯</li><li>Blockä¸€æ—¦å¼€å§‹æ‰§è¡Œï¼Œä¼šè¿è¡Œåˆ°ç»“æŸ</li></ul><p>è¿™ç§è®¾è®¡çš„å¥½å¤„ï¼šblockå®Œå…¨ç‹¬ç«‹ï¼Œç¡¬ä»¶å¯ä»¥è‡ªç”±è°ƒåº¦ï¼Œé€‚åº”ä¸åŒè§„æ¨¡çš„GPUã€‚</p><h2 id="warp-zhi-xing-de-ji-ben-dan-wei" tabindex="-1" id="Warpï¼šæ‰§è¡Œçš„åŸºæœ¬å•ä½">Warpï¼šæ‰§è¡Œçš„åŸºæœ¬å•ä½</h2><h3 id="shi-yao-shi-warp" tabindex="-1" id="ä»€ä¹ˆæ˜¯Warp">ä»€ä¹ˆæ˜¯Warp</h3><p><strong>Warpæ˜¯32ä¸ªè¿ç»­çº¿ç¨‹ç»„æˆçš„æ‰§è¡Œå•ä½</strong>ã€‚è¿™æ˜¯NVIDIA GPUçš„æ ¸å¿ƒè®¾è®¡ï¼Œç†è§£warpå°±ç†è§£äº†GPUæ‰§è¡Œæ¨¡å‹çš„ä¸€åŠã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Block (256 threads)</span><br><span class="line">â”œâ”€â”€ Warp 0: Thread 0-31</span><br><span class="line">â”œâ”€â”€ Warp 1: Thread 32-63</span><br><span class="line">â”œâ”€â”€ Warp 2: Thread 64-95</span><br><span class="line">â”œâ”€â”€ Warp 3: Thread 96-127</span><br><span class="line">â”œâ”€â”€ Warp 4: Thread 128-159</span><br><span class="line">â”œâ”€â”€ Warp 5: Thread 160-191</span><br><span class="line">â”œâ”€â”€ Warp 6: Thread 192-223</span><br><span class="line">â””â”€â”€ Warp 7: Thread 224-255</span><br></pre></td></tr></table></figure><p><strong>ä¸ºä»€ä¹ˆæ˜¯32</strong>ï¼Ÿç¡¬ä»¶è®¾è®¡å†³å®šçš„ã€‚æ¯ä¸ªSMæœ‰ä¸€å®šæ•°é‡çš„è®¡ç®—å•å…ƒï¼Œ32æ˜¯æ•ˆç‡æœ€ä¼˜çš„åˆ†ç»„å¤§å°ã€‚</p><h3 id="simt-zhi-xing-mo-xing" tabindex="-1" id="SIMTæ‰§è¡Œæ¨¡å‹">SIMTæ‰§è¡Œæ¨¡å‹</h3><p>GPUé‡‡ç”¨**SIMTï¼ˆSingle Instruction Multiple Threadï¼‰**æ¨¡å‹ï¼š</p><ul><li>åŒä¸€warpå†…çš„32ä¸ªçº¿ç¨‹ï¼Œåœ¨åŒä¸€æ—¶é’Ÿå‘¨æœŸæ‰§è¡Œç›¸åŒæŒ‡ä»¤</li><li>ä½†æ“ä½œä¸åŒçš„æ•°æ®ï¼ˆä¸åŒçš„å¯„å­˜å™¨ï¼‰</li><li>ç±»ä¼¼SIMDï¼Œä½†æ›´çµæ´»ï¼ˆçº¿ç¨‹å¯ä»¥æœ‰ç‹¬ç«‹çŠ¶æ€ï¼‰</li></ul><p><strong>ä¸¾ä¾‹</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C[i] = A[i] + B[i];</span><br></pre></td></tr></table></figure><p>Warpä¸­çš„32ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œ&quot;åŠ æ³•&quot;æŒ‡ä»¤ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Warp 0æ‰§è¡Œ:</span><br><span class="line">Thread 0: C[0] = A[0] + B[0]  â”€â”</span><br><span class="line">Thread 1: C[1] = A[1] + B[1]   â”‚ åŒä¸€æ¡addæŒ‡ä»¤</span><br><span class="line">...                            â”‚ åŒä¸€æ—¶é’Ÿå‘¨æœŸ</span><br><span class="line">Thread 31: C[31] = A[31] + B[31]â”€â”˜</span><br></pre></td></tr></table></figure><p>ç¡¬ä»¶åªéœ€å–ä¸€æ¬¡æŒ‡ä»¤ï¼Œå°±èƒ½å®Œæˆ32ä¸ªæ“ä½œã€‚è¿™å°±æ˜¯GPUé«˜ååçš„æ¥æºã€‚</p><h3 id="warp-diao-du" tabindex="-1" id="Warpè°ƒåº¦">Warpè°ƒåº¦</h3><p>æ¯ä¸ªSMæœ‰å¤šä¸ªWarpè°ƒåº¦å™¨ï¼ˆå¦‚Ampereæ˜¯4ä¸ªï¼‰ã€‚æ¯ä¸ªå‘¨æœŸï¼Œè°ƒåº¦å™¨é€‰æ‹©ä¸€ä¸ªå‡†å¤‡å¥½çš„warpå‘å°„æŒ‡ä»¤ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">å‘¨æœŸ1: Warpè°ƒåº¦å™¨0é€‰æ‹©Warp 3ï¼Œå‘å°„addæŒ‡ä»¤</span><br><span class="line">å‘¨æœŸ2: Warpè°ƒåº¦å™¨0é€‰æ‹©Warp 7ï¼Œå‘å°„loadæŒ‡ä»¤</span><br><span class="line">å‘¨æœŸ3: Warpè°ƒåº¦å™¨0é€‰æ‹©Warp 0ï¼Œå‘å°„mulæŒ‡ä»¤</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p><strong>å…³é”®</strong>ï¼šwarpä¹‹é—´æ˜¯ç‹¬ç«‹è°ƒåº¦çš„ã€‚å¦‚æœwarp 3åœ¨ç­‰å†…å­˜ï¼Œè°ƒåº¦å™¨åˆ‡æ¢åˆ°warp 7æ‰§è¡Œï¼Œä¸æµªè´¹æ—¶é’Ÿå‘¨æœŸã€‚</p><h2 id="kong-zhi-liu-fa-san-xing-neng-sha-shou" tabindex="-1" id="æ§åˆ¶æµå‘æ•£ï¼šæ€§èƒ½æ€æ‰‹">æ§åˆ¶æµå‘æ•£ï¼šæ€§èƒ½æ€æ‰‹</h2><h3 id="shi-yao-shi-fen-zhi-fa-san" tabindex="-1" id="ä»€ä¹ˆæ˜¯åˆ†æ”¯å‘æ•£">ä»€ä¹ˆæ˜¯åˆ†æ”¯å‘æ•£</h3><p>å½“warpå†…çš„çº¿ç¨‹èµ°ä¸åŒåˆ†æ”¯æ—¶ï¼Œå°±å‘ç”Ÿ<strong>æ§åˆ¶æµå‘æ•£ï¼ˆControl Divergenceï¼‰</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if (threadIdx.x &lt; 16) &#123;</span><br><span class="line">    // åˆ†æ”¯A</span><br><span class="line">    A[i] = ...;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    // åˆ†æ”¯B</span><br><span class="line">    B[i] = ...;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é—®é¢˜æ¥äº†ï¼š32ä¸ªçº¿ç¨‹å¿…é¡»æ‰§è¡Œç›¸åŒæŒ‡ä»¤ï¼Œä½†è¿™é‡Œçº¿ç¨‹0-15éœ€è¦æ‰§è¡Œåˆ†æ”¯Aï¼Œçº¿ç¨‹16-31éœ€è¦æ‰§è¡Œåˆ†æ”¯Bã€‚æ€ä¹ˆåŠï¼Ÿ</p><h3 id="ying-jian-ru-he-chu-li" tabindex="-1" id="ç¡¬ä»¶å¦‚ä½•å¤„ç†">ç¡¬ä»¶å¦‚ä½•å¤„ç†</h3><p>GPUé‡‡ç”¨<strong>è°“è¯æ‰§è¡Œï¼ˆPredicated Executionï¼‰</strong>ï¼š</p><ol><li>æ‰€æœ‰çº¿ç¨‹å…ˆæ‰§è¡Œåˆ†æ”¯Aï¼Œä½†åªæœ‰æ»¡è¶³æ¡ä»¶çš„çº¿ç¨‹å†™å…¥ç»“æœ</li><li>å†æ‰§è¡Œåˆ†æ”¯Bï¼Œåªæœ‰ä¸æ»¡è¶³æ¡ä»¶çš„çº¿ç¨‹å†™å…¥ç»“æœ</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">å®é™…æ‰§è¡Œåºåˆ—:</span><br><span class="line">Step 1: æ‰§è¡Œåˆ†æ”¯Aï¼ˆçº¿ç¨‹0-15æ´»è·ƒï¼Œ16-31æŠ‘åˆ¶ï¼‰</span><br><span class="line">Step 2: æ‰§è¡Œåˆ†æ”¯Bï¼ˆçº¿ç¨‹0-15æŠ‘åˆ¶ï¼Œ16-31æ´»è·ƒï¼‰</span><br></pre></td></tr></table></figure><p><strong>ä»£ä»·</strong>ï¼šä¸¤ä¸ªåˆ†æ”¯éƒ½è¢«æ‰§è¡Œï¼Œæ—¶é—´ç¿»å€ã€‚å¦‚æœæœ‰nä¸ªåˆ†æ”¯ï¼Œæœ€åæƒ…å†µæ€§èƒ½é™ä¸º1/nã€‚</p><h3 id="xing-neng-ying-xiang-liang-hua" tabindex="-1" id="æ€§èƒ½å½±å“é‡åŒ–">æ€§èƒ½å½±å“é‡åŒ–</h3><p><strong>åœºæ™¯1</strong>ï¼šæ— å‘æ•£</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">int i = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">C[i] = A[i] + B[i];  // æ‰€æœ‰çº¿ç¨‹æ‰§è¡Œç›¸åŒæ“ä½œ</span><br></pre></td></tr></table></figure><p>100%æ•ˆç‡ï¼Œç†æƒ³æƒ…å†µã€‚</p><p><strong>åœºæ™¯2</strong>ï¼šwarpå†…å‘æ•£</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if (threadIdx.x % 2 == 0) &#123;</span><br><span class="line">    C[i] = A[i] + B[i];</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    C[i] = A[i] * B[i];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯ä¸ªwarpä¸€åŠæ‰§è¡ŒåŠ æ³•ï¼Œä¸€åŠæ‰§è¡Œä¹˜æ³•ã€‚æ•ˆç‡çº¦50%ã€‚</p><p><strong>åœºæ™¯3</strong>ï¼šwarpé—´æ— å‘æ•£</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if (threadIdx.x &lt; 32) &#123;  // warp 0æ•´ä½“èµ°è¿™è¾¹</span><br><span class="line">    C[i] = A[i] + B[i];</span><br><span class="line">&#125; else &#123;                  // warp 1-7æ•´ä½“èµ°è¿™è¾¹</span><br><span class="line">    C[i] = A[i] * B[i];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯ä¸ªwarpå†…éƒ¨ä¸å‘æ•£ï¼Œæ•ˆç‡æ¥è¿‘100%ã€‚</p><p><strong>æ ¸å¿ƒåŸåˆ™</strong>ï¼šåˆ†æ”¯å‘æ•£åªåœ¨warpå†…éƒ¨æœ‰å¼€é”€ã€‚è®©åŒä¸€warpçš„çº¿ç¨‹èµ°ç›¸åŒåˆ†æ”¯ï¼Œå°±ä¸æŸå¤±æ€§èƒ½ã€‚</p><h3 id="bi-mian-fa-san-de-ji-qiao" tabindex="-1" id="é¿å…å‘æ•£çš„æŠ€å·§">é¿å…å‘æ•£çš„æŠ€å·§</h3><p><strong>æŠ€å·§1</strong>ï¼šæŒ‰warpè¾¹ç•Œåˆ’åˆ†ä»»åŠ¡</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// å·®ï¼šå¥‡å¶åˆ†æ”¯ï¼Œwarpå†…å‘æ•£</span><br><span class="line">if (threadIdx.x % 2 == 0) &#123; taskA(); &#125;</span><br><span class="line">else &#123; taskB(); &#125;</span><br><span class="line"></span><br><span class="line">// å¥½ï¼šæŒ‰warpåˆ’åˆ†ï¼Œwarpé—´åˆ†å·¥</span><br><span class="line">if (threadIdx.x / 32 == 0) &#123; taskA(); &#125;  // warp 0</span><br><span class="line">else &#123; taskB(); &#125;                         // å…¶ä»–warp</span><br></pre></td></tr></table></figure><p><strong>æŠ€å·§2</strong>ï¼šé‡ç»„æ•°æ®</p><p>å¦‚æœå¿…é¡»å¤„ç†ä¸åŒç±»å‹çš„å…ƒç´ ï¼Œå¯ä»¥å…ˆæ’åºï¼Œè®©åŒç±»å…ƒç´ è½åœ¨åŒä¸€warpã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// åŸå§‹ï¼štypeåˆ†å¸ƒéšæœºï¼Œæ¯ä¸ªwarpéƒ½å‘æ•£</span><br><span class="line">if (type[i] == 0) &#123; processType0(); &#125;</span><br><span class="line">else &#123; processType1(); &#125;</span><br><span class="line"></span><br><span class="line">// ä¼˜åŒ–ï¼šæŒ‰typeæ’åºåå¤„ç†ï¼Œwarpå†…typeç›¸åŒ</span><br><span class="line">sort_by_type(data);  // é¢„å¤„ç†</span><br><span class="line">kernel&lt;&lt;&lt;...&gt;&gt;&gt;(sorted_data);</span><br></pre></td></tr></table></figure><p><strong>æŠ€å·§3</strong>ï¼šç”¨ç®—æœ¯æ›¿ä»£åˆ†æ”¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// åˆ†æ”¯ç‰ˆæœ¬</span><br><span class="line">if (x &gt; 0) &#123; y = x; &#125;</span><br><span class="line">else &#123; y = -x; &#125;</span><br><span class="line"></span><br><span class="line">// æ— åˆ†æ”¯ç‰ˆæœ¬ï¼ˆReLUå¯ä»¥è¿™æ ·ï¼‰</span><br><span class="line">y = x * (x &gt; 0);  // åˆ©ç”¨å¸ƒå°”è½¬int</span><br><span class="line">// æˆ–ç”¨å†…ç½®å‡½æ•°</span><br><span class="line">y = fabs(x);</span><br></pre></td></tr></table></figure><h2 id="yan-chi-yin-cang-gpu-de-he-xin-you-hua-ce-lue" tabindex="-1" id="å»¶è¿Ÿéšè—ï¼šGPUçš„æ ¸å¿ƒä¼˜åŒ–ç­–ç•¥">å»¶è¿Ÿéšè—ï¼šGPUçš„æ ¸å¿ƒä¼˜åŒ–ç­–ç•¥</h2><h3 id="shi-yao-shi-yan-chi" tabindex="-1" id="ä»€ä¹ˆæ˜¯å»¶è¿Ÿ">ä»€ä¹ˆæ˜¯å»¶è¿Ÿ</h3><p>**å»¶è¿Ÿï¼ˆLatencyï¼‰**æ˜¯æŒ‡ä»¤ä»å‘å‡ºåˆ°å®Œæˆéœ€è¦çš„æ—¶é’Ÿå‘¨æœŸï¼š</p><table><thead><tr><th>æ“ä½œ</th><th>å…¸å‹å»¶è¿Ÿ</th></tr></thead><tbody><tr><td>ç®—æœ¯è¿ç®—</td><td>4-8å‘¨æœŸ</td></tr><tr><td>å…±äº«å†…å­˜</td><td>20-30å‘¨æœŸ</td></tr><tr><td>å…¨å±€å†…å­˜</td><td>200-400å‘¨æœŸ</td></tr><tr><td>ç‰¹æ®Šå‡½æ•°(sin/exp)</td><td>20-40å‘¨æœŸ</td></tr></tbody></table><p>å…¨å±€å†…å­˜è®¿é—®æ˜¯å¤§å¤´ï¼Œ400å‘¨æœŸæ„å‘³ç€è¯»ä¸€æ¬¡æ•°æ®çš„æ—¶é—´å¯ä»¥åš100æ¬¡è®¡ç®—ã€‚</p><h3 id="gpu-ru-he-yin-cang-yan-chi" tabindex="-1" id="GPUå¦‚ä½•éšè—å»¶è¿Ÿ">GPUå¦‚ä½•éšè—å»¶è¿Ÿ</h3><p>CPUç”¨å¤æ‚çš„ä¹±åºæ‰§è¡Œã€é¢„å–æ¥éšè—å»¶è¿Ÿã€‚GPUç”¨æ›´ç®€å•ç²—æš´çš„æ–¹æ³•ï¼š<strong>å¤§é‡çº¿ç¨‹+å¿«é€Ÿåˆ‡æ¢</strong>ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">æ—¶é’Ÿå‘¨æœŸæ¨æ¼”:</span><br><span class="line">å‘¨æœŸ1: Warp0å‘èµ·load A[0]ï¼ˆéœ€è¦400å‘¨æœŸè¿”å›ï¼‰</span><br><span class="line">å‘¨æœŸ2: Warp1å‘èµ·load A[32]</span><br><span class="line">å‘¨æœŸ3: Warp2å‘èµ·load A[64]</span><br><span class="line">...ï¼ˆç»§ç»­åˆ‡æ¢æ‰§è¡Œå…¶ä»–warpï¼‰</span><br><span class="line">å‘¨æœŸ400: Warp0çš„æ•°æ®åˆ°äº†ï¼Œå¯ä»¥ç»§ç»­æ‰§è¡Œ</span><br><span class="line">å‘¨æœŸ401: åˆ‡å›Warp0æ‰§è¡Œè®¡ç®—</span><br></pre></td></tr></table></figure><p>åªè¦æœ‰è¶³å¤Ÿå¤šçš„warpå¯ä»¥åˆ‡æ¢ï¼Œè®¡ç®—å•å…ƒå°±ä¸ä¼šç©ºé—²ã€‚è¿™å°±æ˜¯<strong>å»¶è¿Ÿéšè—</strong>ã€‚</p><h3 id="yan-chi-yin-cang-de-shu-xue" tabindex="-1" id="å»¶è¿Ÿéšè—çš„æ•°å­¦">å»¶è¿Ÿéšè—çš„æ•°å­¦</h3><p>å‡è®¾ï¼š</p><ul><li>å…¨å±€å†…å­˜å»¶è¿Ÿ400å‘¨æœŸ</li><li>ç®—æœ¯æŒ‡ä»¤ååé‡1ä¸ª/å‘¨æœŸï¼ˆæ¯ä¸ªè°ƒåº¦å™¨ï¼‰</li><li>æ¯SMæœ‰4ä¸ªè°ƒåº¦å™¨</li></ul><p>å®Œå…¨éšè—å»¶è¿Ÿéœ€è¦çš„æœ€å°warpæ•°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">éœ€è¦æ´»è·ƒwarpæ•° = å»¶è¿Ÿ / ååé‡ = 400 / 1 = 400ï¼ˆæ¯è°ƒåº¦å™¨ï¼‰</span><br><span class="line">æ¯SMéœ€è¦ = 400 / 4 = 100 warpï¼ˆç†è®ºæœ€å°å€¼ï¼‰</span><br></pre></td></tr></table></figure><p>å®é™…ä¸Šæ¯SMæœ€å¤š64 warpï¼ˆ2048çº¿ç¨‹ï¼‰ï¼Œæ‰€ä»¥å…¨å±€å†…å­˜å»¶è¿Ÿå¾ˆéš¾å®Œå…¨éšè—ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¦å°½é‡ç”¨å…±äº«å†…å­˜å’Œå¯„å­˜å™¨ã€‚</p><h2 id="zhan-yong-lu-occupancy" tabindex="-1" id="å ç”¨ç‡ï¼ˆOccupancyï¼‰">å ç”¨ç‡ï¼ˆOccupancyï¼‰</h2><h3 id="ding-yi" tabindex="-1" id="å®šä¹‰">å®šä¹‰</h3><p>**å ç”¨ç‡ï¼ˆOccupancyï¼‰**æ˜¯&quot;SMä¸Šæ´»è·ƒwarpæ•°&quot;ä¸&quot;SMæœ€å¤§æ”¯æŒwarpæ•°&quot;çš„æ¯”å€¼ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å ç”¨ç‡ = æ´»è·ƒWarpæ•° / SMæœ€å¤§Warpæ•°</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚ï¼ŒAmpere SMæœ€å¤šæ”¯æŒ64 warpï¼ˆ2048çº¿ç¨‹ï¼‰ã€‚å¦‚æœå®é™…æœ‰32 warpåœ¨è¿è¡Œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å ç”¨ç‡ = 32 / 64 = 50%</span><br></pre></td></tr></table></figure><h3 id="ying-xiang-zhan-yong-lu-de-zi-yuan" tabindex="-1" id="å½±å“å ç”¨ç‡çš„èµ„æº">å½±å“å ç”¨ç‡çš„èµ„æº</h3><p>ä¸‰å¤§é™åˆ¶å› ç´ ï¼š</p><p><strong>1. æ¯blockçº¿ç¨‹æ•°</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">dim3 block(1024);  // æ¯block 1024çº¿ç¨‹ = 32 warp</span><br><span class="line">// SMæœ€å¤š16 blockï¼Œä½†...</span><br><span class="line">// SMæœ€å¤š2048çº¿ç¨‹ï¼Œæ‰€ä»¥åªèƒ½æ”¾2ä¸ªè¿™æ ·çš„block</span><br><span class="line">// æ´»è·ƒ = 2 Ã— 32 = 64 warpï¼Œå ç”¨ç‡100%</span><br><span class="line"></span><br><span class="line">dim3 block(64);    // æ¯block 64çº¿ç¨‹ = 2 warp</span><br><span class="line">// SMæœ€å¤š16 blockï¼Œå¯ä»¥æ”¾16ä¸ª</span><br><span class="line">// æ´»è·ƒ = 16 Ã— 2 = 32 warpï¼Œå ç”¨ç‡50%</span><br></pre></td></tr></table></figure><p><strong>2. å¯„å­˜å™¨ä½¿ç”¨</strong></p><p>æ¯SMå¯„å­˜å™¨æ•°é‡æœ‰é™ï¼ˆå¦‚65536ä¸ªï¼‰ã€‚kernelç”¨çš„å¯„å­˜å™¨è¶Šå¤šï¼Œèƒ½åŒæ—¶è¿è¡Œçš„çº¿ç¨‹è¶Šå°‘ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">å‡è®¾kernelç”¨64ä¸ªå¯„å­˜å™¨/çº¿ç¨‹</span><br><span class="line">æ¯SMå¯æ”¯æŒçº¿ç¨‹ = 65536 / 64 = 1024çº¿ç¨‹ = 32 warp</span><br><span class="line">å ç”¨ç‡ = 32 / 64 = 50%</span><br><span class="line"></span><br><span class="line">å‡è®¾kernelç”¨32ä¸ªå¯„å­˜å™¨/çº¿ç¨‹</span><br><span class="line">æ¯SMå¯æ”¯æŒçº¿ç¨‹ = 65536 / 32 = 2048çº¿ç¨‹ = 64 warp</span><br><span class="line">å ç”¨ç‡ = 100%</span><br></pre></td></tr></table></figure><p><strong>3. å…±äº«å†…å­˜ä½¿ç”¨</strong></p><p>æ¯SMå…±äº«å†…å­˜æœ‰é™ï¼ˆå¦‚96KBï¼‰ã€‚blockç”¨çš„å…±äº«å†…å­˜è¶Šå¤šï¼Œèƒ½åŒæ—¶è¿è¡Œçš„blockè¶Šå°‘ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">å‡è®¾blockç”¨48KBå…±äº«å†…å­˜</span><br><span class="line">æ¯SMå¯è¿è¡Œblock = 96 / 48 = 2ä¸ª</span><br><span class="line">å‡è®¾æ¯block 256çº¿ç¨‹ = 8 warp</span><br><span class="line">æ´»è·ƒ = 2 Ã— 8 = 16 warp</span><br><span class="line">å ç”¨ç‡ = 16 / 64 = 25%</span><br></pre></td></tr></table></figure><h3 id="ji-suan-zhan-yong-lu" tabindex="-1" id="è®¡ç®—å ç”¨ç‡">è®¡ç®—å ç”¨ç‡</h3><p>ä½¿ç”¨CUDA Occupancy Calculatoræˆ–APIï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;cuda_runtime.h&gt;</span><br><span class="line"></span><br><span class="line">int blockSize = 256;</span><br><span class="line">int minGridSize, gridSize;</span><br><span class="line"></span><br><span class="line">// è‡ªåŠ¨è®¡ç®—æœ€ä¼˜blockå¤§å°</span><br><span class="line">cudaOccupancyMaxPotentialBlockSize(&amp;minGridSize, &amp;blockSize, </span><br><span class="line">                                    myKernel, 0, 0);</span><br><span class="line"></span><br><span class="line">// è®¡ç®—ç»™å®šé…ç½®çš„å ç”¨ç‡</span><br><span class="line">int numBlocks;</span><br><span class="line">cudaOccupancyMaxActiveBlocksPerMultiprocessor(&amp;numBlocks, </span><br><span class="line">                                               myKernel, blockSize, 0);</span><br><span class="line">int device;</span><br><span class="line">cudaGetDevice(&amp;device);</span><br><span class="line">cudaDeviceProp prop;</span><br><span class="line">cudaGetDeviceProperties(&amp;prop, device);</span><br><span class="line">float occupancy = (float)(numBlocks * blockSize) / prop.maxThreadsPerMultiProcessor;</span><br><span class="line">printf(&quot;å ç”¨ç‡: %.2f%%\n&quot;, occupancy * 100);</span><br></pre></td></tr></table></figure><h3 id="zhan-yong-lu-yu-xing-neng" tabindex="-1" id="å ç”¨ç‡ä¸æ€§èƒ½">å ç”¨ç‡ä¸æ€§èƒ½</h3><p><strong>é«˜å ç”¨ç‡ä¸ä¸€å®šæ„å‘³ç€é«˜æ€§èƒ½</strong>ã€‚è¿™æ˜¯å¸¸è§è¯¯è§£ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">åœºæ™¯1ï¼šè®¡ç®—å¯†é›†å‹kernel</span><br><span class="line">- æ¯çº¿ç¨‹ç”¨å¤§é‡å¯„å­˜å™¨åšå¤æ‚è®¡ç®—</span><br><span class="line">- å ç”¨ç‡å¯èƒ½åªæœ‰25%</span><br><span class="line">- ä½†è®¡ç®—å•å…ƒåˆ©ç”¨ç‡é«˜ï¼Œæ€§èƒ½å¥½</span><br><span class="line"></span><br><span class="line">åœºæ™¯2ï¼šå†…å­˜å¯†é›†å‹kernel</span><br><span class="line">- æ¯çº¿ç¨‹æ“ä½œç®€å•ï¼Œä¸»è¦åœ¨è¯»å†™å†…å­˜</span><br><span class="line">- éœ€è¦é«˜å ç”¨ç‡æ¥éšè—å»¶è¿Ÿ</span><br><span class="line">- 50%å ç”¨ç‡å¯èƒ½ä¸å¤Ÿ</span><br></pre></td></tr></table></figure><p><strong>åŸåˆ™</strong>ï¼š</p><ul><li>å†…å­˜å—é™kernelï¼šæé«˜å ç”¨ç‡æœ‰å¸®åŠ©</li><li>è®¡ç®—å—é™kernelï¼šå ç”¨ç‡å¤Ÿç”¨å°±è¡Œï¼Œä¼˜å…ˆåˆ©ç”¨å¥½è®¡ç®—èµ„æº</li><li>æœ€ä½³å®è·µï¼šä»åˆ†æå®é™…ç“¶é¢ˆå…¥æ‰‹ï¼Œè€Œä¸æ˜¯ç›²ç›®è¿½æ±‚å ç”¨ç‡</li></ul><h2 id="zi-yuan-xian-zhi-hui-zong" tabindex="-1" id="èµ„æºé™åˆ¶æ±‡æ€»">èµ„æºé™åˆ¶æ±‡æ€»</h2><p>ä»¥Ampereæ¶æ„ä¸ºä¾‹ï¼š</p><table><thead><tr><th>èµ„æº</th><th>æ¯SMé™åˆ¶</th><th>æ¯Blocké™åˆ¶</th></tr></thead><tbody><tr><td>çº¿ç¨‹æ•°</td><td>2048</td><td>1024</td></tr><tr><td>Blockæ•°</td><td>16</td><td>-</td></tr><tr><td>Warpæ•°</td><td>64</td><td>32</td></tr><tr><td>å¯„å­˜å™¨</td><td>65536</td><td>65536</td></tr><tr><td>å…±äº«å†…å­˜</td><td>å¯é…ç½®,æœ€å¤§164KB</td><td>å¯é…ç½®,æœ€å¤§99KB</td></tr></tbody></table><h3 id="block-da-xiao-xuan-ze" tabindex="-1" id="Blockå¤§å°é€‰æ‹©">Blockå¤§å°é€‰æ‹©</h3><p><strong>å®ç”¨å»ºè®®</strong>ï¼š</p><ol><li><strong>128-256æ˜¯å®‰å…¨èµ·ç‚¹</strong>ï¼šæ»¡è¶³warpæ•´æ•°å€ï¼Œä¸å¤ªå¤§ä¸å¤ªå°</li><li><strong>å¿…é¡»æ˜¯32çš„å€æ•°</strong>ï¼šå¦åˆ™æœ€åä¸€ä¸ªwarpæµªè´¹çº¿ç¨‹</li><li><strong>è€ƒè™‘å…±äº«å†…å­˜éœ€æ±‚</strong>ï¼šblockè¶Šå¤§ï¼Œå…±äº«å†…å­˜åˆ†æ‘Šæ•ˆç‡è¶Šé«˜</li><li><strong>å®æµ‹ä¸ºç‹</strong>ï¼šæœ€ç»ˆè¿˜æ˜¯è¦profileä¸åŒé…ç½®çš„æ€§èƒ½</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// ä¸å¥½ï¼šä¸æ˜¯32çš„å€æ•°</span><br><span class="line">dim3 block(100);  // æœ€åwarpåªæœ‰4ä¸ªæœ‰æ•ˆçº¿ç¨‹</span><br><span class="line"></span><br><span class="line">// å¥½ï¼š32çš„å€æ•°</span><br><span class="line">dim3 block(128);  // 4ä¸ªå®Œæ•´warp</span><br><span class="line"></span><br><span class="line">// ä¹Ÿå¥½</span><br><span class="line">dim3 block(256);  // 8ä¸ªå®Œæ•´warp</span><br></pre></td></tr></table></figure><h2 id="bian-yi-qi-you-hua-yu-diao-shi" tabindex="-1" id="ç¼–è¯‘å™¨ä¼˜åŒ–ä¸è°ƒè¯•">ç¼–è¯‘å™¨ä¼˜åŒ–ä¸è°ƒè¯•</h2><h3 id="cha-kan-ji-cun-qi-shi-yong" tabindex="-1" id="æŸ¥çœ‹å¯„å­˜å™¨ä½¿ç”¨">æŸ¥çœ‹å¯„å­˜å™¨ä½¿ç”¨</h3><p>ç¼–è¯‘æ—¶åŠ <code>--ptxas-options=-v</code>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvcc -O3 --ptxas-options=-v mykernel.cu -o mykernel</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ptxas info : Compiling entry function &#x27;mykernel&#x27;</span><br><span class="line">ptxas info : Function properties for mykernel</span><br><span class="line">    0 bytes stack frame, 0 bytes spill stores, 0 bytes spill loads</span><br><span class="line">ptxas info : Used 32 registers, 336 bytes cmem[0]</span><br></pre></td></tr></table></figure><p>32ä¸ªå¯„å­˜å™¨/çº¿ç¨‹ï¼Œæ²¡æœ‰æº¢å‡ºåˆ°local memoryã€‚</p><h3 id="kong-zhi-ji-cun-qi-shu-liang" tabindex="-1" id="æ§åˆ¶å¯„å­˜å™¨æ•°é‡">æ§åˆ¶å¯„å­˜å™¨æ•°é‡</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__global__ void __launch_bounds__(256, 4) myKernel(...) &#123;</span><br><span class="line">    // æç¤ºç¼–è¯‘å™¨ï¼šæ¯block 256çº¿ç¨‹ï¼Œæ¯SMè‡³å°‘4 block</span><br><span class="line">    // ç¼–è¯‘å™¨ä¼šæ®æ­¤ä¼˜åŒ–å¯„å­˜å™¨åˆ†é…</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ–ç¼–è¯‘é€‰é¡¹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvcc -maxrregcount=32 mykernel.cu  <span class="comment"># é™åˆ¶æ¯çº¿ç¨‹æœ€å¤š32å¯„å­˜å™¨</span></span><br></pre></td></tr></table></figure><p><strong>æƒè¡¡</strong>ï¼šé™åˆ¶å¯„å­˜å™¨å¯èƒ½å¯¼è‡´æº¢å‡ºåˆ°local memoryï¼ˆå¾ˆæ…¢ï¼‰ï¼Œéœ€è¦å¹³è¡¡ã€‚</p><h3 id="nsight-compute-fen-xi" tabindex="-1" id="Nsight-Computeåˆ†æ">Nsight Computeåˆ†æ</h3><p>ä½¿ç”¨NVIDIAçš„profileråˆ†æå®é™…ç“¶é¢ˆï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ncu --<span class="built_in">set</span> full ./mykernel</span><br></pre></td></tr></table></figure><p>å…³æ³¨ï¼š</p><ul><li>Warpæ‰§è¡Œæ•ˆç‡ï¼ˆåˆ†æ”¯å‘æ•£ï¼‰</li><li>å†…å­˜ååç‡</li><li>è®¡ç®—ååç‡</li><li>å ç”¨ç‡</li></ul><p>è¿™æ¯”çŒœæµ‹æœ‰æ•ˆå¾—å¤šã€‚</p><h2 id="shi-li-fen-xi-ju-zhen-cheng-fa-de-block-pei-zhi" tabindex="-1" id="å®ä¾‹åˆ†æï¼šçŸ©é˜µä¹˜æ³•çš„Blocké…ç½®">å®ä¾‹åˆ†æï¼šçŸ©é˜µä¹˜æ³•çš„Blocké…ç½®</h2><p>å›é¡¾ç¬¬ä¸‰ç« çš„çŸ©é˜µä¹˜æ³•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">__global__ void matMul(float *M, float *N, float *P, int width) &#123;</span><br><span class="line">    int row = blockIdx.y * blockDim.y + threadIdx.y;</span><br><span class="line">    int col = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">    </span><br><span class="line">    if (row &lt; width &amp;&amp; col &lt; width) &#123;</span><br><span class="line">        float sum = 0.0f;</span><br><span class="line">        for (int k = 0; k &lt; width; k++) &#123;</span><br><span class="line">            sum += M[row * width + k] * N[k * width + col];</span><br><span class="line">        &#125;</span><br><span class="line">        P[row * width + col] = sum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>é…ç½®é€‰æ‹©</strong>ï¼š</p><table><thead><tr><th>Blockå¤§å°</th><th>Warpæ•°</th><th>åˆ†æ</th></tr></thead><tbody><tr><td>8Ã—8=64</td><td>2</td><td>å¤ªå°ï¼Œwarpå°‘ï¼Œå»¶è¿Ÿéšè—ä¸è¶³</td></tr><tr><td>16Ã—16=256</td><td>8</td><td>åˆé€‚ï¼Œæ¯SMå¯æ”¾å¤šä¸ªblock</td></tr><tr><td>32Ã—32=1024</td><td>32</td><td>æ¥è¿‘é™åˆ¶ï¼Œçµæ´»æ€§å·®</td></tr></tbody></table><p><strong>16Ã—16é€šå¸¸æ˜¯äºŒç»´é—®é¢˜çš„å¥½é€‰æ‹©</strong>ã€‚</p><p><strong>è¿›ä¸€æ­¥ä¼˜åŒ–</strong>ï¼ˆç¬¬5ç« ä¼šè¯¦ç»†è®²ï¼‰ï¼š</p><ul><li>ç”¨å…±äº«å†…å­˜åštiling</li><li>å‡å°‘å…¨å±€å†…å­˜è®¿é—®</li><li>ç®—æœ¯å¼ºåº¦ä»0.25æå‡åˆ°10+</li></ul><h2 id="xiao-jie" tabindex="-1" id="å°ç»“">å°ç»“</h2><p>ç¬¬å››ç« æ­ç¤ºäº†GPUçš„å†…éƒ¨æœºåˆ¶ï¼š</p><p><strong>æ¶æ„è®¤è¯†</strong>ï¼šSMæ˜¯ç‹¬ç«‹æ‰§è¡Œå•å…ƒï¼Œå¤šä¸ªblockåˆ†é…åˆ°SMå…±äº«èµ„æºã€‚ç†è§£èµ„æºé™åˆ¶ï¼ˆå¯„å­˜å™¨ã€å…±äº«å†…å­˜ã€çº¿ç¨‹æ•°ï¼‰ï¼Œå°±ç†è§£äº†ä¸ºä»€ä¹ˆæŸäº›é…ç½®æ€§èƒ½å·®ã€‚</p><p><strong>Warpæœ¬è´¨</strong>ï¼š32çº¿ç¨‹ä¸€ç»„ï¼ŒSIMTæ‰§è¡Œã€‚æ‰€æœ‰ä¼˜åŒ–éƒ½å›´ç»•warpå±•å¼€â€”â€”è®©warpå†…çº¿ç¨‹åšç›¸åŒçš„äº‹ï¼ˆé¿å…å‘æ•£ï¼‰ï¼Œè®©è¶³å¤Ÿå¤šçš„warpå‚ä¸æ‰§è¡Œï¼ˆéšè—å»¶è¿Ÿï¼‰ã€‚</p><p><strong>å‘æ•£ä»£ä»·</strong>ï¼šæ§åˆ¶æµå‘æ•£æ˜¯æ€§èƒ½æ€æ‰‹ã€‚æŒ‰warpè¾¹ç•Œåˆ’åˆ†ä»»åŠ¡ã€ç”¨ç®—æœ¯æ›¿ä»£åˆ†æ”¯ã€é‡ç»„æ•°æ®ï¼Œè¿™äº›æŠ€å·§å¾ˆå®ç”¨ã€‚</p><p><strong>å»¶è¿Ÿä¸å ç”¨ç‡</strong>ï¼šé«˜å ç”¨ç‡å¸®åŠ©éšè—å»¶è¿Ÿï¼Œä½†ä¸æ˜¯è¶Šé«˜è¶Šå¥½ã€‚è®¡ç®—å¯†é›†å‹kernelå¯èƒ½ä¸éœ€è¦é‚£ä¹ˆé«˜å ç”¨ç‡ã€‚å…³é”®æ˜¯åˆ†æå®é™…ç“¶é¢ˆã€‚</p><p><strong>è°ƒä¼˜æ€è·¯</strong>ï¼š</p><ul><li>Blockå¤§å°é€‰128-256ï¼Œ32çš„å€æ•°</li><li>æ£€æŸ¥å¯„å­˜å™¨ä½¿ç”¨ï¼Œæ§åˆ¶æº¢å‡º</li><li>ç”¨profileråˆ†æï¼Œä¸è¦çŒœ</li></ul><p>ç†è§£äº†è¿™äº›ç¡¬ä»¶çŸ¥è¯†ï¼Œåé¢ç¬¬5ç« çš„Shared Memoryä¼˜åŒ–å°±æ°´åˆ°æ¸ æˆäº†ã€‚Tilingçš„æœ¬è´¨å°±æ˜¯åˆ©ç”¨å…±äº«å†…å­˜å‡å°‘å…¨å±€å†…å­˜è®¿é—®ï¼Œæé«˜ç®—æœ¯å¼ºåº¦ï¼Œè®©è®¡ç®—å•å…ƒä¸å†é¥¿ç€ã€‚</p><hr><p><strong>å‚è€ƒèµ„æ–™ï¼š</strong></p><ul><li>Hwu, W., Kirk, D., &amp; El Hajj, I. (2022). <em>Programming Massively Parallel Processors: A Hands-on Approach</em> (4th Edition). Morgan Kaufmann.</li><li><a href="https://docs.nvidia.com/cuda/cuda-c-programming-guide/index.html#hardware-implementation">CUDA C++ Programming Guide - Hardware Implementation</a></li><li><a href="https://docs.nvidia.com/nsight-compute/">NVIDIA Nsight Compute Documentation</a></li></ul><hr><blockquote><p><strong>æœ¬æ–‡ GitHub ä»“åº“</strong>: <a href="https://github.com/psmarter/PMPP-Learning">https://github.com/psmarter/PMPP-Learning</a></p></blockquote>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;qian-yan&quot; tabindex=&quot;-1&quot;</summary>
        
      
    
    
    
    <category term="çŸ¥è¯†åˆ†äº«" scheme="https://smarter.xin/categories/knowledge-sharing/"/>
    
    
    <category term="CUDA" scheme="https://smarter.xin/tags/CUDA/"/>
    
    <category term="GPUç¼–ç¨‹" scheme="https://smarter.xin/tags/gpu-programming/"/>
    
    <category term="å¹¶è¡Œè®¡ç®—" scheme="https://smarter.xin/tags/parallel-computing/"/>
    
    <category term="PMPP" scheme="https://smarter.xin/tags/PMPP/"/>
    
    <category term="GPUæ¶æ„" scheme="https://smarter.xin/tags/gpu-architecture/"/>
    
    <category term="Warp" scheme="https://smarter.xin/tags/Warp/"/>
    
  </entry>
  
  <entry>
    <title>PMPP-ç¬¬ä¸‰ç« ï¼šå¤šç»´ç½‘æ ¼å’Œæ•°æ®</title>
    <link href="https://smarter.xin/posts/6b7045b6/"/>
    <id>https://smarter.xin/posts/6b7045b6/</id>
    <published>2026-01-12T07:19:16.000Z</published>
    <updated>2026-01-24T08:26:21.331Z</updated>
    
    <content type="html"><![CDATA[<h2 id="qian-yan" tabindex="-1" id="å‰è¨€">å‰è¨€</h2><p>ç¬¬äºŒç« çš„å‘é‡åŠ æ³•æ˜¯ä¸€ç»´æ•°æ®ï¼Œå®é™…åº”ç”¨å¤§å¤šæ˜¯å¤šç»´çš„â€”â€”å›¾åƒæ˜¯2Dï¼ŒçŸ©é˜µæ˜¯2Dï¼Œæ·±åº¦å­¦ä¹ å¼ é‡æ˜¯3D/4Dã€‚ç¬¬ä¸‰ç« è®²è§£å¦‚ä½•ç”¨CUDAçš„å¤šç»´Grid/Blockå¤„ç†è¿™äº›æ•°æ®ï¼Œæ ¸å¿ƒæ¡ˆä¾‹æ˜¯çŸ©é˜µä¹˜æ³•å’Œå›¾åƒå¤„ç†ã€‚è™½ç„¶è¿˜æ˜¯åŸºç¡€å®ç°ï¼Œä½†å·²ç»èƒ½çœ‹å‡ºGPUç¼–ç¨‹çš„æ€ç»´å’Œä¼˜åŒ–æ–¹å‘ã€‚</p><blockquote><p><strong>ğŸ“¦ é…å¥—èµ„æº</strong>ï¼šæœ¬ç³»åˆ—æ–‡ç« é…æœ‰å®Œæ•´çš„ <a href="https://github.com/psmarter/PMPP-Learning">GitHub ä»“åº“</a>ï¼ŒåŒ…å«æ¯ç« çš„ç»ƒä¹ é¢˜è§£ç­”ã€CUDA ä»£ç å®ç°å’Œè¯¦ç»†æ³¨é‡Šã€‚æ‰€æœ‰ä»£ç éƒ½ç»è¿‡æµ‹è¯•ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œã€‚</p></blockquote><h2 id="duo-wei-xian-cheng-zu-zhi" tabindex="-1" id="å¤šç»´çº¿ç¨‹ç»„ç»‡">å¤šç»´çº¿ç¨‹ç»„ç»‡</h2><h3 id="cong-1-d-dao-2-d" tabindex="-1" id="ä»1Dåˆ°2D">ä»1Dåˆ°2D</h3><p>ç¬¬äºŒç« ç”¨ä¸€ç»´ç´¢å¼•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int i = blockIdx.x * blockDim.x + threadIdx.x;</span><br></pre></td></tr></table></figure><p>å¤„ç†çŸ©é˜µè‹¥ç”¨ä¸€ç»´ï¼Œéœ€è¦è½¬æ¢ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">int idx = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">int row = idx / width;  // é™¤æ³•</span><br><span class="line">int col = idx % width;  // å–æ¨¡</span><br></pre></td></tr></table></figure><p>é™¤æ³•å’Œå–æ¨¡åœ¨GPUä¸Šæœ‰å¼€é”€ï¼Œå¯è¯»æ€§ä¹Ÿå·®ã€‚ç”¨äºŒç»´æ›´è‡ªç„¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">int row = blockIdx.y * blockDim.y + threadIdx.y;</span><br><span class="line">int col = blockIdx.x * blockDim.x + threadIdx.x;</span><br></pre></td></tr></table></figure><h3 id="dim-3-lei-xing" tabindex="-1" id="dim3ç±»å‹">dim3ç±»å‹</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dim3 blockDim(16, 16);     // 256 threads: 16Ã—16</span><br><span class="line">dim3 gridDim(64, 64);      // 4096 blocks</span><br><span class="line">kernel&lt;&lt;&lt;gridDim, blockDim&gt;&gt;&gt;(args);</span><br></pre></td></tr></table></figure><p>å¦‚æœç”¨æ•´æ•°ä¼šè‡ªåŠ¨è½¬ä¸º1Dï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kernel&lt;&lt;&lt;256, 128&gt;&gt;&gt;(args);  // ç­‰ä»·äº dim3(256,1,1), dim3(128,1,1)</span><br></pre></td></tr></table></figure><h3 id="pei-zhi-yuan-ze" tabindex="-1" id="é…ç½®åŸåˆ™">é…ç½®åŸåˆ™</h3><ul><li><strong>åŒ¹é…æ•°æ®ç»´åº¦</strong>ï¼šå›¾åƒç”¨2Dï¼Œä½“æ•°æ®ç”¨3D</li><li><strong>è€ƒè™‘å†…å­˜è®¿é—®</strong>ï¼šåŒä¸€warpçš„çº¿ç¨‹æœ€å¥½è®¿é—®è¿ç»­å†…å­˜</li><li><strong>ç¡¬ä»¶é™åˆ¶</strong>ï¼š<ul><li>æ¯blockæœ€å¤š1024 threads</li><li>Gridçš„y/zç»´æœ€å¤š65535 blocks</li></ul></li></ul><h3 id="chang-jian-cuo-wu" tabindex="-1" id="å¸¸è§é”™è¯¯">å¸¸è§é”™è¯¯</h3><p><strong>1. å‚æ•°é¡ºåº</strong>ï¼š<code>&lt;&lt;&lt;grid, block&gt;&gt;&gt;</code>ä¸è¦å</p><p><strong>2. å‘ä¸Šå–æ•´</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// é”™è¯¯ï¼šsizeæ•´é™¤æ—¶ä¼šå¤šä¸€ä¸ªblock</span><br><span class="line">int blocks = size / threads + 1;</span><br><span class="line"></span><br><span class="line">// æ­£ç¡®</span><br><span class="line">int blocks = (size + threads - 1) / threads;</span><br></pre></td></tr></table></figure><p><strong>3. è¶…è¿‡é™åˆ¶</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dim3 block(32, 32, 1);   // 32*32=1024ï¼Œåˆšå¥½</span><br><span class="line">dim3 block(32, 32, 2);   // 2048ï¼Œè¶…é™ï¼</span><br></pre></td></tr></table></figure><h2 id="ju-zhen-cheng-fa" tabindex="-1" id="çŸ©é˜µä¹˜æ³•">çŸ©é˜µä¹˜æ³•</h2><h3 id="wen-ti-ding-yi" tabindex="-1" id="é—®é¢˜å®šä¹‰">é—®é¢˜å®šä¹‰</h3><p>P[i][j] = Î£(k=0â†’n-1) M[i][k] Ã— N[k][j]</p><ul><li>M: mÃ—n</li><li>N: nÃ—o</li><li>P: mÃ—o</li></ul><h3 id="ji-chu-shi-xian" tabindex="-1" id="åŸºç¡€å®ç°">åŸºç¡€å®ç°</h3><p>æ¯ä¸ªçº¿ç¨‹è®¡ç®—ä¸€ä¸ªè¾“å‡ºå…ƒç´ ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">__global__ void matMul(float *M, float *N, float *P, </span><br><span class="line">                       int m, int n, int o) &#123;</span><br><span class="line">    int row = blockIdx.y * blockDim.y + threadIdx.y;</span><br><span class="line">    int col = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">    </span><br><span class="line">    if (row &lt; m &amp;&amp; col &lt; o) &#123;</span><br><span class="line">        float sum = 0.0f;</span><br><span class="line">        for (int k = 0; k &lt; n; k++) &#123;</span><br><span class="line">            sum += M[row * n + k] * N[k * o + col];</span><br><span class="line">        &#125;</span><br><span class="line">        P[row * o + col] = sum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç´¢å¼•å…¬å¼</strong>ï¼ˆè¡Œä¸»åºï¼‰ï¼š</p><ul><li>M[i][j] â†’ <code>i * width + j</code></li><li>ç¬¬iè¡Œç¬¬jåˆ—åœ¨ä¸€ç»´æ•°ç»„ä¸­çš„ä½ç½®</li></ul><p><strong>å¯åŠ¨é…ç½®</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dim3 block(16, 16);</span><br><span class="line">dim3 grid((o + 15) / 16, (m + 15) / 16);</span><br><span class="line">matMul&lt;&lt;&lt;grid, block&gt;&gt;&gt;(d_M, d_N, d_P, m, n, o);</span><br></pre></td></tr></table></figure><p><strong>è¾¹ç•Œæ£€æŸ¥</strong>ï¼š<code>if (row &lt; m &amp;&amp; col &lt; o)</code> ä¸¤ä¸ªæ¡ä»¶éƒ½è¦ï¼ˆgridå‘ä¸Šå–æ•´ä¼šå¤šçº¿ç¨‹ï¼‰</p><h3 id="xing-neng-ping-jing" tabindex="-1" id="æ€§èƒ½ç“¶é¢ˆ">æ€§èƒ½ç“¶é¢ˆ</h3><p><strong>ç®—æœ¯å¼ºåº¦æä½</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">æ¯çº¿ç¨‹è¯»å–: 2nä¸ªfloat = 8n bytes</span><br><span class="line">æ¯çº¿ç¨‹è®¡ç®—: 2n FLOP</span><br><span class="line">ç®—æœ¯å¼ºåº¦ = 2n / 8n = 0.25 FLOP/Byte</span><br></pre></td></tr></table></figure><p>å¯¹äºå³°å€¼10 TFLOPSã€å¸¦å®½500 GB/sçš„GPUï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">è¾¾åˆ°å³°å€¼éœ€è¦: 10T / 500G = 20 FLOP/Byte</span><br><span class="line">å®é™…åªæœ‰: 0.25</span><br><span class="line">åˆ©ç”¨ç‡: 1.25%</span><br></pre></td></tr></table></figure><p>GPUå¤§éƒ¨åˆ†æ—¶é—´åœ¨ç­‰æ•°æ®ã€‚æ›´ä¸¥é‡çš„æ˜¯æ•°æ®é‡å¤è¯»å–ï¼šM[i][k]è¢«ç¬¬iè¡Œçš„æ‰€æœ‰çº¿ç¨‹è¯»ï¼Œæ€»å…±è¢«è¯»mÃ—oæ¬¡ï¼Œä½†æ¯æ¬¡éƒ½ä»å…¨å±€å†…å­˜è¯»ï¼Œæ²¡æœ‰å¤ç”¨ã€‚</p><p><strong>ä¼˜åŒ–æ–¹å‘</strong>ï¼ˆç¬¬4-5ç« ï¼‰ï¼šç”¨Shared MemoryåšTilingï¼Œç®—æœ¯å¼ºåº¦æå‡åˆ°10+ FLOP/Byteã€‚</p><h3 id="bian-ti-dui-bi" tabindex="-1" id="å˜ä½“å¯¹æ¯”">å˜ä½“å¯¹æ¯”</h3><p><strong>æ¯çº¿ç¨‹ä¸€è¡Œ</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">int row = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">for (int col = 0; col &lt; size; col++) &#123;</span><br><span class="line">    // è®¡ç®—P[row][col]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ¯çº¿ç¨‹ä¸€åˆ—</strong>ï¼šç±»ä¼¼ï¼Œå¤–å±‚å¾ªç¯æ”¹ä¸ºrow</p><table><thead><tr><th>æ–¹æ¡ˆ</th><th>å¹¶è¡Œåº¦</th><th>é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td>æ¯çº¿ç¨‹ä¸€å…ƒç´ </td><td>mÃ—o (æœ€é«˜)</td><td>é€šç”¨</td></tr><tr><td>æ¯çº¿ç¨‹ä¸€è¡Œ</td><td>m</td><td>m &gt;&gt; o</td></tr><tr><td>æ¯çº¿ç¨‹ä¸€åˆ—</td><td>o</td><td>o &gt;&gt; m</td></tr></tbody></table><p>å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæ¯çº¿ç¨‹ä¸€å…ƒç´ çš„å¹¶è¡Œåº¦æœ€é«˜ã€‚</p><h2 id="ju-zhen-xiang-liang-cheng-fa" tabindex="-1" id="çŸ©é˜µ-å‘é‡ä¹˜æ³•">çŸ©é˜µ-å‘é‡ä¹˜æ³•</h2><p>A[i] = Î£ B[i][j] Ã— C[j]</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">__global__ void matVecMul(float *B, float *C, float *A, </span><br><span class="line">                          int m, int n) &#123;</span><br><span class="line">    int row = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">    if (row &lt; m) &#123;</span><br><span class="line">        float sum = 0.0f;</span><br><span class="line">        for (int j = 0; j &lt; n; j++) &#123;</span><br><span class="line">            sum += B[row * n + j] * C[j];</span><br><span class="line">        &#125;</span><br><span class="line">        A[row] = sum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åªéœ€ä¸€ç»´ï¼Œå› ä¸ºè¾“å‡ºæ˜¯å‘é‡ã€‚ç“¶é¢ˆæ˜¯å‘é‡Cè¢«æ‰€æœ‰çº¿ç¨‹é‡å¤è¯»å–ï¼Œå¯ç”¨Constant Memoryæˆ–Shared Memoryä¼˜åŒ–ã€‚</p><h2 id="tu-xiang-chu-li" tabindex="-1" id="å›¾åƒå¤„ç†">å›¾åƒå¤„ç†</h2><h3 id="rgb-zhuan-hui-du" tabindex="-1" id="RGBè½¬ç°åº¦">RGBè½¬ç°åº¦</h3><p><strong>å…¬å¼</strong>ï¼šGray = 0.299R + 0.587G + 0.114B</p><p><strong>å†…å­˜å¸ƒå±€</strong>ï¼ˆRGBäº¤é”™ï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[R0 G0 B0][R1 G1 B1]...[R(w-1) G(w-1) B(w-1)]</span><br><span class="line">[Rw Gw Bw]...</span><br></pre></td></tr></table></figure><p><strong>Kernel</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">__global__ void rgb2gray(unsigned char *rgb, unsigned char *gray,</span><br><span class="line">                         int width, int height) &#123;</span><br><span class="line">    int col = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">    int row = blockIdx.y * blockDim.y + threadIdx.y;</span><br><span class="line">    </span><br><span class="line">    if (row &lt; height &amp;&amp; col &lt; width) &#123;</span><br><span class="line">        int rgbIdx = (row * width + col) * 3;</span><br><span class="line">        int grayIdx = row * width + col;</span><br><span class="line">        </span><br><span class="line">        unsigned char r = rgb[rgbIdx];</span><br><span class="line">        unsigned char g = rgb[rgbIdx + 1];</span><br><span class="line">        unsigned char b = rgb[rgbIdx + 2];</span><br><span class="line">        </span><br><span class="line">        gray[grayIdx] = 0.299f*r + 0.587f*g + 0.114f*b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ€§èƒ½</strong>ï¼šå¸¦å®½å—é™ï¼ˆè¯»3å­—èŠ‚ï¼Œå†™1å­—èŠ‚ï¼Œè®¡ç®—å¾ˆå°‘ï¼‰ï¼Œä½†è®¿é—®è¿ç»­ï¼Œcoalescingæ•ˆæœå¥½ã€‚</p><h3 id="gao-si-mo-hu" tabindex="-1" id="é«˜æ–¯æ¨¡ç³Š">é«˜æ–¯æ¨¡ç³Š</h3><p><strong>æ¨¡æ¿è®¡ç®—</strong>ï¼ˆStencilï¼‰ï¼šæ¯ä¸ªåƒç´ ç”±é‚»åŸŸåŠ æƒæ±‚å’Œ</p><p>3Ã—3é«˜æ–¯æ ¸ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1/16 * [1 2 1]</span><br><span class="line">       [2 4 2]</span><br><span class="line">       [1 2 1]</span><br></pre></td></tr></table></figure><p><strong>Kernel</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">__global__ void gaussianBlur(unsigned char *in, unsigned char *out,</span><br><span class="line">                              int width, int height) &#123;</span><br><span class="line">    int col = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">    int row = blockIdx.y * blockDim.y + threadIdx.y;</span><br><span class="line">    </span><br><span class="line">    // è¾¹ç•Œç›´æ¥å¤åˆ¶</span><br><span class="line">    if (row == 0 || row == height-1 || </span><br><span class="line">        col == 0 || col == width-1) &#123;</span><br><span class="line">        if (row &lt; height &amp;&amp; col &lt; width)</span><br><span class="line">            out[row*width + col] = in[row*width + col];</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    if (row &lt; height &amp;&amp; col &lt; width) &#123;</span><br><span class="line">        float sum = 0;</span><br><span class="line">        // 3x3é‚»åŸŸ</span><br><span class="line">        sum += in[(row-1)*width + col-1] * 1.0f;</span><br><span class="line">        sum += in[(row-1)*width + col  ] * 2.0f;</span><br><span class="line">        sum += in[(row-1)*width + col+1] * 1.0f;</span><br><span class="line">        sum += in[row*width + col-1] * 2.0f;</span><br><span class="line">        sum += in[row*width + col  ] * 4.0f;</span><br><span class="line">        sum += in[row*width + col+1] * 2.0f;</span><br><span class="line">        sum += in[(row+1)*width + col-1] * 1.0f;</span><br><span class="line">        sum += in[(row+1)*width + col  ] * 2.0f;</span><br><span class="line">        sum += in[(row+1)*width + col+1] * 1.0f;</span><br><span class="line">        </span><br><span class="line">        out[row*width + col] = sum / 16.0f;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å…³é”®ç‚¹</strong>ï¼š<br>-è¾¹ç•Œå¤„ç†ï¼šè¿™é‡Œç®€åŒ–ä¸ºå¤åˆ¶ï¼Œä¹Ÿå¯padding/é•œåƒ</p><ul><li>æ•°æ®é‡ç”¨ï¼šç›¸é‚»åƒç´ çš„é‚»åŸŸé‡å ï¼Œä½†æ­¤ç‰ˆæœ¬æ²¡å¤ç”¨</li><li>ä¼˜åŒ–ï¼šç”¨Shared Memoryè®©blockåä½œåŠ è½½tile+halo</li></ul><h2 id="nei-cun-bu-ju" tabindex="-1" id="å†…å­˜å¸ƒå±€">å†…å­˜å¸ƒå±€</h2><h3 id="xing-zhu-xu-c-cuda" tabindex="-1" id="è¡Œä¸»åºï¼ˆC-CUDAï¼‰">è¡Œä¸»åºï¼ˆC/CUDAï¼‰</h3><p>å…ƒç´ [row][col]çš„ç´¢å¼•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">index = row * width + col</span><br></pre></td></tr></table></figure><p>ä¾‹ï¼š4Ã—3çŸ©é˜µå…ƒç´ [2][1]ï¼š<code>2*3 + 1 = 7</code></p><h3 id="lie-zhu-xu-fortran-matlab" tabindex="-1" id="åˆ—ä¸»åºï¼ˆFortran-MATLABï¼‰">åˆ—ä¸»åºï¼ˆFortran/MATLABï¼‰</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">index = col * height + row</span><br></pre></td></tr></table></figure><p>åŒæ ·å…ƒç´ [2][1]ï¼š<code>1*4 + 2 = 6</code></p><h3 id="san-wei-zhang-liang" tabindex="-1" id="ä¸‰ç»´å¼ é‡">ä¸‰ç»´å¼ é‡</h3><p>æ·±åº¦Ã—é«˜åº¦Ã—å®½åº¦ï¼Œå…ƒç´ [z][y][x]ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">index = z * (height * width) + y * width + x</span><br></pre></td></tr></table></figure><p>ä¾‹ï¼š300Ã—500Ã—400 (DÃ—HÃ—W)ï¼Œå…ƒç´ [5][20][10]ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">5*(500*400) + 20*400 + 10 = 1,008,010</span><br></pre></td></tr></table></figure><p><strong>æ³¨æ„</strong>ï¼šæ·±åº¦å­¦ä¹ æ¡†æ¶ç»´åº¦é¡ºåºå¯èƒ½ä¸åŒï¼ˆPyTorchç”¨NCHWï¼ŒTensorFlowç”¨NHWCï¼‰ã€‚</p><h2 id="zhi-xing-pei-zhi-shi-li" tabindex="-1" id="æ‰§è¡Œé…ç½®ç¤ºä¾‹">æ‰§è¡Œé…ç½®ç¤ºä¾‹</h2><p>ä¹¦ä¸­ä¹ é¢˜3ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dim3 bd(16, 32);                      // block: 16Ã—32</span><br><span class="line">dim3 gd((300-1)/16+1, (150-1)/32+1); // grid</span><br><span class="line">// M=150, N=300</span><br></pre></td></tr></table></figure><ul><li>æ¯blockï¼š16Ã—32 = 512 threads</li><li>Gridï¼š(19, 5) = 95 blocks</li><li>æ€»çº¿ç¨‹ï¼š95Ã—512 = 48,640</li><li>æœ‰æ•ˆçº¿ç¨‹ï¼ˆrow&lt;150 &amp;&amp; col&lt;300ï¼‰ï¼š150Ã—300 = 45,000</li><li>æµªè´¹ï¼š3,640 (7.5%)ï¼Œå¯æ¥å—</li></ul><h2 id="xing-neng-fen-xi-si-lu" tabindex="-1" id="æ€§èƒ½åˆ†ææ€è·¯">æ€§èƒ½åˆ†ææ€è·¯</h2><h3 id="roofline-mo-xing" tabindex="-1" id="Rooflineæ¨¡å‹">Rooflineæ¨¡å‹</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å®é™…æ€§èƒ½ = min(è®¡ç®—å³°å€¼, å¸¦å®½ Ã— ç®—æœ¯å¼ºåº¦)</span><br></pre></td></tr></table></figure><p>è¦è¾¾åˆ°è®¡ç®—å³°å€¼éœ€è¦ï¼šç®—æœ¯å¼ºåº¦ â‰¥ å³°å€¼FLOPS / å¸¦å®½</p><p>ä¾‹å¦‚GPU 10 TFLOPS, 500 GB/sï¼šéœ€è¦ â‰¥ 20 FLOP/Byte</p><p>å½“å‰ç®—æ³•éƒ½è¿œä½äºæ­¤ï¼Œæ€§èƒ½å—å†…å­˜é™åˆ¶ã€‚</p><h3 id="ti-sheng-suan-zhu-qiang-du" tabindex="-1" id="æå‡ç®—æœ¯å¼ºåº¦">æå‡ç®—æœ¯å¼ºåº¦</h3><p>æ ¸å¿ƒï¼š<strong>æ•°æ®é‡ç”¨</strong></p><ul><li><strong>Tiling</strong>ï¼šæ•°æ®åŠ è½½åˆ°Shared Memoryé‡å¤ä½¿ç”¨</li><li><strong>å¯„å­˜å™¨å¤ç”¨</strong>ï¼šæ¯çº¿ç¨‹è®¡ç®—å¤šä¸ªå…ƒç´ </li><li><strong>Kernelèåˆ</strong>ï¼šå‡å°‘ä¸­é—´ç»“æœä¼ è¾“</li></ul><p>çŸ©é˜µä¹˜æ³•ä¼˜åŒ–ç‰ˆèƒ½è¾¾åˆ°10+ FLOP/Byteï¼Œæ€§èƒ½æå‡10å€ä»¥ä¸Šã€‚</p><h2 id="xiao-jie" tabindex="-1" id="å°ç»“">å°ç»“</h2><p>ç¬¬ä¸‰ç« ä»ä¸€ç»´æ‰©å±•åˆ°å¤šç»´ï¼Œæ ¸å¿ƒæ˜¯Grid/Blockçš„çµæ´»ç»„ç»‡ï¼š</p><p><strong>å¤šç»´ç´¢å¼•</strong>ï¼š<code>row = blockIdx.y*blockDim.y + threadIdx.y</code> è¦ç†Ÿç»ƒï¼ŒäºŒç»´ã€ä¸‰ç»´æ˜¯è‡ªç„¶æ‰©å±•ã€‚</p><p><strong>å†…å­˜å¸ƒå±€</strong>ï¼šè¡Œä¸»åºå†³å®šç´¢å¼•å…¬å¼ <code>row*width + col</code>ï¼Œæé”™ä¼šè®¿é—®é”™è¯¯æ•°æ®ã€‚</p><p><strong>æ€§èƒ½è®¤çŸ¥</strong>ï¼šåŸºç¡€å®ç°éƒ½æ˜¯å†…å­˜å—é™ï¼Œç®—æœ¯å¼ºåº¦0.1-0.25 FLOP/Byteï¼Œè¿œä½äºéœ€è¦çš„20ã€‚GPUè®¡ç®—èƒ½åŠ›å¼ºï¼Œä½†æ•°æ®ä¾›åº”è·Ÿä¸ä¸Šã€‚</p><p><strong>ä¼˜åŒ–æ–¹å‘</strong>ï¼šæå‡ç®—æœ¯å¼ºåº¦ = å¢åŠ æ•°æ®é‡ç”¨ã€‚è¿™æ˜¯ç¬¬4-5ç« çš„é‡ç‚¹ã€‚</p><p><strong>ä»£ç ä¹ æƒ¯</strong>ï¼š</p><ul><li>äºŒç»´/ä¸‰ç»´éƒ½è¦ä¸¥æ ¼è¾¹ç•Œæ£€æŸ¥</li><li>ç´¢å¼•è®¡ç®—å…ˆrowåcolï¼ˆè¡Œä¸»åºï¼‰</li><li>æ€§èƒ½åˆ†æè¦é‡åŒ–ï¼ˆç®—æœ¯å¼ºåº¦ã€å¸¦å®½åˆ©ç”¨ç‡ï¼‰</li></ul><p>ç†è§£äº†naiveå®ç°çš„ç“¶é¢ˆï¼Œæ‰èƒ½æ˜ç™½Shared Memoryã€Tilingçš„ä»·å€¼ã€‚ä¸‹ä¸€ç« çš„ä¼˜åŒ–ä¼šè®©åŒæ ·çš„çŸ©é˜µä¹˜æ³•æ€§èƒ½æå‡10å€ä»¥ä¸Šã€‚</p><hr><p><strong>å‚è€ƒèµ„æ–™ï¼š</strong></p><ul><li>Hwu, W., Kirk, D., &amp; El Hajj, I. (2022). <em>Programming Massively Parallel Processors: A Hands-on Approach</em> (4th Edition). Morgan Kaufmann.</li><li><a href="https://docs.nvidia.com/cuda/cuda-c-programming-guide/">CUDA C++ Programming Guide</a></li></ul><hr><blockquote><p><strong>æœ¬æ–‡ GitHub ä»“åº“</strong>: <a href="https://github.com/psmarter/PMPP-Learning">https://github.com/psmarter/PMPP-Learning</a></p></blockquote>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;qian-yan&quot; tabindex=&quot;-1&quot;</summary>
        
      
    
    
    
    <category term="çŸ¥è¯†åˆ†äº«" scheme="https://smarter.xin/categories/knowledge-sharing/"/>
    
    
    <category term="CUDA" scheme="https://smarter.xin/tags/CUDA/"/>
    
    <category term="GPUç¼–ç¨‹" scheme="https://smarter.xin/tags/gpu-programming/"/>
    
    <category term="å¹¶è¡Œè®¡ç®—" scheme="https://smarter.xin/tags/parallel-computing/"/>
    
    <category term="PMPP" scheme="https://smarter.xin/tags/PMPP/"/>
    
    <category term="çŸ©é˜µä¹˜æ³•" scheme="https://smarter.xin/tags/matrix-multiplication/"/>
    
    <category term="å›¾åƒå¤„ç†" scheme="https://smarter.xin/tags/image-processing/"/>
    
  </entry>
  
  <entry>
    <title>PMPP-ç¬¬äºŒç« ï¼šå¼‚æ„æ•°æ®å¹¶è¡Œè®¡ç®—</title>
    <link href="https://smarter.xin/posts/3ee22ce5/"/>
    <id>https://smarter.xin/posts/3ee22ce5/</id>
    <published>2026-01-11T11:38:29.000Z</published>
    <updated>2026-01-24T08:26:21.332Z</updated>
    
    <content type="html"><![CDATA[<h2 id="qian-yan" tabindex="-1" id="å‰è¨€">å‰è¨€</h2><p>ç¬¬ä¸€ç« è®²äº†ç†è®ºï¼Œç¬¬äºŒç« å¼€å§‹å†™ä»£ç äº†ã€‚è™½ç„¶ä¾‹å­æ˜¯ç»å…¸çš„å‘é‡åŠ æ³•ï¼Œä½†å®ƒåŒ…å«äº†CUDAç¼–ç¨‹çš„æ‰€æœ‰æ ¸å¿ƒç¯èŠ‚ï¼šå†…å­˜ç®¡ç†ã€kernelç¼–å†™ã€çº¿ç¨‹ç»„ç»‡ã€‚æŒæ¡è¿™ä¸ªç®€å•ä¾‹å­ï¼Œåé¢çš„å¤æ‚åº”ç”¨å°±æ˜¯åœ¨æ­¤åŸºç¡€ä¸Šçš„æ‰©å±•ã€‚</p><blockquote><p><strong>ğŸ“¦ é…å¥—èµ„æº</strong>ï¼šæœ¬ç³»åˆ—æ–‡ç« é…æœ‰å®Œæ•´çš„ <a href="https://github.com/psmarter/PMPP-Learning">GitHub ä»“åº“</a>ï¼ŒåŒ…å«æ¯ç« çš„ç»ƒä¹ é¢˜è§£ç­”ã€CUDA ä»£ç å®ç°å’Œè¯¦ç»†æ³¨é‡Šã€‚æ‰€æœ‰ä»£ç éƒ½ç»è¿‡æµ‹è¯•ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œã€‚</p></blockquote><h2 id="wei-shi-yao-cong-xiang-liang-jia-fa-kai-shi" tabindex="-1" id="ä¸ºä»€ä¹ˆä»å‘é‡åŠ æ³•å¼€å§‹">ä¸ºä»€ä¹ˆä»å‘é‡åŠ æ³•å¼€å§‹</h2><h3 id="shu-ju-bing-xing-de-dian-xing-li-zi" tabindex="-1" id="æ•°æ®å¹¶è¡Œçš„å…¸å‹ä¾‹å­">æ•°æ®å¹¶è¡Œçš„å…¸å‹ä¾‹å­</h3><p>å‘é‡åŠ æ³•æ˜¯æ•°æ®å¹¶è¡Œçš„æœ€ä½³å…¥å£ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">C[0] = A[0] + B[0]</span><br><span class="line">C[1] = A[1] + B[1]</span><br><span class="line">...</span><br><span class="line">C[n-1] = A[n-1] + B[n-1]</span><br></pre></td></tr></table></figure><p>æ¯ä¸ªå…ƒç´ çš„è®¡ç®—å®Œå…¨ç‹¬ç«‹ï¼ŒC[0]ä¸éœ€è¦ç­‰C[1]ç®—å®Œã€‚è¿™ç§ç‹¬ç«‹æ€§æ­£æ˜¯å¹¶è¡Œè®¡ç®—çš„é»„é‡‘åœºæ™¯ã€‚</p><h3 id="nei-cun-shou-xian-wen-ti" tabindex="-1" id="å†…å­˜å—é™é—®é¢˜">å†…å­˜å—é™é—®é¢˜</h3><p>å‘é‡åŠ æ³•çš„ç®—æœ¯å¼ºåº¦å¾ˆä½ï¼š</p><ul><li>æ¯å…ƒç´ ï¼šè¯»2ä¸ªfloat + å†™1ä¸ªfloat = 12å­—èŠ‚</li><li>è®¡ç®—ï¼š1æ¬¡æµ®ç‚¹åŠ æ³•</li><li>ç®—æœ¯å¼ºåº¦ï¼š1 FLOP / 12 Bytes â‰ˆ 0.083 FLOP/Byte</li></ul><p>å…¸å‹å†…å­˜å—é™ï¼ˆMemory-Boundï¼‰é—®é¢˜ã€‚GPUè®¡ç®—å•å…ƒä¼šç»å¸¸ç­‰æ•°æ®ã€‚è™½ç„¶æ€§èƒ½è¾¾ä¸åˆ°å³°å€¼ï¼Œä½†ä½œä¸ºå…¥é—¨ä¾‹å­è¶³å¤Ÿç®€å•ç›´è§‚ã€‚</p><h2 id="cuda-cheng-xu-jie-gou-san-bu-zou" tabindex="-1" id="CUDAç¨‹åºç»“æ„ï¼šä¸‰æ­¥èµ°">CUDAç¨‹åºç»“æ„ï¼šä¸‰æ­¥èµ°</h2><h3 id="cpu-ban-ben-dui-bi" tabindex="-1" id="CPUç‰ˆæœ¬ï¼ˆå¯¹æ¯”ï¼‰">CPUç‰ˆæœ¬ï¼ˆå¯¹æ¯”ï¼‰</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">vecAddCPU</span><span class="params">(<span class="type">float</span> *A, <span class="type">float</span> *B, <span class="type">float</span> *C, <span class="type">int</span> n)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        C[i] = A[i] + B[i];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸²è¡Œæ‰§è¡Œï¼Œn=10000å°±è¦å¾ªç¯10000æ¬¡ã€‚</p><h3 id="cuda-ban-ben" tabindex="-1" id="CUDAç‰ˆæœ¬">CUDAç‰ˆæœ¬</h3><h4 id="1-host-duan-zhun-bei" tabindex="-1" id="1-Hostç«¯å‡†å¤‡">1. Hostç«¯å‡†å¤‡</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">int n = 10000;</span><br><span class="line">size_t size = n * sizeof(float);</span><br><span class="line"></span><br><span class="line">// åˆ†é…Hostå†…å­˜</span><br><span class="line">float *h_A = (float*)malloc(size);</span><br><span class="line">float *h_B = (float*)malloc(size);</span><br><span class="line">float *h_C = (float*)malloc(size);</span><br><span class="line"></span><br><span class="line">// åˆå§‹åŒ–æ•°æ®</span><br><span class="line">for (int i = 0; i &lt; n; i++) &#123;</span><br><span class="line">    h_A[i] = i * 1.0f;</span><br><span class="line">    h_B[i] = i * 2.0f;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>h_</code>å‰ç¼€è¡¨ç¤ºHostå˜é‡ï¼Œè¿™æ˜¯ä¸ªå¥½ä¹ æƒ¯ã€‚</p><h4 id="2-device-duan-zhun-bei" tabindex="-1" id="2-Deviceç«¯å‡†å¤‡">2. Deviceç«¯å‡†å¤‡</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// åˆ†é…Deviceå†…å­˜</span><br><span class="line">float *d_A, *d_B, *d_C;</span><br><span class="line">cudaMalloc((void**)&amp;d_A, size);</span><br><span class="line">cudaMalloc((void**)&amp;d_B, size);</span><br><span class="line">cudaMalloc((void**)&amp;d_C, size);</span><br><span class="line"></span><br><span class="line">// Host â†’ Device</span><br><span class="line">cudaMemcpy(d_A, h_A, size, cudaMemcpyHostToDevice);</span><br><span class="line">cudaMemcpy(d_B, h_B, size, cudaMemcpyHostToDevice);</span><br></pre></td></tr></table></figure><p><strong>å…³é”®</strong>ï¼š</p><ul><li><code>cudaMalloc</code>å‚æ•°æ˜¯äºŒçº§æŒ‡é’ˆï¼ˆéœ€è¦ä¿®æ”¹æŒ‡é’ˆå€¼ï¼‰</li><li><code>d_A</code>æ˜¯DeviceæŒ‡é’ˆï¼Œåœ¨Hostä»£ç ä¸­ä¸èƒ½ç›´æ¥è§£å¼•ç”¨<code>d_A[0]</code>ï¼ˆä¼šæ®µé”™è¯¯ï¼‰</li></ul><h4 id="3-zhi-xing-yu-hui-chuan" tabindex="-1" id="3-æ‰§è¡Œä¸å›ä¼ ">3. æ‰§è¡Œä¸å›ä¼ </h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">// å¯åŠ¨kernel</span><br><span class="line">int threadsPerBlock = 256;</span><br><span class="line">int blocksPerGrid = (n + threadsPerBlock - 1) / threadsPerBlock;</span><br><span class="line">vecAdd&lt;&lt;&lt;blocksPerGrid, threadsPerBlock&gt;&gt;&gt;(d_A, d_B, d_C, n);</span><br><span class="line"></span><br><span class="line">// Device â†’ Host</span><br><span class="line">cudaMemcpy(h_C, d_C, size, cudaMemcpyDeviceToHost);</span><br><span class="line"></span><br><span class="line">// éªŒè¯</span><br><span class="line">for (int i = 0; i &lt; n; i++) &#123;</span><br><span class="line">    if (fabs(h_C[i] - (h_A[i] + h_B[i])) &gt; 1e-5) &#123;</span><br><span class="line">        printf(&quot;Error at index %d\n&quot;, i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æ¸…ç†</span><br><span class="line">cudaFree(d_A);</span><br><span class="line">cudaFree(d_B);</span><br><span class="line">cudaFree(d_C);</span><br><span class="line">free(h_A);</span><br><span class="line">free(h_B);</span><br><span class="line">free(h_C);</span><br></pre></td></tr></table></figure><h2 id="kernel-han-shu" tabindex="-1" id="Kernelå‡½æ•°">Kernelå‡½æ•°</h2><h3 id="ji-ben-jie-gou" tabindex="-1" id="åŸºæœ¬ç»“æ„">åŸºæœ¬ç»“æ„</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__global__ void vecAdd(float *A, float *B, float *C, int n) &#123;</span><br><span class="line">    int i = blockDim.x * blockIdx.x + threadIdx.x;</span><br><span class="line">    if (i &lt; n) &#123;</span><br><span class="line">        C[i] = A[i] + B[i];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>é€è¡Œè§£æ</strong>ï¼š</p><ul><li><p><code>__global__</code>ï¼šGPUä¸Šæ‰§è¡Œï¼ŒCPUè°ƒç”¨</p><ul><li><code>__device__</code>ï¼šGPUä¸Šæ‰§è¡Œï¼ŒGPUè°ƒç”¨</li><li><code>__host__</code>ï¼šCPUä¸Šæ‰§è¡Œï¼ŒCPUè°ƒç”¨ï¼ˆé»˜è®¤ï¼Œå¯çœç•¥ï¼‰</li></ul></li><li><p>çº¿ç¨‹ç´¢å¼•è®¡ç®—ï¼š<code>i = blockIdx.x * blockDim.x + threadIdx.x</code></p><ul><li><code>blockIdx.x</code>ï¼šblockåœ¨gridä¸­çš„ç´¢å¼•</li><li><code>blockDim.x</code>ï¼šblockçš„å¤§å°</li><li><code>threadIdx.x</code>ï¼šthreadåœ¨blockä¸­çš„ç´¢å¼•</li></ul></li><li><p>è¾¹ç•Œæ£€æŸ¥ï¼š<code>if (i &lt; n)</code> å¿…é¡»æœ‰ï¼ˆæ€»çº¿ç¨‹æ•°é€šå¸¸å¤šäºæ•°ç»„å…ƒç´ ï¼‰</p></li></ul><h3 id="xian-cheng-ceng-ci-jie-gou" tabindex="-1" id="çº¿ç¨‹å±‚æ¬¡ç»“æ„">çº¿ç¨‹å±‚æ¬¡ç»“æ„</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Grid</span><br><span class="line">â”œâ”€â”€ Block 0 (256 threads)</span><br><span class="line">â”‚   â”œâ”€â”€ Thread 0   â†’ i = 0*256 + 0 = 0</span><br><span class="line">â”‚   â”œâ”€â”€ Thread 1   â†’ i = 0*256 + 1 = 1</span><br><span class="line">â”‚   â””â”€â”€ Thread 255 â†’ i = 0*256 + 255 = 255</span><br><span class="line">â”œâ”€â”€ Block 1 (256 threads)</span><br><span class="line">â”‚   â”œâ”€â”€ Thread 0   â†’ i = 1*256 + 0 = 256</span><br><span class="line">â”‚   â””â”€â”€ Thread 255 â†’ i = 1*256 + 255 = 511</span><br><span class="line">â””â”€â”€ ...</span><br></pre></td></tr></table></figure><p>æ¯ä¸ªthreadå¾—åˆ°å”¯ä¸€ç´¢å¼•ï¼Œå¯¹åº”æ•°ç»„å…ƒç´ ã€‚</p><h3 id="wei-shi-yao-256-ge-threads" tabindex="-1" id="ä¸ºä»€ä¹ˆ256ä¸ªthreadsï¼Ÿ">ä¸ºä»€ä¹ˆ256ä¸ªthreadsï¼Ÿ</h3><p>ä¸æ˜¯éšä¾¿é€‰çš„ï¼š</p><ol><li><strong>Warpçš„å€æ•°</strong>ï¼šGPUä»¥32çº¿ç¨‹ä¸ºä¸€ç»„ï¼ˆwarpï¼‰æ‰§è¡Œï¼Œ256 = 8 Ã— 32</li><li><strong>ç¡¬ä»¶é™åˆ¶</strong>ï¼šæ¯blockæœ€å¤š1024 threads</li><li><strong>ç»éªŒå€¼</strong>ï¼š128-512é€šå¸¸æ€§èƒ½è¾ƒå¥½</li></ol><p>å…·ä½“æœ€ä¼˜å€¼éœ€è¦profilingç¡®å®šã€‚</p><h3 id="bian-jie-jian-cha-de-bi-yao-xing" tabindex="-1" id="è¾¹ç•Œæ£€æŸ¥çš„å¿…è¦æ€§">è¾¹ç•Œæ£€æŸ¥çš„å¿…è¦æ€§</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">blocksPerGrid = (10000 + 255) / 256 = 40</span><br><span class="line">æ€»threads = 40 Ã— 256 = 10240</span><br></pre></td></tr></table></figure><p>å¤šå‡º240ä¸ªçº¿ç¨‹ã€‚ä¸æ£€æŸ¥è¾¹ç•Œä¼šè¶Šç•Œè®¿é—®ï¼Œå¯¼è‡´é”™è¯¯æˆ–å´©æºƒã€‚</p><h2 id="nei-cun-guan-li" tabindex="-1" id="å†…å­˜ç®¡ç†">å†…å­˜ç®¡ç†</h2><h3 id="host-vs-device-nei-cun" tabindex="-1" id="Host-vs-Deviceå†…å­˜">Host vs Deviceå†…å­˜</h3><p><strong>å…³é”®</strong>ï¼šä¸¤ä¸ªç‹¬ç«‹çš„å†…å­˜ç©ºé—´ï¼Œä¸èƒ½ç›´æ¥äº’è®¿ã€‚</p><ul><li><strong>Host Memory</strong>ï¼šCPUçš„DDR4/DDR5</li><li><strong>Device Memory</strong>ï¼šGPUçš„GDDR6/HBM</li></ul><p><strong>é”™è¯¯ç¤ºä¾‹</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">float *d_A;</span><br><span class="line">cudaMalloc((void**)&amp;d_A, size);</span><br><span class="line">d_A[0] = 1.0f;  // æ®µé”™è¯¯ï¼CPUä¸èƒ½ç›´æ¥è®¿é—®GPUå†…å­˜</span><br></pre></td></tr></table></figure><p><strong>æ­£ç¡®åšæ³•</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">float *h_A = (float*)malloc(size);</span><br><span class="line">h_A[0] = 1.0f;</span><br><span class="line">cudaMemcpy(d_A, h_A, size, cudaMemcpyHostToDevice);</span><br></pre></td></tr></table></figure><h3 id="shu-ju-chuan-shu-kai-xiao" tabindex="-1" id="æ•°æ®ä¼ è¾“å¼€é”€">æ•°æ®ä¼ è¾“å¼€é”€</h3><p>PCIeå¸¦å®½ï¼ˆ~32 GB/sï¼‰è¿œä½äºGPUå†…å­˜å¸¦å®½ï¼ˆ500+ GB/sï¼‰ã€‚å¯¹äºç®€å•è®¡ç®—ï¼Œä¼ è¾“æ—¶é—´å¯èƒ½æ˜¯è®¡ç®—æ—¶é—´çš„æ•°åå€ã€‚</p><p><strong>ä¼˜åŒ–åŸåˆ™</strong>ï¼š</p><ul><li>å‡å°‘ä¼ è¾“æ¬¡æ•°ï¼ˆæ‰¹é‡ä¼ è¾“ï¼‰</li><li>ä¿æŒæ•°æ®åœ¨GPUï¼ˆå¤šæ­¥è®¡ç®—ä¸å›ä¼ ï¼‰</li><li>å¼‚æ­¥ä¼ è¾“ä¸è®¡ç®—é‡å ï¼ˆé«˜çº§æŠ€å·§ï¼‰</li></ul><h3 id="unified-memory-ke-xuan" tabindex="-1" id="Unified-Memoryï¼ˆå¯é€‰ï¼‰">Unified Memoryï¼ˆå¯é€‰ï¼‰</h3><p>ä»CUDA 6.0èµ·å¯ä»¥ç”¨ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">float *data;</span><br><span class="line">cudaMallocManaged(&amp;data, size);</span><br><span class="line"></span><br><span class="line">data[0] = 1.0f;              // CPUè®¿é—®</span><br><span class="line">kernel&lt;&lt;&lt;...&gt;&gt;&gt;(data);       // GPUè®¿é—®ï¼ˆè‡ªåŠ¨è¿ç§»ï¼‰</span><br><span class="line">printf(&quot;%f\n&quot;, data[0]);     // CPUè®¿é—®ï¼ˆè‡ªåŠ¨ä¼ å›ï¼‰</span><br><span class="line"></span><br><span class="line">cudaFree(data);</span><br></pre></td></tr></table></figure><p>æ–¹ä¾¿ï¼Œä½†æœ‰æ€§èƒ½å¼€é”€ã€‚å­¦ä¹ åŸå‹å¼€å‘å‹å¥½ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®æ˜¾å¼ç®¡ç†ã€‚</p><h2 id="zhi-xing-pei-zhi" tabindex="-1" id="æ‰§è¡Œé…ç½®">æ‰§è¡Œé…ç½®</h2><h3 id="qi-dong-yu-fa" tabindex="-1" id="å¯åŠ¨è¯­æ³•">å¯åŠ¨è¯­æ³•</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vecAdd&lt;&lt;&lt;blocksPerGrid, threadsPerBlock&gt;&gt;&gt;(d_A, d_B, d_C, n);</span><br></pre></td></tr></table></figure><p>å®Œæ•´å½¢å¼ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kernel&lt;&lt;&lt;gridDim, blockDim, sharedMem, stream&gt;&gt;&gt;(args);</span><br></pre></td></tr></table></figure><ul><li><code>gridDim</code>ï¼šgridçš„ç»´åº¦ï¼ˆ1D/2D/3Dï¼‰</li><li><code>blockDim</code>ï¼šblockçš„ç»´åº¦</li><li><code>sharedMem</code>ï¼šå…±äº«å†…å­˜å¤§å°ï¼ˆå¯é€‰ï¼Œé»˜è®¤0ï¼‰</li><li><code>stream</code>ï¼šCUDAæµï¼ˆå¯é€‰ï¼Œé»˜è®¤0ï¼‰</li></ul><h3 id="ji-suan-grid-da-xiao" tabindex="-1" id="è®¡ç®—gridå¤§å°">è®¡ç®—gridå¤§å°</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">int threads = 256;</span><br><span class="line">int blocks = (n + threads - 1) / threads;  // å‘ä¸Šå–æ•´</span><br></pre></td></tr></table></figure><p>æ•°å­¦ç­‰ä»·äº<code>ceil(n / threads)</code>ï¼Œä½†æ•´æ•°è¿ç®—æ›´é«˜æ•ˆã€‚</p><h2 id="cuo-wu-chu-li" tabindex="-1" id="é”™è¯¯å¤„ç†">é”™è¯¯å¤„ç†</h2><p>CUDAå‡½æ•°è¿”å›<code>cudaError_t</code>ï¼Œéœ€è¦æ˜¾å¼æ£€æŸ¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#define CUDA_CHECK(call) \</span><br><span class="line">do &#123; \</span><br><span class="line">    cudaError_t err = call; \</span><br><span class="line">    if (err != cudaSuccess) &#123; \</span><br><span class="line">        fprintf(stderr, &quot;CUDA Error: %s at %s:%d\n&quot;, \</span><br><span class="line">                cudaGetErrorString(err), __FILE__, __LINE__); \</span><br><span class="line">        exit(EXIT_FAILURE); \</span><br><span class="line">    &#125; \</span><br><span class="line">&#125; while(0)</span><br><span class="line"></span><br><span class="line">// ä½¿ç”¨</span><br><span class="line">CUDA_CHECK(cudaMalloc((void**)&amp;d_A, size));</span><br><span class="line">CUDA_CHECK(cudaMemcpy(d_A, h_A, size, cudaMemcpyHostToDevice));</span><br></pre></td></tr></table></figure><p>Kernelå¯åŠ¨ä¸è¿”å›é”™è¯¯ç ï¼Œéœ€è¦ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vecAdd&lt;&lt;&lt;blocks, threads&gt;&gt;&gt;(d_A, d_B, d_C, n);</span><br><span class="line">CUDA_CHECK(cudaGetLastError());          // æ£€æŸ¥å¯åŠ¨é”™è¯¯</span><br><span class="line">CUDA_CHECK(cudaDeviceSynchronize());     // åŒæ­¥å¹¶æ£€æŸ¥æ‰§è¡Œé”™è¯¯</span><br></pre></td></tr></table></figure><h2 id="xiao-jie" tabindex="-1" id="å°ç»“">å°ç»“</h2><p>ç¬¬äºŒç« é€šè¿‡å‘é‡åŠ æ³•å»ºç«‹äº†CUDAç¼–ç¨‹çš„åŸºæœ¬æ¡†æ¶ï¼š</p><p><strong>æ ¸å¿ƒæµç¨‹</strong>ï¼šå†…å­˜åˆ†é… â†’ æ•°æ®ä¼ è¾“ â†’ kernelå¯åŠ¨ â†’ ç»“æœå›ä¼ ï¼Œè¿™æ˜¯æ‰€æœ‰CUDAç¨‹åºçš„éª¨æ¶ã€‚</p><p><strong>çº¿ç¨‹ç»„ç»‡</strong>ï¼šGrid/Block/Threadä¸‰çº§ç»“æ„ï¼Œç´¢å¼•è®¡ç®—<code>i = blockIdx.x * blockDim.x + threadIdx.x</code>è¦çƒ‚ç†Ÿäºå¿ƒã€‚</p><p><strong>å†…å­˜æ¨¡å‹</strong>ï¼šHostå’ŒDeviceæ˜¯ç‹¬ç«‹ç©ºé—´ï¼Œå¿…é¡»æ˜¾å¼ä¼ è¾“ã€‚æ•°æ®ä¼ è¾“å¼€é”€ä¸å®¹å¿½è§†ã€‚</p><p><strong>æ€§èƒ½è®¤çŸ¥</strong>ï¼šå‘é‡åŠ æ³•è™½ç„¶èƒ½åœ¨GPUä¸Šè·‘ï¼Œä½†å—å†…å­˜å¸¦å®½é™åˆ¶ï¼Œæ€§èƒ½æå‡æœ‰é™ã€‚çœŸæ­£å‘æŒ¥GPUä¼˜åŠ¿éœ€è¦é«˜ç®—æœ¯å¼ºåº¦çš„ä»»åŠ¡ã€‚</p><p><strong>ä»£ç ä¹ æƒ¯</strong>ï¼š</p><ul><li>å˜é‡å‘½ååŒºåˆ†h_/d_</li><li>è¾¹ç•Œæ£€æŸ¥å¿…é¡»ä¸¥æ ¼</li><li>é”™è¯¯å¤„ç†ä¸èƒ½çœç•¥</li></ul><p>ä¸‹ä¸€ç« è¿›å…¥å¤šç»´æ•°æ®å¤„ç†ï¼ˆçŸ©é˜µã€å›¾åƒï¼‰ï¼Œä¼šç”¨åˆ°2D Grid/Blockç»„ç»‡ã€‚ç†è§£äº†ä¸€ç»´çš„åŸç†ï¼Œå¤šç»´åªæ˜¯è‡ªç„¶æ‰©å±•ã€‚</p><hr><p><strong>å‚è€ƒèµ„æ–™ï¼š</strong></p><ul><li>Hwu, W., Kirk, D., &amp; El Hajj, I. (2022). <em>Programming Massively Parallel Processors: A Hands-on Approach</em> (4th Edition). Morgan Kaufmann.</li><li><a href="https://docs.nvidia.com/cuda/cuda-c-programming-guide/">CUDA C++ Programming Guide</a></li></ul><hr><blockquote><p><strong>æœ¬æ–‡ GitHub ä»“åº“</strong>: <a href="https://github.com/psmarter/PMPP-Learning">https://github.com/psmarter/PMPP-Learning</a></p></blockquote>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;qian-yan&quot; tabindex=&quot;-1&quot;</summary>
        
      
    
    
    
    <category term="çŸ¥è¯†åˆ†äº«" scheme="https://smarter.xin/categories/knowledge-sharing/"/>
    
    
    <category term="CUDA" scheme="https://smarter.xin/tags/CUDA/"/>
    
    <category term="GPUç¼–ç¨‹" scheme="https://smarter.xin/tags/gpu-programming/"/>
    
    <category term="å¹¶è¡Œè®¡ç®—" scheme="https://smarter.xin/tags/parallel-computing/"/>
    
    <category term="PMPP" scheme="https://smarter.xin/tags/PMPP/"/>
    
    <category term="å‘é‡åŠ æ³•" scheme="https://smarter.xin/tags/vector-addition/"/>
    
  </entry>
  
</feed>
